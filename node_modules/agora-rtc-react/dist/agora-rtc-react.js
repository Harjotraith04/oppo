'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var react = require('react');
var jsxRuntime = require('react/jsx-runtime');

/**
 * @license agora-rtc-react
 * @version 2.2.0
 *
 * Copyright (c) Agora, Inc.
 *
 * This source code is licensed under the MIT license.
 */

var LH=Object.create;var Cf=Object.defineProperty;var kH=Object.getOwnPropertyDescriptor;var MH=Object.getOwnPropertyNames;var UH=Object.getPrototypeOf,xH=Object.prototype.hasOwnProperty;var VH=(L,V)=>()=>(V||L((V={exports:{}}).exports,V),V.exports),FH=(L,V)=>{for(var j in V)Cf(L,j,{get:V[j],enumerable:!0});},Rf=(L,V,j,H)=>{if(V&&typeof V=="object"||typeof V=="function")for(let rt of MH(V))!xH.call(L,rt)&&rt!==j&&Cf(L,rt,{get:()=>V[rt],enumerable:!(H=kH(V,rt))||H.enumerable});return L},Kr=(L,V,j)=>(Rf(L,V,"default"),j),Bs=(L,V,j)=>(j=L!=null?LH(UH(L)):{},Rf(!L||!L.__esModule?Cf(j,"default",{value:L,enumerable:!0}):j,L));var Qo=VH((vf,If)=>{(function(L,V){typeof vf=="object"&&typeof If<"u"?If.exports=V():typeof define=="function"&&define.amd?define(V):(L=typeof globalThis<"u"?globalThis:L||self).AgoraRTC=V();})(vf,function(){function L(t,e){return e.forEach(function(n){n&&typeof n!="string"&&!Array.isArray(n)&&Object.keys(n).forEach(function(i){if(i!=="default"&&!(i in t)){var r=Object.getOwnPropertyDescriptor(n,i);Object.defineProperty(t,i,r.get?r:{enumerable:!0,get:function(){return n[i]}});}});}),Object.freeze(t)}var V=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function j(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var H=function(t){try{return !!t()}catch{return !0}},rt=!H(function(){var t=function(){}.bind();return typeof t!="function"||t.hasOwnProperty("prototype")}),wt=rt,lt=Function.prototype,qt=lt.call,se=wt&&lt.bind.bind(qt,qt),Et=wt?se:function(t){return function(){return qt.apply(t,arguments)}},ut=Et({}.isPrototypeOf),Rt=function(t){return t&&t.Math==Math&&t},Vt=Rt(typeof globalThis=="object"&&globalThis)||Rt(typeof window=="object"&&window)||Rt(typeof self=="object"&&self)||Rt(typeof V=="object"&&V)||function(){return this}()||V||Function("return this")(),pn=rt,nn=Function.prototype,at=nn.apply,mt=nn.call,Se=typeof Reflect=="object"&&Reflect.apply||(pn?mt.bind(at):function(){return mt.apply(at,arguments)}),Ti=Et,Bn=Ti({}.toString),Yr=Ti("".slice),Tn=function(t){return Yr(Bn(t),8,-1)},UN=Tn,xN=Et,ac=function(t){if(UN(t)==="Function")return xN(t)},vh=typeof document=="object"&&document.all,Ld={all:vh,IS_HTMLDDA:vh===void 0&&vh!==void 0},VN=Ld.all,sn=Ld.IS_HTMLDDA?function(t){return typeof t=="function"||t===VN}:function(t){return typeof t=="function"},cc={},Si=!H(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!=7}),FN=rt,kd=Function.prototype.call,an=FN?kd.bind(kd):function(){return kd.apply(kd,arguments)},Md={},jf={}.propertyIsEnumerable,Gf=Object.getOwnPropertyDescriptor,BN=Gf&&!jf.call({1:2},1);Md.f=BN?function(t){var e=Gf(this,t);return !!e&&e.enumerable}:jf;var uo,Ud,ho=function(t,e){return {enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}},jN=H,GN=Tn,Ih=Object,WN=Et("".split),xd=jN(function(){return !Ih("z").propertyIsEnumerable(0)})?function(t){return GN(t)=="String"?WN(t,""):Ih(t)}:Ih,js=function(t){return t==null},HN=js,KN=TypeError,Gs=function(t){if(HN(t))throw KN("Can't call method on "+t);return t},YN=xd,qN=Gs,po=function(t){return YN(qN(t))},Wf=sn,zN=Ld.all,ii=Ld.IS_HTMLDDA?function(t){return typeof t=="object"?t!==null:Wf(t)||t===zN}:function(t){return typeof t=="object"?t!==null:Wf(t)},ir={},yh=ir,Ah=Vt,JN=sn,Hf=function(t){return JN(t)?t:void 0},Jn=function(t,e){return arguments.length<2?Hf(yh[t])||Hf(Ah[t]):yh[t]&&yh[t][e]||Ah[t]&&Ah[t][e]},ts=typeof navigator<"u"&&String(navigator.userAgent)||"",Kf=Vt,bh=ts,Yf=Kf.process,qf=Kf.Deno,zf=Yf&&Yf.versions||qf&&qf.version,Jf=zf&&zf.v8;Jf&&(Ud=(uo=Jf.split("."))[0]>0&&uo[0]<4?1:+(uo[0]+uo[1])),!Ud&&bh&&(!(uo=bh.match(/Edge\/(\d+)/))||uo[1]>=74)&&(uo=bh.match(/Chrome\/(\d+)/))&&(Ud=+uo[1]);var es=Ud,Xf=es,XN=H,QN=Vt.String,Ws=!!Object.getOwnPropertySymbols&&!XN(function(){var t=Symbol();return !QN(t)||!(Object(t)instanceof Symbol)||!Symbol.sham&&Xf&&Xf<41}),Qf=Ws&&!Symbol.sham&&typeof Symbol.iterator=="symbol",ZN=Jn,$N=sn,tD=ut,eD=Object,dc=Qf?function(t){return typeof t=="symbol"}:function(t){var e=ZN("Symbol");return $N(e)&&tD(e.prototype,eD(t))},nD=String,Hs=function(t){try{return nD(t)}catch{return "Object"}},iD=sn,rD=Hs,oD=TypeError,Li=function(t){if(iD(t))return t;throw oD(rD(t)+" is not a function")},sD=Li,aD=js,Vd=function(t,e){var n=t[e];return aD(n)?void 0:sD(n)},wh=an,Oh=sn,Nh=ii,cD=TypeError,Zf={exports:{}},$f=Vt,dD=Object.defineProperty,lD=function(t,e){try{dD($f,t,{value:e,configurable:!0,writable:!0});}catch{$f[t]=e;}return e},tg="__core-js_shared__",Dh=Vt[tg]||lD(tg,{}),eg=Dh;(Zf.exports=function(t,e){return eg[t]||(eg[t]=e!==void 0?e:{})})("versions",[]).push({version:"3.31.1",mode:"pure",copyright:"\xA9 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.31.1/LICENSE",source:"https://github.com/zloirock/core-js"});var Ks=Zf.exports,uD=Gs,hD=Object,Rr=function(t){return hD(uD(t))},pD=Rr,_D=Et({}.hasOwnProperty),_n=Object.hasOwn||function(t,e){return _D(pD(t),e)},mD=Et,ED=0,fD=Math.random(),gD=mD(1 .toString),Ph=function(t){return "Symbol("+(t===void 0?"":t)+")_"+gD(++ED+fD,36)},TD=Ks,ng=_n,SD=Ph,RD=Ws,CD=Qf,Ys=Vt.Symbol,Lh=TD("wks"),vD=CD?Ys.for||Ys:Ys&&Ys.withoutSetter||SD,Oe=function(t){return ng(Lh,t)||(Lh[t]=RD&&ng(Ys,t)?Ys[t]:vD("Symbol."+t)),Lh[t]},ID=an,ig=ii,rg=dc,yD=Vd,AD=function(t,e){var n,i;if(Oh(n=t.toString)&&!Nh(i=wh(n,t))||Oh(n=t.valueOf)&&!Nh(i=wh(n,t))||e!=="string")return i;throw cD("Can't convert object to primitive value")},bD=TypeError,wD=Oe("toPrimitive"),OD=function(t,e){if(!ig(t)||rg(t))return t;var n,i=yD(t,wD);if(i){if(n=ID(i,t,e),!ig(n)||rg(n))return n;throw bD("Can't convert object to primitive value")}return AD(t,e)},ND=dc,Fd=function(t){var e=OD(t,"string");return ND(e)?e:e+""},og=ii,kh=Vt.document,DD=og(kh)&&og(kh.createElement),Mh=function(t){return DD?kh.createElement(t):{}},PD=Mh,sg=!Si&&!H(function(){return Object.defineProperty(PD("div"),"a",{get:function(){return 7}}).a!=7}),LD=Si,kD=an,MD=Md,UD=ho,xD=po,VD=Fd,FD=_n,BD=sg,ag=Object.getOwnPropertyDescriptor;cc.f=LD?ag:function(t,e){if(t=xD(t),e=VD(e),BD)try{return ag(t,e)}catch{}if(FD(t,e))return UD(!kD(MD.f,t,e),t[e])};var jD=H,GD=sn,WD=/#|\.prototype\./,lc=function(t,e){var n=KD[HD(t)];return n==qD||n!=YD&&(GD(e)?jD(e):!!e)},HD=lc.normalize=function(t){return String(t).replace(WD,".").toLowerCase()},KD=lc.data={},YD=lc.NATIVE="N",qD=lc.POLYFILL="P",cg=lc,zD=Li,JD=rt,XD=ac(ac.bind),_o=function(t,e){return zD(t),e===void 0?t:JD?XD(t,e):function(){return t.apply(e,arguments)}},ki={},dg=Si&&H(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!=42}),QD=ii,ZD=String,$D=TypeError,jn=function(t){if(QD(t))return t;throw $D(ZD(t)+" is not an object")},tP=Si,eP=sg,nP=dg,Bd=jn,lg=Fd,iP=TypeError,Uh=Object.defineProperty,rP=Object.getOwnPropertyDescriptor,xh="enumerable",Vh="configurable",Fh="writable";ki.f=tP?nP?function(t,e,n){if(Bd(t),e=lg(e),Bd(n),typeof t=="function"&&e==="prototype"&&"value"in n&&Fh in n&&!n[Fh]){var i=rP(t,e);i&&i[Fh]&&(t[e]=n.value,n={configurable:Vh in n?n[Vh]:i[Vh],enumerable:xh in n?n[xh]:i[xh],writable:!1});}return Uh(t,e,n)}:Uh:function(t,e,n){if(Bd(t),e=lg(e),Bd(n),eP)try{return Uh(t,e,n)}catch{}if("get"in n||"set"in n)throw iP("Accessors not supported");return "value"in n&&(t[e]=n.value),t};var oP=ki,sP=ho,mo=Si?function(t,e,n){return oP.f(t,e,sP(1,n))}:function(t,e,n){return t[e]=n,t},jd=Vt,aP=Se,cP=ac,dP=sn,lP=cc.f,uP=cg,qs=ir,hP=_o,zs=mo,ug=_n,pP=function(t){var e=function(n,i,r){if(this instanceof e){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,i)}return new t(n,i,r)}return aP(t,this,arguments)};return e.prototype=t.prototype,e},ee=function(t,e){var n,i,r,o,s,a,c,d,l,u=t.target,h=t.global,p=t.stat,T=t.proto,m=h?jd:p?jd[u]:(jd[u]||{}).prototype,E=h?qs:qs[u]||zs(qs,u,{})[u],S=E.prototype;for(o in e)i=!(n=uP(h?o:u+(p?".":"#")+o,t.forced))&&m&&ug(m,o),a=E[o],i&&(c=t.dontCallGetSet?(l=lP(m,o))&&l.value:m[o]),s=i&&c?c:e[o],i&&typeof a==typeof s||(d=t.bind&&i?hP(s,jd):t.wrap&&i?pP(s):T&&dP(s)?cP(s):s,(t.sham||s&&s.sham||a&&a.sham)&&zs(d,"sham",!0),zs(E,o,d),T&&(ug(qs,r=u+"Prototype")||zs(qs,r,{}),zs(qs[r],o,s),t.real&&S&&(n||!S[o])&&zs(S,o,s)));},_P=Math.ceil,mP=Math.floor,EP=Math.trunc||function(t){var e=+t;return (e>0?mP:_P)(e)},fP=EP,Bh=function(t){var e=+t;return e!=e||e===0?0:fP(e)},gP=Bh,TP=Math.max,SP=Math.min,jh=function(t,e){var n=gP(t);return n<0?TP(n+e,0):SP(n,e)},RP=Bh,CP=Math.min,hg=function(t){return t>0?CP(RP(t),9007199254740991):0},vP=hg,qr=function(t){return vP(t.length)},IP=po,yP=jh,AP=qr,pg=function(t){return function(e,n,i){var r,o=IP(e),s=AP(o),a=yP(i,s);if(t&&n!=n){for(;s>a;)if((r=o[a++])!=r)return !0}else for(;s>a;a++)if((t||a in o)&&o[a]===n)return t||a||0;return !t&&-1}},Gh={includes:pg(!0),indexOf:pg(!1)},bP=Gh.includes;ee({target:"Array",proto:!0,forced:H(function(){return !Array(1).includes()})},{includes:function(t){return bP(this,t,arguments.length>1?arguments[1]:void 0)}});var wP=ir,Mi=function(t){return wP[t+"Prototype"]},OP=Mi("Array").includes,NP=ii,DP=Tn,PP=Oe("match"),_g=function(t){var e;return NP(t)&&((e=t[PP])!==void 0?!!e:DP(t)=="RegExp")},LP=_g,kP=TypeError,mg={};mg[Oe("toStringTag")]="z";var Wh=String(mg)==="[object z]",MP=Wh,UP=sn,Gd=Tn,xP=Oe("toStringTag"),VP=Object,FP=Gd(function(){return arguments}())=="Arguments",Cr=MP?Gd:function(t){var e,n,i;return t===void 0?"Undefined":t===null?"Null":typeof(n=function(r,o){try{return r[o]}catch{}}(e=VP(t),xP))=="string"?n:FP?Gd(e):(i=Gd(e))=="Object"&&UP(e.callee)?"Arguments":i},BP=Cr,jP=String,Ri=function(t){if(BP(t)==="Symbol")throw TypeError("Cannot convert a Symbol value to a string");return jP(t)},GP=Oe("match"),WP=ee,HP=function(t){if(LP(t))throw kP("The method doesn't accept regular expressions");return t},KP=Gs,Eg=Ri,YP=function(t){var e=/./;try{"/./"[t](e);}catch{try{return e[GP]=!1,"/./"[t](e)}catch{}}return !1},qP=Et("".indexOf);WP({target:"String",proto:!0,forced:!YP("includes")},{includes:function(t){return !!~qP(Eg(KP(this)),Eg(HP(t)),arguments.length>1?arguments[1]:void 0)}});var zP=Mi("String").includes,fg=ut,JP=OP,XP=zP,Hh=Array.prototype,Kh=String.prototype,QP=function(t){var e=t.includes;return t===Hh||fg(Hh,t)&&e===Hh.includes?JP:typeof t=="string"||t===Kh||fg(Kh,t)&&e===Kh.includes?XP:e},q=j(QP),ZP=Li,$P=Rr,tL=xd,eL=qr,nL=TypeError,gg=function(t){return function(e,n,i,r){ZP(n);var o=$P(e),s=tL(o),a=eL(o),c=t?a-1:0,d=t?-1:1;if(i<2)for(;;){if(c in s){r=s[c],c+=d;break}if(c+=d,t?c<0:a<=c)throw nL("Reduce of empty array with no initial value")}for(;t?c>=0:a>c;c+=d)c in s&&(r=n(r,s[c],c,o));return r}},iL={left:gg(!1),right:gg(!0)},rL=H,Wd=function(t,e){var n=[][t];return !!n&&rL(function(){n.call(null,e||function(){return 1},1);})},uc=typeof process<"u"&&Tn(process)=="process",oL=iL.left;ee({target:"Array",proto:!0,forced:!uc&&es>79&&es<83||!Wd("reduce")},{reduce:function(t){var e=arguments.length;return oL(this,t,e,e>1?arguments[1]:void 0)}});var sL=Mi("Array").reduce,aL=ut,cL=sL,Yh=Array.prototype,dL=function(t){var e=t.reduce;return t===Yh||aL(Yh,t)&&e===Yh.reduce?cL:e},Tg=dL,rr=j(Tg);let Sg=!0,Rg=!0;function Hd(t,e,n){let i=t.match(e);return i&&i.length>=n&&parseInt(i[n],10)}function ns(t,e,n){if(!t.RTCPeerConnection)return;let i=t.RTCPeerConnection.prototype,r=i.addEventListener;i.addEventListener=function(s,a){if(s!==e)return r.apply(this,arguments);let c=d=>{let l=n(d);l&&(a.handleEvent?a.handleEvent(l):a(l));};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(a,c),r.apply(this,[s,c])};let o=i.removeEventListener;i.removeEventListener=function(s,a){if(s!==e||!this._eventMap||!this._eventMap[e])return o.apply(this,arguments);if(!this._eventMap[e].has(a))return o.apply(this,arguments);let c=this._eventMap[e].get(a);return this._eventMap[e].delete(a),this._eventMap[e].size===0&&delete this._eventMap[e],Object.keys(this._eventMap).length===0&&delete this._eventMap,o.apply(this,[s,c])},Object.defineProperty(i,"on"+e,{get(){return this["_on"+e]},set(s){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),s&&this.addEventListener(e,this["_on"+e]=s);},enumerable:!0,configurable:!0});}function lL(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):(Sg=t,t?"adapter.js logging disabled":"adapter.js logging enabled")}function uL(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):(Rg=!t,"adapter.js deprecation warnings "+(t?"disabled":"enabled"))}function Cg(){if(typeof window=="object"){if(Sg)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments);}}function qh(t,e){Rg&&console.warn(t+" is deprecated, please use "+e+" instead.");}function vg(t){return Object.prototype.toString.call(t)==="[object Object]"}function Ig(t){var e;return vg(t)?rr(e=Object.keys(t)).call(e,function(n,i){let r=vg(t[i]),o=r?Ig(t[i]):t[i],s=r&&!Object.keys(o).length;return o===void 0||s?n:Object.assign(n,{[i]:o})},{}):t}function zh(t,e,n){e&&!n.has(e.id)&&(n.set(e.id,e),Object.keys(e).forEach(i=>{i.endsWith("Id")?zh(t,t.get(e[i]),n):i.endsWith("Ids")&&e[i].forEach(r=>{zh(t,t.get(r),n);});}));}function yg(t,e,n){let i=n?"outbound-rtp":"inbound-rtp",r=new Map;if(e===null)return r;let o=[];return t.forEach(s=>{s.type==="track"&&s.trackIdentifier===e.id&&o.push(s);}),o.forEach(s=>{t.forEach(a=>{a.type===i&&a.trackId===s.id&&zh(t,a,r);});}),r}var hL=Ph,Ag=Ks("keys"),Kd=function(t){return Ag[t]||(Ag[t]=hL(t))},pL=!H(function(){function t(){}return t.prototype.constructor=null,Object.getPrototypeOf(new t)!==t.prototype}),_L=_n,mL=sn,EL=Rr,fL=pL,bg=Kd("IE_PROTO"),Jh=Object,gL=Jh.prototype,Xh=fL?Jh.getPrototypeOf:function(t){var e=EL(t);if(_L(e,bg))return e[bg];var n=e.constructor;return mL(n)&&e instanceof n?n.prototype:e instanceof Jh?gL:null},TL=Et,SL=Li,RL=sn,CL=String,vL=TypeError,IL=function(t,e,n){try{return TL(SL(Object.getOwnPropertyDescriptor(t,e)[n]))}catch{}},yL=jn,AL=function(t){if(typeof t=="object"||RL(t))return t;throw vL("Can't set "+CL(t)+" as a prototype")},bL=Object.setPrototypeOf||("__proto__"in{}?function(){var t,e=!1,n={};try{(t=IL(Object.prototype,"__proto__","set"))(n,[]),e=n instanceof Array;}catch{}return function(i,r){return yL(i),AL(r),e?t(i,r):i.__proto__=r,i}}():void 0),Yd={},qd={},Qh=_n,wL=po,OL=Gh.indexOf,NL=qd,wg=Et([].push),Og=function(t,e){var n,i=wL(t),r=0,o=[];for(n in i)!Qh(NL,n)&&Qh(i,n)&&wg(o,n);for(;e.length>r;)Qh(i,n=e[r++])&&(~OL(o,n)||wg(o,n));return o},Zh=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],DL=Og,PL=Zh.concat("length","prototype");Yd.f=Object.getOwnPropertyNames||function(t){return DL(t,PL)};var hc={};hc.f=Object.getOwnPropertySymbols;var LL=Jn,kL=Yd,ML=hc,UL=jn,xL=Et([].concat),VL=LL("Reflect","ownKeys")||function(t){var e=kL.f(UL(t)),n=ML.f;return n?xL(e,n(t)):e},Ng=_n,FL=VL,BL=cc,jL=ki,$h={},GL=Og,WL=Zh,zd=Object.keys||function(t){return GL(t,WL)},HL=Si,KL=dg,YL=ki,qL=jn,zL=po,JL=zd;$h.f=HL&&!KL?Object.defineProperties:function(t,e){qL(t);for(var n,i=zL(e),r=JL(e),o=r.length,s=0;o>s;)YL.f(t,n=r[s++],i[n]);return t};var Jd,Dg=Jn("document","documentElement"),XL=jn,QL=$h,Pg=Zh,ZL=qd,$L=Dg,tk=Mh,tp="prototype",ep="script",Lg=Kd("IE_PROTO"),np=function(){},kg=function(t){return "<"+ep+">"+t+"</"+ep+">"},Mg=function(t){t.write(kg("")),t.close();var e=t.parentWindow.Object;return t=null,e},Xd=function(){try{Jd=new ActiveXObject("htmlfile");}catch{}var t,e,n;Xd=typeof document<"u"?document.domain&&Jd?Mg(Jd):(e=tk("iframe"),n="java"+ep+":",e.style.display="none",$L.appendChild(e),e.src=String(n),(t=e.contentWindow.document).open(),t.write(kg("document.F=Object")),t.close(),t.F):Mg(Jd);for(var i=Pg.length;i--;)delete Xd[tp][Pg[i]];return Xd()};ZL[Lg]=!0;var pc=Object.create||function(t,e){var n;return t!==null?(np[tp]=XL(t),n=new np,np[tp]=null,n[Lg]=t):n=Xd(),e===void 0?n:QL.f(n,e)},ek=ii,nk=mo,Ug=Error,ik=Et("".replace),rk=String(Ug("zxcasd").stack),xg=/\n\s*at [^:]*:[^\n]*/,ok=xg.test(rk),sk=ho,ak=!H(function(){var t=Error("a");return !("stack"in t)||(Object.defineProperty(t,"stack",sk(1,7)),t.stack!==7)}),ck=mo,dk=function(t,e){if(ok&&typeof t=="string"&&!Ug.prepareStackTrace)for(;e--;)t=ik(t,xg,"");return t},lk=ak,Vg=Error.captureStackTrace,is={},uk=is,hk=Oe("iterator"),pk=Array.prototype,Fg=function(t){return t!==void 0&&(uk.Array===t||pk[hk]===t)},_k=Cr,Bg=Vd,mk=js,Ek=is,fk=Oe("iterator"),Qd=function(t){if(!mk(t))return Bg(t,fk)||Bg(t,"@@iterator")||Ek[_k(t)]},gk=an,Tk=Li,Sk=jn,Rk=Hs,Ck=Qd,vk=TypeError,ip=function(t,e){var n=arguments.length<2?Ck(t):e;if(Tk(n))return Sk(gk(n,t));throw vk(Rk(t)+" is not iterable")},Ik=an,jg=jn,yk=Vd,Gg=function(t,e,n){var i,r;jg(t);try{if(!(i=yk(t,"return"))){if(e==="throw")throw n;return n}i=Ik(i,t);}catch(o){r=!0,i=o;}if(e==="throw")throw n;if(r)throw i;return jg(i),n},Ak=_o,bk=an,wk=jn,Ok=Hs,Nk=Fg,Dk=qr,Wg=ut,Pk=ip,Lk=Qd,Hg=Gg,kk=TypeError,Zd=function(t,e){this.stopped=t,this.result=e;},Kg=Zd.prototype,_c=function(t,e,n){var i,r,o,s,a,c,d,l=n&&n.that,u=!(!n||!n.AS_ENTRIES),h=!(!n||!n.IS_RECORD),p=!(!n||!n.IS_ITERATOR),T=!(!n||!n.INTERRUPTED),m=Ak(e,l),E=function(C){return i&&Hg(i,"normal",C),new Zd(!0,C)},S=function(C){return u?(wk(C),T?m(C[0],C[1],E):m(C[0],C[1])):T?m(C,E):m(C)};if(h)i=t.iterator;else if(p)i=t;else {if(!(r=Lk(t)))throw kk(Ok(t)+" is not iterable");if(Nk(r)){for(o=0,s=Dk(t);s>o;o++)if((a=S(t[o]))&&Wg(Kg,a))return a;return new Zd(!1)}i=Pk(t,r);}for(c=h?t.next:i.next;!(d=bk(c,i)).done;){try{a=S(d.value);}catch(C){Hg(i,"throw",C);}if(typeof a=="object"&&a&&Wg(Kg,a))return a}return new Zd(!1)},Mk=Ri,Uk=ee,xk=ut,Vk=Xh,$d=bL,Fk=function(t,e,n){for(var i=FL(e),r=jL.f,o=BL.f,s=0;s<i.length;s++){var a=i[s];Ng(t,a)||n&&Ng(n,a)||r(t,a,o(e,a));}},Yg=pc,rp=mo,op=ho,Bk=function(t,e){ek(e)&&"cause"in e&&nk(t,"cause",e.cause);},jk=function(t,e,n,i){lk&&(Vg?Vg(t,e):ck(t,"stack",dk(n,i)));},Gk=_c,Wk=function(t,e){return t===void 0?arguments.length<2?"":e:Mk(t)},Hk=Oe("toStringTag"),tl=Error,Kk=[].push,Js=function(t,e){var n,i=xk(sp,this);$d?n=$d(tl(),i?Vk(this):sp):(n=i?this:Yg(sp),rp(n,Hk,"Error")),e!==void 0&&rp(n,"message",Wk(e)),jk(n,Js,n.stack,1),arguments.length>2&&Bk(n,arguments[2]);var r=[];return Gk(t,Kk,{that:r}),rp(n,"errors",r),n};$d?$d(Js,tl):Fk(Js,tl,{name:!0});var sp=Js.prototype=Yg(tl.prototype,{constructor:op(1,Js),message:op(1,""),name:op(1,"AggregateError")});Uk({global:!0,constructor:!0,arity:2},{AggregateError:Js});var el,mc,nl,Yk=sn,qg=Vt.WeakMap,qk=Yk(qg)&&/native code/.test(String(qg)),zg=Vt,zk=ii,Jk=mo,ap=_n,cp=Dh,Xk=Kd,Qk=qd,Jg="Object already initialized",dp=zg.TypeError,Zk=zg.WeakMap;if(qk||cp.state){var vr=cp.state||(cp.state=new Zk);vr.get=vr.get,vr.has=vr.has,vr.set=vr.set,el=function(t,e){if(vr.has(t))throw dp(Jg);return e.facade=t,vr.set(t,e),e},mc=function(t){return vr.get(t)||{}},nl=function(t){return vr.has(t)};}else {var Xs=Xk("state");Qk[Xs]=!0,el=function(t,e){if(ap(t,Xs))throw dp(Jg);return e.facade=t,Jk(t,Xs,e),e},mc=function(t){return ap(t,Xs)?t[Xs]:{}},nl=function(t){return ap(t,Xs)};}var rs,Xg,Qg,os={set:el,get:mc,has:nl,enforce:function(t){return nl(t)?mc(t):el(t,{})},getterFor:function(t){return function(e){var n;if(!zk(e)||(n=mc(e)).type!==t)throw dp("Incompatible receiver, "+t+" required");return n}}},lp=Si,$k=_n,Zg=Function.prototype,tM=lp&&Object.getOwnPropertyDescriptor,up=$k(Zg,"name"),$g={EXISTS:up,PROPER:up&&function(){}.name==="something",CONFIGURABLE:up&&(!lp||lp&&tM(Zg,"name").configurable)},eM=mo,Eo=function(t,e,n,i){return i&&i.enumerable?t[e]=n:eM(t,e,n),t},nM=H,iM=sn,rM=ii,oM=pc,tT=Xh,sM=Eo,hp=Oe("iterator"),eT=!1;[].keys&&("next"in(Qg=[].keys())?(Xg=tT(tT(Qg)))!==Object.prototype&&(rs=Xg):eT=!0);var aM=!rM(rs)||nM(function(){var t={};return rs[hp].call(t)!==t});iM((rs=aM?{}:oM(rs))[hp])||sM(rs,hp,function(){return this});var nT={IteratorPrototype:rs,BUGGY_SAFARI_ITERATORS:eT},cM=Cr,dM=Wh?{}.toString:function(){return "[object "+cM(this)+"]"},lM=Wh,uM=ki.f,hM=mo,pM=_n,_M=dM,iT=Oe("toStringTag"),fo=function(t,e,n,i){if(t){var r=n?t:t.prototype;pM(r,iT)||uM(r,iT,{configurable:!0,value:e}),i&&!lM&&hM(r,"toString",_M);}},mM=nT.IteratorPrototype,EM=pc,fM=ho,gM=fo,TM=is,SM=function(){return this},pp=function(t,e,n,i){var r=e+" Iterator";return t.prototype=EM(mM,{next:fM(+!i,n)}),gM(t,r,!1,!0),TM[r]=SM,t},RM=ee,CM=an,vM=$g,IM=pp,yM=Xh,AM=fo,rT=Eo,oT=is,bM=nT,wM=vM.PROPER,il=bM.BUGGY_SAFARI_ITERATORS,_p=Oe("iterator"),sT="keys",rl="values",aT="entries",OM=function(){return this},cT=function(t,e,n,i,r,o,s){IM(n,e,i);var a,c,d,l=function(S){if(S===r&&m)return m;if(!il&&S in p)return p[S];switch(S){case sT:case rl:case aT:return function(){return new n(this,S)}}return function(){return new n(this)}},u=e+" Iterator",h=!1,p=t.prototype,T=p[_p]||p["@@iterator"]||r&&p[r],m=!il&&T||l(r),E=e=="Array"&&p.entries||T;if(E&&(a=yM(E.call(new t)))!==Object.prototype&&a.next&&(AM(a,u,!0,!0),oT[u]=OM),wM&&r==rl&&T&&T.name!==rl&&(h=!0,m=function(){return CM(T,this)}),r)if(c={values:l(rl),keys:o?m:l(sT),entries:l(aT)},s)for(d in c)(il||h||!(d in p))&&rT(p,d,c[d]);else RM({target:e,proto:!0,forced:il||h},c);return s&&p[_p]!==m&&rT(p,_p,m,{name:r}),oT[e]=m,c},mp=function(t,e){return {value:t,done:e}},NM=po,dT=is,lT=os;ki.f;var DM=cT,uT=mp,hT="Array Iterator",PM=lT.set,LM=lT.getterFor(hT);DM(Array,"Array",function(t,e){PM(this,{type:hT,target:NM(t),index:0,kind:e});},function(){var t=LM(this),e=t.target,n=t.kind,i=t.index++;return !e||i>=e.length?(t.target=void 0,uT(void 0,!0)):uT(n=="keys"?i:n=="values"?e[i]:[i,e[i]],!1)},"values"),dT.Arguments=dT.Array;var kM=ki,ol=function(t,e,n){return kM.f(t,e,n)},MM=Jn,UM=ol,xM=Si,pT=Oe("species"),VM=ut,FM=TypeError,Ep=function(t,e){if(VM(e,t))return t;throw FM("Incorrect invocation")},BM=sn,fp=Dh,jM=Et(Function.toString);BM(fp.inspectSource)||(fp.inspectSource=function(t){return jM(t)});var _T=fp.inspectSource,GM=Et,WM=H,mT=sn,HM=Cr,KM=_T,ET=function(){},YM=[],fT=Jn("Reflect","construct"),gp=/^\s*(?:class|function)\b/,qM=GM(gp.exec),zM=!gp.exec(ET),Ec=function(t){if(!mT(t))return !1;try{return fT(ET,YM,t),!0}catch{return !1}},gT=function(t){if(!mT(t))return !1;switch(HM(t)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return !1}try{return zM||!!qM(gp,KM(t))}catch{return !0}};gT.sham=!0;var fc,Qs,TT,Tp,sl=!fT||WM(function(){var t;return Ec(Ec.call)||!Ec(Object)||!Ec(function(){t=!0;})||t})?gT:Ec,JM=sl,XM=Hs,QM=TypeError,ST=jn,ZM=function(t){if(JM(t))return t;throw QM(XM(t)+" is not a constructor")},$M=js,t1=Oe("species"),Sp=function(t,e){var n,i=ST(t).constructor;return i===void 0||$M(n=ST(i)[t1])?e:ZM(n)},Rp=Et([].slice),e1=TypeError,al=function(t,e){if(t<e)throw e1("Not enough arguments");return t},RT=/(?:ipad|iphone|ipod).*applewebkit/i.test(ts),Ci=Vt,n1=Se,i1=_o,CT=sn,r1=_n,vT=H,IT=Dg,o1=Rp,yT=Mh,s1=al,a1=RT,c1=uc,Cp=Ci.setImmediate,vp=Ci.clearImmediate,d1=Ci.process,Ip=Ci.Dispatch,l1=Ci.Function,AT=Ci.MessageChannel,u1=Ci.String,yp=0,gc={},bT="onreadystatechange";vT(function(){fc=Ci.location;});var Ap=function(t){if(r1(gc,t)){var e=gc[t];delete gc[t],e();}},bp=function(t){return function(){Ap(t);}},wT=function(t){Ap(t.data);},OT=function(t){Ci.postMessage(u1(t),fc.protocol+"//"+fc.host);};Cp&&vp||(Cp=function(t){s1(arguments.length,1);var e=CT(t)?t:l1(t),n=o1(arguments,1);return gc[++yp]=function(){n1(e,void 0,n);},Qs(yp),yp},vp=function(t){delete gc[t];},c1?Qs=function(t){d1.nextTick(bp(t));}:Ip&&Ip.now?Qs=function(t){Ip.now(bp(t));}:AT&&!a1?(Tp=(TT=new AT).port2,TT.port1.onmessage=wT,Qs=i1(Tp.postMessage,Tp)):Ci.addEventListener&&CT(Ci.postMessage)&&!Ci.importScripts&&fc&&fc.protocol!=="file:"&&!vT(OT)?(Qs=OT,Ci.addEventListener("message",wT,!1)):Qs=bT in yT("script")?function(t){IT.appendChild(yT("script"))[bT]=function(){IT.removeChild(this),Ap(t);};}:function(t){setTimeout(bp(t),0);});var NT={set:Cp,clear:vp},DT=function(){this.head=null,this.tail=null;};DT.prototype={add:function(t){var e={item:t,next:null},n=this.tail;n?n.next=e:this.head=e,this.tail=e;},get:function(){var t=this.head;if(t)return (this.head=t.next)===null&&(this.tail=null),t.item}};var Zs,wp,Op,Np,PT,LT=DT,h1=/ipad|iphone|ipod/i.test(ts)&&typeof Pebble<"u",p1=/web0s(?!.*chrome)/i.test(ts),ss=Vt,kT=_o,_1=cc.f,Dp=NT.set,m1=LT,E1=RT,f1=h1,g1=p1,Pp=uc,MT=ss.MutationObserver||ss.WebKitMutationObserver,UT=ss.document,xT=ss.process,cl=ss.Promise,VT=_1(ss,"queueMicrotask"),Lp=VT&&VT.value;if(!Lp){var dl=new m1,ll=function(){var t,e;for(Pp&&(t=xT.domain)&&t.exit();e=dl.get();)try{e();}catch(n){throw dl.head&&Zs(),n}t&&t.enter();};E1||Pp||g1||!MT||!UT?!f1&&cl&&cl.resolve?((Np=cl.resolve(void 0)).constructor=cl,PT=kT(Np.then,Np),Zs=function(){PT(ll);}):Pp?Zs=function(){xT.nextTick(ll);}:(Dp=kT(Dp,ss),Zs=function(){Dp(ll);}):(wp=!0,Op=UT.createTextNode(""),new MT(ll).observe(Op,{characterData:!0}),Zs=function(){Op.data=wp=!wp;}),Lp=function(t){dl.head||Zs(),dl.add(t);};}var T1=Lp,$s=function(t){try{return {error:!1,value:t()}}catch(e){return {error:!0,value:e}}},as=Vt.Promise,FT=typeof Deno=="object"&&Deno&&typeof Deno.version=="object",S1=!FT&&!uc&&typeof window=="object"&&typeof document=="object",R1=Vt,Tc=as,C1=sn,v1=cg,I1=_T,y1=Oe,A1=S1,b1=FT,kp=es,BT=Tc&&Tc.prototype,w1=y1("species"),jT=!1,GT=C1(R1.PromiseRejectionEvent),O1=v1("Promise",function(){var t=I1(Tc),e=t!==String(Tc);if(!e&&kp===66||!BT.catch||!BT.finally)return !0;if(!kp||kp<51||!/native code/.test(t)){var n=new Tc(function(r){r(1);}),i=function(r){r(function(){},function(){});};if((n.constructor={})[w1]=i,!(jT=n.then(function(){})instanceof i))return !0}return !e&&(A1||b1)&&!GT}),Sc={CONSTRUCTOR:O1,REJECTION_EVENT:GT,SUBCLASSING:jT},Ir={},WT=Li,N1=TypeError,D1=function(t){var e,n;this.promise=new t(function(i,r){if(e!==void 0||n!==void 0)throw N1("Bad Promise constructor");e=i,n=r;}),this.resolve=WT(e),this.reject=WT(n);};Ir.f=function(t){return new D1(t)};var Mp,HT,P1=ee,ul=uc,go=Vt,Rc=an,L1=Eo,k1=fo,M1=function(t){var e=MM(t);xM&&e&&!e[pT]&&UM(e,pT,{configurable:!0,get:function(){return this}});},U1=Li,Up=sn,x1=ii,V1=Ep,F1=Sp,KT=NT.set,xp=T1,B1=function(t,e){try{arguments.length==1?console.error(t):console.error(t,e);}catch{}},j1=$s,G1=LT,YT=os,Vp=as,qT=Sc,zT=Ir,hl="Promise",JT=qT.CONSTRUCTOR,W1=qT.REJECTION_EVENT,Fp=YT.getterFor(hl),H1=YT.set,K1=Vp&&Vp.prototype,Cc=Vp,Bp=K1,XT=go.TypeError,jp=go.document,Gp=go.process,Wp=zT.f,Y1=Wp,q1=!!(jp&&jp.createEvent&&go.dispatchEvent),QT="unhandledrejection",ZT=function(t){var e;return !(!x1(t)||!Up(e=t.then))&&e},$T=function(t,e){var n,i,r,o=e.value,s=e.state==1,a=s?t.ok:t.fail,c=t.resolve,d=t.reject,l=t.domain;try{a?(s||(e.rejection===2&&J1(e),e.rejection=1),a===!0?n=o:(l&&l.enter(),n=a(o),l&&(l.exit(),r=!0)),n===t.promise?d(XT("Promise-chain cycle")):(i=ZT(n))?Rc(i,n,c,d):c(n)):d(o);}catch(u){l&&!r&&l.exit(),d(u);}},tS=function(t,e){t.notified||(t.notified=!0,xp(function(){for(var n,i=t.reactions;n=i.get();)$T(n,t);t.notified=!1,e&&!t.rejection&&z1(t);}));},eS=function(t,e,n){var i,r;q1?((i=jp.createEvent("Event")).promise=e,i.reason=n,i.initEvent(t,!1,!0),go.dispatchEvent(i)):i={promise:e,reason:n},!W1&&(r=go["on"+t])?r(i):t===QT&&B1("Unhandled promise rejection",n);},z1=function(t){Rc(KT,go,function(){var e,n=t.facade,i=t.value;if(nS(t)&&(e=j1(function(){ul?Gp.emit("unhandledRejection",i,n):eS(QT,n,i);}),t.rejection=ul||nS(t)?2:1,e.error))throw e.value});},nS=function(t){return t.rejection!==1&&!t.parent},J1=function(t){Rc(KT,go,function(){var e=t.facade;ul?Gp.emit("rejectionHandled",e):eS("rejectionhandled",e,t.value);});},ta=function(t,e,n){return function(i){t(e,i,n);}},ea=function(t,e,n){t.done||(t.done=!0,n&&(t=n),t.value=e,t.state=2,tS(t,!0));},Hp=function(t,e,n){if(!t.done){t.done=!0,n&&(t=n);try{if(t.facade===e)throw XT("Promise can't be resolved itself");var i=ZT(e);i?xp(function(){var r={done:!1};try{Rc(i,e,ta(Hp,r,t),ta(ea,r,t));}catch(o){ea(r,o,t);}}):(t.value=e,t.state=1,tS(t,!1));}catch(r){ea({done:!1},r,t);}}};JT&&(Bp=(Cc=function(t){V1(this,Bp),U1(t),Rc(Mp,this);var e=Fp(this);try{t(ta(Hp,e),ta(ea,e));}catch(n){ea(e,n);}}).prototype,(Mp=function(t){H1(this,{type:hl,done:!1,notified:!1,parent:!1,reactions:new G1,rejection:!1,state:0,value:void 0});}).prototype=L1(Bp,"then",function(t,e){var n=Fp(this),i=Wp(F1(this,Cc));return n.parent=!0,i.ok=!Up(t)||t,i.fail=Up(e)&&e,i.domain=ul?Gp.domain:void 0,n.state==0?n.reactions.add(i):xp(function(){$T(i,n);}),i.promise}),HT=function(){var t=new Mp,e=Fp(t);this.promise=t,this.resolve=ta(Hp,e),this.reject=ta(ea,e);},zT.f=Wp=function(t){return t===Cc||t===void 0?new HT(t):Y1(t)}),P1({global:!0,constructor:!0,wrap:!0,forced:JT},{Promise:Cc}),k1(Cc,hl,!1,!0),M1(hl);var iS=Oe("iterator"),rS=!1;try{var X1=0,oS={next:function(){return {done:!!X1++}},return:function(){rS=!0;}};oS[iS]=function(){return this},Array.from(oS,function(){throw 2});}catch{}var Q1=as,Z1=function(t,e){if(!rS)return !1;var n=!1;try{var i={};i[iS]=function(){return {next:function(){return {done:n=!0}}}},t(i);}catch{}return n},pl=Sc.CONSTRUCTOR||!Z1(function(t){Q1.all(t).then(void 0,function(){});}),$1=an,tU=Li,eU=Ir,nU=$s,iU=_c;ee({target:"Promise",stat:!0,forced:pl},{all:function(t){var e=this,n=eU.f(e),i=n.resolve,r=n.reject,o=nU(function(){var s=tU(e.resolve),a=[],c=0,d=1;iU(t,function(l){var u=c++,h=!1;d++,$1(s,e,l).then(function(p){h||(h=!0,a[u]=p,--d||i(a));},r);}),--d||i(a);});return o.error&&r(o.value),n.promise}});var rU=ee,oU=Sc.CONSTRUCTOR;as&&as.prototype,rU({target:"Promise",proto:!0,forced:oU,real:!0},{catch:function(t){return this.then(void 0,t)}});var sU=an,aU=Li,cU=Ir,dU=$s,lU=_c;ee({target:"Promise",stat:!0,forced:pl},{race:function(t){var e=this,n=cU.f(e),i=n.reject,r=dU(function(){var o=aU(e.resolve);lU(t,function(s){sU(o,e,s).then(n.resolve,i);});});return r.error&&i(r.value),n.promise}});var uU=an,hU=Ir;ee({target:"Promise",stat:!0,forced:Sc.CONSTRUCTOR},{reject:function(t){var e=hU.f(this);return uU(e.reject,void 0,t),e.promise}});var pU=jn,_U=ii,mU=Ir,sS=function(t,e){if(pU(t),_U(e)&&e.constructor===t)return e;var n=mU.f(t);return (0, n.resolve)(e),n.promise},EU=ee,fU=as,gU=Sc.CONSTRUCTOR,TU=sS,SU=Jn("Promise"),RU=!gU;EU({target:"Promise",stat:!0,forced:!0},{resolve:function(t){return TU(RU&&this===SU?fU:this,t)}});var CU=an,vU=Li,IU=Ir,yU=$s,AU=_c;ee({target:"Promise",stat:!0,forced:pl},{allSettled:function(t){var e=this,n=IU.f(e),i=n.resolve,r=n.reject,o=yU(function(){var s=vU(e.resolve),a=[],c=0,d=1;AU(t,function(l){var u=c++,h=!1;d++,CU(s,e,l).then(function(p){h||(h=!0,a[u]={status:"fulfilled",value:p},--d||i(a));},function(p){h||(h=!0,a[u]={status:"rejected",reason:p},--d||i(a));});}),--d||i(a);});return o.error&&r(o.value),n.promise}});var bU=an,wU=Li,OU=Jn,NU=Ir,DU=$s,PU=_c,aS="No one promise resolved";ee({target:"Promise",stat:!0,forced:pl},{any:function(t){var e=this,n=OU("AggregateError"),i=NU.f(e),r=i.resolve,o=i.reject,s=DU(function(){var a=wU(e.resolve),c=[],d=0,l=1,u=!1;PU(t,function(h){var p=d++,T=!1;l++,bU(a,e,h).then(function(m){T||u||(u=!0,r(m));},function(m){T||u||(T=!0,c[p]=m,--l||o(new n(c,aS)));});}),--l||o(new n(c,aS));});return s.error&&o(s.value),i.promise}});var LU=ee,Kp=as,kU=H,MU=Jn,UU=sn,xU=Sp,cS=sS,VU=Kp&&Kp.prototype;LU({target:"Promise",proto:!0,real:!0,forced:!!Kp&&kU(function(){VU.finally.call({then:function(){}},function(){});})},{finally:function(t){var e=xU(this,MU("Promise")),n=UU(t);return this.then(n?function(i){return cS(e,t()).then(function(){return i})}:t,n?function(i){return cS(e,t()).then(function(){throw i})}:t)}});var Yp=Et,FU=Bh,BU=Ri,jU=Gs,GU=Yp("".charAt),dS=Yp("".charCodeAt),WU=Yp("".slice),lS=function(t){return function(e,n){var i,r,o=BU(jU(e)),s=FU(n),a=o.length;return s<0||s>=a?t?"":void 0:(i=dS(o,s))<55296||i>56319||s+1===a||(r=dS(o,s+1))<56320||r>57343?t?GU(o,s):i:t?WU(o,s,s+2):r-56320+(i-55296<<10)+65536}},qp={codeAt:lS(!1),charAt:lS(!0)},HU=qp.charAt,KU=Ri,uS=os,YU=cT,hS=mp,pS="String Iterator",qU=uS.set,zU=uS.getterFor(pS);YU(String,"String",function(t){qU(this,{type:pS,string:KU(t),index:0});},function(){var t,e=zU(this),n=e.string,i=e.index;return i>=n.length?hS(void 0,!0):(t=HU(n,i),e.index+=t.length,hS(t,!1))});var JU=ir.Promise,XU={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},QU=Vt,ZU=Cr,$U=mo,_S=is,mS=Oe("toStringTag");for(var zp in XU){var ES=QU[zp],Jp=ES&&ES.prototype;Jp&&ZU(Jp)!==mS&&$U(Jp,mS,zp),_S[zp]=_S.Array;}var fS=JU,K=j(fS);let gS=Cg;function TS(t,e){let n=t&&t.navigator;if(!n.mediaDevices)return;let i=function(s){if(typeof s!="object"||s.mandatory||s.optional)return s;let a={};return Object.keys(s).forEach(c=>{if(c==="require"||c==="advanced"||c==="mediaSource")return;let d=typeof s[c]=="object"?s[c]:{ideal:s[c]};d.exact!==void 0&&typeof d.exact=="number"&&(d.min=d.max=d.exact);let l=function(u,h){return u?u+h.charAt(0).toUpperCase()+h.slice(1):h==="deviceId"?"sourceId":h};if(d.ideal!==void 0){a.optional=a.optional||[];let u={};typeof d.ideal=="number"?(u[l("min",c)]=d.ideal,a.optional.push(u),u={},u[l("max",c)]=d.ideal,a.optional.push(u)):(u[l("",c)]=d.ideal,a.optional.push(u));}d.exact!==void 0&&typeof d.exact!="number"?(a.mandatory=a.mandatory||{},a.mandatory[l("",c)]=d.exact):["min","max"].forEach(u=>{d[u]!==void 0&&(a.mandatory=a.mandatory||{},a.mandatory[l(u,c)]=d[u]);});}),s.advanced&&(a.optional=(a.optional||[]).concat(s.advanced)),a},r=function(s,a){if(e.version>=61)return a(s);if((s=JSON.parse(JSON.stringify(s)))&&typeof s.audio=="object"){let c=function(d,l,u){l in d&&!(u in d)&&(d[u]=d[l],delete d[l]);};c((s=JSON.parse(JSON.stringify(s))).audio,"autoGainControl","googAutoGainControl"),c(s.audio,"noiseSuppression","googNoiseSuppression"),s.audio=i(s.audio);}if(s&&typeof s.video=="object"){let c=s.video.facingMode;c=c&&(typeof c=="object"?c:{ideal:c});let d=e.version<66;if(c&&(c.exact==="user"||c.exact==="environment"||c.ideal==="user"||c.ideal==="environment")&&(!n.mediaDevices.getSupportedConstraints||!n.mediaDevices.getSupportedConstraints().facingMode||d)){let l;if(delete s.video.facingMode,c.exact==="environment"||c.ideal==="environment"?l=["back","rear"]:c.exact!=="user"&&c.ideal!=="user"||(l=["front"]),l)return n.mediaDevices.enumerateDevices().then(u=>{let h=(u=u.filter(p=>p.kind==="videoinput")).find(p=>l.some(T=>{var m;return q(m=p.label.toLowerCase()).call(m,T)}));return !h&&u.length&&q(l).call(l,"back")&&(h=u[u.length-1]),h&&(s.video.deviceId=c.exact?{exact:h.deviceId}:{ideal:h.deviceId}),s.video=i(s.video),gS("chrome: "+JSON.stringify(s)),a(s)})}s.video=i(s.video);}return gS("chrome: "+JSON.stringify(s)),a(s)},o=function(s){return e.version>=64?s:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[s.name]||s.name,message:s.message,constraint:s.constraint||s.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(n.getUserMedia=function(s,a,c){r(s,d=>{n.webkitGetUserMedia(d,a,l=>{c&&c(o(l));});});}.bind(n),n.mediaDevices.getUserMedia){let s=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(a){return r(a,c=>s(c).then(d=>{if(c.audio&&!d.getAudioTracks().length||c.video&&!d.getVideoTracks().length)throw d.getTracks().forEach(l=>{l.stop();}),new DOMException("","NotFoundError");return d},d=>K.reject(o(d))))};}}function SS(t){t.MediaStream=t.MediaStream||t.webkitMediaStream;}function RS(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("ontrack"in t.RTCPeerConnection.prototype)){Object.defineProperty(t.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(n){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=n);},enumerable:!0,configurable:!0});let e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=n=>{n.stream.addEventListener("addtrack",i=>{let r;r=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(s=>s.track&&s.track.id===i.track.id):{track:i.track};let o=new Event("track");o.track=i.track,o.receiver=r,o.transceiver={receiver:r},o.streams=[n.stream],this.dispatchEvent(o);}),n.stream.getTracks().forEach(i=>{let r;r=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(s=>s.track&&s.track.id===i.id):{track:i};let o=new Event("track");o.track=i,o.receiver=r,o.transceiver={receiver:r},o.streams=[n.stream],this.dispatchEvent(o);});},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)};}else ns(t,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e));}function CS(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("getSenders"in t.RTCPeerConnection.prototype)&&"createDTMFSender"in t.RTCPeerConnection.prototype){let e=function(r,o){return {track:o,get dtmf(){return this._dtmf===void 0&&(o.kind==="audio"?this._dtmf=r.createDTMFSender(o):this._dtmf=null),this._dtmf},_pc:r}};if(!t.RTCPeerConnection.prototype.getSenders){t.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};let r=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(s,a){let c=r.apply(this,arguments);return c||(c=e(this,s),this._senders.push(c)),c};let o=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(s){o.apply(this,arguments);let a=this._senders.indexOf(s);a!==-1&&this._senders.splice(a,1);};}let n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(r){this._senders=this._senders||[],n.apply(this,[r]),r.getTracks().forEach(o=>{this._senders.push(e(this,o));});};let i=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(r){this._senders=this._senders||[],i.apply(this,[r]),r.getTracks().forEach(o=>{let s=this._senders.find(a=>a.track===o);s&&this._senders.splice(this._senders.indexOf(s),1);});};}else if(typeof t=="object"&&t.RTCPeerConnection&&"getSenders"in t.RTCPeerConnection.prototype&&"createDTMFSender"in t.RTCPeerConnection.prototype&&t.RTCRtpSender&&!("dtmf"in t.RTCRtpSender.prototype)){let e=t.RTCPeerConnection.prototype.getSenders;t.RTCPeerConnection.prototype.getSenders=function(){let n=e.apply(this,[]);return n.forEach(i=>i._pc=this),n},Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}});}}function vS(t){if(!t.RTCPeerConnection)return;let e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){let[n,i,r]=arguments;if(arguments.length>0&&typeof n=="function")return e.apply(this,arguments);if(e.length===0&&(arguments.length===0||typeof n!="function"))return e.apply(this,[]);let o=function(a){let c={};return a.result().forEach(d=>{let l={id:d.id,timestamp:d.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[d.type]||d.type};d.names().forEach(u=>{l[u]=d.stat(u);}),c[l.id]=l;}),c},s=function(a){return new Map(Object.keys(a).map(c=>[c,a[c]]))};if(arguments.length>=2){let a=function(c){i(s(o(c)));};return e.apply(this,[a,n])}return new K((a,c)=>{e.apply(this,[function(d){a(s(o(d)));},c]);}).then(i,r)};}function IS(t){if(!(typeof t=="object"&&t.RTCPeerConnection&&t.RTCRtpSender&&t.RTCRtpReceiver))return;if(!("getStats"in t.RTCRtpSender.prototype)){let n=t.RTCPeerConnection.prototype.getSenders;n&&(t.RTCPeerConnection.prototype.getSenders=function(){let r=n.apply(this,[]);return r.forEach(o=>o._pc=this),r});let i=t.RTCPeerConnection.prototype.addTrack;i&&(t.RTCPeerConnection.prototype.addTrack=function(){let r=i.apply(this,arguments);return r._pc=this,r}),t.RTCRtpSender.prototype.getStats=function(){let r=this;return this._pc.getStats().then(o=>yg(o,r.track,!0))};}if(!("getStats"in t.RTCRtpReceiver.prototype)){let n=t.RTCPeerConnection.prototype.getReceivers;n&&(t.RTCPeerConnection.prototype.getReceivers=function(){let i=n.apply(this,[]);return i.forEach(r=>r._pc=this),i}),ns(t,"track",i=>(i.receiver._pc=i.srcElement,i)),t.RTCRtpReceiver.prototype.getStats=function(){let i=this;return this._pc.getStats().then(r=>yg(r,i.track,!1))};}if(!("getStats"in t.RTCRtpSender.prototype)||!("getStats"in t.RTCRtpReceiver.prototype))return;let e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof t.MediaStreamTrack){let n=arguments[0],i,r,o;return this.getSenders().forEach(s=>{s.track===n&&(i?o=!0:i=s);}),this.getReceivers().forEach(s=>(s.track===n&&(r?o=!0:r=s),s.track===n)),o||i&&r?K.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):i?i.getStats():r?r.getStats():K.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)};}function yS(t){t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(o=>this._shimmedLocalStreams[o][0])};let e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(o,s){if(!s)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};let a=e.apply(this,arguments);return this._shimmedLocalStreams[s.id]?this._shimmedLocalStreams[s.id].indexOf(a)===-1&&this._shimmedLocalStreams[s.id].push(a):this._shimmedLocalStreams[s.id]=[s,a],a};let n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(o){this._shimmedLocalStreams=this._shimmedLocalStreams||{},o.getTracks().forEach(c=>{if(this.getSenders().find(l=>l.track===c))throw new DOMException("Track already exists.","InvalidAccessError")});let s=this.getSenders();n.apply(this,arguments);let a=this.getSenders().filter(c=>s.indexOf(c)===-1);this._shimmedLocalStreams[o.id]=[o].concat(a);};let i=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[o.id],i.apply(this,arguments)};let r=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},o&&Object.keys(this._shimmedLocalStreams).forEach(s=>{let a=this._shimmedLocalStreams[s].indexOf(o);a!==-1&&this._shimmedLocalStreams[s].splice(a,1),this._shimmedLocalStreams[s].length===1&&delete this._shimmedLocalStreams[s];}),r.apply(this,arguments)};}function AS(t,e){if(!t.RTCPeerConnection)return;if(t.RTCPeerConnection.prototype.addTrack&&e.version>=65)return yS(t);let n=t.RTCPeerConnection.prototype.getLocalStreams;t.RTCPeerConnection.prototype.getLocalStreams=function(){let c=n.apply(this);return this._reverseStreams=this._reverseStreams||{},c.map(d=>this._reverseStreams[d.id])};let i=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(c){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},c.getTracks().forEach(d=>{if(this.getSenders().find(u=>u.track===d))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[c.id]){let d=new t.MediaStream(c.getTracks());this._streams[c.id]=d,this._reverseStreams[d.id]=c,c=d;}i.apply(this,[c]);};let r=t.RTCPeerConnection.prototype.removeStream;function o(c,d){let l=d.sdp;return Object.keys(c._reverseStreams||[]).forEach(u=>{let h=c._reverseStreams[u],p=c._streams[h.id];l=l.replace(new RegExp(p.id,"g"),h.id);}),new RTCSessionDescription({type:d.type,sdp:l})}t.RTCPeerConnection.prototype.removeStream=function(c){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[c.id]||c]),delete this._reverseStreams[this._streams[c.id]?this._streams[c.id].id:c.id],delete this._streams[c.id];},t.RTCPeerConnection.prototype.addTrack=function(c,d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");let l=[].slice.call(arguments,1);if(l.length!==1||!l[0].getTracks().find(p=>p===c))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(p=>p.track===c))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};let h=this._streams[d.id];if(h)h.addTrack(c),K.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"));});else {let p=new t.MediaStream([c]);this._streams[d.id]=p,this._reverseStreams[p.id]=d,this.addStream(p);}return this.getSenders().find(p=>p.track===c)},["createOffer","createAnswer"].forEach(function(c){let d=t.RTCPeerConnection.prototype[c],l={[c](){let u=arguments;return arguments.length&&typeof arguments[0]=="function"?d.apply(this,[h=>{let p=o(this,h);u[0].apply(null,[p]);},h=>{u[1]&&u[1].apply(null,h);},arguments[2]]):d.apply(this,arguments).then(h=>o(this,h))}};t.RTCPeerConnection.prototype[c]=l[c];});let s=t.RTCPeerConnection.prototype.setLocalDescription;t.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(c,d){let l=d.sdp;return Object.keys(c._reverseStreams||[]).forEach(u=>{let h=c._reverseStreams[u],p=c._streams[h.id];l=l.replace(new RegExp(h.id,"g"),p.id);}),new RTCSessionDescription({type:d.type,sdp:l})}(this,arguments[0]),s.apply(this,arguments)):s.apply(this,arguments)};let a=Object.getOwnPropertyDescriptor(t.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(t.RTCPeerConnection.prototype,"localDescription",{get(){let c=a.get.apply(this);return c.type===""?c:o(this,c)}}),t.RTCPeerConnection.prototype.removeTrack=function(c){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!c._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(c._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let d;this._streams=this._streams||{},Object.keys(this._streams).forEach(l=>{this._streams[l].getTracks().find(u=>c.track===u)&&(d=this._streams[l]);}),d&&(d.getTracks().length===1?this.removeStream(this._reverseStreams[d.id]):d.removeTrack(c.track),this.dispatchEvent(new Event("negotiationneeded")));};}function Xp(t,e){!t.RTCPeerConnection&&t.webkitRTCPeerConnection&&(t.RTCPeerConnection=t.webkitRTCPeerConnection),t.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(n){let i=t.RTCPeerConnection.prototype[n],r={[n](){return arguments[0]=new(n==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};t.RTCPeerConnection.prototype[n]=r[n];});}function bS(t,e){ns(t,"negotiationneeded",n=>{let i=n.target;if(!(e.version<72||i.getConfiguration&&i.getConfiguration().sdpSemantics==="plan-b")||i.signalingState==="stable")return n});}var wS=Object.freeze({__proto__:null,fixNegotiationNeeded:bS,shimAddTrackRemoveTrack:AS,shimAddTrackRemoveTrackWithNative:yS,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(typeof e=="function"?t.navigator.mediaDevices.getDisplayMedia=function(n){return e(n).then(i=>{let r=n.video&&n.video.width,o=n.video&&n.video.height,s=n.video&&n.video.frameRate;return n.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:i,maxFrameRate:s||3}},r&&(n.video.mandatory.maxWidth=r),o&&(n.video.mandatory.maxHeight=o),t.navigator.mediaDevices.getUserMedia(n)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"));},shimGetSendersWithDtmf:CS,shimGetStats:vS,shimGetUserMedia:TS,shimMediaStream:SS,shimOnTrack:RS,shimPeerConnection:Xp,shimSenderReceiverGetStats:IS});function OS(t,e){let n=t&&t.navigator,i=t&&t.MediaStreamTrack;if(n.getUserMedia=function(r,o,s){qh("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(r).then(o,s);},!(e.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){let r=function(s,a,c){a in s&&!(c in s)&&(s[c]=s[a],delete s[a]);},o=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(s){return typeof s=="object"&&typeof s.audio=="object"&&(s=JSON.parse(JSON.stringify(s)),r(s.audio,"autoGainControl","mozAutoGainControl"),r(s.audio,"noiseSuppression","mozNoiseSuppression")),o(s)},i&&i.prototype.getSettings){let s=i.prototype.getSettings;i.prototype.getSettings=function(){let a=s.apply(this,arguments);return r(a,"mozAutoGainControl","autoGainControl"),r(a,"mozNoiseSuppression","noiseSuppression"),a};}if(i&&i.prototype.applyConstraints){let s=i.prototype.applyConstraints;i.prototype.applyConstraints=function(a){return this.kind==="audio"&&typeof a=="object"&&(a=JSON.parse(JSON.stringify(a)),r(a,"autoGainControl","mozAutoGainControl"),r(a,"noiseSuppression","mozNoiseSuppression")),s.apply(this,[a])};}}}function NS(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return {receiver:this.receiver}}});}function Qp(t,e){if(typeof t!="object"||!t.RTCPeerConnection&&!t.mozRTCPeerConnection)return;!t.RTCPeerConnection&&t.mozRTCPeerConnection&&(t.RTCPeerConnection=t.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(r){let o=t.RTCPeerConnection.prototype[r],s={[r](){return arguments[0]=new(r==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),o.apply(this,arguments)}};t.RTCPeerConnection.prototype[r]=s[r];});let n={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){let[r,o,s]=arguments;return i.apply(this,[r||null]).then(a=>{if(e.version<53&&!o)try{a.forEach(c=>{c.type=n[c.type]||c.type;});}catch(c){if(c.name!=="TypeError")throw c;a.forEach((d,l)=>{a.set(l,Object.assign({},d,{type:n[d.type]||d.type}));});}return a}).then(o,s)};}function DS(t){if(typeof t!="object"||!t.RTCPeerConnection||!t.RTCRtpSender||t.RTCRtpSender&&"getStats"in t.RTCRtpSender.prototype)return;let e=t.RTCPeerConnection.prototype.getSenders;e&&(t.RTCPeerConnection.prototype.getSenders=function(){let i=e.apply(this,[]);return i.forEach(r=>r._pc=this),i});let n=t.RTCPeerConnection.prototype.addTrack;n&&(t.RTCPeerConnection.prototype.addTrack=function(){let i=n.apply(this,arguments);return i._pc=this,i}),t.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):K.resolve(new Map)};}function PS(t){if(typeof t!="object"||!t.RTCPeerConnection||!t.RTCRtpSender||t.RTCRtpSender&&"getStats"in t.RTCRtpReceiver.prototype)return;let e=t.RTCPeerConnection.prototype.getReceivers;e&&(t.RTCPeerConnection.prototype.getReceivers=function(){let n=e.apply(this,[]);return n.forEach(i=>i._pc=this),n}),ns(t,"track",n=>(n.receiver._pc=n.srcElement,n)),t.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)};}function LS(t){t.RTCPeerConnection&&!("removeStream"in t.RTCPeerConnection.prototype)&&(t.RTCPeerConnection.prototype.removeStream=function(e){qh("removeStream","removeTrack"),this.getSenders().forEach(n=>{var i;n.track&&q(i=e.getTracks()).call(i,n.track)&&this.removeTrack(n);});});}function kS(t){t.DataChannel&&!t.RTCDataChannel&&(t.RTCDataChannel=t.DataChannel);}function MS(t){if(typeof t!="object"||!t.RTCPeerConnection)return;let e=t.RTCPeerConnection.prototype.addTransceiver;e&&(t.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let n=arguments[1]&&arguments[1].sendEncodings;n===void 0&&(n=[]),n=[...n];let i=n.length>0;i&&n.forEach(o=>{if("rid"in o&&!/^[a-z0-9]{0,16}$/i.test(o.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in o&&!(parseFloat(o.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in o&&!(parseFloat(o.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});let r=e.apply(this,arguments);if(i){let{sender:o}=r,s=o.getParameters();(!("encodings"in s)||s.encodings.length===1&&Object.keys(s.encodings[0]).length===0)&&(s.encodings=n,o.sendEncodings=n,this.setParametersPromises.push(o.setParameters(s).then(()=>{delete o.sendEncodings;}).catch(()=>{delete o.sendEncodings;})));}return r});}function US(t){if(typeof t!="object"||!t.RTCRtpSender)return;let e=t.RTCRtpSender.prototype.getParameters;e&&(t.RTCRtpSender.prototype.getParameters=function(){let n=e.apply(this,arguments);return "encodings"in n||(n.encodings=[].concat(this.sendEncodings||[{}])),n});}function xS(t){if(typeof t!="object"||!t.RTCPeerConnection)return;let e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?K.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[];}):e.apply(this,arguments)};}function VS(t){if(typeof t!="object"||!t.RTCPeerConnection)return;let e=t.RTCPeerConnection.prototype.createAnswer;t.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?K.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[];}):e.apply(this,arguments)};}var FS=Object.freeze({__proto__:null,shimAddTransceiver:MS,shimCreateAnswer:VS,shimCreateOffer:xS,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(t.navigator.mediaDevices.getDisplayMedia=function(n){if(!n||!n.video){let i=new DOMException("getDisplayMedia without video constraints is undefined");return i.name="NotFoundError",i.code=8,K.reject(i)}return n.video===!0?n.video={mediaSource:e}:n.video.mediaSource=e,t.navigator.mediaDevices.getUserMedia(n)});},shimGetParameters:US,shimGetUserMedia:OS,shimOnTrack:NS,shimPeerConnection:Qp,shimRTCDataChannel:kS,shimReceiverGetStats:PS,shimRemoveStream:LS,shimSenderGetStats:DS});function BS(t){if(typeof t=="object"&&t.RTCPeerConnection){if("getLocalStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in t.RTCPeerConnection.prototype)){let e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addStream=function(n){var i;this._localStreams||(this._localStreams=[]),q(i=this._localStreams).call(i,n)||this._localStreams.push(n),n.getAudioTracks().forEach(r=>e.call(this,r,n)),n.getVideoTracks().forEach(r=>e.call(this,r,n));},t.RTCPeerConnection.prototype.addTrack=function(n){for(var i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];return r&&r.forEach(s=>{var a;this._localStreams?q(a=this._localStreams).call(a,s)||this._localStreams.push(s):this._localStreams=[s];}),e.apply(this,arguments)};}"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);let n=this._localStreams.indexOf(e);if(n===-1)return;this._localStreams.splice(n,1);let i=e.getTracks();this.getSenders().forEach(r=>{q(i).call(i,r.track)&&this.removeTrack(r);});});}}function jS(t){if(typeof t=="object"&&t.RTCPeerConnection&&("getRemoteStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in t.RTCPeerConnection.prototype))){Object.defineProperty(t.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(n){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=n),this.addEventListener("track",this._onaddstreampoly=i=>{i.streams.forEach(r=>{var o;if(this._remoteStreams||(this._remoteStreams=[]),q(o=this._remoteStreams).call(o,r))return;this._remoteStreams.push(r);let s=new Event("addstream");s.stream=r,this.dispatchEvent(s);});});}});let e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){let n=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(i){i.streams.forEach(r=>{if(n._remoteStreams||(n._remoteStreams=[]),n._remoteStreams.indexOf(r)>=0)return;n._remoteStreams.push(r);let o=new Event("addstream");o.stream=r,n.dispatchEvent(o);});}),e.apply(n,arguments)};}}function GS(t){if(typeof t!="object"||!t.RTCPeerConnection)return;let e=t.RTCPeerConnection.prototype,n=e.createOffer,i=e.createAnswer,r=e.setLocalDescription,o=e.setRemoteDescription,s=e.addIceCandidate;e.createOffer=function(c,d){let l=arguments.length>=2?arguments[2]:arguments[0],u=n.apply(this,[l]);return d?(u.then(c,d),K.resolve()):u},e.createAnswer=function(c,d){let l=arguments.length>=2?arguments[2]:arguments[0],u=i.apply(this,[l]);return d?(u.then(c,d),K.resolve()):u};let a=function(c,d,l){let u=r.apply(this,[c]);return l?(u.then(d,l),K.resolve()):u};e.setLocalDescription=a,a=function(c,d,l){let u=o.apply(this,[c]);return l?(u.then(d,l),K.resolve()):u},e.setRemoteDescription=a,a=function(c,d,l){let u=s.apply(this,[c]);return l?(u.then(d,l),K.resolve()):u},e.addIceCandidate=a;}function WS(t){let e=t&&t.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){let n=e.mediaDevices,i=n.getUserMedia.bind(n);e.mediaDevices.getUserMedia=r=>i(HS(r));}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=function(n,i,r){e.mediaDevices.getUserMedia(n).then(i,r);}.bind(e));}function HS(t){return t&&t.video!==void 0?Object.assign({},t,{video:Ig(t.video)}):t}function KS(t){if(!t.RTCPeerConnection)return;let e=t.RTCPeerConnection;t.RTCPeerConnection=function(n,i){if(n&&n.iceServers){let r=[];for(let o=0;o<n.iceServers.length;o++){let s=n.iceServers[o];!s.hasOwnProperty("urls")&&s.hasOwnProperty("url")?(qh("RTCIceServer.url","RTCIceServer.urls"),s=JSON.parse(JSON.stringify(s)),s.urls=s.url,delete s.url,r.push(s)):r.push(n.iceServers[o]);}n.iceServers=r;}return new e(n,i)},t.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(t.RTCPeerConnection,"generateCertificate",{get:()=>e.generateCertificate});}function YS(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return {receiver:this.receiver}}});}function qS(t){let e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(n){if(n){n.offerToReceiveAudio!==void 0&&(n.offerToReceiveAudio=!!n.offerToReceiveAudio);let i=this.getTransceivers().find(o=>o.receiver.track.kind==="audio");n.offerToReceiveAudio===!1&&i?i.direction==="sendrecv"?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":i.direction==="recvonly"&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):n.offerToReceiveAudio!==!0||i||this.addTransceiver("audio",{direction:"recvonly"}),n.offerToReceiveVideo!==void 0&&(n.offerToReceiveVideo=!!n.offerToReceiveVideo);let r=this.getTransceivers().find(o=>o.receiver.track.kind==="video");n.offerToReceiveVideo===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):n.offerToReceiveVideo!==!0||r||this.addTransceiver("video",{direction:"recvonly"});}return e.apply(this,arguments)};}function zS(t){typeof t!="object"||t.AudioContext||(t.AudioContext=t.webkitAudioContext);}var JS=Object.freeze({__proto__:null,shimAudioContext:zS,shimCallbacksAPI:GS,shimConstraints:HS,shimCreateOfferLegacy:qS,shimGetUserMedia:WS,shimLocalStreamsAPI:BS,shimRTCIceServerUrls:KS,shimRemoteStreamsAPI:jS,shimTrackEventTransceiver:YS}),XS=`	
\v\f\r \xA0\u1680\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u3000\u2028\u2029\uFEFF`,t2=Gs,e2=Ri,Zp=XS,QS=Et("".replace),n2=RegExp("^["+Zp+"]+"),i2=RegExp("(^|[^"+Zp+"])["+Zp+"]+$"),$p=function(t){return function(e){var n=e2(t2(e));return 1&t&&(n=QS(n,n2,"")),2&t&&(n=QS(n,i2,"$1")),n}},r2={start:$p(1),end:$p(2),trim:$p(3)},o2=$g.PROPER,s2=H,ZS=XS,a2=r2.trim;ee({target:"String",proto:!0,forced:function(t){return s2(function(){return !!ZS[t]()||"\u200B\x85\u180E"[t]()!=="\u200B\x85\u180E"||o2&&ZS[t].name!==t})}("trim")},{trim:function(){return a2(this)}});var c2=Mi("String").trim,d2=ut,l2=c2,t_=String.prototype,u2=function(t){var e=t.trim;return typeof t=="string"||t===t_||d2(t_,t)&&e===t_.trim?l2:e},vn=j(u2),$S={exports:{}};(function(t){let e={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};e.localCName=e.generateIdentifier(),e.splitLines=function(n){return n.trim().split(`
`).map(i=>i.trim())},e.splitSections=function(n){return n.split(`
m=`).map((i,r)=>(r>0?"m="+i:i).trim()+`\r
`)},e.getDescription=function(n){let i=e.splitSections(n);return i&&i[0]},e.getMediaSections=function(n){let i=e.splitSections(n);return i.shift(),i},e.matchPrefix=function(n,i){return e.splitLines(n).filter(r=>r.indexOf(i)===0)},e.parseCandidate=function(n){let i;i=n.indexOf("a=candidate:")===0?n.substring(12).split(" "):n.substring(10).split(" ");let r={foundation:i[0],component:{1:"rtp",2:"rtcp"}[i[1]]||i[1],protocol:i[2].toLowerCase(),priority:parseInt(i[3],10),ip:i[4],address:i[4],port:parseInt(i[5],10),type:i[7]};for(let o=8;o<i.length;o+=2)switch(i[o]){case"raddr":r.relatedAddress=i[o+1];break;case"rport":r.relatedPort=parseInt(i[o+1],10);break;case"tcptype":r.tcpType=i[o+1];break;case"ufrag":r.ufrag=i[o+1],r.usernameFragment=i[o+1];break;default:r[i[o]]===void 0&&(r[i[o]]=i[o+1]);}return r},e.writeCandidate=function(n){let i=[];i.push(n.foundation);let r=n.component;r==="rtp"?i.push(1):r==="rtcp"?i.push(2):i.push(r),i.push(n.protocol.toUpperCase()),i.push(n.priority),i.push(n.address||n.ip),i.push(n.port);let o=n.type;return i.push("typ"),i.push(o),o!=="host"&&n.relatedAddress&&n.relatedPort&&(i.push("raddr"),i.push(n.relatedAddress),i.push("rport"),i.push(n.relatedPort)),n.tcpType&&n.protocol.toLowerCase()==="tcp"&&(i.push("tcptype"),i.push(n.tcpType)),(n.usernameFragment||n.ufrag)&&(i.push("ufrag"),i.push(n.usernameFragment||n.ufrag)),"candidate:"+i.join(" ")},e.parseIceOptions=function(n){return n.substring(14).split(" ")},e.parseRtpMap=function(n){let i=n.substring(9).split(" "),r={payloadType:parseInt(i.shift(),10)};return i=i[0].split("/"),r.name=i[0],r.clockRate=parseInt(i[1],10),r.channels=i.length===3?parseInt(i[2],10):1,r.numChannels=r.channels,r},e.writeRtpMap=function(n){let i=n.payloadType;n.preferredPayloadType!==void 0&&(i=n.preferredPayloadType);let r=n.channels||n.numChannels||1;return "a=rtpmap:"+i+" "+n.name+"/"+n.clockRate+(r!==1?"/"+r:"")+`\r
`},e.parseExtmap=function(n){let i=n.substring(9).split(" ");return {id:parseInt(i[0],10),direction:i[0].indexOf("/")>0?i[0].split("/")[1]:"sendrecv",uri:i[1],attributes:i.slice(2).join(" ")}},e.writeExtmap=function(n){return "a=extmap:"+(n.id||n.preferredId)+(n.direction&&n.direction!=="sendrecv"?"/"+n.direction:"")+" "+n.uri+(n.attributes?" "+n.attributes:"")+`\r
`},e.parseFmtp=function(n){let i={},r,o=n.substring(n.indexOf(" ")+1).split(";");for(let s=0;s<o.length;s++)r=o[s].trim().split("="),i[r[0].trim()]=r[1];return i},e.writeFmtp=function(n){let i="",r=n.payloadType;if(n.preferredPayloadType!==void 0&&(r=n.preferredPayloadType),n.parameters&&Object.keys(n.parameters).length){let o=[];Object.keys(n.parameters).forEach(s=>{n.parameters[s]!==void 0?o.push(s+"="+n.parameters[s]):o.push(s);}),i+="a=fmtp:"+r+" "+o.join(";")+`\r
`;}return i},e.parseRtcpFb=function(n){let i=n.substring(n.indexOf(" ")+1).split(" ");return {type:i.shift(),parameter:i.join(" ")}},e.writeRtcpFb=function(n){let i="",r=n.payloadType;return n.preferredPayloadType!==void 0&&(r=n.preferredPayloadType),n.rtcpFeedback&&n.rtcpFeedback.length&&n.rtcpFeedback.forEach(o=>{i+="a=rtcp-fb:"+r+" "+o.type+(o.parameter&&o.parameter.length?" "+o.parameter:"")+`\r
`;}),i},e.parseSsrcMedia=function(n){let i=n.indexOf(" "),r={ssrc:parseInt(n.substring(7,i),10)},o=n.indexOf(":",i);return o>-1?(r.attribute=n.substring(i+1,o),r.value=n.substring(o+1)):r.attribute=n.substring(i+1),r},e.parseSsrcGroup=function(n){let i=n.substring(13).split(" ");return {semantics:i.shift(),ssrcs:i.map(r=>parseInt(r,10))}},e.getMid=function(n){let i=e.matchPrefix(n,"a=mid:")[0];if(i)return i.substring(6)},e.parseFingerprint=function(n){let i=n.substring(14).split(" ");return {algorithm:i[0].toLowerCase(),value:i[1].toUpperCase()}},e.getDtlsParameters=function(n,i){return {role:"auto",fingerprints:e.matchPrefix(n+i,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(n,i){let r="a=setup:"+i+`\r
`;return n.fingerprints.forEach(o=>{r+="a=fingerprint:"+o.algorithm+" "+o.value+`\r
`;}),r},e.parseCryptoLine=function(n){let i=n.substring(9).split(" ");return {tag:parseInt(i[0],10),cryptoSuite:i[1],keyParams:i[2],sessionParams:i.slice(3)}},e.writeCryptoLine=function(n){return "a=crypto:"+n.tag+" "+n.cryptoSuite+" "+(typeof n.keyParams=="object"?e.writeCryptoKeyParams(n.keyParams):n.keyParams)+(n.sessionParams?" "+n.sessionParams.join(" "):"")+`\r
`},e.parseCryptoKeyParams=function(n){if(n.indexOf("inline:")!==0)return null;let i=n.substring(7).split("|");return {keyMethod:"inline",keySalt:i[0],lifeTime:i[1],mkiValue:i[2]?i[2].split(":")[0]:void 0,mkiLength:i[2]?i[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(n){return n.keyMethod+":"+n.keySalt+(n.lifeTime?"|"+n.lifeTime:"")+(n.mkiValue&&n.mkiLength?"|"+n.mkiValue+":"+n.mkiLength:"")},e.getCryptoParameters=function(n,i){return e.matchPrefix(n+i,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(n,i){let r=e.matchPrefix(n+i,"a=ice-ufrag:")[0],o=e.matchPrefix(n+i,"a=ice-pwd:")[0];return r&&o?{usernameFragment:r.substring(12),password:o.substring(10)}:null},e.writeIceParameters=function(n){let i="a=ice-ufrag:"+n.usernameFragment+`\r
a=ice-pwd:`+n.password+`\r
`;return n.iceLite&&(i+=`a=ice-lite\r
`),i},e.parseRtpParameters=function(n){let i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=e.splitLines(n)[0].split(" ");i.profile=r[2];for(let s=3;s<r.length;s++){let a=r[s],c=e.matchPrefix(n,"a=rtpmap:"+a+" ")[0];if(c){let d=e.parseRtpMap(c),l=e.matchPrefix(n,"a=fmtp:"+a+" ");switch(d.parameters=l.length?e.parseFmtp(l[0]):{},d.rtcpFeedback=e.matchPrefix(n,"a=rtcp-fb:"+a+" ").map(e.parseRtcpFb),i.codecs.push(d),d.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(d.name.toUpperCase());}}}e.matchPrefix(n,"a=extmap:").forEach(s=>{i.headerExtensions.push(e.parseExtmap(s));});let o=e.matchPrefix(n,"a=rtcp-fb:* ").map(e.parseRtcpFb);return i.codecs.forEach(s=>{o.forEach(a=>{s.rtcpFeedback.find(c=>c.type===a.type&&c.parameter===a.parameter)||s.rtcpFeedback.push(a);});}),i},e.writeRtpDescription=function(n,i){let r="";r+="m="+n+" ",r+=i.codecs.length>0?"9":"0",r+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ",r+=i.codecs.map(s=>s.preferredPayloadType!==void 0?s.preferredPayloadType:s.payloadType).join(" ")+`\r
`,r+=`c=IN IP4 0.0.0.0\r
`,r+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,i.codecs.forEach(s=>{r+=e.writeRtpMap(s),r+=e.writeFmtp(s),r+=e.writeRtcpFb(s);});let o=0;return i.codecs.forEach(s=>{s.maxptime>o&&(o=s.maxptime);}),o>0&&(r+="a=maxptime:"+o+`\r
`),i.headerExtensions&&i.headerExtensions.forEach(s=>{r+=e.writeExtmap(s);}),r},e.parseRtpEncodingParameters=function(n){let i=[],r=e.parseRtpParameters(n),o=r.fecMechanisms.indexOf("RED")!==-1,s=r.fecMechanisms.indexOf("ULPFEC")!==-1,a=e.matchPrefix(n,"a=ssrc:").map(h=>e.parseSsrcMedia(h)).filter(h=>h.attribute==="cname"),c=a.length>0&&a[0].ssrc,d,l=e.matchPrefix(n,"a=ssrc-group:FID").map(h=>h.substring(17).split(" ").map(p=>parseInt(p,10)));l.length>0&&l[0].length>1&&l[0][0]===c&&(d=l[0][1]),r.codecs.forEach(h=>{if(h.name.toUpperCase()==="RTX"&&h.parameters.apt){let p={ssrc:c,codecPayloadType:parseInt(h.parameters.apt,10)};c&&d&&(p.rtx={ssrc:d}),i.push(p),o&&(p=JSON.parse(JSON.stringify(p)),p.fec={ssrc:c,mechanism:s?"red+ulpfec":"red"},i.push(p));}}),i.length===0&&c&&i.push({ssrc:c});let u=e.matchPrefix(n,"b=");return u.length&&(u=u[0].indexOf("b=TIAS:")===0?parseInt(u[0].substring(7),10):u[0].indexOf("b=AS:")===0?1e3*parseInt(u[0].substring(5),10)*.95-16e3:void 0,i.forEach(h=>{h.maxBitrate=u;})),i},e.parseRtcpParameters=function(n){let i={},r=e.matchPrefix(n,"a=ssrc:").map(a=>e.parseSsrcMedia(a)).filter(a=>a.attribute==="cname")[0];r&&(i.cname=r.value,i.ssrc=r.ssrc);let o=e.matchPrefix(n,"a=rtcp-rsize");i.reducedSize=o.length>0,i.compound=o.length===0;let s=e.matchPrefix(n,"a=rtcp-mux");return i.mux=s.length>0,i},e.writeRtcpParameters=function(n){let i="";return n.reducedSize&&(i+=`a=rtcp-rsize\r
`),n.mux&&(i+=`a=rtcp-mux\r
`),n.ssrc!==void 0&&n.cname&&(i+="a=ssrc:"+n.ssrc+" cname:"+n.cname+`\r
`),i},e.parseMsid=function(n){let i,r=e.matchPrefix(n,"a=msid:");if(r.length===1)return i=r[0].substring(7).split(" "),{stream:i[0],track:i[1]};let o=e.matchPrefix(n,"a=ssrc:").map(s=>e.parseSsrcMedia(s)).filter(s=>s.attribute==="msid");return o.length>0?(i=o[0].value.split(" "),{stream:i[0],track:i[1]}):void 0},e.parseSctpDescription=function(n){let i=e.parseMLine(n),r=e.matchPrefix(n,"a=max-message-size:"),o;r.length>0&&(o=parseInt(r[0].substring(19),10)),isNaN(o)&&(o=65536);let s=e.matchPrefix(n,"a=sctp-port:");if(s.length>0)return {port:parseInt(s[0].substring(12),10),protocol:i.fmt,maxMessageSize:o};let a=e.matchPrefix(n,"a=sctpmap:");if(a.length>0){let c=a[0].substring(10).split(" ");return {port:parseInt(c[0],10),protocol:c[1],maxMessageSize:o}}},e.writeSctpDescription=function(n,i){let r=[];return r=n.protocol!=="DTLS/SCTP"?["m="+n.kind+" 9 "+n.protocol+" "+i.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+i.port+`\r
`]:["m="+n.kind+" 9 "+n.protocol+" "+i.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+i.port+" "+i.protocol+` 65535\r
`],i.maxMessageSize!==void 0&&r.push("a=max-message-size:"+i.maxMessageSize+`\r
`),r.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(n,i,r){let o,s=i!==void 0?i:2;return o=n||e.generateSessionId(),`v=0\r
o=`+(r||"thisisadapterortc")+" "+o+" "+s+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},e.getDirection=function(n,i){let r=e.splitLines(n);for(let o=0;o<r.length;o++)switch(r[o]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[o].substring(2)}return i?e.getDirection(i):"sendrecv"},e.getKind=function(n){return e.splitLines(n)[0].split(" ")[0].substring(2)},e.isRejected=function(n){return n.split(" ",2)[1]==="0"},e.parseMLine=function(n){let i=e.splitLines(n)[0].substring(2).split(" ");return {kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},e.parseOLine=function(n){let i=e.matchPrefix(n,"o=")[0].substring(2).split(" ");return {username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},e.isValidSDP=function(n){if(typeof n!="string"||n.length===0)return !1;let i=e.splitLines(n);for(let r=0;r<i.length;r++)if(i[r].length<2||i[r].charAt(1)!=="=")return !1;return !0},t.exports=e;})($S);var tR=$S.exports,na=j(tR),h2=L({__proto__:null,default:na},[tR]);function _l(t){if(!t.RTCIceCandidate||t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype)return;let e=t.RTCIceCandidate;t.RTCIceCandidate=function(n){if(typeof n=="object"&&n.candidate&&n.candidate.indexOf("a=")===0&&((n=JSON.parse(JSON.stringify(n))).candidate=n.candidate.substr(2)),n.candidate&&n.candidate.length){let i=new e(n),r=na.parseCandidate(n.candidate),o=Object.assign(i,r);return o.toJSON=function(){return {candidate:o.candidate,sdpMid:o.sdpMid,sdpMLineIndex:o.sdpMLineIndex,usernameFragment:o.usernameFragment}},o}return new e(n)},t.RTCIceCandidate.prototype=e.prototype,ns(t,"icecandidate",n=>(n.candidate&&Object.defineProperty(n,"candidate",{value:new t.RTCIceCandidate(n.candidate),writable:"false"}),n));}function e_(t){!t.RTCIceCandidate||t.RTCIceCandidate&&"relayProtocol"in t.RTCIceCandidate.prototype||ns(t,"icecandidate",e=>{if(e.candidate){let n=na.parseCandidate(e.candidate.candidate);n.type==="relay"&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[n.priority>>24]);}return e});}function ml(t,e){if(!t.RTCPeerConnection)return;"sctp"in t.RTCPeerConnection.prototype||Object.defineProperty(t.RTCPeerConnection.prototype,"sctp",{get(){return this._sctp===void 0?null:this._sctp}});let n=function(a){if(!a||!a.sdp)return !1;let c=na.splitSections(a.sdp);return c.shift(),c.some(d=>{let l=na.parseMLine(d);return l&&l.kind==="application"&&l.protocol.indexOf("SCTP")!==-1})},i=function(a){let c=a.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(c===null||c.length<2)return -1;let d=parseInt(c[1],10);return d!=d?-1:d},r=function(a){let c=65536;return e.browser==="firefox"&&(c=e.version<57?a===-1?16384:2147483637:e.version<60?e.version===57?65535:65536:2147483637),c},o=function(a,c){let d=65536;e.browser==="firefox"&&e.version===57&&(d=65535);let l=na.matchPrefix(a.sdp,"a=max-message-size:");return l.length>0?d=parseInt(l[0].substr(19),10):e.browser==="firefox"&&c!==-1&&(d=2147483637),d},s=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,e.browser==="chrome"&&e.version>=76){let{sdpSemantics:a}=this.getConfiguration();a==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return this._sctp===void 0?null:this._sctp},enumerable:!0,configurable:!0});}if(n(arguments[0])){let a=i(arguments[0]),c=r(a),d=o(arguments[0],a),l;l=c===0&&d===0?Number.POSITIVE_INFINITY:c===0||d===0?Math.max(c,d):Math.min(c,d);let u={};Object.defineProperty(u,"maxMessageSize",{get:()=>l}),this._sctp=u;}return s.apply(this,arguments)};}function El(t){if(!t.RTCPeerConnection||!("createDataChannel"in t.RTCPeerConnection.prototype))return;function e(i,r){let o=i.send;i.send=function(){let s=arguments[0],a=s.length||s.size||s.byteLength;if(i.readyState==="open"&&r.sctp&&a>r.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+r.sctp.maxMessageSize+" bytes)");return o.apply(i,arguments)};}let n=t.RTCPeerConnection.prototype.createDataChannel;t.RTCPeerConnection.prototype.createDataChannel=function(){let i=n.apply(this,arguments);return e(i,this),i},ns(t,"datachannel",i=>(e(i.channel,i.target),i));}function n_(t){if(!t.RTCPeerConnection||"connectionState"in t.RTCPeerConnection.prototype)return;let e=t.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return {completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(n){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),n&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=n);},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(n=>{let i=e[n];e[n]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=r=>{let o=r.target;if(o._lastConnectionState!==o.connectionState){o._lastConnectionState=o.connectionState;let s=new Event("connectionstatechange",r);o.dispatchEvent(s);}return r},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)};});}function i_(t,e){if(!t.RTCPeerConnection||e.browser==="chrome"&&e.version>=71||e.browser==="safari"&&e.version>=605)return;let n=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(i){if(i&&i.sdp&&i.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){let r=i.sdp.split(`
`).filter(o=>vn(o).call(o)!=="a=extmap-allow-mixed").join(`
`);t.RTCSessionDescription&&i instanceof t.RTCSessionDescription?arguments[0]=new t.RTCSessionDescription({type:i.type,sdp:r}):i.sdp=r;}return n.apply(this,arguments)};}function fl(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;let n=t.RTCPeerConnection.prototype.addIceCandidate;n&&n.length!==0&&(t.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(e.browser==="chrome"&&e.version<78||e.browser==="firefox"&&e.version<68||e.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?K.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),K.resolve())});}function gl(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;let n=t.RTCPeerConnection.prototype.setLocalDescription;n&&n.length!==0&&(t.RTCPeerConnection.prototype.setLocalDescription=function(){let i=arguments[0]||{};if(typeof i!="object"||i.type&&i.sdp)return n.apply(this,arguments);if(i={type:i.type,sdp:i.sdp},!i.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":i.type="offer";break;default:i.type="answer";}return i.sdp||i.type!=="offer"&&i.type!=="answer"?n.apply(this,[i]):(i.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(r=>n.apply(this,[r]))});}var p2=Object.freeze({__proto__:null,removeExtmapAllowMixed:i_,shimAddIceCandidateNullOrEmpty:fl,shimConnectionState:n_,shimMaxMessageSize:ml,shimParameterlessSetLocalDescription:gl,shimRTCIceCandidate:_l,shimRTCIceCandidateRelayProtocol:e_,shimSendThrowTypeError:El});(function(){let{window:t}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0},n=Cg,i=function(o){let s={browser:null,version:null};if(o===void 0||!o.navigator)return s.browser="Not a browser.",s;let{navigator:a}=o;if(a.mozGetUserMedia)s.browser="firefox",s.version=Hd(a.userAgent,/Firefox\/(\d+)\./,1);else if(a.webkitGetUserMedia||o.isSecureContext===!1&&o.webkitRTCPeerConnection)s.browser="chrome",s.version=Hd(a.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else {if(!o.RTCPeerConnection||!a.userAgent.match(/AppleWebKit\/(\d+)\./))return s.browser="Not a supported browser.",s;s.browser="safari",s.version=Hd(a.userAgent,/AppleWebKit\/(\d+)\./,1),s.supportsUnifiedPlan=o.RTCRtpTransceiver&&"currentDirection"in o.RTCRtpTransceiver.prototype;}return s}(t),r={browserDetails:i,commonShim:p2,extractVersion:Hd,disableLog:lL,disableWarnings:uL,sdp:h2};switch(i.browser){case"chrome":if(!wS||!Xp||!e.shimChrome)return n("Chrome shim is not included in this adapter release."),r;if(i.version===null)return n("Chrome shim can not determine version, not shimming."),r;n("adapter.js shimming chrome."),r.browserShim=wS,fl(t,i),gl(t),TS(t,i),SS(t),Xp(t,i),RS(t),AS(t,i),CS(t),vS(t),IS(t),bS(t,i),_l(t),e_(t),n_(t),ml(t,i),El(t),i_(t,i);break;case"firefox":if(!FS||!Qp||!e.shimFirefox)return n("Firefox shim is not included in this adapter release."),r;n("adapter.js shimming firefox."),r.browserShim=FS,fl(t,i),gl(t),OS(t,i),Qp(t,i),NS(t),LS(t),DS(t),PS(t),kS(t),MS(t),US(t),xS(t),VS(t),_l(t),n_(t),ml(t,i),El(t);break;case"safari":if(!JS||!e.shimSafari)return n("Safari shim is not included in this adapter release."),r;n("adapter.js shimming safari."),r.browserShim=JS,fl(t,i),gl(t),KS(t),qS(t),GS(t),BS(t),jS(t),YS(t),WS(t),zS(t),_l(t),e_(t),ml(t,i),El(t),i_(t,i);break;default:n("Unsupported browser!");}})({window:typeof window>"u"?void 0:window});var _2=Mi("Array").keys,m2=Cr,E2=_n,f2=ut,g2=_2,r_=Array.prototype,T2={DOMTokenList:!0,NodeList:!0},S2=function(t){var e=t.keys;return t===r_||f2(r_,t)&&e===r_.keys||E2(T2,m2(t))?g2:e},ri=j(S2),eR=Hs,R2=TypeError,C2=Fd,v2=ki,I2=ho,Tl=function(t,e,n){var i=C2(e);i in t?v2.f(t,i,I2(0,n)):t[i]=n;},nR=jh,y2=qr,A2=Tl,b2=Array,w2=Math.max,o_=function(t,e,n){for(var i=y2(t),r=nR(e,i),o=nR(n===void 0?i:n,i),s=b2(w2(o-r,0)),a=0;r<o;r++,a++)A2(s,a,t[r]);return s.length=a,s},iR=o_,O2=Math.floor,s_=function(t,e){var n=t.length,i=O2(n/2);return n<8?N2(t,e):D2(t,s_(iR(t,0,i),e),s_(iR(t,i),e),e)},N2=function(t,e){for(var n,i,r=t.length,o=1;o<r;){for(i=o,n=t[o];i&&e(t[i-1],n)>0;)t[i]=t[--i];i!==o++&&(t[i]=n);}return t},D2=function(t,e,n,i){for(var r=e.length,o=n.length,s=0,a=0;s<r||a<o;)t[s+a]=s<r&&a<o?i(e[s],n[a])<=0?e[s++]:n[a++]:s<r?e[s++]:n[a++];return t},rR=s_,oR=ts.match(/firefox\/(\d+)/i),P2=!!oR&&+oR[1],L2=/MSIE|Trident/.test(ts),sR=ts.match(/AppleWebKit\/(\d+)\./),k2=!!sR&&+sR[1],M2=ee,aR=Et,U2=Li,x2=Rr,cR=qr,V2=function(t,e){if(!delete t[e])throw R2("Cannot delete property "+eR(e)+" of "+eR(t))},dR=Ri,a_=H,F2=rR,B2=Wd,lR=P2,j2=L2,uR=es,hR=k2,To=[],pR=aR(To.sort),G2=aR(To.push),W2=a_(function(){To.sort(void 0);}),H2=a_(function(){To.sort(null);}),K2=B2("sort"),_R=!a_(function(){if(uR)return uR<70;if(!(lR&&lR>3)){if(j2)return !0;if(hR)return hR<603;var t,e,n,i,r="";for(t=65;t<76;t++){switch(e=String.fromCharCode(t),t){case 66:case 69:case 70:case 72:n=3;break;case 68:case 71:n=4;break;default:n=2;}for(i=0;i<47;i++)To.push({k:e+i,v:n});}for(To.sort(function(o,s){return s.v-o.v}),i=0;i<To.length;i++)e=To[i].k.charAt(0),r.charAt(r.length-1)!==e&&(r+=e);return r!=="DGBEFHACIJK"}});M2({target:"Array",proto:!0,forced:W2||!H2||!K2||!_R},{sort:function(t){t!==void 0&&U2(t);var e=x2(this);if(_R)return t===void 0?pR(e):pR(e,t);var n,i,r=[],o=cR(e);for(i=0;i<o;i++)i in e&&G2(r,e[i]);for(F2(r,function(s){return function(a,c){return c===void 0?-1:a===void 0?1:s!==void 0?+s(a,c)||0:dR(a)>dR(c)?1:-1}}(t)),n=cR(r),i=0;i<n;)e[i]=r[i++];for(;i<o;)V2(e,i++);return e}});var Y2=Mi("Array").sort,q2=ut,z2=Y2,c_=Array.prototype,J2=function(t){var e=t.sort;return t===c_||q2(c_,t)&&e===c_.sort?z2:e},vc=j(J2),d_={exports:{}};(function(t,e){(function(n,i){var r="function",o="undefined",s="object",a="string",c="major",d="model",l="name",u="type",h="vendor",p="version",T="architecture",m="console",E="mobile",S="tablet",C="smarttv",A="wearable",b="embedded",O="Amazon",N="Apple",k="ASUS",M="BlackBerry",x="Browser",X="Chrome",bt="Firefox",Ft="Google",re="Huawei",Le="LG",Ee="Microsoft",nr="Motorola",U="Opera",G="Samsung",$="Sharp",ht="Sony",Ut="Xiaomi",Y="Zebra",f="Facebook",I="Chromium OS",y="Mac OS",B=function(be){for(var Ve={},ce=0;ce<be.length;ce++)Ve[be[ce].toUpperCase()]=be[ce];return Ve},pt=function(be,Ve){return typeof be===a&&Yt(Ve).indexOf(Yt(be))!==-1},Yt=function(be){return be.toLowerCase()},We=function(be,Ve){if(typeof be===a)return be=be.replace(/^\s\s*/,""),typeof Ve===o?be:be.substring(0,350)},qn=function(be,Ve){for(var ce,ei,Hr,we,xt,zn,Xo=0;Xo<Ve.length&&!xt;){var Tr=Ve[Xo],_N=Ve[Xo+1];for(ce=ei=0;ce<Tr.length&&!xt&&Tr[ce];)if(xt=Tr[ce++].exec(be))for(Hr=0;Hr<_N.length;Hr++)zn=xt[++ei],typeof(we=_N[Hr])===s&&we.length>0?we.length===2?typeof we[1]==r?this[we[0]]=we[1].call(this,zn):this[we[0]]=we[1]:we.length===3?typeof we[1]!==r||we[1].exec&&we[1].test?this[we[0]]=zn?zn.replace(we[1],we[2]):i:this[we[0]]=zn?we[1].call(this,zn,we[2]):i:we.length===4&&(this[we[0]]=zn?we[3].call(this,zn.replace(we[1],we[2])):i):this[we]=zn||i;Xo+=2;}},lo=function(be,Ve){for(var ce in Ve)if(typeof Ve[ce]===s&&Ve[ce].length>0){for(var ei=0;ei<Ve[ce].length;ei++)if(pt(Ve[ce][ei],be))return ce==="?"?i:ce}else if(pt(Ve[ce],be))return ce==="?"?i:ce;return be},hh={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},ph={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[p,[l,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[p,[l,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[l,p],[/opios[\/ ]+([\w\.]+)/i],[p,[l,U+" Mini"]],[/\bopr\/([\w\.]+)/i],[p,[l,U]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[l,p],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[p,[l,"UC"+x]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[p,[l,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[p,[l,"WeChat"]],[/konqueror\/([\w\.]+)/i],[p,[l,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[p,[l,"IE"]],[/yabrowser\/([\w\.]+)/i],[p,[l,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[l,/(.+)/,"$1 Secure "+x],p],[/\bfocus\/([\w\.]+)/i],[p,[l,bt+" Focus"]],[/\bopt\/([\w\.]+)/i],[p,[l,U+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[p,[l,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[p,[l,"Dolphin"]],[/coast\/([\w\.]+)/i],[p,[l,U+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[p,[l,"MIUI "+x]],[/fxios\/([-\w\.]+)/i],[p,[l,bt]],[/\bqihu|(qi?ho?o?|360)browser/i],[[l,"360 "+x]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[l,/(.+)/,"$1 "+x],p],[/(comodo_dragon)\/([\w\.]+)/i],[[l,/_/g," "],p],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[l,p],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[l],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[l,f],p],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[l,p],[/\bgsa\/([\w\.]+) .*safari\//i],[p,[l,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[p,[l,X+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[l,X+" WebView"],p],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[p,[l,"Android "+x]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[l,p],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[p,[l,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[p,l],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[l,[p,lo,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[l,p],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[l,"Netscape"],p],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[p,[l,bt+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[l,p],[/(cobalt)\/([\w\.]+)/i],[l,[p,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[T,"amd64"]],[/(ia32(?=;))/i],[[T,Yt]],[/((?:i[346]|x)86)[;\)]/i],[[T,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[T,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[T,"armhf"]],[/windows (ce|mobile); ppc;/i],[[T,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[T,/ower/,"",Yt]],[/(sun4\w)[;\)]/i],[[T,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[T,Yt]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[d,[h,G],[u,S]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[d,[h,G],[u,E]],[/\((ip(?:hone|od)[\w ]*);/i],[d,[h,N],[u,E]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[d,[h,N],[u,S]],[/(macintosh);/i],[d,[h,N]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[d,[h,$],[u,E]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[d,[h,re],[u,S]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[d,[h,re],[u,E]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[d,/_/g," "],[h,Ut],[u,E]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[d,/_/g," "],[h,Ut],[u,S]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[d,[h,"OPPO"],[u,E]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[d,[h,"Vivo"],[u,E]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[d,[h,"Realme"],[u,E]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[d,[h,nr],[u,E]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[d,[h,nr],[u,S]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[d,[h,Le],[u,S]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[d,[h,Le],[u,E]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[d,[h,"Lenovo"],[u,S]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[d,/_/g," "],[h,"Nokia"],[u,E]],[/(pixel c)\b/i],[d,[h,Ft],[u,S]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[d,[h,Ft],[u,E]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[d,[h,ht],[u,E]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[d,"Xperia Tablet"],[h,ht],[u,S]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[d,[h,"OnePlus"],[u,E]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[d,[h,O],[u,S]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[d,/(.+)/g,"Fire Phone $1"],[h,O],[u,E]],[/(playbook);[-\w\),; ]+(rim)/i],[d,h,[u,S]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[d,[h,M],[u,E]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[d,[h,k],[u,S]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[d,[h,k],[u,E]],[/(nexus 9)/i],[d,[h,"HTC"],[u,S]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[h,[d,/_/g," "],[u,E]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[d,[h,"Acer"],[u,S]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[d,[h,"Meizu"],[u,E]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[h,d,[u,E]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[h,d,[u,S]],[/(surface duo)/i],[d,[h,Ee],[u,S]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[d,[h,"Fairphone"],[u,E]],[/(u304aa)/i],[d,[h,"AT&T"],[u,E]],[/\bsie-(\w*)/i],[d,[h,"Siemens"],[u,E]],[/\b(rct\w+) b/i],[d,[h,"RCA"],[u,S]],[/\b(venue[\d ]{2,7}) b/i],[d,[h,"Dell"],[u,S]],[/\b(q(?:mv|ta)\w+) b/i],[d,[h,"Verizon"],[u,S]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[d,[h,"Barnes & Noble"],[u,S]],[/\b(tm\d{3}\w+) b/i],[d,[h,"NuVision"],[u,S]],[/\b(k88) b/i],[d,[h,"ZTE"],[u,S]],[/\b(nx\d{3}j) b/i],[d,[h,"ZTE"],[u,E]],[/\b(gen\d{3}) b.+49h/i],[d,[h,"Swiss"],[u,E]],[/\b(zur\d{3}) b/i],[d,[h,"Swiss"],[u,S]],[/\b((zeki)?tb.*\b) b/i],[d,[h,"Zeki"],[u,S]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[h,"Dragon Touch"],d,[u,S]],[/\b(ns-?\w{0,9}) b/i],[d,[h,"Insignia"],[u,S]],[/\b((nxa|next)-?\w{0,9}) b/i],[d,[h,"NextBook"],[u,S]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[h,"Voice"],d,[u,E]],[/\b(lvtel\-)?(v1[12]) b/i],[[h,"LvTel"],d,[u,E]],[/\b(ph-1) /i],[d,[h,"Essential"],[u,E]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[d,[h,"Envizen"],[u,S]],[/\b(trio[-\w\. ]+) b/i],[d,[h,"MachSpeed"],[u,S]],[/\btu_(1491) b/i],[d,[h,"Rotor"],[u,S]],[/(shield[\w ]+) b/i],[d,[h,"Nvidia"],[u,S]],[/(sprint) (\w+)/i],[h,d,[u,E]],[/(kin\.[onetw]{3})/i],[[d,/\./g," "],[h,Ee],[u,E]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[d,[h,Y],[u,S]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[d,[h,Y],[u,E]],[/smart-tv.+(samsung)/i],[h,[u,C]],[/hbbtv.+maple;(\d+)/i],[[d,/^/,"SmartTV"],[h,G],[u,C]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[h,Le],[u,C]],[/(apple) ?tv/i],[h,[d,N+" TV"],[u,C]],[/crkey/i],[[d,X+"cast"],[h,Ft],[u,C]],[/droid.+aft(\w)( bui|\))/i],[d,[h,O],[u,C]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[d,[h,$],[u,C]],[/(bravia[\w ]+)( bui|\))/i],[d,[h,ht],[u,C]],[/(mitv-\w{5}) bui/i],[d,[h,Ut],[u,C]],[/Hbbtv.*(technisat) (.*);/i],[h,d,[u,C]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[h,We],[d,We],[u,C]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[u,C]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[h,d,[u,m]],[/droid.+; (shield) bui/i],[d,[h,"Nvidia"],[u,m]],[/(playstation [345portablevi]+)/i],[d,[h,ht],[u,m]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[d,[h,Ee],[u,m]],[/((pebble))app/i],[h,d,[u,A]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[d,[h,N],[u,A]],[/droid.+; (glass) \d/i],[d,[h,Ft],[u,A]],[/droid.+; (wt63?0{2,3})\)/i],[d,[h,Y],[u,A]],[/(quest( 2| pro)?)/i],[d,[h,f],[u,A]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[h,[u,b]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[d,[u,E]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[d,[u,S]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[u,S]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[u,E]],[/(android[-\w\. ]{0,9});.+buil/i],[d,[h,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[p,[l,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[p,[l,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[l,p],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[p,l]],os:[[/microsoft (windows) (vista|xp)/i],[l,p],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[l,[p,lo,hh]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[l,"Windows"],[p,lo,hh]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[p,/_/g,"."],[l,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[l,y],[p,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[p,l],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[l,p],[/\(bb(10);/i],[p,[l,M]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[p,[l,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[p,[l,bt+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[p,[l,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[p,[l,"watchOS"]],[/crkey\/([\d\.]+)/i],[p,[l,X+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[l,I],p],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[l,p],[/(sunos) ?([\w\.\d]*)/i],[[l,"Solaris"],p],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[l,p]]},Pi=function(be,Ve){if(typeof be===s&&(Ve=be,be=i),!(this instanceof Pi))return new Pi(be,Ve).getResult();var ce=typeof n!==o&&n.navigator?n.navigator:i,ei=be||(ce&&ce.userAgent?ce.userAgent:""),Hr=ce&&ce.userAgentData?ce.userAgentData:i,we=Ve?function(xt,zn){var Xo={};for(var Tr in xt)zn[Tr]&&zn[Tr].length%2==0?Xo[Tr]=zn[Tr].concat(xt[Tr]):Xo[Tr]=xt[Tr];return Xo}(ph,Ve):ph;return this.getBrowser=function(){var xt={};return xt[l]=i,xt[p]=i,qn.call(xt,ei,we.browser),xt[c]=function(zn){return typeof zn===a?zn.replace(/[^\d\.]/g,"").split(".")[0]:i}(xt[p]),ce&&ce.brave&&typeof ce.brave.isBrave==r&&(xt[l]="Brave"),xt},this.getCPU=function(){var xt={};return xt[T]=i,qn.call(xt,ei,we.cpu),xt},this.getDevice=function(){var xt={};return xt[h]=i,xt[d]=i,xt[u]=i,qn.call(xt,ei,we.device),!xt[u]&&Hr&&Hr.mobile&&(xt[u]=E),xt[d]=="Macintosh"&&ce&&typeof ce.standalone!==o&&ce.maxTouchPoints&&ce.maxTouchPoints>2&&(xt[d]="iPad",xt[u]=S),xt},this.getEngine=function(){var xt={};return xt[l]=i,xt[p]=i,qn.call(xt,ei,we.engine),xt},this.getOS=function(){var xt={};return xt[l]=i,xt[p]=i,qn.call(xt,ei,we.os),!xt[l]&&Hr&&Hr.platform!="Unknown"&&(xt[l]=Hr.platform.replace(/chrome os/i,I).replace(/macos/i,y)),xt},this.getResult=function(){return {ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return ei},this.setUA=function(xt){return ei=typeof xt===a&&xt.length>350?We(xt,350):xt,this},this.setUA(ei),this};Pi.VERSION="0.7.34",Pi.BROWSER=B([l,p,c]),Pi.CPU=B([T]),Pi.DEVICE=B([d,h,u,m,E,C,S,A,b]),Pi.ENGINE=Pi.OS=B([l,p]),t.exports&&(e=t.exports=Pi),e.UAParser=Pi;var Jo=typeof n!==o&&(n.jQuery||n.Zepto);if(Jo&&!Jo.ua){var nc=new Pi;Jo.ua=nc.getResult(),Jo.ua.get=function(){return nc.getUA()},Jo.ua.set=function(be){nc.setUA(be);var Ve=nc.getResult();for(var ce in Ve)Jo.ua[ce]=Ve[ce];};}})(typeof window=="object"?window:V);})(d_,d_.exports);var X2=j(d_.exports),Q2=Cr,Z2=_n,$2=js,tx=is,ex=Oe("iterator"),nx=Object,ix=function(t){if($2(t))return !1;var e=nx(t);return e[ex]!==void 0||"@@iterator"in e||Z2(tx,Q2(e))},rx=j(ix),l_=Vt;ee({global:!0,forced:l_.globalThis!==l_},{globalThis:l_});var mR=j(Vt);function ER(t,e){return function(){return t.apply(e,arguments)}}let{toString:ox}=Object.prototype,{getPrototypeOf:u_}=Object,Sl=(h_=Object.create(null),t=>{let e=ox.call(t);return h_[e]||(h_[e]=e.slice(8,-1).toLowerCase())});var h_;let yr=t=>(t=t.toLowerCase(),e=>Sl(e)===t),Rl=t=>e=>typeof e===t,{isArray:ia}=Array,Ic=Rl("undefined"),fR=yr("ArrayBuffer"),sx=Rl("string"),Ui=Rl("function"),gR=Rl("number"),Cl=t=>t!==null&&typeof t=="object",vl=t=>{if(Sl(t)!=="object")return !1;let e=u_(t);return !(e!==null&&e!==Object.prototype&&Object.getPrototypeOf(e)!==null||Symbol.toStringTag in t||rx(t))},ax=yr("Date"),cx=yr("File"),dx=yr("Blob"),lx=yr("FileList"),ux=yr("URLSearchParams");function yc(t,e){let n,i,{allOwnKeys:r=!1}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(t!=null)if(typeof t!="object"&&(t=[t]),ia(t))for(n=0,i=t.length;n<i;n++)e.call(null,t[n],n,t);else {let o=r?Object.getOwnPropertyNames(t):Object.keys(t),s=o.length,a;for(n=0;n<s;n++)a=o[n],e.call(null,t[a],a,t);}}function TR(t,e){e=e.toLowerCase();let n=Object.keys(t),i,r=n.length;for(;r-- >0;)if(i=n[r],e===i.toLowerCase())return i;return null}let SR=mR!==void 0?mR:typeof self<"u"?self:typeof window<"u"?window:global,RR=t=>!Ic(t)&&t!==SR,hx=(p_=typeof Uint8Array<"u"&&u_(Uint8Array),t=>p_&&t instanceof p_);var p_;let px=yr("HTMLFormElement"),CR=(t=>{let{hasOwnProperty:e}=t;return (n,i)=>e.call(n,i)})(Object.prototype),_x=yr("RegExp"),vR=(t,e)=>{let n=Object.getOwnPropertyDescriptors(t),i={};yc(n,(r,o)=>{let s;(s=e(r,o,t))!==!1&&(i[o]=s||r);}),Object.defineProperties(t,i);},__="abcdefghijklmnopqrstuvwxyz",IR="0123456789",yR={DIGIT:IR,ALPHA:__,ALPHA_DIGIT:__+__.toUpperCase()+IR},mx=yr("AsyncFunction");var Z={isArray:ia,isArrayBuffer:fR,isBuffer:function(t){return t!==null&&!Ic(t)&&t.constructor!==null&&!Ic(t.constructor)&&Ui(t.constructor.isBuffer)&&t.constructor.isBuffer(t)},isFormData:t=>{let e;return t&&(typeof FormData=="function"&&t instanceof FormData||Ui(t.append)&&((e=Sl(t))==="formdata"||e==="object"&&Ui(t.toString)&&t.toString()==="[object FormData]"))},isArrayBufferView:function(t){let e;return e=typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(t):t&&t.buffer&&fR(t.buffer),e},isString:sx,isNumber:gR,isBoolean:t=>t===!0||t===!1,isObject:Cl,isPlainObject:vl,isUndefined:Ic,isDate:ax,isFile:cx,isBlob:dx,isRegExp:_x,isFunction:Ui,isStream:t=>Cl(t)&&Ui(t.pipe),isURLSearchParams:ux,isTypedArray:hx,isFileList:lx,forEach:yc,merge:function t(){let{caseless:e}=RR(this)&&this||{},n={},i=(r,o)=>{let s=e&&TR(n,o)||o;vl(n[s])&&vl(r)?n[s]=t(n[s],r):vl(r)?n[s]=t({},r):ia(r)?n[s]=r.slice():n[s]=r;};for(let r=0,o=arguments.length;r<o;r++)arguments[r]&&yc(arguments[r],i);return n},extend:function(t,e,n){let{allOwnKeys:i}=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};return yc(e,(r,o)=>{n&&Ui(r)?t[o]=ER(r,n):t[o]=r;},{allOwnKeys:i}),t},trim:t=>vn(t)?vn(t).call(t):t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:t=>(t.charCodeAt(0)===65279&&(t=t.slice(1)),t),inherits:(t,e,n,i)=>{t.prototype=Object.create(e.prototype,i),t.prototype.constructor=t,Object.defineProperty(t,"super",{value:e.prototype}),n&&Object.assign(t.prototype,n);},toFlatObject:(t,e,n,i)=>{let r,o,s,a={};if(e=e||{},t==null)return e;do{for(r=Object.getOwnPropertyNames(t),o=r.length;o-- >0;)s=r[o],i&&!i(s,t,e)||a[s]||(e[s]=t[s],a[s]=!0);t=n!==!1&&u_(t);}while(t&&(!n||n(t,e))&&t!==Object.prototype);return e},kindOf:Sl,kindOfTest:yr,endsWith:(t,e,n)=>{t=String(t),(n===void 0||n>t.length)&&(n=t.length),n-=e.length;let i=t.indexOf(e,n);return i!==-1&&i===n},toArray:t=>{if(!t)return null;if(ia(t))return t;let e=t.length;if(!gR(e))return null;let n=new Array(e);for(;e-- >0;)n[e]=t[e];return n},forEachEntry:(t,e)=>{let n=(t&&t[Symbol.iterator]).call(t),i;for(;(i=n.next())&&!i.done;){let r=i.value;e.call(t,r[0],r[1]);}},matchAll:(t,e)=>{let n,i=[];for(;(n=t.exec(e))!==null;)i.push(n);return i},isHTMLForm:px,hasOwnProperty:CR,hasOwnProp:CR,reduceDescriptors:vR,freezeMethods:t=>{vR(t,(e,n)=>{if(Ui(t)&&["arguments","caller","callee"].indexOf(n)!==-1)return !1;let i=t[n];Ui(i)&&(e.enumerable=!1,"writable"in e?e.writable=!1:e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+n+"'")}));});},toObjectSet:(t,e)=>{let n={},i=r=>{r.forEach(o=>{n[o]=!0;});};return ia(t)?i(t):i(String(t).split(e)),n},toCamelCase:t=>t.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(e,n,i){return n.toUpperCase()+i}),noop:()=>{},toFiniteNumber:(t,e)=>(t=+t,Number.isFinite(t)?t:e),findKey:TR,global:SR,isContextDefined:RR,ALPHABET:yR,generateString:function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:16,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:yR.ALPHA_DIGIT,n="",{length:i}=e;for(;t--;)n+=e[Math.random()*i|0];return n},isSpecCompliantForm:function(t){return !!(t&&Ui(t.append)&&t[Symbol.toStringTag]==="FormData"&&t[Symbol.iterator])},toJSONObject:t=>{let e=new Array(10),n=(i,r)=>{if(Cl(i)){if(e.indexOf(i)>=0)return;if(!("toJSON"in i)){e[r]=i;let o=ia(i)?[]:{};return yc(i,(s,a)=>{let c=n(s,r+1);!Ic(c)&&(o[a]=c);}),e[r]=void 0,o}}return i};return n(t,0)},isAsyncFn:mx,isThenable:t=>t&&(Cl(t)||Ui(t))&&Ui(t.then)&&Ui(t.catch)};function pe(t,e,n,i,r){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=t,this.name="AxiosError",e&&(this.code=e),n&&(this.config=n),i&&(this.request=i),r&&(this.response=r);}Z.inherits(pe,Error,{toJSON:function(){return {message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:Z.toJSONObject(this.config),code:this.code,status:this.response&&this.response.status?this.response.status:null}}});let AR=pe.prototype,bR={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(t=>{bR[t]={value:t};}),Object.defineProperties(pe,bR),Object.defineProperty(AR,"isAxiosError",{value:!0}),pe.from=(t,e,n,i,r,o)=>{let s=Object.create(AR);return Z.toFlatObject(t,s,function(a){return a!==Error.prototype},a=>a!=="isAxiosError"),pe.call(s,t.message,e,n,i,r),s.cause=t,s.name=t.name,o&&Object.assign(s,o),s};function m_(t){return Z.isPlainObject(t)||Z.isArray(t)}function wR(t){return Z.endsWith(t,"[]")?t.slice(0,-2):t}function OR(t,e,n){return t?t.concat(e).map(function(i,r){return i=wR(i),!n&&r?"["+i+"]":i}).join(n?".":""):e}let Ex=Z.toFlatObject(Z,{},null,function(t){return /^is[A-Z]/.test(t)});function Il(t,e,n){if(!Z.isObject(t))throw new TypeError("target must be an object");e=e||new FormData;let i=(n=Z.toFlatObject(n,{metaTokens:!0,dots:!1,indexes:!1},!1,function(h,p){return !Z.isUndefined(p[h])})).metaTokens,r=n.visitor||d,o=n.dots,s=n.indexes,a=(n.Blob||typeof Blob<"u"&&Blob)&&Z.isSpecCompliantForm(e);if(!Z.isFunction(r))throw new TypeError("visitor must be a function");function c(h){if(h===null)return "";if(Z.isDate(h))return h.toISOString();if(!a&&Z.isBlob(h))throw new pe("Blob is not supported. Use a Buffer instead.");return Z.isArrayBuffer(h)||Z.isTypedArray(h)?a&&typeof Blob=="function"?new Blob([h]):Buffer.from(h):h}function d(h,p,T){let m=h;if(h&&!T&&typeof h=="object"){if(Z.endsWith(p,"{}"))p=i?p:p.slice(0,-2),h=JSON.stringify(h);else if(Z.isArray(h)&&function(E){return Z.isArray(E)&&!E.some(m_)}(h)||(Z.isFileList(h)||Z.endsWith(p,"[]"))&&(m=Z.toArray(h)))return p=wR(p),m.forEach(function(E,S){!Z.isUndefined(E)&&E!==null&&e.append(s===!0?OR([p],S,o):s===null?p:p+"[]",c(E));}),!1}return !!m_(h)||(e.append(OR(T,p,o),c(h)),!1)}let l=[],u=Object.assign(Ex,{defaultVisitor:d,convertValue:c,isVisitable:m_});if(!Z.isObject(t))throw new TypeError("data must be an object");return function h(p,T){if(!Z.isUndefined(p)){if(l.indexOf(p)!==-1)throw Error("Circular reference detected in "+T.join("."));l.push(p),Z.forEach(p,function(m,E){(!(Z.isUndefined(m)||m===null)&&r.call(e,m,Z.isString(E)?vn(E).call(E):E,T,u))===!0&&h(m,T?T.concat(E):[E]);}),l.pop();}}(t),e}function NR(t){let e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(t).replace(/[!'()~]|%20|%00/g,function(n){return e[n]})}function E_(t,e){this._pairs=[],t&&Il(t,this,e);}let DR=E_.prototype;function fx(t){return encodeURIComponent(t).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function PR(t,e,n){if(!e)return t;let i=n&&n.encode||fx,r=n&&n.serialize,o;if(o=r?r(e,n):Z.isURLSearchParams(e)?e.toString():new E_(e,n).toString(i),o){let s=t.indexOf("#");s!==-1&&(t=t.slice(0,s)),t+=(t.indexOf("?")===-1?"?":"&")+o;}return t}DR.append=function(t,e){this._pairs.push([t,e]);},DR.toString=function(t){let e=t?function(n){return t.call(this,n,NR)}:NR;return this._pairs.map(function(n){return e(n[0])+"="+e(n[1])},"").join("&")};var LR=class{constructor(){this.handlers=[];}use(t,e,n){return this.handlers.push({fulfilled:t,rejected:e,synchronous:!!n&&n.synchronous,runWhen:n?n.runWhen:null}),this.handlers.length-1}eject(t){this.handlers[t]&&(this.handlers[t]=null);}clear(){this.handlers&&(this.handlers=[]);}forEach(t){Z.forEach(this.handlers,function(e){e!==null&&t(e);});}},kR={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},MR={exports:{}},gx=ee,Tx=Si,UR=ki.f;gx({target:"Object",stat:!0,forced:Object.defineProperty!==UR,sham:!Tx},{defineProperty:UR});var xR=ir.Object,Sx=MR.exports=function(t,e,n){return xR.defineProperty(t,e,n)};xR.defineProperty.sham&&(Sx.sham=!0);var VR=j(MR.exports),Rx=Tn,Ac=Array.isArray||function(t){return Rx(t)=="Array"},Cx=TypeError,FR=Ac,vx=sl,Ix=ii,yx=Oe("species"),BR=Array,Ax=function(t){var e;return FR(t)&&(e=t.constructor,(vx(e)&&(e===BR||FR(e.prototype))||Ix(e)&&(e=e[yx])===null)&&(e=void 0)),e===void 0?BR:e},jR=function(t,e){return new(Ax(t))(e===0?0:e)},bx=H,wx=es,Ox=Oe("species"),GR=function(t){return wx>=51||!bx(function(){var e=[];return (e.constructor={})[Ox]=function(){return {foo:1}},e[t](Boolean).foo!==1})},Nx=ee,Dx=H,Px=Ac,Lx=ii,kx=Rr,Mx=qr,WR=function(t){if(t>9007199254740991)throw Cx("Maximum allowed index exceeded");return t},HR=Tl,Ux=jR,xx=GR,Vx=es,KR=Oe("isConcatSpreadable"),Fx=Vx>=51||!Dx(function(){var t=[];return t[KR]=!1,t.concat()[0]!==t}),Bx=function(t){if(!Lx(t))return !1;var e=t[KR];return e!==void 0?!!e:Px(t)};Nx({target:"Array",proto:!0,arity:1,forced:!Fx||!xx("concat")},{concat:function(t){var e,n,i,r,o,s=kx(this),a=Ux(s,0),c=0;for(e=-1,i=arguments.length;e<i;e++)if(Bx(o=e===-1?s:arguments[e]))for(r=Mx(o),WR(c+r),n=0;n<r;n++,c++)n in o&&HR(a,c,o[n]);else WR(c+1),HR(a,c++,o);return a.length=c,a}});var YR={},jx=Tn,Gx=po,qR=Yd.f,Wx=o_,zR=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];YR.f=function(t){return zR&&jx(t)=="Window"?function(e){try{return qR(e)}catch{return Wx(zR)}}(t):qR(Gx(t))};var ra={},Hx=Oe;ra.f=Hx;var JR=ir,Kx=_n,Yx=ra,qx=ki.f,cn=function(t){var e=JR.Symbol||(JR.Symbol={});Kx(e,t)||qx(e,t,{value:Yx.f(t)});},zx=an,Jx=Jn,Xx=Oe,Qx=Eo,XR=function(){var t=Jx("Symbol"),e=t&&t.prototype,n=e&&e.valueOf,i=Xx("toPrimitive");e&&!e[i]&&Qx(e,i,function(r){return zx(n,this)},{arity:1});},Zx=_o,$x=xd,tV=Rr,eV=qr,nV=jR,QR=Et([].push),So=function(t){var e=t==1,n=t==2,i=t==3,r=t==4,o=t==6,s=t==7,a=t==5||o;return function(c,d,l,u){for(var h,p,T=tV(c),m=$x(T),E=Zx(d,l),S=eV(m),C=0,A=u||nV,b=e?A(c,S):n||s?A(c,0):void 0;S>C;C++)if((a||C in m)&&(p=E(h=m[C],C,T),t))if(e)b[C]=p;else if(p)switch(t){case 3:return !0;case 5:return h;case 6:return C;case 2:QR(b,h);}else switch(t){case 4:return !1;case 7:QR(b,h);}return o?-1:i||r?r:b}},ZR={forEach:So(0),map:So(1),filter:So(2),some:So(3),every:So(4),find:So(5),findIndex:So(6),filterReject:So(7)},yl=ee,f_=Vt,g_=an,iV=Et,oa=Si,sa=Ws,rV=H,wn=_n,oV=ut,T_=jn,Al=po,S_=Fd,sV=Ri,R_=ho,bc=pc,$R=zd,aV=Yd,tC=YR,cV=hc,eC=cc,nC=ki,dV=$h,iC=Md,rC=Eo,lV=ol,C_=Ks,oC=qd,sC=Ph,uV=Oe,hV=ra,pV=cn,_V=XR,mV=fo,aC=os,bl=ZR.forEach,oi=Kd("hidden"),wl="Symbol",wc="prototype",EV=aC.set,cC=aC.getterFor(wl),or=Object[wc],cs=f_.Symbol,Ol=cs&&cs[wc],fV=f_.TypeError,v_=f_.QObject,dC=eC.f,ds=nC.f,lC=tC.f,gV=iC.f,uC=iV([].push),zr=C_("symbols"),Oc=C_("op-symbols"),TV=C_("wks"),I_=!v_||!v_[wc]||!v_[wc].findChild,y_=oa&&rV(function(){return bc(ds({},"a",{get:function(){return ds(this,"a",{value:7}).a}})).a!=7})?function(t,e,n){var i=dC(or,e);i&&delete or[e],ds(t,e,n),i&&t!==or&&ds(or,e,i);}:ds,A_=function(t,e){var n=zr[t]=bc(Ol);return EV(n,{type:wl,tag:t,description:e}),oa||(n.description=e),n},Nl=function(t,e,n){t===or&&Nl(Oc,e,n),T_(t);var i=S_(e);return T_(n),wn(zr,i)?(n.enumerable?(wn(t,oi)&&t[oi][i]&&(t[oi][i]=!1),n=bc(n,{enumerable:R_(0,!1)})):(wn(t,oi)||ds(t,oi,R_(1,{})),t[oi][i]=!0),y_(t,i,n)):ds(t,i,n)},b_=function(t,e){T_(t);var n=Al(e),i=$R(n).concat(mC(n));return bl(i,function(r){oa&&!g_(hC,n,r)||Nl(t,r,n[r]);}),t},hC=function(t){var e=S_(t),n=g_(gV,this,e);return !(this===or&&wn(zr,e)&&!wn(Oc,e))&&(!(n||!wn(this,e)||!wn(zr,e)||wn(this,oi)&&this[oi][e])||n)},pC=function(t,e){var n=Al(t),i=S_(e);if(n!==or||!wn(zr,i)||wn(Oc,i)){var r=dC(n,i);return !r||!wn(zr,i)||wn(n,oi)&&n[oi][i]||(r.enumerable=!0),r}},_C=function(t){var e=lC(Al(t)),n=[];return bl(e,function(i){wn(zr,i)||wn(oC,i)||uC(n,i);}),n},mC=function(t){var e=t===or,n=lC(e?Oc:Al(t)),i=[];return bl(n,function(r){!wn(zr,r)||e&&!wn(or,r)||uC(i,zr[r]);}),i};sa||(cs=function(){if(oV(Ol,this))throw fV("Symbol is not a constructor");var t=arguments.length&&arguments[0]!==void 0?sV(arguments[0]):void 0,e=sC(t),n=function(i){this===or&&g_(n,Oc,i),wn(this,oi)&&wn(this[oi],e)&&(this[oi][e]=!1),y_(this,e,R_(1,i));};return oa&&I_&&y_(or,e,{configurable:!0,set:n}),A_(e,t)},rC(Ol=cs[wc],"toString",function(){return cC(this).tag}),rC(cs,"withoutSetter",function(t){return A_(sC(t),t)}),iC.f=hC,nC.f=Nl,dV.f=b_,eC.f=pC,aV.f=tC.f=_C,cV.f=mC,hV.f=function(t){return A_(uV(t),t)},oa&&lV(Ol,"description",{configurable:!0,get:function(){return cC(this).description}})),yl({global:!0,constructor:!0,wrap:!0,forced:!sa,sham:!sa},{Symbol:cs}),bl($R(TV),function(t){pV(t);}),yl({target:wl,stat:!0,forced:!sa},{useSetter:function(){I_=!0;},useSimple:function(){I_=!1;}}),yl({target:"Object",stat:!0,forced:!sa,sham:!oa},{create:function(t,e){return e===void 0?bc(t):b_(bc(t),e)},defineProperty:Nl,defineProperties:b_,getOwnPropertyDescriptor:pC}),yl({target:"Object",stat:!0,forced:!sa},{getOwnPropertyNames:_C}),_V(),mV(cs,wl),oC[oi]=!0;var EC=Ws&&!!Symbol.for&&!!Symbol.keyFor,SV=ee,RV=Jn,CV=_n,vV=Ri,fC=Ks,IV=EC,w_=fC("string-to-symbol-registry"),yV=fC("symbol-to-string-registry");SV({target:"Symbol",stat:!0,forced:!IV},{for:function(t){var e=vV(t);if(CV(w_,e))return w_[e];var n=RV("Symbol")(e);return w_[e]=n,yV[n]=e,n}});var AV=ee,bV=_n,wV=dc,OV=Hs,NV=EC,gC=Ks("symbol-to-string-registry");AV({target:"Symbol",stat:!0,forced:!NV},{keyFor:function(t){if(!wV(t))throw TypeError(OV(t)+" is not a symbol");if(bV(gC,t))return gC[t]}});var TC=Ac,DV=sn,SC=Tn,PV=Ri,RC=Et([].push),LV=ee,CC=Jn,vC=Se,kV=an,Nc=Et,IC=H,yC=sn,AC=dc,bC=Rp,MV=function(t){if(DV(t))return t;if(TC(t)){for(var e=t.length,n=[],i=0;i<e;i++){var r=t[i];typeof r=="string"?RC(n,r):typeof r!="number"&&SC(r)!="Number"&&SC(r)!="String"||RC(n,PV(r));}var o=n.length,s=!0;return function(a,c){if(s)return s=!1,c;if(TC(this))return c;for(var d=0;d<o;d++)if(n[d]===a)return c}}},UV=Ws,xV=String,Ro=CC("JSON","stringify"),Dl=Nc(/./.exec),wC=Nc("".charAt),VV=Nc("".charCodeAt),FV=Nc("".replace),BV=Nc(1 .toString),jV=/[\uD800-\uDFFF]/g,OC=/^[\uD800-\uDBFF]$/,NC=/^[\uDC00-\uDFFF]$/,DC=!UV||IC(function(){var t=CC("Symbol")();return Ro([t])!="[null]"||Ro({a:t})!="{}"||Ro(Object(t))!="{}"}),PC=IC(function(){return Ro("\uDF06\uD834")!=='"\\udf06\\ud834"'||Ro("\uDEAD")!=='"\\udead"'}),GV=function(t,e){var n=bC(arguments),i=MV(e);if(yC(i)||t!==void 0&&!AC(t))return n[1]=function(r,o){if(yC(i)&&(o=kV(i,this,xV(r),o)),!AC(o))return o},vC(Ro,null,n)},WV=function(t,e,n){var i=wC(n,e-1),r=wC(n,e+1);return Dl(OC,t)&&!Dl(NC,r)||Dl(NC,t)&&!Dl(OC,i)?"\\u"+BV(VV(t,0),16):t};Ro&&LV({target:"JSON",stat:!0,arity:3,forced:DC||PC},{stringify:function(t,e,n){var i=bC(arguments),r=vC(DC?GV:Ro,null,i);return PC&&typeof r=="string"?FV(r,jV,WV):r}});var LC=hc,HV=Rr;ee({target:"Object",stat:!0,forced:!Ws||H(function(){LC.f(1);})},{getOwnPropertySymbols:function(t){var e=LC.f;return e?e(HV(t)):[]}}),cn("asyncIterator"),cn("hasInstance"),cn("isConcatSpreadable"),cn("iterator"),cn("match"),cn("matchAll"),cn("replace"),cn("search"),cn("species"),cn("split");var KV=XR;cn("toPrimitive"),KV();var YV=Jn,qV=fo;cn("toStringTag"),qV(YV("Symbol"),"Symbol"),cn("unscopables"),fo(Vt.JSON,"JSON",!0);var zV=ir.Symbol,JV=Oe,XV=ki.f,kC=JV("metadata"),MC=Function.prototype;MC[kC]===void 0&&XV(MC,kC,{value:null}),cn("dispose"),cn("metadata");var QV=zV;cn("asyncDispose");var ZV=Et,O_=Jn("Symbol"),$V=O_.keyFor,tF=ZV(O_.prototype.valueOf),UC=O_.isRegisteredSymbol||function(t){try{return $V(tF(t))!==void 0}catch{return !1}};ee({target:"Symbol",stat:!0},{isRegisteredSymbol:UC});for(var eF=Ks,xC=Jn,nF=Et,iF=dc,rF=Oe,Pl=xC("Symbol"),VC=Pl.isWellKnownSymbol,FC=xC("Object","getOwnPropertyNames"),oF=nF(Pl.prototype.valueOf),BC=eF("wks"),N_=0,jC=FC(Pl),sF=jC.length;N_<sF;N_++)try{var GC=jC[N_];iF(Pl[GC])&&rF(GC);}catch{}var WC=function(t){if(VC&&VC(t))return !0;try{for(var e=oF(t),n=0,i=FC(BC),r=i.length;n<r;n++)if(BC[i[n]]==e)return !0}catch{}return !1};ee({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:WC}),cn("matcher"),cn("observable"),ee({target:"Symbol",stat:!0,name:"isRegisteredSymbol"},{isRegistered:UC}),ee({target:"Symbol",stat:!0,name:"isWellKnownSymbol",forced:!0},{isWellKnown:WC}),cn("metadataKey"),cn("patternMatch"),cn("replaceAll");var aa=j(QV),HC=j(ra.f("iterator"));function Dc(t){return Dc=typeof aa=="function"&&typeof HC=="symbol"?function(e){return typeof e}:function(e){return e&&typeof aa=="function"&&e.constructor===aa&&e!==aa.prototype?"symbol":typeof e},Dc(t)}var aF=j(ra.f("toPrimitive"));function cF(t){var e=function(n,i){if(Dc(n)!=="object"||n===null)return n;var r=n[aF];if(r!==void 0){var o=r.call(n,i||"default");if(Dc(o)!=="object")return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return (i==="string"?String:Number)(n)}(t,"string");return Dc(e)==="symbol"?e:String(e)}function g(t,e,n){return (e=cF(e))in t?VR(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var dF=H,lF=Oe("iterator"),D_=!dF(function(){var t=new URL("b?a=1&b=2&c=3","http://a"),e=t.searchParams,n=new URLSearchParams("a=1&a=2"),i="";return t.pathname="c%20d",e.forEach(function(r,o){e.delete("b"),i+=o+r;}),n.delete("a",2),!t.toJSON||!n.has("a",1)||n.has("a",2)||!e.size&&!0||!e.sort||t.href!=="http://a/c%20d?a=1&c=3"||e.get("c")!=="3"||String(new URLSearchParams("?a=1"))!=="a=1"||!e[lF]||new URL("https://a@b").username!=="a"||new URLSearchParams(new URLSearchParams("a=b")).get("a")!=="b"||new URL("http://\u0442\u0435\u0441\u0442").host!=="xn--e1aybc"||new URL("http://a#\u0431").hash!=="#%D0%B1"||i!=="a1c3"||new URL("http://x",void 0).host!=="x"}),uF=Eo,P_=ee,ca=Vt,Ll=an,Ar=Et,da=Si,KC=D_,YC=Eo,hF=ol,pF=function(t,e,n){for(var i in e)n&&n.unsafe&&t[i]?t[i]=e[i]:uF(t,i,e[i],n);return t},_F=fo,mF=pp,L_=os,qC=Ep,k_=sn,EF=_n,fF=_o,gF=Cr,TF=jn,zC=ii,Xn=Ri,SF=pc,JC=ho,M_=ip,RF=Qd,la=al,CF=rR,vF=Oe("iterator"),Pc="URLSearchParams",XC=Pc+"Iterator",QC=L_.set,xi=L_.getterFor(Pc),IF=L_.getterFor(XC),yF=Object.getOwnPropertyDescriptor,U_=function(t){if(!da)return ca[t];var e=yF(ca,t);return e&&e.value},ZC=U_("fetch"),kl=U_("Request"),Lc=U_("Headers"),x_=kl&&kl.prototype,$C=Lc&&Lc.prototype,AF=ca.RegExp,bF=ca.TypeError,tv=ca.decodeURIComponent,wF=ca.encodeURIComponent,OF=Ar("".charAt),ev=Ar([].join),ls=Ar([].push),V_=Ar("".replace),NF=Ar([].shift),nv=Ar([].splice),iv=Ar("".split),DF=Ar("".slice),PF=/\+/g,rv=Array(4),LF=function(t){return rv[t-1]||(rv[t-1]=AF("((?:%[\\da-f]{2}){"+t+"})","gi"))},kF=function(t){try{return tv(t)}catch{return t}},ov=function(t){var e=V_(t,PF," "),n=4;try{return tv(e)}catch{for(;n;)e=V_(e,LF(n--),kF);return e}},MF=/[!'()~]|%20/g,UF={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},xF=function(t){return UF[t]},sv=function(t){return V_(wF(t),MF,xF)},F_=mF(function(t,e){QC(this,{type:XC,iterator:M_(xi(t).entries),kind:e});},"Iterator",function(){var t=IF(this),e=t.kind,n=t.iterator.next(),i=n.value;return n.done||(n.value=e==="keys"?i.key:e==="values"?i.value:[i.key,i.value]),n},!0),av=function(t){this.entries=[],this.url=null,t!==void 0&&(zC(t)?this.parseObject(t):this.parseQuery(typeof t=="string"?OF(t,0)==="?"?DF(t,1):t:Xn(t)));};av.prototype={type:Pc,bindURL:function(t){this.url=t,this.update();},parseObject:function(t){var e,n,i,r,o,s,a,c=RF(t);if(c)for(n=(e=M_(t,c)).next;!(i=Ll(n,e)).done;){if(o=(r=M_(TF(i.value))).next,(s=Ll(o,r)).done||(a=Ll(o,r)).done||!Ll(o,r).done)throw bF("Expected sequence with length 2");ls(this.entries,{key:Xn(s.value),value:Xn(a.value)});}else for(var d in t)EF(t,d)&&ls(this.entries,{key:d,value:Xn(t[d])});},parseQuery:function(t){if(t)for(var e,n,i=iv(t,"&"),r=0;r<i.length;)(e=i[r++]).length&&(n=iv(e,"="),ls(this.entries,{key:ov(NF(n)),value:ov(ev(n,"="))}));},serialize:function(){for(var t,e=this.entries,n=[],i=0;i<e.length;)t=e[i++],ls(n,sv(t.key)+"="+sv(t.value));return ev(n,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query);},updateURL:function(){this.url&&this.url.update();}};var Ml=function(){qC(this,ua);var t=QC(this,new av(arguments.length>0?arguments[0]:void 0));da||(this.size=t.entries.length);},ua=Ml.prototype;if(pF(ua,{append:function(t,e){var n=xi(this);la(arguments.length,2),ls(n.entries,{key:Xn(t),value:Xn(e)}),da||this.length++,n.updateURL();},delete:function(t){for(var e=xi(this),n=la(arguments.length,1),i=e.entries,r=Xn(t),o=n<2?void 0:arguments[1],s=o===void 0?o:Xn(o),a=0;a<i.length;){var c=i[a];if(c.key!==r||s!==void 0&&c.value!==s)a++;else if(nv(i,a,1),s!==void 0)break}da||(this.size=i.length),e.updateURL();},get:function(t){var e=xi(this).entries;la(arguments.length,1);for(var n=Xn(t),i=0;i<e.length;i++)if(e[i].key===n)return e[i].value;return null},getAll:function(t){var e=xi(this).entries;la(arguments.length,1);for(var n=Xn(t),i=[],r=0;r<e.length;r++)e[r].key===n&&ls(i,e[r].value);return i},has:function(t){for(var e=xi(this).entries,n=la(arguments.length,1),i=Xn(t),r=n<2?void 0:arguments[1],o=r===void 0?r:Xn(r),s=0;s<e.length;){var a=e[s++];if(a.key===i&&(o===void 0||a.value===o))return !0}return !1},set:function(t,e){var n=xi(this);la(arguments.length,1);for(var i,r=n.entries,o=!1,s=Xn(t),a=Xn(e),c=0;c<r.length;c++)(i=r[c]).key===s&&(o?nv(r,c--,1):(o=!0,i.value=a));o||ls(r,{key:s,value:a}),da||(this.size=r.length),n.updateURL();},sort:function(){var t=xi(this);CF(t.entries,function(e,n){return e.key>n.key?1:-1}),t.updateURL();},forEach:function(t){for(var e,n=xi(this).entries,i=fF(t,arguments.length>1?arguments[1]:void 0),r=0;r<n.length;)i((e=n[r++]).value,e.key,this);},keys:function(){return new F_(this,"keys")},values:function(){return new F_(this,"values")},entries:function(){return new F_(this,"entries")}},{enumerable:!0}),YC(ua,vF,ua.entries,{name:"entries"}),YC(ua,"toString",function(){return xi(this).serialize()},{enumerable:!0}),da&&hF(ua,"size",{get:function(){return xi(this).entries.length},configurable:!0,enumerable:!0}),_F(Ml,Pc),P_({global:!0,constructor:!0,forced:!KC},{URLSearchParams:Ml}),!KC&&k_(Lc)){var VF=Ar($C.has),FF=Ar($C.set),cv=function(t){if(zC(t)){var e,n=t.body;if(gF(n)===Pc)return e=t.headers?new Lc(t.headers):new Lc,VF(e,"content-type")||FF(e,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),SF(t,{body:JC(0,Xn(n)),headers:JC(0,e)})}return t};if(k_(ZC)&&P_({global:!0,enumerable:!0,dontCallGetSet:!0,forced:!0},{fetch:function(t){return ZC(t,arguments.length>1?cv(arguments[1]):{})}}),k_(kl)){var B_=function(t){return qC(this,x_),new kl(t,arguments.length>1?cv(arguments[1]):{})};x_.constructor=B_,B_.prototype=x_,P_({global:!0,constructor:!0,dontCallGetSet:!0,forced:!0},{Request:B_});}}var BF={URLSearchParams:Ml,getState:xi},dv=j(ir.URLSearchParams),jF={isBrowser:!0,classes:{URLSearchParams:dv!==void 0?dv:E_,FormData:typeof FormData<"u"?FormData:null,Blob:typeof Blob<"u"?Blob:null},protocols:["http","https","file","blob","url","data"]};let lv=typeof window<"u"&&typeof document<"u",GF=(uv=typeof navigator<"u"&&navigator.product,lv&&["ReactNative","NativeScript","NS"].indexOf(uv)<0);var uv;let WF=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function";function hv(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function pv(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?hv(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):hv(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}var br=pv(pv({},Object.freeze({__proto__:null,hasBrowserEnv:lv,hasStandardBrowserEnv:GF,hasStandardBrowserWebWorkerEnv:WF})),jF),HF=jn,KF=an,YF=_n,qF=ut,zF=function(){var t=HF(this),e="";return t.hasIndices&&(e+="d"),t.global&&(e+="g"),t.ignoreCase&&(e+="i"),t.multiline&&(e+="m"),t.dotAll&&(e+="s"),t.unicode&&(e+="u"),t.unicodeSets&&(e+="v"),t.sticky&&(e+="y"),e},_v=RegExp.prototype,mv=function(t){var e=t.flags;return e!==void 0||"flags"in _v||YF(t,"flags")||!qF(_v,t)?e:KF(zF,t)},JF=qp.charAt,Ev=an,XF=jn,QF=sn,ZF=Tn,$F=/./.exec,tB=TypeError,eB=ee,fv=an,gv=ac,nB=pp,Ul=mp,Tv=Gs,Sv=hg,kc=Ri,iB=jn,rB=js,oB=Tn,sB=_g,Rv=mv,aB=Vd,cB=H,dB=Sp,lB=function(t,e,n){return e+(n?JF(t,e).length:1)},uB=function(t,e){var n=t.exec;if(QF(n)){var i=Ev(n,t,e);return i!==null&&XF(i),i}if(ZF(t)==="RegExp")return Ev($F,t,e);throw tB("RegExp#exec called on incompatible receiver")},Cv=os,hB=Oe("matchAll"),vv="RegExp String",Iv=vv+" Iterator",pB=Cv.set,_B=Cv.getterFor(Iv),mB=TypeError,j_=gv("".indexOf),xl=gv("".matchAll),G_=!!xl&&!cB(function(){xl("a",/./);}),EB=nB(function(t,e,n,i){pB(this,{type:Iv,regexp:t,string:e,global:n,unicode:i,done:!1});},vv,function(){var t=_B(this);if(t.done)return Ul(void 0,!0);var e=t.regexp,n=t.string,i=uB(e,n);return i===null?(t.done=!0,Ul(void 0,!0)):t.global?(kc(i[0])===""&&(e.lastIndex=lB(n,Sv(e.lastIndex),t.unicode)),Ul(i,!1)):(t.done=!0,Ul(i,!1))}),yv=function(t){var e,n,i,r=iB(this),o=kc(t),s=dB(r,RegExp),a=kc(Rv(r));return e=new s(s===RegExp?r.source:r,a),n=!!~j_(a,"g"),i=!!~j_(a,"u"),e.lastIndex=Sv(r.lastIndex),new EB(e,o,n,i)};eB({target:"String",proto:!0,forced:G_},{matchAll:function(t){var e,n,i,r,o=Tv(this);if(rB(t)){if(G_)return xl(o,t)}else {if(sB(t)&&(e=kc(Tv(Rv(t))),!~j_(e,"g")))throw mB("`.matchAll` does not allow non-global regexes");if(G_)return xl(o,t);if((i=aB(t,hB))===void 0&&oB(t)=="RegExp"&&(i=yv),i)return fv(i,t,o)}return n=kc(o),r=new RegExp(t,"g"),fv(yv,r,n)}});var fB=Mi("String").matchAll,gB=ut,TB=fB,W_=String.prototype,SB=function(t){var e=t.matchAll;return typeof t=="string"||t===W_||gB(W_,t)&&e===W_.matchAll?TB:e},RB=j(SB);function Av(t){function e(n,i,r,o){let s=n[o++];if(s==="__proto__")return !0;let a=Number.isFinite(+s),c=o>=n.length;return s=!s&&Z.isArray(r)?r.length:s,c?(Z.hasOwnProp(r,s)?r[s]=[r[s],i]:r[s]=i,!a):(r[s]&&Z.isObject(r[s])||(r[s]=[]),e(n,i,r[s],o)&&Z.isArray(r[s])&&(r[s]=function(d){let l={},u=Object.keys(d),h,p=u.length,T;for(h=0;h<p;h++)T=u[h],l[T]=d[T];return l}(r[s])),!a)}if(Z.isFormData(t)&&Z.isFunction(t.entries)){let n={};return Z.forEachEntry(t,(i,r)=>{e(function(o){return RB(Z).call(Z,/\w+|\[(\w*)]/g,o).map(s=>s[0]==="[]"?"":s[1]||s[0])}(i),r,n,0);}),n}return null}let H_={transitional:kR,adapter:["xhr","http"],transformRequest:[function(t,e){let n=e.getContentType()||"",i=n.indexOf("application/json")>-1,r=Z.isObject(t);if(r&&Z.isHTMLForm(t)&&(t=new FormData(t)),Z.isFormData(t))return i?JSON.stringify(Av(t)):t;if(Z.isArrayBuffer(t)||Z.isBuffer(t)||Z.isStream(t)||Z.isFile(t)||Z.isBlob(t))return t;if(Z.isArrayBufferView(t))return t.buffer;if(Z.isURLSearchParams(t))return e.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),t.toString();let o;if(r){if(n.indexOf("application/x-www-form-urlencoded")>-1)return function(s,a){return Il(s,new br.classes.URLSearchParams,Object.assign({visitor:function(c,d,l,u){return br.isNode&&Z.isBuffer(c)?(this.append(d,c.toString("base64")),!1):u.defaultVisitor.apply(this,arguments)}},a))}(t,this.formSerializer).toString();if((o=Z.isFileList(t))||n.indexOf("multipart/form-data")>-1){let s=this.env&&this.env.FormData;return Il(o?{"files[]":t}:t,s&&new s,this.formSerializer)}}return r||i?(e.setContentType("application/json",!1),function(s,a,c){if(Z.isString(s))try{return (a||JSON.parse)(s),vn(Z).call(Z,s)}catch(d){if(d.name!=="SyntaxError")throw d}return (0, JSON.stringify)(s)}(t)):t}],transformResponse:[function(t){let e=this.transitional||H_.transitional,n=e&&e.forcedJSONParsing,i=this.responseType==="json";if(t&&Z.isString(t)&&(n&&!this.responseType||i)){let r=!(e&&e.silentJSONParsing)&&i;try{return JSON.parse(t)}catch(o){if(r)throw o.name==="SyntaxError"?pe.from(o,pe.ERR_BAD_RESPONSE,this,null,this.response):o}}return t}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:br.classes.FormData,Blob:br.classes.Blob},validateStatus:function(t){return t>=200&&t<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};Z.forEach(["delete","get","head","post","put","patch"],t=>{H_.headers[t]={};});var K_=H_;let CB=Z.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),bv=Symbol("internals");function Mc(t){var e;return t&&vn(e=String(t)).call(e).toLowerCase()}function Vl(t){return t===!1||t==null?t:Z.isArray(t)?t.map(Vl):String(t)}function Y_(t,e,n,i,r){return Z.isFunction(i)?i.call(this,e,n):(r&&(e=n),Z.isString(e)?Z.isString(i)?e.indexOf(i)!==-1:Z.isRegExp(i)?i.test(e):void 0:void 0)}class Fl{constructor(e){e&&this.set(e);}set(e,n,i){let r=this;function o(c,d,l){let u=Mc(d);if(!u)throw new Error("header name must be a non-empty string");let h=Z.findKey(r,u);(!h||r[h]===void 0||l===!0||l===void 0&&r[h]!==!1)&&(r[h||d]=Vl(c));}let s=(c,d)=>Z.forEach(c,(l,u)=>o(l,u,d));var a;return Z.isPlainObject(e)||e instanceof this.constructor?s(e,n):Z.isString(e)&&(e=vn(e).call(e))&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(vn(a=e).call(a))?s((c=>{let d={},l,u,h;return c&&c.split(`
`).forEach(function(p){var T,m;h=p.indexOf(":"),l=vn(T=p.substring(0,h)).call(T).toLowerCase(),u=vn(m=p.substring(h+1)).call(m),!l||d[l]&&CB[l]||(l==="set-cookie"?d[l]?d[l].push(u):d[l]=[u]:d[l]=d[l]?d[l]+", "+u:u);}),d})(e),n):e!=null&&o(n,e,i),this}get(e,n){if(e=Mc(e)){let i=Z.findKey(this,e);if(i){let r=this[i];if(!n)return r;if(n===!0)return function(o){let s=Object.create(null),a=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g,c;for(;c=a.exec(o);)s[c[1]]=c[2];return s}(r);if(Z.isFunction(n))return n.call(this,r,i);if(Z.isRegExp(n))return n.exec(r);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,n){if(e=Mc(e)){let i=Z.findKey(this,e);return !(!i||this[i]===void 0||n&&!Y_(0,this[i],i,n))}return !1}delete(e,n){let i=this,r=!1;function o(s){if(s=Mc(s)){let a=Z.findKey(i,s);!a||n&&!Y_(0,i[a],a,n)||(delete i[a],r=!0);}}return Z.isArray(e)?e.forEach(o):o(e),r}clear(e){let n=Object.keys(this),i=n.length,r=!1;for(;i--;){let o=n[i];e&&!Y_(0,this[o],o,e,!0)||(delete this[o],r=!0);}return r}normalize(e){let n=this,i={};return Z.forEach(this,(r,o)=>{var s;let a=Z.findKey(i,o);if(a)return n[a]=Vl(r),void delete n[o];let c=e?function(d){return vn(d).call(d).toLowerCase().replace(/([a-z\d])(\w*)/g,(l,u,h)=>u.toUpperCase()+h)}(o):vn(s=String(o)).call(s);c!==o&&delete n[o],n[c]=Vl(r),i[c]=!0;}),this}concat(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];return this.constructor.concat(this,...n)}toJSON(e){let n=Object.create(null);return Z.forEach(this,(i,r)=>{i!=null&&i!==!1&&(n[r]=e&&Z.isArray(i)?i.join(", "):i);}),n}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(e=>{let[n,i]=e;return n+": "+i}).join(`
`)}get[Symbol.toStringTag](){return "AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e){let n=new this(e);for(var i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];return r.forEach(s=>n.set(s)),n}static accessor(e){let n=(this[bv]=this[bv]={accessors:{}}).accessors,i=this.prototype;function r(o){let s=Mc(o);n[s]||(function(a,c){let d=Z.toCamelCase(" "+c);["get","set","has"].forEach(l=>{Object.defineProperty(a,l+d,{value:function(u,h,p){return this[l].call(this,c,u,h,p)},configurable:!0});});}(i,o),n[s]=!0);}return Z.isArray(e)?e.forEach(r):r(e),this}}Fl.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),Z.reduceDescriptors(Fl.prototype,(t,e)=>{let{value:n}=t,i=e[0].toUpperCase()+e.slice(1);return {get:()=>n,set(r){this[i]=r;}}}),Z.freezeMethods(Fl);var Jr=Fl;function q_(t,e){let n=this||K_,i=e||n,r=Jr.from(i.headers),o=i.data;return Z.forEach(t,function(s){o=s.call(n,o,r.normalize(),e?e.status:void 0);}),r.normalize(),o}function wv(t){return !(!t||!t.__CANCEL__)}function Uc(t,e,n){pe.call(this,t??"canceled",pe.ERR_CANCELED,e,n),this.name="CanceledError";}Z.inherits(Uc,pe,{__CANCEL__:!0});var vB=br.hasStandardBrowserEnv?{write(t,e,n,i,r,o){let s=[t+"="+encodeURIComponent(e)];Z.isNumber(n)&&s.push("expires="+new Date(n).toGMTString()),Z.isString(i)&&s.push("path="+i),Z.isString(r)&&s.push("domain="+r),o===!0&&s.push("secure"),document.cookie=s.join("; ");},read(t){let e=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove(t){this.write(t,"",Date.now()-864e5);}}:{write(){},read:()=>null,remove(){}};function Ov(t,e){return t&&!function(n){return /^([a-z][a-z\d+\-.]*:)?\/\//i.test(n)}(e)?function(n,i){return i?n.replace(/\/?\/$/,"")+"/"+i.replace(/^\/+/,""):n}(t,e):e}var IB=br.hasStandardBrowserEnv?function(){let t=/(msie|trident)/i.test(navigator.userAgent),e=document.createElement("a"),n;function i(r){let o=r;return t&&(e.setAttribute("href",o),o=e.href),e.setAttribute("href",o),{href:e.href,protocol:e.protocol?e.protocol.replace(/:$/,""):"",host:e.host,search:e.search?e.search.replace(/^\?/,""):"",hash:e.hash?e.hash.replace(/^#/,""):"",hostname:e.hostname,port:e.port,pathname:e.pathname.charAt(0)==="/"?e.pathname:"/"+e.pathname}}return n=i(window.location.href),function(r){let o=Z.isString(r)?i(r):r;return o.protocol===n.protocol&&o.host===n.host}}():function(){return !0};function Nv(t,e){let n=0,i=function(r,o){r=r||10;let s=new Array(r),a=new Array(r),c,d=0,l=0;return o=o!==void 0?o:1e3,function(u){let h=Date.now(),p=a[l];c||(c=h),s[d]=u,a[d]=h;let T=l,m=0;for(;T!==d;)m+=s[T++],T%=r;if(d=(d+1)%r,d===l&&(l=(l+1)%r),h-c<o)return;let E=p&&h-p;return E?Math.round(1e3*m/E):void 0}}(50,250);return r=>{let o=r.loaded,s=r.lengthComputable?r.total:void 0,a=o-n,c=i(a);n=o;let d={loaded:o,total:s,progress:s?o/s:void 0,bytes:a,rate:c||void 0,estimated:c&&s&&o<=s?(s-o)/c:void 0,event:r};d[e?"download":"upload"]=!0,t(d);}}var yB=typeof XMLHttpRequest<"u"&&function(t){return new K(function(e,n){let i=t.data,r=Jr.from(t.headers).normalize(),o,s,{responseType:a,withXSRFToken:c}=t;function d(){t.cancelToken&&t.cancelToken.unsubscribe(o),t.signal&&t.signal.removeEventListener("abort",o);}if(Z.isFormData(i)){if(br.hasStandardBrowserEnv||br.hasStandardBrowserWebWorkerEnv)r.setContentType(!1);else if((s=r.getContentType())!==!1){let[T,...m]=s?s.split(";").map(E=>vn(E).call(E)).filter(Boolean):[];r.setContentType([T||"multipart/form-data",...m].join("; "));}}let l=new XMLHttpRequest;if(t.auth){let T=t.auth.username||"",m=t.auth.password?unescape(encodeURIComponent(t.auth.password)):"";r.set("Authorization","Basic "+btoa(T+":"+m));}let u=Ov(t.baseURL,t.url);function h(){if(!l)return;let T=Jr.from("getAllResponseHeaders"in l&&l.getAllResponseHeaders());((function(m,E,S){let C=S.config.validateStatus;S.status&&C&&!C(S.status)?E(new pe("Request failed with status code "+S.status,[pe.ERR_BAD_REQUEST,pe.ERR_BAD_RESPONSE][Math.floor(S.status/100)-4],S.config,S.request,S)):m(S);}))(function(m){e(m),d();},function(m){n(m),d();},{data:a&&a!=="text"&&a!=="json"?l.response:l.responseText,status:l.status,statusText:l.statusText,headers:T,config:t,request:l}),l=null;}if(l.open(t.method.toUpperCase(),PR(u,t.params,t.paramsSerializer),!0),l.timeout=t.timeout,"onloadend"in l?l.onloadend=h:l.onreadystatechange=function(){l&&l.readyState===4&&(l.status!==0||l.responseURL&&l.responseURL.indexOf("file:")===0)&&setTimeout(h);},l.onabort=function(){l&&(n(new pe("Request aborted",pe.ECONNABORTED,t,l)),l=null);},l.onerror=function(){n(new pe("Network Error",pe.ERR_NETWORK,t,l)),l=null;},l.ontimeout=function(){let T=t.timeout?"timeout of "+t.timeout+"ms exceeded":"timeout exceeded",m=t.transitional||kR;t.timeoutErrorMessage&&(T=t.timeoutErrorMessage),n(new pe(T,m.clarifyTimeoutError?pe.ETIMEDOUT:pe.ECONNABORTED,t,l)),l=null;},br.hasStandardBrowserEnv&&(c&&Z.isFunction(c)&&(c=c(t)),c||c!==!1&&IB(u))){let T=t.xsrfHeaderName&&t.xsrfCookieName&&vB.read(t.xsrfCookieName);T&&r.set(t.xsrfHeaderName,T);}i===void 0&&r.setContentType(null),"setRequestHeader"in l&&Z.forEach(r.toJSON(),function(T,m){l.setRequestHeader(m,T);}),Z.isUndefined(t.withCredentials)||(l.withCredentials=!!t.withCredentials),a&&a!=="json"&&(l.responseType=t.responseType),typeof t.onDownloadProgress=="function"&&l.addEventListener("progress",Nv(t.onDownloadProgress,!0)),typeof t.onUploadProgress=="function"&&l.upload&&l.upload.addEventListener("progress",Nv(t.onUploadProgress)),(t.cancelToken||t.signal)&&(o=T=>{l&&(n(!T||T.type?new Uc(null,t,l):T),l.abort(),l=null);},t.cancelToken&&t.cancelToken.subscribe(o),t.signal&&(t.signal.aborted?o():t.signal.addEventListener("abort",o)));let p=function(T){let m=/^([-+\w]{1,25})(:?\/\/|:)/.exec(T);return m&&m[1]||""}(u);p&&br.protocols.indexOf(p)===-1?n(new pe("Unsupported protocol "+p+":",pe.ERR_BAD_REQUEST,t)):l.send(i||null);})};let z_={http:null,xhr:yB};Z.forEach(z_,(t,e)=>{if(t){try{Object.defineProperty(t,"name",{value:e});}catch{}Object.defineProperty(t,"adapterName",{value:e});}});let Dv=t=>"- ".concat(t),AB=t=>Z.isFunction(t)||t===null||t===!1;var Pv={getAdapter:t=>{t=Z.isArray(t)?t:[t];let{length:e}=t,n,i,r={};for(let o=0;o<e;o++){let s;if(n=t[o],i=n,!AB(n)&&(i=z_[(s=String(n)).toLowerCase()],i===void 0))throw new pe("Unknown adapter '".concat(s,"'"));if(i)break;r[s||"#"+o]=i;}if(!i){let o=Object.entries(r).map(s=>{let[a,c]=s;return "adapter ".concat(a," ")+(c===!1?"is not supported by the environment":"is not available in the build")});throw new pe("There is no suitable adapter to dispatch the request "+(e?o.length>1?`since :
`+o.map(Dv).join(`
`):" "+Dv(o[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return i},adapters:z_};function J_(t){if(t.cancelToken&&t.cancelToken.throwIfRequested(),t.signal&&t.signal.aborted)throw new Uc(null,t)}function Lv(t){return J_(t),t.headers=Jr.from(t.headers),t.data=q_.call(t,t.transformRequest),["post","put","patch"].indexOf(t.method)!==-1&&t.headers.setContentType("application/x-www-form-urlencoded",!1),Pv.getAdapter(t.adapter||K_.adapter)(t).then(function(e){return J_(t),e.data=q_.call(t,t.transformResponse,e),e.headers=Jr.from(e.headers),e},function(e){return wv(e)||(J_(t),e&&e.response&&(e.response.data=q_.call(t,t.transformResponse,e.response),e.response.headers=Jr.from(e.response.headers))),K.reject(e)})}function kv(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}let Mv=t=>t instanceof Jr?function(e){for(var n=1;n<arguments.length;n++){var i=arguments[n]!=null?arguments[n]:{};n%2?kv(Object(i),!0).forEach(function(r){g(e,r,i[r]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):kv(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r));});}return e}({},t):t;function ha(t,e){e=e||{};let n={};function i(d,l,u){return Z.isPlainObject(d)&&Z.isPlainObject(l)?Z.merge.call({caseless:u},d,l):Z.isPlainObject(l)?Z.merge({},l):Z.isArray(l)?l.slice():l}function r(d,l,u){return Z.isUndefined(l)?Z.isUndefined(d)?void 0:i(void 0,d,u):i(d,l,u)}function o(d,l){if(!Z.isUndefined(l))return i(void 0,l)}function s(d,l){return Z.isUndefined(l)?Z.isUndefined(d)?void 0:i(void 0,d):i(void 0,l)}function a(d,l,u){return u in e?i(d,l):u in t?i(void 0,d):void 0}let c={url:o,method:o,data:o,baseURL:s,transformRequest:s,transformResponse:s,paramsSerializer:s,timeout:s,timeoutMessage:s,withCredentials:s,withXSRFToken:s,adapter:s,responseType:s,xsrfCookieName:s,xsrfHeaderName:s,onUploadProgress:s,onDownloadProgress:s,decompress:s,maxContentLength:s,maxBodyLength:s,beforeRedirect:s,transport:s,httpAgent:s,httpsAgent:s,cancelToken:s,socketPath:s,responseEncoding:s,validateStatus:a,headers:(d,l)=>r(Mv(d),Mv(l),!0)};return Z.forEach(Object.keys(Object.assign({},t,e)),function(d){let l=c[d]||r,u=l(t[d],e[d],d);Z.isUndefined(u)&&l!==a||(n[d]=u);}),n}let Uv="1.6.8",X_={};["object","boolean","number","function","string","symbol"].forEach((t,e)=>{X_[t]=function(n){return typeof n===t||"a"+(e<1?"n ":" ")+t};});let xv={};X_.transitional=function(t,e,n){function i(r,o){return "[Axios v"+Uv+"] Transitional option '"+r+"'"+o+(n?". "+n:"")}return (r,o,s)=>{if(t===!1)throw new pe(i(o," has been removed"+(e?" in "+e:"")),pe.ERR_DEPRECATED);return e&&!xv[o]&&(xv[o]=!0,console.warn(i(o," has been deprecated since v"+e+" and will be removed in the near future"))),!t||t(r,o,s)}};var Q_={assertOptions:function(t,e,n){if(typeof t!="object")throw new pe("options must be an object",pe.ERR_BAD_OPTION_VALUE);let i=Object.keys(t),r=i.length;for(;r-- >0;){let o=i[r],s=e[o];if(s){let a=t[o],c=a===void 0||s(a,o,t);if(c!==!0)throw new pe("option "+o+" must be "+c,pe.ERR_BAD_OPTION_VALUE)}else if(n!==!0)throw new pe("Unknown option "+o,pe.ERR_BAD_OPTION)}},validators:X_};let Co=Q_.validators,Bl=class{constructor(t){this.defaults=t,this.interceptors={request:new LR,response:new LR};}async request(t,e){try{return await this._request(t,e)}catch(n){if(n instanceof Error){let i;Error.captureStackTrace?Error.captureStackTrace(i={}):i=new Error;let r=i.stack?i.stack.replace(/^.+\n/,""):"";n.stack?r&&!String(n.stack).endsWith(r.replace(/^.+\n.+\n/,""))&&(n.stack+=`
`+r):n.stack=r;}throw n}}_request(t,e){typeof t=="string"?(e=e||{}).url=t:e=t||{},e=ha(this.defaults,e);let{transitional:n,paramsSerializer:i,headers:r}=e;n!==void 0&&Q_.assertOptions(n,{silentJSONParsing:Co.transitional(Co.boolean),forcedJSONParsing:Co.transitional(Co.boolean),clarifyTimeoutError:Co.transitional(Co.boolean)},!1),i!=null&&(Z.isFunction(i)?e.paramsSerializer={serialize:i}:Q_.assertOptions(i,{encode:Co.function,serialize:Co.function},!0)),e.method=(e.method||this.defaults.method||"get").toLowerCase();let o=r&&Z.merge(r.common,r[e.method]);r&&Z.forEach(["delete","get","head","post","put","patch","common"],p=>{delete r[p];}),e.headers=Jr.concat(o,r);let s=[],a=!0;this.interceptors.request.forEach(function(p){typeof p.runWhen=="function"&&p.runWhen(e)===!1||(a=a&&p.synchronous,s.unshift(p.fulfilled,p.rejected));});let c=[],d;this.interceptors.response.forEach(function(p){c.push(p.fulfilled,p.rejected);});let l,u=0;if(!a){let p=[Lv.bind(this),void 0];for(p.unshift.apply(p,s),p.push.apply(p,c),l=p.length,d=K.resolve(e);u<l;)d=d.then(p[u++],p[u++]);return d}l=s.length;let h=e;for(u=0;u<l;){let p=s[u++],T=s[u++];try{h=p(h);}catch(m){T.call(this,m);break}}try{d=Lv.call(this,h);}catch(p){return K.reject(p)}for(u=0,l=c.length;u<l;)d=d.then(c[u++],c[u++]);return d}getUri(t){return PR(Ov((t=ha(this.defaults,t)).baseURL,t.url),t.params,t.paramsSerializer)}};Z.forEach(["delete","get","head","options"],function(t){Bl.prototype[t]=function(e,n){return this.request(ha(n||{},{method:t,url:e,data:(n||{}).data}))};}),Z.forEach(["post","put","patch"],function(t){function e(n){return function(i,r,o){return this.request(ha(o||{},{method:t,headers:n?{"Content-Type":"multipart/form-data"}:{},url:i,data:r}))}}Bl.prototype[t]=e(),Bl.prototype[t+"Form"]=e(!0);});var jl=Bl;class Z_{constructor(e){if(typeof e!="function")throw new TypeError("executor must be a function.");let n;this.promise=new K(function(r){n=r;});let i=this;this.promise.then(r=>{if(!i._listeners)return;let o=i._listeners.length;for(;o-- >0;)i._listeners[o](r);i._listeners=null;}),this.promise.then=r=>{let o,s=new K(a=>{i.subscribe(a),o=a;}).then(r);return s.cancel=function(){i.unsubscribe(o);},s},e(function(r,o,s){i.reason||(i.reason=new Uc(r,o,s),n(i.reason));});}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e];}unsubscribe(e){if(!this._listeners)return;let n=this._listeners.indexOf(e);n!==-1&&this._listeners.splice(n,1);}static source(){let e;return {token:new Z_(function(n){e=n;}),cancel:e}}}var bB=Z_;let $_={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries($_).forEach(t=>{let[e,n]=t;$_[n]=e;});var wB=$_;let Sn=function t(e){let n=new jl(e),i=ER(jl.prototype.request,n);return Z.extend(i,jl.prototype,n,{allOwnKeys:!0}),Z.extend(i,n,null,{allOwnKeys:!0}),i.create=function(r){return t(ha(e,r))},i}(K_);Sn.Axios=jl,Sn.CanceledError=Uc,Sn.CancelToken=bB,Sn.isCancel=wv,Sn.VERSION=Uv,Sn.toFormData=Il,Sn.AxiosError=pe,Sn.Cancel=Sn.CanceledError,Sn.all=function(t){return K.all(t)},Sn.spread=function(t){return function(e){return t.apply(null,e)}},Sn.isAxiosError=function(t){return Z.isObject(t)&&t.isAxiosError===!0},Sn.mergeConfig=ha,Sn.AxiosHeaders=Jr,Sn.formToJSON=t=>Av(Z.isHTMLForm(t)?new FormData(t):t),Sn.getAdapter=Pv.getAdapter,Sn.HttpStatusCode=wB,Sn.default=Sn;var Mn=Sn;let OB=()=>{};function xc(){let t={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:OB};return t.promise=new K((e,n)=>{t.resolve=i=>{t.isFinished||(t.isResolved=!0,t.isFinished=!0,e(i),t.value=i);},t.reject=i=>{t.isFinished||(t.isRejected=!0,t.isFinished=!0,n(i));};}),t}let Gl=new Map,Wl=new Map,wr=new Map,He=function(t){return t.WIN_10="Windows 10",t.WIN_81="Windows 8.1",t.WIN_8="Windows 8",t.WIN_7="Windows 7",t.WIN_VISTA="Windows Vista",t.WIN_SERVER_2003="Windows Server 2003",t.WIN_XP="Windows XP",t.WIN_2000="Windows 2000",t.ANDROID="Android",t.HARMONY_OS="HarmonyOS",t.OPEN_BSD="Open BSD",t.SUN_OS="Sun OS",t.LINUX="Linux",t.IOS="iOS",t.MAC_OS="Mac OS",t.CHROMIUM_OS="Chromium OS",t.QNX="QNX",t.UNIX="UNIX",t.BEOS="BeOS",t.OS_2="OS/2",t.SEARCH_BOT="Search Bot",t}({}),Bt=function(t){return t.CHROME="Chrome",t.SAFARI="Safari",t.EDGE="Edge",t.FIREFOX="Firefox",t.OPERA="OPR",t.QQ="QQBrowser",t.WECHAT="MicroMessenger",t}({}),tm=new X2,sr=tm.getResult(),em=null;function Pt(t){if(!em){sr=tm.getResult();let e=function(a){if(a.engine.name==="Blink"&&a.browser.name!=="WeChat")return Bt.CHROME;switch(a.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return Bt.CHROME;case"Safari":case"Mobile Safari":return Bt.SAFARI;case"Edge":return Bt.EDGE;case"Firefox":return Bt.FIREFOX;case"QQ":case"QQBrowser":return Bt.QQ;case"Opera":return Bt.OPERA;case"WeChat":return Bt.WECHAT;default:return a.browser.name||""}}(sr),n=Vv(sr),i=function(a){return a.os.name==="Windows"?a.os.version?a.os.name+" "+a.os.version:a.os.name:a.os.name||""}(sr),r=sr.os.version,o=Vv(sr,!1),s=sr.device.type;if(!(e&&n&&i&&r))return {name:e,version:n,os:i,osVersion:r,browserVersion:o,deviceType:s};em={name:e,version:n,os:i,osVersion:r,browserVersion:o,deviceType:s};}return em}function Vv(t){let e,n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return e=t.engine.name==="Blink"?t.engine.version||"":t.browser.version||"",n?e.split(".")[0]:e}function Hl(){return Pt().os}function Fv(){let t=Pt();return "".concat(t.os," ").concat(t.osVersion)}function Kl(){let t=Pt();return !!(sr.engine.name==="WebKit"&&t.os===He.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&t.name!==Bt.SAFARI||mn()&&t.name!==Bt.SAFARI)}function vo(){return Pt().name===Bt.CHROME}function Ke(){return Pt().name===Bt.SAFARI}function Bv(){return Pt().name===Bt.EDGE}function Xt(){return Pt().name===Bt.FIREFOX}function mn(){return Pt().os===He.IOS}function nm(t){let e=Pt();return !(e.name!==Bt.CHROME||!e.osVersion)&&Number(e.version)>=t}function jv(t){let e=Pt();return !(e.name!==Bt.EDGE||!e.osVersion)&&Number(e.version)>=t}function Gv(t){let e=Pt();return !(e.name!==Bt.SAFARI||!e.osVersion)&&Number(e.version)>=t}function Wv(t,e,n){let i=Pt();if(i.os!==He.IOS||!i.osVersion)return !1;let r=i.osVersion.split(".");return e&&Number(r[0])===t&&Number(r[1])<e||Number(r[0])<t}function Hv(t,e,n){let i=Pt();if(i.name!==Bt.SAFARI||!i.osVersion||!i.browserVersion)return !1;let r=i.browserVersion.split(".");return e&&Number(r[0])===t&&Number(r[1])<e||Number(r[0])<t}function Kv(t){let e=Pt();return !(e.name!==Bt.OPERA||!e.osVersion)&&Number(e.version)>=t}function Yv(){let t=Pt();return !(t.name!==Bt.CHROME||!t.osVersion)&&Number(t.version)<=90}function qv(){let t=Pt();if(t.os!==He.IOS||!t.osVersion)return !1;let e=t.osVersion.split(".");return Number(e[0])<14||Number(e[0])===14&&Number(e[1])<=6}function pa(){let t=Pt();if(t.os!==He.IOS||!t.osVersion)return !1;let e=t.osVersion.split(".");return Number(e[0])===15}function im(){let t=Pt();if(t.os!==He.IOS||!t.osVersion)return !1;let e=t.osVersion.split(".");return Number(e[0])===16}function zv(){let t=Pt();if(t.os!==He.IOS||!t.osVersion)return !1;let e=t.osVersion.split(".");return Number(e[0])===15&&Number(e[1])>=1}function Vi(){return Ke()&&navigator.maxTouchPoints>0}function Jv(){return Pt().name===Bt.WECHAT}function Xv(){return window.navigator.appVersion&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)!==null&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function rm(){let t=Hl();return function(){let{deviceType:e}=Pt();return e==="mobile"||e==="tablet"}()||t===He.ANDROID||t===He.IOS||t===He.HARMONY_OS}function Io(){let t=Pt();return t.name!==Bt.EDGE&&t.name!==Bt.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function Yl(){return Hl()===He.ANDROID}function Vc(){let t=Pt();return Yl()&&(t.name===Bt.CHROME||t.name===Bt.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}function Qv(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function nt(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Qv(Object(n),!0).forEach(function(i){ae(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Qv(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}function ae(t,e,n){return (e=function(i){var r=function(o,s){if(typeof o!="object"||o===null)return o;var a=o[Symbol.toPrimitive];if(a!==void 0){var c=a.call(o,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(i);return typeof r=="symbol"?r:String(r)}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}let R=function(t){return t.UNEXPECTED_ERROR="UNEXPECTED_ERROR",t.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",t.TIMEOUT="TIMEOUT",t.INVALID_PARAMS="INVALID_PARAMS",t.NOT_READABLE="NOT_READABLE",t.NOT_SUPPORTED="NOT_SUPPORTED",t.INVALID_OPERATION="INVALID_OPERATION",t.OPERATION_ABORTED="OPERATION_ABORTED",t.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",t.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",t.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",t.DATACHANNEL_FAILED="DATACHANNEL_FAILED",t.NETWORK_ERROR="NETWORK_ERROR",t.NETWORK_TIMEOUT="NETWORK_TIMEOUT",t.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",t.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",t.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",t.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",t.ELECTRON_IS_NULL="ELECTRON_IS_NULL",t.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",t.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",t.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",t.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",t.PERMISSION_DENIED="PERMISSION_DENIED",t.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",t.TRACK_IS_DISABLED="TRACK_IS_DISABLED",t.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",t.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",t.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",t.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",t.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",t.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",t.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",t.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",t.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",t.UID_CONFLICT="UID_CONFLICT",t.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",t.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",t.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",t.INVALID_TRACK="INVALID_TRACK",t.SENDER_NOT_FOUND="SENDER_NOT_FOUND",t.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",t.SET_ANSWER_FAILED="SET_ANSWER_FAILED",t.ICE_FAILED="ICE_FAILED",t.PC_CLOSED="PC_CLOSED",t.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",t.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",t.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",t.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",t.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",t.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",t.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",t.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",t.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",t.INVALID_REMOTE_USER="INVALID_REMOTE_USER",t.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",t.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",t.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",t.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",t.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",t.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",t.WS_ABORT="WS_ABORT",t.WS_DISCONNECT="WS_DISCONNECT",t.WS_ERR="WS_ERR",t.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",t.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",t.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",t.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",t.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",t.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",t.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",t.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",t.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",t.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",t.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",t.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",t.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",t.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",t.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",t.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",t.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",t.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",t.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",t.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",t.INVALID_PLUGIN="INVALID_PLUGIN",t.DISCONNECT_P2P="DISCONNECT_P2P",t.INIT_WEBSOCKET_TIMEOUT="INIT_WEBSOCKET_TIMEOUT",t.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",t.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",t.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",t.CREATE_DATACHANNEL_ERROR="CREATE_DATACHANNEL_ERROR",t.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",t.PROHIBITED_OPERATION="PROHIBITED_OPERATION",t.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",t.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED",t}({});class D extends Error{constructor(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",i=arguments.length>2?arguments[2]:void 0;super(n),ae(this,"code",void 0),ae(this,"message",void 0),ae(this,"data",void 0),ae(this,"name","AgoraRTCException"),this.code=e,this.message="AgoraRTCError ".concat(this.code,": ").concat(n),this.data=i;}toString(){return this.data?"data: ".concat(JSON.stringify(this.data),`
`).concat(this.stack):"".concat(this.stack)}print(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error",n=arguments.length>1?arguments[1]:void 0;return e==="error"&&(n||console).error(this.toString()),e==="warning"&&(n||console).warn(this.toString()),this}throw(e){throw this.print("error",e),this}}function Xr(t,e){if(typeof t!="boolean")throw new D(R.INVALID_PARAMS,"Invalid ".concat(e,": The value is of the boolean type."))}function Ge(t,e,n){if(!q(n).call(n,t))throw new D(R.INVALID_PARAMS,"".concat(e," can only be set as ").concat(JSON.stringify(n)))}function zt(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1e4;if(t<n||t>i||(!(arguments.length>4&&arguments[4]!==void 0)||arguments[4])&&!function(r){return typeof r=="number"&&r%1==0}(t))throw new D(R.INVALID_PARAMS,"invalid ".concat(e,": the value range is [").concat(n,", ").concat(i,"]. integer only"))}function om(t,e){if(typeof t!="number"){if(!(t.min||t.max||t.ideal||t.exact))throw new D(R.INVALID_PARAMS,"".concat(e," is not a valid ConstrainLong"));t.min!==void 0&&zt(t.min,"".concat(e,".min"),0,1/0),t.max!==void 0&&zt(t.max,"".concat(e,".max"),1,1/0),t.exact!==void 0&&zt(t.exact,"".concat(e,".exact"),1,1/0),t.ideal!==void 0&&zt(t.ideal,"".concat(e,".ideal"),1,1/0);}else zt(t,e,1,1/0);}function rn(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:255,r=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(t==null)throw new D(R.INVALID_PARAMS,"".concat(e||"param"," cannot be empty"));if(!Zv(t,n,i,r))throw new D(R.INVALID_PARAMS,"Invalid ".concat(e||"string param",": Length of the string: [").concat(n,",").concat(i,"].").concat(r?" ASCII characters only.":""))}function Qr(t,e){if(!Array.isArray(t))throw new D(R.INVALID_PARAMS,"".concat(e," should be an array"))}function fe(t){return t==null}function Zv(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,i=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];return typeof t=="string"&&t.length<=n&&t.length>=e&&(!i||function(r){if(typeof r!="string")return !1;for(let o=0;o<r.length;o+=1){let s=r.charCodeAt(o);if(s<0||s>255)return !1}return !0}(t))}function $v(t,e,n){if("getBigUint64"in DataView.prototype)return t.getBigUint64(e,n);let i=t.getUint32(e,n),r=t.getUint32(e+4,n),o=+!!n,s=+!n;return BigInt(i*s+r*o)<<BigInt(32)|BigInt(i*o+r*s)}function tI(t,e,n,i){if("setBigUint64"in DataView.prototype)return t.setBigUint64(e,n,i);let r=Number(n>>BigInt(32)),o=Number(n&BigInt(4294967295));(t.setUint32(e,r,i),t.setUint32(e+4,o,i));}var Fc=function(t){return t.COVERED="COVERED",t.POSITION="POSITION",t.SIZE="SIZE",t.STYLE="STYLE",t}(Fc||{}),sm=function(t){return t.UNMOUNTED="UNMOUNTED",t.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT",t}(sm||{});let eI=new class{constructor(){ae(this,"_clientSize",null),ae(this,"getClientWidth",()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth),ae(this,"getClientHeight",()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight),ae(this,"getStyle",t=>window.getComputedStyle(t,null)),ae(this,"checkCssVisibleProperty",t=>{var e;let n=!0,i=this.getStyle(t),{display:r,visibility:o,opacity:s,filter:a}=i;return (r==="none"||q(e=["hidden","collapse"]).call(e,o)||Number(s)<.1)&&(n=!1),!!n&&(a&&a.split(" ").filter(c=>{var d;let l=c.split("(")[0];return q(d=["brightness","blur","opacity"]).call(d,l)}).map(c=>{let[d,l]=c.split(/\(|\)/);return [d,Number(l.match(/^[0-9\.]+/))]}).forEach(c=>{let[d,l]=c;switch(d){case"brightness":(l<.1||l>3)&&(n=!1);break;case"blur":l>3&&(n=!1);break;case"opacity":l<.1&&(n=!1);}}),n)}),ae(this,"checkPropertyUpToAllParentNodes",(t,e)=>{let n=!0,i=!0,r=s=>e(s),o=t;for(;o&&i;)r(o)||(n=!1,i=!1),o=o.parentElement,o||(i=!1);return n}),ae(this,"checkActualCssVisibleIncludeInherit",t=>this.checkPropertyUpToAllParentNodes(t,this.checkCssVisibleProperty)),ae(this,"getSizeAboutClient",t=>{let{width:e,height:n,left:i,right:r,top:o,bottom:s}=t.getBoundingClientRect(),a=this.getClientWidth(),c=this.getClientHeight();return {width:e,height:n,left:i,right:r,top:o,bottom:s,clientWidth:a,clientHeight:c,clientMin:Math.min(a,c)}}),ae(this,"checkActualSize",()=>{let{width:t,height:e,clientMin:n}=this._clientSize;return this.checkSizeIsVisible(t,e,n)}),ae(this,"elementFromPoint",(t,e)=>document.elementFromPoint?document.elementFromPoint(t,e):null),ae(this,"checkCoverForAPoint",(t,e,n)=>{let i=this.elementFromPoint(t,e);return i!==null&&i!==n}),ae(this,"getPointPositionList",()=>{let{width:t,height:e,left:n,top:i}=this._clientSize,r=t/6,o=e/6,s=[],a=10**6;for(let c=0;c<5;c++)for(let d=0;d<5;d++){let l=(n*a+(c===0?.1:c===4?(r*c*a-1e5)/a:r*c)*a)/a,u=(i*a+(d===0?.1:d===4?(o*d*a-1e5)/a:o*d)*a)/a;s.push({x:l,y:u});}return [...s]}),ae(this,"checkElementCover",t=>this.getPointPositionList().map(e=>this.checkCoverForAPoint(e.x,e.y,t)).filter(e=>!!e).length>6),ae(this,"checkSizeIsVisible",(t,e,n)=>(t>50||n/t<=10)&&(e>50||n/e<=10)),ae(this,"checkSizeOfPartInClient",()=>{let{left:t,right:e,top:n,bottom:i,clientHeight:r,clientWidth:o,clientMin:s}=this._clientSize,a,c,d,l;if(t<0)a=0;else {if(!(t<o))return !1;a=t;}if(e<0)return !1;if(c=e<o?e:o,n<0)d=0;else {if(!(n<r))return !1;d=n;}if(i<0)return !1;l=i<r?i:r;let u=c-a,h=l-d;return this.checkSizeIsVisible(u,h,s)}),ae(this,"returnHiddenResult",t=>(this._clientSize=null,{visible:!1,reason:t})),ae(this,"checkOneElementVisible",t=>{if(t instanceof HTMLElement){if(this.checkElementIsMountedOnDom(t)){if(this.checkActualCssVisibleIncludeInherit(t)){if(this._clientSize=this.getSizeAboutClient(t),this.checkElementCover(t))return this.returnHiddenResult(Fc.COVERED);{let e=this.checkActualSize(),n=this.checkSizeOfPartInClient();return e&&!n?this.returnHiddenResult(Fc.POSITION):e?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(Fc.SIZE)}}return this.returnHiddenResult(Fc.STYLE)}return this.returnHiddenResult(sm.UNMOUNTED)}return this.returnHiddenResult(sm.INVALID_HTML_ELEMENT)}),ae(this,"checkElementIsMountedOnDom",t=>this.checkPropertyUpToAllParentNodes(t,e=>e.nodeName.toUpperCase()!=="HTML"?e.parentElement!==null:!!document.documentElement));}};function am(t){return new TextEncoder().encode(t)}let nI=function(t,e){let n=new Uint8Array(t.byteLength+e.byteLength);return n.set(new Uint8Array(t),0),n.set(new Uint8Array(e),t.byteLength),n},cm=async t=>function(e,n){let i="";return new Uint8Array(e).forEach(r=>{i+=r.toString(n).padStart(2,"0");}),i}(await crypto.subtle.digest("SHA-256",am(t)),16),de=class{constructor(){ae(this,"_events",{}),ae(this,"addListener",this.on);}getListeners(t){return this._events[t]?this._events[t].map(e=>e.listener):[]}on(t,e){this._events[t]||(this._events[t]=[]);let n=this._events[t];this._indexOfListener(n,e)===-1&&n.push({listener:e,once:!1});}once(t,e){this._events[t]||(this._events[t]=[]);let n=this._events[t];this._indexOfListener(n,e)===-1&&n.push({listener:e,once:!0});}off(t,e){if(!this._events[t])return;let n=this._events[t],i=this._indexOfListener(n,e);i!==-1&&n.splice(i,1),this._events[t].length===0&&delete this._events[t];}removeAllListeners(t){t?delete this._events[t]:this._events={};}emit(t){this._events[t]||(this._events[t]=[]);let e=this._events[t].map(o=>o);for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(let o=0;o<e.length;o+=1){let s=e[o];s.once&&this.off(t,s.listener),s.listener.apply(this,i||[]);}}safeEmit(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];[...this._events[t]||[]].forEach(r=>{r.once&&this.off(t,r.listener);try{r.listener.apply(this,n);}catch(o){console.error("safeEmit event:".concat(t," error ").concat(o?.toString()));}});}_indexOfListener(t,e){let n=t.length;for(;n--;)if(t[n].listener===e)return n;return -1}},Bc=null;function iI(){if(Bc)return Bc;if(window.electron)return Bc=window.electron;if(!window.require)return null;try{return Bc=window.require("electron"),Bc}catch{return null}}let ke=function(t){return t.CREATE_CLIENT="createClient",t.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",t.SET_AREA="setArea",t.PRELOAD="PRELOAD",t.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",t.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",t.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",t.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",t.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",t.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",t.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",t.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",t.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",t.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",t.START_PROXY_SERVER="Client.startProxyServer",t.STOP_PROXY_SERVER="Client.stopProxyServer",t.SET_PROXY_SERVER="Client.setProxyServer",t.SET_TURN_SERVER="Client.setTurnServer",t.SET_CLIENT_ROLE="Client.setClientRole",t.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",t.ENABLE_DUAL_STREAM="Client.enableDualStream",t.DISABLE_DUAL_STREAM="Client.disableDualStream",t.JOIN="Client.join",t.LEAVE="Client.leave",t.PUBLISH="Client.publish",t.UNPUBLISH="Client.unpublish",t.SUBSCRIBE="Client.subscribe",t.MASS_SUBSCRIBE="Client.massSubscribe",t.MASS_UNSUBSCRIBE="Client.massUnsubscribe",t.UNSUBSCRIBE="Client.unsubscribe",t.RENEW_TOKEN="Client.renewToken",t.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",t.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",t.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",t.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",t.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",t.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",t.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",t.DATACHANNEL_FAILBACK="Client._datachannelFailback",t.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",t.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",t.START_LIVE_STREAMING="Client.startLiveStreaming",t.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",t.STOP_LIVE_STREAMING="Client.stopLiveStreaming",t.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",t.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",t.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",t.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",t.SET_CONFIG_DISTRIBUTE="_configDistribute",t.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",t.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",t.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",t.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",t.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",t.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",t.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",t.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",t.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",t.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",t.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",t.LOCAL_VIDEO_SEND_SEI_DATA="LocalVideoTrack.sendSeiData",t.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",t.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",t.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",t.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",t.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",t.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",t.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",t.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",t.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",t.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",t.STREAM_TYPE_CHANGE="streamTypeChange",t.CONNECTION_STATE_CHANGE="connectionStateChange",t.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",t.IMAGE_MODERATION_UPLOAD="imageModerationUpload",t}({}),ge=function(t){return t.TRACER="tracer",t}({});function rI(t){return zt(t.timeout,"config.timeout",0,1e5),zt(t.timeoutFactor,"config.timeoutFactor",0,100,!1),zt(t.maxRetryCount,"config.maxRetryConfig",0,1/0),zt(t.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}let NB=function(t){return t[t.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",t[t.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",t[t.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY",t}({}),It=function(t){return t.LEAVE="LEAVE",t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.UID_BANNED="UID_BANNED",t.IP_BANNED="IP_BANNED",t.CHANNEL_BANNED="CHANNEL_BANNED",t.FALLBACK="FALLBACK",t.LICENSE_MISSING="LICENSE_MISSING",t.LICENSE_EXPIRED="LICENSE_EXPIRED",t.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",t.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",t.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",t.LICENSE_ILLEGAL="LICENSE_ILLEGAL",t.TOKEN_EXPIRE="TOKEN_EXPIRE",t}({});function _a(t){if(!Array.isArray(t)||t.length<1)return !1;try{t.forEach(e=>{if(!e.urls)throw Error()});}catch{return !1}return !0}function oI(t){return rn(t.turnServerURL,"turnServerURL"),rn(t.username,"username"),rn(t.password,"password"),t.udpport&&zt(t.udpport,"udpport",1,99999,!0),t.forceturn&&Xr(t.forceturn,"forceturn"),t.security&&Xr(t.security,"security"),t.tcpport&&zt(t.tcpport,"tcpport",1,99999,!0),!0}function sI(t){return t.level!==void 0&&Ge(t.level,"level",[1,2,3]),t.delay!==void 0&&zt(t.delay,"delay",0,3e3,!0),!0}let yt=function(t){return t.CONNECTION_STATE_CHANGE="connection-state-change",t.MEDIA_RECONNECT_START="media-reconnect-start",t.MEDIA_RECONNECT_END="media-reconnect-end",t.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",t.USER_JOINED="user-joined",t.USER_LEAVED="user-left",t.USER_PUBLISHED="user-published",t.USER_UNPUBLISHED="user-unpublished",t.USER_INFO_UPDATED="user-info-updated",t.CLIENT_BANNED="client-banned",t.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",t.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",t.VOLUME_INDICATOR="volume-indicator",t.CRYPT_ERROR="crypt-error",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGED="stream-type-changed",t.STREAM_FALLBACK="stream-fallback",t.RECEIVE_METADATA="receive-metadata",t.STREAM_MESSAGE="stream-message",t.LIVE_STREAMING_ERROR="live-streaming-error",t.LIVE_STREAMING_WARNING="live-streaming-warning",t.INJECT_STREAM_STATUS="stream-inject-status",t.EXCEPTION="exception",t.ERROR="error",t.P2P_LOST="p2p_lost",t.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",t.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",t.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",t.PUBLISHED_USER_LIST="published-user-list",t.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",t.CONTENT_INSPECT_ERROR="content-inspect-error",t.CONTENT_INSPECT_RESULT="content-inspect-result",t.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change",t}({}),dn=function(t){return t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.MULTI_IP="MULTI_IP",t.TIMEOUT="TIMEOUT",t.OFFLINE="OFFLINE",t.LEAVE="LEAVE",t.P2P_FAILED="P2P_FAILED",t.FALLBACK="FALLBACK",t}({}),On=function(t){return t.ONLINE="ONLINE",t.OFFLINE="OFFLINE",t}({}),us=function(t){return t.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",t.ONLINE="ONLINE",t.OFFLINE="OFFLINE",t}({});function Me(t,e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return t.getListeners(e).length===0?K.reject(new D(R.UNEXPECTED_ERROR,"can not emit promise")):new K((o,s)=>{t.emit(e,...i,o,s);})}function Qt(t,e){if(t.getListeners(e).length===0)return K.resolve();for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return Me(t,e,...i)}function Qn(t,e){if(t.getListeners(e).length===0)return null;for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return hs(t,e,...i)}function hs(t,e){let n=null,i=null;for(var r=arguments.length,o=new Array(r>2?r-2:0),s=2;s<r;s++)o[s-2]=arguments[s];if(t.emit(e,...o,a=>{n=a;},a=>{i=a;}),i!==null)throw i;if(n===null)throw new D(R.UNEXPECTED_ERROR,"handler is not sync");return n}let Te=new class extends de{set networkState(t){this.emit(us.NETWORK_STATE_CHANGE,t,this._networkState),t===On.ONLINE?this.emit(us.ONLINE):t===On.OFFLINE&&(this.onlineWaiter=new K(e=>{this.once(us.ONLINE,()=>{this.onlineWaiter=void 0,e(On.ONLINE);});}),this.emit(us.OFFLINE)),this._networkState=t;}get networkState(){return this._networkState}get isOnline(){return this._networkState===On.ONLINE}constructor(){super(),ae(this,"_moduleName","network-indicator"),ae(this,"_networkState",On.ONLINE),ae(this,"onlineWaiter",void 0),window.addEventListener("online",()=>{this.networkState=On.ONLINE;}),window.addEventListener("offline",()=>{this.networkState=On.OFFLINE;});}};function ql(t,e){let n=t.indexOf(e);n!==-1&&t.splice(n,1);}function ma(t){let e=[];return t.forEach(n=>{e.indexOf(n)===-1&&e.push(n);}),e}function zl(t){K!==void 0?K.resolve().then(t):setTimeout(t,0);}function ne(t){return JSON.parse(JSON.stringify(t))}function ps(t){try{return ne(t)}catch{return t}}let aI={};function yo(t,e){aI[e]||(aI[e]=!0,t());}function _s(t){let e=window.atob(t),n=new Uint8Array(new ArrayBuffer(e.length));for(let i=0;i<e.length;i+=1)n[i]=e.charCodeAt(i);return n}function Ao(t){let e="";for(let n=0;n<t.length;n+=1)e+=String.fromCharCode(t[n]);return window.btoa(e)}function cI(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,n=new TextEncoder().encode(t);if(n.length>e)n=n.slice(0,e);else if(n.length<e){let i=new Uint8Array(e);i.set(n),n=i;}return n}function dI(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];let i=rr(e).call(e,(s,a)=>s+a.length,0),r=new Uint8Array(new ArrayBuffer(i)),o=0;return e.forEach(s=>{r.set(s,o),o+=s.length;}),r}function Or(t){return window.TextEncoder?new TextEncoder().encode(t).length:t.length}function lI(t){let e=0;return (/DingTalk/i.test(navigator.userAgent)||/AliApp/i.test(navigator.userAgent))&&t.realFormData&&(t=t.realFormData),t.forEach(n=>{e+=typeof n=="string"?Or(n):n.size;}),e+138}function DB(t){let e=new D(R.TIMEOUT,"timeout");return new K((n,i)=>{window.setTimeout(()=>i(e),t);})}function Ye(t){return new K(e=>{window.setTimeout(e,t);})}function Zt(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:7,e=arguments.length>1?arguments[1]:void 0,n=Math.random().toString(16).substr(2,t).toLowerCase();return n.length===t?"".concat(e).concat(n):"".concat(e).concat(n)+Zt(t-n.length,"")}function jc(){return Zt(32,"").toUpperCase()}let Jl=()=>{},uI=new class{constructor(){ae(this,"fnMap",new Map);}throttleByKey(t,e,n,i){for(var r=arguments.length,o=new Array(r>4?r-4:0),s=4;s<r;s++)o[s-4]=arguments[s];if(this.fnMap.has(e)){let a=this.fnMap.get(e);if(a.threshold!==n){a.fn(...a.args),clearTimeout(a.timer);let c=window.setTimeout(()=>{let d=this.fnMap.get(e);d&&d.fn(...d.args),this.fnMap.delete(e);},n);this.fnMap.set(e,{fn:t,threshold:n,timer:c,args:o,skipFn:i});}else a.skipFn&&a.skipFn(...a.args),this.fnMap.set(e,nt(nt({},a),{},{fn:t,args:o,skipFn:i}));}else {let a=window.setTimeout(()=>{let c=this.fnMap.get(e);c&&c.fn(...c.args),this.fnMap.delete(e);},n);this.fnMap.set(e,{fn:t,threshold:n,timer:a,args:o,skipFn:i});}}},hI=uI.throttleByKey.bind(uI);function pI(t){return typeof t=="object"&&t!==null&&!(t instanceof RegExp)}function dm(t,e){if(!pI(t)||!pI(e)||Array.isArray(t)&&!Array.isArray(e)||!Array.isArray(t)&&Array.isArray(e))return e;if(Array.isArray(e)&&Array.isArray(t)){let n=[...t];for(let i=0;i<e.length;i++)n[i]=dm(t[i],e[i]);return n}{let n=nt({},t);for(let i in e)Object.prototype.hasOwnProperty.call(e,i)&&(Object.prototype.hasOwnProperty.call(t,i)?n[i]=dm(t[i],e[i]):n[i]=e[i]);return n}}function _I(t,e){let n=[0];if((n=new Array(e).fill(0)),t===0)return n;let i=0;for(;t>0&&(n[i]=255&t,t>>=8,i++,i!==e););return n}function lm(t){return typeof t=="number"?t:t.exact||t.ideal||t.max||t.min||0}function mI(t){let e="0123456789abcdef";function n(A){let b,O="";for(b=0;b<=3;b++)O+=e.charAt(A>>8*b+4&15)+e.charAt(A>>8*b&15);return O}function i(A,b){let O=(65535&A)+(65535&b);return (A>>16)+(b>>16)+(O>>16)<<16|65535&O}function r(A,b,O,N,k,M){return i(function(x,X){return x<<X|x>>>32-X}(i(i(b,A),i(N,M)),k),O)}function o(A,b,O,N,k,M,x){return r(b&O|~b&N,A,b,k,M,x)}function s(A,b,O,N,k,M,x){return r(b&N|O&~N,A,b,k,M,x)}function a(A,b,O,N,k,M,x){return r(b^O^N,A,b,k,M,x)}function c(A,b,O,N,k,M,x){return r(O^(b|~N),A,b,k,M,x)}let d=function(A){let b,O=1+(A.length+8>>6),N=new Array(16*O);for(b=0;b<16*O;b++)N[b]=0;for(b=0;b<A.length;b++)N[b>>2]|=A.charCodeAt(b)<<b%4*8;return N[b>>2]|=128<<b%4*8,N[16*O-2]=8*A.length,N}(t),l,u,h,p,T,m=1732584193,E=-271733879,S=-1732584194,C=271733878;for(l=0;l<d.length;l+=16)u=m,h=E,p=S,T=C,m=o(m,E,S,C,d[l+0],7,-680876936),C=o(C,m,E,S,d[l+1],12,-389564586),S=o(S,C,m,E,d[l+2],17,606105819),E=o(E,S,C,m,d[l+3],22,-1044525330),m=o(m,E,S,C,d[l+4],7,-176418897),C=o(C,m,E,S,d[l+5],12,1200080426),S=o(S,C,m,E,d[l+6],17,-1473231341),E=o(E,S,C,m,d[l+7],22,-45705983),m=o(m,E,S,C,d[l+8],7,1770035416),C=o(C,m,E,S,d[l+9],12,-1958414417),S=o(S,C,m,E,d[l+10],17,-42063),E=o(E,S,C,m,d[l+11],22,-1990404162),m=o(m,E,S,C,d[l+12],7,1804603682),C=o(C,m,E,S,d[l+13],12,-40341101),S=o(S,C,m,E,d[l+14],17,-1502002290),E=o(E,S,C,m,d[l+15],22,1236535329),m=s(m,E,S,C,d[l+1],5,-165796510),C=s(C,m,E,S,d[l+6],9,-1069501632),S=s(S,C,m,E,d[l+11],14,643717713),E=s(E,S,C,m,d[l+0],20,-373897302),m=s(m,E,S,C,d[l+5],5,-701558691),C=s(C,m,E,S,d[l+10],9,38016083),S=s(S,C,m,E,d[l+15],14,-660478335),E=s(E,S,C,m,d[l+4],20,-405537848),m=s(m,E,S,C,d[l+9],5,568446438),C=s(C,m,E,S,d[l+14],9,-1019803690),S=s(S,C,m,E,d[l+3],14,-187363961),E=s(E,S,C,m,d[l+8],20,1163531501),m=s(m,E,S,C,d[l+13],5,-1444681467),C=s(C,m,E,S,d[l+2],9,-51403784),S=s(S,C,m,E,d[l+7],14,1735328473),E=s(E,S,C,m,d[l+12],20,-1926607734),m=a(m,E,S,C,d[l+5],4,-378558),C=a(C,m,E,S,d[l+8],11,-2022574463),S=a(S,C,m,E,d[l+11],16,1839030562),E=a(E,S,C,m,d[l+14],23,-35309556),m=a(m,E,S,C,d[l+1],4,-1530992060),C=a(C,m,E,S,d[l+4],11,1272893353),S=a(S,C,m,E,d[l+7],16,-155497632),E=a(E,S,C,m,d[l+10],23,-1094730640),m=a(m,E,S,C,d[l+13],4,681279174),C=a(C,m,E,S,d[l+0],11,-358537222),S=a(S,C,m,E,d[l+3],16,-722521979),E=a(E,S,C,m,d[l+6],23,76029189),m=a(m,E,S,C,d[l+9],4,-640364487),C=a(C,m,E,S,d[l+12],11,-421815835),S=a(S,C,m,E,d[l+15],16,530742520),E=a(E,S,C,m,d[l+2],23,-995338651),m=c(m,E,S,C,d[l+0],6,-198630844),C=c(C,m,E,S,d[l+7],10,1126891415),S=c(S,C,m,E,d[l+14],15,-1416354905),E=c(E,S,C,m,d[l+5],21,-57434055),m=c(m,E,S,C,d[l+12],6,1700485571),C=c(C,m,E,S,d[l+3],10,-1894986606),S=c(S,C,m,E,d[l+10],15,-1051523),E=c(E,S,C,m,d[l+1],21,-2054922799),m=c(m,E,S,C,d[l+8],6,1873313359),C=c(C,m,E,S,d[l+15],10,-30611744),S=c(S,C,m,E,d[l+6],15,-1560198380),E=c(E,S,C,m,d[l+13],21,1309151649),m=c(m,E,S,C,d[l+4],6,-145523070),C=c(C,m,E,S,d[l+11],10,-1120210379),S=c(S,C,m,E,d[l+2],15,718787259),E=c(E,S,C,m,d[l+9],21,-343485551),m=i(m,u),E=i(E,h),S=i(S,p),C=i(C,T);return n(m)+n(E)+n(S)+n(C)}let PB=1,Xl=console,Qe=class{static setLogger(t){Xl=t;}constructor(t){ae(this,"lockingPromise",K.resolve()),ae(this,"locks",0),ae(this,"name",""),ae(this,"lockId",void 0),this.lockId=PB++,t&&(this.name=t),Xl.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is created."));}get isLocked(){return this.locks>0}lock(t){let e;this.locks+=1,Xl.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is locked, current queue ").concat(this.locks,". ").concat(typeof t=="string"?t:""));let n=new K(r=>{e=()=>{this.locks-=1,Xl.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is not locked, current queue ").concat(this.locks,". ").concat(typeof t=="string"?t:"")),r();};}),i=this.lockingPromise.then(()=>e);return this.lockingPromise=this.lockingPromise.then(()=>n),i}};function Ea(t,e){return function(n,i,r){let o=r.value;if(typeof o!="function")throw new Error("Cannot use mutex on object property.");return r.value=async function(){let s=this[e];if(!s)throw new Error("mutex property key ".concat(e," doesn't exist on ").concat(t));let a=await s.lock("From ".concat(t,".").concat(i));try{for(var c=arguments.length,d=new Array(c),l=0;l<c;l++)d[l]=arguments[l];return await o.apply(this,d)}finally{a();}},r}}let Ne={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function Ql(t,e){let n=Math.floor(e.timeout*Math.pow(e.timeoutFactor,t));return Math.min(e.maxRetryTimeout,n)}function ar(t,e,n,i){let r=Object.assign({},Ne,i),o=r.timeout,s=async()=>{await function(d){return new K(l=>{window.setTimeout(l,d);})}(o),o*=r.timeoutFactor,o=Math.min(r.maxRetryTimeout,o);},a=!1,c=new K(async(d,l)=>{e=e||(()=>!1),n=n||(()=>!0);for(let u=0;u<r.maxRetryCount;u+=1){if(a)return l(new D(R.OPERATION_ABORTED));try{let h=await t();if(!e(h,u)||u+1===r.maxRetryCount)return d(h);await s();}catch(h){if(!n(h,u)||u+1===r.maxRetryCount)return l(h);await s();}}});return c.cancel=()=>a=!0,c}class um{constructor(e){ae(this,"input",[]),ae(this,"size",void 0),this.size=e;}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1);}mean(){var e;return this.input.length===0?0:rr(e=this.input).call(e,(n,i)=>n+i)/this.input.length}}let Zl,$l=0,hm=0;function pm(t,e,n,i){return new K((r,o)=>{e.responseType=e.responseType||"json",e.data&&!n?(e.data=JSON.stringify(e.data),$l+=Or(e.data)):n&&(e.data.size?$l+=e.data.size:e.data instanceof FormData?$l+=lI(e.data):$l+=Or(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=t,Mn.request(e).then(s=>{typeof s.data=="string"?hm+=Or(s.data):s.data instanceof ArrayBuffer||s.data instanceof Uint8Array?hm+=s.data.byteLength:hm+=Or(JSON.stringify(s.data)),r(s.data);}).catch(s=>{Mn.isCancel(s)?o(new D(R.OPERATION_ABORTED,"cancel token canceled")):s.code==="ECONNABORTED"?o(new D(R.NETWORK_TIMEOUT,s.message)):s.response?o(new D(R.NETWORK_RESPONSE_ERROR,s.response.status)):o(new D(R.NETWORK_ERROR,s.message));});})}async function LB(t,e){let n=new Blob([e.data],{type:"buffer"});return await pm(t,nt(nt({},e),{},{data:n,headers:{"Content-Type":"application/octet-stream"}}),!0)}let EI=()=>window.isSecureContext!==void 0,vi=function(t){if(t.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return t;let e=t.match(/([0-9]+\.[0-9]+\.[0-9]+)\-alpha\.([0-9]+)/);if(e&&e[1]&&e[2]){let i=e[1],r=e[2];return "".concat(i,".").concat(r)}let n=t.match(/([0-9]+\.[0-9]+\.[0-9]+)\-special\.([0-9]+)/);if(n&&n[1]&&n[2]){let i=n[1],r=n[2];return "".concat(i,".").concat(100*(Number(r)+1))}return "4.0.0.999"}("4.21.0"),_m=function(){try{return JSON.parse("true")===!0}catch{return !0}}(),ms=function(t){return t.Default="default",t.Auto="auto",t.Relay="relay",t.SdRtn="sd-rtn",t}({}),mm={MIN_FRAME_RATE:1,MAX_FRAME_RATE:30,MAX_THRESHOLD_FRAMERATE:30,BITRATE_MIN_THRESHOLD:100,BITRATE_MAX_THRESHOLD:100,MAX_SCALE:5,BWE_SCALE_UP_THRESHOLD:.6,BWE_SCALE_DOWN_THRESHOLD:.6,PERF_SCALE_UP_THRESHOLD:.7,PERF_SCALE_DOWN_THRESHOLD:.6,MOTION_RESOLUTION_FACTOR:.8,MOTION_BITRATE_FACTOR:.6,DETAIL_FRAMERATE_FACTOR:.8,DETAIL_BITRATE_FACTOR:.6,BALANCE_RESOLUTION_FACTOR:.9,BALANCE_FRAMERATE_FACTOR:.9,BALANCE_BITRATE_FACTOR:.6,OVERUSE_TIMES_THRESHOLD:10,UNDERUSE_TIMES_THRESHOLD:40},Em="v4.21.0-0-g16fdae2c-dirty(6/3/2024, 2:55:18 PM)",Fe={PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",ENABLE_EVENT_REPORT:!0,GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,UPLOAD_LOG:!1,NOT_REPORT_EVENT:[],SUBSCRIBE_TWCC:!0,PUBLISH_TWCC:!1,PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",TURN_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,PRELOAD_MEDIA_COUNT:0,USE_PUB_RTX:!0,USE_SUB_RTX:!0,USE_XR:!0,ENABLE_LOSSBASED_BWE:!0,ENABLE_AUT_CC:void 0,ENABLE_CC_FALLBACK:void 0,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:250,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!1,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{excludedLinks:[]},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,DISABLE_FEC:void 0,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,NEW_ICE_RESTART:!1,ENABLE_USER_LICENSE_CHECK:!0,SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,FINGERPRINT:null,DC_JOIN_WITH_FAILBACK:5e3,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,AP_AREA:!0,SVC:[],ENABLE_ENCODED_TRANSFORM:!1,ENABLE_VIDEO_SEI:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,ENABLE_DATASTREAM_2:!1,DATASTREAM_MAX_RETRANSMITS:10,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_INSTANT_VIDEO:!1,ENABLE_NTP_REPORT:!1,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,USE_PURE_ENCRYPTION_MASTER_KEY:!1,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],USE_NEW_NETWORK_CONFIG:!1,AUTO_RESET_AUDIO_ROUTE:!1,PLUGIN_INFO:[],OVERUSE_DETECTOR_PARAMS:mm,ENABLE_AG_ADAPTATION:!0,FORCE_AG_HIGH_FRAMERATE:!1,FORCE_SUPPORT_AG_ADAPTATION:!1,CUSTOM_ADAPTATION_DEFAULT_MODE:"",ENCODER_CONFIG_LIMIT:{},CAMERA_CAPTURE_CONFIG:void 0,HIDE_NO_POSTER:!1,AP_CACHE_NUM:10,AP_UPDATE_INTERVAL:12e4,AP_CACHE_LIFETIME:12e4,MAX_PRELOAD_ASYNC_LENGTH:3,ENABLE_PRELOAD:!0};function Jt(t,e,n){var i,r,o;q(i=Object.keys(Fe)).call(i,t)&&(!n&&q(r=Object.keys(bo)).call(r,t)||(Fe[t]=e,t==="ENABLE_VIDEO_SEI"&&e===!0&&(Fe.ENABLE_ENCODED_TRANSFORM=!0),t==="USE_NEW_NETWORK_CONFIG"&&e&&(o=!!e,Fe.USE_NEW_NETWORK_CONFIG=o,o&&(Fe.WEBCS_DOMAIN=["webrtc2-2.ap.sd-rtn.com"],Fe.WEBCS_DOMAIN_BACKUP_LIST=["webrtc2-4.ap.sd-rtn.com"],Fe.CDS_AP=["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],Fe.ACCOUNT_REGISTER=["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],Fe.EVENT_REPORT_DOMAIN="web-2.statscollector.sd-rtn.com",Fe.EVENT_REPORT_BACKUP_DOMAIN="statscollector-1.agora.io",Fe.GATEWAY_DOMAINS=["edge.sd-rtn.com"]))));}function v(t){return Fe[t]}let bo={};var Ct=function(t){return t.SET_SESSION_ID="SET_SESSION_ID",t.SET_P2P_ID="SET_P2P_id",t.SET_DC_ID="SET_DC_id",t.SET_UID="SET_UID",t.SET_INT_UID="SET_INT_UID",t.SET_PUB_ID="SET_PUB_ID",t.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",t.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",t.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",t.AVOID_JOIN_START="AVOID_JOIN_START",t.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",t.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",t.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",t.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",t.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",t.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",t.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",t.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",t.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",t.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",t.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",t.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",t.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",t.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",t.RESET_KEY_METRICS="RESET_KEY_METRICS",t.SET_USE_DATACHANNEL="SET_USE_DATACHANNEL",t.SET_USE_P2P="SET_USE_P2P",t.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE",t}(Ct||{});class kB{constructor(e,n,i,r){ae(this,"state",void 0),this.state={codec:e,audioCodec:n,mode:i,clientId:r,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,avoidJoinStart:0,keyMetrics:{publish:[],subscribe:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useDataChannel:!1,useP2P:!1,p2pTransport:ms.Default};}dispatch(e){this.state=function(n,i){switch(i.type){case Ct.SET_SESSION_ID:return nt(nt({},n),{},{sessionId:i.sessionId});case Ct.SET_P2P_ID:return nt(nt({},n),{},{p2pId:i.p2pId});case Ct.SET_UID:return nt(nt({},n),{},{uid:i.uid});case Ct.SET_INT_UID:return nt(nt({},n),{},{intUid:i.intUid});case Ct.SET_PUB_ID:return nt(nt({},n),{},{pubId:i.pubId});case Ct.KEY_METRIC_CLIENT_CREATED:return nt(nt({},n),{},{keyMetrics:nt(nt({},n.keyMetrics),{},{clientCreated:i.metric})});case Ct.KEY_METRIC_JOIN_START:return nt(nt({},n),{},{keyMetrics:nt(nt({},n.keyMetrics),{},{joinStart:i.metric})});case Ct.AVOID_JOIN_START:return nt(nt({},n),{},{avoidJoinStart:i.avoidJoinStart});case Ct.KEY_METRIC_JOIN_END:return nt(nt({},n),{},{keyMetrics:nt(nt({},n.keyMetrics),{},{joinEnd:i.metric})});case Ct.KEY_METRIC_REQUEST_AP_START:return nt(nt({},n),{},{keyMetrics:nt(nt({},n.keyMetrics),{},{requestAPStart:i.metric})});case Ct.KEY_METRIC_REQUEST_AP_END:return nt(nt({},n),{},{keyMetrics:nt(nt({},n.keyMetrics),{},{requestAPEnd:i.metric})});case Ct.KEY_METRIC_JOIN_GATEWAY_START:return nt(nt({},n),{},{keyMetrics:nt(nt({},n.keyMetrics),{},{joinGatewayStart:i.metric})});case Ct.KEY_METRIC_JOIN_GATEWAY_END:return nt(nt({},n),{},{keyMetrics:nt(nt({},n.keyMetrics),{},{joinGatewayEnd:i.metric})});case Ct.KEY_METRIC_PEER_CONNECTION_START:return nt(nt({},n),{},{keyMetrics:nt(nt({},n.keyMetrics),{},{peerConnectionStart:i.metric})});case Ct.KEY_METRIC_PEER_CONNECTION_END:return nt(nt({},n),{},{keyMetrics:nt(nt({},n.keyMetrics),{},{peerConnectionEnd:i.metric})});case Ct.KEY_METRIC_DESCRIPTION_START:return nt(nt({},n),{},{keyMetrics:nt(nt({},n.keyMetrics),{},{descriptionStart:i.metric})});case Ct.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return nt(nt({},n),{},{keyMetrics:nt(nt({},n.keyMetrics),{},{signalChannelOpen:i.metric})});case Ct.KEY_METRIC_ICE_CONNECTION_END:return nt(nt({},n),{},{keyMetrics:nt(nt({},n.keyMetrics),{},{iceConnectionEnd:i.metric})});case Ct.KEY_METRIC_PUBLISH:{let r=n.keyMetrics.publish,o=r.findIndex(s=>s.trackId===i.metric.trackId);return o!==-1?(r[o]=nt(nt({},r[o]),i.metric),nt(nt({},n),{},{keyMetrics:nt(nt({},n.keyMetrics),{},{publish:[...r]})})):nt(nt({},n),{},{keyMetrics:nt(nt({},n.keyMetrics),{},{publish:[...n.keyMetrics.publish,i.metric]})})}case Ct.KEY_METRIC_SUBSCRIBE:{let r=n.keyMetrics.subscribe,o=r.findIndex(s=>s.userId===i.metric.userId&&s.type===i.metric.type);return o!==-1?(r[o]=nt(nt({},r[o]),i.metric),nt(nt({},n),{},{keyMetrics:nt(nt({},n.keyMetrics),{},{subscribe:[...r]})})):nt(nt({},n),{},{keyMetrics:nt(nt({},n.keyMetrics),{},{subscribe:[...n.keyMetrics.subscribe,i.metric]})})}case Ct.SET_CLOUD_PROXY_SERVER_MODE:return n.cloudProxyServerMode=i.mode,n;case Ct.RECORD_JOIN_CHANNEL_SERVICE:return typeof i.index!="number"?n.joinChannelServiceRecords=[...n.joinChannelServiceRecords,i.record]:(n.joinChannelServiceRecords[i.index]=nt(nt({},n.joinChannelServiceRecords[i.index]),i.record),n.joinChannelServiceRecords=[...n.joinChannelServiceRecords]),n;case Ct.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return n.joinChannelServiceRecords=[],n;case Ct.RESET_KEY_METRICS:return n.keyMetrics={publish:[],subscribe:[]},n;case Ct.SET_USE_DATACHANNEL:return nt(nt({},n),{},{useDataChannel:i.val});case Ct.SET_USE_P2P:return nt(nt({},n),{},{useP2P:i.val});case Ct.SET_TRANSPORT_TYPE:return nt(nt({},n),{},{p2pTransport:i.val});default:return n}}(this.state,e);}set sessionId(e){this.dispatch({type:Ct.SET_SESSION_ID,sessionId:e});}get sessionId(){return this.state.sessionId}set codec(e){this.state.codec=e;}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(e){this.dispatch({type:Ct.SET_P2P_ID,p2pId:e});}get p2pId(){return this.state.p2pId}set dcId(e){this.dispatch({type:Ct.SET_DC_ID,dcId:e});}get dcId(){return this.state.dcId}set uid(e){this.dispatch({type:Ct.SET_UID,uid:e});}get uid(){return this.state.uid}set intUid(e){this.dispatch({type:Ct.SET_INT_UID,intUid:e});}get intUid(){return this.state.intUid}set pubId(e){this.dispatch({type:Ct.SET_PUB_ID,pubId:e});}get pubId(){return this.state.pubId}set cloudProxyServerMode(e){this.dispatch({type:Ct.SET_CLOUD_PROXY_SERVER_MODE,mode:e});}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useDataChannel(e){this.dispatch({type:Ct.SET_USE_DATACHANNEL,val:e});}get useDataChannel(){return this.state.useDataChannel}set useP2P(e){this.dispatch({type:Ct.SET_USE_P2P,val:e});}get useP2P(){return this.state.useP2P}set p2pTransport(e){this.dispatch({type:Ct.SET_TRANSPORT_TYPE,val:e});}get p2pTransport(){return this.state.p2pTransport}clientCreated(){this.dispatch({type:Ct.KEY_METRIC_CLIENT_CREATED,metric:Date.now()});}joinStart(){this.dispatch({type:Ct.KEY_METRIC_JOIN_START,metric:Date.now()});}joinEnd(){this.dispatch({type:Ct.KEY_METRIC_JOIN_END,metric:Date.now()});}requestAPStart(){this.dispatch({type:Ct.KEY_METRIC_REQUEST_AP_START,metric:Date.now()});}requestAPEnd(){this.dispatch({type:Ct.KEY_METRIC_REQUEST_AP_END,metric:Date.now()});}joinGatewayStart(){this.dispatch({type:Ct.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()});}joinGatewayEnd(){this.dispatch({type:Ct.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()});}peerConnectionStart(){this.dispatch({type:Ct.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()});}peerConnectionEnd(){this.dispatch({type:Ct.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()});}descriptionStart(){this.dispatch({type:Ct.KEY_METRIC_DESCRIPTION_START,metric:Date.now()});}signalChannelOpen(){this.dispatch({type:Ct.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()});}iceConnectionEnd(){this.dispatch({type:Ct.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()});}publish(e,n,i,r){this.dispatch({type:Ct.KEY_METRIC_PUBLISH,metric:nt(nt({trackId:e,type:n},i&&{publishStart:i}),r&&{publishEnd:r})});}subscribe(e,n,i,r,o,s,a){this.dispatch({type:Ct.KEY_METRIC_SUBSCRIBE,metric:nt(nt(nt(nt(nt({userId:e,type:n},i&&{subscribeStart:i}),r&&{subscribeEnd:r}),o&&{firstFrame:o}),s&&{streamAdded:s}),a&&{firstDecoded:a})});}massSubscribe(e,n,i,r){e.forEach(o=>{this.dispatch({type:Ct.KEY_METRIC_SUBSCRIBE,metric:nt(nt(nt({userId:o.userId,type:o.type},n&&{subscribeStart:n}),i&&{subscribeEnd:i}),r&&{firstFrame:r})});});}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(e,n){e.service==="gateway"&&Array.isArray(e.urls)&&(e.urls=e.urls.map(i=>i.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2")));try{return typeof n!="number"?(this.dispatch({type:Ct.RECORD_JOIN_CHANNEL_SERVICE,record:nt(nt({},e),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(n<0||n>=this.state.joinChannelServiceRecords.length||this.dispatch({type:Ct.RECORD_JOIN_CHANNEL_SERVICE,record:e,index:n}),n)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:Ct.RESET_JOIN_CHANNEL_SERVICE_RECORDS});}resetKeyMetrics(){this.dispatch({type:Ct.RESET_KEY_METRICS});}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return []}}get avoidJoinStart(){return this.state.avoidJoinStart}set avoidJoinStart(e){this.dispatch({type:Ct.AVOID_JOIN_START,avoidJoinStart:e});}}let fa=function(t){return t.h264="h264",t.h265="h265",t.vp8="vp8",t.vp9="vp9",t.av1="av1",t}({});(function(t){t.opus="opus",t.pcma="pcma",t.pcmu="pcmu",t.g722="g722";})({});let fI=128,MB=96,gI=1e3,ga=10,UB=0;function TI(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function ft(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?TI(Object(n),!0).forEach(function(i){ve(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):TI(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}function ve(t,e,n){return (e=function(i){var r=function(o,s){if(typeof o!="object"||o===null)return o;var a=o[Symbol.toPrimitive];if(a!==void 0){var c=a.call(o,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(i);return typeof r=="symbol"?r:String(r)}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}let SI=new class extends de{constructor(){super(...arguments),ve(this,"currentUploadLogID",0);}reportLogUploadError(t){let{errorRange:e}=t;e[e.length-1]&&e[e.length-1]>this.currentUploadLogID&&(this.currentUploadLogID=e[e.length-1],this.emit("REPORT_LOG_UPLOAD",t));}};class xB{constructor(e){ve(this,"logger",void 0),ve(this,"prefixLists",[]),this.logger=e;}debug(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];this.logger.debug(...this.prefixLists,...n);}info(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];this.logger.info(...this.prefixLists,...n);}warning(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];this.logger.warning(...this.prefixLists,...n);}error(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];this.logger.error(...this.prefixLists,...n);}prefix(e){return this.prefixLists.push(e),this}popPrefix(){return this.prefixLists.pop(),this}}function fm(){let t=new Date;return t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}function RI(){let t=new Date,e=/((\d+:){2}\d+)/.exec(new Date().toUTCString());return e?e?.[0]+":"+t.getUTCMilliseconds():t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}let Ii={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},tu=Date.now(),Gc=t=>{for(let e in Ii)if(Object.prototype.hasOwnProperty.call(Ii,e)&&Ii[e]===t)return e;return "DEFAULT"},_=new class{constructor(){ve(this,"proxyServerURL",void 0),ve(this,"logLevel",Ii.DEBUG),ve(this,"uploadState","collecting"),ve(this,"uploadLogWaitingList",[]),ve(this,"uploadLogUploadingList",[]),ve(this,"uploadErrorCount",0),ve(this,"currentLogID",0),ve(this,"url",void 0),ve(this,"extLog",(t,e)=>{this.appendLogToWaitingList(t,...e);});}debug(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];let i=[Ii.DEBUG].concat(e);this.log.apply(this,i);}info(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];let i=[Ii.INFO].concat(e);this.log.apply(this,i);}warning(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];let i=[Ii.WARNING].concat(e);this.log.apply(this,i);}warn(){this.warning(...arguments);}error(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];let i=[Ii.ERROR].concat(e);this.log.apply(this,i);}upload(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];let i=[Ii.DEBUG].concat(e);this.uploadLog.apply(this,i);}setLogLevel(t){t=Math.min(Math.max(0,t),4),this.logLevel=t;}enableLogUpload(){Jt("UPLOAD_LOG",!0);}disableLogUpload(){Jt("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[];}setProxyServer(t){this.proxyServerURL=t;}prefix(t){return new xB(this).prefix(t)}log(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(Date.now()-tu<100)return void setTimeout(()=>{this.log(...e);},Date.now()-tu);let i=Math.max(0,Math.min(4,e[0]));if(e[0]=fm()+" Agora-SDK [".concat(Gc(i),"]:"),this.appendLogToWaitingList(i,...e),i<this.logLevel)return;let r=fm()+" %cAgora-SDK [".concat(Gc(i),"]:"),o=[];if(!v("USE_NEW_LOG"))switch(i){case Ii.DEBUG:o=[r,"color: #64B5F6;"].concat(e.slice(1)),console.log.apply(console,o);break;case Ii.INFO:o=[r,"color: #1E88E5; font-weight: bold;"].concat(e.slice(1)),console.log.apply(console,o);break;case Ii.WARNING:o=[r,"color: #FB8C00; font-weight: bold;"].concat(e.slice(1)),console.warn.apply(console,o);break;case Ii.ERROR:o=[r,"color: #B00020; font-weight: bold;"].concat(e.slice(1)),console.error.apply(console,o);}}uploadLog(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(Date.now()-tu<100)return void setTimeout(()=>{this.uploadLog(...e);},Date.now()-tu);let i=Math.max(0,Math.min(4,e[0]));e[0]=fm()+" Agora-SDK [".concat(Gc(i),"]:"),this.appendLogToWaitingList(i,...e);}appendLogToWaitingList(t){if(!v("UPLOAD_LOG"))return;for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];Array.isArray(n[0])?n[0][0]=RI()+" Agora-SDK [".concat(Gc(t),"]:"):n[0]=RI()+" Agora-SDK [".concat(Gc(t),"]:");let r="";n.forEach(o=>{typeof o=="object"&&(o=JSON.stringify(o)),r+="".concat(o," ");}),this.uploadLogWaitingList.push({payload_str:r,log_level:t,log_item_id:this.currentLogID++}),this.uploadState==="uploading"&&this.uploadLogUploadingList.length===0&&this.uploadLogInterval();}startUpload(){this.uploadState="uploading",this.uploadLogUploadingList.length===0&&this.uploadLogInterval();}async uploadLogs(){let t=this.uploadLogUploadingList,e={sdk_version:vi,process_id:v("PROCESS_ID"),payload:JSON.stringify(t)};return ar(async()=>{let n=await Mn.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(v("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(v("LOG_UPLOAD_SERVER"),"/upload/v1")),e,{responseType:"text"});if(n.data!=="OK"){let i=new Error("unexpected upload log response");throw i.response=n,i}},()=>(this.uploadLogUploadingList=[],!1),n=>{let i={status:-1,message:n.message,errorRange:t.map(r=>r.log_item_id)};return n.response?(i.status=n.response.status,i.data=n.response.data,i.headers=n.response.headers):n.request&&(i.status=n.request.status),SI.reportLogUploadError(i),!0},{timeout:v("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:v("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){this.uploadLogUploadingList.length===0&&this.uploadLogWaitingList.length===0||(this.uploadLogUploadingList.length===0&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,v("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then(()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout(()=>this.uploadLogInterval(),v("UPLOAD_LOG_INTERVAL"));}).catch(t=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout(()=>this.uploadLogInterval(),v("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout(()=>this.uploadLogInterval(),v("UPLOAD_LOG_RETRY_INTERVAL_V1"));}));}};var CI;function VB(t){return rn(t.reportId,"params.reportId",0,100,!1),rn(t.category,"params.category",0,100,!1),rn(t.event,"params.event",0,100,!1),rn(t.label,"params.label",0,100,!1),zt(t.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(CI={}).FREE="free",CI.UPLOADING="uploading",function(t){t[t.MISC=0]="MISC",t[t.INTERNAL_EVENT=1]="INTERNAL_EVENT",t[t.PUBLIC_EVENT=2]="PUBLIC_EVENT",t[t.WEB_EVENT=3]="WEB_EVENT",t[t.INTERNAL_API=4]="INTERNAL_API",t[t.WEB_API=5]="WEB_API",t[t.PUBLIC_API=6]="PUBLIC_API";}({});let FB={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0},Ze=function(t){return t.PUBLISH="publish",t.SUBSCRIBE="subscribe",t.WS_COMPRESSOR_INIT="ws_compressor_init",t.SESSION_INIT="session_init",t.JOIN_CHOOSE_SERVER="join_choose_server",t.REQ_USER_ACCOUNT="req_user_account",t.JOIN_GATEWAY="join_gateway",t.REJOIN_GATEWAY="rejoin_gateway",t.STREAM_SWITCH="stream_switch",t.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",t.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",t.FIRST_VIDEO_RECEIVED="first_video_received",t.FIRST_AUDIO_RECEIVED="first_audio_received",t.FIRST_VIDEO_DECODE="first_video_decode",t.FIRST_AUDIO_DECODE="first_audio_decode",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_UPDATE_STREAM="on_update_stream",t.ON_REMOVE_STREAM="on_remove_stream",t.USER_ANALYTICS="req_user_analytics",t.PC_STATS="pc_stats",t.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities",t}({}),_e=function(t){return t.SESSION="io.agora.pb.Wrtc.Session",t.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",t.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",t.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",t.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",t.PUBLISH="io.agora.pb.Wrtc.Publish",t.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",t.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",t.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",t.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",t.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",t.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",t.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",t.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",t.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",t.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",t.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",t.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",t.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",t.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",t.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",t.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",t.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",t.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",t.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",t.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",t.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",t.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",t.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",t.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",t.PC_STATS="io.agora.pb.Wrtc.PCStats",t.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities",t}({});((function(t){t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT";}))({}),function(t){t[t.SESSION=26]="SESSION",t[t.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",t[t.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",t[t.JOIN_GATEWAY=28]="JOIN_GATEWAY",t[t.PUBLISH=30]="PUBLISH",t[t.SUBSCRIBE=29]="SUBSCRIBE",t[t.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",t[t.STREAM_SWITCH=32]="STREAM_SWITCH",t[t.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",t[t.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",t[t.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",t[t.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",t[t.API_INVOKE=41]="API_INVOKE",t[t.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",t[t.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",t[t.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",t[t.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",t[t.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",t[t.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",t[t.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",t[t.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",t[t.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",t[t.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",t[t.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",t[t.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",t[t.USER_ANALYTICS=1e4]="USER_ANALYTICS",t[t.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED";}({});class Wc{constructor(){ve(this,"baseInfoMap",new Map),ve(this,"proxyServer",void 0),ve(this,"eventUploadTimer",void 0),ve(this,"setSessionIdTimer",void 0),ve(this,"url",void 0),ve(this,"backupUrl",void 0),ve(this,"_appId",void 0),ve(this,"keyEventUploadPendingItems",[]),ve(this,"normalEventUploadPendingItems",[]),ve(this,"apiInvokeUploadPendingItems",[]),ve(this,"apiInvokeCount",0),ve(this,"ltsList",[]),ve(this,"lastSendNormalEventTime",Date.now()),ve(this,"customReportCounterTimer",void 0),ve(this,"customReportCount",0),ve(this,"extApiInvoke",async e=>{for(let n of e){let i=ft(ft({},n),{},{sid:null,invokeId:++this.apiInvokeCount,tag:ge.TRACER});this.sendApiInvoke(i);}}),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),v("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),v("EVENT_REPORT_SEND_INTERVAL"));}getBaseInfoBySessionId(e){return this.baseInfoMap.get(e)}adjustSessionStartTime(e){if(!this.baseInfoMap.has(e)&&!this.baseInfoMap.get(e))return void _.error("adjust session ".concat(e," start time, sid is not exist or info is undefined"));let n=this.baseInfoMap.get(e),i=Date.now(),r=n.startTime;n.startTime=i,_.debug("rewrite session ".concat(e," startTime: ").concat(i," , ").concat(i-r,"ms")),this.baseInfoMap.set(e,n);}setAppId(e){this._appId=e;}reportApiInvoke(e,n,i){n.timeout=n.timeout||6e4,n.reportResult=n.reportResult===void 0||n.reportResult;let r=Date.now();this.apiInvokeCount+=1;let o=this.apiInvokeCount,s=()=>({tag:n.tag,invokeId:o,sid:e,name:n.name,apiInvokeTime:r,options:n.options,states:n.states||null}),a=!!v("SHOW_REPORT_INVOKER_LOG");a&&_.info("".concat(n.name," start"),n.options);let c=!1;Ye(n.timeout).then(()=>{c||(this.sendApiInvoke(ft(ft({},s()),{},{error:R.API_INVOKE_TIMEOUT,success:!1})),_.debug("".concat(n.name," timeout")));});let d=new D(R.UNEXPECTED_ERROR,"".concat(n.name,": this api invoke is end"));return {onSuccess:l=>{let u=()=>{if(c)throw d;return c=!0,this.sendApiInvoke(ft(ft({},s()),{},{success:!0},n.reportResult&&{result:l})),a&&_.info("".concat(n.name," onSuccess")),l};return i?hI(u,n.name+"Success",i,()=>c=!0):u()},onError:l=>{let u=()=>{if(c)throw l;c=!0,this.sendApiInvoke(ft(ft({},s()),{},{success:!1,error:l})),a&&_.info("".concat(n.name," onFailure"),l.toString());};return i?hI(u,n.name+"Error",i,()=>c=!0):u()}}}sessionInit(e,n){if(this.baseInfoMap.has(e))return;let i=Date.now(),r=this.createBaseInfo(e,i);r.cname=n.cname;let o=Object.assign({},{willUploadConsoleLog:v("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:_m?"global":"oversea",areas:v("AREAS")&&v("AREAS").join(",")},n.extend),{stringUid:s,channelProfile:a,channelMode:c,isABTestSuccess:d,lsid:l,clientRole:u}=n,h=Date.now(),p=ft(ft({},r),{},{eventType:Ze.SESSION_INIT,appid:n.appid,browser:navigator.userAgent,buildFormat:n.buildFormat,build:Em,lts:h,elapse:h-i,extend:JSON.stringify(o),mode:n.mode,process:v("PROCESS_ID"),appType:v("APP_TYPE"),success:!0,version:vi,stringUid:s,channelProfile:a,channelMode:c,isABTestSuccess:d,lsid:l,clientType:20,clientRole:u,serviceId:v("PROCESS_ID"),extensionID:v("PLUGIN_INFO").join(",")||"",preload:n.preload?1:0});this.send({type:_e.SESSION,data:p},!0);}joinChooseServer(e,n){let i=this.baseInfoMap.get(e);if(!i)return;let r=i.info,o=Date.now(),s=ft(ft({},r),{},{eventType:Ze.JOIN_CHOOSE_SERVER,lts:o,eventElapse:n.elapse||o-n.lts,chooseServerAddr:n.csAddr,errorCode:n.ec,elapse:o-i.startTime,success:n.succ,chooseServerAddrList:JSON.stringify(n.serverList),uid:n.uid?parseInt(n.uid):null,cid:n.cid?parseInt(n.cid):null,chooseServerIp:n.csIp||"",opid:n.opid,unilbsServerIds:n.unilbsServerIds,extend:n.extend||void 0,isHttp3:n.isHttp3});this.send({type:_e.JOIN_CHOOSE_SERVER,data:s},!0);}reqUserAccount(e,n){let i=this.baseInfoMap.get(e);if(!i)return;let r=i.info,o=Date.now(),s=ft(ft({},r),{},{eventType:Ze.REQ_USER_ACCOUNT,lts:o,success:n.success,serverAddress:n.serverAddr,stringUid:n.stringUid,uid:n.uid,errorCode:n.errorCode,elapse:n.elapse||o-i.startTime,eventElapse:o-n.lts,extend:JSON.stringify(n.extend)});this.send({type:_e.REQ_USER_ACCOUNT,data:s},!0);}joinGateway(e,n){let i=this.baseInfoMap.get(e);if(!i)return;let r=i.info;n.vid&&(r.vid=n.vid),r.uid=n.uid,r.cid=n.cid;let o=Date.now(),{firstSuccess:s,avoidJoinStartTime:a,isProxy:c,addr:d}=n,l=o-(s&&a?a:i.startTime),u=ft(ft({},r),{},{eventType:Ze.JOIN_GATEWAY,lts:o,gatewayAddr:n.addr,success:n.succ,errorCode:n.ec,elapse:l,eventElapse:o-n.lts,firstSuccess:s,signalChannel:n.signalChannel}),h=u.success?1:0;if(n.succ&&(i.lastJoinSuccessTime=o),s)this.send({type:_e.JOIN_GATEWAY,data:u},!0);else {let p;if(d)if(c){let m=d.match(/h=(\d{1,3}-){3}\d{1,3}/g),E=d.match(/p=[0-9]{1,6}/g);p={isSuccess:h,gatewayIp:m&&m.length?m[0].split("=")[1].replace(/-/g,"."):"",port:E&&E.length?E[0].split("=")[1]:"",isProxy:c?1:0};}else {let m=d.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),E=d.match(/(:|p=)[0-9]{1,6}/g);p={isSuccess:h,gatewayIp:m&&m.length?m[0].split("//")[1].replace(/-/g,"."):"",port:E&&E.length?E[0].split(/:|p=/g)[1]:"",isProxy:c?1:0};}else p={isSuccess:h,gatewayIp:"",port:"",isProxy:c?1:0};delete u.success,delete u.eventType,delete u.firstSuccess,u.vid=Number(u.vid);let T=Object.assign({},u,p,{eventType:Ze.REJOIN_GATEWAY});this.send({type:_e.RE_JOIN_GATEWAY,data:T},!0);}}joinChannelTimeout(e,n){let i=this.baseInfoMap.get(e);if(!i)return;let r=Date.now(),o=ft(ft({},i.info),{},{lts:r,timeout:n,elapse:r-i.startTime});this.send({type:_e.JOIN_CHANNEL_TIMEOUT,data:o},!0);}publish(e,n){let i=this.baseInfoMap.get(e);if(!i)return;let r=i.info,o=Date.now(),s=ft(ft({},r),{},{eventType:Ze.PUBLISH,lts:o,eventElapse:n.eventElapse,elapse:o-i.startTime,success:n.succ,errorCode:n.ec,videoName:n.videoName,audioName:n.audioName,screenName:n.screenName,screenshare:n.screenshare,audio:n.audio,video:n.video,p2pid:n.p2pid,publishRequestid:n.publishRequestid});this.send({type:_e.PUBLISH,data:s},!0);}subscribe(e,n,i){let r=this.baseInfoMap.get(e);if(!r)return;let o=r.info,s=Date.now(),a=ft(ft({},o),{},{eventType:Ze.SUBSCRIBE,lts:s,eventElapse:n.eventElapse,elapse:s-r.startTime,success:n.succ,errorCode:n.ec,video:n.video,audio:n.audio,subscribeRequestid:n.subscribeRequestid,p2pid:n.p2pid},i&&{extend:JSON.stringify({isMassSubscribe:!0})});typeof n.peerid=="string"?a.peerSuid=n.peerid:a.peer=n.peerid,this.send({type:_e.SUBSCRIBE,data:a},!0);}wsCompressorInit(e){var n;let i=[...ri(n=this.baseInfoMap).call(n)],r=i.length?i[0]:"UnableToGetSid",o=this.baseInfoMap.get(r);if(!o)return;let s=o.info,a=Date.now(),c=ft(ft({},s),{},{eventType:Ze.WS_COMPRESSOR_INIT,lts:a,eventElapse:e.eventElapse,elapse:a-o.startTime,status:e.status?1:2});this.send({type:_e.WS_COMPRESSOR_INIT,data:c},!0);}firstRemoteVideoDecode(e,n,i,r){let o=this.baseInfoMap.get(e);if(!o)return;let s=o.info,a=Date.now(),c=ft(ft(ft({},s),r),{},{elapse:a-o.startTime,eventType:n,lts:a,firstDecodeFrame:Math.max(a-o.startTime,0),apEnd:Math.max(r.apEnd-o.startTime,0),apStart:Math.max(r.apStart-o.startTime,0),joinGwEnd:Math.max(r.joinGwEnd-o.startTime,0),joinGwStart:Math.max(r.joinGwStart-o.startTime,0),pcEnd:Math.max(r.pcEnd-o.startTime,0),pcStart:Math.max(r.pcStart-o.startTime,0),subscriberEnd:Math.max(r.subscriberEnd-o.startTime,0),subscriberStart:Math.max(r.subscriberStart-o.startTime,0),videoAddNotify:Math.max(r.videoAddNotify-o.startTime,0)});this.send({type:i,data:c},!0);}firstRemoteFrame(e,n,i,r){let o=this.baseInfoMap.get(e);if(!o)return;let s=o.info,a=Date.now(),c=ft(ft(ft({},s),r),{},{elapse:a-o.startTime,eventType:n,lts:a});this.send({type:i,data:c},!0);}pcStats(e,n){let i=this.baseInfoMap.get(e);if(!i)return;let r=i.info,o=Date.now(),s=ft(ft(ft({},r),n),{},{vid:r.vid===void 0?0:Number(r.vid),elapse:o-i.startTime,eventType:Ze.PC_STATS,lts:o});this.send({type:_e.PC_STATS,data:s},!0);}updateRemoteRTPCapabilities(e,n){if(e){let i=this.baseInfoMap.get(e);if(!i)return;let r=i.info,o=Date.now(),s=ft(ft(ft({},r),n),{},{vid:r.vid===void 0?0:Number(r.vid),eventType:Ze.UPDATE_REMOTE_RTPCAPABILITIES,lts:o});this.send({type:_e.UPDATE_REMOTE_RTPCAPABILITIES,data:s},!0);}}onGatewayStream(e,n,i,r){let o=this.baseInfoMap.get(e);if(!o)return;let s=o.info,a=Date.now(),c=ft(ft(ft({},s),r),{},{eventType:n,lts:a});this.send({type:i,data:c},!0);}streamSwitch(e,n){let i=this.baseInfoMap.get(e);if(!i)return;let r=i.info,o=Date.now(),s=ft(ft({},r),{},{eventType:Ze.STREAM_SWITCH,lts:o,isDual:n.isdual,elapse:o-i.startTime,success:n.succ});this.send({type:_e.STREAM_SWITCH,data:s},!0);}requestProxyAppCenter(e,n){let i=this.baseInfoMap.get(e);if(!i)return;let r=i.info,o=Date.now(),s=ft(ft({},r),{},{eventType:Ze.REQUEST_PROXY_APPCENTER,lts:o,eventElapse:o-n.lts,elapse:o-i.startTime,APAddr:n.APAddr,workerManagerList:n.workerManagerList,response:n.response,errorCode:n.ec,success:n.succ});this.send({type:_e.REQUEST_PROXY_APPCENTER,data:s},!0);}requestProxyWorkerManager(e,n){let i=this.baseInfoMap.get(e);if(!i)return;let r=i.info,o=Date.now(),s=ft(ft({},r),{},{eventType:Ze.REQUEST_PROXY_WORKER_MANAGER,lts:o,eventElapse:o-n.lts,elapse:o-i.startTime,workerManagerAddr:n.workerManagerAddr,response:n.response,errorCode:n.ec,success:n.succ});this.send({type:_e.REQUEST_PROXY_WORKER_MANAGER,data:s},!0);}setProxyServer(e){this.proxyServer=e,e?_.debug("reportProxyServerurl: ".concat(e)):_.debug("disable reportProxyServerurl: ".concat(e));}peerPublishStatus(e,n){let i=this.baseInfoMap.get(e);if(!i)return;let r=i.info,o=Date.now(),s=ft(ft({},r),{},{subscribeElapse:n.subscribeElapse,peer:n.peer,peerPublishDuration:Math.max(n.audioPublishDuration,n.videoPublishDuration),audiotag:n.audioPublishDuration>0?1:-1,videotag:n.videoPublishDuration>0?1:-1,lts:o,elapse:o-i.startTime,joinChannelSuccessElapse:o-(i.lastJoinSuccessTime||o),peerPublishDurationVideo:n.videoPublishDuration,peerPublishDurationAudio:n.audioPublishDuration});this.send({type:_e.PEER_PUBLISH_STATUS,data:s},!0);}workerEvent(e,n){let i=this.baseInfoMap.get(e);if(!i)return;let r=i.info,o=Date.now();(function(s,a,c){let d=s[a];if(!d||typeof d!="string")return [s];s[a]="";let l=Or(JSON.stringify(s)),u=0,h=[],p=0;for(let T=0;T<d.length;T++)p+=d.charCodeAt(T)<=127?1:3,p<=c-l||(h[h.length]=nt(nt({},s),{},{[a]:d.substring(u,T)}),u=T,p=d.charCodeAt(T)<=127?1:3);return u!==d.length-1&&(h[h.length]=nt(nt({},s),{},{[a]:d.substring(u)})),h})(ft(ft(ft({},r),n),{},{elapse:o-i.startTime,lts:o,productType:"WebRTC"}),"payload",1300).forEach(s=>this.send({type:_e.WORKER_EVENT,data:s},!0));}apworkerEvent(e,n){let i=this.baseInfoMap.get(e);if(!i)return;let r=i.info,o=Date.now(),s=ft(ft(ft({},r),n),{},{elapse:o-i.startTime,lts:o});this.send({type:_e.AP_WORKER_EVENT,data:s},!0);}joinWebProxyAP(e,n){let i=this.baseInfoMap.get(e);if(!i)return;let r=i.info,o=Date.now(),s=ft(ft(ft({},r),n),{},{elapse:o-i.startTime,lts:o,extend:n.extend||void 0});this.send({type:_e.JOIN_WEB_PROXY_AP,data:s},!0);}WebSocketQuit(e,n){let i=this.baseInfoMap.get(e);if(!i)return;let r=i.info,o=Date.now(),s=ft(ft(ft({},r),n),{},{elapse:o-i.startTime,lts:o});this.send({type:_e.WEBSOCKET_QUIT,data:s},!0);}async sendCustomReportMessage(e,n){if(this.customReportCount+=n.length,this.customReportCount>v("CUSTOM_REPORT_LIMIT"))throw new D(R.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval(()=>{this.customReportCount=0;},5e3));let i=Date.now(),r=n.map(o=>({type:_e.USER_ANALYTICS,data:ft(ft({sid:e},o),{},{lts:i})}));try{v("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(r):await this.postDataToStatsCollector(r);}catch(o){throw _.error("send custom report message failed",o.toString()),new D(R.CUSTOM_REPORT_SEND_FAILED,o.message)}}sendApiInvoke(e){let n=v("NOT_REPORT_EVENT");if(e.tag&&q(n)&&q(n).call(n,e.tag))return !1;if(e.sid===null)return this.apiInvokeUploadPendingItems.push(e),!1;let i=this.baseInfoMap.get(e.sid);if(!i)return this.apiInvokeUploadPendingItems.push(e),!1;let{cname:r,uid:o,cid:s}=i.info,a;if(e.lts=e.lts||Date.now(),e.error)if(e.error instanceof D){let{code:d,message:l}=e.error;a=d||l||e.error.toString();}else a=e.error.toString();let c={invokeId:e.invokeId,sid:e.sid,cname:r,cid:s,uid:o,lts:e.lts,success:e.success,elapse:e.lts-i.startTime,execElapse:e.lts-e.apiInvokeTime,apiName:e.name,options:e.options?JSON.stringify(e.options):void 0,execStates:e.states?JSON.stringify(e.states):void 0,execResult:e.result?JSON.stringify(e.result):void 0,errorCode:e.error?a:void 0,errorMsg:e.error?JSON.stringify(e.error):void 0};return this.send({type:_e.API_INVOKE,data:c},!1),!0}appendSessionId(){Wc.__CLIENT_LIST__.forEach(e=>{if(e._sessionId){let n=this.apiInvokeUploadPendingItems.length;for(let i=0;i<n;i++){let r=this.apiInvokeUploadPendingItems.shift();r&&(r.sid=e._sessionId,this.sendApiInvoke(Object.assign({},r)));}}});}send(e,n){if(n)return this.keyEventUploadPendingItems.push(e),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(e),this.normalEventUploadPendingItems.length>v("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1);}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1);}sendItems(e,n){let i=[],r=[];for(;e.length;){let s=e.shift();i.length<20?i.push(s):r.push(s);}e.push(...r);for(let s of [...i]){var o;this.ltsList.indexOf(s.data.lts)!==-1?(s.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(s.data.lts)):(this.ltsList.push(s.data.lts),vc(o=this.ltsList).call(o,(a,c)=>a-c));}return n||(this.lastSendNormalEventTime=Date.now()),v("ENABLE_EVENT_REPORT")&&i.length&&(v("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(i):this.postDataToStatsCollector(i)).catch((s=>a=>{v("EVENT_REPORT_RETRY")&&(n?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(s):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(s),this.normalEventUploadPendingItems.length>v("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-v("NORMAL_EVENT_QUEUE_CAPACITY")),_.warning("report: drop normal events"))));})(i)),e}async postDataToStatsCollector2(e){Te.networkState===On.OFFLINE&&await K.race([Te.onlineWaiter,Ye(2*Ne.maxRetryTimeout)]);let n=o=>{let s=new Uint8Array;return o.forEach(a=>{let c=am(JSON.stringify(a.data)),d=new ArrayBuffer(5),l=(h=>{let p=0;return Object.entries(_e).forEach(T=>{let[m,E]=T;E===h.type&&(p=EventNameToID[m]);}),p})(a),u=new DataView(d);u.setUint16(0,c.byteLength,!0),u.setUint8(2,255&l),u.setUint8(3,l>>>8&255),u.setUint8(4,l>>>16&255),s=nI(s,new Uint8Array(d)),s=nI(s,c);}),s},i="event",r=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(v("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(i):"https://".concat(v("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(i);for(let o=0;o<2;o+=1){o===1&&(r=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(v("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(i):"https://".concat(v("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(i));try{await pm(r,{timeout:1e4,data:n(e),headers:ft(ft({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0);}catch(s){if(o===1)throw s;continue}return}}async postDataToStatsCollector(e){let n=arguments.length>1&&arguments[1]!==void 0&&arguments[1],i={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:e.map(s=>JSON.stringify(s)),vid:(s=>{let a=s&&s.data.sid&&this.baseInfoMap.get(s.data.sid);return a&&a.info.vid&&+a.info.vid||0})(e[0])};Te.networkState===On.OFFLINE&&await K.race([Te.onlineWaiter,Ye(2*Ne.maxRetryTimeout)]);let r=n?"/events/proto-raws":"/events/messages",o=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(v("EVENT_REPORT_DOMAIN"),"&p=").concat(v("STATS_COLLECTOR_PORT"),"&d=").concat(r):"https://".concat(v("EVENT_REPORT_DOMAIN"),":").concat(v("STATS_COLLECTOR_PORT")).concat(r));for(let s=0;s<2;s+=1){s===1&&(o=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(v("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(v("STATS_COLLECTOR_PORT"),"&d=").concat(r):"https://".concat(v("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(v("STATS_COLLECTOR_PORT")).concat(r)));try{n?await LB(o,{timeout:1e4,data:i}):await pm(o,{timeout:1e4,data:i});}catch(a){if(s===1)throw a;continue}return}}createBaseInfo(e,n){let i=Object.assign({},FB);return i.sid=e,this.baseInfoMap.set(e,{info:i,startTime:n}),i}reportResourceTiming(e,n){let i=performance.getEntriesByName(e),r=i[i.length-1];r&&this.reportApiInvoke(n,{name:"Client.resourceTiming",options:r,tag:ge.TRACER}).onSuccess();}}function st(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function(e,n,i){let r=i.value;if(typeof r=="function"){let o=t.className||e.__className__||(e.constructor.name==="AgoraRTCClient"?"Client":e.constructor.name);i.value=function(){for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];let d=a;if(t.argsMap)try{d=t.argsMap(this,...a);}catch(u){_.warning(u),d=[];}try{JSON.stringify(d);}catch{_.warning("arguments for method ".concat(o,".").concat(String(n)," not serializable for apiInvoke.")),d=[];}let l=(t.report||et).reportApiInvoke(this._sessionId||null,{name:"".concat(o,".").concat(String(n)),options:d,tag:ge.TRACER,reportResult:t.reportResult},t.throttleTime);try{let u=r.apply(this,a);return u instanceof K?u.then(h=>(l.onSuccess(t.reportResult&&h),h)).catch(h=>{throw l.onError(h),h}):(l.onSuccess(t.reportResult&&u),u)}catch(u){throw l.onError(u),u}};}return i}}ve(Wc,"__CLIENT_LIST__",[]);let et=new Wc;SI.on("REPORT_LOG_UPLOAD",t=>{t.networkState=Te.networkState,et.reportApiInvoke(null,{name:"logUploadError",options:t,tag:ge.TRACER}).onSuccess("logUploadError");});let BB=["CHINA","GLOBAL"],ln=function(){let t="us".concat("erna","me"),e="pa".concat("sswo","rd"),n=["t","s","t"];n.splice(1,0,"e");let i=n.join(""),r=[];for(let a=0;a<6;a++)r.push("1");let o=r.join(""),s={};return s[t]=i,s[e]=o,Object.assign(s,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=ln,_m||(Fe.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],Fe.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],Fe.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],Fe.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],Fe.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],Fe.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],Fe.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",Fe.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",Fe.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",Fe.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",Fe.AREAS=["NORTH_AMERICA","OVERSEA"]);let vI=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],wo=[];function Es(t,e){return !!e&&wo.some(n=>n.uid===t&&n.channelName===e)}Wc.__CLIENT_LIST__=wo;var jB=ZR.forEach,II=Wd("forEach")?[].forEach:function(t){return jB(this,t,arguments.length>1?arguments[1]:void 0)};ee({target:"Array",proto:!0,forced:[].forEach!=II},{forEach:II});var GB=Mi("Array").forEach,WB=Cr,HB=_n,KB=ut,YB=GB,gm=Array.prototype,qB={DOMTokenList:!0,NodeList:!0},zB=function(t){var e=t.forEach;return t===gm||KB(gm,t)&&e===gm.forEach||HB(qB,WB(t))?YB:e},JB=j(zB),XB=Rr,yI=zd;ee({target:"Object",stat:!0,forced:H(function(){yI(1);})},{keys:function(t){return yI(XB(t))}});var AI=j(ir.Object.keys),QB=j(Tg),ZB=ee,$B=Ac,tj=Et([].reverse),bI=[1,2];ZB({target:"Array",proto:!0,forced:String(bI)===String(bI.reverse())},{reverse:function(){return $B(this)&&(this.length=this.length),tj(this)}});var ej=Mi("Array").reverse,nj=ut,ij=ej,Tm=Array.prototype,rj=function(t){var e=t.reverse;return t===Tm||nj(Tm,t)&&e===Tm.reverse?ij:e},wI=rj,oj=j(wI),sj=ee,OI=Ac,aj=sl,cj=ii,NI=jh,dj=qr,lj=po,uj=Tl,hj=Oe,pj=Rp,_j=GR("slice"),mj=hj("species"),Sm=Array,Ej=Math.max;sj({target:"Array",proto:!0,forced:!_j},{slice:function(t,e){var n,i,r,o=lj(this),s=dj(o),a=NI(t,s),c=NI(e===void 0?s:e,s);if(OI(o)&&(n=o.constructor,(aj(n)&&(n===Sm||OI(n.prototype))||cj(n)&&(n=n[mj])===null)&&(n=void 0),n===Sm||n===void 0))return pj(o,a,c);for(i=new(n===void 0?Sm:n)(Ej(c-a,0)),r=0;a<c;a++,r++)a in o&&uj(i,r,o[a]);return i.length=r,i}});var fj=Mi("Array").slice,gj=ut,Tj=fj,Rm=Array.prototype,Sj=function(t){var e=t.slice;return t===Rm||gj(Rm,t)&&e===Rm.slice?Tj:e},Rj=j(Sj);function W(t,e,n,i,r){var o,s,a,c={};return JB(o=AI(i)).call(o,function(d){c[d]=i[d];}),c.enumerable=!!c.enumerable,c.configurable=!!c.configurable,("value"in c||c.initializer)&&(c.writable=!0),c=QB(s=oj(a=Rj(n).call(n)).call(a)).call(s,function(d,l){return l(t,e,d)||d},c),r&&c.initializer!==void 0&&(c.value=c.initializer?c.initializer.call(r):void 0,c.initializer=void 0),c.initializer===void 0&&(VR(t,e,c),c=null),c}var Cj=Mi("Array").values,vj=Cr,Ij=_n,yj=ut,Aj=Cj,Cm=Array.prototype,bj={DOMTokenList:!0,NodeList:!0},wj=function(t){var e=t.values;return t===Cm||yj(Cm,t)&&e===Cm.values||Ij(bj,vj(t))?Aj:e},cr=j(wj);let Oj=function(t){return t.L1T1="L1T1",t.L1T2="L1T2",t.L1T3="L1T3",t.L2T1_KEY="L2T1_KEY",t.L2T2_KEY="L2T2_KEY",t.L2T3_KEY="L2T3_KEY",t.L3T1_KEY="L3T1_KEY",t.L3T2_KEY="L3T2_KEY",t.L3T3_KEY="L3T3_KEY",t}({}),si=function(t){return t.CERTIFICATE="certificate",t.CODEC="codec",t.CANDIDATE_PAIR="candidate-pair",t.LOCAL_CANDIDATE="local-candidate",t.REMOTE_CANDIDATE="remote-candidate",t.INBOUND="inbound-rtp",t.TRACK="track",t.OUTBOUND="outbound-rtp",t.PC="peer-connection",t.REMOTE_INBOUND="remote-inbound-rtp",t.REMOTE_OUTBOUND="remote-outbound-rtp",t.TRANSPORT="transport",t.CSRC="csrc",t.DATA_CHANNEL="data-channel",t.STREAM="stream",t.SENDER="sender",t.RECEIVER="receiver",t}({}),eu=function(t){return t[t.ACCESS_POINT=101]="ACCESS_POINT",t[t.UNILBS=201]="UNILBS",t[t.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",t}({}),vm=function(t){return t[t.IIIEGAL_APPID=1]="IIIEGAL_APPID",t[t.IIIEGAL_UID=2]="IIIEGAL_UID",t[t.INTERNAL_ERROR=3]="INTERNAL_ERROR",t}({}),Fi=function(t){return t[t.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",t[t.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",t[t.INTERNAL_ERROR=8]="INTERNAL_ERROR",t[t.NO_AUTHORIZED=9]="NO_AUTHORIZED",t[t.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",t[t.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",t[t.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",t[t.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",t[t.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",t[t.USER_OVERLOAD=16]="USER_OVERLOAD",t[t.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",t[t.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",t}({}),Nn=function(t){return t[t.NO_FLAG_SET=100]="NO_FLAG_SET",t[t.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",t[t.INVALID_FALG_SET=102]="INVALID_FALG_SET",t[t.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",t[t.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",t[t.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",t[t.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",t[t.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",t[t.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",t[t.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",t[t.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",t[t.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",t[t.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",t[t.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",t[t.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",t[t.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",t[t.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",t[t.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",t[t.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",t}({}),ot=function(t){return t[t.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",t[t.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",t[t.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",t[t.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",t[t.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",t[t.K_TICKET_INVALID=7]="K_TICKET_INVALID",t[t.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",t[t.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",t[t.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",t[t.K_UID_BANNED=14]="K_UID_BANNED",t[t.K_IP_BANNED=15]="K_IP_BANNED",t[t.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",t[t.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",t[t.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",t[t.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",t[t.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",t[t.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",t[t.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",t[t.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",t[t.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",t[t.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",t[t.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",t[t.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",t[t.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",t[t.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",t[t.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",t[t.ERR_INVALID_UID=117]="ERR_INVALID_UID",t[t.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",t[t.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",t[t.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",t[t.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",t[t.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",t[t.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",t[t.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",t[t.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",t[t.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",t[t.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",t[t.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",t[t.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",t[t.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",t[t.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",t[t.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",t[t.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",t[t.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",t[t.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",t[t.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",t[t.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",t[t.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",t[t.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",t[t.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",t[t.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",t[t.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",t[t.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",t[t.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",t[t.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",t[t.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",t[t.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",t[t.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",t[t.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",t[t.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",t[t.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",t[t.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",t[t.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",t[t.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",t}({}),vt=function(t){return t.CONNECTING="connecting",t.CONNECTED="connected",t.RECONNECTING="reconnecting",t.CLOSED="closed",t}({}),Q=function(t){return t.WS_CONNECTED="ws_connected",t.WS_RECONNECTING="ws_reconnecting",t.WS_CLOSED="ws_closed",t.WS_RECONNECT_WAITTING_FINISH="ws_reconnect_waitting_finish",t.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",t.ON_BINARY_DATA="on_binary_data",t.REQUEST_RECOVER="request_recover",t.REQUEST_JOIN_INFO="request_join_info",t.REQUEST_REJOIN_INFO="req_rejoin_info",t.IS_P2P_DISCONNECTED="is_p2p_dis",t.DISCONNECT_P2P="dis_p2p",t.ABORT_P2P_EXECUTION="abort_p2p_execution",t.NEED_RENEW_SESSION="need-sid",t.REPORT_JOIN_GATEWAY="report_join_gateway",t.REQUEST_TIMEOUT="request_timeout",t.REQUEST_SUCCESS="request_success",t.JOIN_RESPONSE="join_response",t.DATACHANNEL_PRECONNECT="datachannel_preconnect",t.DATACHANNEL_CONNECTING="datachannel_connecting",t.DATACHANNEL_FAILBACK="datachannel_failback",t.P2P_CONNECTION="p2p_connection",t.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",t.P2P_SUBSCRIBE="p2p_subscribe",t.P2P_UNSUBSCRIBE="p2p_unsubscribe",t.P2P_EXCHANGE_SDP="p2p_exchange_sdp",t.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",t.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",t}({}),it=function(t){return t.PING="ping",t.PING_BACK="ping_back",t.JOIN="join_v3",t.REJOIN="rejoin_v3",t.LEAVE="leave",t.SET_CLIENT_ROLE="set_client_role",t.PUBLISH="publish",t.PUBLISH_DATASTREAM="publish_datastream",t.UNPUBLISH="unpublish",t.UNPUBLISH_DATASTREAM="unpublish_datastream",t.SUBSCRIBE="subscribe",t.PRE_SUBSCRIBE="pre_subscribe",t.SUBSCRIBE_DATASTREAM="subscribe_datastream",t.SUBSCRIBE_STREAMS="subscribe_streams",t.UNSUBSCRIBE="unsubscribe",t.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",t.UNSUBSCRIBE_STREAMS="unsubscribe_streams",t.SUBSCRIBE_CHANGE="subscribe_change",t.TRAFFIC_STATS="traffic_stats",t.RENEW_TOKEN="renew_token",t.SWITCH_VIDEO_STREAM="switch_video_stream",t.DEFAULT_VIDEO_STREAM="default_video_stream",t.SET_FALLBACK_OPTION="set_fallback_option",t.GATEWAY_INFO="gateway_info",t.CONTROL="control",t.SEND_METADATA="send_metadata",t.DATA_STREAM="data_stream",t.PICK_SVC_LAYER="pick_svc_layer",t.RESTART_ICE="restart_ice",t.CONNECT_PC="connect_pc",t.SET_VIDEO_PROFILE="set_video_profile",t.SET_PARAMETER="set_parameter",t.SET_RTM2_FLAG="set_rtm2_flag",t}({}),fs=function(t){return t.WRTC_STATS="wrtc_stats",t.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",t.DENOISER_STATS="denoiser_stats",t.EXTENSION_USAGE_STATS="extension_usage_stats",t}({}),_t=function(t){return t.ON_USER_ONLINE="on_user_online",t.ON_USER_OFFLINE="on_user_offline",t.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",t.ON_PUBLISH_STREAM="on_publish_stream",t.ON_UPLINK_STATS="on_uplink_stats",t.ON_P2P_LOST="on_p2p_lost",t.ON_REMOVE_STREAM="on_remove_stream",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",t.ON_USER_BANNED="on_user_banned",t.ON_USER_LICENSE_BANNED="on_user_license_banned",t.ON_NOTIFICATION="on_notification",t.ON_CRYPT_ERROR="on_crypt_error",t.MUTE_AUDIO="mute_audio",t.MUTE_VIDEO="mute_video",t.UNMUTE_AUDIO="unmute_audio",t.UNMUTE_VIDEO="unmute_video",t.ON_P2P_OK="on_p2p_ok",t.RECEIVE_METADATA="receive_metadata",t.ON_DATA_STREAM="on_data_stream",t.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",t.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",t.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",t.ENABLE_LOCAL_VIDEO="enable_local_video",t.DISABLE_LOCAL_VIDEO="disable_local_video",t.ENABLE_LOCAL_AUDIO="enable_local_audio",t.DISABLE_LOCAL_AUDIO="disable_local_audio",t.ON_PUBLISHED_USER_LIST="on_published_user_list",t}({}),Dn=function(t){return t.SEND_ONLY="SEND_ONLY",t.RECEIVE_ONLY="RECEIVE_ONLY",t}({}),dt=function(t){return t.CONNECTED="websocket:connected",t.RECONNECTING="websocket:reconnecting",t.WILL_RECONNECT="websocket:will_reconnect",t.CLOSED="websocket:closed",t.FAILED="websocket:failed",t.ON_MESSAGE="websocket:on_message",t.REQUEST_NEW_URLS="websocket:request_new_urls",t.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",t.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",t}({});class w extends D{constructor(e){super(e,arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",arguments.length>2?arguments[2]:void 0),g(this,"name","AgoraRTCException");}print(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error";return super.print(e,_)}throw(){super.throw(_);}}function nu(t){if(typeof t!="string"||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(t))throw _.error("Invalid Channel Name ".concat(t)),new w(R.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function iu(t){if(!function(e){return typeof e=="number"&&Math.floor(e)===e&&0<=e&&e<=4294967295}(t)&&!Zv(t,1,255))throw new w(R.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");typeof t=="string"&&_.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.");}let $e=function(t){return t.TRANSCODE="mix_streaming",t.RAW="raw_streaming",t.INJECT="inject_streaming",t}({}),Ta=function(t){return t[t.INJECT_STREAM_STATUS_START_SUCCESS=0]="INJECT_STREAM_STATUS_START_SUCCESS",t[t.INJECT_STREAM_STATUS_START_ALREADY_EXISTS=1]="INJECT_STREAM_STATUS_START_ALREADY_EXISTS",t[t.INJECT_STREAM_STATUS_START_UNAUTHORIZED=2]="INJECT_STREAM_STATUS_START_UNAUTHORIZED",t[t.INJECT_STREAM_STATUS_START_TIMEOUT=3]="INJECT_STREAM_STATUS_START_TIMEOUT",t[t.INJECT_STREAM_STATUS_START_FAILED=4]="INJECT_STREAM_STATUS_START_FAILED",t[t.INJECT_STREAM_STATUS_STOP_SUCCESS=5]="INJECT_STREAM_STATUS_STOP_SUCCESS",t[t.INJECT_STREAM_STATUS_STOP_NOT_FOUND=6]="INJECT_STREAM_STATUS_STOP_NOT_FOUND",t[t.INJECT_STREAM_STATUS_STOP_UNAUTHORIZED=7]="INJECT_STREAM_STATUS_STOP_UNAUTHORIZED",t[t.INJECT_STREAM_STATUS_STOP_TIMEOUT=8]="INJECT_STREAM_STATUS_STOP_TIMEOUT",t[t.INJECT_STREAM_STATUS_STOP_FAILED=9]="INJECT_STREAM_STATUS_STOP_FAILED",t[t.INJECT_STREAM_STATUS_BROKEN=10]="INJECT_STREAM_STATUS_BROKEN",t}({}),Nj={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},Im={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function ym(t,e){rn(t.url,"".concat(e,".url"),1,1e3,!1),fe(t.x)||zt(t.x,"".concat(e,".x"),0,1e4),fe(t.y)||zt(t.y,"".concat(e,".y"),0,1e4),fe(t.width)||zt(t.width,"".concat(e,".width"),0,1e4),fe(t.height)||zt(t.height,"".concat(e,".height"),0,1e4),fe(t.zOrder)||zt(t.zOrder,"".concat(e,".zOrder"),0,255),fe(t.alpha)||zt(t.alpha,"".concat(e,".alpha"),0,1,!1);}let Dj={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},Pj={audioBitrate:48,audioChannels:2,audioVolume:100,audioSampleRate:48e3,height:0,width:0,videoBitrate:400,videoFramerate:15,videoGop:30},Nr=function(t){return t.WARNING="@live_uap-warning",t.ERROR="@line_uap-error",t.PUBLISH_STREAM_STATUS="@live_uap-publish-status",t.INJECT_STREAM_STATUS="@live_uap-inject-status",t.WORKER_STATUS="@live_uap-worker-status",t.REQUEST_NEW_ADDRESS="@live_uap-request-address",t}({}),ru=function(t){return t.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager",t}({}),Be=function(t){return t[t.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",t[t.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",t[t.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",t[t.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",t[t.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",t[t.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",t[t.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",t[t.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",t[t.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",t[t.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",t[t.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",t[t.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",t[t.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",t[t.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",t[t.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",t[t.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN",t}({});function DI(t){if(!t.channelName)throw new w(R.INVALID_PARAMS,"invalid channelName in info");if(typeof t.uid!="number")throw new w(R.INVALID_PARAMS,"invalid uid in info, uid must be a number");return t.token&&rn(t.token,"info.token",1,2047),iu(t.uid),nu(t.channelName),!0}let Pn=function(t){return t[t.SetSdkProfile=0]="SetSdkProfile",t[t.SetSourceChannel=1]="SetSourceChannel",t[t.SetSourceUserId=2]="SetSourceUserId",t[t.SetDestChannel=3]="SetDestChannel",t[t.StartPacketTransfer=4]="StartPacketTransfer",t[t.StopPacketTransfer=5]="StopPacketTransfer",t[t.UpdateDestChannel=6]="UpdateDestChannel",t[t.Reconnect=7]="Reconnect",t[t.SetVideoProfile=8]="SetVideoProfile",t}({}),Zr=function(t){return t.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",t.NETWORK_CONNECTED="NETWORK_CONNECTED",t.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",t.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",t.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",t.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",t.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",t.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",t.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",t.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",t}({}),Gn=function(t){return t.RELAY_STATE_IDLE="RELAY_STATE_IDLE",t.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",t.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",t.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",t}({}),Sa=function(t){return t.RELAY_OK="RELAY_OK",t.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",t.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",t.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",t}({}),jt=function(t){return t.High="high",t.Low="low",t.Audio="audio",t.Screen="screen",t.ScreenLow="screen_low",t}({}),Ie=function(t){return t.DISCONNECT="disconnect",t.CONNECTION_STATE_CHANGE="connection-state-change",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGE="stream-type-change",t.IS_P2P_DISCONNECTED="is-p2p-dis",t.DISCONNECT_P2P="dis-p2p",t.REQUEST_NEW_GATEWAY_LIST="req-gate-url",t.NEED_RENEW_SESSION="need-sid",t.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",t.JOIN_RESPONSE="join-response",t.REQUEST_DC_CONNECTION_PARAMS="request-dc-connection-params",t.RESET_CONNECTION_EVENTS="reset-connection-events",t.DATACHANNEL_PRECONNECT="datachannel_preconnect",t.DATACHANNEL_FAILBACK="datachannel_failback",t.RESET_SIGNAL="reset-signal",t}({}),Hc=function(t){return t.P2P_DISCONNECTED="P2P_DISCONNECTED",t.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",t.TIMEOUT="TIMEOUT",t.UNKNOWN_REASON="UNKNOWN_REASON",t}({}),qe=function(t){return t[t.Nothing=0]="Nothing",t[t.Audio=1]="Audio",t[t.LwoVideo=2]="LwoVideo",t[t.Video=4]="Video",t[t.Data=8]="Data",t[t.DataStream0=256]="DataStream0",t[t.DataStream1=512]="DataStream1",t[t.DataStream2=1024]="DataStream2",t[t.DataStream3=2048]="DataStream3",t[t.DataStream4=4096]="DataStream4",t[t.DataStream5=8192]="DataStream5",t[t.DataStream6=16384]="DataStream6",t[t.DataStream7=32768]="DataStream7",t}({}),PI=function(t){return t[t.websocket=0]="websocket",t[t.datachannel=1]="datachannel",t}({}),Mt=function(t){return t.CHINA="CHINA",t.ASIA="ASIA",t.NORTH_AMERICA="NORTH_AMERICA",t.EUROPE="EUROPE",t.JAPAN="JAPAN",t.INDIA="INDIA",t.KOREA="KOREA",t.HKMC="HKMC",t.US="US",t.OCEANIA="OCEANIA",t.SOUTH_AMERICA="SOUTH_AMERICA",t.AFRICA="AFRICA",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="EXTENSIONS",t}({}),LI=[Mt.AFRICA,Mt.ASIA,Mt.CHINA,Mt.EUROPE,Mt.GLOBAL,Mt.INDIA,Mt.JAPAN,Mt.NORTH_AMERICA,Mt.OCEANIA,Mt.OVERSEA,Mt.SOUTH_AMERICA],En=function(t){return t.CHINA="CN",t.ASIA="AS",t.NORTH_AMERICA="NA",t.EUROPE="EU",t.JAPAN="JP",t.INDIA="IN",t.KOREA="KR",t.HKMC="HK",t.US="US",t.OCEANIA="OC",t.SOUTH_AMERICA="SA",t.AFRICA="AF",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="GLOBAL",t}({}),ou={CHINA:{},ASIA:{CODE:En.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:En.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:En.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:En.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:En.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:En.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:En.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:En.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:En.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:En.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:En.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:En.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:En.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};_m&&(ou.CHINA={CODE:En.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]});let Am=function(t){return t.UPDATE_BITRATE_LIMIT="update_bitrate_limit",t}({});class kI extends de{constructor(e,n){super(),g(this,"onICEConnectionStateChange",void 0),g(this,"onConnectionStateChange",void 0),g(this,"onDTLSTransportStateChange",void 0),g(this,"onDTLSTransportError",void 0),g(this,"onICETransportStateChange",void 0),g(this,"onFirstAudioReceived",void 0),g(this,"onFirstVideoReceived",void 0),g(this,"onFirstAudioDecoded",void 0),g(this,"onFirstVideoDecoded",void 0),g(this,"onFirstVideoDecodedTimeout",void 0),g(this,"onSelectedLocalCandidateChanged",void 0),g(this,"onSelectedRemoteCandidateChanged",void 0),g(this,"getLocalVideoStats",void 0);}}class su extends kI{constructor(e,n){super(e,n),g(this,"establishPromise",void 0);}}let tt=function(t){return t.VIDEO="video",t.AUDIO="audio",t}({}),In=function(t){return t[t.UDP=0]="UDP",t[t.TCP=1]="TCP",t[t.RELAY=2]="RELAY",t}({}),$r=function(t){return t[t.FIRST_CONNECTION=0]="FIRST_CONNECTION",t[t.TCP_RESTART=1]="TCP_RESTART",t[t.RELAY_RESTART=2]="RELAY_RESTART",t[t.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",t[t.OLD_RESTART=11]="OLD_RESTART",t[t.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED",t}({}),F=function(t){return t.LocalVideoTrack="videoTrack",t.LocalAudioTrack="audioTrack",t.LocalVideoLowTrack="videoLowTrack",t}({}),Gt=function(t){return t.New="new",t.Connected="connected",t.Reconnecting="reconnecting",t.Disconnected="disconnected",t}({}),ct=function(t){return t.StateChange="stateChange",t.IceConnectionStateChange="iceConnectionStateChange",t.RequestMuteLocal="requestMuteLocal",t.RequestUnmuteLocal="requestUnmuteLocal",t.RequestRePublish="requestRePublish",t.RequestRePublishDataChannel="requestRePublishDataChannel",t.RequestReSubscribe="requestReSubscribe",t.RequestUploadStats="requestUploadStats",t.RequestUpload="requestUpload",t.MediaReconnectStart="MediaReconnectStart",t.MediaReconnectEnd="MediaReconnectEnd",t.NeedSignalRTT="NeedSignalRTT",t.RequestRestartICE="RequestRestartIce",t.PeerConnectionStateChange="PeerConnectionStateChange",t.RequestReconnect="RequestReconnect",t.RequestReconnectPC="RequestReconnectPC",t.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",t.P2PLost="P2PLost",t.UpdateVideoEncoder="UpdateVideoEncoder",t.ConnectionTypeChange="ConnectionTypeChange",t.RequestLowStreamParameter="RequestLowStreamParameter",t.QueryClientConnectionState="QueryClientConnectionState",t.LocalCandidate="LocalCandidate",t.RequestP2PMuteLocal="requestP2PMuteLocal",t.RequestP2PUnPublish="RequestP2PUnPublish",t.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",t.RequestP2PMuteRemote="RequestP2PMuteRemote",t.RequestP2PRestartICE="RequestP2PRestartICE",t}({}),Bi=function(t){return t.CONNECTING="CONNECTING",t.RECONNECTING="RECONNECTING",t.CONNECTED="CONNECTED",t.CLOSED="CLOSED",t}({}),ji=function(t){return t[t.CONNECT_AP=0]="CONNECT_AP",t[t.AP_CONNECTED=1]="AP_CONNECTED",t[t.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",t[t.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",t[t.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",t[t.CONNECT_WORKER=5]="CONNECT_WORKER",t[t.WORKER_CONNECTED=6]="WORKER_CONNECTED",t[t.CLOSED=7]="CLOSED",t}({}),tn=function(t){return t.CONNECTION_STATE_CHANGE="connection-state-change",t.STATE_CHANGE="state-change",t.INSPECT_RESULT="inspect-result",t.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",t.REQUEST_NEW_WORKER_URL="request-new-worker-url",t}({}),Oo=function(t){return t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.MULTI_IP="MULTI_IP",t.TIMEOUT="TIMEOUT",t.OFFLINE="OFFLINE",t.LEAVE="LEAVE",t.P2P_FAILED="P2P_FAILED",t.FALLBACK="FALLBACK",t}({}),Ue=function(t){return t.CONNECTED="transmitter:connected",t.RECONNECTING="transmitter:reconnecting",t.WILL_RECONNECT="transmitter:will_reconnect",t.CLOSED="transmitter:closed",t.FAILED="transmitter:failed",t.ON_MESSAGE="transmitter:on_message",t.REQUEST_NEW_URLS="transmitter:request_new_urls",t.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",t.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",t.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",t.FAILBACK="transmitter:failback",t}({}),Dr=function(t){return t.CAMERA_CHANGED="camera-changed",t.MICROPHONE_CHANGED="microphone-changed",t.PLAYBACK_DEVICE_CHANGED="playback-device-changed",t.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",t.AUTOPLAY_FAILED="autoplay-failed",t.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",t.SECURITY_POLICY_VIOLATION="security-policy-violation",t}({}),yi=function(t){return t.CONNECTING="CONNECTING",t.RECONNECTING="RECONNECTING",t.CONNECTED="CONNECTED",t.CLOSED="CLOSED",t}({}),dr=function(t){return t.CONNECTION_STATE_CHANGE="connection-state-change",t.STATE_CHANGE="state-change",t.INSPECT_RESULT="inspect-result",t.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",t.REQUEST_NEW_WORKER_URL="request-new-worker-url",t}({}),Ra=function(t){return t[t.CONNECT_AP=0]="CONNECT_AP",t[t.AP_CONNECTED=1]="AP_CONNECTED",t[t.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",t[t.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",t[t.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",t[t.CONNECT_WORKER=5]="CONNECT_WORKER",t[t.WORKER_CONNECTED=6]="WORKER_CONNECTED",t[t.CLOSED=7]="CLOSED",t}({}),ye=function(t){return t.CALL="call",t.CANDIDATE="candidate",t.PUBLISH="publish",t.UNPUBLISH="unpublish",t.CONTROL="control",t.RESTART_ICE="restart_ice",t.ACK="ack",t.RESPONSE="response",t.JOIN="join",t.CHECK="check",t}({}),Ca=function(t){return t.ABORT="abort",t}({}),No=function(t){return t.MUTE_LOCAL_AUDIO="mute_local_audio",t.MUTE_LOCAL_VIDEO="mute_local_video",t.UNMUTE_LOCAL_AUDIO="unmute_local_audio",t.UNMUTE_LOCAL_VIDEO="unmute_local_video",t}({}),Lj=function(t){return t.P2P_TOKEN_TIMEOUT="p2p_token_timeout",t.P2P_TOKEN_CHANGED="p2p_token_changed",t}({}),kj={[eu.ACCESS_POINT]:{[Nn.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[Nn.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[Nn.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[Nn.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[Nn.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[Nn.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[Nn.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[Nn.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[Nn.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[Nn.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[Nn.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[Nn.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[Nn.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[Nn.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[Nn.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[Nn.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[Nn.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[Nn.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[eu.UNILBS]:{[Fi.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[Fi.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[Fi.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[Fi.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[Fi.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[Fi.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[Fi.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[Fi.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[Fi.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[Fi.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[Fi.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[Fi.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[eu.STRING_UID_ALLOCATOR]:{[vm.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[vm.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[vm.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function va(t){let e=kj[Math.floor(t/1e4)];if(!e)return {desc:"unknown error",retry:!1};let n=e[t%1e4];if(!n){if(Math.floor(t/1e4)===eu.ACCESS_POINT){let i=t%1e4;if(i.toString()[0]==="1")return {desc:t.toString(),retry:!1};if(i.toString()[0]==="2")return {desc:t.toString(),retry:!0}}return {desc:"unknown error",retry:!1}}return n}let Mj={[ot.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[ot.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[ot.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[ot.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[ot.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[ot.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[ot.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[ot.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[ot.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[ot.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[ot.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[ot.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[ot.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[ot.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[ot.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[ot.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[ot.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[ot.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[ot.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[ot.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[ot.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[ot.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[ot.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[ot.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[ot.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[ot.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[ot.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[ot.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[ot.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[ot.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[ot.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[ot.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[ot.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[ot.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[ot.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[ot.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[ot.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[ot.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[ot.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[ot.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[ot.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[ot.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[ot.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[ot.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[ot.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[ot.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[ot.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[ot.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[ot.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[ot.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[ot.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[ot.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[ot.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[ot.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[ot.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[ot.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[ot.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[ot.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[ot.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[ot.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[ot.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[ot.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[ot.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function gs(t){return Mj[t]||{desc:"UNKNOW_ERROR_".concat(t),action:"failed"}}function MI(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function bm(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?MI(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):MI(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}function UI(t){return t.every(e=>e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING)}function xI(t,e){if(typeof t=="string")return t;let{proxy:n,host:i,port:r}=t;if(e){let o=v("JOIN_GATEWAY_FALLBACK_PORT")||443;return o===443?"wss://".concat(i,"/ws/?p=").concat(Number(r)+150):"wss://".concat(i,":").concat(o,"/ws/?p=").concat(Number(r)+150)}return n?"wss://".concat(n,"/ws/?h=").concat(i,"&p=").concat(r):"wss://".concat(i,":").concat(r)}let Uj=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,xj=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,Vj=/wss:\/\/(.+):([0-9]+)\/?/,Fj=/wss:\/\/(.[^\/]+)\/?/,Bj=0;class jj{constructor(e,n){g(this,"id",0),g(this,"store",void 0),g(this,"recordIndex",void 0),g(this,"websockets",[]),g(this,"try443PortDuration",2e3),g(this,"forceCloseWSDuration",5e3),g(this,"try443PortTimeout",null),g(this,"forceCloseTimeout",null),g(this,"isTry443PortFailed",!1),g(this,"isNormalPortFailed",!1),g(this,"useDoubleDomain",!1),g(this,"useProxy",!1),g(this,"startTime",Date.now()),this.id=++Bj,this.try443PortDuration=v("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=e||5e3,this.store=n;}closeAllWebsockets(){this.websockets.forEach(e=>{e.onopen=null,e.onclose=null,e.onmessage=null,e.close();}),this.websockets.length=0;}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout);}logger(){var e;let n=Date.now()-this.startTime;for(var i=arguments.length,r=new Array(i),o=0;o<i;o++)r[o]=arguments[o];_.debug("[choose-best-ws ".concat((e=this.store)===null||e===void 0?void 0:e.clientId," ").concat(this.id,"] ").concat(n,"ms:"),...r);}createWebSocket(e,n,i){this.logger("createWebSocket:",e,{isTry443Port:n,hasTimeoutDetection:i});let r=v("GATEWAY_DOMAINS"),o=Date.now(),s=[],a=r.find(l=>{var u;return q(u=e.host).call(u,l)});a||(this.useDoubleDomain=!1);let c=[];if(this.useDoubleDomain)r.forEach(l=>{c.push(xI(bm(bm({},e),{},{host:e.host.replace(a,l)}),n));});else {let l=bm({},e);if(n&&a){let u=r.find(h=>h!==a);u&&(l.host=l.host.replace(a,u));}c.push(xI(l,n));}try{c.forEach(l=>{let u=new WebSocket(l);u.binaryType="arraybuffer",s.push(u),this.logger("ws is connecting:",u.url);});}catch(l){if(this.logger("ws create failed"),s.forEach(u=>u.close()),s.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(e,n,i);if(!n&&Number(e.port)!==443)return this.createWebSocket(e,!0,i);throw new w(R.WS_ERR,"init websocket failed! Error: ".concat(l.toString()))}let d=xc();return this.store&&this.store.recordJoinChannelService({urls:s.map(l=>l.url),service:"gateway"},this.recordIndex),s.forEach(l=>{l.onopen=()=>{this.logger("onopen: ws ".concat(l.url," open cost ").concat(Date.now()-o,"ms")),this.websockets.forEach(u=>{u!==l&&(u.onopen=null,u.onclose=null,u.onmessage=null,u.close(),this.logger("close backup websocket: ".concat(u.url)));}),this.websockets.length=0,d.resolve(l);},l.onclose=u=>{this.logger("onclose: ws ".concat(l.url," closed cost ").concat(Date.now()-o,"ms state: ").concat(l.readyState)),n?this.isTry443PortFailed=UI(s):this.isNormalPortFailed=UI(s),this.logger("443: ".concat(this.useProxy?"not try":this.isTry443PortFailed?"failed":"trying"," 47xx: ").concat(this.isNormalPortFailed?"failed":"trying")),(n&&this.isTry443PortFailed||!n&&(this.isTry443PortFailed||this.useProxy)&&this.isNormalPortFailed)&&(this.logger("onclose: all websocket is closed, ".concat(u.reason)),d.reject({code:u.code,reason:Hc.A_ROUND_WS_FAILED}));},l.onmessage=u=>this.logger("".concat(l.url," onmessage: ").concat(u.data));}),this.websockets.push(...s),i||(()=>{let l=()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",d.isResolved),this.websockets.forEach(u=>u.readyState!==WebSocket.OPEN&&u.close());};if(n||this.useProxy)return this.logger("add 5s timeout at ".concat(n?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(l,this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout(()=>{if(this.logger("2s timeout, isWebsocket created: ",d.isResolved),d.isResolved)return l();Pt().os===He.MAC_OS&&Xt()&&l(),this.createWebSocket(e,!0,!0).then(u=>d.resolve(u)).catch(u=>{this.isNormalPortFailed&&d.reject(u),this.logger("try 443 port to create ws failed");}),this.forceCloseTimeout=window.setTimeout(l,this.forceCloseWSDuration);},this.try443PortDuration);})(),d.promise}chooseBestWebsocket(e,n,i,r){return this.useDoubleDomain=!!n,typeof e=="string"&&(e=function(o){let s,a,c;return [,s,a,c]=o.match(Uj)||[],s||([,a,c]=o.match(xj)||[]),a&&c||([,a,c]=o.match(Vj)||[]),a&&c||([,a]=o.match(Fj)||[]),a||_.warning("un-destructible url: ",o),{proxy:s,host:a,port:c||"443"}}(e)),this.recordIndex=r,this.useProxy=!!e.proxy,i&&this.useProxy&&(_.warn("cannot use 443 only when use proxy"),i=!1),this.createWebSocket(e,!!i,!1).finally(()=>this.clearTimeout())}}function VI(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}class FI extends de{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var n;q(n=["tryNext","recover"]).call(n,e)&&this.resetReconnectCount(e),this._reconnectMode=e;}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._state==="reconnecting"?this.emit(dt.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(dt.CONNECTED):this._state==="closed"?this.emit(dt.CLOSED):this._state==="failed"&&this.emit(dt.FAILED));}resetReconnectCount(e){_.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0;}constructor(e,n){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2],r=arguments.length>3&&arguments[3]!==void 0&&arguments[3],o=arguments.length>4&&arguments[4]!==void 0&&arguments[4],s=arguments.length>5?arguments[5]:void 0;super(),g(this,"connectionID",0),g(this,"currentURLIndex",0),g(this,"urls",[]),g(this,"_reconnectMode","tryNext"),g(this,"reconnectReason",void 0),g(this,"_initMutex",new Qe("websocket")),g(this,"name",void 0),g(this,"_state","closed"),g(this,"reconnectInterrupter",void 0),g(this,"websocket",void 0),g(this,"retryConfig",void 0),g(this,"reconnectCount",0),g(this,"forceCloseTimeout",5e3),g(this,"onlineReconnectListener",void 0),g(this,"useCompress",void 0),g(this,"tryDoubleDomain",!1),g(this,"use443PortOnly",!1),g(this,"wsInflateLength",0),g(this,"wsDeflateLength",0),g(this,"closeEstablishingWs",()=>{}),g(this,"store",void 0),g(this,"joinGatewayRecordIndex",void 0),this.store=s,this.name=e,this.retryConfig=function(u){for(var h=1;h<arguments.length;h++){var p=arguments[h]!=null?arguments[h]:{};h%2?VI(Object(p),!0).forEach(function(T){g(u,T,p[T]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(u,Object.getOwnPropertyDescriptors(p)):VI(Object(p)).forEach(function(T){Object.defineProperty(u,T,Object.getOwnPropertyDescriptor(p,T));});}return u}({},n),this.useCompress=i,this.tryDoubleDomain=r,this.use443PortOnly=o;let{timeout:a,timeoutFactor:c}=n,d=Math.max(300,Math.floor(3*a/5)),l=Math.max(1.2,Math.floor(8*c)/10);On.ONLINE&&(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=l),Te.on(us.NETWORK_STATE_CHANGE,(u,h)=>{u!==h&&(this.resetReconnectCount("network state change: ".concat(h," -> ").concat(u)),u===On.ONLINE?(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=l):(this.retryConfig.timeout=a,this.retryConfig.timeoutFactor=c));});}getConnection(){return this.websocket||void 0}async init(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3,i=await this._initMutex.lock();this.forceCloseTimeout=n,this.urls=e,this.state="connecting";try{let r=xc(),o=this.urls[this.currentURLIndex];this.createWebSocketConnection(o).then(r.resolve).catch(r.reject),this.once(dt.CLOSED,()=>{r.reject(new D(R.WS_DISCONNECT));}),this.once(dt.CONNECTED,r.resolve),await r.promise;}catch{}finally{i();}}close(e,n){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;let i=this.websocket;n?setTimeout(()=>i.close(),500):i.close(),this.websocket=void 0;}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs();}reconnect(e,n){if(!this.websocket)return void _.warning("[".concat(this.name,"] can not reconnect, no websocket"));e!==void 0&&(this.reconnectMode=e),_.debug("[".concat(this.name,"] reconnect is triggered initiative")),typeof this.joinGatewayRecordIndex=="number"&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(n)]},this.joinGatewayRecordIndex);let i=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),i&&i.bind(this.websocket)({code:9999,reason:n});}sendMessage(e){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new D(R.WS_ABORT,"websocket is not ready");try{n||(e=JSON.stringify(e)),this.websocket.send(e);}catch(i){throw new D(R.WS_ERR,"send websocket message error"+i.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength;}getWsInflateData(){let e=this.wsInflateLength,n=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:n}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0;}async createWebSocketConnection(e){var n;let i=xc();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;let r=l=>{var u;(u=this.store)===null||u===void 0||u.signalChannelOpen(),_.debug("[".concat(this.name,"] websocket opened:"),l),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),i.resolve();},o=async l=>{var u;if(_.debug("[".concat(this.name,"] websocket close ").concat((u=this.websocket)===null||u===void 0?void 0:u.url,", code: ").concat(l.code,", reason: ").concat(l.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)i.reject(new D(R.WS_DISCONNECT,"websocket close: ".concat(l.code))),this.close();else {this.state==="connected"&&(this.reconnectReason=l.reason,this.state="reconnecting");let h=Qn(this,dt.WILL_RECONNECT,this.reconnectMode,l.reason)||this.reconnectMode,p=await this.reconnectWithAction(h);if(this.state==="closed")return void _.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!p)return i.reject(new D(R.WS_DISCONNECT,"websocket reconnect failed: ".concat(l.code))),this.close(!0);i.resolve();}},s=l=>{this.emit(dt.ON_MESSAGE,l);},a=l=>{_.warn("[".concat(this.connectionID,"] ws open error ").concat(l));};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),v("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(e=v("GATEWAY_WSS_ADDRESS")),_.debug("[".concat(this.name,"] start connect, url:"),e);let c=(n=this.store)===null||n===void 0?void 0:n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var d;let l=await this.chooseBestWebsocketConnection(e);this.websocket=l,r&&r(this.websocket.url),this.websocket.onclose=o,this.websocket.onmessage=s,this.websocket.onerror=a,(d=this.store)===null||d===void 0||d.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this.joinGatewayRecordIndex=c;}catch(l){let u=this.state==="closed",h=l instanceof D,p=h&&l.code===R.WS_ABORT,T=h&&l.code===R.WS_ERR,m=h?l.message:l&&(l.reason||l.toString());_.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(m)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:p?"aborted":"error",errors:[l]},c),u||T?(i.reject(u?new D(R.WS_DISCONNECT,"websocket is closed: ".concat(m)):new D(R.WS_ERR,"init websocket failed: ".concat(m))),T&&_.error("[".concat(this.name,"] init websocket failed: ").concat(m))):o&&o(l);}return i.promise}async reconnectWithAction(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||this.urls.length===0||this.state==="closed")return !1;_.warning("[choose-best-ws] action: =>",e),this.onlineReconnectListener||Te.isOnline||!Te.onlineWaiter||(this.onlineReconnectListener=Te.onlineWaiter.then(()=>{this.onlineReconnectListener=void 0;}));let i=!0;if(this.reconnectInterrupter=()=>i=!1,n){let s=Ql(this.reconnectCount,this.retryConfig);_.debug("[".concat(this.name,"] wait ").concat(s,"ms to reconnect websocket, mode: ").concat(e)),await K.race([Ye(s),this.onlineReconnectListener||new K(()=>{})]);}if(this._state==="closed"||!i)return !1;this.reconnectCount+=1;let r=async(s,a)=>{this.emit(dt.RECONNECT_CREATE_CONNECTION,a),await this.createWebSocketConnection(s);};try{if(e==="retry")this.emit(dt.RECONNECT_WAITTING_FINISH,e),await r(this.urls[this.currentURLIndex],e);else if(e==="tryNext"){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);_.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),this.emit(dt.RECONNECT_WAITTING_FINISH,e),await r(this.urls[this.currentURLIndex],e);}else e==="recover"&&(_.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(dt.RECONNECT_WAITTING_FINISH,e),this.urls=await Me(this,dt.REQUEST_NEW_URLS),this.currentURLIndex=0,await r(this.urls[this.currentURLIndex],e));}catch(s){var o;_.error("[".concat(this.name,"] reconnect failed ").concat(s&&s.toString()));let a=s==null||(o=s.data)===null||o===void 0?void 0:o.desc;return Array.isArray(a)&&q(a).call(a,"dynamic key expired")?(this.emit(dt.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(e,n)}return !0}}class Kc extends FI{constructor(e,n){super(e,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0);}async chooseBestWebsocketConnection(e,n){let i=xc(),r=function(s,a){return new jj(s,a)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{_.debug("[choose-best-ws] close establishing websockets"),r.closeAllWebsockets(),i.reject(new D(R.WS_ABORT,"choose best websocket aborted"));};let o=v("GATEWAY_DOMAINS");return _.debug("[choose-best-ws] currentDomain: ",e,", domains: ",o,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),r.chooseBestWebsocket(e,this.tryDoubleDomain,this.use443PortOnly,n).then(i.resolve).catch(i.reject),i.promise.finally(()=>{this.closeEstablishingWs=void 0;})}}class Yc extends FI{constructor(e,n){super(e,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0);}async chooseBestWebsocketConnection(e,n){return new K((i,r)=>{let o=!1,s=[];this.closeEstablishingWs=()=>{_.debug("[choose-best-ws] close establishing websockets"),s.forEach(T=>{T.onclose=null,T.onopen=null,T.onmessage=null,T.close();}),r(new D(R.WS_ABORT,"choose best websocket aborted"));};let a=v("GATEWAY_DOMAINS"),c,d=e.indexOf("?h="),l=a.find(T=>d!==-1?q(e).call(e,T,d):q(e).call(e,T));_.debug("[choose-best-ws] currentDomain: ",l,", domains: ",a);let u=!this.tryDoubleDomain||!l;if(!u&&l){var h;let T=Date.now();try{a.forEach(m=>{let E=d===-1?e.replace(l,m):e.substr(0,d)+e.substr(d).replace(l,m),S=new WebSocket(E);S.binaryType="arraybuffer",s.push(S),_.debug("[choose-best-ws] ws is connecting:",S.url);});}catch{for(_.debug("[choose-best-ws] ws create failed, fallback to single url"),s.forEach(E=>E.close());s.length;)s.pop();u=!0;}(h=this.store)===null||h===void 0||h.recordJoinChannelService({urls:s.map(m=>m.url),service:"gateway"},n),s.forEach(m=>{m.onopen=()=>{if(o)return;let E=Date.now()-T;_.debug("[choose-best-ws] ws open cost ".concat(E,"ms")),s.filter(S=>S!==m).forEach(S=>{_.debug("[choose-best-ws]close backup websocket: ".concat(S.url)),S.close();}),o=!0,i(m);},m.onclose=E=>{c=E,!o&&(s.find(S=>!(S.readyState===WebSocket.CLOSED||S.readyState===WebSocket.CLOSING))||(_.debug("[choose-best-ws] all websocket is closed"),o=!0,r(c)));},m.onmessage=E=>{_.debug("[choose-best-ws]".concat(m.url," onmessage: ").concat(E.data));};}),Ye(this.forceCloseTimeout).then(()=>{s.forEach(m=>{m.readyState!==WebSocket.OPEN&&m.close();});});}if(u){var p;let T;_.debug("[choose-best-ws] use single url: ",e),(p=this.store)===null||p===void 0||p.recordJoinChannelService({urls:[e],service:"gateway"},n);try{T=new WebSocket(e),s.push(T),T.binaryType="arraybuffer";}catch(m){let E=new D(R.WS_ERR,"init websocket failed! Error: ".concat(m.toString()));return _.error("[".concat(this.name,"]").concat(E)),void r(E)}T.onopen=()=>{i(T);},T.onclose=m=>{r(m);},T.onmessage=m=>{_.debug("[choose-best-ws]".concat(T.url," onmessage: ").concat(m.data));},Ye(this.forceCloseTimeout).then(()=>{T&&T.readyState!==WebSocket.OPEN&&T.close();});}}).then(i=>(this.closeEstablishingWs=void 0,i)).catch(i=>{throw this.closeEstablishingWs=void 0,i})}}class BI extends de{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===vt.CONNECTED?this.emit(Q.WS_CONNECTED):e===vt.RECONNECTING?this.emit(Q.WS_RECONNECTING,this._websocketReconnectReason):e===vt.CLOSED&&this.emit(Q.WS_CLOSED,this._disconnectedReason));}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,n){super(),g(this,"_disconnectedReason",void 0),g(this,"_websocketReconnectReason",void 0),g(this,"_connectionState",vt.CLOSED),g(this,"reconnectToken",void 0),g(this,"websocket",void 0),g(this,"openConnectionTime",void 0),g(this,"clientId",void 0),g(this,"lastMsgTime",Date.now()),g(this,"uploadCache",[]),g(this,"uploadCacheInterval",void 0),g(this,"rttRolling",new um(5)),g(this,"pingpongTimer",void 0),g(this,"wsInflateDataTimer",void 0),g(this,"pingpongTimeoutCount",0),g(this,"joinResponse",void 0),g(this,"multiIpOption",void 0),g(this,"initError",void 0),g(this,"spec",void 0),g(this,"store",void 0),g(this,"onWebsocketMessage",i=>{if(i.data instanceof ArrayBuffer)return void this.emit(Q.ON_BINARY_DATA,i.data);let r=JSON.parse(i.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){let o="res-@".concat(r._id);this.emit(o,r._result,r._message);}else if(Object.prototype.hasOwnProperty.call(r,"_type")){if(this.emit(r._type,r._message),r._type===_t.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===_t.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(It.UID_BANNED);break;case 15:this.close(It.IP_BANNED);break;case 16:this.close(It.CHANNEL_BANNED);}if(r._type===_t.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case ot.ERR_LICENSE_MISSING:this.close(It.LICENSE_MISSING);break;case ot.ERR_LICENSE_EXPIRED:this.close(It.LICENSE_EXPIRED);break;case ot.ERR_LICENSE_MINUTES_EXCEEDED:this.close(It.LICENSE_MINUTES_EXCEEDED);break;case ot.ERR_LICENSE_PERIOD_INVALID:this.close(It.LICENSE_PERIOD_INVALID);break;case ot.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(It.LICENSE_MULTIPLE_SDK_SERVICE);break;case ot.ERR_LICENSE_ILLEGAL:this.close(It.LICENSE_ILLEGAL);break;default:this.close();}}}),this.clientId=e.clientId,this.spec=e,this.store=n,this.websocket=new Kc("gateway-".concat(this.clientId),this.spec.retryConfig,!0,v("JOIN_GATEWAY_USE_DUAL_DOMAIN"),v("JOIN_GATEWAY_USE_443PORT_ONLY"),n),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===vt.CONNECTED&&this.reconnect("retry",dn.OFFLINE);});}async request(e,n,i,r){let o=Zt(6,""),s={_id:o,_type:e,_message:n},a=this.websocket.connectionID,c=()=>new K((T,m)=>{if(this.connectionState===vt.CONNECTED)return T();let E=()=>{this.off(Q.WS_CLOSED,S),T();},S=()=>{this.off(Q.WS_CONNECTED,E),m(new w(R.WS_ABORT));};this.once(Q.WS_CONNECTED,E),this.once(Q.WS_CLOSED,S),e!==it.PUBLISH&&e!==it.PUBLISH_DATASTREAM&&e!==it.SUBSCRIBE&&e!==it.SUBSCRIBE_DATASTREAM&&e!==it.UNSUBSCRIBE&&e!==it.UNSUBSCRIBE_DATASTREAM&&e!==it.UNPUBLISH&&e!==it.UNPUBLISH_DATASTREAM&&e!==it.CONTROL&&e!==it.RESTART_ICE||this.once(Q.DISCONNECT_P2P,()=>{m(new w(R.DISCONNECT_P2P));}),e!==it.PUBLISH&&e!==it.RESTART_ICE||this.once(Q.ABORT_P2P_EXECUTION,()=>{m(new w(R.DISCONNECT_P2P));});});if(this.connectionState!==vt.CONNECTING&&this.connectionState!==vt.RECONNECTING||e===it.JOIN||e===it.REJOIN||await c(),this.websocket.sendMessage(s,!0),r)return;let d=new K((T,m)=>{let E=!1,S=(A,b)=>{E=!0,T({isSuccess:A==="success",message:b||{}}),this.off(Q.WS_CLOSED,C),this.off(Q.WS_RECONNECTING,C),this.emit(Q.REQUEST_SUCCESS,e,n);};this.once("res-@".concat(o),S);let C=()=>{m(new w(R.WS_ABORT,"type: ".concat(e))),this.off(Q.WS_CLOSED,C),this.off(Q.WS_RECONNECTING,C),this.off("res-@".concat(o),S);};this.once(Q.WS_CLOSED,C),this.once(Q.WS_RECONNECTING,C),Ye(v("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||E||(_.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(Q.REQUEST_TIMEOUT,e,n));});}),l=null;try{l=await d;}catch(T){if(this.connectionState===vt.CLOSED||e===it.LEAVE)throw new w(R.WS_ABORT);return !this.spec.forceWaitGatewayResponse||i?T.throw():e===it.JOIN||e===it.REJOIN?null:(await c(),await this.request(e,n))}if(l.isSuccess)return l.message;let u=Number(l.message.error_code||l.message.code),h=gs(u),p=new w(R.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(l.message.error_str),{code:u,data:l.message});return h.action==="success"?l.message:(_.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(u,", message: ").concat(h.desc,", action: ").concat(h.action)),u===ot.ERR_TOO_MANY_BROADCASTERS?((e===it.JOIN||e===it.REJOIN)&&(this.initError=p,this.close()),p.throw()):h.action==="failed"?p.throw():h.action==="quit"?(this.initError=p,this.close(),p.throw()):(u===ot.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,_.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",dn.MULTI_IP)):this.reconnect(h.action,dn.SERVER_ERROR),e===it.JOIN||e===it.REJOIN?null:await this.request(e,n)))}waitMessage(e,n){return new K(i=>{let r=o=>{(!n||n(o))&&(this.off(e,r),i(o));};this.on(e,r);})}uploadWRTCStats(e){if(!this.store.sessionId)return void _.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));let n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(fs.WRTC_STATS,n);}upload(e,n){let i={_type:e,_message:n};try{this.websocket.sendMessage(i);}catch{let o=v("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>o&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==vt.CONNECTED)return;let s=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(s._type,s._message);},v("UPLOAD_CACHE_INTERVAL")||2e3));}}send(e,n){let i={_type:e,_message:n};this.websocket.sendMessage(i);}init(e,n){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new K((i,r)=>{this.once(Q.WS_CONNECTED,()=>i(this.joinResponse)),this.once(Q.WS_CLOSED,()=>r(this.initError||new w(R.WS_ABORT))),this.connectionState=vt.CONNECTING,this.websocket.init(e).catch(r),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval(()=>{this.handleWsInflateData();},2e4);})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||It.LEAVE,this.connectionState=vt.CLOSED,_.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===It.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new Kc("gateway-".concat(this.clientId),this.spec.retryConfig,!0,v("JOIN_GATEWAY_USE_DUAL_DOMAIN"),v("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents());}async join(){if(!this.joinResponse){this.emit(Q.ABORT_P2P_EXECUTION);let e=await Me(this,Q.REQUEST_JOIN_INFO),n=await this.request(it.JOIN,e);if(!n)return this.emit(Q.REPORT_JOIN_GATEWAY,Hc.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(Q.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token;}return this.connectionState=vt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new w(R.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");let e=hs(this,Q.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;let n=await this.request(it.REJOIN,e);return !!n&&(this.connectionState=vt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),n.peers&&n.peers.forEach(i=>{this.emit(_t.ON_USER_ONLINE,{uid:i.uid}),i.audio&&this.emit(_t.ON_ADD_AUDIO_STREAM,{uid:i.uid,uint_id:i.uint_id,audio:!0,ssrcId:i.audio_ssrc}),i.video&&this.emit(_t.ON_ADD_VIDEO_STREAM,{uid:i.uid,uint_id:i.uint_id,video:!0,ssrcId:i.video_ssrc}),i.audio_mute?this.emit(_t.MUTE_AUDIO,{uid:i.uid}):this.emit(_t.UNMUTE_AUDIO,{uid:i.uid}),i.video_mute?this.emit(_t.MUTE_VIDEO,{uid:i.uid}):this.emit(_t.UNMUTE_VIDEO,{uid:i.uid}),i.audio_enable_local?this.emit(_t.ENABLE_LOCAL_AUDIO,{uid:i.uid}):this.emit(_t.DISABLE_LOCAL_AUDIO,{uid:i.uid}),i.video_enable_local?this.emit(_t.ENABLE_LOCAL_VIDEO,{uid:i.uid}):this.emit(_t.DISABLE_LOCAL_VIDEO,{uid:i.uid}),i.audio||i.video||this.emit(_t.ON_REMOVE_STREAM,{uid:i.uid,uint_id:i.uint_id});}),!0)}reconnect(e,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,n);}handleNotification(e){_.debug("[".concat(this.clientId,"] receive notification: "),e);let n=gs(e.code);if(n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(It.UID_BANNED),void this.close()):void this.reconnect(n.action,dn.SERVER_ERROR);_.error("[".concat(this.clientId,"] ignore error: "),n.desc);}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;let e=v("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=e&&(_.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>v("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",dn.TIMEOUT):this.request(it.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;let i=Date.now()-n;this.rttRolling.add(i),v("REPORT_STATS")&&this.send(it.PING_BACK,{pingpongElapse:i});}).catch(i=>{});}handleWsInflateData(){let{wsInflateLength:e,wsDeflateLength:n}=this.websocket.getWsInflateData();e!==0&&n!==0&&this.upload(fs.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:n,ws_inflate_length:e});}handleWebsocketEvents(){this.websocket.on(dt.RECONNECT_WAITTING_FINISH,e=>{this.emit(Q.WS_RECONNECT_WAITTING_FINISH,e);}),this.websocket.on(dt.RECONNECT_CREATE_CONNECTION,e=>{this.emit(Q.WS_RECONNECT_CREATE_CONNECTION,e);}),this.websocket.on(dt.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(dt.CLOSED,()=>{this.connectionState=vt.CLOSED;}),this.websocket.on(dt.FAILED,()=>{this._disconnectedReason=It.NETWORK_ERROR,this.connectionState=vt.CLOSED;}),this.websocket.on(dt.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===vt.CONNECTED?this.connectionState=vt.RECONNECTING:this.connectionState=vt.CONNECTING;}),this.websocket.on(dt.WILL_RECONNECT,(e,n,i)=>{let r=hs(this,Q.IS_P2P_DISCONNECTED),o=r||e!=="retry";r&&e==="retry"&&(_.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),e="tryNext",n=Hc.P2P_DISCONNECTED),o&&(_.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(e)),this.emit(Q.REPORT_JOIN_GATEWAY,n||Hc.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(Q.NEED_RENEW_SESSION,this.websocket.currentURLIndex>=this.websocket.urls.length-1?"recover":e),this.emit(Q.DISCONNECT_P2P)),i(e);}),this.websocket.on(dt.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(e=>{_.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",dn.SERVER_ERROR);}):this.join().catch(e=>{if(this.emit(Q.REPORT_JOIN_GATEWAY,e.message||e.code||Hc.UNKNOWN_REASON,this.url||""),e instanceof w){if(e.code===R.UNEXPECTED_RESPONSE&&e.data.code===ot.ERR_NO_AUTHORIZED)return this.initError=new w(R.CAN_NOT_GET_GATEWAY_SERVER,"AgoraRTCError CAN_NOT_GET_GATEWAY_SERVER: dynamic key expired"),_.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",dn.SERVER_ERROR);_.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",dn.SERVER_ERROR):(this.initError=e,this.close());}});}),this.websocket.on(dt.REQUEST_NEW_URLS,(e,n)=>{Me(this,Q.REQUEST_RECOVER,this.multiIpOption).then(e).catch(n);}),this.websocket.on(dt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(_t.ON_TOKEN_PRIVILEGE_DID_EXPIRE);});}}let De=function(t){return t[t.CHOOSE_SERVER=11]="CHOOSE_SERVER",t[t.CLOUD_PROXY=18]="CLOUD_PROXY",t[t.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",t[t.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK",t}({});function jI(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function au(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?jI(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):jI(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}function Do(t){return t.match(/^[\.\:\d]+$/)?"".concat(t.replace(/[^\d]/g,"-"),".").concat(v("TURN_DOMAIN")):(_.info("Unidentified as ip: ".concat(t,", use as host")),t)}function wm(t,e){t.addresses||(t.addresses=[]);let n=function(o,s){if(v("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return o.map(d=>{let{ip:l,port:u}=d;return {address:"".concat(l,":").concat(u)}});let a=v("GATEWAY_DOMAINS"),c=a[1]&&q(s).call(s,a[1])?1:0;return o.map(d=>{let{domain_prefix:l,port:u,ip:h}=d;if(l)return {address:"".concat(l,".").concat(a[c++%a.length],":").concat(u)};let p=/^[\.\:\d]+$/.test(h),T=p?"".concat(h.replace(/[^\d]/g,"-"),".").concat(a[c++%a.length],":").concat(u):"".concat(h,":").concat(u);return p||_.info("Unidentified as ip: ".concat(h,", use as host")),{ip:h,port:u,address:T}})}(t.addresses,e),i=Array.isArray(t.detail)&&t.detail[18];if(i&&typeof i=="string"){let o=i.split(";");for(let s=0;s<o.length;s++){var r;let a=vn(r=o[s]).call(r);n[s]&&a&&(n[s].ip6=a);}}return {gatewayAddrs:n,uid:t.uid,cid:t.cid,cert:t.cert,vid:t.detail&&t.detail[8],uni_lbs_ip:t.detail&&t.detail[1],res:t,csIp:t.detail&&t.detail[502]}}function Wn(t){return typeof t=="number"?t:t.exact||t.ideal||t.max||t.min||0}function GI(t){let e=t._encoderConfig;if(!e)return {};let n={resolution:e.width&&e.height?"".concat(Wn(e.width),"x").concat(Wn(e.height)):void 0,maxVideoBW:e.bitrateMax,minVideoBW:e.bitrateMin};return typeof e.frameRate=="number"?(n.maxFrameRate=e.frameRate,n.minFrameRate=e.frameRate):e.frameRate&&(n.maxFrameRate=e.frameRate.max||e.frameRate.ideal||e.frameRate.exact||e.frameRate.min,n.minFrameRate=e.frameRate.min||e.frameRate.ideal||e.frameRate.exact||e.frameRate.max),n}function WI(t){return t>=0&&t<.17?1:t>=.17&&t<.36?2:t>=.36&&t<.59?3:t>=.59&&t<=1?4:t>1?5:0}function qc(t,e){let n,i,r;switch(e){case De.CHOOSE_SERVER:i=4096,r="choose server";break;case De.CLOUD_PROXY:i=1048576,r="proxy";break;case De.CLOUD_PROXY_5:i=4194304,r="proxy5";break;case De.CLOUD_PROXY_FALLBACK:i=4194310,r="proxy fallback";break;default:throw new w(R.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:t.detail&&t.detail[502],retry:!1})}if(t.response_body.forEach(o=>{o.buffer&&o.buffer.flag===i&&(n={code:o.buffer.code,addresses:(o.buffer.edges_services||[]).map(s=>au(au({},s),{},{ticket:o.buffer.cert})),server_ts:t.enter_ts,uid:o.buffer.uid,cid:o.buffer.cid,cname:o.buffer.cname,detail:au(au({},o.buffer.detail),t.detail),flag:o.buffer.flag,opid:t.opid,cert:o.buffer.cert});}),!n)throw new w(R.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(r," from multi unilbs response"),{csIp:t.detail&&t.detail[502]});return n}async function HI(t,e){return await K.all(t.addresses.map(async n=>({address:Do(n.ip),tcpport:n.port,udpport:n.port,username:e&&v("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?e.toString():ln.username,password:e&&v("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await cm(e.toString()):ln.password})))}function Om(t,e){let n=e.getMediaStreamTrack(!0).getSettings(),i=e.videoHeight||n.height,r=e.videoWidth||n.width;return i&&r?Math.max(Math.min(i,r)/Math.min(Wn(t.height),Wn(t.width)),1):(_.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function Po(t){let{candidateType:e,relayProtocol:n,type:i,address:r,port:o,protocol:s}=t;return i==="local-candidate"?{candidateType:e,relayProtocol:n,protocol:s}:{candidateType:e,relayProtocol:n,address:r,port:o,protocol:s}}function KI(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}class Gj extends de{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var n;q(n=["tryNext","recover"]).call(n,e)&&this.resetReconnectCount(e),this._reconnectMode=e;}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._state==="reconnecting"?this.emit(Ue.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(Ue.CONNECTED):this._state==="closed"?this.emit(Ue.CLOSED):this._state==="failed"&&this.emit(Ue.FAILED));}constructor(e,n,i,r){super(),g(this,"connectionID",0),g(this,"currentURLIndex",0),g(this,"reconnectReason",void 0),g(this,"_reconnectMode","tryNext"),g(this,"_initMutex",void 0),g(this,"_name",void 0),g(this,"_state","closed"),g(this,"_reconnectInterrupter",void 0),g(this,"_url",void 0),g(this,"_retryConfig",void 0),g(this,"_reconnectCount",0),g(this,"_forceCloseTimeout",5e3),g(this,"_onlineReconnectListener",void 0),g(this,"_closeEstablishingTransmitter",()=>{}),g(this,"_store",void 0),g(this,"_joinChannelServiceRecordIndex",void 0),g(this,"_transmitter",void 0),g(this,"_useCompress",void 0),g(this,"_inflateLength",0),g(this,"_deflateLength",0),this._store=r,this._name=e,this._retryConfig=function(o){for(var s=1;s<arguments.length;s++){var a=arguments[s]!=null?arguments[s]:{};s%2?KI(Object(a),!0).forEach(function(c){g(o,c,a[c]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(a)):KI(Object(a)).forEach(function(c){Object.defineProperty(o,c,Object.getOwnPropertyDescriptor(a,c));});}return o}({},n),this._useCompress=i;}resetReconnectCount(e){_.debug("".concat(this._name," reset reconnect count, reason: ").concat(e)),this._reconnectCount=0;}close(e,n){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;let i=this._transmitter;n?setTimeout(()=>i.close(),500):i.close(),this._transmitter=void 0;}this.state=e?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter();}reconnect(e,n){if(!this._transmitter)return void _.warning("[".concat(this._name,"] can not reconnect, no websocket"));var i;e!==void 0&&(this.reconnectMode=e),_.debug("[".concat(this._name,"] reconnect is triggered initiative")),typeof this._joinChannelServiceRecordIndex=="number"&&((i=this._store)===null||i===void 0||i.recordJoinChannelService({status:"error",errors:[new Error(n)]},this._joinChannelServiceRecordIndex));let r=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),r&&r.bind(this._transmitter)({code:9999,reason:n});}getInflateData(){let e=this._inflateLength,n=this._deflateLength;return this.clearInflateData(),{inflateLength:e,deflateLength:n}}setInflateData(e){this._deflateLength=this._deflateLength+e.originLength,this._inflateLength=this._inflateLength+e.compressedLength;}clearInflateData(){this._inflateLength=0,this._deflateLength=0;}}let lr=function(t){return t[t.Default=0]="Default",t[t.Ack=1]="Ack",t}({});class Wj{constructor(e,n,i){g(this,"version",1),g(this,"initialRTO",void 0),g(this,"maxBatchAckCount",void 0),g(this,"maxRTO",void 0),g(this,"initialRTT",void 0),g(this,"ID",void 0),g(this,"rtt",void 0),g(this,"packetNumber",1),g(this,"rtoRatioMap",new Map),g(this,"timeoutMap",new Map),g(this,"unorderedPacketQueue",[]),g(this,"batchAckPacketQueue",[]),g(this,"lastOrderedPacketNumber",0),g(this,"batchAckTimer",void 0),g(this,"sendImpl",void 0),g(this,"receiveImpl",void 0),this.sendImpl=e,this.receiveImpl=n,this.ID=Zt(7,"transmitter-"),this.initialRTO=i?.initialRTO!==void 0?i.initialRTO:v("TRANSMITTER_INITIAL_RTO"),this.initialRTT=i?.initialRTT!==void 0?i.initialRTT:v("TRANSMITTER_INITIAL_RTT"),this.rtt=i?.initialRTT!==void 0?i.initialRTT:v("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=i?.maxBatchAckCount!==void 0?i.maxBatchAckCount:v("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=i?.maxRTO!==void 0?i.maxRTO:v("TRANSMITTER_MAX_RTO");}packetize(e,n){return {type:lr.Default,version:this.version,packetNumber:n,payload:e}}serialize(e){switch(e.type){case lr.Default:{let n;typeof e.payload=="string"?n=new TextEncoder().encode(e.payload):n=e.payload;let i=new ArrayBuffer(n.length+15),r=new DataView(i);return r.setUint16(0,e.version),r.setUint8(2,e.type),r.setUint32(3,e.packetNumber),tI(r,7,BigInt(e.sendTs)),new Uint8Array(r.buffer).set(n,15),i}case lr.Ack:{let n=new ArrayBuffer(16),i=new DataView(n);return i.setUint16(0,e.version),i.setUint8(2,e.type),i.setUint32(3,e.maxAckPacketNumber),i.setUint8(7,e.shift),tI(i,8,BigInt(e.ackSendTs)),n}}}deserialize(e){let n=new DataView(e),i=n.getUint16(0),r=n.getUint8(2);switch(r){case lr.Default:{let o=n.getUint32(3),s=$v(n,7),a=e.slice(15),c=new TextDecoder().decode(a);return {version:i,type:r,packetNumber:o,sendTs:Number(s),payload:c}}case lr.Ack:{let o=n.getUint32(3),s=n.getUint8(7),a=$v(n,8);return {version:i,type:r,maxAckPacketNumber:o,shift:s,ackSendTs:Number(a)}}default:throw _.error("[".concat(this.ID,"] Unrecognized packet type ").concat(r)),new Error("Unrecognized packet type ".concat(r))}}sendMessage(e){let n=this.packetize(e,this.packetNumber);this.packetNumber=this.packetNumber===4294967295?1:this.packetNumber+1;let i=this.calculateRTO(n),r=window.setTimeout(()=>{this.resendMessage(n);},i);this.timeoutMap.set(n.packetNumber,r),this.sendPacket(n);}onData(e){let n=this.deserialize(e);n.type===lr.Default?this.ack(n):n.type===lr.Ack&&(this.updateRTT(n,Math.round(performance.now())),this.clearRTO(n));}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach(e=>{let[n,i]=e;window.clearTimeout(i);}),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer!==void 0&&window.clearTimeout(this.batchAckTimer);}resendMessage(e){let n=this.calculateRTO(e),i=window.setTimeout(()=>{this.resendMessage(e);},n);this.timeoutMap.set(e.packetNumber,i),this.sendPacket(e);}calculateRTO(e){let n=this.rtoRatioMap.get(e.packetNumber);if(n===void 0)return this.rtoRatioMap.set(e.packetNumber,1),this.initialRTO;{let i=9*this.rtt/8*n;return this.rtoRatioMap.set(e.packetNumber,n+1),i>this.maxRTO?this.maxRTO:i}}updateRTT(e,n){let i=e.ackSendTs;this.rtt=this.rtt*(7/8)+(n-i-this.rtt)/8;}ack(e){if(e.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(e):(this.batchAckPacketQueue.push(e),this.batchAckTimer=window.setTimeout(()=>{this.batchAck();},this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(e.payload);;){let n=this.unorderedPacketQueue[0];if(!n){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(n.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1;}else if(e.packetNumber<=this.lastOrderedPacketNumber){let n={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:lr.Ack,version:this.version};this.sendPacket(n);}else if(e.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[e.packetNumber-this.lastOrderedPacketNumber-2]=e;let n={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:lr.Ack,version:this.version};this.sendPacket(n);}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;let e={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:lr.Ack,version:this.version};this.sendPacket(e),this.batchAckPacketQueue=[];}sendPacket(e){e.type===lr.Default&&(e.sendTs=Math.round(performance.now()));let n=this.serialize(e);this.sendImpl(n);}clearRTO(e){for(let n=e.maxAckPacketNumber-e.shift;n<=e.maxAckPacketNumber;n++){let i=this.timeoutMap.get(n);i!==void 0&&window.clearTimeout(i),this.timeoutMap.delete(n),this.rtoRatioMap.delete(n);}}}class YI extends Gj{constructor(e,n){super(e,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3?arguments[3]:void 0),g(this,"_initMutex",void 0),g(this,"_reconnectInterrupter",void 0),g(this,"_url",void 0),g(this,"_transmitter",void 0),g(this,"_addresses",void 0),g(this,"_reliableTransmission",void 0),this._initMutex=new Qe("datachannel");let{timeout:i,timeoutFactor:r}=n,o=Math.max(300,Math.floor(3*i/5)),s=Math.max(1.2,Math.floor(8*r)/10);On.ONLINE&&(this._retryConfig.timeout=o,this._retryConfig.timeoutFactor=s),Te.on(us.NETWORK_STATE_CHANGE,(a,c)=>{a!==c&&(this.resetReconnectCount("network state change: ".concat(c," -> ").concat(a)),a===On.ONLINE?(this._retryConfig.timeout=o,this._retryConfig.timeoutFactor=s):(this._retryConfig.timeout=i,this._retryConfig.timeoutFactor=r));});}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;this._forceCloseTimeout=n;let i=(r,o)=>{this._addresses=e,this.currentURLIndex=this._addresses.findIndex(a=>a.fingerprint||v("FINGERPRINT"));let s=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(s).then(r).catch(o),this.once(Ue.CLOSED,()=>o(new w(R.WS_DISCONNECT))),this.once(Ue.CONNECTED,()=>r());};return this._initMutex.lock().then(r=>new K((o,s)=>{i(o,s);}).then(()=>{r();}).catch(()=>{r();}))}sendMessage(e){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new w(R.WS_ABORT,"datachannel is not ready");try{n||(e=JSON.stringify(e)),this._reliableTransmission.sendMessage(e);}catch(i){throw new w(R.WS_ERR,"send datachannel signal message error"+i.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null);}sendMessageWithJSON(e){let n=JSON.stringify(e);return {compressed:n,compressedLength:n.length,origin:e}}sendMessageWithUint8Array(e){return {compressed:e,compressedLength:e.byteLength,origin:e}}createTransmitterConnection(e){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(e.ip,":").concat(e.port),new K((n,i)=>{var r;let o=()=>{_.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),n();},s=async l=>{var u;if((u=this._closeEstablishingTransmitter)===null||u===void 0||u.call(this),_.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(l.code,", reason: ").concat(l.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){this.state==="connected"&&(this.reconnectReason=l.reason,this.state="reconnecting");let h=Qn(this,Ue.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,p=await this.reconnectWithAction(h);if(this.state==="closed")return void _.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!p)return i(new w(R.WS_DISCONNECT,"datachannel reconnect failed: ".concat(l.code))),void this.close(!0);n();}else i(new w(R.WS_DISCONNECT,"datachannel close: ".concat(l.code))),this.close();},a=l=>{var u;(u=this._reliableTransmission)===null||u===void 0||u.onData(l.data);};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),_.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(e)));let c=(r=this._store)===null||r===void 0?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),d=Date.now();Me(this,Ue.TO_CONNECT_DATACHANNEL,e).then(l=>{var u,h;if(!l)throw new Error("transmissonInfo not exist yet");let{transmitter:p,close:T}=l;this._transmitter=p,(u=this._store)===null||u===void 0||u.signalChannelOpen();let m=Date.now()-d;_.debug("[choose dc] dc open cost ".concat(m,"ms")),this._reliableTransmission=new Wj(E=>{var S;this._transmitter&&this._transmitter.readyState==="open"&&((S=this._transmitter)===null||S===void 0||S.send(E));},E=>{typeof E=="string"&&this.emit(Ue.ON_MESSAGE,E);}),this._closeEstablishingTransmitter=()=>{var E;(E=this._reliableTransmission)===null||E===void 0||E.close(),this._reliableTransmission=void 0,T();},o&&o(),p.onclose=s,p.onmessage=a,(h=this._store)===null||h===void 0||h.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this._joinChannelServiceRecordIndex=c;}).catch(l=>{var u;if((u=this._store)===null||u===void 0||u.recordJoinChannelService({endTs:Date.now(),status:l instanceof w&&l.code===R.WS_ABORT?"aborted":"error",errors:[l]},c),this.state!=="closed"){if(l instanceof w&&l.code===R.WS_ERR){let h=new w(R.WS_ERR,"init datachannel failed! Error: ".concat(l.toString()));return _.error("[".concat(this._name,"]").concat(h)),void i(h)}s&&s(l);}else i(new w(R.WS_DISCONNECT,"datachannel is closed: ".concat(l.toString())));});})}async reconnectWithAction(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount||!this._addresses||this.state==="closed")return !1;this._onlineReconnectListener||Te.networkState!==On.OFFLINE||(this._onlineReconnectListener=Te.onlineWaiter&&Te.onlineWaiter.then(()=>{this._onlineReconnectListener=void 0;}));let i=!0;if(this._reconnectInterrupter=()=>{i=!1;},n){let a=Ql(this._reconnectCount,this._retryConfig);_.debug("[".concat(this._name,"] wait ").concat(a,"ms to reconnect datachannel, mode: ").concat(e)),await K.race([Ye(a),this._onlineReconnectListener||new K(()=>{})]);}if(this.state==="closed"||!i)return !1;this._reconnectCount+=1;let r=async(a,c)=>{this.emit(Ue.RECONNECT_CREATE_CONNECTION,c),await this.createTransmitterConnection(a);};try{if(e==="retry"){let a=this._addresses[this.currentURLIndex];this.emit(Ue.RECONNECT_WAITTING_FINISH,e),await r(a,e);}else if(e==="tryNext"){this.currentURLIndex+=1;for(let c=this.currentURLIndex;c<this._addresses.length;c++){if(this._addresses[c].fingerprint||v("FINGERPRINT")){this.currentURLIndex=c;break}this.currentURLIndex+=1;}if(this.currentURLIndex>=this._addresses.length)return _.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);_.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));let a=this._addresses[this.currentURLIndex];this.emit(Ue.RECONNECT_WAITTING_FINISH,e),await r(a,e);}else e==="recover"&&(_.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(Ue.RECONNECT_WAITTING_FINISH,e),this.emit(Ue.FAILBACK));return !0}catch(a){var o,s;return _.error("[".concat(this._name,"] reconnect failed"),a.toString()),a!=null&&(o=a.data)!==null&&o!==void 0&&o.desc&&Array.isArray(a.data.desc)&&a.data.desc.length&&q(s=a.data.desc).call(s,"dynamic key expired")?(this.emit(Ue.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(e,n)}}}class to extends de{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===vt.CONNECTED?this.emit(Q.WS_CONNECTED):e===vt.RECONNECTING?this.emit(Q.WS_RECONNECTING,this._websocketReconnectReason):e===vt.CLOSED&&this.emit(Q.WS_CLOSED,this._disconnectedReason));}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(e,n){super(),g(this,"_disconnectedReason",void 0),g(this,"_websocketReconnectReason",void 0),g(this,"_connectionState",vt.CLOSED),g(this,"reconnectToken",void 0),g(this,"websocket",void 0),g(this,"openConnectionTime",void 0),g(this,"clientId",void 0),g(this,"lastMsgTime",Date.now()),g(this,"uploadCache",[]),g(this,"uploadCacheInterval",void 0),g(this,"rttRolling",new um(5)),g(this,"pingpongTimer",void 0),g(this,"inflateDataTimer",void 0),g(this,"pingpongTimeoutCount",0),g(this,"joinResponse",void 0),g(this,"multiIpOption",void 0),g(this,"initError",void 0),g(this,"spec",void 0),g(this,"store",void 0),g(this,"onWebsocketMessage",i=>{if(i instanceof ArrayBuffer)return void this.emit(Q.ON_BINARY_DATA,i);let r=JSON.parse(i);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){let o="res-@".concat(r._id);this.emit(o,r._result,r._message);}else if(Object.prototype.hasOwnProperty.call(r,"_type")&&(this.emit(r._type,r._message),r._type===_t.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===_t.ON_USER_BANNED))switch(r._message.error_code){case 14:this.close(It.UID_BANNED);break;case 15:this.close(It.IP_BANNED);break;case 16:this.close(It.CHANNEL_BANNED);}}),this.clientId=e.clientId,this.spec=e,this.store=n,this.websocket=new YI("gateway-".concat(this.clientId),this.spec.retryConfig,!0,n),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===vt.CONNECTED&&this.reconnect("retry",Oo.OFFLINE);});}async request(e,n,i,r){let o=Zt(6,""),s={_id:o,_type:e,_message:n},a=this.websocket.connectionID,c=()=>new K((T,m)=>{if(this.connectionState===vt.CONNECTED)return T();let E=()=>{this.off(Q.WS_CLOSED,S),T();},S=()=>{this.off(Q.WS_CONNECTED,E),m(new w(R.WS_ABORT));};this.once(Q.WS_CONNECTED,E),this.once(Q.WS_CLOSED,S),e!==it.PUBLISH&&e!==it.SUBSCRIBE&&e!==it.UNSUBSCRIBE&&e!==it.UNPUBLISH&&e!==it.CONTROL&&e!==it.RESTART_ICE||this.once(Q.DISCONNECT_P2P,()=>{m(new w(R.DISCONNECT_P2P));}),e!==it.PUBLISH&&e!==it.RESTART_ICE||this.once(Q.ABORT_P2P_EXECUTION,()=>{m(new w(R.DISCONNECT_P2P));});});if(this.connectionState!==vt.CONNECTING&&this.connectionState!==vt.RECONNECTING||e===it.JOIN||e===it.REJOIN||await c(),e===it.LEAVE&&(this.websocket.unbindDcCloseEventListener(),r=!0),this.websocket.sendMessage(s,!0,!1),r)return;let d=new K((T,m)=>{let E=!1,S=(A,b)=>{E=!0,T({isSuccess:A==="success",message:b||{}}),this.off(Q.WS_CLOSED,C),this.off(Q.WS_RECONNECTING,C),this.emit(Q.REQUEST_SUCCESS,e,n);};this.once("res-@".concat(o),S);let C=()=>{m(new w(R.WS_ABORT,"type: ".concat(e))),this.off(Q.WS_CLOSED,C),this.off(Q.WS_RECONNECTING,C),this.off("res-@".concat(o),S);};this.once(Q.WS_CLOSED,C),this.once(Q.WS_RECONNECTING,C),Ye(v("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||E||(_.warning("dc request timeout, type: ".concat(e)),this.emit(Q.REQUEST_TIMEOUT,e,n));});}),l=null;try{l=await d;}catch(T){if(this.connectionState===vt.CLOSED||e===it.LEAVE)throw new w(R.WS_ABORT);return !this.spec.forceWaitGatewayResponse||i?T.throw():e===it.JOIN||e===it.REJOIN?null:(await c(),await this.request(e,n))}if(l.isSuccess)return l.message;let u=Number(l.message.error_code||l.message.code),h=gs(u),p=new w(R.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(l.message.error_str),{code:u,data:l.message});return h.action==="success"?l.message:(_.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(u,", message: ").concat(h.desc,", action: ").concat(h.action)),u===ot.ERR_TOO_MANY_BROADCASTERS?((e===it.JOIN||e===it.REJOIN)&&(this.initError=p,this.close()),p.throw()):h.action==="failed"?p.throw():h.action==="quit"?(this.initError=p,this.close(),p.throw()):(u===ot.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,_.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Oo.MULTI_IP)):this.reconnect(h.action,Oo.SERVER_ERROR),e===it.JOIN||e===it.REJOIN?null:await this.request(e,n)))}waitMessage(e,n){return new K(i=>{let r=o=>{(!n||n(o))&&(this.off(e,r),i(o));};this.on(e,r);})}uploadWRTCStats(e){if(!this.store.sessionId)return void _.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));let n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(fs.WRTC_STATS,n);}upload(e,n){let i={_type:e,_message:n};try{this.websocket.sendMessage(i);}catch{let o=v("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>o&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==vt.CONNECTED)return;let s=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(s._type,s._message);},v("UPLOAD_CACHE_INTERVAL")||2e3));}}send(e,n){let i={_type:e,_message:n};this.websocket.sendMessage(i);}init(e,n){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new K((i,r)=>{this.once(Q.WS_CONNECTED,()=>i(this.joinResponse)),this.once(Q.WS_CLOSED,()=>r(this.initError||new w(R.WS_ABORT))),this.connectionState=vt.CONNECTING,this.websocket.init(e).catch(r),this.websocket.once(Ue.FAILBACK,()=>{this.openConnectionTime===void 0&&r(new w(R.INIT_DATACHANNEL_TIMEOUT));}),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval(()=>{this.handleInflateData();},2e4),setTimeout(()=>{n&&this.openConnectionTime===void 0&&(_.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),r(new w(R.INIT_DATACHANNEL_TIMEOUT)));},v("DC_JOIN_WITH_FAILBACK"));})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||It.LEAVE,this.connectionState=vt.CLOSED,_.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),e===It.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new YI("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents());}async join(){if(!this.joinResponse){this.emit(Q.ABORT_P2P_EXECUTION);let e=await Me(this,Q.DATACHANNEL_CONNECTING),n=await this.request(it.JOIN,e);if(!n)return this.emit(Q.REPORT_JOIN_GATEWAY,R.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(Q.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token;}return this.connectionState=vt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new w(R.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");let e=hs(this,Q.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;let n=await this.request(it.REJOIN,e);return !!n&&(this.connectionState=vt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),n.peers&&n.peers.forEach(i=>{this.emit(_t.ON_USER_ONLINE,{uid:i.uid}),i.audio&&this.emit(_t.ON_ADD_AUDIO_STREAM,{uid:i.uid,uint_id:i.uint_id,audio:!0,ssrcId:i.audio_ssrc}),i.video&&this.emit(_t.ON_ADD_VIDEO_STREAM,{uid:i.uid,uint_id:i.uint_id,video:!0,ssrcId:i.video_ssrc}),i.audio_mute?this.emit(_t.MUTE_AUDIO,{uid:i.uid}):this.emit(_t.UNMUTE_AUDIO,{uid:i.uid}),i.video_mute?this.emit(_t.MUTE_VIDEO,{uid:i.uid}):this.emit(_t.UNMUTE_VIDEO,{uid:i.uid}),i.audio_enable_local?this.emit(_t.ENABLE_LOCAL_AUDIO,{uid:i.uid}):this.emit(_t.DISABLE_LOCAL_AUDIO,{uid:i.uid}),i.video_enable_local?this.emit(_t.ENABLE_LOCAL_VIDEO,{uid:i.uid}):this.emit(_t.DISABLE_LOCAL_VIDEO,{uid:i.uid}),i.audio||i.video||this.emit(_t.ON_REMOVE_STREAM,{uid:i.uid,uint_id:i.uint_id});}),!0)}reconnect(e,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,n);}handleNotification(e){_.debug("[".concat(this.clientId,"] receive notification: "),e);let n=gs(e.code);if(n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(It.UID_BANNED),void this.close()):void this.reconnect(n.action,Oo.SERVER_ERROR);_.error("[".concat(this.clientId,"] ignore error: "),n.desc);}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;let e=v("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=e&&(_.warning("PINGPONG Timeout. Last Socket Message: ".concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>v("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Oo.TIMEOUT):this.request(it.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;let i=Date.now()-n;this.rttRolling.add(i),v("REPORT_STATS")&&this.send(it.PING_BACK,{pingpongElapse:i});}).catch(i=>{});}handleInflateData(){let{inflateLength:e,deflateLength:n}=this.websocket.getInflateData();e!==0&&n!==0&&this.upload(fs.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:n,ws_inflate_length:e});}handleWebsocketEvents(){this.websocket.on(Ue.RECONNECT_WAITTING_FINISH,e=>{this.emit(Q.WS_RECONNECT_WAITTING_FINISH,e);}),this.websocket.on(Ue.RECONNECT_CREATE_CONNECTION,e=>{this.emit(Q.WS_RECONNECT_CREATE_CONNECTION,e);}),this.websocket.on(Ue.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Ue.CLOSED,()=>{this.connectionState=vt.CLOSED;}),this.websocket.on(Ue.FAILED,()=>{this._disconnectedReason=It.NETWORK_ERROR,this.connectionState=vt.CLOSED;}),this.websocket.on(Ue.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===vt.CONNECTED?this.connectionState=vt.RECONNECTING:this.connectionState=vt.CONNECTING;}),this.websocket.on(Ue.WILL_RECONNECT,(e,n)=>{if(hs(this,Q.IS_P2P_DISCONNECTED)&&e==="retry")return _.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(Q.NEED_RENEW_SESSION),this.emit(Q.DISCONNECT_P2P),n("tryNext");e!=="retry"&&(_.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(Q.NEED_RENEW_SESSION),this.emit(Q.DISCONNECT_P2P)),n(e);}),this.websocket.on(Ue.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(e=>{_.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",Oo.SERVER_ERROR);}):this.join().catch(e=>{if(this.emit(Q.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof w&&e.code===R.UNEXPECTED_RESPONSE&&e.data.code===ot.ERR_NO_AUTHORIZED)return _.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Oo.SERVER_ERROR);_.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Oo.SERVER_ERROR):(this.initError=e,this.close());});}),this.websocket.on(Ue.REQUEST_NEW_URLS,(e,n)=>{Me(this,Q.REQUEST_RECOVER,this.multiIpOption).then(e).catch(n);}),this.websocket.on(Ue.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(_t.ON_TOKEN_PRIVILEGE_DID_EXPIRE);}),this.websocket.on(Ue.TO_CONNECT_DATACHANNEL,async(e,n,i)=>Me(this,Q.DATACHANNEL_PRECONNECT,e).then(n).catch(i)),this.websocket.on(Ue.FAILBACK,()=>{this.openConnectionTime!==void 0&&this.emit(Q.DATACHANNEL_FAILBACK);});}}class Ts extends de{constructor(e,n){super(),g(this,"signal",void 0),g(this,"token",void 0),g(this,"tokenTimeout",void 0),g(this,"tokenInterval",void 0),g(this,"_sequence",0),g(this,"userMap",new Map),g(this,"encoder",new TextEncoder),this.signal=e,this.token=n;let i=()=>{this.signal.connectionState===vt.CONNECTED&&this.check(),this.userMap.size===0?this.tokenInterval=window.setTimeout(i,1e3):this.tokenInterval=window.setTimeout(i,3*v("P2P_TOKEN_INTERVAL"));};i();}async send(e,n,i,r,o){var s,a,c;if(this.userMap.size===0)return;let d=Array.from(cr(s=this.userMap).call(s))[0].token;typeof n!="string"&&(n=JSON.stringify(n)),r=(a=r)!==null&&a!==void 0?a:Zt(6,""),o=(c=o)!==null&&c!==void 0?c:this._sequence++;let l={_id:r,_type:e,_seq:o,_message:n,token:"".concat(this.token,"_").concat(d)};v("SHOW_P2P_LOG")&&_.debug("send message",l,"noNeedResponse : ".concat(i)),this.splitMessage(JSON.stringify(l)).forEach(h=>{this.signal.request(it.DATA_STREAM,{payload:Ao(this.encoder.encode(h))});});let u=new K((h,p)=>{let T=window.setTimeout(()=>{this.off("res-@".concat(r,"_ack"),m),this.off("res-@".concat(r),S),this.off(Ca.ABORT,E),_.debug("[external-signal] request timeout, type: ".concat(e,", requestId: ").concat(r)),this.userMap.size===0?p(new D(R.INVALID_REMOTE_USER)):p(new D(R.TIMEOUT));},v("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),m=()=>{T&&window.clearTimeout(T),this.off(Ca.ABORT,E),i&&h();},E=()=>{T&&window.clearTimeout(T),this.off("res-@".concat(r,"_ack"),m),this.off("res-@".concat(r),S),p(new D(R.EXTERNAL_SIGNAL_ABORT,"type: ".concat(e,", requestId: ").concat(r)));};this.once(Ca.ABORT,E),this.once("res-@".concat(r,"_ack"),m);let S=(A,b)=>{C=!0,T&&window.clearTimeout(T),this.off("res-@".concat(r,"_ack"),m),this.off(Ca.ABORT,E),A==="success"?h(b):p(new D(R.P2P_MESSAGE_FAILED,"request ".concat(e," failed, requestId: ").concat(r)));},C=!1;i||(this.once("res-@".concat(r),S),Ye(v("SIGNAL_REQUEST_TIMEOUT")).then(()=>{C||_.warning("external_signal request timeout, type: ".concat(e,", requestId: ").concat(r,", ").concat(l));}));});try{return await u}catch(h){if(h.code===R.TIMEOUT)return await this.send(e,n,i,r,o);throw h}}onMessage(e){var n;let{_uid:i}=e,r,o=this.userMap.get(i);if(o)r=o.splitMessageMap;else {if(this.userMap.size>0||!("_type"in e)||e._type!==ye.CHECK)return;let{token:d}=e;r=new Map,o={uid:i,isStart:!0,token:d,splitMessageMap:r,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(i,o),this.signal.emit(_t.ON_USER_ONLINE,{uid:i}),this.handleUserOnline();}if("id"in e&&"total"in e){var s;let{id:d,total:l}=e,u=(s=r.get(d))!==null&&s!==void 0?s:[];if(u.push(e),r.has(d)||r.set(d,u),u.length!==l)return;{let h=vc(u).call(u,(p,T)=>p.index-T.index).map(p=>p.payload).join("");r.delete(d),(e=JSON.parse(h))._uid=i;}}let{_type:a,token:c}=e;if(q(n=[ye.ACK,ye.CHECK]).call(n,a))return a===ye.CHECK&&this.handleCheckToken(o,c),void this.receiveMessage(e);c==="".concat(o.token,"_").concat(this.token)?this.handleReceivedMessage(e):_.debug('Receive unexpected message", '.concat(c,", cur_token: ").concat(o.token,"_").concat(this.token),e);}check(){let e={_id:Zt(6,""),token:this.token,_type:ye.CHECK};v("SHOW_P2P_LOG")&&_.debug("send message",e),this.signal.request(it.DATA_STREAM,{payload:Ao(this.encoder.encode(JSON.stringify(e)))});}ack(e){let n={_id:e,_type:ye.ACK,token:this.token};v("SHOW_P2P_LOG")&&_.debug("send message",n),this.signal.request(it.DATA_STREAM,{payload:Ao(this.encoder.encode(JSON.stringify(n)))});}response(e,n,i){this.send(ye.RESPONSE,JSON.stringify({success:!i,message:n}),!0,e);}handleReceivedMessage(e){let n=()=>{this.userMap.forEach(d=>{let{receivedMessagesMap:l,nextExpectedSequenceNumber:u}=d;for(;l.has(u);){let h=l.get(u);l.delete(u),this.receiveMessage(h),d.nextExpectedSequenceNumber++;}});};if(!e)return void n();let{_uid:i,_seq:r}=e,o=this.userMap.get(i),{receivedMessagesMap:s,isStart:a,nextExpectedSequenceNumber:c}=o;if(r<c)return this.ack(e._id),void _.debug("[external-signal] receive old message, seq: ".concat(r,", ").concat(e._message));s.set(r,e),a&&r===c&&(this.receiveMessage(e),s.delete(c),o.nextExpectedSequenceNumber++,n());}receiveMessage(e){let{_id:n,_type:i,_message:r,_uid:o}=e;if(v("SHOW_P2P_LOG")&&_.debug("receive message",e),n){let s;switch(e._type!==ye.ACK&&(r&&(s=JSON.parse(r)),this.ack(e._id)),e._type){case ye.CANDIDATE:case ye.CONTROL:this.signal.emit(i,s,o);break;case ye.PUBLISH:case ye.UNPUBLISH:case ye.RESTART_ICE:case ye.CALL:s.uid=o,Me(this.signal,i,s).then(a=>{this.response(e._id,a);}).catch(()=>{this.response(e._id,void 0,!0);});break;case ye.ACK:this.getListeners("res-@".concat(n,"_ack")).length>0&&this.emit("res-@".concat(n,"_ack"));break;case ye.RESPONSE:{let{success:a,message:c}=s;this.emit("res-@".concat(n),a?"success":"failed",c);break}}}}splitMessage(e){if(e.length<Ts.MAX_MESSAGE_SIZE)return [e];let n=[],{remoteToken:i}=JSON.parse(e),r=Zt(6,""),o=0,s=800,a=Math.ceil(e.length/s);for(;e.length>0;){o++;let c={id:r,index:o,total:a,payload:e.slice(0,s),token:"".concat(this.token,"_").concat(i)};JSON.stringify(c).length>Ts.MAX_MESSAGE_SIZE?s-=50:(n.push(c),e=e.slice(s));}return n.map(c=>JSON.stringify(c))}handleCheckToken(e,n){return e.token!==n?(_.debug("token changed, from ".concat(e.token," to ").concat(n)),this.reset(e.uid,n),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout(()=>{_.debug("token timeout, ".concat(n)),this.reset(e.uid);},v("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){let e=await Me(this.signal,ye.CALL,void 0),n=await this.send(ye.CALL,e);this.signal.emit(Q.P2P_CONNECTION,n,!0);}async reset(e,n){let i=this.userMap.get(e);i&&(this.emit(Ca.ABORT),this.signal.emit(_t.ON_USER_OFFLINE,{uid:i.uid,reason:Lj.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),n||(_.debug("change local token from ".concat(n," to ").concat(n)),this.token=Zt(6,"")));}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(Ca.ABORT);}}g(Ts,"MAX_SIZE",1),g(Ts,"MAX_MESSAGE_SIZE",1024);class qI extends de{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===vt.CONNECTED?this.emit(Q.WS_CONNECTED):e===vt.RECONNECTING?this.emit(Q.WS_RECONNECTING,this._websocketReconnectReason):e===vt.CLOSED&&this.emit(Q.WS_CLOSED,this._disconnectedReason));}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,n){super(),g(this,"_disconnectedReason",void 0),g(this,"_websocketReconnectReason",void 0),g(this,"_connectionState",vt.CLOSED),g(this,"reconnectToken",void 0),g(this,"p2pToken",void 0),g(this,"websocket",void 0),g(this,"openConnectionTime",void 0),g(this,"clientId",void 0),g(this,"lastMsgTime",Date.now()),g(this,"uploadCache",[]),g(this,"uploadCacheInterval",void 0),g(this,"rttRolling",new um(5)),g(this,"pingpongTimer",void 0),g(this,"pingpongTimeoutCount",0),g(this,"joinResponse",void 0),g(this,"multiIpOption",void 0),g(this,"initError",void 0),g(this,"spec",void 0),g(this,"store",void 0),g(this,"_external_signal",void 0),g(this,"onWebsocketMessage",i=>{if(i.data instanceof ArrayBuffer)return void this.emit(Q.ON_BINARY_DATA,i.data);let r=JSON.parse(i.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){let o="res-@".concat(r._id);this.emit(o,r._result,r._message);}else if(Object.prototype.hasOwnProperty.call(r,"_type")){switch(r._type){case _t.ON_DATA_STREAM:return void this.handleDataStream(r._message);case _t.MUTE_AUDIO:case _t.MUTE_VIDEO:case _t.ON_P2P_LOST:case _t.ON_USER_ONLINE:return;case _t.ON_USER_OFFLINE:let{uid:o}=r._message;return _.debug("[".concat(this.clientId,"] user-offline uid: ").concat(o)),void this._external_signal.reset(o)}if(this.emit(r._type,r._message),r._type===_t.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===_t.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(It.UID_BANNED);break;case 15:this.close(It.IP_BANNED);break;case 16:this.close(It.CHANNEL_BANNED);}if(r._type===_t.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case ot.ERR_LICENSE_MISSING:this.close(It.LICENSE_MISSING);break;case ot.ERR_LICENSE_EXPIRED:this.close(It.LICENSE_EXPIRED);break;case ot.ERR_LICENSE_MINUTES_EXCEEDED:this.close(It.LICENSE_MINUTES_EXCEEDED);break;case ot.ERR_LICENSE_PERIOD_INVALID:this.close(It.LICENSE_PERIOD_INVALID);break;case ot.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(It.LICENSE_MULTIPLE_SDK_SERVICE);break;case ot.ERR_LICENSE_ILLEGAL:this.close(It.LICENSE_ILLEGAL);break;default:this.close();}}}),this.clientId=e.clientId,this.spec=e,this.store=n,this.websocket=new Kc("gateway-".concat(this.clientId),this.spec.retryConfig,!0,v("JOIN_GATEWAY_USE_DUAL_DOMAIN"),v("JOIN_GATEWAY_USE_443PORT_ONLY"),n),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===vt.CONNECTED&&this.reconnect("retry",dn.OFFLINE);}),this.p2pToken=Zt(6,""),this._external_signal=new Ts(this,this.p2pToken);}async request(e,n,i,r){let o=Zt(6,""),s={_id:o,_type:e,_message:n},a=this.websocket.connectionID,c=()=>new K((T,m)=>{if(this.connectionState===vt.CONNECTED)return T();let E=()=>{this.off(Q.WS_CLOSED,S),T();},S=()=>{this.off(Q.WS_CONNECTED,E),m(new D(R.WS_ABORT));};this.once(Q.WS_CONNECTED,E),this.once(Q.WS_CLOSED,S);});if(this.connectionState!==vt.CONNECTING&&this.connectionState!==vt.RECONNECTING||e===it.JOIN||e===it.REJOIN||await c(),this.websocket.sendMessage(s,!0),r)return;let d=new K((T,m)=>{let E=!1,S=(A,b)=>{E=!0,T({isSuccess:A==="success",message:b||{}}),this.off(Q.WS_CLOSED,C),this.off(Q.WS_RECONNECTING,C),this.emit(Q.REQUEST_SUCCESS,e,n);};this.once("res-@".concat(o),S);let C=()=>{m(new D(R.WS_ABORT,"type: ".concat(e))),this.off(Q.WS_CLOSED,C),this.off(Q.WS_RECONNECTING,C),this.off("res-@".concat(o),S);};this.once(Q.WS_CLOSED,C),this.once(Q.WS_RECONNECTING,C),Ye(v("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||E||(_.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(Q.REQUEST_TIMEOUT,e,n));});}),l=null;try{l=await d;}catch(T){if(this.connectionState===vt.CLOSED||e===it.LEAVE)throw new D(R.WS_ABORT);return !this.spec.forceWaitGatewayResponse||i?T.throw():e===it.JOIN||e===it.REJOIN?null:(await c(),await this.request(e,n))}if(l.isSuccess)return l.message;let u=Number(l.message.error_code||l.message.code),h=gs(u),p=new D(R.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(l.message.error_str),{code:u,data:l.message});return h.action==="success"?l.message:(_.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(u,", message: ").concat(h.desc,", action: ").concat(h.action)),u===ot.ERR_TOO_MANY_BROADCASTERS?((e===it.JOIN||e===it.REJOIN)&&(this.initError=p,this.close()),p.throw()):h.action==="failed"?p.throw():h.action==="quit"?(this.initError=p,this.close(),p.throw()):(u===ot.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,_.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",dn.MULTI_IP)):this.reconnect(h.action,dn.SERVER_ERROR),e===it.JOIN||e===it.REJOIN?null:await this.request(e,n)))}waitMessage(e,n){return new K(i=>{let r=o=>{(!n||n(o))&&(this.off(e,r),i(o));};this.on(e,r);})}uploadWRTCStats(e){if(!this.store.sessionId)return void _.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));let n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(fs.WRTC_STATS,n);}upload(e,n){let i={_type:e,_message:n};try{this.websocket.sendMessage(i);}catch{let o=v("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>o&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==vt.CONNECTED)return;let s=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(s._type,s._message);},v("UPLOAD_CACHE_INTERVAL")||2e3));}}send(e,n){let i={_type:e,_message:n};this.websocket.sendMessage(i);}async sendExtensionMessage(e,n,i){return await this._external_signal.send(e,n,i)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new K((n,i)=>{this.once(Q.WS_CONNECTED,()=>n(this.joinResponse)),this.once(Q.WS_CLOSED,()=>i(this.initError||new D(R.WS_ABORT))),this.connectionState=vt.CONNECTING,this.websocket.init(e).catch(i);})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=e||It.LEAVE,this.connectionState=vt.CLOSED,_.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===It.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new Kc("gateway-".concat(this.clientId),this.spec.retryConfig,!0,v("JOIN_GATEWAY_USE_DUAL_DOMAIN"),v("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents()),this.p2pToken=Zt(6,""),this._external_signal.clear(),this._external_signal=new Ts(this,this.p2pToken);}async join(){if(!this.joinResponse){this.emit(Q.ABORT_P2P_EXECUTION);let e=await Me(this,Q.REQUEST_JOIN_INFO),n=await this.request(it.JOIN,e);if(!n)return this.emit(Q.REPORT_JOIN_GATEWAY,R.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(Q.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token;}return this.connectionState=vt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(e,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,n);}handleDataStream(e){try{var n;let i=_s(e.payload),r=new TextDecoder().decode(i),o=JSON.parse(r);"total"in o&&"id"in o||q(n=Object.values(ye)).call(n,o._type)?(o._uid=e.uid,this._external_signal.onMessage(o)):this.emit(_t.ON_DATA_STREAM,e);}catch{this.emit(_t.ON_DATA_STREAM,e);}}handleNotification(e){_.debug("[".concat(this.clientId,"] receive notification: "),e);let n=gs(e.code);if(n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(It.UID_BANNED),void this.close()):void this.reconnect(n.action,dn.SERVER_ERROR);_.error("[".concat(this.clientId,"] ignore error: "),n.desc);}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;let e=v("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=e&&(_.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>v("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",dn.TIMEOUT):this.request(it.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;let i=Date.now()-n;this.rttRolling.add(i),v("REPORT_STATS")&&this.send(it.PING_BACK,{pingpongElapse:i});}).catch(i=>{});}handleWebsocketEvents(){this.websocket.on(dt.RECONNECT_WAITTING_FINISH,e=>{this.emit(Q.WS_RECONNECT_WAITTING_FINISH,e);}),this.websocket.on(dt.RECONNECT_CREATE_CONNECTION,e=>{this.emit(Q.WS_RECONNECT_CREATE_CONNECTION,e);}),this.websocket.on(dt.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(dt.CLOSED,()=>{this.connectionState=vt.CLOSED;}),this.websocket.on(dt.FAILED,()=>{this._disconnectedReason=It.NETWORK_ERROR,this.connectionState=vt.CLOSED;}),this.websocket.on(dt.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===vt.CONNECTED?this.connectionState=vt.RECONNECTING:this.connectionState=vt.CONNECTING;}),this.websocket.on(dt.WILL_RECONNECT,(e,n,i)=>{e!=="retry"?(_.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(Q.NEED_RENEW_SESSION)):_.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),i(e);}),this.websocket.on(dt.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.join().catch(e=>{if(this.emit(Q.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof D&&e.code===R.UNEXPECTED_RESPONSE&&e.data.code===ot.ERR_NO_AUTHORIZED)return _.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",dn.SERVER_ERROR);_.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",dn.SERVER_ERROR):(this.initError=e,this.close());});}),this.websocket.on(dt.REQUEST_NEW_URLS,(e,n)=>{Me(this,Q.REQUEST_RECOVER,this.multiIpOption).then(e).catch(n);}),this.websocket.on(dt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(_t.ON_TOKEN_PRIVILEGE_DID_EXPIRE);});}}function zI(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function Gi(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?zI(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):zI(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}let Nm=new Map;class Hj extends de{get state(){return this._state}set state(e){if(e===this._state)return;let n=this._state;this._state=e,e==="DISCONNECTED"&&this._disconnectedReason?this.emit(Ie.CONNECTION_STATE_CHANGE,e,n,this._disconnectedReason):this.emit(Ie.CONNECTION_STATE_CHANGE,e,n);}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(e){_.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(e)),this._joinGatewayStartTime=e;}constructor(e,n){super(),g(this,"store",void 0),g(this,"joinInfo",void 0),g(this,"key",void 0),g(this,"ntpOffset",0),g(this,"signal",void 0),g(this,"role",void 0),g(this,"inChannelInfo",{joinAt:null,duration:0}),g(this,"spec",void 0),g(this,"_state","DISCONNECTED"),g(this,"_statsCollector",void 0),g(this,"_disconnectedReason",void 0),g(this,"isSignalRecover",!1),g(this,"hasChangeBGPAddress",!1),g(this,"trafficStatsInterval",void 0),g(this,"networkQualityInterval",void 0),g(this,"_joinGatewayStartTime",0),g(this,"_signalTimeout",!1),g(this,"_clientRoleOptions",void 0),g(this,"_isProactiveJoin",!1),this.store=e,this.spec=n,this.signal=this.store.useP2P?new qI(Gi(Gi({},n),{},{retryConfig:n.websocketRetryConfig}),e):this.store.useDataChannel?new to(Gi(Gi({},n),{},{retryConfig:n.websocketRetryConfig}),e):new BI(Gi(Gi({},n),{},{retryConfig:n.websocketRetryConfig}),e),this._statsCollector=n.statsCollector,this.role=n.role||"audience",this._clientRoleOptions=n.clientRoleOptions,this.handleSignalEvents();}async join(e,n,i){if(this.signal instanceof to){let c=!1;e.cloudProxyServer!=="disabled"?(_.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(e.cloudProxyServer,")")),c=!0):"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length>255||"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length<22?(_.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),c=!0):e.apResponse.addresses.some(d=>d.fingerprint)||v("FINGERPRINT")||(_.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),c=!0),c&&this.resetSignal();}this.store.joinGatewayStart(),e.cloudProxyServer!=="disabled"&&(this.hasChangeBGPAddress=!0);let r=Date.now(),o=Nm.get(e.cname);if(o||(o=new Map,Nm.set(e.cname,o)),this._isProactiveJoin=!0,o.has(e.uid)){let c=new w(R.UID_CONFLICT);throw et.joinGateway(e.sid,{lts:r,succ:!1,ec:c.message,addr:null,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!e.proxyServer,signalChannel:this.signal instanceof to?"1":"0"}),this._isProactiveJoin=!1,c}o.set(e.uid,!0),this.joinInfo=e,this.key=n;let s=0;this.joinGatewayStartTime=r;let a=e.proxyServer;try{let c;if(_.debug("[".concat(this.store.clientId,"] use ").concat(this.signal instanceof to?"datachannel":"websocket"," join uid ").concat(s)),this.signal instanceof to)c=await this.signal.init(e.apResponse.addresses,i);else {let d=e.gatewayAddrs.map(l=>{let{address:u}=l,[h,p]=u.split(":"),T={host:h,port:p};return e.proxyServer&&(T.proxy=e.proxyServer),T});c=await this.signal.init(d,i);}s=c.uid,_.debug("[".concat(this.store.clientId,"] ").concat(this.signal instanceof to?"datachannel":"websocket"," join uid ").concat(s," cost ").concat(Date.now()-this.joinGatewayStartTime));}catch(c){throw c&&c.code===R.INIT_WEBSOCKET_TIMEOUT?(_.warning("[".concat(this.store.clientId,"] User join failed"),c.toString()),c):c&&c.code===R.INIT_DATACHANNEL_TIMEOUT?(_.warning("[".concat(this.store.clientId,"] User join datachannel failed"),c.toString()),this.resetSignal(),c):(_.error("[".concat(this.store.clientId,"] User join failed"),c.toString()),et.joinGateway(e.sid,{lts:r,succ:!1,ec:c.message,addr:this.signal.url,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!a,signalChannel:this.signal instanceof to?"1":"0"}),this._isProactiveJoin=!1,o.delete(e.uid),this.signal.close(),c)}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),_.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval(()=>{this.updateTrafficStats().catch(c=>{_.warning("[".concat(this.store.clientId,"] get traffic stats error"),c.toString());});},3e3),this.networkQualityInterval=window.setInterval(()=>{navigator&&navigator.onLine!==void 0&&!navigator.onLine?this.emit(Ie.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(Ie.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):this.state==="CONNECTED"&&this._statsCollector.trafficStats?this.emit(Ie.NETWORK_QUALITY,{uplinkNetworkQuality:WI(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:WI(this._statsCollector.trafficStats.B_dnq)}):this.emit(Ie.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0});},2e3),this.store.joinGatewayEnd(),s}async leave(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0],n=arguments.length>1?arguments[1]:void 0;if(this.state!=="DISCONNECTED"){n!==It.FALLBACK&&(this.state="DISCONNECTING");try{e||this.signal.connectionState!==vt.CONNECTED||await function(i,r){return r===1/0?i:K.race([i,DB(r)])}(this.signal.request(it.LEAVE,void 0,!0),3e3);}catch(i){_.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),i);}this.signal.close(n),n!==It.FALLBACK&&(this.state="DISCONNECTED"),this.reset();}}async publish(e,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));let r={state:"offer",p2p_id:this.store.p2pId,ortc:n,mode:this.spec.mode,extend:v("PUB_EXTEND"),twcc:!!v("PUBLISH_TWCC"),rtx:!!v("USE_PUB_RTX")};try{return (await this.signal.request(it.PUBLISH,r,!0))._message}catch(o){if(i&&o.data&&o.data.code===ot.ERR_PUBLISH_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),o.toString()),await this.tryUnpubBeforeRepub(e,n),this.publish(e,n,!1);throw o}}async publishDataChannel(e,n,i){var r;if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));let o={stream_id:n.streamId,ordered:n.ordered?1:0,max_retrans_times:(r=n.maxRetransmits)!==null&&r!==void 0?r:10,channel_id:n.channelId,metadata:n.metadata};try{await this.signal.request(it.PUBLISH_DATASTREAM,o,!0);}catch(s){if(i&&s.data&&s.data.code===ot.ERR_PUBLISH_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),s.toString()),await this.tryUnpubDataChannelBeforeRepub(e,n),this.publishDataChannel(e,n,!1);throw s}}async unpublish(e,n){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(it.UNPUBLISH,{stream_id:n,ortc:e},!0);}catch(i){_.warning("[".concat(this.store.clientId,"] unpublish warning: "),i);}}async unpublishDataChannel(e){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await K.all(e.map(n=>this.signal.request(it.UNPUBLISH_DATASTREAM,{channel_id:n},!0)));}catch(n){_.warning("unpublish datachannels warning: ",n);}}async presubscribe(e,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));let r={stream_id:e,stream_type:n,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!v("SUBSCRIBE_TWCC"),rtx:!!v("USE_SUB_RTX")||void 0,extend:v("SUB_EXTEND"),svc:Array.isArray(v("SVC"))&&v("SVC").length!==0?v("SVC"):void 0};try{return await this.signal.request(it.PRE_SUBSCRIBE,r,!0)}catch(o){if(i&&o.data&&o.data.code===ot.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),o.toString()),this.presubscribe(e,n,!1);throw o}}async subscribe(e,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));let r={stream_id:e,stream_type:n.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!v("SUBSCRIBE_TWCC"),rtx:!!v("USE_SUB_RTX"),extend:v("SUB_EXTEND"),ssrcId:n.ssrcId,svc:Array.isArray(v("SVC"))&&v("SVC").length!==0?v("SVC"):void 0};try{return (await this.signal.request(it.SUBSCRIBE,r,!0))._message}catch(o){if(i&&o.data&&o.data.code===ot.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),o.toString()),await this.tryUnsubBeforeResub(e,n),await this.subscribe(e,n,!1);throw o}}async subscribeDataChannel(e,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));let r={uid:e,stream_id:n.id,channel_id:n.datachannelId};try{return void await this.signal.request(it.SUBSCRIBE_DATASTREAM,r,!0)}catch(o){if(i&&o.data&&o.data.code===ot.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),o.toString()),await this.tryUnsubDataChannelBeforeResub(e,n),await this.subscribeDataChannel(e,n,!1);throw o}}async subscribeAll(e,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));let i={p2p_id:this.store.p2pId,users:e,dtx:!1,rtx:!!v("USE_SUB_RTX"),twcc:!!v("SUBSCRIBE_TWCC"),svc:Array.isArray(v("SVC"))&&v("SVC").length!==0?v("SVC"):void 0};try{return await this.signal.request(it.SUBSCRIBE_STREAMS,i,!0)}catch(r){if(n&&r.data&&r.data.code===ot.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),r.toString()),await this.tryMassUnsubBeforeResub(e),await this.subscribeAll(e,!1);throw r}}async setVideoProfile(e){let n=function(i){if(!(i.bitrateMax&&i.bitrateMin&&i.frameRate&&i.height&&i.width))return;let r=i.frameRate,o=i.width,s=i.height,a=!0;return typeof r!="number"&&(r=r.exact||r.ideal||r.max||r.min||0,r||(a=!1)),typeof o!="number"&&(o=o.exact||o.ideal||o.max||o.min||0,o||(a=!1)),typeof s!="number"&&(s=s.exact||s.ideal||s.max||s.min||0,r||(a=!1)),a?{stream_type:0,width:o,height:s,fps:r,start_bps:1e3*i.bitrateMax,min_bps:1e3*i.bitrateMin,target_bps:1e3*i.bitrateMax}:void 0}(e);if(n)return this.signal.request(it.SET_VIDEO_PROFILE,n);_.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"));}async unsubscribe(e,n){try{await this.signal.request(it.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:e,stream_id:n},!0);}catch(i){_.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),i);}}async unsubscribeDataChannel(e,n){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await K.all(e.map(i=>this.signal.request(it.UNSUBSCRIBE_DATASTREAM,{stream_id:i,uid:n},!0)));}catch(i){_.warning("unsubscribeDataChannel warning: ",i);}}async massUnsubscribe(e){try{await this.signal.request(it.UNSUBSCRIBE_STREAMS,e,!0);}catch(n){_.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),n);}}async reconnectPC(e){let{iceParameters:n,dtlsParameters:i,rtpCapabilities:r}=e;return {gatewayEstablishParams:await this.signal.request(it.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:n,dtlsParameters:i,rtpCapabilities:r}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(it.GATEWAY_INFO)}async renewToken(e){await this.signal.request(it.RENEW_TOKEN,e),this.key=e.token;}async setClientRole(e,n){if(n&&(this._clientRoleOptions=Object.assign({},n)),this.state!=="CONNECTED")return void(this.role=e);let i,r=0;e==="audience"?this._clientRoleOptions&&this._clientRoleOptions.delay?(i=this._clientRoleOptions.delay,r=1):r=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:r=0,await this.signal.request(it.SET_CLIENT_ROLE,{role:e,level:r,delay:i,client_ts:Date.now()}),this.role=e;}async setRemoteVideoStreamType(e,n){await this.signal.request(it.SWITCH_VIDEO_STREAM,{stream_id:e,stream_type:n});}async setDefaultRemoteVideoStreamType(e){await this.signal.request(it.DEFAULT_VIDEO_STREAM,{stream_type:e});}async setStreamFallbackOption(e,n){await this.signal.request(it.SET_FALLBACK_OPTION,{stream_id:e,fallback_type:n});}async pickSVCLayer(e,n){await this.signal.request(it.PICK_SVC_LAYER,{stream_id:e,spatial_layer:n.spatialLayer,temporal_layer:n.temporalLayer});}async setRTM2Flag(e){await this.signal.request(it.SET_RTM2_FLAG,{rtm2_flag:e});}async sendExtensionMessage(e,n,i){if(this.signal instanceof qI)return this.signal.sendExtensionMessage(e,n,i)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),Gi({},this.inChannelInfo)}async getGatewayVersion(){return (await this.signal.request(it.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){let e=Nm.get(this.joinInfo.cname);e&&e.delete(this.joinInfo.uid);}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0);}updateTurnConfigFromSignal(){if(!this.joinInfo)return;let e=function(n){let i;return i=n.startsWith("dc")?n.match(/(dc\:\/\/)?([^:]+):(\d+)/):n.match(/(wss\:\/\/)?([^:]+):(\d+)/),i?{username:ln.username,password:ln.password,turnServerURL:i[2],tcpport:parseInt(i[3])+30,udpport:parseInt(i[3])+30,forceturn:!1}:null}((this.joinInfo.cloudProxyServer==="disabled"?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],e&&this.joinInfo.turnServer.mode!=="off"&&this.joinInfo.cloudProxyServer==="disabled"&&this.joinInfo.turnServer.serversFromGateway.push(Gi(Gi({},ln),{},{turnServerURL:e.turnServerURL,tcpport:e.tcpport,udpport:e.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}));}async updateTrafficStats(){if(this.state!=="CONNECTED")return;let e=await this.signal.request(it.TRAFFIC_STATS,void 0,!0);e.timestamp=Date.now(),e.ntp_offset!=null&&(this.ntpOffset=e.ntp_offset),e.peer_delay.forEach(n=>{let i=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find(r=>r.peer_uid===n.peer_uid);i&&i.B_st!==n.B_st&&zl(()=>{this.emit(Ie.STREAM_TYPE_CHANGE,n.peer_uid,n.B_st);});}),this._statsCollector.updateTrafficStats(e);}getJoinMessage(e){if(!this.joinInfo||!this.key)throw new w(R.UNEXPECTED_ERROR,"can not generate join message, no join info");let n=Object.assign({},this.joinInfo.apResponse),i=v("REPORT_APP_SCENARIO");if(typeof i!="string")try{i=JSON.stringify(i);}catch{i=void 0;}i&&i.length>128&&(i=void 0);let r=Gi({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:vi,browser:navigator.userAgent,process_id:v("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:n,extend:v("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:this.joinInfo.cloudProxyServer==="proxy3"?"1":this.joinInfo.cloudProxyServer==="proxy5"?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:i,attributes:{userAttributes:{enablePublishedUserList:v("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:v("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:typeof v("SUBSCRIBE_AUDIO_FILTER_TOPN")=="number"?v("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:typeof v("ENABLE_PUBLISH_AUDIO_FILTER")=="boolean"?v("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:typeof v("ENABLE_USER_LICENSE_CHECK")=="boolean"?v("ENABLE_USER_LICENSE_CHECK"):void 0,enableRTX:v("USE_PUB_RTX")===!0||v("USE_SUB_RTX")===!0||void 0,disableFEC:v("DISABLE_FEC"),enableNTPReport:!!v("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!v("ENABLE_INSTANT_VIDEO")||void 0,enableDataStream2:typeof v("ENABLE_DATASTREAM_2")=="boolean"?v("ENABLE_DATASTREAM_2"):void 0,rtm2Flag:typeof this.joinInfo.rtmFlag=="number"?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!v("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:typeof v("USE_XR")=="boolean"?v("USE_XR"):void 0,enableLossbasedBwe:typeof v("ENABLE_LOSSBASED_BWE")=="boolean"?v("ENABLE_LOSSBASED_BWE"):void 0,enableAutCC:typeof v("ENABLE_AUT_CC")=="boolean"?v("ENABLE_AUT_CC"):void 0,enableCCFallback:typeof v("ENABLE_CC_FALLBACK")=="boolean"?v("ENABLE_CC_FALLBACK"):void 0}},join_ts:this.joinGatewayStartTime},e);return this.joinInfo.stringUid&&(r.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(r.aes_mode=this.joinInfo.aesmode,v("ENCRYPT_AES")?(r.aes_secret=this.joinInfo.aespassword,r.aes_encrypt=!0):r.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(r.aes_salt=this.joinInfo.aessalt)),n.addresses[this.signal.websocket.currentURLIndex]&&(r.ap_response.ticket=n.addresses[this.signal.websocket.currentURLIndex].ticket,delete n.addresses),this.joinInfo.defaultVideoStream!==void 0&&(r.default_video_stream=this.joinInfo.defaultVideoStream),r}getRejoinMessage(){if(!this.joinInfo)throw new w(R.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return {session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(Q.WS_RECONNECT_WAITTING_FINISH,e=>{var n;q(n=["tryNext","recover"]).call(n,e)&&this.joinInfo&&et.adjustSessionStartTime(this.joinInfo.sid);}),this.signal.on(Q.WS_RECONNECT_CREATE_CONNECTION,e=>{this.joinGatewayStartTime=Date.now();}),this.signal.on(Q.WS_RECONNECTING,e=>{this.joinInfo&&et.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e||dn.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",et.sessionInit(this.joinInfo.sid,{lts:new Date().getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:this.spec.mode==="live"?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:this.role==="audience"?2:1,buildFormat:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now());}),this.signal.on(Q.WS_CLOSED,e=>{let n;switch(e){case It.LEAVE:n=dn.LEAVE;break;case It.UID_BANNED:case It.IP_BANNED:case It.CHANNEL_BANNED:case It.SERVER_ERROR:n=dn.SERVER_ERROR;break;case It.FALLBACK:n=dn.FALLBACK;break;case It.LICENSE_MISSING:case It.LICENSE_EXPIRED:case It.LICENSE_MINUTES_EXCEEDED:case It.LICENSE_PERIOD_INVALID:case It.LICENSE_MULTIPLE_SDK_SERVICE:case It.LICENSE_ILLEGAL:case It.TOKEN_EXPIRE:n=e;break;default:n=dn.NETWORK_ERROR;}_.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(n||"undefined -> "+dn.NETWORK_ERROR)),this.joinInfo&&et.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:e===It.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:n}),this._disconnectedReason=e,e!==It.FALLBACK&&(this.state="DISCONNECTED"),this.reset();}),this.signal.on(Q.WS_CONNECTED,()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&(this.role==="audience"&&this._clientRoleOptions&&(this._clientRoleOptions.level||this._clientRoleOptions.delay)&&(_.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions.level,", delay: ").concat(this._clientRoleOptions.delay)),this.setClientRole(this.role,this._clientRoleOptions)),et.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof to?"1":"0"}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&this.joinInfo.setLocalAPVersion===1)){let e=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!e)return void _.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(e));Jt("EVENT_REPORT_DOMAIN",e[1]),Jt("EVENT_REPORT_BACKUP_DOMAIN",e[1]),Jt("LOG_UPLOAD_SERVER","".concat(e[1],":6444"));}}),this.signal.on(_t.ON_UPLINK_STATS,e=>{this._statsCollector.updateUplinkStats(e);}),this.signal.on(Q.REQUEST_RECOVER,(e,n,i)=>{if(!this.joinInfo)return i(new w(R.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));e&&(this.joinInfo.multiIP=e,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,Me(this,Ie.REQUEST_NEW_GATEWAY_LIST).then(n).catch(i);}),this.signal.on(Q.REQUEST_JOIN_INFO,async e=>{var n;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void e(this.getJoinMessage({ortc:{}}));let{iceParameters:i,dtlsParameters:r,rtpCapabilities:o}=await Me(this,Ie.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:(n=this.joinInfo)===null||n===void 0?void 0:n.turnServer});e(this.getJoinMessage({ortc:{iceParameters:i,dtlsParameters:r,rtpCapabilities:o,version:"2"}}));}),this.signal.on(Q.REQUEST_REJOIN_INFO,e=>{e(this.getRejoinMessage());}),this.signal.on(Q.REPORT_JOIN_GATEWAY,(e,n)=>{this.joinInfo&&(et.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:e,addr:n,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof to?"1":"0"}),this._isProactiveJoin=!1);}),this.signal.on(Q.IS_P2P_DISCONNECTED,e=>{e(hs(this,Ie.IS_P2P_DISCONNECTED));}),this.signal.on(Q.DISCONNECT_P2P,()=>{this.emit(Ie.DISCONNECT_P2P);}),this.signal.on(Q.NEED_RENEW_SESSION,e=>{this.emit(Ie.NEED_RENEW_SESSION,e);}),this.signal.on(Q.REQUEST_SUCCESS,()=>{this._signalTimeout=!1;}),this.signal.on(Q.REQUEST_TIMEOUT,()=>{this._signalTimeout=!0;}),this.signal.on(Q.JOIN_RESPONSE,e=>{let n=this.getCurrentGatewayAddress();this.emit(Ie.JOIN_RESPONSE,e,n);}),this.signal.on(Q.DATACHANNEL_PRECONNECT,async(e,n,i)=>{this.updateTurnConfigFromSignal();let r=this.getCurrentGatewayAddress();return Me(this,Ie.DATACHANNEL_PRECONNECT,e,r).then(n).catch(i)}),this.signal.on(Q.DATACHANNEL_CONNECTING,async e=>{let{iceParameters:n,dtlsParameters:i,rtpCapabilities:r}=await Me(this,Ie.REQUEST_DC_CONNECTION_PARAMS);e(this.getJoinMessage({ortc:{iceParameters:n,dtlsParameters:i,rtpCapabilities:r,version:"2"}}));}),this.signal.on(Q.DATACHANNEL_FAILBACK,()=>{_.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(Ie.DATACHANNEL_FAILBACK);});}async tryUnsubBeforeResub(e,n){try{await this.signal.request(it.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:e,ortc:[n]},!0);}catch(i){throw _.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),i),i}}async tryUnsubDataChannelBeforeResub(e,n){try{await this.signal.request(it.UNSUBSCRIBE,{stream_id:n.id},!0);}catch(i){throw _.warning("unsubscribe datachannel warning",i),i}}async tryUnpubBeforeRepub(e,n){try{await this.signal.request(it.UNPUBLISH,{stream_id:e,ortc:n},!0);}catch(i){throw _.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),i),i}}async tryUnpubDataChannelBeforeRepub(e,n){try{await this.signal.request(it.UNPUBLISH_DATASTREAM,{channnel_id:n.channelId},!0);}catch(i){throw _.warning("unpublish datastream warning: ",i),i}}async tryMassUnsubBeforeResub(e){let n={users:e.map(i=>({stream_id:i.stream_id,stream_type:i.stream_type}))};try{await this.signal.request(it.UNSUBSCRIBE_STREAMS,n,!0);}catch(i){throw _.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),i),i}}async muteLocal(e,n){let i={action:e.find(r=>r.stream_type===jt.Audio)?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:n};try{await this.signal.request(it.CONTROL,i,!0,!0);}catch(r){throw _.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),r),r}}async unmuteLocal(e,n){let i={action:e.find(r=>r.stream_type===jt.Audio)?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:n};try{await this.signal.request(it.CONTROL,i,!0,!0);}catch(r){throw _.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),r),r}}async muteRemote(e,n){let i={action:e===tt.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:n};try{await this.signal.request(it.CONTROL,i,!0,!0);}catch(r){throw _.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),r),r}}async unmuteRemote(e,n){let i={action:e===tt.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:n};try{await this.signal.request(it.CONTROL,i,!0,!0);}catch(r){throw _.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),r),r}}uploadWRTCStats(e){this.signal.uploadWRTCStats(e);}upload(e,n){this.signal.upload(e,n);}getSignalRTT(){return this.signal.rtt}async restartICE(e){let n={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:e};try{return await this.signal.request(it.RESTART_ICE,n,!0)}catch(i){throw _.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),i),i}}reconnect(){this.state==="CONNECTED"&&this.signal.reconnect(void 0,dn.P2P_FAILED);}getCurrentGatewayAddress(){var e;if(!v("GATEWAY_WSS_ADDRESS"))return (e=this.joinInfo)!==null&&e!==void 0&&e.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(e){await this.signal.request(it.SET_PARAMETER,{enablePublishAudioFilter:e});}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(It.FALLBACK)),this.store.useDataChannel=!1,this.signal=new BI(Gi(Gi({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(Ie.RESET_SIGNAL,PI.websocket);}}let cu=0,Dm=0;function ur(t,e,n,i){return new K((r,o)=>{e.timeout=e.timeout||v("HTTP_CONNECT_TIMEOUT"),e.responseType=e.responseType||"json",e.data&&!n?(e.data=JSON.stringify(e.data),cu+=Or(e.data)):n&&(e.data.size?cu+=e.data.size:e.data instanceof FormData?cu+=lI(e.data):cu+=Or(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=t,Mn.request(e).then(s=>{typeof s.data=="string"?Dm+=Or(s.data):s.data instanceof ArrayBuffer||s.data instanceof Uint8Array?Dm+=s.data.byteLength:Dm+=Or(JSON.stringify(s.data)),i&&r({data:s.data,headers:s.headers}),r(s.data);}).catch(s=>{Mn.isCancel(s)?o(new w(R.OPERATION_ABORTED,"cancel token canceled")):s.code==="ECONNABORTED"?o(new w(R.NETWORK_TIMEOUT,s.message)):s.response?o(new w(R.NETWORK_RESPONSE_ERROR,s.response.status)):o(new w(R.NETWORK_ERROR,s.message));});})}(function(){var t;function e(U){var G=0;return function(){return G<U.length?{done:!1,value:U[G++]}:{done:!0}}}var n=typeof Object.defineProperties=="function"?Object.defineProperty:function(U,G,$){return U==Array.prototype||U==Object.prototype||(U[G]=$.value),U},i,r=function(U){U=[typeof globalThis=="object"&&globalThis,U,typeof window=="object"&&window,typeof self=="object"&&self,typeof V=="object"&&V];for(var G=0;G<U.length;++G){var $=U[G];if($&&$.Math==Math)return $}throw Error("Cannot find global object")}(this);function o(U,G){if(G)t:{var $=r;U=U.split(".");for(var ht=0;ht<U.length-1;ht++){var Ut=U[ht];if(!(Ut in $))break t;$=$[Ut];}(G=G(ht=$[U=U[U.length-1]]))!=ht&&G!=null&&n($,U,{configurable:!0,writable:!0,value:G});}}function s(U){return (U={next:U})[Symbol.iterator]=function(){return this},U}function a(U){var G=typeof Symbol<"u"&&Symbol.iterator&&U[Symbol.iterator];return G?G.call(U):{next:e(U)}}if(o("Symbol",function(U){function G(Ut,Y){this.A=Ut,n(this,"description",{configurable:!0,writable:!0,value:Y});}if(U)return U;G.prototype.toString=function(){return this.A};var $="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",ht=0;return function Ut(Y){if(this instanceof Ut)throw new TypeError("Symbol is not a constructor");return new G($+(Y||"")+"_"+ht++,Y)}}),o("Symbol.iterator",function(U){if(U)return U;U=Symbol("Symbol.iterator");for(var G="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),$=0;$<G.length;$++){var ht=r[G[$]];typeof ht=="function"&&typeof ht.prototype[U]!="function"&&n(ht.prototype,U,{configurable:!0,writable:!0,value:function(){return s(e(this))}});}return U}),typeof Object.setPrototypeOf=="function")i=Object.setPrototypeOf;else {var c;t:{var d={};try{d.__proto__={a:!0},c=d.a;break t}catch{}c=!1;}i=c?function(U,G){if(U.__proto__=G,U.__proto__!==G)throw new TypeError(U+" is not extensible");return U}:null;}var l=i;function u(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null;}function h(U){if(U.m)throw new TypeError("Generator is already running");U.m=!0;}function p(U,G){return U.h=3,{value:G}}function T(U){this.g=new u,this.G=U;}function m(U,G,$,ht){try{var Ut=G.call(U.g.j,$);if(!(Ut instanceof Object))throw new TypeError("Iterator result "+Ut+" is not an object");if(!Ut.done)return U.g.m=!1,Ut;var Y=Ut.value;}catch(f){return U.g.j=null,U.g.s(f),E(U)}return U.g.j=null,ht.call(U.g,Y),E(U)}function E(U){for(;U.g.h;)try{var G=U.G(U.g);if(G)return U.g.m=!1,{value:G.value,done:!1}}catch($){U.g.v=void 0,U.g.s($);}if(U.g.m=!1,U.g.l){if(G=U.g.l,U.g.l=null,G.F)throw G.D;return {value:G.return,done:!0}}return {value:void 0,done:!0}}function S(U){this.next=function(G){return U.o(G)},this.throw=function(G){return U.s(G)},this.return=function(G){return function($,ht){h($.g);var Ut=$.g.j;return Ut?m($,"return"in Ut?Ut.return:function(Y){return {value:Y,done:!0}},ht,$.g.return):($.g.return(ht),E($))}(U,G)},this[Symbol.iterator]=function(){return this};}function C(U,G){return G=new S(new T(G)),l&&U.prototype&&l(G,U.prototype),G}if(u.prototype.o=function(U){this.v=U;},u.prototype.s=function(U){this.l={D:U,F:!0},this.h=this.C||this.u;},u.prototype.return=function(U){this.l={return:U},this.h=this.u;},T.prototype.o=function(U){return h(this.g),this.g.j?m(this,this.g.j.next,U,this.g.o):(this.g.o(U),E(this))},T.prototype.s=function(U){return h(this.g),this.g.j?m(this,this.g.j.throw,U,this.g.o):(this.g.s(U),E(this))},o("Array.prototype.entries",function(U){return U||function(){return function(G,$){G instanceof String&&(G+="");var ht=0,Ut=!1,Y={next:function(){if(!Ut&&ht<G.length){var f=ht++;return {value:$(f,G[f]),done:!1}}return Ut=!0,{done:!0,value:void 0}}};return Y[Symbol.iterator]=function(){return Y},Y}(this,function(G,$){return [G,$]})}}),typeof Blob<"u"&&(typeof FormData>"u"||!FormData.prototype.keys)){var A=function(U,G){for(var $=0;$<U.length;$++)G(U[$]);},b=function(U){return U.replace(/\r?\n|\r/g,`\r
`)},O=function(U,G,$){return G instanceof Blob?($=$!==void 0?$+"":typeof G.name=="string"?G.name:"blob",G.name===$&&Object.prototype.toString.call(G)!=="[object Blob]"||(G=new File([G],$)),[String(U),G]):[String(U),String(G)]},N=function(U,G){if(U.length<G)throw new TypeError(G+" argument required, but only "+U.length+" present.")},k=typeof globalThis=="object"?globalThis:typeof window=="object"?window:typeof self=="object"?self:this,M=k.FormData,x=k.XMLHttpRequest&&k.XMLHttpRequest.prototype.send,X=k.Request&&k.fetch,bt=k.navigator&&k.navigator.sendBeacon,Ft=k.Element&&k.Element.prototype,re=k.Symbol&&Symbol.toStringTag;re&&(Blob.prototype[re]||(Blob.prototype[re]="Blob"),"File"in k&&!File.prototype[re]&&(File.prototype[re]="File"));try{new File([],"");}catch{k.File=function(G,$,ht){return G=new Blob(G,ht||{}),Object.defineProperties(G,{name:{value:$},lastModified:{value:+(ht&&ht.lastModified!==void 0?new Date(ht.lastModified):new Date)},toString:{value:function(){return "[object File]"}}}),re&&Object.defineProperty(G,re,{value:"File"}),G};}var Le=function(U){return U.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},Ee=function(U){this.i=[];var G=this;U&&A(U.elements,function($){if($.name&&!$.disabled&&$.type!=="submit"&&$.type!=="button"&&!$.matches("form fieldset[disabled] *"))if($.type==="file"){var ht=$.files&&$.files.length?$.files:[new File([],"",{type:"application/octet-stream"})];A(ht,function(Ut){G.append($.name,Ut);});}else $.type==="select-multiple"||$.type==="select-one"?A($.options,function(Ut){!Ut.disabled&&Ut.selected&&G.append($.name,Ut.value);}):$.type==="checkbox"||$.type==="radio"?$.checked&&G.append($.name,$.value):(ht=$.type==="textarea"?b($.value):$.value,G.append($.name,ht));});};if((t=Ee.prototype).append=function(U,G,$){N(arguments,2),this.i.push(O(U,G,$));},t.delete=function(U){N(arguments,1);var G=[];U=String(U),A(this.i,function($){$[0]!==U&&G.push($);}),this.i=G;},t.entries=function U(){var G,$=this;return C(U,function(ht){if(ht.h==1&&(G=0),ht.h!=3)return G<$.i.length?ht=p(ht,$.i[G]):(ht.h=0,ht=void 0),ht;G++,ht.h=2;})},t.forEach=function(U,G){N(arguments,1);for(var $=a(this),ht=$.next();!ht.done;ht=$.next()){var Ut=a(ht.value);ht=Ut.next().value,Ut=Ut.next().value,U.call(G,Ut,ht,this);}},t.get=function(U){N(arguments,1);var G=this.i;U=String(U);for(var $=0;$<G.length;$++)if(G[$][0]===U)return G[$][1];return null},t.getAll=function(U){N(arguments,1);var G=[];return U=String(U),A(this.i,function($){$[0]===U&&G.push($[1]);}),G},t.has=function(U){N(arguments,1),U=String(U);for(var G=0;G<this.i.length;G++)if(this.i[G][0]===U)return !0;return !1},t.keys=function U(){var G,$,ht,Ut,Y=this;return C(U,function(f){if(f.h==1&&(G=a(Y),$=G.next()),f.h!=3)return $.done?void(f.h=0):(ht=$.value,Ut=a(ht),p(f,Ut.next().value));$=G.next(),f.h=2;})},t.set=function(U,G,$){N(arguments,2),U=String(U);var ht=[],Ut=O(U,G,$),Y=!0;A(this.i,function(f){f[0]===U?Y&&(Y=!ht.push(Ut)):ht.push(f);}),Y&&ht.push(Ut),this.i=ht;},t.values=function U(){var G,$,ht,Ut,Y=this;return C(U,function(f){if(f.h==1&&(G=a(Y),$=G.next()),f.h!=3)return $.done?void(f.h=0):(ht=$.value,(Ut=a(ht)).next(),p(f,Ut.next().value));$=G.next(),f.h=2;})},Ee.prototype._asNative=function(){for(var U=new M,G=a(this),$=G.next();!$.done;$=G.next()){var ht=a($.value);$=ht.next().value,ht=ht.next().value,U.append($,ht);}return U},Ee.prototype._blob=function(){var U="----formdata-polyfill-"+Math.random(),G=[],$="--"+U+`\r
Content-Disposition: form-data; name="`;return this.forEach(function(ht,Ut){return typeof ht=="string"?G.push($+Le(b(Ut))+`"\r
\r
`+b(ht)+`\r
`):G.push($+Le(b(Ut))+'"; filename="'+Le(ht.name)+`"\r
Content-Type: `+(ht.type||"application/octet-stream")+`\r
\r
`,ht,`\r
`)}),G.push("--"+U+"--"),new Blob(G,{type:"multipart/form-data; boundary="+U})},Ee.prototype[Symbol.iterator]=function(){return this.entries()},Ee.prototype.toString=function(){return "[object FormData]"},Ft&&!Ft.matches&&(Ft.matches=Ft.matchesSelector||Ft.mozMatchesSelector||Ft.msMatchesSelector||Ft.oMatchesSelector||Ft.webkitMatchesSelector||function(U){for(var G=(U=(this.document||this.ownerDocument).querySelectorAll(U)).length;0<=--G&&U.item(G)!==this;);return -1<G}),re&&(Ee.prototype[re]="FormData"),x){var nr=k.XMLHttpRequest.prototype.setRequestHeader;k.XMLHttpRequest.prototype.setRequestHeader=function(U,G){nr.call(this,U,G),U.toLowerCase()==="content-type"&&(this.B=!0);},k.XMLHttpRequest.prototype.send=function(U){U instanceof Ee?(U=U._blob(),this.B||this.setRequestHeader("Content-Type",U.type),x.call(this,U)):x.call(this,U);};}X&&(k.fetch=function(U,G){return G&&G.body&&G.body instanceof Ee&&(G.body=G.body._blob()),X.call(this,U,G)}),bt&&(k.navigator.sendBeacon=function(U,G){return G instanceof Ee&&(G=G._asNative()),bt.call(this,U,G)}),k.FormData=Ee;}})();let zc=()=>{let t=v("AREAS");return t.length===0&&t.push(Mt.GLOBAL),rr(t).call(t,(e,n,i)=>{let r=JI(n);return r?i===0?r:"".concat(e,",").concat(r):e},"")},JI=t=>t===Mt.OVERSEA?"".concat(En.ASIA,",").concat(En.EUROPE,",").concat(En.AFRICA,",").concat(En.NORTH_AMERICA,",").concat(En.SOUTH_AMERICA,",").concat(En.OCEANIA):En[t],Kj=t=>{let e={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return t.map(n=>{let i=ou[n],r=Object.keys(i);r&&r.map(o=>{o!=="CODE"&&(e[o]=e[o].concat(i[o]));});}),e},du={GLOBAL:{ASIA:[Mt.CHINA,Mt.JAPAN,Mt.INDIA,Mt.KOREA,Mt.HKMC],EUROPE:[],NORTH_AMERICA:[Mt.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},lu=Object.keys(du[Mt.GLOBAL]),Pm=[Mt.CHINA,Mt.NORTH_AMERICA,Mt.EUROPE,Mt.ASIA,Mt.JAPAN,Mt.INDIA,Mt.OCEANIA,Mt.SOUTH_AMERICA,Mt.AFRICA,Mt.KOREA,Mt.HKMC,Mt.US],Yj=function(t,e){let n=[];if(q(t).call(t,Mt.GLOBAL)){let o=[Mt.GLOBAL,Mt.OVERSEA],s=Object.keys(ou);if(e===Mt.GLOBAL)throw new w(R.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(e===Mt.CHINA)n=[Mt.OVERSEA];else if(r=e,q(lu).call(lu,r)){let a=(i=e,du[Mt.GLOBAL][i]||[]),c=[...o,e,...a];n=s.filter(d=>!q(c).call(c,d));}else if(function(a){let c=!1;return lu.forEach(d=>{var l;q(l=du[Mt.GLOBAL][d]).call(l,a)&&(c=!0);}),c}(e)){let a=function(d){let l;return lu.forEach(u=>{var h;q(h=du[Mt.GLOBAL][u]).call(h,d)&&(l=u);}),l}(e),c=[...o,a,e];n=s.filter(d=>!q(c).call(c,d));}else n=t;n=function(a){let c=[];return Pm.forEach(d=>{q(a).call(a,d)&&c.push(d);}),c.concat(a.filter(d=>!q(Pm).call(Pm,d)))}(n);}else n=t;var i,r;return n};function XI(t){var e,n;if(!t&&q(e=v("AREAS")).call(e,Mt.EXTENSIONS))return _.debug("update area from ap : reset"),void Lm(BB,!0);if(!q(n=v("AREAS")).call(n,Mt.GLOBAL)||!t)return;let i=ou.EXTENSIONS;i&&(i={CODE:JI(Mt.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(t,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(t,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(t,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(t,".agora.io"),"cds-ap-web-2-".concat(t,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(t,".agora.io"),"sua-ap-web-2-".concat(t,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(t,".agora.io"),"uap-ap-web-2-".concat(t,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(t,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(t,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(t,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(t,".agora.io")]},_.debug("update area from ap success: ".concat(t,",config is "),i),Jt("AREAS",[Mt.EXTENSIONS],!0),Object.keys(i).map(r=>{r==="LOG_UPLOAD_SERVER"||r==="EVENT_REPORT_DOMAIN"||r==="EVENT_REPORT_BACKUP_DOMAIN"||r==="PROXY_SERVER_TYPE3"?Jt(r,i[r][0]):Jt(r,i[r]);}));}function Lm(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1],n=et.reportApiInvoke(null,{name:ke.SET_AREA,options:t,tag:ge.TRACER});try{let i=[];if(typeof t=="string"&&(i=[t]),Array.isArray(t)&&(t.forEach(o=>{if(!q(LI).call(LI,o))throw new w(R.INVALID_PARAMS,"invalid area code")}),i=t),Object.prototype.toString.call(t)==="[object Object]"){let{areaCode:o,excludedArea:s}=t;if(!o)throw new w(R.INVALID_PARAMS,"area code is needed");let a=o;typeof o=="string"&&(a=[o]),i=s?Yj(a,s):a;}if(!e){if(bo.AREAS){let o=new w(R.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return n.onError(o),void _.warning("setArea is prohibited because of config-distribute")}if(q(i).call(i,Mt.GLOBAL)&&v("AREAS")===Mt.EXTENSIONS){let o=new w(R.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return n.onError(o),void _.warning("setArea is prohibited because of ap extensions")}}Jt("AREAS",i,e);let r=Kj(i);Object.keys(r).map(o=>{o==="LOG_UPLOAD_SERVER"||o==="EVENT_REPORT_DOMAIN"||o==="EVENT_REPORT_BACKUP_DOMAIN"||o==="PROXY_SERVER_TYPE3"?Jt(o,r[o][0]):Jt(o,r[o]);}),_.debug("set area success:",i.join(","));}catch(i){throw n.onError(i),i}n.onSuccess();}function QI(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function km(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?QI(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):QI(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}let Mm=1;function qj(t,e,n,i,r){Mm+=1;let o={sid:n.sid,command:"convergeAllocateEdge",uid:"666",appId:n.appId,ts:Math.floor(Date.now()/1e3),seq:Mm,requestId:Mm,version:vi,cname:n.cname},s={service_name:e,json_body:JSON.stringify(o)},a,c,d=t[0];return ar(async()=>{a=Date.now();let l=await ur(d,{data:s,cancelToken:i,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(c=Date.now()-a,l.code!==0){let p=new w(R.UNEXPECTED_RESPONSE,"live streaming ap error, code"+l.code,{retry:!0,responseTime:c});throw _.error(p.toString()),p}let u=JSON.parse(l.json_body);if(u.code!==200){let p=new w(R.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(u.code,", reason: ").concat(u.reason),{code:u.code,responseTime:c});throw _.error(p.toString()),p}if(!u.servers||u.servers.length===0){let p=new w(R.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:u.code,responseTime:c});throw _.error(p.toString()),p}let h=function(p,T){return {addressList:p.servers.map(m=>"wss://".concat(m.address.replace(/\./g,"-"),".").concat(v("WORKER_DOMAIN"),":").concat(m.wss,"?serviceName=").concat(encodeURIComponent(T))),workerToken:p.workerToken,vid:p.vid}}(u,e);return v("LIVE_STREAMING_ADDRESS")&&(h.addressList=v("LIVE_STREAMING_ADDRESS")instanceof Array?v("LIVE_STREAMING_ADDRESS"):[v("LIVE_STREAMING_ADDRESS")]),km(km({},h),{},{responseTime:c})},(l,u)=>(et.apworkerEvent(n.sid,{success:!0,sc:200,serviceName:e,responseDetail:JSON.stringify(l.addressList),firstSuccess:u===0,responseTime:c,serverIp:t[u%t.length]}),!1),(l,u)=>(et.apworkerEvent(n.sid,{success:!1,sc:l.data&&l.data.code||200,serviceName:e,responseTime:c,serverIp:t[u%t.length]}),!!(l.code!==R.OPERATION_ABORTED&&l.code!==R.UNEXPECTED_RESPONSE||l.data&&l.data.retry)&&(d=t[(u+1)%t.length],!0)),r)}let Um=1;function ZI(t,e,n,i){let{url:r,areaCode:o}=t,{clientId:s,sid:a}=e,c=Date.now(),d,[l,u]=Vm(e,o,[De.CHOOSE_SERVER]),h=Te.networkState;return ar(async()=>{h&&Te.networkState===On.OFFLINE&&Te.onlineWaiter&&await K.race([Te.onlineWaiter,Ye(i&&i.maxRetryTimeout||Ne.maxRetryTimeout)]),h=Te.networkState;let{data:p,headers:T}=await ur(r,{data:l,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);d=T.http3==="1"?1:-1,et.reportResourceTiming(r,a),ty(p,r,e,c,[De.CHOOSE_SERVER],d);let m=qc(p,De.CHOOSE_SERVER);return xm(m),wm(m,r)},p=>(p&&et.joinChooseServer(a,{lts:c,succ:!0,csAddr:r,opid:u,serverList:p.gatewayAddrs.map(T=>T.address),ec:null,cid:p.cid.toString(),uid:p.uid.toString(),csIp:p.csIp,unilbsServerIds:[De.CHOOSE_SERVER].toString(),isHttp3:d}),!1),p=>p.code!==R.OPERATION_ABORTED&&(p.code===R.CAN_NOT_GET_GATEWAY_SERVER?p.data.retry:(et.joinChooseServer(a,{lts:c,succ:!1,csAddr:r,serverList:null,opid:u,ec:p.code,csIp:p.data&&p.data.csIp,unilbsServerIds:[De.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:h}),isHttp3:d}),_.warning("[".concat(s||"sid-".concat(a.slice(0,6)),"] Choose server network error, retry"),p),!0)),i)}function $I(t,e,n,i){let r,{url:o,areaCode:s,serviceIds:a}=t,c=Date.now(),[d,l]=Vm(e,s,a),u;return ar(async()=>{u&&Te.networkState===On.OFFLINE&&Te.onlineWaiter&&await K.race([Te.onlineWaiter,Ye(i&&i.maxRetryTimeout||Ne.maxRetryTimeout)]),u=Te.networkState;let{data:h,headers:p}=await ur(o,{data:d,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);r=p.http3==="1"?1:-1,et.reportResourceTiming(o,e.sid),ty(h,o,e,c,a,r);let T=qc(h,De.CHOOSE_SERVER),m=qc(h,e.cloudProxyServer==="proxy5"?De.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?De.CLOUD_PROXY:De.CLOUD_PROXY_FALLBACK);return xm(T),{gatewayInfo:wm(T,o),proxyInfo:m,url:o}},h=>(h.gatewayInfo&&et.joinChooseServer(e.sid,{lts:c,succ:!0,csAddr:o,serverList:h.gatewayInfo.gatewayAddrs.map(p=>p.address),ec:null,opid:l,cid:h.gatewayInfo.cid.toString(),uid:h.gatewayInfo.uid.toString(),csIp:h.gatewayInfo.csIp,unilbsServerIds:a.toString(),isHttp3:r}),h.proxyInfo&&et.joinWebProxyAP(e.sid,{lts:c,sucess:1,apServerAddr:o,turnServerAddrList:h.proxyInfo.addresses.map(p=>p.ip).join(","),errorCode:null,eventType:e.cloudProxyServer,unilbsServerIds:a.toString()}),!1),h=>h.code!==R.OPERATION_ABORTED&&(h.code===R.CAN_NOT_GET_GATEWAY_SERVER?h.data.retry:(et.joinWebProxyAP(e.sid,{lts:c,sucess:0,apServerAddr:o,turnServerAddrList:null,errorCode:h.code,eventType:e.cloudProxyServer,unilbsServerIds:a.toString(),extend:JSON.stringify({networkState:u})}),_.warning("[".concat(e.clientId,"] multi unilbs network error, retry"),h),!0)),i)}let ty=(t,e,n,i,r,o)=>{let{sid:s,clientId:a,cloudProxyServer:c}=n,d=[],l=u=>{u.flag===4096?et.joinChooseServer(s,{lts:i,succ:!1,csAddr:e,opid:t.opid,serverList:null,ec:u.error.message,csIp:u.error.data&&u.error.data.csIp,unilbsServerIds:r.toString(),isHttp3:o}):u.flag!==1048576&&u.flag!==4194304&&u.flag!==4194310||et.joinWebProxyAP(s,{lts:i,sucess:0,apServerAddr:e,turnServerAddrList:null,errorCode:u.error.code,eventType:c,unilbsServerIds:r.toString()});};if(t.response_body.forEach(u=>{let h=u.buffer.code;if(u.uri===23&&h===0&&!u.buffer.edges_services)if(u.buffer.flag===4194310)_.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),u.buffer.edges_services=[];else {let p={error:new w(R.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:t.detail[502]}),flag:u.buffer.flag};d.push(p),l(p);}if(h!==0){let p=va(h),T={error:new w(R.CAN_NOT_GET_GATEWAY_SERVER,p.desc,{desc:p.desc,retry:p.retry,csIp:t.detail[502]}),flag:u.buffer.flag};u.buffer.flag===4194310?_.warning(T.error.toString()):d.push(T),l(T);}}),d.length)throw _.warning("[".concat(a||"sid-".concat(s.slice(0,6)),"] multi unilbs ").concat(e," failed, ").concat(d.map(u=>"flag: ".concat(u.flag,", message: ").concat(u.error.message,", retry: ").concat(u.error.data.retry)).join(" | "))),new w(R.CAN_NOT_GET_GATEWAY_SERVER,d.map(u=>"flag: ".concat(u.flag,", message: ").concat(u.error.message)).join(" | "),{retry:!!d.find(u=>u.error.data.retry),csIp:t.detail[502],desc:[...new Set(d.map(u=>{var h;return u==null||(h=u.error)===null||h===void 0||(h=h.data)===null||h===void 0?void 0:h.desc}).filter(u=>!!u))]})},xm=t=>{var e,n,i,r;if(t.addresses&&t.addresses.length===0&&t.code===0)throw new w(R.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:t.detail&&t.detail[502]});if(v("AP_AREA")&&((i=t.detail)!==null&&i!==void 0&&i[23]&&typeof((r=t.detail)===null||r===void 0?void 0:r[23])=="string"?XI(t.detail[23].toLowerCase()):XI()),(e=t.detail)!==null&&e!==void 0&&e[19]&&typeof((n=t.detail)===null||n===void 0?void 0:n[19])=="string"){let s=t.detail[19],a=s?.split(";");for(let c=0;c<a.length;c++){var o;let d=vn(o=a[c]).call(o);t.addresses[c]&&a&&(t.addresses[c].fingerprint=d);}}if(v("GATEWAY_ADDRESS")&&v("GATEWAY_ADDRESS").length>0){_.debug("assign gateway address to",v("GATEWAY_ADDRESS"));let s=v("GATEWAY_ADDRESS").map(a=>{var c,d;let l=(c=(d=t.addresses.find(u=>u.ip===a.ip&&u.port===a.port))===null||d===void 0?void 0:d.fingerprint)!==null&&c!==void 0?c:"";return {ip:a.ip,port:a.port,ticket:t.addresses[0]&&t.addresses[0].ticket,fingerprint:l}});t.addresses=s;}},zj=(t,e)=>{if(t.response_body&&t.response_body.length){let n=t.response_body[0];if(n.buffer.code!==0){let i=va(n.buffer.code);throw new w(R.UPDATE_TICKET_FAILED,"[".concat(n.buffer.code,"]: ").concat(i.desc),{retry:i.retry})}return n.buffer.ticket}throw _.debug("update ticket request received ap response without response body:",e),new w(R.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},Vm=(t,e,n)=>{let i=Math.floor(Math.random()*1e12),r={appid:t.appId,client_ts:Date.now(),opid:i,sid:t.sid,request_bodies:[{uri:22,buffer:{cname:t.cname,detail:km({6:t.stringUid,11:e,12:v("USE_NEW_TOKEN")?"1":void 0,22:e},t.apRTM?{26:"RTM2"}:{}),key:t.token,service_ids:n,uid:t.uid||0}}]};r.request_bodies.forEach(s=>{t.multiIP&&t.multiIP.gateway_ip&&(s.buffer.detail[5]=JSON.stringify({vocs_ip:[t.multiIP.uni_lbs_ip],vos_ip:[t.multiIP.gateway_ip]}));});let o=new FormData;return o.append("request",JSON.stringify(r)),[o,i]},Jj=(t,e)=>{let n=Math.floor(Math.random()*1e12),i={appid:t.appId,client_ts:Date.now(),opid:n,sid:t.sid,request_bodies:[{uri:28,buffer:{cname:t.cname,detail:{1:"",6:t.stringUid,12:"1"},token:t.token,service_ids:e,uid:t.uid||0,edges_services:t.apResponse.addresses.map(o=>({ip:o.ip,port:o.port}))}}]},r=new FormData;return r.append("request",JSON.stringify(i)),[r,n]},Ia=0;function ya(t){return K.all(t.map(e=>e.then(n=>{throw n},n=>n))).then(e=>{throw e},e=>e)}let Jc=async t=>{let{fragementLength:e,referenceList:n,asyncMapHandler:i,allFailedhandler:r,promisesCollector:o}=t,s=0,a=e,c,d=0,l=async()=>{let u=(()=>{let h=s*a,p=h+a;return n.slice(h,p).map(i)})();o&&o.push(...u);try{c=await ya(u);}catch(h){if(d+=a,s++,!(d>=n.length))return void await l();r(h);}u.forEach(h=>h.cancel());};return await l(),c},ey=async t=>{let{referenceList:e,asyncMapHandler:n,closeFn:i}=t,r=e.length,o=0,s=async()=>{let a=n(e.shift());try{return await a}catch(c){if(o++,o>=r||i!=null&&i(c))throw c;return s()}};return s()};async function Fm(t,e,n,i){return {gatewayInfo:await async function(o,s,a,c){let d=null,l=[],u=async()=>{let p=v("WEBCS_DOMAIN").slice(0,v("AJAX_REQUEST_CONCURRENT")).map(E=>({url:o.proxyServer?"https://".concat(o.proxyServer,"/ap/?url=").concat(E+"/api/v2/transpond/webrtc?v=2"):"https://".concat(E,"/api/v2/transpond/webrtc?v=2"),areaCode:zc()})),T=c.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map(E=>E.url)}),m=await Jc({fragementLength:v("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:E=>(_.debug("[".concat(o.clientId,"] Connect to choose_server:"),E.url),ZI(E,o,s,a)),allFailedhandler:E=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:E},T),E[0]},promisesCollector:l});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},T),m},h=async()=>{if(await Ye(1e3),d!==null)return d;let p=v("WEBCS_DOMAIN_BACKUP_LIST").map(E=>({url:o.proxyServer?"https://".concat(o.proxyServer,"/ap/?url=").concat(E+"/api/v2/transpond/webrtc?v=2"):"https://".concat(E,"/api/v2/transpond/webrtc?v=2"),areaCode:zc()})),T=c.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map(E=>E.url)}),m=await Jc({fragementLength:v("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:E=>(_.debug("[".concat(o.clientId,"] Connect to backup choose_server:"),E.url),ZI(E,o,s,a)),allFailedhandler:E=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:E},T),E[0]},promisesCollector:l});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},T),m};try{return d=await ya([u(),h()]),l.length&&l.forEach(p=>p.cancel&&typeof p.cancel=="function"&&p.cancel()),d}catch(p){throw p[0]}}(t,e,n,i)}}async function ny(t,e,n,i,r){let o=t.cloudProxyServer;if(o==="disabled"){if(t.useLocalAccessPoint)return await Fm(t,e,n,r);if(v("JOIN_WITH_FALLBACK_MEDIA_PROXY")){let{gatewayInfo:h,proxyInfo:p}=await oy(t,e,n,r);if(t.turnServer&&t.turnServer.mode!=="auto")return {gatewayInfo:h};let T=p.map(m=>({turnServerURL:m.address,tcpport:m.tcpport||ln.tcpport,udpport:m.udpport||ln.udpport,username:m.username||ln.username,password:m.password||ln.password,forceturn:!1,security:!0}));if(r.useP2P){var s;let m=(s=t.uid)!==null&&s!==void 0?s:h.uid,E="glb:".concat(m.toString()),S=await cm(E),C=p.map(A=>({turnServerURL:A.address,tcpport:A.tcpport||ln.tcpport,udpport:A.udpport||ln.udpport,username:E,password:S,forceturn:!1,security:!0}));T.push(...C);}return t.turnServer={mode:"manual",servers:T},{gatewayInfo:h}}return await Fm(t,e,n,r)}let{proxyInfo:a,gatewayInfo:c}=await oy(t,e,n,r),d={gatewayInfo:c},l=a.map(h=>({turnServerURL:h.address,tcpport:o==="proxy3"?void 0:h.tcpport?h.tcpport:ln.tcpport,udpport:o==="proxy4"?void 0:h.udpport?h.udpport:ln.udpport,username:h.username||ln.username,password:h.password||ln.password,forceturn:o!=="proxy4",security:o==="proxy5"}));if(r.useP2P){var u;let h=(u=t.uid)!==null&&u!==void 0?u:c.uid,p="glb:".concat(h.toString()),T=await cm(p),m=a.map(E=>({turnServerURL:E.address,tcpport:o==="proxy3"?void 0:E.tcpport||ln.tcpport,udpport:o==="proxy4"?void 0:E.udpport||ln.udpport,username:p,password:T,forceturn:o!=="proxy4",security:o==="proxy5"}));l.push(...m);}return t.turnServer={mode:"manual",servers:l},_.debug("[".concat(t.clientId,"] set proxy server: ").concat(t.proxyServer,", mode: ").concat(o)),d}async function iy(t,e,n,i,r){let o=v("ACCOUNT_REGISTER").slice(0,v("AJAX_REQUEST_CONCURRENT")),s=[];s=e.proxyServer?o.map(c=>"https://".concat(e.proxyServer,"/ap/?url=").concat(c+"/api/v1")):o.map(c=>"https://".concat(c,"/api/v1"));let a=r?.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:s});try{let c=await async function(d,l,u,h,p){let T=Date.now(),m={sid:u.sid,opid:10,appid:u.appId,string_uid:l},E=d[0],S=await ar(()=>ur(E+"".concat(E.indexOf("?")===-1?"?":"&","action=stringuid"),{data:m,cancelToken:h,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}}),(C,A)=>{if(C.code===0){if(C.uid<=0||C.uid>=Math.pow(2,32))throw _.error("Invalid Uint Uid ".concat(l," => ").concat(C.uid),C),et.reqUserAccount(m.sid,{lts:T,success:!1,serverAddr:E,stringUid:m.string_uid,uid:C.uid,errorCode:R.INVALID_UINT_UID_FROM_STRING_UID,extend:m}),new w(R.INVALID_UINT_UID_FROM_STRING_UID);return et.reqUserAccount(m.sid,{lts:T,success:!0,serverAddr:E,stringUid:m.string_uid,uid:C.uid,errorCode:null,extend:m}),!1}let b=va(C.code);return b.retry&&(E=d[(A+1)%d.length]),et.reqUserAccount(m.sid,{lts:T,success:!1,serverAddr:E,stringUid:m.string_uid,uid:C.uid,errorCode:b.desc,extend:m}),b.retry},(C,A)=>C.code!==R.OPERATION_ABORTED&&(et.reqUserAccount(m.sid,{lts:T,success:!1,serverAddr:E,stringUid:m.string_uid,uid:null,errorCode:C.code,extend:m}),E=d[(A+1)%d.length],!0),p);if(S.code!==0){let C=va(S.code);throw new w(R.UNEXPECTED_RESPONSE,C.desc)}return S}(s,t,e,n,i);return r?.recordJoinChannelService({status:"success",endTs:Date.now()},a),c.uid}catch(c){throw r?.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[c]},a),c}}async function Xj(t,e,n){let i=v("ACCOUNT_REGISTER"),r=[];r=e.proxyServer?i.map(o=>"https://".concat(e.proxyServer,"/ap/?url=").concat(o+"/api/v1")):i.map(o=>"https://".concat(o,"/api/v1"));try{return await ey({referenceList:r,asyncMapHandler:s=>async function(a,c,d,l){let u=Date.now(),h={sid:d.sid,opid:10,appid:d.appId,string_uid:c};try{let p=await ur(a+"".concat(a.indexOf("?")===-1?"?":"&","action=stringuid"),{data:h,cancelToken:l,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}});if(p.code!==0){let T=va(p.code);throw new w(R.UNEXPECTED_RESPONSE,"preload sua error:".concat(T.desc),T)}if(p.uid<=0||p.uid>=Math.pow(2,32))throw new w(R.INVALID_UINT_UID_FROM_STRING_UID);return {requestTime:u,url:a,req:h,uid:p.uid,elapse:Date.now()-u}}catch(p){throw p}}(s,t,e,n),closeFn:s=>s.code===R.OPERATION_ABORTED||s.code===R.UNEXPECTED_RESPONSE&&!s.data.retry})}catch(o){throw o}}async function Qj(t,e,n){let i=v("CDS_AP").slice(0,v("AJAX_REQUEST_CONCURRENT")).map(c=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(c+"/api/v1"):"https://".concat(c,"/api/v1?action=config")),r=i.map(c=>function(d,l,u,h){let p=Pt(),T={flag:64,cipher_method:0,features:{device:p.name,system:p.os,system_general:navigator.userAgent,vendor:l.appId,version:vi,cname:l.cname,sid:l.sid,session_id:l.sid,detail:"",proxyServer:l.proxyServer}};return ar(()=>ur(d,{data:T,timeout:1e3,cancelToken:u,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}}),void 0,m=>m.code!==R.OPERATION_ABORTED,h)}(c,t,e,n)),o=null,s=null,a={};try{o=await ya(r);}catch(c){if(c.code===R.OPERATION_ABORTED)throw c;s=c;}if(r.forEach(c=>c.cancel()),et.reportApiInvoke(t.sid,{name:ke.REQUEST_CONFIG_DISTRIBUTE,options:{error:s,res:o}}).onSuccess(),o&&o.test_tags)try{a=function(c){if(!c.test_tags)return {};let d=c.test_tags,l=Object.keys(d),u={};return l.forEach(h=>{var p;let T=vn(p=h.slice(4)).call(p),m=JSON.parse(d[h])[1];u[T]=m;}),u}(o);}catch{}return a}async function ry(t,e){let n=v("WEBCS_DOMAIN").concat(v("WEBCS_DOMAIN_BACKUP_LIST")).map(i=>({url:"https://".concat(i,"/api/v2/transpond/webrtc?v=2"),areaCode:zc(),serviceIds:[De.CHOOSE_SERVER,De.CLOUD_PROXY_FALLBACK]}));try{return await ey({referenceList:n,asyncMapHandler:r=>async function(o,s,a){let c,{url:d,areaCode:l,serviceIds:u}=o,h=Date.now(),[p,T]=Vm(s,l,u),m=Te.networkState;try{m&&Te.networkState===On.OFFLINE&&Te.onlineWaiter&&await K.race([Te.onlineWaiter,Ye(Ne.maxRetryTimeout)]),m=Te.networkState;let{data:E,headers:S}=await ur(d,{data:p,cancelToken:a,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);c=S.http3==="1"?1:-1,(O=>{let N=[];if(O.response_body.forEach(k=>{let M=k.buffer.code;if(k.uri===23&&M===0&&!k.buffer.edges_services)if(k.buffer.flag===4194310)k.buffer.edges_services=[];else {let x={error:new w(R.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:O.detail[502]}),flag:k.buffer.flag};N.push(x);}if(M!==0){let x=va(M),X={error:new w(R.CAN_NOT_GET_GATEWAY_SERVER,x.desc,{desc:x.desc,retry:x.retry,csIp:O.detail[502]}),flag:k.buffer.flag};k.buffer.flag===4194310?_.warning(X.error.toString()):N.push(X);}}),N.length)throw new w(R.CAN_NOT_GET_GATEWAY_SERVER,N.map(k=>"flag: ".concat(k.flag,", message: ").concat(k.error.message)).join(" | "),{retry:!!N.find(k=>k.error.data.retry),csIp:O.detail[502],desc:[...new Set(N.map(k=>{var M;return k==null||(M=k.error)===null||M===void 0||(M=M.data)===null||M===void 0?void 0:M.desc}).filter(k=>!!k))]})})(E);let A=qc(E,De.CHOOSE_SERVER),b=qc(E,De.CLOUD_PROXY_FALLBACK);return xm(A),{gatewayInfo:wm(A,d),proxyInfo:b,opid:T,requestTime:h,url:d,isHttp3:c,elapse:Date.now()-h}}catch(E){throw E}}(r,t,e),closeFn:r=>r.code===R.OPERATION_ABORTED||r.code===R.CAN_NOT_GET_GATEWAY_SERVER&&!r.data.retry})}catch(i){throw i}}async function oy(t,e,n,i){let r=v("PROXY_SERVER_TYPE3"),o=(p,T,m)=>{let E=m||r;return Array.isArray(E)&&(E=T%2==0?r[1]:r[0]),"https://".concat(E,"/ap/?url=").concat(p)},s=null,a=[],c=async()=>{let p=v("WEBCS_DOMAIN").slice(0,v("AJAX_REQUEST_CONCURRENT")).map((E,S)=>{let C;return C=t.cloudProxyServer==="disabled"&&t.proxyServer?o("".concat(E,"/api/v2/transpond/webrtc?v=2"),S,t.proxyServer):t.cloudProxyServer==="disabled"||t.cloudProxyServer==="fallback"?"https://".concat(E,"/api/v2/transpond/webrtc?v=2"):o("".concat(E,"/api/v2/transpond/webrtc?v=2"),S),{url:C,areaCode:zc(),serviceIds:[De.CHOOSE_SERVER,t.cloudProxyServer==="proxy5"?De.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?De.CLOUD_PROXY:De.CLOUD_PROXY_FALLBACK]}}),T=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map(E=>E.url)}),m=await Jc({fragementLength:v("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:E=>(_.debug("[".concat(t.clientId,"] Connect to choose_server:"),E.url),$I(E,t,e,n)),allFailedhandler:E=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:E},T),E[0]},promisesCollector:a});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},T),m},d=async()=>{if(await Ye(1e3),s!==null)return s;let p=v("WEBCS_DOMAIN_BACKUP_LIST").map((E,S)=>{let C;return C=t.cloudProxyServer==="disabled"&&t.proxyServer?o("".concat(E,"/api/v2/transpond/webrtc?v=2"),S,t.proxyServer):t.cloudProxyServer==="disabled"||t.cloudProxyServer==="fallback"?"https://".concat(E,"/api/v2/transpond/webrtc?v=2"):o("".concat(E,"/api/v2/transpond/webrtc?v=2"),S),{url:C,areaCode:zc(),serviceIds:[De.CHOOSE_SERVER,t.cloudProxyServer==="proxy5"?De.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?De.CLOUD_PROXY:De.CLOUD_PROXY_FALLBACK]}}),T=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map(E=>E.url)}),m=await Jc({fragementLength:v("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:E=>(_.debug("[".concat(t.clientId,"] Connect to backup choose_server:"),E.url),$I(E,t,e,n)),allFailedhandler:E=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:E},T),E[0]},promisesCollector:a});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},T),m},l,u,h;try{({gatewayInfo:l,proxyInfo:u,url:h}=await ya([c(),d()]));}catch(p){throw p[0]}if(a.length&&a.forEach(p=>p.cancel&&typeof p.cancel=="function"&&p.cancel()),!l||!u)throw new w(R.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(t.apUrl=h,t.cloudProxyServer!=="disabled"&&Array.isArray(r)&&h){let p=/^https?:\/\/(.+?)(\/.*)?$/.exec(h)[1];q(r).call(r,p)&&(t.proxyServer=p,_.setProxyServer(p),et.setProxyServer(p));}return s={gatewayInfo:l,proxyInfo:await HI(u,l.uid)},s}async function sy(t,e,n,i){let r=v("UAP_AP").slice(0,v("AJAX_REQUEST_CONCURRENT")).map(o=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(o+"/api/v1?action=uap"):"https://".concat(o,"/api/v1?action=uap"));return await qj(r,t,e,n,i)}async function Zj(t,e,n){let i=v("UAP_AP").slice(0,v("AJAX_REQUEST_CONCURRENT")).map(o=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(o+"/api/v1?action=uap"):"https://".concat(o,"/api/v1?action=uap")),r=i.map(o=>function(s,a,c,d){let l={command:"convergeAllocateEdge",sid:a.sid,appId:a.appId,token:a.token,ts:Date.now(),version:vi,cname:a.cname,uid:a.uid.toString(),requestId:Um,seq:Um};Um+=1;let u={service_name:"tele_channel",json_body:JSON.stringify(l)};return ar(async()=>{let h=await ur(s,{data:u,cancelToken:c,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(h.code!==0){let T=new w(R.UNEXPECTED_RESPONSE,"cross channel ap error, code"+h.code,{retry:!0});throw _.error(T.toString()),T}let p=JSON.parse(h.json_body);if(p.code!==200){let T=new w(R.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(p.code,", reason: ").concat(p.reason));throw _.error(T.toString()),T}if(!p.servers||p.servers.length===0){let T=new w(R.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw _.error(T.toString()),T}return {vid:p.vid,workerToken:p.workerToken,addressList:(v("CHANNEL_MEDIA_RELAY_SERVERS")||p.servers).map(T=>"wss://".concat(T.address.replace(/\./g,"-"),".").concat(v("WORKER_DOMAIN"),":").concat(T.wss))}},void 0,h=>!!(h.code!==R.OPERATION_ABORTED&&h.code!==R.UNEXPECTED_RESPONSE||h.data&&h.data.retry),d)}(o,t,e,n));try{let o=await ya(r);return r.forEach(s=>s.cancel()),o}catch(o){throw o[0]}}async function $j(t,e,n){let i=null,r=[],o=async s=>{let a=v(s?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map(c=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(c+"/api/v2/transpond/webrtc?v=2"):"https://".concat(c,"/api/v2/transpond/webrtc?v=2"));return s&&(await Ye(1e3),i!==null)?i:await Jc({fragementLength:v("FRAGEMENT_LENGTH"),referenceList:a,asyncMapHandler:c=>(_.debug("[".concat(t.clientId,"] update ticket, Connect to ").concat(s?"backup":""," choose_server:"),c),function(d,l,u,h){let[p]=Jj(l,[De.CHOOSE_SERVER]),T=Te.networkState;return ar(async()=>{T&&Te.networkState===On.OFFLINE&&Te.onlineWaiter&&await K.race([Te.onlineWaiter,Ye(h&&h.maxRetryTimeout||Ne.maxRetryTimeout)]),T=Te.networkState;let m=await ur(d,{data:p,cancelToken:u,headers:{"Content-Type":"multipart/form-data;"}},!0);return zj(m,d)},()=>!1,m=>m.code!==R.OPERATION_ABORTED&&(m.code===R.UPDATE_TICKET_FAILED?m.data.retry:(_.warning("[".concat(l.clientId,"] update ticket network error, retry"),m),!0)),h)}(c,t,e,n)),allFailedhandler:c=>{throw c[0]},promisesCollector:r})};try{return i=await ya([o(!1),o(!0)]),r.length&&r.forEach(s=>s.cancel&&typeof s.cancel=="function"&&s.cancel()),i}catch(s){throw s[0]}}function ay(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function cy(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?ay(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ay(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}class tG extends de{get isSuccess(){return !!this.configs}constructor(){super(),g(this,"configs",void 0),g(this,"joinInfo",void 0),g(this,"cancelToken",void 0),g(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),g(this,"interval",void 0),g(this,"mutex",new Qe("config-distribute")),g(this,"mutableParamsRead",!1);}startGetConfigDistribute(e,n){this.joinInfo=e,this.cancelToken=n,this.interval&&this.stopGetConfigDistribute(),v("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval(()=>{this.updateConfigDistribute();},v("CONFIG_DISTRIBUTE_INTERVAL")));}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0;}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())();}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,et.reportApiInvoke(null,{options:void 0,name:ke.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:ge.TRACER}).onSuccess(JSON.stringify(bo))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void _.debug("[config-distribute] get config distribute interrupted have no joininfo");let e,n=await this.mutex.lock();try{e=await Qj(this.joinInfo,this.cancelToken,this.retryConfig),_.debug("[config-distribute] get config distribute",JSON.stringify(e)),e.limit_bitrate&&this.handleBitrateLimit(e.limit_bitrate),this.cacheGlobalParameterConfig(e),this.configs=e;}catch(i){let r=new w(R.NETWORK_RESPONSE_ERROR,i);_.warning("[config-distribute] ".concat(r.toString()));}finally{n();}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(e){var n;(n=e)&&n.uplink&&n.id&&n.uplink.max_bitrate!==void 0&&n.uplink.min_bitrate!==void 0&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==e.id&&this.emit(Am.UPDATE_BITRATE_LIMIT,e):this.emit(Am.UPDATE_BITRATE_LIMIT,e));}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&cy({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(e){var n;let i=vc(n=Object.keys(e).filter(o=>/^webrtc_ng_global_parameter/.test(o))).call(n);for(let o=0;o<i.length;o++)for(let s=i.length-1;s>o;s--){let a=i[s];if(typeof e[a].__priority=="number"){let c=e[a].__priority,d=i[s-1];if(typeof e[d].__priority=="number"){if(!(c>e[d].__priority))continue;{let l=a;i[s]=i[s-1],i[s-1]=l;}}else {let l=a;i[s]=i[s-1],i[s-1]=l;}}}let r={};i.forEach(o=>{let s=e[o],a=s.__expires;Object.keys(s).forEach(c=>{c==="__priority"||c==="__expires"||Object.prototype.hasOwnProperty.call(r,c)||(r[c]=cy({value:s[c]},a&&{expires:a}));});});try{(function(a){try{let c=Date.now();Object.keys(a).forEach(d=>{switch(d){case"ENABLE_EVENT_REPORT":case"UPLOAD_LOG":case"ENABLE_AG_ADAPTATION":case"FORCE_AG_HIGH_FRAMERATE":case"FORCE_SUPPORT_AG_ADAPTATION":case"ENCODER_CONFIG_LIMIT":case"CAMERA_CAPTURE_CONFIG":case"ENABLE_PRELOAD":if(Object.prototype.hasOwnProperty.call(Fe,d)){let{value:l,expires:u}=a[d];if(u&&u<=c)return;bo[d]=l,Fe[d]=l,_.debug("Update global parameters from config distribute",d,l);}}});}catch(c){_.error("Error update config immediately: ".concat(a),c.message);}})(r);let o=JSON.stringify(r),s=window.btoa(o);window.localStorage.setItem("websdk_ng_global_parameter",s),_.debug("Caching global parameters ".concat(o));}catch(o){_.error("Error caching global parameters:",o.message);}}}var Wi,eG=j(wI),dy=Si,nG=Et,iG=an,rG=H,Bm=zd,oG=hc,sG=Md,aG=Rr,cG=xd,Aa=Object.assign,ly=Object.defineProperty,dG=nG([].concat),lG=!Aa||rG(function(){if(dy&&Aa({b:1},Aa(ly({},"a",{enumerable:!0,get:function(){ly(this,"b",{value:3,enumerable:!1});}}),{b:2})).b!==1)return !0;var t={},e={},n=Symbol(),i="abcdefghijklmnopqrst";return t[n]=7,i.split("").forEach(function(r){e[r]=r;}),Aa({},t)[n]!=7||Bm(Aa({},e)).join("")!=i})?function(t,e){for(var n=aG(t),i=arguments.length,r=1,o=oG.f,s=sG.f;i>r;)for(var a,c=cG(arguments[r++]),d=o?dG(Bm(c),o(c)):Bm(c),l=d.length,u=0;l>u;)a=d[u++],dy&&!iG(s,c,a)||(n[a]=c[a]);return n}:Aa,uG=jn,hG=Gg,pG=_o,_G=an,mG=Rr,EG=function(t,e,n,i){try{return i?e(uG(n)[0],n[1]):e(n)}catch(r){hG(t,"throw",r);}},fG=Fg,gG=sl,TG=qr,uy=Tl,SG=ip,RG=Qd,hy=Array,Ss=Et,jm=2147483647,CG=/[^\0-\u007E]/,py=/[.\u3002\uFF0E\uFF61]/g,_y="Overflow: input needs wider integers to process",my=RangeError,vG=Ss(py.exec),ba=Math.floor,Gm=String.fromCharCode,Ey=Ss("".charCodeAt),fy=Ss([].join),Lo=Ss([].push),IG=Ss("".replace),yG=Ss("".split),AG=Ss("".toLowerCase),gy=function(t){return t+22+75*(t<26)},bG=function(t,e,n){var i=0;for(t=n?ba(t/700):t>>1,t+=ba(t/e);t>455;)t=ba(t/35),i+=36;return ba(i+36*t/(t+38))},wG=function(t){var e=[];t=function(S){for(var C=[],A=0,b=S.length;A<b;){var O=Ey(S,A++);if(O>=55296&&O<=56319&&A<b){var N=Ey(S,A++);(64512&N)==56320?Lo(C,((1023&O)<<10)+(1023&N)+65536):(Lo(C,O),A--);}else Lo(C,O);}return C}(t);var n,i,r=t.length,o=128,s=0,a=72;for(n=0;n<t.length;n++)(i=t[n])<128&&Lo(e,Gm(i));var c=e.length,d=c;for(c&&Lo(e,"-");d<r;){var l=jm;for(n=0;n<t.length;n++)(i=t[n])>=o&&i<l&&(l=i);var u=d+1;if(l-o>ba((jm-s)/u))throw my(_y);for(s+=(l-o)*u,o=l,n=0;n<t.length;n++){if((i=t[n])<o&&++s>jm)throw my(_y);if(i==o){for(var h=s,p=36;;){var T=p<=a?1:p>=a+26?26:p-a;if(h<T)break;var m=h-T,E=36-T;Lo(e,Gm(gy(T+m%E))),h=ba(m/E),p+=36;}Lo(e,Gm(gy(h))),a=bG(s,u,d==c),s=0,d++;}}s++,o++;}return fy(e,"")},OG=ee,Wm=Si,NG=D_,Hm=Vt,Ty=_o,Hi=Et,uu=Eo,Ki=ol,DG=Ep,Km=_n,Ym=lG,wa=function(t){var e=mG(t),n=gG(this),i=arguments.length,r=i>1?arguments[1]:void 0,o=r!==void 0;o&&(r=pG(r,i>2?arguments[2]:void 0));var s,a,c,d,l,u,h=RG(e),p=0;if(!h||this===hy&&fG(h))for(s=TG(e),a=n?new this(s):hy(s);s>p;p++)u=o?r(e[p],p):e[p],uy(a,p,u);else for(l=(d=SG(e,h)).next,a=n?new this:[];!(c=_G(l,d)).done;p++)u=o?EG(d,r,[c.value,p],!0):c.value,uy(a,p,u);return a.length=p,a},hr=o_,PG=qp.codeAt,LG=function(t){var e,n,i=[],r=yG(IG(AG(t),py,"."),".");for(e=0;e<r.length;e++)n=r[e],Lo(i,vG(CG,n)?"xn--"+wG(n):n);return fy(i,".")},eo=Ri,kG=fo,MG=al,Sy=BF,Ry=os,UG=Ry.set,hu=Ry.getterFor("URL"),xG=Sy.URLSearchParams,VG=Sy.getState,Xc=Hm.URL,qm=Hm.TypeError,pu=Hm.parseInt,FG=Math.floor,Cy=Math.pow,Yi=Hi("".charAt),pr=Hi(/./.exec),Qc=Hi([].join),BG=Hi(1 .toString),jG=Hi([].pop),Oa=Hi([].push),zm=Hi("".replace),GG=Hi([].shift),WG=Hi("".split),Zc=Hi("".slice),_u=Hi("".toLowerCase),HG=Hi([].unshift),Jm="Invalid scheme",Rs="Invalid host",vy="Invalid port",Iy=/[a-z]/i,KG=/[\d+-.a-z]/i,Xm=/\d/,YG=/^0x/i,qG=/^[0-7]+$/,zG=/^\d+$/,yy=/^[\da-f]+$/i,JG=/[\0\t\n\r #%/:<>?@[\\\]^|]/,XG=/[\0\t\n\r #/:<>?@[\\\]^|]/,QG=/^[\u0000-\u0020]+/,ZG=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,$G=/[\t\n\r]/g,$c=function(t){var e,n,i,r;if(typeof t=="number"){for(e=[],n=0;n<4;n++)HG(e,t%256),t=FG(t/256);return Qc(e,".")}if(typeof t=="object"){for(e="",i=function(o){for(var s=null,a=1,c=null,d=0,l=0;l<8;l++)o[l]!==0?(d>a&&(s=c,a=d),c=null,d=0):(c===null&&(c=l),++d);return d>a&&(s=c,a=d),s}(t),n=0;n<8;n++)r&&t[n]===0||(r&&(r=!1),i===n?(e+=n?":":"::",r=!0):(e+=BG(t[n],16),n<7&&(e+=":")));return "["+e+"]"}return t},mu={},Ay=Ym({},mu,{" ":1,'"':1,"<":1,">":1,"`":1}),by=Ym({},Ay,{"#":1,"?":1,"{":1,"}":1}),Qm=Ym({},by,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),ko=function(t,e){var n=PG(t,0);return n>32&&n<127&&!Km(e,t)?t:encodeURIComponent(t)},Eu={ftp:21,file:null,http:80,https:443,ws:80,wss:443},td=function(t,e){var n;return t.length==2&&pr(Iy,Yi(t,0))&&((n=Yi(t,1))==":"||!e&&n=="|")},wy=function(t){var e;return t.length>1&&td(Zc(t,0,2))&&(t.length==2||(e=Yi(t,2))==="/"||e==="\\"||e==="?"||e==="#")},tW=function(t){return t==="."||_u(t)==="%2e"},Zm={},Oy={},$m={},Ny={},Dy={},tE={},Py={},Ly={},fu={},gu={},eE={},nE={},iE={},rE={},ky={},oE={},Na={},Pr={},My={},Cs={},no={},sE=function(t,e,n){var i,r,o,s=eo(t);if(e){if(r=this.parse(s))throw qm(r);this.searchParams=null;}else {if(n!==void 0&&(i=new sE(n,!0)),r=this.parse(s,null,i))throw qm(r);(o=VG(new xG)).bindURL(this),this.searchParams=o;}};sE.prototype={type:"URL",parse:function(t,e,n){var i,r,o,s,a,c=this,d=e||Zm,l=0,u="",h=!1,p=!1,T=!1;for(t=eo(t),e||(c.scheme="",c.username="",c.password="",c.host=null,c.port=null,c.path=[],c.query=null,c.fragment=null,c.cannotBeABaseURL=!1,t=zm(t,QG,""),t=zm(t,ZG,"$1")),t=zm(t,$G,""),i=wa(t);l<=i.length;){switch(r=i[l],d){case Zm:if(!r||!pr(Iy,r)){if(e)return Jm;d=$m;continue}u+=_u(r),d=Oy;break;case Oy:if(r&&(pr(KG,r)||r=="+"||r=="-"||r=="."))u+=_u(r);else {if(r!=":"){if(e)return Jm;u="",d=$m,l=0;continue}if(e&&(c.isSpecial()!=Km(Eu,u)||u=="file"&&(c.includesCredentials()||c.port!==null)||c.scheme=="file"&&!c.host))return;if(c.scheme=u,e)return void(c.isSpecial()&&Eu[c.scheme]==c.port&&(c.port=null));u="",c.scheme=="file"?d=rE:c.isSpecial()&&n&&n.scheme==c.scheme?d=Ny:c.isSpecial()?d=Ly:i[l+1]=="/"?(d=Dy,l++):(c.cannotBeABaseURL=!0,Oa(c.path,""),d=My);}break;case $m:if(!n||n.cannotBeABaseURL&&r!="#")return Jm;if(n.cannotBeABaseURL&&r=="#"){c.scheme=n.scheme,c.path=hr(n.path),c.query=n.query,c.fragment="",c.cannotBeABaseURL=!0,d=no;break}d=n.scheme=="file"?rE:tE;continue;case Ny:if(r!="/"||i[l+1]!="/"){d=tE;continue}d=fu,l++;break;case Dy:if(r=="/"){d=gu;break}d=Pr;continue;case tE:if(c.scheme=n.scheme,r==Wi)c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=hr(n.path),c.query=n.query;else if(r=="/"||r=="\\"&&c.isSpecial())d=Py;else if(r=="?")c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=hr(n.path),c.query="",d=Cs;else {if(r!="#"){c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=hr(n.path),c.path.length--,d=Pr;continue}c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=hr(n.path),c.query=n.query,c.fragment="",d=no;}break;case Py:if(!c.isSpecial()||r!="/"&&r!="\\"){if(r!="/"){c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,d=Pr;continue}d=gu;}else d=fu;break;case Ly:if(d=fu,r!="/"||Yi(u,l+1)!="/")continue;l++;break;case fu:if(r!="/"&&r!="\\"){d=gu;continue}break;case gu:if(r=="@"){h&&(u="%40"+u),h=!0,o=wa(u);for(var m=0;m<o.length;m++){var E=o[m];if(E!=":"||T){var S=ko(E,Qm);T?c.password+=S:c.username+=S;}else T=!0;}u="";}else if(r==Wi||r=="/"||r=="?"||r=="#"||r=="\\"&&c.isSpecial()){if(h&&u=="")return "Invalid authority";l-=wa(u).length+1,u="",d=eE;}else u+=r;break;case eE:case nE:if(e&&c.scheme=="file"){d=oE;continue}if(r!=":"||p){if(r==Wi||r=="/"||r=="?"||r=="#"||r=="\\"&&c.isSpecial()){if(c.isSpecial()&&u=="")return Rs;if(e&&u==""&&(c.includesCredentials()||c.port!==null))return;if(s=c.parseHost(u))return s;if(u="",d=Na,e)return;continue}r=="["?p=!0:r=="]"&&(p=!1),u+=r;}else {if(u=="")return Rs;if(s=c.parseHost(u))return s;if(u="",d=iE,e==nE)return}break;case iE:if(!pr(Xm,r)){if(r==Wi||r=="/"||r=="?"||r=="#"||r=="\\"&&c.isSpecial()||e){if(u!=""){var C=pu(u,10);if(C>65535)return vy;c.port=c.isSpecial()&&C===Eu[c.scheme]?null:C,u="";}if(e)return;d=Na;continue}return vy}u+=r;break;case rE:if(c.scheme="file",r=="/"||r=="\\")d=ky;else {if(!n||n.scheme!="file"){d=Pr;continue}if(r==Wi)c.host=n.host,c.path=hr(n.path),c.query=n.query;else if(r=="?")c.host=n.host,c.path=hr(n.path),c.query="",d=Cs;else {if(r!="#"){wy(Qc(hr(i,l),""))||(c.host=n.host,c.path=hr(n.path),c.shortenPath()),d=Pr;continue}c.host=n.host,c.path=hr(n.path),c.query=n.query,c.fragment="",d=no;}}break;case ky:if(r=="/"||r=="\\"){d=oE;break}n&&n.scheme=="file"&&!wy(Qc(hr(i,l),""))&&(td(n.path[0],!0)?Oa(c.path,n.path[0]):c.host=n.host),d=Pr;continue;case oE:if(r==Wi||r=="/"||r=="\\"||r=="?"||r=="#"){if(!e&&td(u))d=Pr;else if(u==""){if(c.host="",e)return;d=Na;}else {if(s=c.parseHost(u))return s;if(c.host=="localhost"&&(c.host=""),e)return;u="",d=Na;}continue}u+=r;break;case Na:if(c.isSpecial()){if(d=Pr,r!="/"&&r!="\\")continue}else if(e||r!="?")if(e||r!="#"){if(r!=Wi&&(d=Pr,r!="/"))continue}else c.fragment="",d=no;else c.query="",d=Cs;break;case Pr:if(r==Wi||r=="/"||r=="\\"&&c.isSpecial()||!e&&(r=="?"||r=="#")){if((a=_u(a=u))===".."||a==="%2e."||a===".%2e"||a==="%2e%2e"?(c.shortenPath(),r=="/"||r=="\\"&&c.isSpecial()||Oa(c.path,"")):tW(u)?r=="/"||r=="\\"&&c.isSpecial()||Oa(c.path,""):(c.scheme=="file"&&!c.path.length&&td(u)&&(c.host&&(c.host=""),u=Yi(u,0)+":"),Oa(c.path,u)),u="",c.scheme=="file"&&(r==Wi||r=="?"||r=="#"))for(;c.path.length>1&&c.path[0]==="";)GG(c.path);r=="?"?(c.query="",d=Cs):r=="#"&&(c.fragment="",d=no);}else u+=ko(r,by);break;case My:r=="?"?(c.query="",d=Cs):r=="#"?(c.fragment="",d=no):r!=Wi&&(c.path[0]+=ko(r,mu));break;case Cs:e||r!="#"?r!=Wi&&(r=="'"&&c.isSpecial()?c.query+="%27":c.query+=r=="#"?"%23":ko(r,mu)):(c.fragment="",d=no);break;case no:r!=Wi&&(c.fragment+=ko(r,Ay));}l++;}},parseHost:function(t){var e,n,i;if(Yi(t,0)=="["){if(Yi(t,t.length-1)!="]"||(e=function(r){var o,s,a,c,d,l,u,h=[0,0,0,0,0,0,0,0],p=0,T=null,m=0,E=function(){return Yi(r,m)};if(E()==":"){if(Yi(r,1)!=":")return;m+=2,T=++p;}for(;E();){if(p==8)return;if(E()!=":"){for(o=s=0;s<4&&pr(yy,E());)o=16*o+pu(E(),16),m++,s++;if(E()=="."){if(s==0||(m-=s,p>6))return;for(a=0;E();){if(c=null,a>0){if(!(E()=="."&&a<4))return;m++;}if(!pr(Xm,E()))return;for(;pr(Xm,E());){if(d=pu(E(),10),c===null)c=d;else {if(c==0)return;c=10*c+d;}if(c>255)return;m++;}h[p]=256*h[p]+c,++a!=2&&a!=4||p++;}if(a!=4)return;break}if(E()==":"){if(m++,!E())return}else if(E())return;h[p++]=o;}else {if(T!==null)return;m++,T=++p;}}if(T!==null)for(l=p-T,p=7;p!=0&&l>0;)u=h[p],h[p--]=h[T+l-1],h[T+--l]=u;else if(p!=8)return;return h}(Zc(t,1,-1)),!e))return Rs;this.host=e;}else if(this.isSpecial()){if(t=LG(t),pr(JG,t)||(e=function(r){var o,s,a,c,d,l,u,h=WG(r,".");if(h.length&&h[h.length-1]==""&&h.length--,(o=h.length)>4)return r;for(s=[],a=0;a<o;a++){if((c=h[a])=="")return r;if(d=10,c.length>1&&Yi(c,0)=="0"&&(d=pr(YG,c)?16:8,c=Zc(c,d==8?1:2)),c==="")l=0;else {if(!pr(d==10?zG:d==8?qG:yy,c))return r;l=pu(c,d);}Oa(s,l);}for(a=0;a<o;a++)if(l=s[a],a==o-1){if(l>=Cy(256,5-o))return null}else if(l>255)return null;for(u=jG(s),a=0;a<s.length;a++)u+=s[a]*Cy(256,3-a);return u}(t),e===null))return Rs;this.host=e;}else {if(pr(XG,t))return Rs;for(e="",n=wa(t),i=0;i<n.length;i++)e+=ko(n[i],mu);this.host=e;}},cannotHaveUsernamePasswordPort:function(){return !this.host||this.cannotBeABaseURL||this.scheme=="file"},includesCredentials:function(){return this.username!=""||this.password!=""},isSpecial:function(){return Km(Eu,this.scheme)},shortenPath:function(){var t=this.path,e=t.length;!e||this.scheme=="file"&&e==1&&td(t[0],!0)||t.length--;},serialize:function(){var t=this,e=t.scheme,n=t.username,i=t.password,r=t.host,o=t.port,s=t.path,a=t.query,c=t.fragment,d=e+":";return r!==null?(d+="//",t.includesCredentials()&&(d+=n+(i?":"+i:"")+"@"),d+=$c(r),o!==null&&(d+=":"+o)):e=="file"&&(d+="//"),d+=t.cannotBeABaseURL?s[0]:s.length?"/"+Qc(s,"/"):"",a!==null&&(d+="?"+a),c!==null&&(d+="#"+c),d},setHref:function(t){var e=this.parse(t);if(e)throw qm(e);this.searchParams.update();},getOrigin:function(){var t=this.scheme,e=this.port;if(t=="blob")try{return new Da(t.path[0]).origin}catch{return "null"}return t!="file"&&this.isSpecial()?t+"://"+$c(this.host)+(e!==null?":"+e:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(t){this.parse(eo(t)+":",Zm);},getUsername:function(){return this.username},setUsername:function(t){var e=wa(eo(t));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var n=0;n<e.length;n++)this.username+=ko(e[n],Qm);}},getPassword:function(){return this.password},setPassword:function(t){var e=wa(eo(t));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var n=0;n<e.length;n++)this.password+=ko(e[n],Qm);}},getHost:function(){var t=this.host,e=this.port;return t===null?"":e===null?$c(t):$c(t)+":"+e},setHost:function(t){this.cannotBeABaseURL||this.parse(t,eE);},getHostname:function(){var t=this.host;return t===null?"":$c(t)},setHostname:function(t){this.cannotBeABaseURL||this.parse(t,nE);},getPort:function(){var t=this.port;return t===null?"":eo(t)},setPort:function(t){this.cannotHaveUsernamePasswordPort()||((t=eo(t))==""?this.port=null:this.parse(t,iE));},getPathname:function(){var t=this.path;return this.cannotBeABaseURL?t[0]:t.length?"/"+Qc(t,"/"):""},setPathname:function(t){this.cannotBeABaseURL||(this.path=[],this.parse(t,Na));},getSearch:function(){var t=this.query;return t?"?"+t:""},setSearch:function(t){(t=eo(t))==""?this.query=null:(Yi(t,0)=="?"&&(t=Zc(t,1)),this.query="",this.parse(t,Cs)),this.searchParams.update();},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var t=this.fragment;return t?"#"+t:""},setHash:function(t){(t=eo(t))!=""?(Yi(t,0)=="#"&&(t=Zc(t,1)),this.fragment="",this.parse(t,no)):this.fragment=null;},update:function(){this.query=this.searchParams.serialize()||null;}};var Da=function(t){var e=DG(this,Zn),n=MG(arguments.length,1)>1?arguments[1]:void 0,i=UG(e,new sE(t,!1,n));Wm||(e.href=i.serialize(),e.origin=i.getOrigin(),e.protocol=i.getProtocol(),e.username=i.getUsername(),e.password=i.getPassword(),e.host=i.getHost(),e.hostname=i.getHostname(),e.port=i.getPort(),e.pathname=i.getPathname(),e.search=i.getSearch(),e.searchParams=i.getSearchParams(),e.hash=i.getHash());},Zn=Da.prototype,qi=function(t,e){return {get:function(){return hu(this)[t]()},set:e&&function(n){return hu(this)[e](n)},configurable:!0,enumerable:!0}};if(Wm&&(Ki(Zn,"href",qi("serialize","setHref")),Ki(Zn,"origin",qi("getOrigin")),Ki(Zn,"protocol",qi("getProtocol","setProtocol")),Ki(Zn,"username",qi("getUsername","setUsername")),Ki(Zn,"password",qi("getPassword","setPassword")),Ki(Zn,"host",qi("getHost","setHost")),Ki(Zn,"hostname",qi("getHostname","setHostname")),Ki(Zn,"port",qi("getPort","setPort")),Ki(Zn,"pathname",qi("getPathname","setPathname")),Ki(Zn,"search",qi("getSearch","setSearch")),Ki(Zn,"searchParams",qi("getSearchParams")),Ki(Zn,"hash",qi("getHash","setHash"))),uu(Zn,"toJSON",function(){return hu(this).serialize()},{enumerable:!0}),uu(Zn,"toString",function(){return hu(this).serialize()},{enumerable:!0}),Xc){var Uy=Xc.createObjectURL,xy=Xc.revokeObjectURL;Uy&&uu(Da,"createObjectURL",Ty(Uy,Xc)),xy&&uu(Da,"revokeObjectURL",Ty(xy,Xc));}kG(Da,"URL"),OG({global:!0,constructor:!0,forced:!NG,sham:!Wm},{URL:Da});var eW=ee,nW=H,iW=al,Vy=Ri,rW=D_,Fy=Jn("URL");eW({target:"URL",stat:!0,forced:!(rW&&nW(function(){Fy.canParse();}))},{canParse:function(t){var e=iW(arguments.length,1),n=Vy(t),i=e<2||arguments[1]===void 0?void 0:Vy(arguments[1]);try{return !!new Fy(n,i)}catch{return !1}}});var By=j(ir.URL),oW=ut,sW=mv,jy=RegExp.prototype,aW=function(t){return t===jy||oW(jy,t)?sW(t):t.flags},yn=j(aW);function Pa(t){let e=t.length;for(;--e>=0;)t[e]=0;}let aE=256,Gy=286,ed=30,nd=15,cE=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),Tu=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),cW=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),Wy=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),io=new Array(576);Pa(io);let id=new Array(60);Pa(id);let rd=new Array(512);Pa(rd);let od=new Array(256);Pa(od);let dE=new Array(29);Pa(dE);let Su=new Array(ed);function lE(t,e,n,i,r){this.static_tree=t,this.extra_bits=e,this.extra_base=n,this.elems=i,this.max_length=r,this.has_stree=t&&t.length;}let Hy,Ky,Yy;function uE(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e;}Pa(Su);let qy=t=>t<256?rd[t]:rd[256+(t>>>7)],sd=(t,e)=>{t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255;},ai=(t,e,n)=>{t.bi_valid>16-n?(t.bi_buf|=e<<t.bi_valid&65535,sd(t,t.bi_buf),t.bi_buf=e>>16-t.bi_valid,t.bi_valid+=n-16):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=n);},Lr=(t,e,n)=>{ai(t,n[2*e],n[2*e+1]);},zy=(t,e)=>{let n=0;do n|=1&t,t>>>=1,n<<=1;while(--e>0);return n>>>1},Jy=(t,e,n)=>{let i=new Array(16),r,o,s=0;for(r=1;r<=nd;r++)s=s+n[r-1]<<1,i[r]=s;for(o=0;o<=e;o++){let a=t[2*o+1];a!==0&&(t[2*o]=zy(i[a]++,a));}},Xy=t=>{let e;for(e=0;e<Gy;e++)t.dyn_ltree[2*e]=0;for(e=0;e<ed;e++)t.dyn_dtree[2*e]=0;for(e=0;e<19;e++)t.bl_tree[2*e]=0;t.dyn_ltree[512]=1,t.opt_len=t.static_len=0,t.sym_next=t.matches=0;},Qy=t=>{t.bi_valid>8?sd(t,t.bi_buf):t.bi_valid>0&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0;},Zy=(t,e,n,i)=>{let r=2*e,o=2*n;return t[r]<t[o]||t[r]===t[o]&&i[e]<=i[n]},hE=(t,e,n)=>{let i=t.heap[n],r=n<<1;for(;r<=t.heap_len&&(r<t.heap_len&&Zy(e,t.heap[r+1],t.heap[r],t.depth)&&r++,!Zy(e,i,t.heap[r],t.depth));)t.heap[n]=t.heap[r],n=r,r<<=1;t.heap[n]=i;},$y=(t,e,n)=>{let i,r,o,s,a=0;if(t.sym_next!==0)do i=255&t.pending_buf[t.sym_buf+a++],i+=(255&t.pending_buf[t.sym_buf+a++])<<8,r=t.pending_buf[t.sym_buf+a++],i===0?Lr(t,r,e):(o=od[r],Lr(t,o+aE+1,e),s=cE[o],s!==0&&(r-=dE[o],ai(t,r,s)),i--,o=qy(i),Lr(t,o,n),s=Tu[o],s!==0&&(i-=Su[o],ai(t,i,s)));while(a<t.sym_next);Lr(t,256,e);},pE=(t,e)=>{let n=e.dyn_tree,i=e.stat_desc.static_tree,r=e.stat_desc.has_stree,o=e.stat_desc.elems,s,a,c,d=-1;for(t.heap_len=0,t.heap_max=573,s=0;s<o;s++)n[2*s]!==0?(t.heap[++t.heap_len]=d=s,t.depth[s]=0):n[2*s+1]=0;for(;t.heap_len<2;)c=t.heap[++t.heap_len]=d<2?++d:0,n[2*c]=1,t.depth[c]=0,t.opt_len--,r&&(t.static_len-=i[2*c+1]);for(e.max_code=d,s=t.heap_len>>1;s>=1;s--)hE(t,n,s);c=o;do s=t.heap[1],t.heap[1]=t.heap[t.heap_len--],hE(t,n,1),a=t.heap[1],t.heap[--t.heap_max]=s,t.heap[--t.heap_max]=a,n[2*c]=n[2*s]+n[2*a],t.depth[c]=(t.depth[s]>=t.depth[a]?t.depth[s]:t.depth[a])+1,n[2*s+1]=n[2*a+1]=c,t.heap[1]=c++,hE(t,n,1);while(t.heap_len>=2);t.heap[--t.heap_max]=t.heap[1],((l,u)=>{let h=u.dyn_tree,p=u.max_code,T=u.stat_desc.static_tree,m=u.stat_desc.has_stree,E=u.stat_desc.extra_bits,S=u.stat_desc.extra_base,C=u.stat_desc.max_length,A,b,O,N,k,M,x=0;for(N=0;N<=nd;N++)l.bl_count[N]=0;for(h[2*l.heap[l.heap_max]+1]=0,A=l.heap_max+1;A<573;A++)b=l.heap[A],N=h[2*h[2*b+1]+1]+1,N>C&&(N=C,x++),h[2*b+1]=N,b>p||(l.bl_count[N]++,k=0,b>=S&&(k=E[b-S]),M=h[2*b],l.opt_len+=M*(N+k),m&&(l.static_len+=M*(T[2*b+1]+k)));if(x!==0){do{for(N=C-1;l.bl_count[N]===0;)N--;l.bl_count[N]--,l.bl_count[N+1]+=2,l.bl_count[C]--,x-=2;}while(x>0);for(N=C;N!==0;N--)for(b=l.bl_count[N];b!==0;)O=l.heap[--A],O>p||(h[2*O+1]!==N&&(l.opt_len+=(N-h[2*O+1])*h[2*O],h[2*O+1]=N),b--);}})(t,e),Jy(n,d,t.bl_count);},tA=(t,e,n)=>{let i,r,o=-1,s=e[1],a=0,c=7,d=4;for(s===0&&(c=138,d=3),e[2*(n+1)+1]=65535,i=0;i<=n;i++)r=s,s=e[2*(i+1)+1],++a<c&&r===s||(a<d?t.bl_tree[2*r]+=a:r!==0?(r!==o&&t.bl_tree[2*r]++,t.bl_tree[32]++):a<=10?t.bl_tree[34]++:t.bl_tree[36]++,a=0,o=r,s===0?(c=138,d=3):r===s?(c=6,d=3):(c=7,d=4));},eA=(t,e,n)=>{let i,r,o=-1,s=e[1],a=0,c=7,d=4;for(s===0&&(c=138,d=3),i=0;i<=n;i++)if(r=s,s=e[2*(i+1)+1],!(++a<c&&r===s)){if(a<d)do Lr(t,r,t.bl_tree);while(--a!=0);else r!==0?(r!==o&&(Lr(t,r,t.bl_tree),a--),Lr(t,16,t.bl_tree),ai(t,a-3,2)):a<=10?(Lr(t,17,t.bl_tree),ai(t,a-3,3)):(Lr(t,18,t.bl_tree),ai(t,a-11,7));a=0,o=r,s===0?(c=138,d=3):r===s?(c=6,d=3):(c=7,d=4);}},nA=!1,iA=(t,e,n,i)=>{ai(t,0+(i?1:0),3),Qy(t),sd(t,n),sd(t,~n),n&&t.pending_buf.set(t.window.subarray(e,e+n),t.pending),t.pending+=n;};var dW=t=>{nA||((()=>{let e,n,i,r,o,s=new Array(16);for(i=0,r=0;r<28;r++)for(dE[r]=i,e=0;e<1<<cE[r];e++)od[i++]=r;for(od[i-1]=r,o=0,r=0;r<16;r++)for(Su[r]=o,e=0;e<1<<Tu[r];e++)rd[o++]=r;for(o>>=7;r<ed;r++)for(Su[r]=o<<7,e=0;e<1<<Tu[r]-7;e++)rd[256+o++]=r;for(n=0;n<=nd;n++)s[n]=0;for(e=0;e<=143;)io[2*e+1]=8,e++,s[8]++;for(;e<=255;)io[2*e+1]=9,e++,s[9]++;for(;e<=279;)io[2*e+1]=7,e++,s[7]++;for(;e<=287;)io[2*e+1]=8,e++,s[8]++;for(Jy(io,287,s),e=0;e<ed;e++)id[2*e+1]=5,id[2*e]=zy(e,5);Hy=new lE(io,cE,257,Gy,nd),Ky=new lE(id,Tu,0,ed,nd),Yy=new lE(new Array(0),cW,0,19,7);})(),nA=!0),t.l_desc=new uE(t.dyn_ltree,Hy),t.d_desc=new uE(t.dyn_dtree,Ky),t.bl_desc=new uE(t.bl_tree,Yy),t.bi_buf=0,t.bi_valid=0,Xy(t);},lW=(t,e,n,i)=>{let r,o,s=0;t.level>0?(t.strm.data_type===2&&(t.strm.data_type=(a=>{let c,d=4093624447;for(c=0;c<=31;c++,d>>>=1)if(1&d&&a.dyn_ltree[2*c]!==0)return 0;if(a.dyn_ltree[18]!==0||a.dyn_ltree[20]!==0||a.dyn_ltree[26]!==0)return 1;for(c=32;c<aE;c++)if(a.dyn_ltree[2*c]!==0)return 1;return 0})(t)),pE(t,t.l_desc),pE(t,t.d_desc),s=(a=>{let c;for(tA(a,a.dyn_ltree,a.l_desc.max_code),tA(a,a.dyn_dtree,a.d_desc.max_code),pE(a,a.bl_desc),c=18;c>=3&&a.bl_tree[2*Wy[c]+1]===0;c--);return a.opt_len+=3*(c+1)+5+5+4,c})(t),r=t.opt_len+3+7>>>3,o=t.static_len+3+7>>>3,o<=r&&(r=o)):r=o=n+5,n+4<=r&&e!==-1?iA(t,e,n,i):t.strategy===4||o===r?(ai(t,2+(i?1:0),3),$y(t,io,id)):(ai(t,4+(i?1:0),3),((a,c,d,l)=>{let u;for(ai(a,c-257,5),ai(a,d-1,5),ai(a,l-4,4),u=0;u<l;u++)ai(a,a.bl_tree[2*Wy[u]+1],3);eA(a,a.dyn_ltree,c-1),eA(a,a.dyn_dtree,d-1);})(t,t.l_desc.max_code+1,t.d_desc.max_code+1,s+1),$y(t,t.dyn_ltree,t.dyn_dtree)),Xy(t),i&&Qy(t);},uW=(t,e,n)=>(t.pending_buf[t.sym_buf+t.sym_next++]=e,t.pending_buf[t.sym_buf+t.sym_next++]=e>>8,t.pending_buf[t.sym_buf+t.sym_next++]=n,e===0?t.dyn_ltree[2*n]++:(t.matches++,e--,t.dyn_ltree[2*(od[n]+aE+1)]++,t.dyn_dtree[2*qy(e)]++),t.sym_next===t.sym_end),hW=t=>{ai(t,2,3),Lr(t,256,io),(e=>{e.bi_valid===16?(sd(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8);})(t);},pW={_tr_init:dW,_tr_stored_block:iA,_tr_flush_block:lW,_tr_tally:uW,_tr_align:hW},ad=(t,e,n,i)=>{let r=65535&t|0,o=t>>>16&65535|0,s=0;for(;n!==0;){s=n>2e3?2e3:n,n-=s;do r=r+e[i++]|0,o=o+r|0;while(--s);r%=65521,o%=65521;}return r|o<<16|0};let _W=new Uint32Array((()=>{let t,e=[];for(var n=0;n<256;n++){t=n;for(var i=0;i<8;i++)t=1&t?3988292384^t>>>1:t>>>1;e[n]=t;}return e})());var Ln=(t,e,n,i)=>{let r=_W,o=i+n;t^=-1;for(let s=i;s<o;s++)t=t>>>8^r[255&(t^e[s])];return -1^t},vs={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},La={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};let{_tr_init:mW,_tr_stored_block:_E,_tr_flush_block:EW,_tr_tally:Mo,_tr_align:fW}=pW,{Z_NO_FLUSH:Uo,Z_PARTIAL_FLUSH:gW,Z_FULL_FLUSH:TW,Z_FINISH:zi,Z_BLOCK:rA,Z_OK:Un,Z_STREAM_END:oA,Z_STREAM_ERROR:kr,Z_DATA_ERROR:SW,Z_BUF_ERROR:mE,Z_DEFAULT_COMPRESSION:RW,Z_FILTERED:CW,Z_HUFFMAN_ONLY:Ru,Z_RLE:vW,Z_FIXED:IW,Z_DEFAULT_STRATEGY:yW,Z_UNKNOWN:AW,Z_DEFLATED:Cu}=La,EE=286,bW=30,wW=19,OW=2*EE+1,NW=15,Is=258,Mr=262,ka=42,ys=113,cd=666,As=(t,e)=>(t.msg=vs[e],e),sA=t=>2*t-(t>4?9:0),xo=t=>{let e=t.length;for(;--e>=0;)t[e]=0;},DW=t=>{let e,n,i,r=t.w_size;e=t.hash_size,i=e;do n=t.head[--i],t.head[i]=n>=r?n-r:0;while(--e);e=r,i=e;do n=t.prev[--i],t.prev[i]=n>=r?n-r:0;while(--e)},Vo=(t,e,n)=>(e<<t.hash_shift^n)&t.hash_mask,Ai=t=>{let e=t.state,n=e.pending;n>t.avail_out&&(n=t.avail_out),n!==0&&(t.output.set(e.pending_buf.subarray(e.pending_out,e.pending_out+n),t.next_out),t.next_out+=n,e.pending_out+=n,t.total_out+=n,t.avail_out-=n,e.pending-=n,e.pending===0&&(e.pending_out=0));},bi=(t,e)=>{EW(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,Ai(t.strm);},Ce=(t,e)=>{t.pending_buf[t.pending++]=e;},dd=(t,e)=>{t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e;},fE=(t,e,n,i)=>{let r=t.avail_in;return r>i&&(r=i),r===0?0:(t.avail_in-=r,e.set(t.input.subarray(t.next_in,t.next_in+r),n),t.state.wrap===1?t.adler=ad(t.adler,e,r,n):t.state.wrap===2&&(t.adler=Ln(t.adler,e,r,n)),t.next_in+=r,t.total_in+=r,r)},aA=(t,e)=>{let n,i,r=t.max_chain_length,o=t.strstart,s=t.prev_length,a=t.nice_match,c=t.strstart>t.w_size-Mr?t.strstart-(t.w_size-Mr):0,d=t.window,l=t.w_mask,u=t.prev,h=t.strstart+Is,p=d[o+s-1],T=d[o+s];t.prev_length>=t.good_match&&(r>>=2),a>t.lookahead&&(a=t.lookahead);do if(n=e,d[n+s]===T&&d[n+s-1]===p&&d[n]===d[o]&&d[++n]===d[o+1]){o+=2,n++;do;while(d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&o<h);if(i=Is-(h-o),o=h-Is,i>s){if(t.match_start=e,s=i,i>=a)break;p=d[o+s-1],T=d[o+s];}}while((e=u[e&l])>c&&--r!=0);return s<=t.lookahead?s:t.lookahead},Ma=t=>{let e=t.w_size,n,i,r;do{if(i=t.window_size-t.lookahead-t.strstart,t.strstart>=e+(e-Mr)&&(t.window.set(t.window.subarray(e,e+e-i),0),t.match_start-=e,t.strstart-=e,t.block_start-=e,t.insert>t.strstart&&(t.insert=t.strstart),DW(t),i+=e),t.strm.avail_in===0)break;if(n=fE(t.strm,t.window,t.strstart+t.lookahead,i),t.lookahead+=n,t.lookahead+t.insert>=3)for(r=t.strstart-t.insert,t.ins_h=t.window[r],t.ins_h=Vo(t,t.ins_h,t.window[r+1]);t.insert&&(t.ins_h=Vo(t,t.ins_h,t.window[r+3-1]),t.prev[r&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=r,r++,t.insert--,!(t.lookahead+t.insert<3)););}while(t.lookahead<Mr&&t.strm.avail_in!==0)},cA=(t,e)=>{let n,i,r,o=t.pending_buf_size-5>t.w_size?t.w_size:t.pending_buf_size-5,s=0,a=t.strm.avail_in;do{if(n=65535,r=t.bi_valid+42>>3,t.strm.avail_out<r||(r=t.strm.avail_out-r,i=t.strstart-t.block_start,n>i+t.strm.avail_in&&(n=i+t.strm.avail_in),n>r&&(n=r),n<o&&(n===0&&e!==zi||e===Uo||n!==i+t.strm.avail_in)))break;s=e===zi&&n===i+t.strm.avail_in?1:0,_E(t,0,0,s),t.pending_buf[t.pending-4]=n,t.pending_buf[t.pending-3]=n>>8,t.pending_buf[t.pending-2]=~n,t.pending_buf[t.pending-1]=~n>>8,Ai(t.strm),i&&(i>n&&(i=n),t.strm.output.set(t.window.subarray(t.block_start,t.block_start+i),t.strm.next_out),t.strm.next_out+=i,t.strm.avail_out-=i,t.strm.total_out+=i,t.block_start+=i,n-=i),n&&(fE(t.strm,t.strm.output,t.strm.next_out,n),t.strm.next_out+=n,t.strm.avail_out-=n,t.strm.total_out+=n);}while(s===0);return a-=t.strm.avail_in,a&&(a>=t.w_size?(t.matches=2,t.window.set(t.strm.input.subarray(t.strm.next_in-t.w_size,t.strm.next_in),0),t.strstart=t.w_size,t.insert=t.strstart):(t.window_size-t.strstart<=a&&(t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,t.insert>t.strstart&&(t.insert=t.strstart)),t.window.set(t.strm.input.subarray(t.strm.next_in-a,t.strm.next_in),t.strstart),t.strstart+=a,t.insert+=a>t.w_size-t.insert?t.w_size-t.insert:a),t.block_start=t.strstart),t.high_water<t.strstart&&(t.high_water=t.strstart),s?4:e!==Uo&&e!==zi&&t.strm.avail_in===0&&t.strstart===t.block_start?2:(r=t.window_size-t.strstart,t.strm.avail_in>r&&t.block_start>=t.w_size&&(t.block_start-=t.w_size,t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,r+=t.w_size,t.insert>t.strstart&&(t.insert=t.strstart)),r>t.strm.avail_in&&(r=t.strm.avail_in),r&&(fE(t.strm,t.window,t.strstart,r),t.strstart+=r,t.insert+=r>t.w_size-t.insert?t.w_size-t.insert:r),t.high_water<t.strstart&&(t.high_water=t.strstart),r=t.bi_valid+42>>3,r=t.pending_buf_size-r>65535?65535:t.pending_buf_size-r,o=r>t.w_size?t.w_size:r,i=t.strstart-t.block_start,(i>=o||(i||e===zi)&&e!==Uo&&t.strm.avail_in===0&&i<=r)&&(n=i>r?r:i,s=e===zi&&t.strm.avail_in===0&&n===i?1:0,_E(t,t.block_start,n,s),t.block_start+=n,Ai(t.strm)),s?3:1)},gE=(t,e)=>{let n,i;for(;;){if(t.lookahead<Mr){if(Ma(t),t.lookahead<Mr&&e===Uo)return 1;if(t.lookahead===0)break}if(n=0,t.lookahead>=3&&(t.ins_h=Vo(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),n!==0&&t.strstart-n<=t.w_size-Mr&&(t.match_length=aA(t,n)),t.match_length>=3)if(i=Mo(t,t.strstart-t.match_start,t.match_length-3),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=3){t.match_length--;do t.strstart++,t.ins_h=Vo(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart;while(--t.match_length!=0);t.strstart++;}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=Vo(t,t.ins_h,t.window[t.strstart+1]);else i=Mo(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(i&&(bi(t,!1),t.strm.avail_out===0))return 1}return t.insert=t.strstart<2?t.strstart:2,e===zi?(bi(t,!0),t.strm.avail_out===0?3:4):t.sym_next&&(bi(t,!1),t.strm.avail_out===0)?1:2},Ua=(t,e)=>{let n,i,r;for(;;){if(t.lookahead<Mr){if(Ma(t),t.lookahead<Mr&&e===Uo)return 1;if(t.lookahead===0)break}if(n=0,t.lookahead>=3&&(t.ins_h=Vo(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=2,n!==0&&t.prev_length<t.max_lazy_match&&t.strstart-n<=t.w_size-Mr&&(t.match_length=aA(t,n),t.match_length<=5&&(t.strategy===CW||t.match_length===3&&t.strstart-t.match_start>4096)&&(t.match_length=2)),t.prev_length>=3&&t.match_length<=t.prev_length){r=t.strstart+t.lookahead-3,i=Mo(t,t.strstart-1-t.prev_match,t.prev_length-3),t.lookahead-=t.prev_length-1,t.prev_length-=2;do++t.strstart<=r&&(t.ins_h=Vo(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart);while(--t.prev_length!=0);if(t.match_available=0,t.match_length=2,t.strstart++,i&&(bi(t,!1),t.strm.avail_out===0))return 1}else if(t.match_available){if(i=Mo(t,0,t.window[t.strstart-1]),i&&bi(t,!1),t.strstart++,t.lookahead--,t.strm.avail_out===0)return 1}else t.match_available=1,t.strstart++,t.lookahead--;}return t.match_available&&(i=Mo(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<2?t.strstart:2,e===zi?(bi(t,!0),t.strm.avail_out===0?3:4):t.sym_next&&(bi(t,!1),t.strm.avail_out===0)?1:2};function Ur(t,e,n,i,r){this.good_length=t,this.max_lazy=e,this.nice_length=n,this.max_chain=i,this.func=r;}let ld=[new Ur(0,0,0,0,cA),new Ur(4,4,8,4,gE),new Ur(4,5,16,8,gE),new Ur(4,6,32,32,gE),new Ur(4,4,16,16,Ua),new Ur(8,16,32,32,Ua),new Ur(8,16,128,128,Ua),new Ur(8,32,128,256,Ua),new Ur(32,128,258,1024,Ua),new Ur(32,258,258,4096,Ua)];function PW(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Cu,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*OW),this.dyn_dtree=new Uint16Array(2*(2*bW+1)),this.bl_tree=new Uint16Array(2*(2*wW+1)),xo(this.dyn_ltree),xo(this.dyn_dtree),xo(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(NW+1),this.heap=new Uint16Array(2*EE+1),xo(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*EE+1),xo(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0;}let ud=t=>{if(!t)return 1;let e=t.state;return !e||e.strm!==t||e.status!==ka&&e.status!==57&&e.status!==69&&e.status!==73&&e.status!==91&&e.status!==103&&e.status!==ys&&e.status!==cd?1:0},dA=t=>{if(ud(t))return As(t,kr);t.total_in=t.total_out=0,t.data_type=AW;let e=t.state;return e.pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap===2?57:e.wrap?ka:ys,t.adler=e.wrap===2?0:1,e.last_flush=-2,mW(e),Un},lA=t=>{let e=dA(t);return e===Un&&(n=>{n.window_size=2*n.w_size,xo(n.head),n.max_lazy_match=ld[n.level].max_lazy,n.good_match=ld[n.level].good_length,n.nice_match=ld[n.level].nice_length,n.max_chain_length=ld[n.level].max_chain,n.strstart=0,n.block_start=0,n.lookahead=0,n.insert=0,n.match_length=n.prev_length=2,n.match_available=0,n.ins_h=0;})(t.state),e},uA=(t,e,n,i,r,o)=>{if(!t)return kr;let s=1;if(e===RW&&(e=6),i<0?(s=0,i=-i):i>15&&(s=2,i-=16),r<1||r>9||n!==Cu||i<8||i>15||e<0||e>9||o<0||o>IW||i===8&&s!==1)return As(t,kr);i===8&&(i=9);let a=new PW;return t.state=a,a.strm=t,a.status=ka,a.wrap=s,a.gzhead=null,a.w_bits=i,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=r+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uint8Array(2*a.w_size),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<r+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=3*(a.lit_bufsize-1),a.level=e,a.strategy=o,a.method=n,lA(t)};var LW=(t,e)=>{if(ud(t)||e>rA||e<0)return t?As(t,kr):kr;let n=t.state;if(!t.output||t.avail_in!==0&&!t.input||n.status===cd&&e!==zi)return As(t,t.avail_out===0?mE:kr);let i=n.last_flush;if(n.last_flush=e,n.pending!==0){if(Ai(t),t.avail_out===0)return n.last_flush=-1,Un}else if(t.avail_in===0&&sA(e)<=sA(i)&&e!==zi)return As(t,mE);if(n.status===cd&&t.avail_in!==0)return As(t,mE);if(n.status===ka&&n.wrap===0&&(n.status=ys),n.status===ka){let r=Cu+(n.w_bits-8<<4)<<8,o=-1;if(o=n.strategy>=Ru||n.level<2?0:n.level<6?1:n.level===6?2:3,r|=o<<6,n.strstart!==0&&(r|=32),r+=31-r%31,dd(n,r),n.strstart!==0&&(dd(n,t.adler>>>16),dd(n,65535&t.adler)),t.adler=1,n.status=ys,Ai(t),n.pending!==0)return n.last_flush=-1,Un}if(n.status===57){if(t.adler=0,Ce(n,31),Ce(n,139),Ce(n,8),n.gzhead)Ce(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),Ce(n,255&n.gzhead.time),Ce(n,n.gzhead.time>>8&255),Ce(n,n.gzhead.time>>16&255),Ce(n,n.gzhead.time>>24&255),Ce(n,n.level===9?2:n.strategy>=Ru||n.level<2?4:0),Ce(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(Ce(n,255&n.gzhead.extra.length),Ce(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(t.adler=Ln(t.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69;else if(Ce(n,0),Ce(n,0),Ce(n,0),Ce(n,0),Ce(n,0),Ce(n,n.level===9?2:n.strategy>=Ru||n.level<2?4:0),Ce(n,3),n.status=ys,Ai(t),n.pending!==0)return n.last_flush=-1,Un}if(n.status===69){if(n.gzhead.extra){let r=n.pending,o=(65535&n.gzhead.extra.length)-n.gzindex;for(;n.pending+o>n.pending_buf_size;){let a=n.pending_buf_size-n.pending;if(n.pending_buf.set(n.gzhead.extra.subarray(n.gzindex,n.gzindex+a),n.pending),n.pending=n.pending_buf_size,n.gzhead.hcrc&&n.pending>r&&(t.adler=Ln(t.adler,n.pending_buf,n.pending-r,r)),n.gzindex+=a,Ai(t),n.pending!==0)return n.last_flush=-1,Un;r=0,o-=a;}let s=new Uint8Array(n.gzhead.extra);n.pending_buf.set(s.subarray(n.gzindex,n.gzindex+o),n.pending),n.pending+=o,n.gzhead.hcrc&&n.pending>r&&(t.adler=Ln(t.adler,n.pending_buf,n.pending-r,r)),n.gzindex=0;}n.status=73;}if(n.status===73){if(n.gzhead.name){let r,o=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>o&&(t.adler=Ln(t.adler,n.pending_buf,n.pending-o,o)),Ai(t),n.pending!==0)return n.last_flush=-1,Un;o=0;}r=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,Ce(n,r);}while(r!==0);n.gzhead.hcrc&&n.pending>o&&(t.adler=Ln(t.adler,n.pending_buf,n.pending-o,o)),n.gzindex=0;}n.status=91;}if(n.status===91){if(n.gzhead.comment){let r,o=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>o&&(t.adler=Ln(t.adler,n.pending_buf,n.pending-o,o)),Ai(t),n.pending!==0)return n.last_flush=-1,Un;o=0;}r=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,Ce(n,r);}while(r!==0);n.gzhead.hcrc&&n.pending>o&&(t.adler=Ln(t.adler,n.pending_buf,n.pending-o,o));}n.status=103;}if(n.status===103){if(n.gzhead.hcrc){if(n.pending+2>n.pending_buf_size&&(Ai(t),n.pending!==0))return n.last_flush=-1,Un;Ce(n,255&t.adler),Ce(n,t.adler>>8&255),t.adler=0;}if(n.status=ys,Ai(t),n.pending!==0)return n.last_flush=-1,Un}if(t.avail_in!==0||n.lookahead!==0||e!==Uo&&n.status!==cd){let r=n.level===0?cA(n,e):n.strategy===Ru?((o,s)=>{let a;for(;;){if(o.lookahead===0&&(Ma(o),o.lookahead===0)){if(s===Uo)return 1;break}if(o.match_length=0,a=Mo(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++,a&&(bi(o,!1),o.strm.avail_out===0))return 1}return o.insert=0,s===zi?(bi(o,!0),o.strm.avail_out===0?3:4):o.sym_next&&(bi(o,!1),o.strm.avail_out===0)?1:2})(n,e):n.strategy===vW?((o,s)=>{let a,c,d,l,u=o.window;for(;;){if(o.lookahead<=Is){if(Ma(o),o.lookahead<=Is&&s===Uo)return 1;if(o.lookahead===0)break}if(o.match_length=0,o.lookahead>=3&&o.strstart>0&&(d=o.strstart-1,c=u[d],c===u[++d]&&c===u[++d]&&c===u[++d])){l=o.strstart+Is;do;while(c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&d<l);o.match_length=Is-(l-d),o.match_length>o.lookahead&&(o.match_length=o.lookahead);}if(o.match_length>=3?(a=Mo(o,1,o.match_length-3),o.lookahead-=o.match_length,o.strstart+=o.match_length,o.match_length=0):(a=Mo(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++),a&&(bi(o,!1),o.strm.avail_out===0))return 1}return o.insert=0,s===zi?(bi(o,!0),o.strm.avail_out===0?3:4):o.sym_next&&(bi(o,!1),o.strm.avail_out===0)?1:2})(n,e):ld[n.level].func(n,e);if(r!==3&&r!==4||(n.status=cd),r===1||r===3)return t.avail_out===0&&(n.last_flush=-1),Un;if(r===2&&(e===gW?fW(n):e!==rA&&(_E(n,0,0,!1),e===TW&&(xo(n.head),n.lookahead===0&&(n.strstart=0,n.block_start=0,n.insert=0))),Ai(t),t.avail_out===0))return n.last_flush=-1,Un}return e!==zi?Un:n.wrap<=0?oA:(n.wrap===2?(Ce(n,255&t.adler),Ce(n,t.adler>>8&255),Ce(n,t.adler>>16&255),Ce(n,t.adler>>24&255),Ce(n,255&t.total_in),Ce(n,t.total_in>>8&255),Ce(n,t.total_in>>16&255),Ce(n,t.total_in>>24&255)):(dd(n,t.adler>>>16),dd(n,65535&t.adler)),Ai(t),n.wrap>0&&(n.wrap=-n.wrap),n.pending!==0?Un:oA)},kW=(t,e)=>{let n=e.length;if(ud(t))return kr;let i=t.state,r=i.wrap;if(r===2||r===1&&i.status!==ka||i.lookahead)return kr;if(r===1&&(t.adler=ad(t.adler,e,n,0)),i.wrap=0,n>=i.w_size){r===0&&(xo(i.head),i.strstart=0,i.block_start=0,i.insert=0);let c=new Uint8Array(i.w_size);c.set(e.subarray(n-i.w_size,n),0),e=c,n=i.w_size;}let o=t.avail_in,s=t.next_in,a=t.input;for(t.avail_in=n,t.next_in=0,t.input=e,Ma(i);i.lookahead>=3;){let c=i.strstart,d=i.lookahead-2;do i.ins_h=Vo(i,i.ins_h,i.window[c+3-1]),i.prev[c&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=c,c++;while(--d);i.strstart=c,i.lookahead=2,Ma(i);}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=2,i.match_available=0,t.next_in=s,t.input=a,t.avail_in=o,i.wrap=r,Un},hd={deflateInit:(t,e)=>uA(t,e,Cu,15,8,yW),deflateInit2:uA,deflateReset:lA,deflateResetKeep:dA,deflateSetHeader:(t,e)=>ud(t)||t.state.wrap!==2?kr:(t.state.gzhead=e,Un),deflate:LW,deflateEnd:t=>{if(ud(t))return kr;let e=t.state.status;return t.state=null,e===ys?As(t,SW):Un},deflateSetDictionary:kW,deflateInfo:"pako deflate (from Nodeca project)"};let MW=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var vu={assign:function(t){let e=Array.prototype.slice.call(arguments,1);for(;e.length;){let n=e.shift();if(n){if(typeof n!="object")throw new TypeError(n+"must be non-object");for(let i in n)MW(n,i)&&(t[i]=n[i]);}}return t},flattenChunks:t=>{let e=0;for(let i=0,r=t.length;i<r;i++)e+=t[i].length;let n=new Uint8Array(e);for(let i=0,r=0,o=t.length;i<o;i++){let s=t[i];n.set(s,r),r+=s.length;}return n}};let hA=!0;try{String.fromCharCode.apply(null,new Uint8Array(1));}catch{hA=!1;}let pd=new Uint8Array(256);for(let t=0;t<256;t++)pd[t]=t>=252?6:t>=248?5:t>=240?4:t>=224?3:t>=192?2:1;pd[254]=pd[254]=1;var _d={string2buf:t=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(t);let e,n,i,r,o,s=t.length,a=0;for(r=0;r<s;r++)n=t.charCodeAt(r),(64512&n)==55296&&r+1<s&&(i=t.charCodeAt(r+1),(64512&i)==56320&&(n=65536+(n-55296<<10)+(i-56320),r++)),a+=n<128?1:n<2048?2:n<65536?3:4;for(e=new Uint8Array(a),o=0,r=0;o<a;r++)n=t.charCodeAt(r),(64512&n)==55296&&r+1<s&&(i=t.charCodeAt(r+1),(64512&i)==56320&&(n=65536+(n-55296<<10)+(i-56320),r++)),n<128?e[o++]=n:n<2048?(e[o++]=192|n>>>6,e[o++]=128|63&n):n<65536?(e[o++]=224|n>>>12,e[o++]=128|n>>>6&63,e[o++]=128|63&n):(e[o++]=240|n>>>18,e[o++]=128|n>>>12&63,e[o++]=128|n>>>6&63,e[o++]=128|63&n);return e},buf2string:(t,e)=>{let n=e||t.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(t.subarray(0,e));let i,r,o=new Array(2*n);for(r=0,i=0;i<n;){let s=t[i++];if(s<128){o[r++]=s;continue}let a=pd[s];if(a>4)o[r++]=65533,i+=a-1;else {for(s&=a===2?31:a===3?15:7;a>1&&i<n;)s=s<<6|63&t[i++],a--;a>1?o[r++]=65533:s<65536?o[r++]=s:(s-=65536,o[r++]=55296|s>>10&1023,o[r++]=56320|1023&s);}}return ((s,a)=>{if(a<65534&&s.subarray&&hA)return String.fromCharCode.apply(null,s.length===a?s:s.subarray(0,a));let c="";for(let d=0;d<a;d++)c+=String.fromCharCode(s[d]);return c})(o,r)},utf8border:(t,e)=>{(e=e||t.length)>t.length&&(e=t.length);let n=e-1;for(;n>=0&&(192&t[n])==128;)n--;return n<0||n===0?e:n+pd[t[n]]>e?n:e}},pA=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0;};let _A=Object.prototype.toString,{Z_NO_FLUSH:UW,Z_SYNC_FLUSH:xW,Z_FULL_FLUSH:VW,Z_FINISH:FW,Z_OK:Iu,Z_STREAM_END:BW,Z_DEFAULT_COMPRESSION:jW,Z_DEFAULT_STRATEGY:GW,Z_DEFLATED:WW}=La;function md(t){this.options=vu.assign({level:jW,method:WW,chunkSize:16384,windowBits:15,memLevel:8,strategy:GW},t||{});let e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new pA,this.strm.avail_out=0;let n=hd.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(n!==Iu)throw new Error(vs[n]);if(e.header&&hd.deflateSetHeader(this.strm,e.header),e.dictionary){let i;if(i=typeof e.dictionary=="string"?_d.string2buf(e.dictionary):_A.call(e.dictionary)==="[object ArrayBuffer]"?new Uint8Array(e.dictionary):e.dictionary,n=hd.deflateSetDictionary(this.strm,i),n!==Iu)throw new Error(vs[n]);this._dict_set=!0;}}function TE(t,e){let n=new md(e);if(n.push(t,!0),n.err)throw n.msg||vs[n.err];return n.result}md.prototype.push=function(t,e){let n=this.strm,i=this.options.chunkSize,r,o;if(this.ended)return !1;for(o=e===~~e?e:e===!0?FW:UW,typeof t=="string"?n.input=_d.string2buf(t):_A.call(t)==="[object ArrayBuffer]"?n.input=new Uint8Array(t):n.input=t,n.next_in=0,n.avail_in=n.input.length;;)if(n.avail_out===0&&(n.output=new Uint8Array(i),n.next_out=0,n.avail_out=i),(o===xW||o===VW)&&n.avail_out<=6)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else {if(r=hd.deflate(n,o),r===BW)return n.next_out>0&&this.onData(n.output.subarray(0,n.next_out)),r=hd.deflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===Iu;if(n.avail_out!==0){if(o>0&&n.next_out>0)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else if(n.avail_in===0)break}else this.onData(n.output);}return !0},md.prototype.onData=function(t){this.chunks.push(t);},md.prototype.onEnd=function(t){t===Iu&&(this.result=vu.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg;};var HW={Deflate:md,deflate:TE,deflateRaw:function(t,e){return (e=e||{}).raw=!0,TE(t,e)},gzip:function(t,e){return (e=e||{}).gzip=!0,TE(t,e)},constants:La};let yu=16209;var KW=function(t,e){let n,i,r,o,s,a,c,d,l,u,h,p,T,m,E,S,C,A,b,O,N,k,M,x,X=t.state;n=t.next_in,M=t.input,i=n+(t.avail_in-5),r=t.next_out,x=t.output,o=r-(e-t.avail_out),s=r+(t.avail_out-257),a=X.dmax,c=X.wsize,d=X.whave,l=X.wnext,u=X.window,h=X.hold,p=X.bits,T=X.lencode,m=X.distcode,E=(1<<X.lenbits)-1,S=(1<<X.distbits)-1;t:do{p<15&&(h+=M[n++]<<p,p+=8,h+=M[n++]<<p,p+=8),C=T[h&E];e:for(;;){if(A=C>>>24,h>>>=A,p-=A,A=C>>>16&255,A===0)x[r++]=65535&C;else {if(!(16&A)){if(!(64&A)){C=T[(65535&C)+(h&(1<<A)-1)];continue e}if(32&A){X.mode=16191;break t}t.msg="invalid literal/length code",X.mode=yu;break t}b=65535&C,A&=15,A&&(p<A&&(h+=M[n++]<<p,p+=8),b+=h&(1<<A)-1,h>>>=A,p-=A),p<15&&(h+=M[n++]<<p,p+=8,h+=M[n++]<<p,p+=8),C=m[h&S];n:for(;;){if(A=C>>>24,h>>>=A,p-=A,A=C>>>16&255,!(16&A)){if(!(64&A)){C=m[(65535&C)+(h&(1<<A)-1)];continue n}t.msg="invalid distance code",X.mode=yu;break t}if(O=65535&C,A&=15,p<A&&(h+=M[n++]<<p,p+=8,p<A&&(h+=M[n++]<<p,p+=8)),O+=h&(1<<A)-1,O>a){t.msg="invalid distance too far back",X.mode=yu;break t}if(h>>>=A,p-=A,A=r-o,O>A){if(A=O-A,A>d&&X.sane){t.msg="invalid distance too far back",X.mode=yu;break t}if(N=0,k=u,l===0){if(N+=c-A,A<b){b-=A;do x[r++]=u[N++];while(--A);N=r-O,k=x;}}else if(l<A){if(N+=c+l-A,A-=l,A<b){b-=A;do x[r++]=u[N++];while(--A);if(N=0,l<b){A=l,b-=A;do x[r++]=u[N++];while(--A);N=r-O,k=x;}}}else if(N+=l-A,A<b){b-=A;do x[r++]=u[N++];while(--A);N=r-O,k=x;}for(;b>2;)x[r++]=k[N++],x[r++]=k[N++],x[r++]=k[N++],b-=3;b&&(x[r++]=k[N++],b>1&&(x[r++]=k[N++]));}else {N=r-O;do x[r++]=x[N++],x[r++]=x[N++],x[r++]=x[N++],b-=3;while(b>2);b&&(x[r++]=x[N++],b>1&&(x[r++]=x[N++]));}break}}break}}while(n<i&&r<s);b=p>>3,n-=b,p-=b<<3,h&=(1<<p)-1,t.next_in=n,t.next_out=r,t.avail_in=n<i?i-n+5:5-(n-i),t.avail_out=r<s?s-r+257:257-(r-s),X.hold=h,X.bits=p;};let Au=15,YW=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),qW=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),zW=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),JW=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var Ed=(t,e,n,i,r,o,s,a)=>{let c=a.bits,d,l,u,h,p,T,m=0,E=0,S=0,C=0,A=0,b=0,O=0,N=0,k=0,M=0,x=null,X=new Uint16Array(16),bt=new Uint16Array(16),Ft,re,Le,Ee=null;for(m=0;m<=Au;m++)X[m]=0;for(E=0;E<i;E++)X[e[n+E]]++;for(A=c,C=Au;C>=1&&X[C]===0;C--);if(A>C&&(A=C),C===0)return r[o++]=20971520,r[o++]=20971520,a.bits=1,0;for(S=1;S<C&&X[S]===0;S++);for(A<S&&(A=S),N=1,m=1;m<=Au;m++)if(N<<=1,N-=X[m],N<0)return -1;if(N>0&&(t===0||C!==1))return -1;for(bt[1]=0,m=1;m<Au;m++)bt[m+1]=bt[m]+X[m];for(E=0;E<i;E++)e[n+E]!==0&&(s[bt[e[n+E]]++]=E);if(t===0?(x=Ee=s,T=20):t===1?(x=YW,Ee=qW,T=257):(x=zW,Ee=JW,T=0),M=0,E=0,m=S,p=o,b=A,O=0,u=-1,k=1<<A,h=k-1,t===1&&k>852||t===2&&k>592)return 1;for(;;){Ft=m-O,s[E]+1<T?(re=0,Le=s[E]):s[E]>=T?(re=Ee[s[E]-T],Le=x[s[E]-T]):(re=96,Le=0),d=1<<m-O,l=1<<b,S=l;do l-=d,r[p+(M>>O)+l]=Ft<<24|re<<16|Le|0;while(l!==0);for(d=1<<m-1;M&d;)d>>=1;if(d!==0?(M&=d-1,M+=d):M=0,E++,--X[m]==0){if(m===C)break;m=e[n+s[E]];}if(m>A&&(M&h)!==u){for(O===0&&(O=A),p+=S,b=m-O,N=1<<b;b+O<C&&(N-=X[b+O],!(N<=0));)b++,N<<=1;if(k+=1<<b,t===1&&k>852||t===2&&k>592)return 1;u=M&h,r[u]=A<<24|b<<16|p-o|0;}}return M!==0&&(r[p+M]=m-O<<24|64<<16|0),a.bits=A,0};let{Z_FINISH:mA,Z_BLOCK:XW,Z_TREES:bu,Z_OK:bs,Z_STREAM_END:QW,Z_NEED_DICT:ZW,Z_STREAM_ERROR:Ji,Z_DATA_ERROR:EA,Z_MEM_ERROR:fA,Z_BUF_ERROR:$W,Z_DEFLATED:gA}=La,wu=16180,Ou=16190,ro=16191,SE=16192,RE=16194,Nu=16199,Du=16200,CE=16206,en=16209,TA=t=>(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24);function t3(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0;}let ws=t=>{if(!t)return 1;let e=t.state;return !e||e.strm!==t||e.mode<wu||e.mode>16211?1:0},SA=t=>{if(ws(t))return Ji;let e=t.state;return t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=wu,e.last=0,e.havedict=0,e.flags=-1,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array(852),e.distcode=e.distdyn=new Int32Array(592),e.sane=1,e.back=-1,bs},RA=t=>{if(ws(t))return Ji;let e=t.state;return e.wsize=0,e.whave=0,e.wnext=0,SA(t)},CA=(t,e)=>{let n;if(ws(t))return Ji;let i=t.state;return e<0?(n=0,e=-e):(n=5+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?Ji:(i.window!==null&&i.wbits!==e&&(i.window=null),i.wrap=n,i.wbits=e,RA(t))},vA=(t,e)=>{if(!t)return Ji;let n=new t3;t.state=n,n.strm=t,n.window=null,n.mode=wu;let i=CA(t,e);return i!==bs&&(t.state=null),i},vE,IE,IA=!0,e3=t=>{if(IA){vE=new Int32Array(512),IE=new Int32Array(32);let e=0;for(;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(Ed(1,t.lens,0,288,vE,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;Ed(2,t.lens,0,32,IE,0,t.work,{bits:5}),IA=!1;}t.lencode=vE,t.lenbits=9,t.distcode=IE,t.distbits=5;},yA=(t,e,n,i)=>{let r,o=t.state;return o.window===null&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),i>=o.wsize?(o.window.set(e.subarray(n-o.wsize,n),0),o.wnext=0,o.whave=o.wsize):(r=o.wsize-o.wnext,r>i&&(r=i),o.window.set(e.subarray(n-i,n-i+r),o.wnext),(i-=r)?(o.window.set(e.subarray(n-i,n),0),o.wnext=i,o.whave=o.wsize):(o.wnext+=r,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=r))),0};var n3=(t,e)=>{let n,i,r,o,s,a,c,d,l,u,h,p,T,m,E,S,C,A,b,O,N,k,M=0,x=new Uint8Array(4),X,bt,Ft=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(ws(t)||!t.output||!t.input&&t.avail_in!==0)return Ji;n=t.state,n.mode===ro&&(n.mode=SE),s=t.next_out,r=t.output,c=t.avail_out,o=t.next_in,i=t.input,a=t.avail_in,d=n.hold,l=n.bits,u=a,h=c,k=bs;t:for(;;)switch(n.mode){case wu:if(n.wrap===0){n.mode=SE;break}for(;l<16;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8;}if(2&n.wrap&&d===35615){n.wbits===0&&(n.wbits=15),n.check=0,x[0]=255&d,x[1]=d>>>8&255,n.check=Ln(n.check,x,2,0),d=0,l=0,n.mode=16181;break}if(n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&d)<<8)+(d>>8))%31){t.msg="incorrect header check",n.mode=en;break}if((15&d)!==gA){t.msg="unknown compression method",n.mode=en;break}if(d>>>=4,l-=4,N=8+(15&d),n.wbits===0&&(n.wbits=N),N>15||N>n.wbits){t.msg="invalid window size",n.mode=en;break}n.dmax=1<<n.wbits,n.flags=0,t.adler=n.check=1,n.mode=512&d?16189:ro,d=0,l=0;break;case 16181:for(;l<16;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8;}if(n.flags=d,(255&yn(n))!==gA){t.msg="unknown compression method",n.mode=en;break}if(57344&yn(n)){t.msg="unknown header flags set",n.mode=en;break}n.head&&(n.head.text=d>>8&1),512&yn(n)&&4&n.wrap&&(x[0]=255&d,x[1]=d>>>8&255,n.check=Ln(n.check,x,2,0)),d=0,l=0,n.mode=16182;case 16182:for(;l<32;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8;}n.head&&(n.head.time=d),512&yn(n)&&4&n.wrap&&(x[0]=255&d,x[1]=d>>>8&255,x[2]=d>>>16&255,x[3]=d>>>24&255,n.check=Ln(n.check,x,4,0)),d=0,l=0,n.mode=16183;case 16183:for(;l<16;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8;}n.head&&(n.head.xflags=255&d,n.head.os=d>>8),512&yn(n)&&4&n.wrap&&(x[0]=255&d,x[1]=d>>>8&255,n.check=Ln(n.check,x,2,0)),d=0,l=0,n.mode=16184;case 16184:if(1024&yn(n)){for(;l<16;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8;}n.length=d,n.head&&(n.head.extra_len=d),512&yn(n)&&4&n.wrap&&(x[0]=255&d,x[1]=d>>>8&255,n.check=Ln(n.check,x,2,0)),d=0,l=0;}else n.head&&(n.head.extra=null);n.mode=16185;case 16185:if(1024&yn(n)&&(p=n.length,p>a&&(p=a),p&&(n.head&&(N=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Uint8Array(n.head.extra_len)),n.head.extra.set(i.subarray(o,o+p),N)),512&yn(n)&&4&n.wrap&&(n.check=Ln(n.check,i,p,o)),a-=p,o+=p,n.length-=p),n.length))break t;n.length=0,n.mode=16186;case 16186:if(2048&yn(n)){if(a===0)break t;p=0;do N=i[o+p++],n.head&&N&&n.length<65536&&(n.head.name+=String.fromCharCode(N));while(N&&p<a);if(512&yn(n)&&4&n.wrap&&(n.check=Ln(n.check,i,p,o)),a-=p,o+=p,N)break t}else n.head&&(n.head.name=null);n.length=0,n.mode=16187;case 16187:if(4096&yn(n)){if(a===0)break t;p=0;do N=i[o+p++],n.head&&N&&n.length<65536&&(n.head.comment+=String.fromCharCode(N));while(N&&p<a);if(512&yn(n)&&4&n.wrap&&(n.check=Ln(n.check,i,p,o)),a-=p,o+=p,N)break t}else n.head&&(n.head.comment=null);n.mode=16188;case 16188:if(512&yn(n)){for(;l<16;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8;}if(4&n.wrap&&d!==(65535&n.check)){t.msg="header crc mismatch",n.mode=en;break}d=0,l=0;}n.head&&(n.head.hcrc=yn(n)>>9&1,n.head.done=!0),t.adler=n.check=0,n.mode=ro;break;case 16189:for(;l<32;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8;}t.adler=n.check=TA(d),d=0,l=0,n.mode=Ou;case Ou:if(n.havedict===0)return t.next_out=s,t.avail_out=c,t.next_in=o,t.avail_in=a,n.hold=d,n.bits=l,ZW;t.adler=n.check=1,n.mode=ro;case ro:if(e===XW||e===bu)break t;case SE:if(n.last){d>>>=7&l,l-=7&l,n.mode=CE;break}for(;l<3;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8;}switch(n.last=1&d,d>>>=1,l-=1,3&d){case 0:n.mode=16193;break;case 1:if(e3(n),n.mode=Nu,e===bu){d>>>=2,l-=2;break t}break;case 2:n.mode=16196;break;case 3:t.msg="invalid block type",n.mode=en;}d>>>=2,l-=2;break;case 16193:for(d>>>=7&l,l-=7&l;l<32;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8;}if((65535&d)!=(d>>>16^65535)){t.msg="invalid stored block lengths",n.mode=en;break}if(n.length=65535&d,d=0,l=0,n.mode=RE,e===bu)break t;case RE:n.mode=16195;case 16195:if(p=n.length,p){if(p>a&&(p=a),p>c&&(p=c),p===0)break t;r.set(i.subarray(o,o+p),s),a-=p,o+=p,c-=p,s+=p,n.length-=p;break}n.mode=ro;break;case 16196:for(;l<14;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8;}if(n.nlen=257+(31&d),d>>>=5,l-=5,n.ndist=1+(31&d),d>>>=5,l-=5,n.ncode=4+(15&d),d>>>=4,l-=4,n.nlen>286||n.ndist>30){t.msg="too many length or distance symbols",n.mode=en;break}n.have=0,n.mode=16197;case 16197:for(;n.have<n.ncode;){for(;l<3;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8;}n.lens[Ft[n.have++]]=7&d,d>>>=3,l-=3;}for(;n.have<19;)n.lens[Ft[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,X={bits:n.lenbits},k=Ed(0,n.lens,0,19,n.lencode,0,n.work,X),n.lenbits=X.bits,k){t.msg="invalid code lengths set",n.mode=en;break}n.have=0,n.mode=16198;case 16198:for(;n.have<n.nlen+n.ndist;){for(;M=n.lencode[d&(1<<n.lenbits)-1],E=M>>>24,S=M>>>16&255,C=65535&M,!(E<=l);){if(a===0)break t;a--,d+=i[o++]<<l,l+=8;}if(C<16)d>>>=E,l-=E,n.lens[n.have++]=C;else {if(C===16){for(bt=E+2;l<bt;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8;}if(d>>>=E,l-=E,n.have===0){t.msg="invalid bit length repeat",n.mode=en;break}N=n.lens[n.have-1],p=3+(3&d),d>>>=2,l-=2;}else if(C===17){for(bt=E+3;l<bt;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8;}d>>>=E,l-=E,N=0,p=3+(7&d),d>>>=3,l-=3;}else {for(bt=E+7;l<bt;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8;}d>>>=E,l-=E,N=0,p=11+(127&d),d>>>=7,l-=7;}if(n.have+p>n.nlen+n.ndist){t.msg="invalid bit length repeat",n.mode=en;break}for(;p--;)n.lens[n.have++]=N;}}if(n.mode===en)break;if(n.lens[256]===0){t.msg="invalid code -- missing end-of-block",n.mode=en;break}if(n.lenbits=9,X={bits:n.lenbits},k=Ed(1,n.lens,0,n.nlen,n.lencode,0,n.work,X),n.lenbits=X.bits,k){t.msg="invalid literal/lengths set",n.mode=en;break}if(n.distbits=6,n.distcode=n.distdyn,X={bits:n.distbits},k=Ed(2,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,X),n.distbits=X.bits,k){t.msg="invalid distances set",n.mode=en;break}if(n.mode=Nu,e===bu)break t;case Nu:n.mode=Du;case Du:if(a>=6&&c>=258){t.next_out=s,t.avail_out=c,t.next_in=o,t.avail_in=a,n.hold=d,n.bits=l,KW(t,h),s=t.next_out,r=t.output,c=t.avail_out,o=t.next_in,i=t.input,a=t.avail_in,d=n.hold,l=n.bits,n.mode===ro&&(n.back=-1);break}for(n.back=0;M=n.lencode[d&(1<<n.lenbits)-1],E=M>>>24,S=M>>>16&255,C=65535&M,!(E<=l);){if(a===0)break t;a--,d+=i[o++]<<l,l+=8;}if(S&&!(240&S)){for(A=E,b=S,O=C;M=n.lencode[O+((d&(1<<A+b)-1)>>A)],E=M>>>24,S=M>>>16&255,C=65535&M,!(A+E<=l);){if(a===0)break t;a--,d+=i[o++]<<l,l+=8;}d>>>=A,l-=A,n.back+=A;}if(d>>>=E,l-=E,n.back+=E,n.length=C,S===0){n.mode=16205;break}if(32&S){n.back=-1,n.mode=ro;break}if(64&S){t.msg="invalid literal/length code",n.mode=en;break}n.extra=15&S,n.mode=16201;case 16201:if(n.extra){for(bt=n.extra;l<bt;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8;}n.length+=d&(1<<n.extra)-1,d>>>=n.extra,l-=n.extra,n.back+=n.extra;}n.was=n.length,n.mode=16202;case 16202:for(;M=n.distcode[d&(1<<n.distbits)-1],E=M>>>24,S=M>>>16&255,C=65535&M,!(E<=l);){if(a===0)break t;a--,d+=i[o++]<<l,l+=8;}if(!(240&S)){for(A=E,b=S,O=C;M=n.distcode[O+((d&(1<<A+b)-1)>>A)],E=M>>>24,S=M>>>16&255,C=65535&M,!(A+E<=l);){if(a===0)break t;a--,d+=i[o++]<<l,l+=8;}d>>>=A,l-=A,n.back+=A;}if(d>>>=E,l-=E,n.back+=E,64&S){t.msg="invalid distance code",n.mode=en;break}n.offset=C,n.extra=15&S,n.mode=16203;case 16203:if(n.extra){for(bt=n.extra;l<bt;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8;}n.offset+=d&(1<<n.extra)-1,d>>>=n.extra,l-=n.extra,n.back+=n.extra;}if(n.offset>n.dmax){t.msg="invalid distance too far back",n.mode=en;break}n.mode=16204;case 16204:if(c===0)break t;if(p=h-c,n.offset>p){if(p=n.offset-p,p>n.whave&&n.sane){t.msg="invalid distance too far back",n.mode=en;break}p>n.wnext?(p-=n.wnext,T=n.wsize-p):T=n.wnext-p,p>n.length&&(p=n.length),m=n.window;}else m=r,T=s-n.offset,p=n.length;p>c&&(p=c),c-=p,n.length-=p;do r[s++]=m[T++];while(--p);n.length===0&&(n.mode=Du);break;case 16205:if(c===0)break t;r[s++]=n.length,c--,n.mode=Du;break;case CE:if(n.wrap){for(;l<32;){if(a===0)break t;a--,d|=i[o++]<<l,l+=8;}if(h-=c,t.total_out+=h,n.total+=h,4&n.wrap&&h&&(t.adler=n.check=yn(n)?Ln(n.check,r,h,s-h):ad(n.check,r,h,s-h)),h=c,4&n.wrap&&(yn(n)?d:TA(d))!==n.check){t.msg="incorrect data check",n.mode=en;break}d=0,l=0;}n.mode=16207;case 16207:if(n.wrap&&yn(n)){for(;l<32;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8;}if(4&n.wrap&&d!==(4294967295&n.total)){t.msg="incorrect length check",n.mode=en;break}d=0,l=0;}n.mode=16208;case 16208:k=QW;break t;case en:k=EA;break t;case 16210:return fA;default:return Ji}return t.next_out=s,t.avail_out=c,t.next_in=o,t.avail_in=a,n.hold=d,n.bits=l,(n.wsize||h!==t.avail_out&&n.mode<en&&(n.mode<CE||e!==mA))&&yA(t,t.output,t.next_out,h-t.avail_out),u-=t.avail_in,h-=t.avail_out,t.total_in+=u,t.total_out+=h,n.total+=h,4&n.wrap&&h&&(t.adler=n.check=yn(n)?Ln(n.check,r,h,t.next_out-h):ad(n.check,r,h,t.next_out-h)),t.data_type=n.bits+(n.last?64:0)+(n.mode===ro?128:0)+(n.mode===Nu||n.mode===RE?256:0),(u===0&&h===0||e===mA)&&k===bs&&(k=$W),k},oo={inflateReset:RA,inflateReset2:CA,inflateResetKeep:SA,inflateInit:t=>vA(t,15),inflateInit2:vA,inflate:n3,inflateEnd:t=>{if(ws(t))return Ji;let e=t.state;return e.window&&(e.window=null),t.state=null,bs},inflateGetHeader:(t,e)=>{if(ws(t))return Ji;let n=t.state;return 2&n.wrap?(n.head=e,e.done=!1,bs):Ji},inflateSetDictionary:(t,e)=>{let n=e.length,i,r,o;return ws(t)?Ji:(i=t.state,i.wrap!==0&&i.mode!==Ou?Ji:i.mode===Ou&&(r=1,r=ad(r,e,n,0),r!==i.check)?EA:(o=yA(t,e,n,n),o?(i.mode=16210,fA):(i.havedict=1,bs)))},inflateInfo:"pako inflate (from Nodeca project)"},i3=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1;};let AA=Object.prototype.toString,{Z_NO_FLUSH:r3,Z_FINISH:o3,Z_OK:fd,Z_STREAM_END:yE,Z_NEED_DICT:AE,Z_STREAM_ERROR:s3,Z_DATA_ERROR:bA,Z_MEM_ERROR:a3}=La;function gd(t){this.options=vu.assign({chunkSize:65536,windowBits:15,to:""},t||{});let e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,e.windowBits===0&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&!(15&e.windowBits)&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new pA,this.strm.avail_out=0;let n=oo.inflateInit2(this.strm,e.windowBits);if(n!==fd)throw new Error(vs[n]);if(this.header=new i3,oo.inflateGetHeader(this.strm,this.header),e.dictionary&&(typeof e.dictionary=="string"?e.dictionary=_d.string2buf(e.dictionary):AA.call(e.dictionary)==="[object ArrayBuffer]"&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(n=oo.inflateSetDictionary(this.strm,e.dictionary),n!==fd)))throw new Error(vs[n])}function bE(t,e){let n=new gd(e);if(n.push(t),n.err)throw n.msg||vs[n.err];return n.result}gd.prototype.push=function(t,e){let n=this.strm,i=this.options.chunkSize,r=this.options.dictionary,o,s,a;if(this.ended)return !1;for(s=e===~~e?e:e===!0?o3:r3,AA.call(t)==="[object ArrayBuffer]"?n.input=new Uint8Array(t):n.input=t,n.next_in=0,n.avail_in=n.input.length;;){for(n.avail_out===0&&(n.output=new Uint8Array(i),n.next_out=0,n.avail_out=i),o=oo.inflate(n,s),o===AE&&r&&(o=oo.inflateSetDictionary(n,r),o===fd?o=oo.inflate(n,s):o===bA&&(o=AE));n.avail_in>0&&o===yE&&n.state.wrap>0&&t[n.next_in]!==0;)oo.inflateReset(n),o=oo.inflate(n,s);switch(o){case s3:case bA:case AE:case a3:return this.onEnd(o),this.ended=!0,!1}if(a=n.avail_out,n.next_out&&(n.avail_out===0||o===yE))if(this.options.to==="string"){let c=_d.utf8border(n.output,n.next_out),d=n.next_out-c,l=_d.buf2string(n.output,c);n.next_out=d,n.avail_out=i-d,d&&n.output.set(n.output.subarray(c,c+d),0),this.onData(l);}else this.onData(n.output.length===n.next_out?n.output:n.output.subarray(0,n.next_out));if(o!==fd||a!==0){if(o===yE)return o=oo.inflateEnd(this.strm),this.onEnd(o),this.ended=!0,!0;if(n.avail_in===0)break}}return !0},gd.prototype.onData=function(t){this.chunks.push(t);},gd.prototype.onEnd=function(t){t===fd&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=vu.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg;};var c3={Inflate:gd,inflate:bE,inflateRaw:function(t,e){return (e=e||{}).raw=!0,bE(t,e)},ungzip:bE,constants:La};let{Deflate:r4,deflate:d3,deflateRaw:o4,gzip:s4}=HW,{Inflate:a4,inflate:l3,inflateRaw:c4,ungzip:d4}=c3;var u3=d3,h3=l3;let un={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1,supportRequestVideoFrameCallback:!1,supportWebCrypto:!1};function Ot(){return un}function wA(){return "setSinkId"in HTMLAudioElement.prototype&&(!v("RESTRICTION_SET_PLAYBACK_DEVICE")||(vo()||Bv())&&!rm())}let on=function(t){return t.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",t.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",t.IOS_INTERRUPTION_START="ios-interruption-start",t.IOS_INTERRUPTION_END="ios-interruption-end",t.STATE_CHANGE="state-change",t}({});function xa(t,e,n){return {sampleRate:t,stereo:e,bitrate:n}}function Dt(t,e,n,i,r){return {width:t,height:e,frameRate:n,bitrateMin:i,bitrateMax:r}}function Xi(t,e,n,i,r){return {width:{max:t},height:{max:e},frameRate:n,bitrateMin:i,bitrateMax:r}}function wE(t,e){return {numSpatialLayers:t,numTemporalLayers:e}}let p3={"90p":Dt(160,90),"90p_1":Dt(160,90),"120p":Dt(160,120,15,30,65),"120p_1":Dt(160,120,15,30,65),"120p_3":Dt(120,120,15,30,50),"120p_4":Dt(212,120),"180p":Dt(320,180,15,30,140),"180p_1":Dt(320,180,15,30,140),"180p_3":Dt(180,180,15,30,100),"180p_4":Dt(240,180,15,30,120),"240p":Dt(320,240,15,40,200),"240p_1":Dt(320,240,15,40,200),"240p_3":Dt(240,240,15,40,140),"240p_4":Dt(424,240,15,40,220),"360p":Dt(640,360,15,80,400),"360p_1":Dt(640,360,15,80,400),"360p_3":Dt(360,360,15,80,260),"360p_4":Dt(640,360,30,80,600),"360p_6":Dt(360,360,30,80,400),"360p_7":Dt(480,360,15,80,320),"360p_8":Dt(480,360,30,80,490),"360p_9":Dt(640,360,15,80,800),"360p_10":Dt(640,360,24,80,800),"360p_11":Dt(640,360,24,80,1e3),"480p":Dt(640,480,15,100,500),"480p_1":Dt(640,480,15,100,500),"480p_2":Dt(640,480,30,100,1e3),"480p_3":Dt(480,480,15,100,400),"480p_4":Dt(640,480,30,100,750),"480p_6":Dt(480,480,30,100,600),"480p_8":Dt(848,480,15,100,610),"480p_9":Dt(848,480,30,100,930),"480p_10":Dt(640,480,10,100,400),"720p":Dt(1280,720,15,120,1130),"720p_auto":Dt(1280,720,30,900,3e3),"720p_1":Dt(1280,720,15,120,1130),"720p_2":Dt(1280,720,30,120,2e3),"720p_3":Dt(1280,720,30,120,1710),"720p_5":Dt(960,720,15,120,910),"720p_6":Dt(960,720,30,120,1380),"1080p":Dt(1920,1080,15,120,2080),"1080p_1":Dt(1920,1080,15,120,2080),"1080p_2":Dt(1920,1080,30,120,3e3),"1080p_3":Dt(1920,1080,30,120,3150),"1080p_5":Dt(1920,1080,60,120,4780),"1440p":Dt(2560,1440,30,120,4850),"1440p_1":Dt(2560,1440,30,120,4850),"1440p_2":Dt(2560,1440,60,120,7350),"4k":Dt(3840,2160,30,120,8910),"4k_1":Dt(3840,2160,30,120,8910),"4k_3":Dt(3840,2160,60,120,13500)},Pu=[{scaleResolutionDownBy:2,width:1280,height:720,frameRate:30,bitrateMin:300,bitrateMax:900},{scaleResolutionDownBy:1.333333,width:1280,height:720,frameRate:30,bitrateMin:600,bitrateMax:2e3},{scaleResolutionDownBy:1,width:1280,height:720,frameRate:30,bitrateMin:900,bitrateMax:3e3}],_3={"480p":Xi(640,480,5),"480p_1":Xi(640,480,5),"480p_2":Xi(640,480,30),"480p_3":Xi(640,480,15),"720p":Xi(1280,720,5),"720p_auto":Dt(1280,720,30,900,3e3),"720p_1":Xi(1280,720,5),"720p_2":Xi(1280,720,30),"720p_3":Xi(1280,720,15),"1080p":Xi(1920,1080,5),"1080p_1":Xi(1920,1080,5),"1080p_2":Xi(1920,1080,30),"1080p_3":Xi(1920,1080,15)},m3={"1SL1TL":wE(1,1),"3SL3TL":wE(3,3),"2SL3TL":wE(2,3)};function xr(t){return t||(t="480p_1"),typeof t=="string"?Object.assign({},p3[t]):t}function OE(t){return typeof t=="string"?Object.assign({},_3[t]):t}function Lu(t){return typeof t=="string"?Object.assign({},m3[t]):t}let E3={speech_low_quality:xa(16e3,!1),speech_standard:xa(32e3,!1,18),music_standard:xa(48e3,!1),standard_stereo:xa(48e3,!0,56),high_quality:xa(48e3,!1,128),high_quality_stereo:xa(48e3,!0,192)};function ku(t){return typeof t=="string"?Object.assign({},E3[t]):t}let Va=[];function OA(t){return Ge(t,"mediaSource",["screen","window","application"]),!0}let J=function(t){return t.NEED_RENEGOTIATE="@need_renegotiate",t.NEED_REPLACE_TRACK="@need_replace_track",t.NEED_REPLACE_MIXING_TRACK="@need_replace_mixing_track",t.NEED_CLOSE="@need_close",t.NEED_ENABLE_TRACK="@need_enable_track",t.NEED_DISABLE_TRACK="@need_disable_track",t.NEED_SESSION_ID="@need_sid",t.SET_OPTIMIZATION_MODE="@set_optimization_mode",t.GET_STATS="@get_stats",t.GET_RTC_STATS="@get_rtc_stats",t.GET_LOW_VIDEO_TRACK="@get_low_video_track",t.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",t.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",t.NEED_UPDATE_VIDEO_SEND_PARAMETERS="@need_update_video_send_parameters",t.NEED_MUTE_TRACK="@need_mute_track",t.NEED_UNMUTE_TRACK="@need_unmute_track",t}({}),ie=function(t){return t.SCREEN_TRACK="screen_track",t.CUSTOM_TRACK="custome_track",t.LOW_STREAM="low_stream",t}({}),Fa=function(t){return t[t.HIGH_STREAM=0]="HIGH_STREAM",t[t.LOW_STREAM=1]="LOW_STREAM",t}({}),f3=function(t){return t[t.HIGH_STREAM=0]="HIGH_STREAM",t[t.LOW_STREAM=1]="LOW_STREAM",t}({}),g3=function(t){return t[t.DISABLE=0]="DISABLE",t[t.LOW_STREAM=1]="LOW_STREAM",t[t.AUDIO_ONLY=2]="AUDIO_ONLY",t}({}),Os=function(t){return t.TRANSCEIVER_UPDATED="transceiver-updated",t.SEI_TO_SEND="sei-to-send",t.SEI_RECEIVED="sei-received",t.TRACK_UPDATED="track-updated",t}({}),Ba=function(t){return t.SOURCE_STATE_CHANGE="source-state-change",t.TRACK_ENDED="track-ended",t.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",t.CLOSED="closed",t}({}),ja=function(t){return t.FIRST_FRAME_DECODED="first-frame-decoded",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",t.VIDEO_STATE_CHANGED="video-state-changed",t}({}),ci=function(t){return t.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",t.RECEIVE_TRACK_BUFFER="receive_track_buffer",t.ON_AUDIO_BUFFER="on_audio_buffer",t.UPDATE_SOURCE="update_source",t}({});(function(t){t.UPDATE_TRACK_SOURCE="update-track-source";})({});let NE={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},DE={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},NA={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},T3={uplinkNetworkQuality:0,downlinkNetworkQuality:0},DA={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},kn=function(t){return t.ON_TRACK="on_track",t.ON_NODE="on_node",t}({}),di=function(t){return t.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",t.REQUEST_CONSTRAINTS="request_constraints",t}({}),Td=function(t){return t.IDLE="IDLE",t.INITING="INITING",t.INITEND="INITEND",t}({}),Ns=function(t){return t.STATE_CHANGE="state_change",t.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",t.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",t.CAMERA_DEVICE_CHANGED="cameraDeviceChanged",t}({}),An=function(t){return t.NONE="none",t.INIT="init",t.CANPLAY="canplay",t.PLAYING="playing",t.PAUSED="paused",t.SUSPEND="suspend",t.STALLED="stalled",t.WAITING="waiting",t.ERROR="error",t.DESTROYED="destroyed",t.ABORT="abort",t.ENDED="ended",t.EMPTIED="emptied",t.LOADEDDATA="loadeddata",t}({}),Vr=function(t){return t[t.VideoStateStopped=0]="VideoStateStopped",t[t.VideoStateStarting=1]="VideoStateStarting",t[t.VideoStateDecoding=2]="VideoStateDecoding",t[t.VideoStateFrozen=3]="VideoStateFrozen",t}({}),PE={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370},Mu=function(t){return t.OPEN="open",t.MESSAGE="message",t.CLOSE="close",t.CLOSING="closing",t.ERROR="error",t}({});function PA(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function le(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?PA(Object(n),!0).forEach(function(i){P(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):PA(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}function P(t,e,n){return (e=function(i){var r=function(o,s){if(typeof o!="object"||o===null)return o;var a=o[Symbol.toPrimitive];if(a!==void 0){var c=a.call(o,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(i);return typeof r=="symbol"?r:String(r)}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function Nt(t,e,n,i,r){var o,s,a={};return Object.keys(i).forEach(function(c){a[c]=i[c];}),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=rr(o=eG(s=n.slice()).call(s)).call(o,function(c,d){return d(t,e,c)||c},a),r&&a.initializer!==void 0&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),a.initializer===void 0&&(Object.defineProperty(t,e,a),a=null),a}class LA extends de{set _mediaStreamTrack(e){e!==this.mediaStreamTrack&&(this.safeEmit(Os.TRACK_UPDATED,e),this.mediaStreamTrack=e);}get _mediaStreamTrack(){return this.mediaStreamTrack}constructor(e,n){super(),P(this,"trackMediaType",void 0),P(this,"_ID",void 0),P(this,"_rtpTransceiver",void 0),P(this,"_lowRtpTransceiver",void 0),P(this,"_hints",[]),P(this,"_isClosed",!1),P(this,"_originMediaStreamTrack",void 0),P(this,"mediaStreamTrack",void 0),P(this,"_external",{}),this._ID=n||Zt(8,"track-"),this._originMediaStreamTrack=e,this.mediaStreamTrack=e,function(i){q(Va).call(Va,i)||Va.push(i);}(this);}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(e){return e||yo(()=>{var n;et.reportApiInvoke(null,{name:ke.GET_MEDIA_STREAM_TRACK,options:[],tag:ge.TRACER}).onSuccess(((n=this._mediaStreamTrack)===null||n===void 0?void 0:n.label)||"");},this.mediaStreamTrack.id||this.getTrackId()),this._mediaStreamTrack}getRTCRtpTransceiver(e){return e===Fa.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(e){let n=Va.indexOf(e);n!==-1&&Va.splice(n,1);}(this),this.emit(Ba.CLOSED),this.removeAllListeners(Os.SEI_RECEIVED);}_updateRtpTransceiver(e,n){if(n===Fa.LOW_STREAM){if(this._lowRtpTransceiver===e)return;this._lowRtpTransceiver=e;}else {if(this._rtpTransceiver===e)return;this._rtpTransceiver=e;}this.emit(Os.TRANSCEIVER_UPDATED,e,n);}}class Ga extends LA{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}constructor(e,n){super(e,n),P(this,"_enabled",!0),P(this,"_muted",!1),P(this,"_isExternalTrack",!1),P(this,"_isClosed",!1),P(this,"_enabledMutex",void 0),P(this,"processor",void 0),P(this,"_processorContext",void 0),P(this,"_handleTrackEnded",()=>{this.onTrackEnded();}),this._enabledMutex=new Qe("".concat(this.getTrackId())),e.addEventListener("ended",this._handleTrackEnded);}getTrackLabel(){var e,n;return (e=(n=this._originMediaStreamTrack)===null||n===void 0?void 0:n.label)!==null&&e!==void 0?e:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,_.debug("[".concat(this.getTrackId(),"] close")),this.emit(J.NEED_CLOSE),super.close());}async _updateOriginMediaStreamTrack(e,n){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this._isExternalTrack=i,e!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),n&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Qt(this,J.NEED_REPLACE_TRACK,this),this.processor&&this._processorContext&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this._processorContext}));}_getDefaultPlayerConfig(){return {}}onTrackEnded(){_.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(Ba.TRACK_ENDED);}stateCheck(e,n){if(_.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(e,": ").concat(n,"]")),Xr(n,e),this._enabled&&this._muted&&e==="enabled"&&n===!1)throw new D(R.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",_);if(!this._enabled&&!this._muted&&e==="muted"&&n===!0)throw new D(R.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",_)}getProcessorStats(){return this._processorContext&&this._processorContext.gatherStats()||[]}getProcessorUsage(){return this._processorContext?this._processorContext.gatherUsage():K.resolve([])}}let kA=window.AudioContext||window.webkitAudioContext,li=null,Kt=new class extends de{constructor(){super(...arguments),P(this,"prevState",void 0),P(this,"curState",void 0),P(this,"currentTime",void 0),P(this,"currentTimeStuckAt",void 0),P(this,"interruptDetectorTrack",void 0),P(this,"onLocalAudioTrackMute",()=>{_.info("ios15-interruption-start"),this.emit(on.IOS_15_16_INTERRUPTION_START);}),P(this,"onLocalAudioTrackUnmute",async()=>{_.info("ios15-interruption-end"),this.curState!=="running"||this.duringInterruption?_.info("ios15-interruption-end-canceled"):(li&&await li.suspend(),this.emit(on.IOS_15_16_INTERRUPTION_END));});}get duringInterruption(){return this.prevState==="running"&&this.curState==="interrupted"}bindInterruptDetectorTrack(t){_.debug("webaudio bindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=t,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute);}unbindInterruptDetectorTrack(t){_.debug("webaudio unbindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===t&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0);}};function Wa(){if(!li){if(function(){if(!kA)return void _.error("your browser is not support web audio");_.info("create audio context");let t=le({},v("WEBAUDIO_INIT_OPTIONS"));_.debug("audio context init option:",JSON.stringify(t)),li=new kA(t),Kt.curState=li.state,li.onstatechange=()=>{Kt.prevState=Kt.curState,Kt.curState=li?li.state:void 0;let{prevState:e,curState:n}=Kt,i=n==="running",r=n==="interrupted",o=e==="running",s=e==="suspended",a=e==="interrupted",c=Pt().osVersion;(mn()||Vi())&&o&&r&&(_.info("ios".concat(c,"-interruption-start")),Kt.emit(on.IOS_INTERRUPTION_START)),(mn()||Vi())&&(s||a)&&i&&(_.info("ios".concat(c,"-interruption-end")),Kt.emit(on.IOS_INTERRUPTION_END)),e!==n&&Kt.emit(on.STATE_CHANGE,n,e);},setInterval(()=>{var e;let n=(e=li)===null||e===void 0?void 0:e.currentTime;Kt.currentTime!==n?(Kt.currentTimeStuckAt&&(_.debug("AudioContext current time resume at ".concat(n)),Kt.currentTimeStuckAt=void 0),Kt.currentTime=n):(n!==Kt.currentTimeStuckAt&&(et.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:n},tag:ge.TRACER}).onSuccess(),_.warning("AudioContext current time stuck at ".concat(n))),Kt.currentTimeStuckAt=n);},5e3),async function(e){let n=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"],i,r=!1,o=!1,s=!1;function a(m){e.state==="running"?c(!1):mn()||Vi()?e.state==="suspended"&&(c(!0),m&&e.resume().then(d,d)):e.state!=="closed"&&(c(!0),m&&e.resume().then(d,d));}function c(m){if(r!==m){r=m;for(let E=0,S=n;E<S.length;E+=1){let C=S[E];m?window.addEventListener(C,l,{capture:!0,passive:!0}):window.removeEventListener(C,l,{capture:!0,passive:!0});}}}function d(){a(!1);}function l(){a(!0);}function u(m){if(!s)if(i.paused)if(m){let E;h(!1),s=!0;try{E=i.play(),E?E.then(p,p):(i.addEventListener("playing",p),i.addEventListener("abort",p),i.addEventListener("error",p));}catch{p();}}else h(!0);else h(!1);}function h(m){if(o!==m){o=m;for(let E=0,S=n;E<S.length;E++){let C=S[E];m?window.addEventListener(C,T,{capture:!0,passive:!0}):window.removeEventListener(C,T,{capture:!0,passive:!0});}}}function p(){i.removeEventListener("playing",p),i.removeEventListener("abort",p),i.removeEventListener("error",p),s=!1,u(!1);}function T(){u(!0);}if(mn()){let m=e.createMediaStreamDestination(),E=document.createElement("div");E.innerHTML="<audio x-webkit-airplay='deny'></audio>",i=E.children.item(0),i.controls=!1,i.disableRemotePlayback=!0,i.preload="auto",i.srcObject=m.stream,u(!0);}Kt.on(on.STATE_CHANGE,function(){a(!0);}),a(!1);}(li);}(),!li)throw new D(R.NOT_SUPPORTED,"can not create audio context");return li}return li}function Ds(t){if(function(){if(LE!==null)return LE;let i=Wa(),r=i.createBufferSource(),o=i.createGain(),s=i.createGain();r.connect(o),r.connect(s),r.disconnect(o);let a=!1;try{r.disconnect(o);}catch{a=!0;}return r.disconnect(),LE=a,a}())return;let e=t.connect,n=t.disconnect;t.connect=(i,r,o)=>{var s;return t._inputNodes||(t._inputNodes=[]),q(s=t._inputNodes).call(s,i)||(i instanceof AudioNode?(t._inputNodes.push(i),e.call(t,i,r,o)):e.call(t,i,r)),t},t.disconnect=(i,r,o)=>{n.call(t),i?ql(t._inputNodes,i):t._inputNodes=[];for(let s of t._inputNodes)e.call(t,s);};}let LE=null;function kE(t,e){let n=!1,i=1/e;if(v("DISABLE_WEBAUDIO")){let r=window.setInterval(()=>{n?window.clearInterval(r):t(performance.now()/1e3);},1e3*i);}else {let r=Wa(),o=r.createGain();o.gain.value=0,o.connect(r.destination);let s=()=>{if(n)return void(o=null);let a=r.createOscillator();a.onended=s,a.connect(o),a.start(0),a.stop(r.currentTime+i),t(r.currentTime);};s();}return ()=>{n=!0;}}class MA{constructor(){P(this,"context",void 0),P(this,"analyserNode",void 0),P(this,"sourceNode",void 0),this.context=Wa(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4;}updateSource(e){if(e!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode);}catch{}this.sourceNode=e,e?.connect(this.analyserNode);}}getVolumeLevel(){if(!this.sourceNode||(!this.context||mn()||Vi()||this.context.state!=="running"&&this.context.resume(),!this.analyserNode))return 0;let e=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(e);else {let i=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(i);for(let r=0;r<e.length;++r)e[r]=i[r]/128-1;}let n=rr(e).call(e,(i,r)=>i+r*r,0)/e.length;return Math.max(10*Math.log10(n)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var e,n;(e=this.sourceNode)===null||e===void 0||e.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,(n=this.sourceNode)===null||n===void 0||n.connect(this.analyserNode);}catch{_.warning("rebuild analyser node failed.");}}destroy(){this.updateSource(void 0);}}class UA extends de{get processSourceNode(){return this.sourceNode}set processedNode(e){var n;if(!this.isDestroyed&&this._processedNode!==e){try{var i;(i=this.sourceNode)===null||i===void 0||i.disconnect(this.outputNode);}catch{}(n=this._processedNode)===null||n===void 0||n.disconnect(),this._processedNode=e,this.connect();}}get processedNode(){return this._processedNode}constructor(){super(),P(this,"outputNode",void 0),P(this,"outputTrack",void 0),P(this,"isPlayed",!1),P(this,"sourceNode",void 0),P(this,"context",void 0),P(this,"audioBufferNode",void 0),P(this,"destNode",void 0),P(this,"audioOutputLevel",0),P(this,"volumeLevelAnalyser",void 0),P(this,"_processedNode",void 0),P(this,"playNode",void 0),P(this,"isDestroyed",!1),P(this,"onNoAudioInput",void 0),P(this,"isNoAudioInput",!1),P(this,"_noAudioInputCount",0),this.context=Wa(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),Ds(this.outputNode),this.volumeLevelAnalyser=new MA;}startGetAudioBuffer(e){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(e),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=n=>{this.emit(ci.ON_AUDIO_BUFFER,function(i){for(let r=0;r<i.outputBuffer.numberOfChannels;r+=1){let o=i.outputBuffer.getChannelData(r);for(let s=0;s<o.length;s+=1)o[s]=0;}return i.inputBuffer}(n));});}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0);}createOutputTrack(){if(!Ot().webAudioMediaStreamDest)throw new D(R.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(e){this.context.state!=="running"&&zl(()=>{Kt.emit("autoplay-failed");}),this.isPlayed=!0,this.playNode=e||this.context.destination,this.outputNode.connect(this.playNode);}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode);}catch{}this.isPlayed=!1;}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;if(e>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;mn()||Vi()?this.context.state==="suspended"&&this.context.resume():this.context.state!=="running"&&this.context.resume();let n=this.volumeLevelAnalyser.getAnalyserNode(),i;n.getFloatTimeDomainData?(i=new Float32Array(n.fftSize),n.getFloatTimeDomainData(i)):(i=new Uint8Array(n.fftSize),n.getByteTimeDomainData(i));let r=!1;for(let o=0;o<i.length;o++)i[o]!==0&&(r=!0);return r?(this.isNoAudioInput=!1,!0):(await Ye(200),await this.checkHasAudioInput(e?e+1:1)&&r)}getAudioVolume(){return this.outputNode.gain.value}setVolume(e){this.outputNode.gain.setValueAtTime(e,this.context.currentTime);}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0;}disconnect(){var e,n;(e=this.processedNode)===null||e===void 0||e.disconnect(),(n=this.sourceNode)===null||n===void 0||n.disconnect(),this.outputNode&&this.outputNode.disconnect();}connect(){var e;this.processedNode?(e=this.processedNode)===null||e===void 0||e.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode);}}class xA extends UA{get isFreeze(){return !1}constructor(e,n,i){var r;if(super(),P(this,"sourceNode",void 0),P(this,"track",void 0),P(this,"clonedTrack",void 0),P(this,"audioElement",void 0),P(this,"isCurrentTrackCloned",!1),P(this,"isRemoteTrack",!1),P(this,"originVolumeLevelAnalyser",void 0),P(this,"rebuildWebAudio",async()=>{if(_.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void _.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then(()=>_.info("resume success")),_.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();let a=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?a.stop():this.isCurrentTrackCloned=!0;let c=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(c),Ds(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();let d=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(d,this.context.currentTime),Ds(this.outputNode),this.emit(ci.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=c,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput();}),e.kind!=="audio")throw new D(R.UNEXPECTED_ERROR);this.track=e;let o=new MediaStream([this.track]);if(this.isRemoteTrack=!!n,this.sourceNode=this.context.createMediaStreamSource(o),Ds(this.sourceNode),i){let a=i.clone();a.enabled=!0,this.clonedTrack=a,_.debug("create an unmuted track ".concat(a.id," from the original track ").concat(i.id," to get the volume"));let c=this.context.createMediaStreamSource(new MediaStream([a]));Ds(c),this.originVolumeLevelAnalyser=new MA,this.originVolumeLevelAnalyser.updateSource(c);}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=o;let s=Pt();n&&s.os===He.IOS&&Number((r=s.osVersion)===null||r===void 0?void 0:r.split(".")[0])<15&&(Kt.on(on.STATE_CHANGE,()=>{this.context.state==="suspended"?document.body.addEventListener("click",this.rebuildWebAudio,!0):this.context.state==="running"&&this.rebuildWebAudio();}),this.checkHasAudioInput().then(a=>{a||document.body.addEventListener("click",this.rebuildWebAudio,!0);}));}updateTrack(e){this.sourceNode.disconnect(),this.track=e,this.isCurrentTrackCloned=!1;let n=new MediaStream([e]);this.sourceNode=this.context.createMediaStreamSource(n),Ds(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(ci.UPDATE_SOURCE),this.audioElement.srcObject=n;}destroy(){var e;this.audioElement.srcObject=null,this.audioElement.remove(),Kt.off("state-change",this.rebuildWebAudio),(e=this.originVolumeLevelAnalyser)===null||e===void 0||e.destroy(),this.clonedTrack=void 0,super.destroy();}createMediaStreamSourceNode(e){return this.context.createMediaStreamSource(new MediaStream([e]))}updateOriginTrack(e){let n=e.clone();n.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=n),_.debug("create an unmuted track ".concat(n.id," from the original track ").concat(e.id," to get the volume"));let i=this.context.createMediaStreamSource(new MediaStream([n]));Ds(i),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(i);}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function VA(t,e,n){let i=(o,s)=>o?typeof o!="number"?o.max||o.exact||o.ideal||o.min||s:o:s,r={audio:!!n&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxHeight:i(e.height,1080),maxWidth:i(e.width,1920)}}};return e.frameRate&&typeof e.frameRate!="number"?(r.video.mandatory.maxFrameRate=e.frameRate.max,r.video.mandatory.minFrameRate=e.frameRate.min):typeof e.frameRate=="number"&&(r.video.mandatory.maxFrameRate=e.frameRate),await navigator.mediaDevices.getUserMedia(r)}async function S3(t,e){let n=await FA(t.mediaSource),{sourceId:i,audio:r}=await function(o){let s=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new K((a,c)=>{let d=document.createElement("div");d.innerText="share screen",d.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");let l=document.createElement("div");l.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");let u=document.createElement("div");u.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",u.setAttribute("style","height: 12%;");let h=document.createElement("div");h.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");let p=document.createElement("div");p.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");let T=document.createElement("button");T.innerHTML="cancel",T.setAttribute("style","width: 85px;"),T.onclick=()=>{document.body.removeChild(S);let C=new Error("NotAllowedError");C.name="NotAllowedError",c(C);};let m=s,E=document.createElement("div");if(s){let C=document.createElement("input");C.setAttribute("type","checkbox");let A=document.createElement("span");C.setAttribute("style","margin-right: 6px;"),A.innerText="Share audio",C.checked=m,C.onchange=()=>{m=C.checked;},E.appendChild(C),E.appendChild(A);}p.appendChild(E),p.appendChild(T),l.appendChild(u),l.appendChild(h),l.appendChild(p);let S=document.createElement("div");S.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),S.appendChild(d),S.appendChild(l),document.body.appendChild(S),o.map(C=>{if(C.id){let A=document.createElement("div");A.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let b=C.thumbnail;try{let{width:O}=b.getSize();O>1920&&(b=b.resize({width:1920}));}catch(O){throw O&&O.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),O}A.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+b.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+C.name.replace(/[\u00A0-\u9999<>\&]/g,function(O){return "&#"+O.charCodeAt(0)+";"})+"</span>",A.onclick=()=>{document.body.removeChild(S),a({sourceId:C.id,audio:m});},h.appendChild(A);}});})}(n,e);return await VA(i,t,r)}async function FA(t){let e=["window","screen"];t!=="application"&&t!=="window"||(e=["window"]),t==="screen"&&(e=["screen"]);let n=iI();if(!n)throw console.error("failed to fetch electron, please mount it to window"),new D(R.ELECTRON_IS_NULL);let i=null;try{var r;i=((r=n.desktopCapturer)===null||r===void 0?void 0:r.getSources({types:e}))||n.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:e});}catch{i=null;}i&&i.then||(i=new K((o,s)=>{n.desktopCapturer.getSources({types:e},(a,c)=>{a?s(a):o(c);});}));try{return await i}catch(o){throw new D(R.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,o.toString())}}let ME=new Qe("safari"),BA=!1,jA=!1;async function ui(t,e){let n=0,i=null;for(;n<2;)try{i=await R3(t,e,n>0);break}catch(r){if(r instanceof D)throw _.error("[".concat(e,"] ").concat(r.toString())),r;let o=Uu(r.name||r.code||r,r.message);if(o.code===R.MEDIA_OPTION_INVALID){_.debug("[".concat(e,"] detect media option invalid, retry")),n+=1,await Ye(500);continue}throw _.error("[".concat(e,"] ").concat(o.toString())),o}if(!i)throw new D(R.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return i}async function R3(t,e,n){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new D(R.NOT_SUPPORTED,"can not find getUserMedia");n&&(t.video&&(delete t.video.width,delete t.video.height),t.screen&&(delete t.screen.width,delete t.screen.height));let i=Ot(),r=new MediaStream;if(t.audioSource&&r.addTrack(t.audioSource),t.videoSource&&r.addTrack(t.videoSource),!t.audio&&!t.video&&!t.screen)return _.debug("Using Video Source/ Audio Source"),r;if(t.screen)if(iI())t.screen.sourceId?Ha(r,await VA(t.screen.sourceId,t.screen,t.screenAudio)):Ha(r,await S3(t.screen,t.screenAudio));else if(vo()&&t.screen.extensionId&&t.screen.mandatory){if(!i.getStreamFromExtension)throw new D(R.NOT_SUPPORTED,"This browser does not support screen sharing");_.debug("[".concat(e,'] Screen access on chrome stable, looking for extension"'));let h=await(s=t.screen.extensionId,a=e,new K((p,T)=>{try{chrome.runtime.sendMessage(s,{getStream:!0},m=>{if(!m||!m.streamId)return _.error("[".concat(a,"] No response from Chrome Plugin. Plugin not installed properly"),m),void T(new D(R.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));p(m.streamId);});}catch(m){_.error("[".concat(a,"] AgoraRTC screensharing plugin is not accessible(").concat(s,")"),m.toString()),T(new D(R.CHROME_PLUGIN_NOT_INSTALL));}}));t.screen.mandatory.chromeMediaSourceId=h,Ha(r,await navigator.mediaDevices.getUserMedia({video:{mandatory:t.screen.mandatory}}));}else if(i.getDisplayMedia){var o;t.screen.mediaSource&&OA(t.screen.mediaSource);let h={width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate,displaySurface:(o=t.screen.displaySurface)!==null&&o!==void 0?o:t.screen.mediaSource==="screen"?"monitor":t.screen.mediaSource},{selfBrowserSurface:p,surfaceSwitching:T,systemAudio:m}=t.screen,E={selfBrowserSurface:p,surfaceSwitching:T,systemAudio:m};!p&&delete E.selfBrowserSurface,!T&&delete E.surfaceSwitching,!m&&delete E.systemAudio,_.debug("[".concat(e,"] getDisplayMedia:"),JSON.stringify({video:h,audio:!!t.screenAudio,controls:E})),Ha(r,await navigator.mediaDevices.getDisplayMedia(le({video:h,audio:!!t.screenAudio},E)));}else {if(!Xt())throw _.error("[".concat(e,"] This browser does not support screenSharing")),new D(R.NOT_SUPPORTED,"This browser does not support screen sharing");{t.screen.mediaSource&&OA(t.screen.mediaSource);let h={video:{mediaSource:t.screen.mediaSource,width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate}};_.debug("[".concat(e,"] getUserMedia: ").concat(JSON.stringify(h))),Ha(r,await navigator.mediaDevices.getUserMedia(h));}}var s,a;if(!t.video&&!t.audio)return r;let c={video:t.video,audio:t.audio},d=v("MEDIA_DEVICE_CONSTRAINTS");if(d)try{typeof d=="string"&&(d=JSON.parse(d)),c=dm(c,d);}catch{}_.debug("[".concat(e,"] GetUserMedia"),JSON.stringify(c)),Pt();let l,u=null;(Ke()||mn()||Kl())&&(u=await ME.lock());try{l=await navigator.mediaDevices.getUserMedia(c);}catch(h){throw u&&u(),h}return c.audio&&(BA=!0),c.video&&(jA=!0),Ha(r,l),u&&u(),r}function Uu(t,e){switch(t){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new D(R.MEDIA_OPTION_INVALID,"".concat(t,": ").concat(e));case"NotFoundError":case"DevicesNotFoundError":return new D(R.DEVICE_NOT_FOUND,"".concat(t,": ").concat(e));case"NotSupportedError":return new D(R.NOT_SUPPORTED,"".concat(t,": ").concat(e));case"NotReadableError":return new D(R.NOT_READABLE,"".concat(t,": ").concat(e));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new D(R.PERMISSION_DENIED,"".concat(t,": ").concat(e));case"ConstraintNotSatisfiedError":return new D(R.CONSTRAINT_NOT_SATISFIED,"".concat(t,": ").concat(e));default:return _.error("getUserMedia unexpected error",t),new D(R.UNEXPECTED_ERROR,"".concat(t,": ").concat(e))}}function Ha(t,e){let n=t.getVideoTracks()[0],i=t.getAudioTracks()[0],r=e.getVideoTracks()[0],o=e.getAudioTracks()[0];o&&(i&&t.removeTrack(i),t.addTrack(o)),r&&(n&&t.removeTrack(n),t.addTrack(r));}let hi=new class extends de{get state(){return this._state}set state(t){t!==this._state&&(this.emit(Ns.STATE_CHANGE,t),this._state=t);}constructor(){super(),P(this,"_state",Td.IDLE),P(this,"isAccessMicrophonePermission",!1),P(this,"isAccessCameraPermission",!1),P(this,"lastAccessMicrophonePermission",!1),P(this,"lastAccessCameraPermission",!1),P(this,"checkdeviceMatched",!1),P(this,"deviceInfoMap",new Map),this.init().then(()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval(()=>{(v("ENUMERATE_DEVICES_INTERVAL")||(Yl()||Hl()===He.HARMONY_OS)&&Io())&&this.updateDevicesInfo();},v("ENUMERATE_DEVICES_INTERVAL_TIME"));}).catch(t=>_.error(t.toString()));}async enumerateDevices(t,e){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new D(R.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();let i=await navigator.mediaDevices.enumerateDevices(),r=this.checkMediaDeviceInfoIsOk(i),o=!this.isAccessMicrophonePermission&&t,s=!this.isAccessCameraPermission&&e;r.audio&&(o=!1),r.video&&(s=!1);let a=null,c=null,d=null;if(!n&&(o||s)){if(ME.isLocked&&(_.debug("[device manager] wait GUM lock"),(await ME.lock())(),_.debug("[device manager] GUM unlock")),BA&&(o=!1,this.isAccessMicrophonePermission=!0),jA&&(s=!1,this.isAccessCameraPermission=!0),_.debug("[device manager] check media device permissions",t,e,o,s),o&&s){try{d=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0});}catch(l){let u=Uu(l.name||l.code||l,l.message);if(u.code===R.PERMISSION_DENIED)throw u;_.warning("getUserMedia failed in getDevices",u);}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0;}else if(o){try{a=await navigator.mediaDevices.getUserMedia({audio:t});}catch(l){let u=Uu(l.name||l.code||l,l.message);if(u.code===R.PERMISSION_DENIED)throw u;_.warning("getUserMedia failed in getDevices",u);}this.isAccessMicrophonePermission=!0;}else if(s){try{c=await navigator.mediaDevices.getUserMedia({video:e});}catch(l){let u=Uu(l.name||l.code||l,l.message);if(u.code===R.PERMISSION_DENIED)throw u;_.warning("getUserMedia failed in getDevices",u);}this.isAccessCameraPermission=!0;}_.debug("[device manager] mic permission",t,"cam permission",e);}try{let l=await navigator.mediaDevices.enumerateDevices();return a&&a.getTracks().forEach(u=>u.stop()),c&&c.getTracks().forEach(u=>u.stop()),d&&d.getTracks().forEach(u=>u.stop()),a=null,c=null,d=null,l}catch(l){return a&&a.getTracks().forEach(u=>u.stop()),c&&c.getTracks().forEach(u=>u.stop()),d&&d.getTracks().forEach(u=>u.stop()),a=null,c=null,d=null,new D(R.ENUMERATE_DEVICES_FAILED,l.toString()).throw()}}async getRecordingDevices(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return (await this.enumerateDevices(!0,!1,t)).filter(e=>e.kind==="audioinput")}async getCamerasDevices(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return (await this.enumerateDevices(!1,!0,t)).filter(e=>e.kind==="videoinput")}async getSpeakers(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return (await this.enumerateDevices(!0,!1,t)).filter(e=>e.kind==="audiooutput")}searchDeviceIdByName(t){let e=null;return this.deviceInfoMap.forEach(n=>{n.device.label===t&&(e=n.device.deviceId);}),e}async getDeviceById(t){let e=(await this.enumerateDevices(!0,!0,!0)).find(n=>n.deviceId===t);if(!e)throw new D(R.DEVICE_NOT_FOUND,"deviceId: ".concat(t));return e}async init(){this.state=Td.INITING;try{await this.updateDevicesInfo(),this.state=Td.INITEND;}catch(t){throw _.warning("Device Detection functionality cannot start properly.",t.toString()),this.state=Td.IDLE,(typeof isSecureContext=="boolean"?isSecureContext:location.protocol==="https:"||location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="::1")||new D(R.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),t}}async updateDevicesInfo(){let t=await this.enumerateDevices(!0,!0,!0),e=Date.now(),n=[];if(t[0]&&t[0].label&&this.checkdeviceMatched===!1){this.checkdeviceMatched=!0;let r=t.find(s=>s.kind==="audioinput"&&s.deviceId==="default"),o=t.find(s=>s.kind==="audiooutput"&&s.deviceId==="default");r&&o?o.groupId===r.groupId?_.debug("[device-check] default input ".concat(r.label," and output ").concat(o.label," is the same group")):_.warning("[device-check] default input ".concat(r.label," and output ").concat(o.label," is not the same group")):_.debug("[device-check] default input or output not found");}let i=this.checkMediaDeviceInfoIsOk(t);if(t.forEach(r=>{if(!r.deviceId)return;let o=this.deviceInfoMap.get("".concat(r.kind,"_").concat(r.deviceId));if((o?o.state:"INACTIVE")!=="ACTIVE"){let s={initAt:e,updateAt:e,device:r,state:"ACTIVE"};this.deviceInfoMap.set("".concat(r.kind,"_").concat(r.deviceId),s),n.push(s);}o&&(o.updateAt=e);}),this.deviceInfoMap.forEach((r,o)=>{r.state==="ACTIVE"&&r.updateAt!==e&&(r.state="INACTIVE",n.push(r));}),this.state!==Td.INITEND)return i.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(i.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));n.forEach(r=>{switch(r.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Ns.RECORDING_DEVICE_CHANGED,r);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(Ns.CAMERA_DEVICE_CHANGED,r);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Ns.PLAYOUT_DEVICE_CHANGED,r);}}),i.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),i.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0);}checkMediaDeviceInfoIsOk(t){let e=t.filter(r=>r.kind==="audioinput"),n=t.filter(r=>r.kind==="videoinput"),i={audio:!1,video:!1};for(let r of e)if(r.label&&r.deviceId){i.audio=!0;break}for(let r of n)if(r.label&&r.deviceId){i.video=!0;break}return i}},UE=!1,pi=new class extends de{constructor(){super(...arguments),P(this,"onAutoplayFailed",void 0),P(this,"onAudioAutoplayFailed",void 0);}};function GA(){if(Pt(),!UE){let t=e=>{e.preventDefault(),UE=!1,Vc()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0));};UE=!0,Vc()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),_.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),pi.onAutoplayFailed?pi.onAutoplayFailed():pi.onAudioAutoplayFailed?_.warning(`AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.

  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`):_.warning(`We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.

  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.

  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`),pi.emit("autoplay-failed");}}function WA(t,e,n,i){if(!t)return;let r=et.getBaseInfoBySessionId(t);if(!r)return;let o=r.info,s=Date.now(),a=le(le({},o),{},{vid:o.vid===void 0?0:Number(o.vid),lts:s,elapse:s-r.startTime,cbRegistered:pi.onAutoplayFailed||pi.onAudioAutoplayFailed?1:-1,errorMsg:n,mediaType:e,trackId:i,extend:void 0});et.send({type:_e.AUTOPLAY_FAILED,data:a},!0);}let C3=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],xn=new class{constructor(){P(this,"onAutoplayFailed",void 0),P(this,"elementMap",new Map),P(this,"elementStateMap",new Map),P(this,"elementsNeedToResume",[]),P(this,"sinkIdMap",new Map),P(this,"autoResumeAfterInterruption",t=>{Array.from(this.elementMap.entries()).forEach(e=>{let[n,i]=e,r=this.elementStateMap.get(n),o=i.srcObject.getAudioTracks()[0],s=o&&o.readyState;if(_.debug("resume after interrupted, ele: ".concat(r," audio: ").concat(s," ").concat(t)),s==="live"){if(t)return i.pause(),void i.play();if(Kt.curState==="running")return pa()?(i.pause(),void i.play()):void(r&&r==="paused"&&i.play())}});}),P(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{Array.from(this.elementMap.entries()).forEach(t=>{let[e,n]=t,i=n.srcObject.getAudioTracks()[0];i&&i.readyState==="live"&&(_.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),n.pause(),n.play());});}),this.autoResumeAudioElement(),Kt.on(on.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Kt.on(on.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),Kt.on(on.STATE_CHANGE,()=>{mn()&&Kt.prevState==="suspended"&&Kt.curState==="running"&&this.autoResumeAfterInterruption();});}async setSinkID(t,e){let n=this.elementMap.get(t);if(this.sinkIdMap.set(t,e),n)try{await n.setSinkId(e);}catch(i){throw new D(R.PERMISSION_DENIED,"can not set sink id: "+i.toString())}}play(t,e,n,i){if(this.elementMap.has(e))return;let r=document.createElement("audio");r.autoplay=!0,r.srcObject=new MediaStream([t]),this.bindAudioElementEvents(e,r),this.elementMap.set(e,r),this.elementStateMap.set(e,An.INIT),this.setVolume(e,n);let o=this.sinkIdMap.get(e);if(o)try{r.setSinkId(o).catch(a=>{_.warning("[".concat(e,"] set sink id failed"),a.toString());});}catch(a){_.warning("[".concat(e,"] set sink id failed"),a.toString());}let s=r.play();s&&s.then&&s.catch(a=>{i&&WA(i,"audio",a.message,e),_.warning("audio element play warning",a.toString()),this.elementMap.has(e)&&a.name==="NotAllowedError"&&(_.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(r),zl(()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),GA();}));});}updateTrack(t,e){let n=this.elementMap.get(t);n&&(n.srcObject=new MediaStream([e]));}isPlaying(t){return this.elementMap.has(t)&&this.elementStateMap.get(t)==="playing"}setVolume(t,e){let n=this.elementMap.get(t);n&&(e=Math.max(0,Math.min(100,e)),n.volume=e/100);}stop(t){let e=this.elementMap.get(t);if(this.sinkIdMap.delete(t),!e)return;let n=this.elementsNeedToResume.indexOf(e);this.elementsNeedToResume.splice(n,1),e.srcObject=null,e.remove(),this.elementMap.delete(t),this.elementStateMap.delete(t);}bindAudioElementEvents(t,e){C3.forEach(n=>{e.addEventListener(n,i=>{let r=this.elementStateMap.get(t),o=i.type==="pause"?"paused":i.type;if(_.debug("[".concat(t,"] audio-element-status change ").concat(r," => ").concat(o)),i.type==="error"){let s=e?.error;s&&_.error("[".concat(t,"] media error, code: ").concat(s.code,", message: ").concat(s.message));}this.elementStateMap.set(t,o);});});}getPlayerState(t){return this.elementStateMap.get(t)||"uninit"}autoResumeAudioElement(){let t=()=>{this.elementsNeedToResume.forEach(e=>{e.play().then(n=>{_.debug("Auto resume audio element success");}).catch(n=>{_.warning("Auto resume audio element failed!",n);});}),this.elementsNeedToResume=[];};new K(e=>{document.body?e():window.addEventListener("load",()=>e());}).then(()=>{Vc()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0));});}};function Ae(){return function(t,e,n){let i=n.value;return typeof i=="function"&&(n.value=function(){this._isClosed&&new D(R.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",_);for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];let a=i.apply(this,o);return a instanceof K?new K((c,d)=>{a.then(c).catch(d);}):a}),n}}class HA extends de{constructor(e){super(),P(this,"name","VideoProcessorDestination"),P(this,"ID","0"),P(this,"_source",void 0),P(this,"videoContext",void 0),P(this,"inputTrack",void 0),this.videoContext=e;}get kind(){return "video"}get enabled(){return !0}pipe(){throw new D(R.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new D(R.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(e){if(e.context!==this.videoContext)throw new Error(`ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.
Probably you are making pipeline like this:
videoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).`);e.track&&e.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=e.track,this.emit(kn.ON_TRACK,e.track));}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(kn.ON_TRACK,void 0);}}class KA extends de{set chained(e){this._chained=e;}get chained(){return this._chained}constructor(e,n){super(),P(this,"constraintsMap",new Map),P(this,"statsRegistry",[]),P(this,"usageRegistry",[]),P(this,"trackId",void 0),P(this,"direction",void 0),P(this,"_chained",!1),this.trackId=e,this.direction=n;}async getConstraints(){return await Me(this,di.REQUEST_CONSTRAINTS)}async requestApplyConstraints(e,n){var i;return _.info("processor ".concat(n.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(n,e),Qt(this,di.REQUEST_UPDATE_CONSTRAINTS,Array.from(cr(i=this.constraintsMap).call(i)))}async requestRevertConstraints(e){var n;if(this.constraintsMap.has(e))return _.info("processor ".concat(e.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(e),Qt(this,di.REQUEST_UPDATE_CONSTRAINTS,Array.from(cr(n=this.constraintsMap).call(n)))}registerStats(e,n,i){this.statsRegistry.find(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===n)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:n,cb:i});}unregisterStats(e,n){let i=this.statsRegistry.findIndex(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===n);i!==-1&&this.statsRegistry.splice(i,1);}gatherStats(){let e=[];for(let{processorID:n,processorName:i,type:r,cb:o}of this.statsRegistry)try{let s=o();e.push({processorID:n,processorName:i,type:r,stats:s});}catch(s){_.error(new D(R.UNEXPECTED_ERROR,s.message));}return e}registerUsage(e,n){this.usageRegistry.find(i=>i.processorID===e.ID&&i.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:n});}unregisterUsage(e){let n=this.usageRegistry.findIndex(i=>i.processorID===e.ID&&i.processorName===e.name);n!==-1&&this.usageRegistry.splice(n,1);}async gatherUsage(){let e=[];if(!this.chained)return [];for(let{cb:n}of this.usageRegistry)try{let i=n();i instanceof K&&(i=await i),e.push(le(le({},i),{},{direction:this.direction}));}catch(i){_.error("gather extension usage error",i);}return e}getDirection(){return this.direction}}class YA extends de{constructor(e){super(),P(this,"name","AudioProcessorDestination"),P(this,"ID","0"),P(this,"inputTrack",void 0),P(this,"inputNode",void 0),P(this,"audioProcessorContext",void 0),P(this,"_source",void 0),this.audioProcessorContext=e;}get kind(){return "audio"}get enabled(){return !0}pipe(){throw new D(R.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new D(R.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(kn.ON_TRACK,void 0),this.emit(kn.ON_NODE,void 0);}updateInput(e){if(e.context!==this.audioProcessorContext)throw new Error(`ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.
        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).`);e.track&&this.inputTrack!==e.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=e.track,this.emit(kn.ON_TRACK,this.inputTrack)),e.node&&this.inputNode!==e.node&&(this.audioProcessorContext.chained=!0,this.inputNode=e.node,this.emit(kn.ON_NODE,this.inputNode));}}class qA extends de{set chained(e){this._chained=e;}get chained(){return this._chained}constructor(e,n,i){super(),P(this,"constraintsMap",new Map),P(this,"statsRegistry",[]),P(this,"audioContext",void 0),P(this,"trackId",void 0),P(this,"direction",void 0),P(this,"usageRegistry",[]),P(this,"_chained",!1),this.audioContext=e,this.trackId=n,this.direction=i;}async getConstraints(){return Me(this,di.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(e,n){var i;return _.info("processor ".concat(n.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(n,e),Qt(this,di.REQUEST_UPDATE_CONSTRAINTS,Array.from(cr(i=this.constraintsMap).call(i)))}async requestRevertConstraints(e){var n;if(this.constraintsMap.has(e))return this.constraintsMap.delete(e),Qt(this,di.REQUEST_UPDATE_CONSTRAINTS,Array.from(cr(n=this.constraintsMap).call(n)))}registerStats(e,n,i){this.statsRegistry.find(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===n)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:n,cb:i});}unregisterStats(e,n){let i=this.statsRegistry.findIndex(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===n);i!==-1&&this.statsRegistry.splice(i,1);}gatherStats(){let e=[];for(let{processorID:n,processorName:i,type:r,cb:o}of this.statsRegistry)try{let s=o();e.push({processorID:n,processorName:i,type:r,stats:s});}catch(s){_.error(new D(R.UNEXPECTED_ERROR,s.message));}return e}registerUsage(e,n){this.usageRegistry.find(i=>i.processorID===e.ID&&i.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:n});}unregisterUsage(e){let n=this.usageRegistry.findIndex(i=>i.processorID===e.ID&&i.processorName===e.name);n!==-1&&this.usageRegistry.splice(n,1);}async gatherUsage(){let e=[];if(!this.chained)return [];for(let{cb:n}of this.usageRegistry)try{let i=n();i instanceof K&&(i=await i),e.push(le(le({},i),{},{direction:this.direction}));}catch(i){_.error("gather extension usage error",i);}return e}getDirection(){return this.direction}}class xE extends de{get isPlayed(){return !0}get isFreeze(){return !1}constructor(){super(),P(this,"context",void 0),P(this,"processSourceNode",void 0),P(this,"outputTrack",void 0),P(this,"processedNode",void 0),P(this,"clonedTrack",void 0),P(this,"outputNode",void 0),this.outputNode=new v3;}setVolume(){}createOutputTrack(){throw new D(R.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class v3{disconnect(){}connect(){}}function zA(t){return new K((e,n)=>{let i=!1,r=document.createElement("video");r.setAttribute("autoplay",""),r.setAttribute("muted",""),r.muted=!0,r.autoplay=!0,r.setAttribute("playsinline",""),r.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(r);let o=mn()?"canplay":"playing";r.addEventListener(o,()=>{let s=r.videoWidth,a=r.videoHeight;!s&&Xt()||(i=!0,r.srcObject=null,r.remove(),e([s,a]));}),r.srcObject=new MediaStream([t]),r.play().catch(Jl),setTimeout(()=>{i||(r.srcObject=null,r.remove(),e([r.videoWidth,r.videoHeight]));},4e3);})}function xu(t){let e={};t.facingMode&&(e.facingMode=t.facingMode),t.cameraId&&(e.deviceId={exact:t.cameraId});let n=xr(t.encoderConfig);return n.width!=null&&(e.width=n.width),n.height!=null&&(e.height=n.height),!Xv()&&n.frameRate&&(e.frameRate=n.frameRate),Bv()&&typeof e.frameRate=="object"&&(e.frameRate.max=60),Xt()&&(e.frameRate={ideal:30,max:30}),e}function JA(t){let e={};if(Xv()||(t.AGC!==void 0&&(e.autoGainControl=t.AGC),t.AEC!==void 0&&(e.echoCancellation=t.AEC),t.ANS!==void 0&&(e.noiseSuppression=t.ANS,vo()&&t.ANS&&(e.googHighpassFilter=t.ANS))),t.encoderConfig){let n=ku(t.encoderConfig);e.channelCount=n.stereo?2:1,e.sampleRate=n.sampleRate,e.sampleSize=n.sampleSize;}return t.microphoneId&&(e.deviceId={exact:t.microphoneId}),Yl()&&(e.sampleRate=void 0),e}let I3=t=>{let e=t._encoderConfig;if(!e)return;let{frameRate:n,width:i,height:r}=t.getMediaStreamTrackSettings(),{frameRate:o=n,width:s=i,height:a=r}=e;if(!o||!s||!a)return;s=lm(s),a=lm(a),o=lm(o);let{max:c,min:d}=function(p,T,m){let E=200*Math.pow(m/15,.6)*Math.pow(p*T/640/360,.75);return {min:Math.floor(E),max:Math.floor(4*E)}}(s,a,o),{bitrateMax:l,bitrateMin:u}=e||{};l||_.debug("calculate bitrate: [w: ".concat(s,", h: ").concat(a,", fps: ").concat(o,"] => [brMax: ").concat(l,", brMin: ").concat(u,"]"));let{maxFramerate:h}=v("ENCODER_CONFIG_LIMIT");return h&&typeof h=="number"&&(o=Math.min(o,h)),{frameRate:o,bitrateMax:l||c,bitrateMin:u||d,scaleResolutionDownBy:1,scale:0}},XA=async(t,e,n)=>await(async(i,r,o)=>{let s=function(d){let l=[];for(let u=0;u<d.length;u+=2)l.push(parseInt(d.slice(u,u+2),16));return Uint8Array.from(l)}(mI(""+r+o)).slice(0,16),a=s.slice(0,12),c=await window.crypto.subtle.importKey("raw",s,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:a},c,i))})(t.buffer,e,n),VE=t=>{let e=document.createElement("canvas");return e.width=2,e.height=2,new K((n,i)=>{e.toBlob(async r=>{if(e.remove(),r){let o=await QA(r);n({buffer:o,width:e.width,height:e.height});}else i(new D(R.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED));},t,1);})},QA=async t=>{let e=await t.arrayBuffer();return new Uint8Array(e)};var ZA,$A,tb,eb,nb,ib,rb,ob,sb,ab,cb,db,lb,ub,hb,pb,_b,mb,me,Eb,fb,gb,Tb,Sb,Rb,Fr,Cb,vb,Ib,yb,Ab,bb,wb,Ob,Nb,Db,Pb,Lb,kb,hn;let Re=(ZA=st({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),$A=st({argsMap:(t,e)=>[t.getTrackId(),e]}),tb=Ae(),eb=Ea("LocalAudioTrack","_enabledMutex"),nb=st({argsMap:(t,e)=>[t.getTrackId(),e]}),ib=Ae(),rb=Ea("LocalAudioTrack","_enabledMutex"),ob=st({argsMap:(t,e)=>[t.getTrackId(),e]}),sb=Ae(),ab=Ae(),cb=Ae(),db=st({argsMap:t=>[t.getTrackId()]}),lb=Ae(),ub=st({argsMap:t=>[t.getTrackId()]}),hb=Ae(),pb=st({argsMap:t=>[t.getTrackId()]}),_b=st({argsMap:(t,e)=>[t.getTrackId(),e.name]}),mb=st({argsMap:t=>[t.getTrackId()]}),Nt((me=class extends Ga{get _source(){return this.initWebAudio()}set _source(t){this._trackSource=t;}get processorContext(){return this._processorContext||(this._processorContext=this.initProcessor().processorContext),this._processorContext}get processorDestination(){return this._processorDestination||(this._processorDestination=this.initProcessor().processorDestination),this._processorDestination}get isPlaying(){return this._useAudioElement?xn.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return "LocalAudioTrack"}constructor(t,e,n,i){super(t,n),P(this,"trackMediaType","audio"),P(this,"_encoderConfig",void 0),P(this,"_trackSource",void 0),P(this,"_enabled",!0),P(this,"_volume",100),P(this,"_useAudioElement",!0),P(this,"_bypassWebAudio",!1),P(this,"processor",void 0),P(this,"_processorContext",void 0),P(this,"_processorDestination",void 0),P(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=e,this._getOriginVolumeLevel=!!i,this._trackSource=new xE,v("DISABLE_WEBAUDIO")&&(this._bypassWebAudio=!0),v("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1),Ke()&&!li?setTimeout(()=>this.initWebAudio()):this.initWebAudio();}setVolume(t){zt(t,"volume",0,1e3),this._volume=t,this._source.setVolume(t/100),this._useAudioElement&&xn.setVolume(this.getTrackId(),t);try{if(this._bypassWebAudio)return void _.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));let e=this._source.createOutputTrack();this._mediaStreamTrack!==e&&(this._mediaStreamTrack=e,Qt(this,J.NEED_REPLACE_TRACK,this).then(()=>{_.debug("[".concat(this.getTrackId(),"] replace web audio track success"));}).catch(n=>{_.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),n);}));}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(t){if(!this._useAudioElement||!wA())throw new D(R.NOT_SUPPORTED,"your browser does not support setting the audio output device");await xn.setSinkID(this.getTrackId(),t);}async setEnabled(t,e,n){return this._setEnabled(t,e,n)}async _setEnabled(t,e,n){if(!n){if(t===this._enabled)return;this.stateCheck("enabled",t);}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){this._originMediaStreamTrack.enabled=!0;try{n||(this._enabled=!0),await Qt(this,J.NEED_ENABLE_TRACK,this),_.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(t," success"));}catch(i){throw n||(this._enabled=!1),_.error("[".concat(this.getTrackId(),"] setEnabled to true error"),i.toString()),i}}else {this._originMediaStreamTrack.enabled=!1,n||(this._enabled=!1);try{await Qt(this,J.NEED_DISABLE_TRACK,this);}catch(i){throw n||(this._enabled=!0),_.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}}}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,_.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await Qt(this,J.NEED_MUTE_TRACK,this):await Qt(this,J.NEED_UNMUTE_TRACK,this));}getStats(){return yo(()=>{_.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead");},"localAudioTrackGetStatsWarning"),Qn(this,J.GET_STATS)||le({},NE)}setAudioFrameCallback(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners(ci.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(ci.ON_AUDIO_BUFFER),this._source.on(ci.ON_AUDIO_BUFFER,n=>t(n));}play(){_.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(_.debug("[".concat(this.getTrackId(),"] start audio playback in element")),xn.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play();}stop(){_.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?xn.stop(this.getTrackId()):this._source.stop();}close(){super.close(),this._processorDestination&&this.unbindProcessorDestinationEvents(this._processorDestination),this._processorContext&&this.unbindProcessorContextEvents(this._processorContext),this.unpipe(),this._processorDestination&&this._processorDestination._source&&this._processorDestination._source.unpipe(),this._source.destroy();}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];_.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&xn.updateTrack(this.getTrackId(),this._mediaStreamTrack);}async _updateOriginMediaStreamTrack(t,e){this._originMediaStreamTrack!==t&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),e&&this._originMediaStreamTrack.stop()),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this._processorContext&&this.processor.updateInput({track:t,context:this._processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Qt(this,J.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(t));}renewMediaStreamTrack(t){return K.resolve(void 0)}pipe(t){if(this._bypassWebAudio)throw new D(R.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===t)return t;if(t._source)throw new D(R.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(!this.processor)return;let e=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset();}bindProcessorDestinationEvents(t){t.on(kn.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e),await Qt(this,J.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Qt(this,J.NEED_REPLACE_TRACK,this));}),t.on(kn.ON_NODE,e=>{this._source.processedNode=e;});}unbindProcessorDestinationEvents(t){t.removeAllListeners(kn.ON_TRACK),t.removeAllListeners(kn.ON_NODE);}bindProcessorContextEvents(t){t.on(di.REQUEST_CONSTRAINTS,async e=>{e(this._originMediaStreamTrack.getSettings());});}unbindProcessorContextEvents(t){t.removeAllListeners(di.REQUEST_CONSTRAINTS);}initWebAudio(){return this._trackSource instanceof xE&&(this._trackSource=new xA(this._mediaStreamTrack,!1,this._getOriginVolumeLevel?this._mediaStreamTrack:void 0)),this._trackSource}initProcessor(){let t=new qA(this._source.context,this.getTrackId(),"local"),e=new YA(t);return this._processorContext=t,this._processorDestination=e,this.bindProcessorContextEvents(t),this.bindProcessorDestinationEvents(e),this._source.on(ci.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:t});}),this._useAudioElement&&(this._useAudioElement=!1,this.isPlaying&&(xn.stop(this.getTrackId()),this._source.play()),Qt(this,J.NEED_REPLACE_MIXING_TRACK,this).then(()=>{_.debug("[".concat(this.getTrackId(),"] replace from origin track to web audio track success"));}).catch(n=>{_.warning("[".concat(this.getTrackId(),"] replace from origin track to web audio track failed"),n);})),{processorContext:t,processorDestination:e}}}).prototype,"setVolume",[ZA],Object.getOwnPropertyDescriptor(me.prototype,"setVolume"),me.prototype),Nt(me.prototype,"setPlaybackDevice",[$A,tb],Object.getOwnPropertyDescriptor(me.prototype,"setPlaybackDevice"),me.prototype),Nt(me.prototype,"setEnabled",[eb,nb,ib],Object.getOwnPropertyDescriptor(me.prototype,"setEnabled"),me.prototype),Nt(me.prototype,"setMuted",[rb,ob,sb],Object.getOwnPropertyDescriptor(me.prototype,"setMuted"),me.prototype),Nt(me.prototype,"getStats",[ab],Object.getOwnPropertyDescriptor(me.prototype,"getStats"),me.prototype),Nt(me.prototype,"setAudioFrameCallback",[cb],Object.getOwnPropertyDescriptor(me.prototype,"setAudioFrameCallback"),me.prototype),Nt(me.prototype,"play",[db,lb],Object.getOwnPropertyDescriptor(me.prototype,"play"),me.prototype),Nt(me.prototype,"stop",[ub,hb],Object.getOwnPropertyDescriptor(me.prototype,"stop"),me.prototype),Nt(me.prototype,"close",[pb],Object.getOwnPropertyDescriptor(me.prototype,"close"),me.prototype),Nt(me.prototype,"pipe",[_b],Object.getOwnPropertyDescriptor(me.prototype,"pipe"),me.prototype),Nt(me.prototype,"unpipe",[mb],Object.getOwnPropertyDescriptor(me.prototype,"unpipe"),me.prototype),me),Vu=(Eb=st({argsMap:(t,e)=>[t.getTrackId(),e]}),fb=Ae(),gb=Ea("MicrophoneAudioTrack","_enabledMutex"),Tb=st({argsMap:(t,e,n)=>[t.getTrackId(),e,n]}),Sb=Ae(),Rb=st({argsMap:t=>[t.getTrackId()]}),Nt((Fr=class extends Re{get __className__(){return "MicrophoneAudioTrack"}constructor(t,e,n,i){super(t,e.encoderConfig?ku(e.encoderConfig):{},i,v("GET_VOLUME_OF_MUTED_AUDIO_TRACK")),P(this,"_config",void 0),P(this,"_deviceName","default"),P(this,"_constraints",void 0),P(this,"_originalConstraints",void 0),P(this,"_enabled",!0),this._config=e,this._constraints=n,this._originalConstraints=n,this._deviceName=t.label,typeof e.bypassWebAudio=="boolean"&&(this._bypassWebAudio=e.bypassWebAudio),(pa()||im())&&Kt.bindInterruptDetectorTrack(this);}async setDevice(t){if(_.info("[".concat(this.getTrackId(),"] start set device to ").concat(t)),this._enabled)try{let e=await hi.getDeviceById(t),n={};n.audio=le({},this._constraints),n.audio.deviceId={exact:t},this._originMediaStreamTrack.stop();let i=null;try{i=await ui(n,this.getTrackId());}catch(r){throw _.error("[".concat(this.getTrackId(),"] setDevice failed"),r.toString()),i=await ui({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!1),this._deviceName=e.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t};}catch(e){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}else try{let e=await hi.getDeviceById(t);this._deviceName=e.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t};}catch(e){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}_.info("[".concat(this.getTrackId(),"] set device to ").concat(t," success"));}async setEnabled(t,e,n){if(e)return _.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(t);if(!n){if(t===this._enabled)return;this.stateCheck("enabled",t);}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),t),v("AUTO_RESET_AUDIO_ROUTE")&&(mn()||Vi())){let s=navigator.audioSession;s&&(t||(s.type="playback"),s.type="auto");}if(!t){var i;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),(i=this._source.clonedTrack)===null||i===void 0||i.stop(),n||(this._enabled=!1);try{await Qt(this,J.NEED_DISABLE_TRACK,this);}catch(s){throw _.error("[".concat(this.getTrackId(),"] setEnabled false failed"),s.toString()),s}return}let r=le({},this._constraints),o=hi.searchDeviceIdByName(this._deviceName);o&&!r.deviceId&&(r.deviceId=o);try{n||(this._enabled=!0);let s=await ui({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(s.getAudioTracks()[0],!1),await Qt(this,J.NEED_ENABLE_TRACK,this);}catch(s){throw n||(this._enabled=!1),_.error("[".concat(this.getTrackId(),"] setEnabled true failed"),s.toString()),s}_.info("[".concat(this.getTrackId(),"] setEnabled success"));}close(){super.close(),(pa()||im())&&Kt.unbindInterruptDetectorTrack(this);}onTrackEnded(){if((mn()||Vi())&&this._enabled&&!this._isClosed&&Kt.duringInterruption){let t=async()=>{Kt.off(on.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(_.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0));};Kt.on(on.IOS_INTERRUPTION_END,t);}else _.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(Ba.TRACK_ENDED);}async renewMediaStreamTrack(t){let e=t||this._constraints,n=hi.searchDeviceIdByName(this._deviceName);if(n&&!e.deviceId&&(e.deviceId=n),this._constraints=e,this._enabled){this._originMediaStreamTrack.stop();let i=await ui({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!0);}}bindProcessorContextEvents(t){super.bindProcessorContextEvents(t),t.on(di.REQUEST_UPDATE_CONSTRAINTS,async(e,n,i)=>{try{let r=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(r),n();}catch(r){i(r);}});}unbindProcessorContextEvents(t){super.unbindProcessorContextEvents(t),t.removeAllListeners(di.REQUEST_UPDATE_CONSTRAINTS);}}).prototype,"setDevice",[Eb,fb],Object.getOwnPropertyDescriptor(Fr.prototype,"setDevice"),Fr.prototype),Nt(Fr.prototype,"setEnabled",[gb,Tb,Sb],Object.getOwnPropertyDescriptor(Fr.prototype,"setEnabled"),Fr.prototype),Nt(Fr.prototype,"close",[Rb],Object.getOwnPropertyDescriptor(Fr.prototype,"close"),Fr.prototype),Fr),y3=(Cb=st({argsMap:(t,e)=>[t.getTrackId(),e,t.duration]}),vb=Ae(),Ib=st({argsMap:t=>[t.getTrackId()]}),yb=Ae(),Ab=st({argsMap:t=>[t.getTrackId()]}),bb=Ae(),wb=st({argsMap:t=>[t.getTrackId()]}),Ob=Ae(),Nb=st({argsMap:t=>[t.getTrackId()]}),Db=Ae(),Pb=st({argsMap:t=>[t.getTrackId()]}),Lb=st({argsMap:t=>[t.getTrackId()]}),kb=Ae(),Nt((hn=class extends Re{get __className__(){return "BufferSourceAudioTrack"}constructor(t,e,n,i){super(e.createOutputTrack(),n,i),P(this,"source",void 0),P(this,"_bufferSource",void 0),this._useAudioElement=!1,this.source=t,this._bufferSource=e,this._bufferSource.on(ci.AUDIO_SOURCE_STATE_CHANGE,r=>{this.safeEmit(Ba.SOURCE_STATE_CHANGE,r);});try{this._mediaStreamTrack=this._source.createOutputTrack();}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(t){t&&this._bufferSource.updateOptions(t),this._bufferSource.startProcessAudioBuffer();}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer();}seekAudioBuffer(t){this._bufferSource.seekAudioBuffer(t);}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer();}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer();}close(){this.source=null,this._bufferSource.destroy(),super.close();}setAudioBufferPlaybackSpeed(t){zt(t,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(t);}}).prototype,"startProcessAudioBuffer",[Cb,vb],Object.getOwnPropertyDescriptor(hn.prototype,"startProcessAudioBuffer"),hn.prototype),Nt(hn.prototype,"pauseProcessAudioBuffer",[Ib,yb],Object.getOwnPropertyDescriptor(hn.prototype,"pauseProcessAudioBuffer"),hn.prototype),Nt(hn.prototype,"seekAudioBuffer",[Ab,bb],Object.getOwnPropertyDescriptor(hn.prototype,"seekAudioBuffer"),hn.prototype),Nt(hn.prototype,"resumeProcessAudioBuffer",[wb,Ob],Object.getOwnPropertyDescriptor(hn.prototype,"resumeProcessAudioBuffer"),hn.prototype),Nt(hn.prototype,"stopProcessAudioBuffer",[Nb,Db],Object.getOwnPropertyDescriptor(hn.prototype,"stopProcessAudioBuffer"),hn.prototype),Nt(hn.prototype,"close",[Pb],Object.getOwnPropertyDescriptor(hn.prototype,"close"),hn.prototype),Nt(hn.prototype,"setAudioBufferPlaybackSpeed",[Lb,kb],Object.getOwnPropertyDescriptor(hn.prototype,"setAudioBufferPlaybackSpeed"),hn.prototype),hn);class je extends Re{get __className__(){return "MixingAudioTrack"}get isActive(){for(let e of this.trackList)if(e._enabled&&!e._isClosed&&!e.muted)return !0;return !1}constructor(){let e=Wa().createMediaStreamDestination();super(e.stream.getAudioTracks()[0],void 0,Zt(8,"track-mix-")),P(this,"trackList",void 0),P(this,"destNode",void 0),this._useAudioElement=!1;try{this._mediaStreamTrack=this._source.createOutputTrack();}catch{}this.destNode=e,this.trackList=[];}hasAudioTrack(e){return this.trackList.indexOf(e)!==-1}addAudioTrack(e){this.trackList.indexOf(e)===-1?(_.debug("add ".concat(e.getTrackId()," to mixing track")),e._source.outputNode.connect(this.destNode),this.trackList.push(e),this.updateEncoderConfig()):_.debug("track ".concat(e.getTrackId()," is already added"));}removeAudioTrack(e){if(this.trackList.indexOf(e)!==-1){_.debug("remove ".concat(e.getTrackId()," from mixing track"));try{e._source.outputNode.disconnect(this.destNode);}catch{}ql(this.trackList,e),this.updateEncoderConfig();}}updateEncoderConfig(){let e={};this.trackList.forEach(n=>{n._encoderConfig&&((n._encoderConfig.bitrate||0)>(e.bitrate||0)&&(e.bitrate=n._encoderConfig.bitrate),(n._encoderConfig.sampleRate||0)>(e.sampleRate||0)&&(e.sampleRate=n._encoderConfig.sampleRate),(n._encoderConfig.sampleSize||0)>(e.sampleSize||0)&&(e.sampleSize=n._encoderConfig.sampleSize),n._encoderConfig.stereo&&(e.stereo=!0));}),this._encoderConfig=e;}_updateRtpTransceiver(e){this._rtpTransceiver!==e&&(this._rtpTransceiver=e,this.trackList.forEach(n=>{n instanceof je?n.emit(Os.TRANSCEIVER_UPDATED,e):n._updateRtpTransceiver(e);}));}}class A3 extends UA{set currentState(e){e!==this._currentState&&(this._currentState=e,this.safeEmit(ci.AUDIO_SOURCE_STATE_CHANGE,this._currentState));}get currentState(){return this._currentState}constructor(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),P(this,"audioBuffer",void 0),P(this,"sourceNode",void 0),P(this,"startPlayTime",0),P(this,"startPlayOffset",0),P(this,"pausePlayTime",0),P(this,"options",void 0),P(this,"currentLoopCount",0),P(this,"currentPlaybackSpeed",100),P(this,"_currentState","stopped"),this.audioBuffer=e,this.options=n,this.startPlayOffset=this.options.startPlayTime||0;}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?this.currentState==="stopped"?0:this.currentState==="paused"?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(e){this.currentState==="stopped"?(this.options=e,this.startPlayOffset=this.options.startPlayTime||0):_.warning("can not set audio source options");}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing";}pauseProcessAudioBuffer(){this.sourceNode&&this.currentState==="playing"&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused");}seekAudioBuffer(e){this.sourceNode&&(this.sourceNode.onended=null,this.currentState==="playing"&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),this.currentState==="playing"?(this.startPlayOffset=e,this.startSourceNode()):this.currentState==="paused"&&(this.pausePlayTime=e));}resumeProcessAudioBuffer(){this.currentState==="paused"&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing");}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop();}catch{}this.reset();}}destroy(){this.audioBuffer=null,super.destroy();}setAudioBufferPlaybackSpeed(e){this.sourceNode&&(this.currentState==="playing"&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=e/100),this.currentPlaybackSpeed=e;}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this));}createSourceNode(){let e=this.context.createBufferSource();return e.buffer=this.audioBuffer,e.loop=!!this.options.loop,e.connect(this.outputNode),e.playbackRate.value=this.currentPlaybackSpeed/100,e}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset();}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0;}}let Mb=new Map;class FE{get rendFrameRate(){if(this.renderStats&&this.renderStats.curTs!==this.renderStats.lastTs){let e=this.renderStats.curTs-this.renderStats.lastTs,n=(this.renderStats.renderNum-this.renderStats.lastRenderNum)/e;return this.renderStats.lastRenderNum=this.renderStats.renderNum,this.renderStats.lastTs=this.renderStats.curTs,n}return 0}get videoElementStatus(){return this._videoElementStatus}set videoElementStatus(e){e!==this._videoElementStatus&&(_.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(e)),this._videoElementStatus=e);}get videoState(){return this._videoState}set videoState(e){var n;e!==this._videoState&&(this._videoState=e,(n=this.onVideoStateChanged)===null||n===void 0||n.call(this,this.videoState));}constructor(e){P(this,"trackId",void 0),P(this,"config",void 0),P(this,"onFirstVideoFrameDecoded",void 0),P(this,"onVideoStateChanged",void 0),P(this,"freezeTimeCounterList",[]),P(this,"renderFreezeAccTime",0),P(this,"isKeepLastFrame",!1),P(this,"timeUpdatedCount",0),P(this,"freezeTime",0),P(this,"playbackTime",0),P(this,"lastTimeUpdatedTime",0),P(this,"autoplayFailed",!1),P(this,"videoTrack",void 0),P(this,"videoElement",void 0),P(this,"cacheVideoElement",void 0),P(this,"renderStats",void 0),P(this,"_videoState",Vr.VideoStateStopped),P(this,"videoElementCheckInterval",void 0),P(this,"videoElementFreezeTimeout",void 0),P(this,"_videoElementStatus",An.NONE),P(this,"isGettingVideoDimensions",!1),P(this,"startGetVideoDimensions",()=>{let n=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return _.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(n,500);};!this.isGettingVideoDimensions&&n();}),P(this,"autoResumeAfterInterruption",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&Kt.curState==="running"&&(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(Fv())),zv()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()));}),P(this,"handleVideoEvents",n=>{switch(n.type){case"play":case"playing":this.startGetVideoDimensions(),this.videoElementStatus=An.PLAYING;break;case"loadeddata":if(this.videoState=Vr.VideoStateStarting,this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove();}catch{}this.cacheVideoElement=void 0;}break;case"canplay":this.videoElementStatus=An.CANPLAY;break;case"stalled":this.videoElementStatus=An.STALLED;break;case"suspend":this.videoElementStatus=An.SUSPEND;break;case"pause":this.videoElementStatus=An.PAUSED,mn()||Vi()||Ke()&&this.autoplayFailed||!this.videoTrack||this.videoTrack.readyState!=="live"||(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=An.WAITING;break;case"abort":this.videoElementStatus=An.ABORT;break;case"ended":this.videoElementStatus=An.ENDED;break;case"emptied":this.videoElementStatus=An.EMPTIED;break;case"error":{let i=this.videoElement.error;i?(this.videoElementStatus=An.ERROR,_.error("[".concat(this.trackId,"] media error: ").concat(i.message," (").concat(i.code,")"))):_.debug("[".concat(this.trackId,"] media not been an error."));break}case"timeupdate":{let i=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=i);let r=i-this.lastTimeUpdatedTime,o=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=i,so.lastVisibleTime<so.lastHiddenTime||o<so.lastHiddenTime||o<so.lastVisibleTime)return;for(r>v("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=r),this.playbackTime+=r;this.playbackTime>=6e3;){this.playbackTime-=6e3;let s=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(s),this.freezeTime=Math.max(0,this.freezeTime-6e3);}break}}}),P(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(Fv())),zv()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()));}),this.trackId=e.trackId,this.config=e,e.element instanceof HTMLVideoElement?this.videoElement=e.element:this.videoElement=document.createElement("video"),Kt.on(on.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Kt.on(on.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16);}getVideoElement(){return this.videoElement}getContainerElement(){var e;return (e=this.videoElement.parentElement)!==null&&e!==void 0?e:void 0}updateConfig(e){this.config=e,this.trackId=e.trackId,e.element!==this.videoElement&&(this.destroy(),this.videoElement=e.element),this.videoTrack&&this.initVideoElement();}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.initVideoElement());}play(e){let n=this.videoElement.play();n&&n.catch&&n.catch(r=>{e&&WA(e,"video",r.message,this.trackId),r.name==="NotAllowedError"?(_.warning("detected video element autoplay failed",r),this.autoplayFailed=!0,this.handleAutoPlayFailed()):_.warning("[".concat(this.trackId,"] play warning: "),r);});let i=Pt();if((i.name==="Safari"&&Number(i.version)===15||pa())&&n&&n.then){let r=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)");};n.then(r).catch(r);}}getCurrentFrame(){let e=document.createElement("canvas");e.width=this.videoElement.videoWidth,e.height=this.videoElement.videoHeight;let n=e.getContext("2d");if(!n)return _.error("create canvas context failed!"),new ImageData(2,2);n.drawImage(this.videoElement,0,0,e.width,e.height);let i=n.getImageData(0,0,e.width,e.height);return e.remove(),i}async getCurrentFrameToUint8Array(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,i=document.createElement("canvas");i.width=this.videoElement.videoWidth,i.height=this.videoElement.videoHeight;let r=i.getContext("2d");return r?(r.drawImage(this.videoElement,0,0,i.width,i.height),new K((o,s)=>{i.toBlob(async a=>{if(i.remove(),a){let c=await QA(a);o({buffer:c,width:i.width,height:i.height});}else s(new D(R.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED));},e,n<0?.1:n>1?1:n);})):await VE(e)}destroy(){this.renderStats=void 0,Kt.off(on.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Kt.off(on.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[],this.videoState=Vr.VideoStateStopped;}initVideoElement(){if(this.videoElementStatus=An.INIT,!this.videoElementCheckInterval&&(Ub.forEach(o=>{this.videoElement.addEventListener(o,this.handleVideoEvents);}),this.videoElementCheckInterval=window.setInterval(()=>{(function(o){return o!==document.body&&document.body.contains(o)})(this.videoElement)||(this.videoElementStatus=An.DESTROYED);},1e3),v("ENABLE_VIDEO_FRAME_CALLBACK"))){var e,n;let o,s=()=>{document.visibilityState==="visible"&&(document.removeEventListener("visibilitychange",s),this.videoElementFreezeTimeout=window.setTimeout(a,v("VIDEO_FREEZE_DURATION")));},a=()=>{this.videoElementFreezeTimeout=void 0,this.videoState===Vr.VideoStateDecoding&&(document.visibilityState==="visible"?this.videoState=Vr.VideoStateFrozen:document.addEventListener("visibilitychange",s));},c=(d,l)=>{if(this.videoElementStatus===An.PLAYING){if(this.renderStats?(this.renderStats.renderNum++,this.renderStats.curTs=l.mediaTime):this.renderStats={lastTs:l.mediaTime,curTs:l.mediaTime,lastRenderNum:0,renderNum:0},o){let p=l.presentationTime-o.presentationTime;this.videoState===Vr.VideoStateStarting&&(this.videoState=Vr.VideoStateDecoding),this.videoState===Vr.VideoStateDecoding&&this.onVideoStateChanged&&(this.videoElementFreezeTimeout&&window.clearTimeout(this.videoElementFreezeTimeout),this.videoElementFreezeTimeout=window.setTimeout(a,v("VIDEO_FREEZE_DURATION"))),p<v("VIDEO_FREEZE_DURATION")&&this.videoState===Vr.VideoStateFrozen&&(this.videoState=Vr.VideoStateDecoding),p>v("VIDEO_FREEZE_DURATION")&&so.lastVisibleTime>=so.lastHiddenTime&&o.timestamp>so.lastVisibleTime&&o.timestamp>so.lastHiddenTime&&(this.renderFreezeAccTime+=p);}o=le(le({},l),{},{timestamp:d});}var u,h;v("ENABLE_VIDEO_FRAME_CALLBACK")&&((u=(h=this.videoElement).requestVideoFrameCallback)===null||u===void 0||u.call(h,c));};(e=(n=this.videoElement).requestVideoFrameCallback)===null||e===void 0||e.call(n,c);}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),Yl()&&!v("HIDE_NO_POSTER")&&(this.videoElement.poster="noposter");let i=Pt();i.name==="Safari"&&Number(i.version)===15||pa()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Xt()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Xt()&&this.videoElement.load());let r=this.videoElement.play();r!==void 0&&r.catch(o=>{_.debug("[".concat(this.trackId,"] playback interrupted"),o.toString());});}resetVideoElement(){Ub.forEach(e=>{this.videoElement&&this.videoElement.removeEventListener(e,this.handleVideoEvents);}),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=An.NONE;}handleAutoPlayFailed(){let e=n=>{n.preventDefault(),this.videoElement.play().then(()=>{_.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."));}).catch(i=>{_.error(i);}),this.autoplayFailed=!1,Vc()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0));};Vc()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),GA();}}let Ub=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class xb extends FE{constructor(e){super(e),P(this,"container",void 0),P(this,"slot",void 0),this.slot=e.element,this.updateConfig(e);}updateConfig(e){this.config=e,this.trackId=e.trackId;let n=e.element;n!==this.slot&&(this.destroy(),this.slot=n),this.createElements();}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.createElements());}play(e){var n;(n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)&&super.play(e);}getCurrentFrame(){var e;return (e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(e){var n;let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return (n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(e,i):await VE(e)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{this.container.remove(),this.slot.removeChild(this.container);}catch{}this.container=void 0;}}createElements(){this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",v("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),this.slot.appendChild(this.container);}mountedVideoElement(){var e;!this.container||(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0";}unmountedVideoElement(){var e;if((e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement);}catch{}this.videoElement=document.createElement("video");}}resetVideoElement(){var e;(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"));}getContainerElement(){return this.container}}var Vb,Fb,Bb,jb,Gb,Wb,Hb,Kb,Yb,qb,zb,Jb,Xb,Qb,Zb,$b,tw,ew,nw,iw,rw,ow,sw,aw,cw,At,dw,lw,uw,hw,pw,_w,mw,Ew,_i;let $t=(Vb=st({argsMap:(t,e,n)=>[t.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),Fb=Ae(),Bb=st({argsMap:t=>[t.getTrackId()]}),jb=Ea("LocalVideoTrack","_enabledMutex"),Gb=st({argsMap:(t,e)=>[t.getTrackId(),e]}),Wb=Ae(),Hb=Ea("LocalVideoTrack","_enabledMutex"),Kb=st({argsMap:(t,e)=>[t.getTrackId(),e]}),Yb=Ae(),qb=st({argsMap:(t,e)=>[t.getTrackId(),e]}),zb=Ae(),Jb=Ae(),Xb=st({argsMap:(t,e,n)=>[t.getTrackId(),e,n]}),Qb=Ae(),Zb=Ae(),$b=Ae(),tw=Ae(),ew=Ae(),nw=Ae(),iw=Ae(),rw=st({argsMap:(t,e)=>[t.getTrackId(),e.name]}),ow=st({argsMap:t=>[t.getTrackId()]}),sw=st({argsMap:t=>[t.getTrackId()]}),aw=st({argsMap:(t,e,n)=>[t.getTrackId(),e.label,n]}),cw=st(),At=class mN extends Ga{get videoHeight(){if(Ke()){let{height:e}=this._mediaStreamTrack.getSettings();return this._videoHeight=e,this._videoHeight}return this._videoHeight}get videoWidth(){if(Ke()){let{width:e}=this._mediaStreamTrack.getSettings();return this._videoWidth=e,this._videoWidth}return this._videoWidth}get isPlaying(){return !(!this._player||this._player.videoElementStatus!==An.PLAYING)}get processorDestination(){return this._processorDestination}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e;}get __className__(){return "LocalVideoTrack"}constructor(e,n,i,r,o,s){if(super(e,o),P(this,"trackMediaType","video"),P(this,"_player",void 0),P(this,"isUseScaleResolutionDownBy",!1),P(this,"_videoVisibleTimer",null),P(this,"_statsTimer",null),P(this,"_previousVideoVisibleStatus",void 0),P(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),P(this,"_encoderConfig",void 0),P(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),P(this,"_optimizationMode",void 0),P(this,"_videoHeight",void 0),P(this,"_videoWidth",void 0),P(this,"_forceBitrateLimit",void 0),P(this,"_enabled",!0),P(this,"_processorDestination",void 0),P(this,"_processorContext",void 0),Ke()){let{width:a,height:c}=e.getSettings();this._videoWidth=a,this._videoHeight=c;}else this.updateMediaStreamTrackResolution();if(this._encoderConfig=n,this._scalabilityMode=i,this._optimizationMode=r,this._hints=s||[],this._hints.indexOf(ie.SCREEN_TRACK)===-1)this.updateBitrateFromProfile();else if(function(a,c,d){let l=Pt();return !(l.name!==a||!l.osVersion)&&(Number(l.version)===c)}(Bt.CHROME,115)&&Hl().indexOf("Windows")!==-1){let a=function(c,d){if("VideoFrame"in window&&"TransformStream"in window&&Ot().supportWebRTCInsertableStream){let l=new MediaStreamTrackProcessor(c),u=new MediaStreamTrackGenerator({kind:"video"}),h,p,T=Date.now(),m=()=>{E&&(clearInterval(E),E=void 0),h&&(h.close(),h=void 0),c.stop(),p=void 0,u.removeEventListener("ended",m);},E=window.setInterval(()=>{if(p&&h&&Date.now()-T>(1e3))try{u.readyState==="live"?p.enqueue(h.clone()):m();}catch{m();}},1e3),S=new TransformStream({transform:(C,A)=>{u.readyState==="live"?(p=A,T=Date.now(),h===void 0?(h=C,A.enqueue(C.clone())):(A.enqueue(h),h=C)):C.close();}});return u.addEventListener("ended",m),l.readable.pipeThrough(S).pipeTo(u.writable),u}}(e);a&&(_.info("local screen video track begin to inject frame"),this._mediaStreamTrack=a);}n&&this._hints.indexOf(ie.CUSTOM_TRACK)!==-1&&this.setEncoderConfiguration(n),this._processorContext=new KA(this.getTrackId(),"local"),this._processorDestination=new HA(this.processorContext),this.bindProcessorDestinationEvents();}play(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof e=="string"){let r=document.getElementById(e);r?e=r:(_.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body);}_.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(n));let i=le(le(le({},this._getDefaultPlayerConfig()),n),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(i):(e instanceof HTMLVideoElement?this._player=new FE(i):this._player=new xb(i),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{let r=this.getVideoElementVisibleStatus();this.safeEmit(Ba.VIDEO_ELEMENT_VISIBLE_STATUS,r);}catch{}},v("CHECK_VIDEO_VISIBLE_INTERVAL"));}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._statsTimer&&(this.isUseScaleResolutionDownBy=!1,window.clearInterval(this._statsTimer),this._statsTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,_.debug("[".concat(this.getTrackId(),"] stop video playback")));}async setEnabled(e,n){if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e);}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),e),!e){this._originMediaStreamTrack.enabled=!1;try{await Qt(this,J.NEED_DISABLE_TRACK,this);}catch(i){throw _.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}return n||(this._enabled=!1),void _.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await Qt(this,J.NEED_ENABLE_TRACK,this);}catch(i){throw _.error("[".concat(this.getTrackId(),"] setEnabled to true error"),i.toString()),i}_.info("[".concat(this.getTrackId(),"] setEnabled to true success")),n||(this._enabled=!0);}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,_.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await Qt(this,J.NEED_MUTE_TRACK,this):await Qt(this,J.NEED_UNMUTE_TRACK,this));}async setEncoderConfiguration(e,n){if(!this._enabled)throw new D(R.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(e==="720p_auto"?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),e=xr(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),e.width||e.height||e.frameRate){let i=xu({encoderConfig:e});(Ke()||mn()||Vi())&&(i.deviceId=void 0),_.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(i));try{await this._originMediaStreamTrack.applyConstraints(i),this.updateMediaStreamTrackResolution();}catch(r){let o=new D(R.UNEXPECTED_ERROR,r.toString());throw _.error("[".concat(this.getTrackId(),"] applyConstraints error"),o.toString()),o}}this._encoderConfig=e,this._hints.indexOf(ie.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Qt(this,J.NEED_UPDATE_VIDEO_ENCODER,this);}catch(i){return i.throw(_)}}getStats(){return yo(()=>{_.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead");},"localVideoTrackGetStatsWarning"),Qn(this,J.GET_STATS)||le({},DE)}async setBeautyEffect(e){_.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect");}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(e,n):await VE(e)}async setBitrateLimit(e){if(_.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(e))),e){this._forceBitrateLimit=e,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<e.max_bitrate?this._encoderConfig.bitrateMax:e.max_bitrate:this._encoderConfig.bitrateMax=e.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=e.min_bitrate);try{await Qt(this,J.NEED_UPDATE_VIDEO_ENCODER,this);}catch(n){return n.throw(_)}}}async setOptimizationMode(e){if(e!=="motion"&&e!=="detail"&&e!=="balanced")return void _.error(R.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");let n=this._optimizationMode;try{this._optimizationMode=e,await Qt(this,J.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this);}catch(i){throw this._optimizationMode=n,_.error("[".concat(this.getTrackId(),"] set optimization mode failed"),i.toString()),i}_.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(e,")"));}setScalabiltyMode(e){if(e.numSpatialLayers===1&&e.numTemporalLayers!==1)return _.error(R.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=e,_.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(e,")"));}updateMediaStreamTrackResolution(){zA(this._originMediaStreamTrack).then(e=>{let[n,i]=e;this._videoHeight=i,this._videoWidth=n;}).catch(Jl);}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack);}_getDefaultPlayerConfig(){return {fit:"contain"}}async setSenderConfiguration(e){if(!this._enabled)throw new D(R.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");_.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(e)),e=xr(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),this._encoderConfig=e,this._hints.indexOf(ie.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Qt(this,J.NEED_UPDATE_VIDEO_ENCODER,this);}catch(n){return n.throw(_)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;let{width:e,height:n,frameRate:i}=this.getMediaStreamTrackSettings();if(!e||!n||!i)return;let{bitrateMax:r,bitrateMin:o}=this._encoderConfig;if(o==null||r==null){let{max:s,min:a}=function(c,d,l,u,h){let p=v("BITRATE_ADAPTER_TYPE");if(p==="DEFAULT_BITRATE")return {min:u,max:h};if(h===void 0){var T;let E=Math.floor(200*Math.pow(l/15,.6)*Math.pow(c*d/640/360,.75));h=p==="STANDARD_BITRATE"?4*E:2*E,u=(T=u)!==null&&T!==void 0?T:E;}else {var m;u=(m=u)!==null&&m!==void 0?m:Math.floor(h/10);}return {min:u,max:h}}(e,n,i,o,r);this._encoderConfig.bitrateMin=a,this._encoderConfig.bitrateMax=s,_.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(e,", h: ").concat(n,", fps: ").concat(i,"] => [brMax: ").concat(s,", brMin: ").concat(a,"]"));}}getVideoElementVisibleStatus(){try{var e,n;let i=this==null||(e=this._player)===null||e===void 0?void 0:e.getContainerElement(),r={track:this,element:this==null||(n=this._player)===null||n===void 0?void 0:n.getVideoElement(),slot:i?.parentElement},{element:o,slot:s}=r;if(this.isPlaying&&o instanceof HTMLVideoElement&&s instanceof HTMLElement){let a=eI.checkOneElementVisible(o),c=Object.assign({},a);if(c.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=c.visible;let d=et.reportApiInvoke(null,{tag:ge.TRACER,name:ke.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});c.visible?d.onSuccess("Video is visible"):d.onSuccess("Invisible because of ".concat(c.reason));}return c}return}catch(i){throw new D(R.GET_VIDEO_ELEMENT_VISIBLE_ERROR,i.message)}}async renewMediaStreamTrack(e){}pipe(e){if(this.processor===e)return e;if(e._source)throw new D(R.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;let e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset();}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe();}clone(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],i=this._encoderConfig;e&&(i=le(le({},i),xr(e))),i=ps(i);let r=Zt(8,"track-video-cloned-"),o=new mN(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,i,ps(this._scalabilityMode),this._optimizationMode,r,ps(this._hints));return e&&i&&o.setEncoderConfiguration(i),_.debug("clone video track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(n)),o}async replaceTrack(e,n){if(!(e instanceof MediaStreamTrack))throw new D(R.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if(e.kind!=="video")throw new D(R.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(e,n,!0),this.updateMediaStreamTrackResolution();}startMonitorStats(){if(!Ke()&&!mn())return;this._statsTimer&&window.clearInterval(this._statsTimer);let e=2,n=Pu[e],i=-1,r=Date.now(),o=s=>{s>2||s<0||(r=Date.now(),n=Pu[s],this.setSenderConfiguration(n));};this.isUseScaleResolutionDownBy=!0,this._statsTimer=window.setInterval(()=>{let s=this.getStats(),a=Qn(this,J.GET_RTC_STATS);if(s.sendPackets>0&&a){i===-1&&(i=Date.now());let c=Date.now();if(c-i<1e3||c-r<v("PROFILE_SWITCH_INTERVAL"))return;let d=s.sendFrameRate,l=.6*n.frameRate,u=.9*n.frameRate;typeof d=="number"&&d>0&&d<l?e>0&&(e--,o(e),_.debug("[".concat(this.getTrackId(),"] step down for fps ").concat(d,", switchProfile to ").concat(e))):a.OutgoingAvailableBandwidth<n.bitrateMin?e>0&&(e--,o(e),_.debug("[".concat(this.getTrackId(),"] step down for OutgoingAvailableBandwidth ").concat(a.OutgoingAvailableBandwidth,", bitrateMin ").concat(n.bitrateMin,", switchProfile to ").concat(e))):typeof d=="number"&&d>u&&e<Pu.length-1&&a.OutgoingAvailableBandwidth>1.2*Pu[e+1].bitrateMin&&(e++,o(e),_.debug("[".concat(this.getTrackId(),"] step up for fps ").concat(d,", OutgoingAvailableBandwidth ").concat(a.OutgoingAvailableBandwidth,", switchProfile to ").concat(e)));}},v("CHECK_LOCAL_STATS_INTERVAL"));}sendSeiData(e){if(yo(()=>{et.reportApiInvoke(null,{name:ke.LOCAL_VIDEO_SEND_SEI_DATA,options:[],tag:ge.TRACER}).onSuccess("");},this._mediaStreamTrack.id||this.getTrackId()),!v("ENABLE_VIDEO_SEI")||!v("ENABLE_ENCODED_TRANSFORM"))return void _.warning('To send/receive SEI, please call AgoraRTC.setParameter("ENABLE_VIDEO_SEI", true) before instantiate IAgoraRtcClient');if(e instanceof Uint8Array==0)return new D(R.INVALID_PARAMS,"Invalid argument type, ILocalVideoTrack.sendSeiData() only accept Uint8Array argument.").throw();let n=this.getRTCRtpTransceiver();if(!n)return void _.warning("Video track is not published, SEI can not be send");let i=n.sender.getParameters();if(i.codecs.length===0)return;let r=i.codecs[0].mimeType.toLocaleLowerCase();r==="video/h264"?this.safeEmit("sei-to-send",e):_.warning("SEI is not supported by ".concat(r));}bindProcessorDestinationEvents(){this.processorDestination.on(kn.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(),await Qt(this,J.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Qt(this,J.NEED_REPLACE_TRACK,this));});}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(kn.ON_TRACK);}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(di.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(di.REQUEST_CONSTRAINTS);}},Nt(At.prototype,"play",[Vb,Fb],Object.getOwnPropertyDescriptor(At.prototype,"play"),At.prototype),Nt(At.prototype,"stop",[Bb],Object.getOwnPropertyDescriptor(At.prototype,"stop"),At.prototype),Nt(At.prototype,"setEnabled",[jb,Gb,Wb],Object.getOwnPropertyDescriptor(At.prototype,"setEnabled"),At.prototype),Nt(At.prototype,"setMuted",[Hb,Kb,Yb],Object.getOwnPropertyDescriptor(At.prototype,"setMuted"),At.prototype),Nt(At.prototype,"setEncoderConfiguration",[qb,zb],Object.getOwnPropertyDescriptor(At.prototype,"setEncoderConfiguration"),At.prototype),Nt(At.prototype,"getStats",[Jb],Object.getOwnPropertyDescriptor(At.prototype,"getStats"),At.prototype),Nt(At.prototype,"setBeautyEffect",[Xb,Qb],Object.getOwnPropertyDescriptor(At.prototype,"setBeautyEffect"),At.prototype),Nt(At.prototype,"getCurrentFrameData",[Zb],Object.getOwnPropertyDescriptor(At.prototype,"getCurrentFrameData"),At.prototype),Nt(At.prototype,"getCurrentFrameImage",[$b],Object.getOwnPropertyDescriptor(At.prototype,"getCurrentFrameImage"),At.prototype),Nt(At.prototype,"setBitrateLimit",[tw],Object.getOwnPropertyDescriptor(At.prototype,"setBitrateLimit"),At.prototype),Nt(At.prototype,"setOptimizationMode",[ew],Object.getOwnPropertyDescriptor(At.prototype,"setOptimizationMode"),At.prototype),Nt(At.prototype,"setScalabiltyMode",[nw],Object.getOwnPropertyDescriptor(At.prototype,"setScalabiltyMode"),At.prototype),Nt(At.prototype,"updateMediaStreamTrackResolution",[iw],Object.getOwnPropertyDescriptor(At.prototype,"updateMediaStreamTrackResolution"),At.prototype),Nt(At.prototype,"pipe",[rw],Object.getOwnPropertyDescriptor(At.prototype,"pipe"),At.prototype),Nt(At.prototype,"unpipe",[ow],Object.getOwnPropertyDescriptor(At.prototype,"unpipe"),At.prototype),Nt(At.prototype,"close",[sw],Object.getOwnPropertyDescriptor(At.prototype,"close"),At.prototype),Nt(At.prototype,"replaceTrack",[aw],Object.getOwnPropertyDescriptor(At.prototype,"replaceTrack"),At.prototype),Nt(At.prototype,"startMonitorStats",[cw],Object.getOwnPropertyDescriptor(At.prototype,"startMonitorStats"),At.prototype),At),BE=(dw=st({argsMap:(t,e)=>[t.getTrackId(),e]}),lw=Ae(),uw=Ea("CameraVideoTrack","_enabledMutex"),hw=st({argsMap:(t,e)=>[t.getTrackId(),e]}),pw=Ae(),_w=st({argsMap:(t,e)=>[t.getTrackId(),e]}),mw=Ae(),Ew=st({argsMap:t=>[t.getTrackId()]}),_i=class EN extends $t{get __className__(){return "CameraVideoTrack"}constructor(e,n,i,r,o,s){super(e,xr(n.encoderConfig),r,o,s),P(this,"_config",void 0),P(this,"_originalConstraints",void 0),P(this,"_constraints",void 0),P(this,"_enabled",!0),P(this,"_deviceName","default"),P(this,"tryResumeVideoForIOS15_16WeChat",async()=>{(pa()||im())&&!function(){let a=Pt();if(a.os!==He.IOS||!a.osVersion)return !1;let c=a.osVersion.split(".");return Number(c[0])===15&&Number(c[1])>=2}()&&Jv()&&this._enabled&&!this._isClosed&&(_.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack());}),this._config=n,this._originalConstraints=i,this._constraints=i,this._deviceName=e.label,this._encoderConfig=xr(this._config.encoderConfig),Kt.on(on.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Kt.on(on.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents();}async setDevice(e){return typeof e=="string"?this._setDeviceById(e):e.deviceId?this._setDeviceById(e.deviceId):e.facingMode?this._setDeviceByFacingModel(e.facingMode):void 0}async _setDeviceById(e){if(_.info("[".concat(this.getTrackId(),"] set device to ").concat(e)),this._enabled)try{let n=await hi.getDeviceById(e),i={};i.video=le({},this._constraints),i.video.deviceId={exact:e},i.video.facingMode=void 0,this._originMediaStreamTrack.stop();let r=null;try{r=await ui(i,this.getTrackId());}catch(o){throw _.error("[".concat(this.getTrackId(),"] setDevice failed"),o.toString()),r=await ui({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),o}await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=n.label,this._config.cameraId=e,this._constraints.deviceId={exact:e};}catch(n){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}else try{let n=await hi.getDeviceById(e);this._deviceName=n.label,this._config.cameraId=e,this._constraints.deviceId={exact:e};}catch(n){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}_.info("[".concat(this.getTrackId(),"] setDevice success"));}async _setDeviceByFacingModel(e){_.info("[".concat(this.getTrackId(),"] set facingMode ").concat(e));let n={video:le(le({},this._constraints),{},{deviceId:void 0,facingMode:{exact:e}})};if(this._enabled){this._originMediaStreamTrack.stop();let i=null;try{i=await ui(n,this.getTrackId());}catch(r){throw _.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),r.toString()),i=await ui({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution();}this._deviceName="",this._config.facingMode=e,this._config.cameraId=void 0,this._constraints=le({},n.video),_.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"));}async setEnabled(e,n){if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e);}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else {let i=await ui({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1);}await Qt(this,J.NEED_ENABLE_TRACK,this);}catch(i){throw _.error("[".concat(this.getTrackId(),"] setEnabled true error"),i.toString()),i}this.updateMediaStreamTrackResolution(),_.info("[".concat(this.getTrackId(),"] setEnabled to true success")),n||(this._enabled=!0);}else {this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),n||(this._enabled=!1);try{await Qt(this,J.NEED_DISABLE_TRACK,this);}catch(i){throw _.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}_.info("[".concat(this.getTrackId(),"] setEnabled to false success"));}}async setEncoderConfiguration(e,n){if(!this._enabled)throw new D(R.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");e==="720p_auto"?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),e=xr(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate||e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate||e.bitrateMin);let i=ne(this._config);i.encoderConfig=e;let r=xu(i);(Ke()||mn()||Vi())&&(r.deviceId=void 0),_.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(r));try{await this._originMediaStreamTrack.applyConstraints(r),this.updateMediaStreamTrackResolution();}catch(o){let s=new D(R.UNEXPECTED_ERROR,o.toString());throw _.error("[".concat(this.getTrackId(),"] applyConstraints error"),s.toString()),s}this._config=i,this._constraints=r,this._originalConstraints=r,this._encoderConfig=e,this._hints.indexOf(ie.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Qt(this,J.NEED_UPDATE_VIDEO_ENCODER,this);}catch(o){return o.throw(_)}}_getDefaultPlayerConfig(){return {mirror:!0,fit:"cover"}}onTrackEnded(){if((mn()||Vi())&&this._enabled&&!this._isClosed&&Kt.duringInterruption){let e=async()=>{Kt.off(on.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(_.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0));};Kt.on(on.IOS_INTERRUPTION_END,e);}else _.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(Ba.TRACK_ENDED);}async renewMediaStreamTrack(e){let n=e||this._constraints,i=hi.searchDeviceIdByName(this._deviceName);if(i&&!n.deviceId&&(n.deviceId={exact:i}),this._enabled){let r=await ui({video:n},this.getTrackId());this._constraints=n,await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution();}}close(){super.close(),Kt.off(on.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Kt.off(on.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat);}clone(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],i=this._encoderConfig;e&&(i=le(le({},i),xr(e))),i=ps(i);let r=Zt(8,"track-cam-cloned-"),o=new EN(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,ps(le(le({},this._config),{},{encoderConfig:i})),ps(this._constraints),ps(this._scalabilityMode),this._optimizationMode,r);return e&&i&&o.setEncoderConfiguration(i),_.debug("clone track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(n)),o}bindProcessorContextEvents(){this.processorContext.on(di.REQUEST_UPDATE_CONSTRAINTS,async(e,n,i)=>{try{let r=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(r),n();}catch(r){i(r);}}),this.processorContext.on(di.REQUEST_CONSTRAINTS,async e=>{e(this._originMediaStreamTrack.getSettings());});}},Nt(_i.prototype,"setDevice",[dw,lw],Object.getOwnPropertyDescriptor(_i.prototype,"setDevice"),_i.prototype),Nt(_i.prototype,"setEnabled",[uw,hw,pw],Object.getOwnPropertyDescriptor(_i.prototype,"setEnabled"),_i.prototype),Nt(_i.prototype,"setEncoderConfiguration",[_w,mw],Object.getOwnPropertyDescriptor(_i.prototype,"setEncoderConfiguration"),_i.prototype),Nt(_i.prototype,"close",[Ew],Object.getOwnPropertyDescriptor(_i.prototype,"close"),_i.prototype),_i);function jE(t,e,n,i){n.optimizationMode&&(i&&i.width&&i.height?(n.encoderConfig=le(le({},i),{},{bitrateMin:i.bitrateMin,bitrateMax:i.bitrateMax}),n.optimizationMode!=="motion"&&n.optimizationMode!=="detail"||(e.contentHint=n.optimizationMode,e.contentHint===n.optimizationMode?_.debug("[".concat(t,"] set content hint to"),n.optimizationMode):_.debug("[".concat(t,"] set content hint failed")))):_.warning("[".concat(t,"] can not apply optimization mode bitrate config, no encoderConfig")));}var fw,gw,Tw,Sw,wi,Rw,Cw,vw,Iw,yw,Aw,bn;class bw extends LA{getUserId(){return this._userId}constructor(e,n,i,r){super(e,"track-".concat(e.kind,"-").concat(n,"-").concat(r.clientId,"_").concat(Zt(5,""))),P(this,"_userId",void 0),P(this,"_uintId",void 0),P(this,"_isDestroyed",!1),P(this,"store",void 0),P(this,"processor",void 0),P(this,"processorContext",void 0),this._userId=n,this._uintId=i,this.store=r;}_updateOriginMediaStreamTrack(e){this._originMediaStreamTrack=e,this._mediaStreamTrack=e,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext});}_destroy(){this._isDestroyed=!0,_.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close();}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}let Ka=(fw=st({argsMap:(t,e,n)=>[t.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),gw=st({argsMap:t=>[t.getTrackId()]}),Tw=st({argsMap:(t,e)=>[t.getTrackId(),e.name]}),Sw=st({argsMap:t=>[t.getTrackId()]}),Nt((wi=class extends bw{get isPlaying(){return !(!this._player||this._player.videoElementStatus!==An.PLAYING)}get __className__(){return "RemoteVideoTrack"}constructor(t,e,n,i){super(t,e,n,i),P(this,"_videoVisibleTimer",null),P(this,"_previousVideoVisibleStatus",void 0),P(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),P(this,"trackMediaType","video"),P(this,"_videoWidth",void 0),P(this,"_videoHeight",void 0),P(this,"_player",void 0),P(this,"processorDestination",void 0),P(this,"processorContext",void 0),this.updateMediaStreamTrackResolution(),this.processorContext=new KA(this.getTrackId(),"remote"),this.processorDestination=new HA(this.processorContext),this.bindProcessorDestinationEvents();}getStats(){return yo(()=>{_.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead");},"remoteVideoTrackGetStatsWarning"),Qn(this,J.GET_STATS)||le({},DA)}play(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof t=="string"){let i=document.getElementById(t);i?t=i:(_.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body);}_.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(e));let n=le(le({fit:"cover"},e),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(n):(t instanceof HTMLVideoElement?this._player=new FE(n):this._player=new xb(n),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(ja.FIRST_FRAME_DECODED);},this._player.onVideoStateChanged=i=>{this.safeEmit(ja.VIDEO_STATE_CHANGED,i);}),this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{let i=this.getVideoElementVisibleStatus();this.safeEmit(ja.VIDEO_ELEMENT_VISIBLE_STATUS,i);}catch{}},v("CHECK_VIDEO_VISIBLE_INTERVAL"));}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,_.debug("[".concat(this.getTrackId(),"] stop video playback")));}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){zA(this._originMediaStreamTrack).then(t=>{let[e,n]=t;this._videoHeight=n,this._videoWidth=e;}).catch(Jl);}_updatePlayerSource(){_.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack);}getVideoElementVisibleStatus(){try{var t,e;let n=this==null||(t=this._player)===null||t===void 0?void 0:t.getContainerElement(),i={track:this,element:this==null||(e=this._player)===null||e===void 0?void 0:e.getVideoElement(),slot:n?.parentElement},{element:r,slot:o}=i;if(this.isPlaying&&r instanceof HTMLVideoElement&&o instanceof HTMLElement){let s=eI.checkOneElementVisible(r),a=Object.assign({},s);if(a.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=a.visible;let c=et.reportApiInvoke(null,{tag:ge.TRACER,name:ke.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});a.visible?c.onSuccess("Video is visible"):c.onSuccess("Invisible because of ".concat(a.reason));}return a}return}catch(n){throw new D(R.GET_VIDEO_ELEMENT_VISIBLE_ERROR,n.message)}}pipe(t){if(this.processor===t)return t;if(t._source)throw new D(R.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;let t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset();}bindProcessorDestinationEvents(){this.processorDestination.on(kn.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource());});}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(kn.ON_TRACK);}_destroy(){super._destroy(),this.unbindProcessorDestinationEvents();}_onSei(t){this.emit(Os.SEI_RECEIVED,t);}}).prototype,"play",[fw],Object.getOwnPropertyDescriptor(wi.prototype,"play"),wi.prototype),Nt(wi.prototype,"stop",[gw],Object.getOwnPropertyDescriptor(wi.prototype,"stop"),wi.prototype),Nt(wi.prototype,"pipe",[Tw],Object.getOwnPropertyDescriptor(wi.prototype,"pipe"),wi.prototype),Nt(wi.prototype,"unpipe",[Sw],Object.getOwnPropertyDescriptor(wi.prototype,"unpipe"),wi.prototype),wi),Ya=(Rw=st({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),Cw=st({argsMap:(t,e)=>[t.getTrackId(),e]}),vw=st({argsMap:t=>[t.getTrackId()]}),Iw=st({argsMap:t=>[t.getTrackId()]}),yw=st({argsMap:(t,e)=>[t.getTrackId(),e.name]}),Aw=st({argsMap:t=>[t.getTrackId()]}),Nt((bn=class extends bw{get isPlaying(){return this._useAudioElement?xn.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return "RemoteAudioTrack"}constructor(t,e,n,i){super(t,e,n,i),P(this,"trackMediaType","audio"),P(this,"_source",void 0),P(this,"_useAudioElement",!0),P(this,"_volume",100),P(this,"processorContext",void 0),P(this,"processorDestination",void 0),P(this,"_played",!1),P(this,"_bypassWebAudio",!1),v("DISABLE_WEBAUDIO")?(this._source=new xE,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new xA(t,!0),v("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(ci.RECEIVE_TRACK_BUFFER,()=>{this.safeEmit(ja.FIRST_FRAME_DECODED);}),this.processorContext=new qA(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new YA(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(ci.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext});});}setAudioFrameCallback(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners(ci.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(ci.ON_AUDIO_BUFFER),this._source.on(ci.ON_AUDIO_BUFFER,n=>t(n));}setVolume(t){this._volume=t,this._useAudioElement?xn.setVolume(this.getTrackId(),t):this._source.setVolume(t/100);}async setPlaybackDevice(t){if(!this._useAudioElement||!wA())throw new D(R.NOT_SUPPORTED,"your browser does not support setting the audio output device");await xn.setSinkID(this.getTrackId(),t);}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return yo(()=>{_.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead");},"remoteAudioTrackGetStatsWarning"),Qn(this,J.GET_STATS)||le({},NA)}play(){_.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(_.debug("[".concat(this.getTrackId(),"] use audio element to play")),xn.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play();}stop(){_.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?xn.stop(this.getTrackId()):this._source.stop();}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy();}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];_.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&xn.updateTrack(this.getTrackId(),this._mediaStreamTrack);}pipe(t){if(this._bypassWebAudio)throw new D(R.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===t)return t;if(t._source)throw new D(R.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(this._bypassWebAudio)throw new D(R.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;let e=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset();}bindProcessorDestinationEvents(){this.processorDestination.on(kn.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource());}),this.processorDestination.on(kn.ON_NODE,t=>{this._source.processedNode=t;let e=!t;this._useAudioElement!==e&&(this._played?(this.stop(),this._useAudioElement=e,this.play()):this._useAudioElement=e);});}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(kn.ON_TRACK),this.processorDestination.removeAllListeners(kn.ON_NODE);}}).prototype,"setVolume",[Rw],Object.getOwnPropertyDescriptor(bn.prototype,"setVolume"),bn.prototype),Nt(bn.prototype,"setPlaybackDevice",[Cw],Object.getOwnPropertyDescriptor(bn.prototype,"setPlaybackDevice"),bn.prototype),Nt(bn.prototype,"play",[vw],Object.getOwnPropertyDescriptor(bn.prototype,"play"),bn.prototype),Nt(bn.prototype,"stop",[Iw],Object.getOwnPropertyDescriptor(bn.prototype,"stop"),bn.prototype),Nt(bn.prototype,"pipe",[yw],Object.getOwnPropertyDescriptor(bn.prototype,"pipe"),bn.prototype),Nt(bn.prototype,"unpipe",[Aw],Object.getOwnPropertyDescriptor(bn.prototype,"unpipe"),bn.prototype),bn),so=new class extends de{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),P(this,"_lastHiddenTime",0),P(this,"_lastVisibleTime",0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),_.debug("document visibility went ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState);});}};var ww=function(t){return t[t.ONE_BYTE=0]="ONE_BYTE",t[t.TWO_BYTE=1]="TWO_BYTE",t}(ww||{});class b3{constructor(){P(this,"_sequence",0),P(this,"_startTime",Date.now()),P(this,"isUseOneByte",!0);}get startTime(){let e=Date.now()-this._startTime;return e<Math.pow(2,16)?e:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(e){let n={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:e};if(e.byteLength>128){let a=new Uint8Array(4);a.set([1,0,0,0]);let c={id:0,length:4,data:a.buffer},d={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[c]};n.commonPacketHeader.extension=1,n.extension=d,n.payload=this.compress(e),n.commonPacketHeader.length=8+(n.extension.length+2)+n.payload.byteLength;}else n.commonPacketHeader.length=8+n.payload.byteLength;v("SHOW_DATASTREAM2_LOG")&&_.debug("send data header: ".concat(JSON.stringify(n.commonPacketHeader)));let i=new ArrayBuffer(n.commonPacketHeader.length),r=new Uint8Array(i),o=new DataView(i),s=0;if(o.setUint16(s,n.commonPacketHeader.extension<<15|n.commonPacketHeader.reserved<<14|n.commonPacketHeader.length,!0),s+=2,o.setUint32(s,n.commonPacketHeader.sequence,!0),s+=4,o.setUint16(s,n.commonStreamHeader,!0),s+=2,n.extension){let a=this.serializeExtension(n.extension);r.set(new Uint8Array(a),s),s+=a.byteLength;}if(r.set(new Uint8Array(n.payload),s),s+=n.payload.byteLength,s!==n.commonPacketHeader.length)throw Error("serialize error!");return i}deserialize(e){if(e.byteLength<4)return new ArrayBuffer(0);let n=new DataView(e),i=0,r=n.getUint16(i,!0);i+=2;let o={length:16383&r,reserved:(16384&r)>>14,extension:(32768&r)>>15,sequence:n.getUint16(i+2,!0)<<16|n.getUint16(i,!0)},s,a;if(i+=4,v("SHOW_DATASTREAM2_LOG")&&_.debug("receive data header: ".concat(JSON.stringify(o))),n.getUint16(i,!0),i+=2,o.extension){a=this.deserializeExtension(e.slice(i)),i+=2+a.length,s=e.slice(i);let c=!1;if(a.datas.length>0){let d=a.datas.find(l=>l.id===0);d&&(c=(1&new DataView(d.data).getUint32(0,!0))==1);}s=c?this.decompress(s):s;}else s=e.slice(8);return s}serializeExtension(e){let{profile:n,length:i,datas:r}=e,o=new ArrayBuffer(i+2),s=new Uint8Array(o),a=new DataView(o),c=0;if(a.setUint8(c++,n),a.setUint8(c++,i),r.forEach(d=>{n?(a.setUint8(c++,d.id),a.setUint8(c++,d.length),s.set(new Uint8Array(d.data),c),c+=d.data.byteLength):(a.setUint8(c++,d.id|d.length<<4),s.set(new Uint8Array(d.data),c),c+=d.data.byteLength);}),c!==i+2)throw Error("serialize extension error, is ".concat(c,"!==").concat(i+2));return o}deserializeExtension(e){let n=new DataView(e),i=0,r=n.getUint8(i);i++;let o=n.getUint8(i);i++;let s=r===ww.TWO_BYTE,a=[],c=new DataView(e,2),d=0;for(;d<o;){let l=0,u=0,h=new ArrayBuffer(0);s?(l=c.getUint8(d),d++,u=c.getUint8(d),d++):(l=15&c.getUint8(d),u=c.getUint8(d)>>4,d++),u>0&&(h=c.buffer.slice(d+2,d+2+u),d+=h.byteLength),a.push({id:l,length:u,data:h});}if(d!==o)throw Error("parse error");return {profile:r,length:o,datas:a}}decompress(e){return h3(new Uint8Array(e))}compress(e){return u3(new Uint8Array(e))}}class Ow extends de{constructor(e,n){super(),P(this,"_version",1),P(this,"_type",3),P(this,"_config",void 0),P(this,"_originDataChannel",void 0),P(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),P(this,"_dataStreamPacketHandler",void 0),P(this,"_datachannelEventMap",new Map),this._config=e,n&&(this._originDataChannel=n,this._bandDataChannelEvents(n)),this._initPacketHeader(),this._dataStreamPacketHandler=new b3;}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return v("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var e,n;return (e=(n=this._originDataChannel)===null||n===void 0?void 0:n.readyState)!==null&&e!==void 0?e:"connecting"}get _originDataChannelId(){var e,n;return (e=(n=this._originDataChannel)===null||n===void 0?void 0:n.id)!==null&&e!==void 0?e:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0);}async _waitTillOpen(){return new K((e,n)=>{if(this._originDataChannel){this._originDataChannel.readyState==="open"&&e();let i=setTimeout(()=>{var r;n(new D(R.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat((r=this._originDataChannel)===null||r===void 0?void 0:r.id)));},1e4);this._originDataChannel.onopen=()=>{clearTimeout(i),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),e();},this._originDataChannel.onerror=()=>{throw clearTimeout(i),new D(R.DATACHANNEL_CONNECTION_TIMEOUT)};}else n(new D(R.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"));})}_updateOriginDataChannel(e){this._originDataChannel=e,this._bandDataChannelEvents(e);}_initPacketHeader(){let e=new DataView(this._dataStreamPacketHeader);e.setUint16(0,this._version),e.setUint8(2,this._type),e.setUint8(3,this._config.id);}_bandDataChannelEvents(e){this._unbindDataChannelEvents(e),[Mu.OPEN,Mu.CLOSE,Mu.ERROR].forEach(n=>{let i=()=>{this.emit(n);};this._datachannelEventMap.set(n,i),e.addEventListener(n,i);});}_unbindDataChannelEvents(e){Array.from(this._datachannelEventMap.entries()).forEach(n=>{let[i,r]=n;e.removeEventListener(i,r);}),this._datachannelEventMap.clear();}}class w3 extends Ow{constructor(e){super(e),P(this,"_messageListener",void 0),this._messageListener=n=>{if(n.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);let i=n.data.slice(0,this._dataStreamPacketHeader.byteLength),r=new DataView(i).getUint8(3);if(r!==this.id)return void(v("SHOW_DATASTREAM2_LOG")&&_.debug("invalid datachannel id: ".concat(r," !== ").concat(this.id)));let o=n.data.slice(this._dataStreamPacketHeader.byteLength);o=this._dataStreamPacketHandler.deserialize(o),this.emit(Mu.MESSAGE,o);};}_updateOriginDataChannel(e){super._updateOriginDataChannel(e),this._bandRemoteDataChannelEvents();}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close());}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener);}}class Nw extends Ow{send(e){if(this._originDataChannel){let n=e;n=this._dataStreamPacketHandler.serialize(e);let i=new Uint8Array(this._dataStreamPacketHeader.byteLength+n.byteLength);i.set(new Uint8Array(this._dataStreamPacketHeader),0),i.set(new Uint8Array(n),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(i.buffer);}}}function Fu(){let t=new Blob([atob("ZnVuY3Rpb24gZShlKXtjb25zdCB0PW5ldyBEYXRhVmlldyhlLmRhdGEpO2lmKDA9PT10LmdldFVpbnQ4KDApJiYwPT09dC5nZXRVaW50OCgxKSYmMD09PXQuZ2V0VWludDgoMikmJjE9PT10LmdldFVpbnQ4KDMpJiY2PT09dC5nZXRVaW50OCg0KSl7bGV0IG49NixyPTAsbz0wO2Zvcig7MjU1PT09KG89dC5nZXRVaW50OChuKyspKTspcis9MjU1O3IrPW87Y29uc3QgYT1mdW5jdGlvbihlLHQsbil7bGV0IHI9bmV3IFVpbnQ4QXJyYXkoZSx0LG4pLG89W10sYT0wO2Zvcig7YTxuOylhKzM8biYmMD09PXJbYV0mJjA9PT1yW2ErMV0mJjM9PT1yW2ErMl0mJigwPT09clthKzNdfHwxPT09clthKzNdfHwyPT09clthKzNdfHwzPT09clthKzNdKT8oby5wdXNoKHJbYV0sclthKzFdLHJbYSszXSksYSs9NCk6KG8ucHVzaChyW2FdKSxhKyspO3JldHVybiBuZXcgVWludDhBcnJheShvKX0oZS5kYXRhLG4scik7cmV0dXJuIG5ldyBVaW50OEFycmF5KGEpfXJldHVybiBudWxsfWZ1bmN0aW9uIHQoZSx0KXtjb25zdCBuPWZ1bmN0aW9uKGUpe2NvbnN0IHQ9ZS5sZW5ndGg7bGV0IG49W10scj0wO2Zvcig7cjx0OylyKzI8dCYmMD09PWVbcl0mJjA9PT1lW3IrMV0mJigwPT09ZVtyKzJdfHwxPT09ZVtyKzJdfHwyPT09ZVtyKzJdfHwzPT09ZVtyKzJdKT8obi5wdXNoKGVbcl0sZVtyKzFdLDMsZVtyKzJdKSxyKz0zKToobi5wdXNoKGVbcl0pLHIrKyk7cmV0dXJuIG5ldyBVaW50OEFycmF5KG4pfSh0KSxyPW4ubGVuZ3RoLG89TWF0aC5mbG9vcihyLzI1NSksYT1yJTI1NSxzPW5ldyBVaW50OEFycmF5KDYrbysxK3IrZS5ieXRlTGVuZ3RoKTtzWzBdPTAsc1sxXT0wLHNbMl09MCxzWzNdPTEsc1s0XT02LHNbNV09MTAxO2xldCBpPTA7Zm9yKDtpPG87KXNbNitpXT0yNTUsaSsrO3JldHVybiBzWzYraV09YSxpKysscy5zZXQobiw2K2kpLHMuc2V0KG5ldyBVaW50OEFycmF5KGUpLDYraStyKSxzLmJ1ZmZlcn1uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIlNhZmFyaSIpPi0xJiYtMT09PW5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiQ2hyb21lIikmJihzZWxmLm9ucnRjdHJhbnNmb3JtPW49Pntjb25zdCByPW4udHJhbnNmb3JtZXI7bGV0IG89W107ci5vcHRpb25zLnBvcnQub25tZXNzYWdlPWU9PntlLmRhdGEuc2VpJiZvLnB1c2goZS5kYXRhLnNlaSl9LHNlbGYucG9zdE1lc3NhZ2UoInN0YXJ0ZWQiKTtjb25zdCBhPXIucmVhZGFibGUuZ2V0UmVhZGVyKCkscz1yLndyaXRhYmxlLmdldFdyaXRlcigpOyJyeCI9PT1yLm9wdGlvbnMubmFtZT9mdW5jdGlvbiB0KG4pe2EucmVhZCgpLnRoZW4oKHI9PntpZighci5kb25lKXtpZihyLnZhbHVlIGluc3RhbmNlb2YgUlRDRW5jb2RlZFZpZGVvRnJhbWUpe2NvbnN0IHQ9ZShyLnZhbHVlKTt0JiZuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7c2VpOnR9KX1zLndyaXRlKHIudmFsdWUpLG4ub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQobil9fSkpfShyKToidHgiPT09ci5vcHRpb25zLm5hbWUmJmZ1bmN0aW9uIGUobil7YS5yZWFkKCkudGhlbigocj0+e2lmKCFyLmRvbmUpe2lmKHIudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgZT1vLnNoaWZ0KCk7ZSYmKHIudmFsdWUuZGF0YT10KHIudmFsdWUuZGF0YSxlKSl9cy53cml0ZShyLnZhbHVlKSxuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSxlKG4pfX0pKX0ocil9LHNlbGYucG9zdE1lc3NhZ2UoInJlZ2lzdGVyZWQiKSk7Cg==")],{type:"text/javascript"});return setTimeout(()=>By.revokeObjectURL(t),0),new Worker(By.createObjectURL(t))}let Bu=new Map,ju=new Map,Gu=new Map;async function O3(t,e){if(!Ot().supportWebRTCEncodedTransform)return void _.warning("browser not support video encoded transform");if(Gu.has(t)||!t.track)return;let n={track:t.track};if(vo()){if(!t.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");let r=null;try{r=t.createEncodedStreams();}catch(a){return void _.error("create video-encoded-streams error",a&&a.message)}let o=[];e.on("sei-to-send",a=>{o.push(a);});let s=new TransformStream({transform(a,c){n.controller||(n.controller=c),t.track&&t.track.id!==n.track.id&&(_.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i));let d=o.shift();d&&(a.data=function(l,u){let h=function(C){let A=C.length,b=[],O=0;for(;O<A;)O+2<A&&C[O]===0&&C[O+1]===0&&(C[O+2]===0||C[O+2]===1||C[O+2]===2||C[O+2]===3)?(b.push(C[O],C[O+1],3,C[O+2]),O+=3):(b.push(C[O]),O++);return new Uint8Array(b)}(u),p=h.length,T=Math.floor(p/255),m=p%255,E=new Uint8Array(6+T+1+p+l.byteLength);E[0]=0,E[1]=0,E[2]=0,E[3]=1,E[4]=6,E[5]=101;let S=0;for(;S<T;)E[6+S]=255,S++;return E[6+S]=m,S++,E.set(h,6+S),E.set(new Uint8Array(l),6+S+p),E.buffer}(a.data,d)),c.enqueue(a);}});r.readable.pipeThrough(s).pipeTo(r.writable);}else {if(!Ke())return;{if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");let r=Fu(),o=new MessageChannel;await new K(a=>r.onmessage=c=>{c.data==="registered"&&a(void 0);});let s=new RTCRtpScriptTransform(r,{name:"tx",port:o.port2},[o.port2]);t.transform=s,await new K(a=>r.onmessage=c=>{c.data==="started"&&a(void 0);}),e.on("sei-to-send",a=>{o.port1.postMessage({sei:a});}),o.port1.onmessage=a=>{var c;a.data.transformed&&t.track&&((c=t.track)===null||c===void 0?void 0:c.id)!==n.track.id&&(_.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i));},n.worker=r;}}function i(){if(t.track){if(this.id!==t.track.id)return;t.track.removeEventListener("ended",i);}let r=Gu.get(t);if(r){Gu.delete(t);try{var o,s;(o=r.controller)===null||o===void 0||o.terminate(),(s=r.worker)===null||s===void 0||s.terminate();}catch(a){_.warning(a&&a.message);}}}Gu.set(t,n),t.track.addEventListener("ended",i);}let Sd=new Map;async function N3(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Ot().supportWebRTCEncodedTransform)return void _.warning("browser not support video encoded transform");if(!t.track)return;if(Sd.has(t)){let r=Sd.get(t);return void(r&&(r.onSei=e.onSei))}let n={track:t.track,onSei:e.onSei};if(vo()){if(!t.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");let r=null;try{r=t.createEncodedStreams();}catch(s){return void _.error("create video-encoded-streams error",s&&s.message)}let o=new TransformStream({transform(s,a){n.controller||(n.controller=a),t.track&&t.track.id!==n.track.id&&(_.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i));let c=function(d){let l=new DataView(d.data);if(l.getUint8(0)===0&&l.getUint8(1)===0&&l.getUint8(2)===0&&l.getUint8(3)===1&&l.getUint8(4)===6){let u=6,h=0,p=0;for(;(p=l.getUint8(u++))===255;)h+=255;h+=p;let T=function(m,E,S){let C=new Uint8Array(m,E,S),A=[],b=0;for(;b<S;)b+3<S&&C[b]===0&&C[b+1]===0&&C[b+2]===3&&(C[b+3]===0||C[b+3]===1||C[b+3]===2||C[b+3]===3)?(A.push(C[b],C[b+1],C[b+3]),b+=4):(A.push(C[b]),b++);return new Uint8Array(A)}(d.data,u,h);return new Uint8Array(T)}return null}(s);c&&n.onSei&&n.onSei(c),a.enqueue(s);}});r.readable.pipeThrough(o).pipeTo(r.writable);}else if(Ke()){if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");let r=Fu(),o=new MessageChannel;await new K(a=>r.onmessage=c=>{c.data==="registered"&&a(void 0);});let s=new RTCRtpScriptTransform(r,{name:"rx",port:o.port2},[o.port2]);t.transform=s,await new K(a=>r.onmessage=c=>{c.data==="started"&&a(void 0);}),o.port1.onmessage=a=>{var c;a.data.transformed&&t.track&&((c=t.track)===null||c===void 0?void 0:c.id)!==n.track.id?(_.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i)):a.data.sei&&n.onSei&&n.onSei(a.data.sei);},n.worker=r;}function i(){if(t.track){if(this.id!==t.track.id)return;t.track.removeEventListener("ended",i);}(function(r){let o=Sd.get(r);if(o){Sd.delete(r);try{var s,a;(s=o.controller)===null||s===void 0||s.terminate(),(a=o.worker)===null||a===void 0||a.terminate();}catch(c){_.warning(c&&c.message);}}})(t);}Sd.set(t,n),t.track.addEventListener("ended",i);}(function(){let t=Pt();un.getDisplayMedia=!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia),un.getStreamFromExtension=t.name===Bt.CHROME&&Number(t.version)>34,un.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return !1;let e=new RTCPeerConnection,n=!1;try{e.addTransceiver("audio"),n=!0;}catch{}return e.close(),n}(),un.supportMinBitrate=t.name===Bt.CHROME||t.name===Bt.EDGE,un.supportSetRtpSenderParameters=function(){let e=Pt();return !!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!Io()||!(!Ke()&&!Kl())||e.name===Bt.FIREFOX&&Number(e.version)>=64)}(),t.name===Bt.SAFARI&&(Number(t.version)>=14?un.supportDualStream=!0:un.supportDualStream=!1),un.webAudioMediaStreamDest=function(){let e=Pt();return !(e.name===Bt.SAFARI&&Number(e.version)<12)}(),un.supportReplaceTrack=!!window.RTCRtpSender&&typeof RTCRtpSender.prototype.replaceTrack=="function",un.supportWebGL=typeof WebGLRenderingContext<"u",un.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,Io()||(un.webAudioWithAEC=!0),un.supportShareAudio=function(){let e=Pt();return (e.os===He.WIN_10||e.os===He.WIN_81||e.os===He.WIN_7||e.os===He.LINUX||e.os===He.MAC_OS||e.os===He.CHROMIUM_OS)&&e.name===Bt.CHROME&&Number(e.version)>=74}(),un.supportDataChannel=!!(nm(76)||function(e){let n=Pt();return !(n.name!==Bt.FIREFOX||!n.osVersion)&&Number(n.version)>=e}(68)||Gv(14)),un.supportPCSetConfiguration=function(){let e=window.RTCPeerConnection;return !Xt()&&!!e&&e.prototype.setConfiguration instanceof Function}(),un.supportWebRTCEncodedTransform=function(){let e=Pt();return e.name==="Chrome"&&Number(e.version)>=86||e.name==="Safari"&&Number(e.version)>=15}(),un.supportWebRTCInsertableStream=function(){let e=Pt();return (e.name===Bt.CHROME||e.name===Bt.EDGE)&&Number(e.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),un.supportRequestVideoFrameCallback="requestVideoFrameCallback"in HTMLVideoElement.prototype,un.supportWebCrypto=typeof window<"u"&&window.crypto!==void 0&&window.crypto.subtle!==void 0,zl(()=>{un.supportDualStreamEncoding=function(){let e=Pt();return !!v("DISABLE_WEBAUDIO")||e.name==="Safari"&&Number(e.version)>=14||!!(e.name==="Chrome"&&/Windows/i.test(e.os||"")&&Number(e.version)>=100&&v("CHROME_DUAL_STREAM_USE_ENCODING"))}(),_.info("browser compatibility",JSON.stringify(un),JSON.stringify(t));});})();class D3 extends de{constructor(){super(...arguments),g(this,"resultStorage",new Map);}setLocalAudioStats(e,n,i){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",e,this.checkAudioInputLevel(i,n)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",e,this.checkSendAudioBitrate(i,n));}setLocalVideoStats(e,n,i){this.record("SEND_VIDEO_BITRATE_TOO_LOW",e,this.checkSendVideoBitrate(i,n)),this.record("FRAMERATE_INPUT_TOO_LOW",e,this.checkFramerateInput(i,n)),this.record("FRAMERATE_SENT_TOO_LOW",e,this.checkFramerateSent(i));}setRemoteAudioStats(e,n){let i=e.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",i,this.checkAudioOutputLevel(n));}setRemoteVideoStats(e,n){let i=e.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",i,this.checkVideoDecode(n));}record(e,n,i){if(v("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(e)||this.resultStorage.set(e,{result:[],isPrevNormal:!0});let r=this.resultStorage.get(e);if(r&&(r.result.push(i),r.result.length>=5)){var o;let s=q(o=r.result).call(o,!0);r.isPrevNormal&&!s&&this.emit("exception",Dw[e],e,n),!r.isPrevNormal&&s&&this.emit("exception",Dw[e]+2e3,e+"_RECOVER",n),r.isPrevNormal=s,r.result=[];}}checkAudioOutputLevel(e){return !(e.receiveBitrate>0&&e.receiveLevel===0)}checkAudioInputLevel(e,n){return n instanceof je&&!n.isActive||!!n.muted||e.sendVolumeLevel!==0}checkFramerateInput(e,n){let i=null;n._encoderConfig&&n._encoderConfig.frameRate&&(i=Wn(n._encoderConfig.frameRate));let r=e.captureFrameRate;return !i||!r||!(i>10&&r<5||i<10&&i>=5&&r<=1)}checkFramerateSent(e){return !(e.captureFrameRate&&e.sendFrameRate&&e.captureFrameRate>5&&e.sendFrameRate<=1)}checkSendVideoBitrate(e,n){return !!n.muted||e.sendBitrate!==0}checkSendAudioBitrate(e,n){return n instanceof je&&!n.isActive||!!n.muted||e.sendBitrate!==0}checkVideoDecode(e){return e.receiveBitrate===0||e.decodeFrameRate!==0}}let Dw={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003},fn=new class{markSubscribeStart(t,e){performance.mark("agora-web-sdk/".concat(t,"/subscribe-").concat(e));}markPublishStart(t,e){performance.mark("agora-web-sdk/".concat(t,"/publish-").concat(e));}measureFromSubscribeStart(t,e){let n=performance.getEntriesByName("agora-web-sdk/".concat(t,"/subscribe-").concat(e));if(n.length>0){let i=n[n.length-1];return Math.round(performance.now()-i.startTime)}return 0}measureFromPublishStart(t,e){let n=performance.getEntriesByName("agora-web-sdk/".concat(t,"/publish-").concat(e));if(n.length>0){let i=n[n.length-1];return Math.round(performance.now()-i.startTime)}return 0}};function GE(t,e){this.v=t,this.k=e;}function gt(t){return new GE(t,0)}var P3=fS,L3=Ir;ee({target:"Promise",stat:!0,forced:!0},{withResolvers:function(){var t=L3.f(this);return {promise:t.promise,resolve:t.resolve,reject:t.reject}}});var k3=Ir,M3=$s;ee({target:"Promise",stat:!0,forced:!0},{try:function(t){var e=k3.f(this),n=M3(t);return (n.error?e.reject:e.resolve)(n.value),e.promise}});var WE=j(P3),Pw=ra.f("asyncIterator"),U3=j(Pw);function Rd(t){var e,n;function i(o,s){try{var a=t[o](s),c=a.value,d=c instanceof GE;WE.resolve(d?c.v:c).then(function(l){if(d){var u=o==="return"?"return":"next";if(!c.k||l.done)return i(u,l);l=t[u](l).value;}r(a.done?"return":"normal",l);},function(l){i("throw",l);});}catch(l){r("throw",l);}}function r(o,s){switch(o){case"return":e.resolve({value:s,done:!0});break;case"throw":e.reject(s);break;default:e.resolve({value:s,done:!1});}(e=e.next)?i(e.key,e.arg):n=null;}this._invoke=function(o,s){return new WE(function(a,c){var d={key:o,arg:s,resolve:a,reject:c,next:null};n?n=n.next=d:(e=n=d,i(o,s));})},typeof t.return!="function"&&(this.return=void 0);}function $n(t){return function(){return new Rd(t.apply(this,arguments))}}Rd.prototype[typeof aa=="function"&&U3||"@@asyncIterator"]=function(){return this},Rd.prototype.next=function(t){return this._invoke("next",t)},Rd.prototype.throw=function(t){return this._invoke("throw",t)},Rd.prototype.return=function(t){return this._invoke("return",t)};var Lw=j(ir.Object.getOwnPropertySymbols),x3=ee,V3=Gh.indexOf,F3=Wd,HE=ac([].indexOf),kw=!!HE&&1/HE([1],1,-0)<0;x3({target:"Array",proto:!0,forced:kw||!F3("indexOf")},{indexOf:function(t){var e=arguments.length>1?arguments[1]:void 0;return kw?HE(this,t,e)||0:V3(this,t,e)}});var B3=Mi("Array").indexOf,j3=ut,G3=B3,KE=Array.prototype,W3=function(t){var e=t.indexOf;return t===KE||j3(KE,t)&&e===KE.indexOf?G3:e},Mw=j(W3);function H3(t,e){if(t==null)return {};var n,i,r=function(s,a){if(s==null)return {};var c,d,l={},u=AI(s);for(d=0;d<u.length;d++)c=u[d],Mw(a).call(a,c)>=0||(l[c]=s[c]);return l}(t,e);if(Lw){var o=Lw(t);for(i=0;i<o.length;i++)n=o[i],Mw(e).call(e,n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(r[n]=t[n]);}return r}var Uw={exports:{}};(function(t,e){t.exports=(()=>{var n={8:(o,s,a)=>{a.r(s),a.d(s,{Parser:()=>bt,Printer:()=>nr,parse:()=>ht,print:()=>Ut});let c=`
`,d="".concat("\r").concat(c),l=" ",u;function h(Y){return Y>="0"&&Y<="9"}function p(Y){return Y>="!"&&Y<="~"}function T(Y){return p(Y)||Y>="\x80"&&Y<="\xFF"}function m(Y){return Y==="!"||Y>="#"&&Y<="'"||Y>="*"&&Y<="+"||Y>="-"&&Y<="."||Y>="0"&&Y<="9"||Y>="A"&&Y<="Z"||Y>="^"&&Y<="~"}function E(Y){return Y>="1"&&Y<="9"}function S(Y){return Y>="A"&&Y<="Z"||Y>="a"&&Y<="z"}function C(Y){return Y==="d"||Y==="h"||Y==="m"||Y==="s"}function A(Y){return Y>""&&Y<"	"||Y>"\v"&&Y<"\f"||Y>""&&Y<"\xFF"}function b(Y){return S(Y)||h(Y)||Y==="+"||Y==="/"}function O(Y){return h(Y)||S(Y)||Y==="+"||Y==="/"||Y==="-"||Y==="_"}function N(Y){return S(Y)||h(Y)||Y==="+"||Y==="/"}function k(Y,f){var I=Object.keys(Y);if(Object.getOwnPropertySymbols){var y=Object.getOwnPropertySymbols(Y);f&&(y=y.filter(function(B){return Object.getOwnPropertyDescriptor(Y,B).enumerable})),I.push.apply(I,y);}return I}function M(Y){for(var f=1;f<arguments.length;f++){var I=arguments[f]!=null?arguments[f]:{};f%2?k(Object(I),!0).forEach(function(y){x(Y,y,I[y]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(Y,Object.getOwnPropertyDescriptors(I)):k(Object(I)).forEach(function(y){Object.defineProperty(Y,y,Object.getOwnPropertyDescriptor(I,y));});}return Y}function x(Y,f,I){return f in Y?Object.defineProperty(Y,f,{value:I,enumerable:!0,configurable:!0,writable:!0}):Y[f]=I,Y}(function(Y){Y.VERSION="v",Y.ORIGIN="o",Y.SESSION_NAME="s",Y.INFORMATION="i",Y.URI="u",Y.EMAIL="e",Y.PHONE="p",Y.CONNECTION="c",Y.BANDWIDTH="b",Y.TIME="t",Y.REPEAT="r",Y.ZONE_ADJUSTMENTS="z",Y.KEY="k",Y.ATTRIBUTE="a",Y.MEDIA="m";})(u||(u={}));class X{consumeText(f,I){let y=I;for(;y<f.length;){let B=f[y];if(B==="\0"||B==="\r"||B===c)break;y+=1;}if(y-I==0)throw new Error("Invalid text, at ".concat(f));return y}consumeUnicastAddress(f,I,y){return this.consumeTill(f,I,l)}consumeOneOrMore(f,I,y){let B=I;for(;y(f[B]);)B++;if(B-I==0)throw new Error("Invalid rule at ".concat(I,"."));return B}consumeSpace(f,I){if(f[I]===l)return I+1;throw new Error("Invalid space at ".concat(I,"."))}consumeIP4Address(f,I){let y=I;for(let B=0;B<4;B++)if(y=this.consumeDecimalUChar(f,y),B!==3){if(f[y]!==".")throw new Error("Invalid IP4 address.");y++;}return y}consumeDecimalUChar(f,I){let y=I;for(let pt=0;pt<3&&h(f[y]);pt++,y++);if(y-I==0)throw new Error("Invalid decimal uchar.");let B=parseInt(f.slice(I,y));if(B>=0&&B<=255)return y;throw new Error("Invalid decimal uchar")}consumeIP6Address(f,I){let y=this.consumeHexpart(f,I);return f[y]===":"&&(y+=1,y=this.consumeIP4Address(f,y)),y}consumeHexpart(f,I){let y=I;if(f[y]===":"&&f[y+1]===":"){y+=2;try{y=this.consumeHexseq(f,y);}catch{}return y}if(y=this.consumeHexseq(f,y),f[y]===":"&&f[y+1]===":"){y+=2;try{y=this.consumeHexseq(f,y);}catch{}return y}return y}consumeHexseq(f,I){let y=I;for(;y=this.consumeHex4(f,y),f[y]===":"&&f[y+1]!==":";)y+=1;return y}consumeHex4(f,I){let y=0;for(;y<4;y++)if(!((B=f[I+y])>="0"&&B<="9"||B>="a"&&B<="f"||B>="A"&&B<="F")){if(y===0)throw new Error("Invalid hex 4");break}var B;return I+y}consumeFQDN(f,I){let y=I;for(;h(f[y])||S(f[y])||f[y]==="-"||f[y]===".";)y+=1;if(y-I<4)throw new Error("Invalid FQDN");return y}consumeExtnAddr(f,I){return this.consumeOneOrMore(f,I,T)}consumeMulticastAddress(f,I,y){switch(y){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(f,I);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(f,I);default:try{return this.consumeFQDN(f,I)}catch{return this.consumeExtnAddr(f,I)}}}consumeIP6MulticastAddress(f,I){let y=this.consumeHexpart(f,I);return f[y]==="/"?this.consumeInteger(f,y+1):y}consumeIP4MulticastAddress(f,I){let y=I+3,B=f.slice(I,y),pt=parseInt(B);if(pt<224||pt>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let Yt=0;Yt<3;Yt++){if(f[y]!==".")throw new Error("Invalid IP4 multicast address.");y+=1,y=this.consumeDecimalUChar(f,y);}return f[y]==="/"&&(y+=1),y=this.consumeTTL(f,y),f[y]==="/"&&(y=this.consumeInteger(f,y)),y}consumeInteger(f,I){if(!E(f[I]))throw new Error("Invalid integer.");for(I+=1;h(f[I]);)I+=1;return I}consumeTTL(f,I){if(f[I]==="0")return I+1;if(!E(f[I]))throw new Error("Invalid TTL.");I+=1;for(let y=0;y<2&&h(f[I]);y++)I+=1;return I}consumeToken(f,I){return this.consumeOneOrMore(f,I,m)}consumeTime(f,I){let y=I;if(f[y]==="0")return y+1;for(E(f[y])&&(y+=1);h(f[y]);)y++;if(y-I<10)throw new Error("Invalid time");return y}consumeAddress(f,I){return this.consumeTill(f,I,l)}consumeTypedTime(f,I){let y=I;return y=this.consumeOneOrMore(f,y,h),C(f[y])?y+1:y}consumeRepeatInterval(f,I){if(!E(f[I]))throw new Error("Invalid repeat interval");for(I+=1;h(f[I]);)I+=1;return C(f[I])&&(I+=1),I}consumePort(f,I){return this.consumeOneOrMore(f,I,h)}consume(f,I,y){for(let B=0;B<y.length;B++){if(I+B>=f.length)throw new Error("consume exceeding value length");if(f[I+B]!==y[B])throw new Error("consume ".concat(y," failed at ").concat(B))}return I+y.length}consumeTill(f,I,y){let B=I;for(;B<f.length&&(typeof y!="string"||f[B]!==y)&&(typeof y!="function"||!y(f[B]));)B++;return B}}class bt extends X{constructor(){super(),x(this,"records",[]),x(this,"currentLine",0);}parse(f){let I=this.probeEOL(f);this.records=f.split(I).filter(Ve=>!!vn(Ve).call(Ve)).map(this.parseLine),this.currentLine=0;let y=this.parseVersion(),B=this.parseOrigin(),pt=this.parseSessionName(),Yt=this.parseInformation(),We=this.parseUri(),qn=this.parseEmail(),lo=this.parsePhone(),hh=this.parseConnection(),ph=this.parseBandWidth(),Pi=this.parseTimeFields(),Jo=this.parseKey(),nc=this.parseSessionAttribute(),be=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return {version:y,origin:B,sessionName:pt,information:Yt,uri:We,emails:qn,phones:lo,connection:hh,bandwidths:ph,timeFields:Pi,key:Jo,attributes:nc,mediaDescriptions:be}}getCurrentRecord(){let f=this.records[this.currentLine];if(!f)throw new Error("Record doesn't exit.");return f}probeEOL(f){for(let I=0;I<f.length;I++)if(f[I]===c)return f[I-1]==="\r"?d:c;throw new Error("Invalid newline character.")}parseLine(f,I){if(f.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");let y=f[0];if(f[1]!=="=")throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return {type:y,value:f.slice(2),line:I,cur:0}}parseSessionAttribute(){let f=new re;for(;this.currentLine<this.records.length;){let I=this.getCurrentRecord();if(I.type!==u.ATTRIBUTE)break;let y={attField:this.extractOneOrMore(I,B=>m(B)&&B!==":"),_cur:0};I.value[I.cur]===":"&&(I.cur+=1,y.attValue=this.extractOneOrMore(I,A)),f.parse(y),this.currentLine++;}return f.digest()}parseMediaAttributes(f){let I=new Le(f);for(;this.currentLine<this.records.length;){let y=this.getCurrentRecord();if(y.type!==u.ATTRIBUTE)break;let B={attField:this.extractOneOrMore(y,pt=>m(pt)&&pt!==":"),_cur:0};y.value[y.cur]===":"&&(y.cur+=1,B.attValue=this.extractOneOrMore(y,A)),I.parse(B),this.currentLine++;}return I.digest()}parseKey(){let f=this.getCurrentRecord();if(f.type===u.KEY){if(f.value==="prompt"||f.value==="clear:"||f.value==="base64:"||f.value==="uri:")return f.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){let f=this.getCurrentRecord();if(f.type===u.ZONE_ADJUSTMENTS){let I=[];for(;;)try{let y=this.extract(f,this.consumeTime);this.consumeSpaceForRecord(f);let B=!1;f.value[f.cur]==="-"&&(B=!0,f.cur+=1);let pt=this.extract(f,this.consumeTypedTime);I.push({time:y,typedTime:pt,back:B});}catch{break}if(I.length===0)throw new Error("Invalid zone adjustments");return this.currentLine++,I}return []}parseRepeat(){let f=[];for(;;){let I=this.getCurrentRecord();if(I.type!==u.REPEAT)break;{let y=this.extract(I,this.consumeRepeatInterval),B=this.parseTypedTime(I);f.push({repeatInterval:y,typedTimes:B}),this.currentLine++;}}return f}parseTypedTime(f){let I=[];for(;;)try{this.consumeSpaceForRecord(f),I.push(this.extract(f,this.consumeTypedTime));}catch{break}if(I.length===0)throw new Error("Invalid typed time.");return I}parseTime(){let f=this.getCurrentRecord(),I=this.extract(f,this.consumeTime);this.consumeSpaceForRecord(f);let y=this.extract(f,this.consumeTime);return this.currentLine++,{startTime:I,stopTime:y}}parseBandWidth(){let f=[];for(;this.currentLine<this.records.length;){let I=this.getCurrentRecord();if(I.type!==u.BANDWIDTH)break;{let y=this.extractOneOrMore(I,m);if(I.value[I.cur]!==":")throw new Error("Invalid bandwidth field.");I.cur++;let B=this.extractOneOrMore(I,h);f.push({bwtype:y,bandwidth:B}),this.currentLine++;}}return f}parseVersion(){let f=this.getCurrentRecord();if(f.type!==u.VERSION)throw new Error("first sdp record must be version");let I=f.value.slice(0,this.consumeOneOrMore(f.value,0,h));if(I.length!==f.value.length)throw new Error('invalid proto version, "v='.concat(f.value,'"'));return this.currentLine++,I}parseOrigin(){let f=this.getCurrentRecord();if(f.type!==u.ORIGIN)throw new Error("second line of sdp must be origin");let I=this.extractOneOrMore(f,T);this.consumeSpaceForRecord(f);let y=this.extractOneOrMore(f,h);this.consumeSpaceForRecord(f);let B=this.extractOneOrMore(f,h);this.consumeSpaceForRecord(f);let pt=this.extractOneOrMore(f,m);this.consumeSpaceForRecord(f);let Yt=this.extractOneOrMore(f,m);this.consumeSpaceForRecord(f);let We=this.extract(f,this.consumeUnicastAddress);return this.currentLine++,{username:I,sessId:y,sessVersion:B,nettype:pt,addrtype:Yt,unicastAddress:We}}parseSessionName(){let f=this.getCurrentRecord();if(f.type===u.SESSION_NAME){let I=this.extract(f,this.consumeText);return this.currentLine++,I}}parseInformation(){let f=this.getCurrentRecord();if(f.type!==u.INFORMATION)return;let I=this.extract(f,this.consumeText);return this.currentLine++,I}parseUri(){let f=this.getCurrentRecord();if(f.type===u.URI)return this.currentLine++,f.value}parseEmail(){let f=[];for(;;){let I=this.getCurrentRecord();if(I.type!==u.EMAIL)break;f.push(I.value),this.currentLine++;}return f}parsePhone(){let f=[];for(;;){let I=this.getCurrentRecord();if(I.type!==u.PHONE)break;f.push(I.value),this.currentLine++;}return f}parseConnection(){let f=this.getCurrentRecord();if(f.type===u.CONNECTION){let I=this.extractOneOrMore(f,m);this.consumeSpaceForRecord(f);let y=this.extractOneOrMore(f,m);this.consumeSpaceForRecord(f);let B=this.extract(f,this.consumeAddress);return this.currentLine++,{nettype:I,addrtype:y,address:B}}}parseMedia(){let f=this.getCurrentRecord(),I=this.extract(f,this.consumeToken);this.consumeSpaceForRecord(f);let y=this.extract(f,this.consumePort);f.value[f.cur]==="/"&&(f.cur+=1,y+=this.extract(f,this.consumeInteger)),this.consumeSpaceForRecord(f);let B=[];for(B.push(this.extract(f,this.consumeToken));f.value[f.cur]==="/";)f.cur+=1,B.push(this.extract(f,this.consumeToken));if(B.length===0)throw new Error("Invalid proto");let pt=this.parseFmt(f);return this.currentLine++,{mediaType:I,port:y,protos:B,fmts:pt}}parseTimeFields(){let f=[];for(;this.getCurrentRecord().type===u.TIME;){let I=this.parseTime(),y=this.parseRepeat(),B=this.parseZone();f.push({time:I,repeats:y,zones:B});}return f}parseMediaDescription(){let f=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===u.MEDIA;){let I=this.parseMedia(),y=this.parseInformation(),B=this.parseConnections(),pt=this.parseBandWidth(),Yt=this.parseKey(),We=this.parseMediaAttributes(I);f.push({media:I,information:y,connections:B,bandwidths:pt,key:Yt,attributes:We});}return f}parseConnections(){let f=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===u.CONNECTION;)f.push(this.parseConnection());return f}parseFmt(f){let I=[];for(;;)try{this.consumeSpaceForRecord(f),I.push(this.extract(f,this.consumeToken));}catch{break}if(I.length===0)throw new Error("Invalid fmts");return I}extract(f,I){for(var y=arguments.length,B=new Array(y>2?y-2:0),pt=2;pt<y;pt++)B[pt-2]=arguments[pt];let Yt=I.call(this,f.value,f.cur,...B),We=f.value.slice(f.cur,Yt);return f.cur=Yt,We}extractOneOrMore(f,I){let y=this.consumeOneOrMore(f.value,f.cur,I),B=f.value.slice(f.cur,y);return f.cur=y,B}consumeSpaceForRecord(f){if(f.value[f.cur]!==l)throw new Error("Invalid space at ".concat(f.cur,"."));f.cur+=1;}}class Ft extends X{constructor(){super(...arguments),x(this,"attributes",void 0),x(this,"digested",!1);}extractOneOrMore(f,I,y){let B=this.consumeOneOrMore(f.attValue,f._cur,I),pt=f.attValue.slice(f._cur,B),[Yt,We]=y||[];if(typeof Yt=="number"&&pt.length<Yt)throw new Error("error in length, should be more or equal than ".concat(Yt," characters."));if(typeof We=="number"&&pt.length>We)throw new Error("error in length, should be less or equal than ".concat(We," characters."));return f._cur=B,pt}consumeAttributeSpace(f){if(f.attValue[f._cur]!==l)throw new Error("Invalid space at ".concat(f._cur,"."));f._cur+=1;}extract(f,I){if(!f.attValue)throw new Error("Nothing to extract from attValue.");for(var y=arguments.length,B=new Array(y>2?y-2:0),pt=2;pt<y;pt++)B[pt-2]=arguments[pt];let Yt=I.call(this,f.attValue,f._cur,...B),We=f.attValue.slice(f._cur,Yt);return f._cur=Yt,We}atEnd(f){if(!f.attValue)throw new Error;return f._cur>=f.attValue.length}peekChar(f){if(!f.attValue)throw new Error;return f.attValue[f._cur]}peek(f,I){if(!f.attValue)throw new Error;for(let y=0;y<I.length;y++)if(I[y]!==f.attValue[f._cur+y])return !1;return !0}parseIceUfrag(f){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(f,b,[4,256]);}parseIcePwd(f){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(f,b,[22,256]);}parseIceOptions(f){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");let I=[];for(;!this.atEnd(f);){I.push(this.extractOneOrMore(f,b));try{this.consumeAttributeSpace(f);}catch(y){if(this.atEnd(f))break;throw y}}this.attributes.iceOptions=I;}parseFingerprint(f){let I=this.extract(f,this.consumeToken);this.consumeAttributeSpace(f);let y=this.extract(f,this.consumeTill);this.attributes.fingerprints.push({hashFunction:I,fingerprint:y});}parseExtmap(f){let I=this.extractOneOrMore(f,h),y;this.peekChar(f)==="/"&&(this.extract(f,this.consume,"/"),y=this.extract(f,this.consumeToken)),this.consumeAttributeSpace(f);let B=this.extract(f,this.consumeTill,l),pt=M(M({entry:parseInt(I,10)},y&&{direction:y}),{},{extensionName:B});this.peekChar(f)===l&&(this.consumeAttributeSpace(f),pt.extensionAttributes=this.extract(f,this.consumeTill)),this.attributes.extmaps.push(pt);}parseSetup(f){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");let I=this.extract(f,this.consumeTill);if(I!=="active"&&I!=="passive"&&I!=="actpass"&&I!=="holdconn")throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=I;}}class re extends Ft{constructor(){super(...arguments),x(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]});}parse(f){if(this.digested)throw new Error("already digested");try{switch(f.attField){case"group":this.parseGroup(f);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(f);break;case"ice-pwd":this.parseIcePwd(f);break;case"ice-options":this.parseIceOptions(f);break;case"fingerprint":this.parseFingerprint(f);break;case"setup":this.parseSetup(f);break;case"tls-id":this.parseTlsId(f);break;case"identity":this.parseIdentity(f);break;case"extmap":this.parseExtmap(f);break;case"msid-semantic":this.parseMsidSemantic(f);break;default:f.ignored=!0,this.attributes.unrecognized.push(f);}}catch(I){throw console.error("parsing session attribute ".concat(f.attField,' error, "a=').concat(f.attField,":").concat(f.attValue,'"')),I}if(!f.ignored&&f.attValue&&!this.atEnd(f))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(f){let I=this.extract(f,this.consumeToken),y=[];for(;!this.atEnd(f)&&this.peekChar(f)===l;)this.consumeAttributeSpace(f),y.push(this.extract(f,this.consumeToken));this.attributes.groups.push({semantic:I,identificationTag:y});}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0;}parseTlsId(f){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(f,O);}parseIdentity(f){let I=this.extractOneOrMore(f,N),y=[];for(;!this.atEnd(f)&&this.peekChar(f)===l;){this.consumeAttributeSpace(f);let B=this.extract(f,this.consumeToken);this.extract(f,this.consume,"=");let pt=this.extractOneOrMore(f,Yt=>Yt!==l&&A(Yt));y.push({name:B,value:pt});}this.attributes.identities.push({assertionValue:I,extensions:y});}parseMsidSemantic(f){this.peekChar(f)===l&&this.consumeAttributeSpace(f);let I={semantic:this.extract(f,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(f);}catch{break}if(this.peekChar(f)==="*"){this.extract(f,this.consume,"*"),I.applyForAll=!0;break}{let y=this.extract(f,this.consumeTill,l);I.identifierList.push(y);}}this.attributes.msidSemantic=I;}}class Le extends Ft{constructor(f){super(),x(this,"attributes",void 0),f.protos.indexOf("RTP")!==-1||f.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]};}parse(f){if(this.digested)throw new Error("already digested");try{switch(f.attField){case"extmap":this.parseExtmap(f);break;case"setup":this.parseSetup(f);break;case"ice-ufrag":this.parseIceUfrag(f);break;case"ice-pwd":this.parseIcePwd(f);break;case"ice-options":this.parseIceOptions(f);break;case"candidate":this.parseCandidate(f);break;case"remote-candidate":this.parseRemoteCandidate(f);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(f);break;case"rtpmap":this.parseRtpmap(f);break;case"ptime":this.parsePtime(f);break;case"maxptime":this.parseMaxPtime(f);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(f);break;case"ssrc":this.parseSSRC(f);break;case"fmtp":this.parseFmtp(f);break;case"rtcp-fb":this.parseRtcpFb(f);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(f);break;case"mid":this.parseMid(f);break;case"msid":this.parseMsid(f);break;case"imageattr":this.parseImageAttr(f);break;case"rid":this.parseRid(f);break;case"simulcast":this.parseSimulcast(f);break;case"sctp-port":this.parseSctpPort(f);break;case"max-message-size":this.parseMaxMessageSize(f);break;case"ssrc-group":this.parseSSRCGroup(f);break;default:f.ignored=!0,this.attributes.unrecognized.push(f);}}catch(I){throw console.error("parsing media attribute ".concat(f.attField,' error, "a=').concat(f.attField,":").concat(f.attValue,'"')),I}if(!f.ignored&&f.attValue&&!this.atEnd(f))throw new Error("attribute parsing error")}parseCandidate(f){let I=this.extractOneOrMore(f,b,[1,32]);this.consumeAttributeSpace(f);let y=this.extractOneOrMore(f,h,[1,5]);this.consumeAttributeSpace(f);let B=this.extract(f,this.consumeToken);this.consumeAttributeSpace(f);let pt=this.extractOneOrMore(f,h,[1,10]);this.consumeAttributeSpace(f);let Yt=this.extract(f,this.consumeAddress);this.consumeAttributeSpace(f);let We=this.extract(f,this.consumePort);this.consumeAttributeSpace(f),this.extract(f,this.consume,"typ"),this.consumeAttributeSpace(f);let qn={foundation:I,componentId:y,transport:B,priority:pt,connectionAddress:Yt,port:We,type:this.extract(f,this.consumeToken),extension:{}};for(this.peek(f," raddr")&&(this.extract(f,this.consume," raddr"),this.consumeAttributeSpace(f),qn.relAddr=this.extract(f,this.consumeAddress)),this.peek(f," rport")&&(this.extract(f,this.consume," rport"),this.consumeAttributeSpace(f),qn.relPort=this.extract(f,this.consumePort));this.peekChar(f)===l;){this.consumeAttributeSpace(f);let lo=this.extract(f,this.consumeToken);this.consumeAttributeSpace(f),qn.extension[lo]=this.extractOneOrMore(f,p);}this.attributes.candidates.push(qn);}parseRemoteCandidate(f){let I=[];for(;;){let y=this.extractOneOrMore(f,h,[1,5]);this.consumeAttributeSpace(f);let B=this.extract(f,this.consumeAddress);this.consumeAttributeSpace(f);let pt=this.extract(f,this.consumePort);I.push({componentId:y,connectionAddress:B,port:pt});try{this.consumeAttributeSpace(f);}catch{break}}this.attributes.remoteCandidatesList.push(I);}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0;}parseRtpmap(f){let I=this.extract(f,this.consumeToken);this.consumeAttributeSpace(f);let y=this.extract(f,this.consumeTill,"/");this.extract(f,this.consume,"/");let B={encodingName:y,clockRate:this.extractOneOrMore(f,h)};this.atEnd(f)||this.peekChar(f)!=="/"||(this.extract(f,this.consume,"/"),B.encodingParameters=parseInt(this.extract(f,this.consumeTill),10));let pt=this.attributes.payloads.find(Yt=>Yt.payloadType===parseInt(I,10));pt?pt.rtpMap=B:this.attributes.payloads.push({payloadType:parseInt(I,10),rtpMap:B,rtcpFeedbacks:[]});}parsePtime(f){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(f,this.consumeTill);}parseMaxPtime(f){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(f,this.consumeTill);}parseDirection(f){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=f.attField;}parseSSRC(f){let I=this.extractOneOrMore(f,h);this.consumeAttributeSpace(f);let y=this.extract(f,this.consumeTill,":"),B;this.peekChar(f)===":"&&(this.extract(f,this.consume,":"),B=this.extract(f,this.consumeTill));let pt=this.attributes.ssrcs.find(Yt=>Yt.ssrcId===parseInt(I,10));pt?pt.attributes[y]=B:this.attributes.ssrcs.push({ssrcId:parseInt(I,10),attributes:{[y]:B}});}parseFmtp(f){let I=this.extract(f,this.consumeTill,l);this.consumeAttributeSpace(f);let y=this.extract(f,this.consumeTill),B={};y.split(";").forEach(Yt=>{let[We,qn]=Yt.split("=");We=vn(We).call(We);let lo=typeof qn=="string"?vn(qn).call(qn):null;typeof We=="string"&&We.length>0&&(B[We]=lo);});let pt=this.attributes.payloads.find(Yt=>Yt.payloadType===parseInt(I,10));pt?pt.fmtp={parameters:B}:this.attributes.payloads.push({payloadType:parseInt(I,10),rtcpFeedbacks:[],fmtp:{parameters:B}});}parseFmtParameters(f){let I={},y=this.extract(f,this.consumeTill,"=");f._cur++;let B=this.extract(f,this.consumeTill,";");for(I[y]=B;f.attValue[f._cur]===";";){let pt=this.extract(f,this.consumeTill,"=");f._cur++;let Yt=this.extract(f,this.consumeTill,";");I[pt]=Yt;}return I}parseRtcpFb(f){let I="";I=this.peekChar(f)==="*"?this.extract(f,this.consume,"*"):this.extract(f,this.consumeTill,l),this.consumeAttributeSpace(f);let y=this.extract(f,this.consumeTill,l),B;if(y==="trr-int")B={type:y,interval:this.extract(f,this.consumeTill)};else {let pt={type:y};this.peekChar(f)===l&&(this.consumeAttributeSpace(f),pt.parameter=this.extract(f,this.consumeToken),this.peekChar(f)===l&&(pt.additional=this.extract(f,this.consumeTill))),B=pt;}if(I==="*")this.attributes.rtcpFeedbackWildcards.push(B);else {let pt=this.attributes.payloads.find(Yt=>Yt.payloadType===parseInt(I,10));pt?pt.rtcpFeedbacks.push(B):this.attributes.payloads.push({payloadType:parseInt(I,10),rtcpFeedbacks:[B]});}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0;}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0;}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0;}parseRTCP(f){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");let I={port:this.extract(f,this.consumePort)};this.peekChar(f)===l&&(this.consumeAttributeSpace(f),I.netType=this.extractOneOrMore(f,m),this.consumeAttributeSpace(f),I.addressType=this.extractOneOrMore(f,m),this.consumeAttributeSpace(f),I.address=this.extract(f,this.consumeAddress)),this.attributes.rtcp=I;}parseMsid(f){let I={id:this.extractOneOrMore(f,m,[1,64])};this.peekChar(f)===l&&(this.consumeAttributeSpace(f),I.appdata=this.extractOneOrMore(f,m,[1,64])),this.attributes.msids.push(I);}parseImageAttr(f){this.attributes.imageattr.push(f.attValue);}parseRid(f){let I=this.extractOneOrMore(f,B=>S(B)||h(B)||B==="_"||B==="-");this.consumeAttributeSpace(f);let y={id:I,direction:this.extract(f,this.consumeToken),params:[]};if(this.peekChar(f)===l){if(this.consumeAttributeSpace(f),this.peek(f,"pt=")){this.extract(f,this.consume,"pt=");let B=[];for(;;){let pt=this.extract(f,this.consumeToken);B.push(pt);try{this.extract(f,this.consume,",");}catch{break}}y.payloads=B,this.peekChar(f)===l&&this.extract(f,this.consume,l);}for(;;){let B=this.extract(f,this.consumeToken);switch(B){case"depend":{let pt={type:B,rids:this.extract(f,this.consume,"=").split(",")};y.params.push(pt);break}default:{let pt={type:B};this.peekChar(f)==="="&&(this.extract(f,this.consume,"="),pt.val=this.extract(f,this.consumeTill,";")),y.params.push(pt);}}try{this.extract(f,this.consume,";");}catch{break}}}this.attributes.rids.push(y);}parseSimulcast(f){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=f.attValue,this.extract(f,this.consumeTill);}parseSctpPort(f){this.attributes.sctpPort=this.extractOneOrMore(f,h,[1,5]);}parseMaxMessageSize(f){this.attributes.maxMessageSize=this.extractOneOrMore(f,h,[1,void 0]);}digest(){return this.digested=!0,this.attributes}parseMid(f){this.attributes.mid=this.extract(f,this.consumeToken);}parseSSRCGroup(f){let I=this.extract(f,this.consumeToken),y=[];for(;;)try{this.consumeAttributeSpace(f);let B=this.extract(f,this.consumeInteger);y.push(parseInt(B,10));}catch{break}this.attributes.ssrcGroups.push({semantic:I,ssrcIds:y});}}function Ee(Y,f,I){return f in Y?Object.defineProperty(Y,f,{value:I,enumerable:!0,configurable:!0,writable:!0}):Y[f]=I,Y}class nr{constructor(){Ee(this,"eol",d);}print(f,I){let y="";return I&&(this.eol=I),y+=this.printVersion(f.version),y+=this.printOrigin(f.origin),y+=this.printSessionName(f.sessionName),y+=this.printInformation(f.information),y+=this.printUri(f.uri),y+=this.printEmail(f.emails),y+=this.printPhone(f.phones),y+=this.printConnection(f.connection),y+=this.printBandwidth(f.bandwidths),y+=this.printTimeFields(f.timeFields),y+=this.printKey(f.key),y+=this.printSessionAttributes(f.attributes),y+=this.printMediaDescription(f.mediaDescriptions),y}printVersion(f){return "v=".concat(f).concat(this.eol)}printOrigin(f){return "o=".concat(f.username," ").concat(f.sessId," ").concat(f.sessVersion," ").concat(f.nettype," ").concat(f.addrtype," ").concat(f.unicastAddress).concat(this.eol)}printSessionName(f){return f?"s=".concat(f).concat(this.eol):""}printInformation(f){return f?"i=".concat(f).concat(this.eol):""}printUri(f){return f?"u=".concat(f).concat(this.eol):""}printEmail(f){let I="";for(let y of f)I+="e=".concat(y).concat(this.eol);return I}printPhone(f){let I="";for(let y of f)I+="e=".concat(y).concat(this.eol);return I}printConnection(f){return f?"c=".concat(f.nettype," ").concat(f.addrtype," ").concat(f.address).concat(this.eol):""}printBandwidth(f){let I="";for(let y of f)I+="b=".concat(y.bwtype,":").concat(y.bandwidth).concat(this.eol);return I}printTimeFields(f){let I="";for(let y of f){I+="t=".concat(y.time.startTime," ").concat(y.time.startTime).concat(this.eol);for(let B of y.repeats)I+="r=".concat(B.repeatInterval," ").concat(B.typedTimes.join(" ")).concat(this.eol);y.zoneAdjustments&&(I+="z=",I+="z=".concat(y.zoneAdjustments.map(B=>"".concat(B.time," ").concat(B.back?"-":""," ").concat(B.typedTime)).join(" ")).concat(this.eol),I+=this.eol);}return I}printKey(f){return f?"k=".concat(f).concat(this.eol):""}printAttributes(f){let I="";for(let y of f)I+="a=".concat(y.attField).concat(y.attValue?":".concat(y.attValue):"").concat(this.eol);return I}printMediaDescription(f){let I="";for(let y of f)I+=this.printMedia(y.media),I+=this.printInformation(y.information),I+=this.printConnections(y.connections),I+=this.printBandwidth(y.bandwidths),I+=this.printKey(y.key),I+=this.printMediaAttributes(y);return I}printConnections(f){let I="";for(let y of f)I+=this.printConnection(y);return I}printMedia(f){return "m=".concat(f.mediaType," ").concat(f.port," ").concat(f.protos.join("/")," ").concat(f.fmts.join(" ")).concat(this.eol)}printSessionAttributes(f){return new G(this.eol).print(f)}printMediaAttributes(f){return new $(this.eol).print(f)}}class U{constructor(f){Ee(this,"eol",void 0),this.eol=f;}printIceUfrag(f){return f===void 0?"":"a=ice-ufrag:".concat(f).concat(this.eol)}printIcePwd(f){return f===void 0?"":"a=ice-pwd:".concat(f).concat(this.eol)}printIceOptions(f){return f===void 0?"":"a=ice-options:".concat(f.join(l)).concat(this.eol)}printFingerprints(f){return f.length>0?f.map(I=>"a=fingerprint:".concat(I.hashFunction).concat(l).concat(I.fingerprint)).join(this.eol)+this.eol:""}printExtmap(f){return f.map(I=>"a=extmap:".concat(I.entry).concat(I.direction?"/".concat(I.direction):"").concat(l).concat(I.extensionName).concat(I.extensionAttributes?"".concat(l).concat(I.extensionAttributes):"").concat(this.eol)).join("")}printSetup(f){return f===void 0?"":"a=setup:".concat(f).concat(this.eol)}printUnrecognized(f){return f.map(I=>"a=".concat(I.attField).concat(I.attValue?":".concat(I.attValue):"").concat(this.eol)).join("")}}class G extends U{print(f){let I="";return I+=this.printGroups(f.groups),I+=this.printMsidSemantic(f.msidSemantic),I+=this.printIceLite(f.iceLite),I+=this.printIceUfrag(f.iceUfrag),I+=this.printIcePwd(f.icePwd),I+=this.printIceOptions(f.iceOptions),I+=this.printFingerprints(f.fingerprints),I+=this.printSetup(f.setup),I+=this.printTlsId(f.tlsId),I+=this.printIdentity(f.identities),I+=this.printExtmap(f.extmaps),I+=this.printUnrecognized(f.unrecognized),I}printGroups(f){let I="";return f.length>0&&(I+=f.map(y=>"a=group:".concat(y.semantic).concat(y.identificationTag.map(B=>"".concat(l).concat(B)).join("")).concat(this.eol)).join("")),I}printIceLite(f){return f===void 0?"":"a=ice-lite"+this.eol}printTlsId(f){return f?"a=tls-id:".concat(f).concat(this.eol):""}printIdentity(f){return f.length===0?"":f.map(I=>"a=identity:".concat(I.assertionValue).concat(I.extensions.map(y=>"".concat(l).concat(y.name).concat(y.value?"=".concat(y.value):"")))).join(this.eol)+this.eol}printMsidSemantic(f){if(!f)return "";let I="a=msid-semantic:".concat(f.semantic);return f.applyForAll?I+="".concat(l,"*"):f.identifierList.length>0&&(I+=f.identifierList.map(y=>"".concat(l).concat(y))),I+this.eol}}class $ extends U{print(f){let I=f.attributes,y="";return y+=this.printRTCP(I.rtcp),y+=this.printIceUfrag(I.iceUfrag),y+=this.printIcePwd(I.icePwd),y+=this.printIceOptions(I.iceOptions),y+=this.printCandidates(I.candidates),y+=this.printRemoteCandidatesList(I.remoteCandidatesList),y+=this.printEndOfCandidates(I.endOfCandidates),y+=this.printFingerprints(I.fingerprints),y+=this.printSetup(I.setup),y+=this.printMid(I.mid),y+=this.printExtmap(I.extmaps),y+=this.printRTPRelated(I),y+=this.printPtime(I.ptime),y+=this.printMaxPtime(I.maxPtime),y+=this.printDirection(I.direction),y+=this.printSSRCGroups(I.ssrcGroups),y+=this.printSSRC(I.ssrcs),y+=this.printRTCPMux(I.rtcpMux),y+=this.printRTCPMuxOnly(I.rtcpMuxOnly),y+=this.printRTCPRsize(I.rtcpRsize),y+=this.printMSId(I.msids),y+=this.printImageattr(I.imageattr),y+=this.printRid(I.rids),y+=this.printSimulcast(I.simulcast),y+=this.printSCTPPort(I.sctpPort),y+=this.printMaxMessageSize(I.maxMessageSize),y+=this.printUnrecognized(I.unrecognized),y}printCandidates(f){return f.map(I=>"a=candidate:".concat(I.foundation).concat(l).concat(I.componentId).concat(l).concat(I.transport).concat(l).concat(I.priority).concat(l).concat(I.connectionAddress).concat(l).concat(I.port).concat(l,"typ").concat(l).concat(I.type).concat(I.relAddr?"".concat(l,"raddr").concat(l).concat(I.relAddr):"").concat(I.relPort?"".concat(l,"rport").concat(l).concat(I.relPort):"").concat(Object.keys(I.extension).map(y=>"".concat(l).concat(y).concat(l).concat(I.extension[y])).join("")).concat(this.eol)).join("")}printRemoteCandidatesList(f){return f.map(I=>"a=remote-candidates:".concat(I.join(l)).concat(this.eol)).join("")}printEndOfCandidates(f){return f===void 0?"":"a=end-of-candidates"+this.eol}printRTPRelated(f){if(!f.payloads)return "";let I=f.payloads,y="";y+=f.rtcpFeedbackWildcards.map(B=>this.printRTCPFeedback("*",B)).join("");for(let B of I)y+=this.printRtpMap(B.payloadType,B.rtpMap),y+=this.printFmtp(B.payloadType,B.fmtp),y+=B.rtcpFeedbacks.map(pt=>this.printRTCPFeedback(B.payloadType,pt)).join("");return y}printFmtp(f,I){if(!I)return "";let y=Object.keys(I.parameters);return y.length===1&&I.parameters[y[0]]===null?"a=fmtp:".concat(f).concat(l).concat(y[0]).concat(this.eol):"a=fmtp:".concat(f).concat(l).concat(Object.keys(I.parameters).map(B=>"".concat(B,"=").concat(I.parameters[B])).join(";")).concat(this.eol)}printRtpMap(f,I){return I?"a=rtpmap:".concat(f).concat(l).concat(I.encodingName,"/").concat(I.clockRate).concat(I.encodingParameters?"/".concat(I.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(f,I){let y="a=rtcp-fb:".concat(f).concat(l),B=I;return B.type==="trr-int"?y+="ttr-int".concat(l).concat(B.interval):(y+="".concat(B.type),B.parameter&&(y+="".concat(l).concat(B.parameter),B.additional&&(y+="".concat(l).concat(B.additional)))),y+this.eol}printPtime(f){return f===void 0?"":"a=ptime:".concat(f).concat(this.eol)}printMaxPtime(f){return f===void 0?"":"a=maxptime:".concat(f).concat(this.eol)}printDirection(f){return f===void 0?"":"a=".concat(f).concat(this.eol)}printSSRC(f){return f.map(I=>Object.keys(I.attributes).map(y=>"a=ssrc:".concat(I.ssrcId.toString(10)).concat(l).concat(y).concat(I.attributes[y]?":".concat(I.attributes[y]):"").concat(this.eol)).join("")).join("")}printRTCPMux(f){return f===void 0?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(f){return f===void 0?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(f){return f===void 0?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(f){if(f===void 0)return "";let I="a=rtcp:".concat(f.port);return f.netType&&(I+="".concat(l).concat(f.netType)),f.addressType&&(I+="".concat(l).concat(f.addressType)),f.address&&(I+="".concat(l).concat(f.address)),I+this.eol}printMSId(f){return f.map(I=>"a=msid:".concat(I.id).concat(I.appdata?"".concat(l).concat(I.appdata):"").concat(this.eol)).join("")}printImageattr(f){return f.map(I=>"a=imageattr:".concat(I).concat(this.eol)).join("")}printRid(f){return f.map(I=>{let y="a=rid:".concat(I.id).concat(l).concat(I.direction);return I.payloads&&(y+="".concat(l,"pt=").concat(I.payloads.join(","))),I.params.length>0&&(y+="".concat(l).concat(I.params.map(B=>B.type==="depend"?"depend=".concat(B.rids.join(",")):"".concat(B.type,"=").concat(B.val)).join(";"))),y+this.eol}).join("")}printSimulcast(f){return f===void 0?"":"a=simulcast:".concat(f).concat(this.eol)}printSCTPPort(f){return f===void 0?"":"a=sctp-port:".concat(f).concat(this.eol)}printMaxMessageSize(f){return f===void 0?"":"a=max-message-size:".concat(f).concat(this.eol)}printMid(f){return f===void 0?"":"a=mid:".concat(f).concat(this.eol)}printSSRCGroups(f){return f.map(I=>"a=ssrc-group:".concat(I.semantic).concat(I.ssrcIds.map(y=>"".concat(l).concat(y.toString(10))).join("")).concat(this.eol)).join("")}}function ht(Y){return new bt().parse(Y)}function Ut(Y,f){return new nr().print(Y,f)}}},i={};function r(o){if(i[o])return i[o].exports;var s=i[o]={exports:{}};return n[o](s,s.exports,r),s.exports}return r.d=(o,s)=>{for(var a in s)r.o(s,a)&&!r.o(o,a)&&Object.defineProperty(o,a,{enumerable:!0,get:s[a]});},r.o=(o,s)=>Object.prototype.hasOwnProperty.call(o,s),r.r=o=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(o,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(o,"__esModule",{value:!0});},r(8)})();})(Uw);var ue=Uw.exports;function Qi(t){if(Array.isArray(t))return t.map(n=>n);if(!xw(t))return t;let e={};for(let n in t){let i=t[n];xw(i)||Array.isArray(i)?e[n]=Qi(i):e[n]=i;}return e}function xw(t){return !(typeof t!="object"||Array.isArray(t)||!t)}class YE{constructor(e){g(this,"input",[]),g(this,"size",void 0),this.size=e;}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1);}diffMean(){return this.input.length===0?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}let Br={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},Cd={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:Br,remoteCandidate:Br}},Vw={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0,framesDroppedCount:0,outputFrameRate:0},Fw={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},Bw={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},jw={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};function Gw(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function Ww(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Gw(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Gw(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}class qE{constructor(e,n){g(this,"onFirstVideoReceived",void 0),g(this,"onFirstVideoDecoded",void 0),g(this,"onFirstAudioReceived",void 0),g(this,"onFirstVideoDecodedTimeout",void 0),g(this,"onFirstAudioDecoded",void 0),g(this,"onSelectedLocalCandidateChanged",void 0),g(this,"onSelectedRemoteCandidateChanged",void 0),g(this,"videoIsReady",!1),g(this,"videoIsReady2",{}),g(this,"pc",void 0),g(this,"options",void 0),g(this,"intervalTimer",void 0),g(this,"stats",Qi(Cd)),g(this,"isFirstVideoReceived",{}),g(this,"isFirstVideoDecoded",{}),g(this,"isFirstAudioReceived",{}),g(this,"isFirstAudioDecoded",{}),g(this,"isFirstVideoDecodedTimeout",{}),g(this,"lossRateWindowStats",[]),this.pc=e,this.options=n,this.intervalTimer=window.setInterval(async()=>{this.updateStats();},this.options.updateInterval);}getStats(){return this.stats}getSelectedCandidatePair(){return new K(e=>{e({local:Ww({},Br),remote:Ww({},Br)});})}setVideoIsReady(e){this.videoIsReady=e;}setVideoIsReady2(e,n){this.videoIsReady2[e]=n;}getVideoIsReady(e){return this.videoIsReady2[e]||!1}setIsFirstAudioDecoded(e){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0;}calcLossRate(e){this.lossRateWindowStats.push(e),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);let n=this.lossRateWindowStats.length,i=["videoSend","audioSend","videoRecv","audioRecv"],r=0,o=0,s=0,a=0;for(let c of i)e[c].forEach((d,l)=>{if(!this.lossRateWindowStats[n-1][c][l]||!this.lossRateWindowStats[0][c][l])return;let u=this.lossRateWindowStats[n-1][c][l].packets-this.lossRateWindowStats[0][c][l].packets,h=this.lossRateWindowStats[n-1][c][l].packetsLost-this.lossRateWindowStats[0][c][l].packetsLost;c==="videoSend"||c==="audioSend"?(r+=u,s+=h):(o+=u,a+=h),Number.isNaN(u)||Number.isNaN(u)?d.packetLostRate=0:d.packetLostRate=u<=0||h<=0?0:h/(u+h);});e.sendPacketLossRate=r<=0||s<=0?0:s/(r+s),e.recvPacketLossRate=o<=0||a<=0?0:a/(o+a);}}function Hw(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function K3(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Hw(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Hw(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}class Y3 extends qE{constructor(){super(...arguments),g(this,"_stats",Cd),g(this,"lastDecodeVideoReceiverStats",new Map);}async updateStats(){let e=await this._getStats(),n=this.statsResponsesToObjects(e);this._stats=Qi(Cd);let i=n.filter(o=>o.type==="ssrc");this.processSSRCStats(i);let r=n.find(o=>o.type==="VideoBwe");r&&this.processBandwidthStats(r),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats;}processBandwidthStats(e){this._stats.bitrate={actualEncoded:Number(e.googActualEncBitrate),targetEncoded:Number(e.googTargetEncBitrate),retransmit:Number(e.googRetransmitBitrate),transmit:Number(e.googTransmitBitrate)},this._stats.sendBandwidth=Number(e.googAvailableSendBandwidth);}processSSRCStats(e){e.forEach(n=>{var i;let r=q(i=n.id).call(i,"send");switch("".concat(n.mediaType,"_").concat(r?"send":"recv")){case"video_send":{let o=Qi(Fw);o.codec=n.googCodecName,o.adaptionChangeReason="none",n.googCpuLimitedResolution&&(o.adaptionChangeReason="cpu"),n.googBandwidthLimitedResolution&&(o.adaptionChangeReason="bandwidth"),o.avgEncodeMs=Number(n.googAvgEncodeMs),o.inputFrame={width:Number(n.googFrameWidthInput)||Number(n.googFrameWidthSent),height:Number(n.googFrameHeightInput)||Number(n.googFrameHeightSent),frameRate:Number(n.googFrameRateInput)},o.sentFrame={width:Number(n.googFrameWidthSent),height:Number(n.googFrameHeightSent),frameRate:Number(n.googFrameRateInput)},o.firsCount=Number(n.googFirReceived),o.nacksCount=Number(n.googNacksReceived),o.plisCount=Number(n.googPlisReceived),o.frameCount=Number(n.framesEncoded),o.bytes=Number(n.bytesSent),o.packets=Number(n.packetsSent),o.packetsLost=Number(n.packetsLost),o.ssrc=Number(n.ssrc),o.rttMs=Number(n.googRtt||0),this._stats.videoSend.push(o),this._stats.rtt=o.rttMs;break}case"video_recv":{let o=Qi(Vw),s=this.lastDecodeVideoReceiverStats.get(Number(n.ssrc));if(o.codec=n.googCodecName,o.targetDelayMs=Number(n.googTargetDelayMs),o.renderDelayMs=Number(n.googRenderDelayMs),o.currentDelayMs=Number(n.googCurrentDelayMs),o.minPlayoutDelayMs=Number(n.googMinPlayoutDelayMs),o.decodeMs=Number(n.googDecodeMs),o.maxDecodeMs=Number(n.googMaxDecodeMs),o.receivedFrame={width:Number(n.googFrameWidthReceived),height:Number(n.googFrameHeightReceived),frameRate:Number(n.googFrameRateReceived)},o.decodedFrame={width:Number(n.googFrameWidthReceived),height:Number(n.googFrameHeightReceived),frameRate:Number(n.googFrameRateDecoded)},o.decodeFrameRate=Number(n.googFrameRateDecoded),o.outputFrame={width:Number(n.googFrameWidthReceived),height:Number(n.googFrameHeightReceived),frameRate:Number(n.googFrameRateOutput)},o.jitterBufferMs=Number(n.googJitterBufferMs),o.firsCount=Number(n.googFirsSent),o.nacksCount=Number(n.googNacksSent),o.plisCount=Number(n.googPlisSent),o.framesDecodeCount=Number(n.framesDecoded),o.bytes=Number(n.bytesReceived),o.packets=Number(n.packetsReceived),o.packetsLost=Number(n.packetsLost),o.ssrc=Number(n.ssrc),o.packets>0&&!this.isFirstVideoReceived[o.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(o.ssrc),this.isFirstVideoReceived[o.ssrc]=!0),o.framesDecodeCount>0&&!this.isFirstVideoDecoded[o.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(o.ssrc,o.decodedFrame.width,o.decodedFrame.height),this.isFirstVideoDecoded[o.ssrc]=!0),s){let a=s.stats,c=Date.now()-s.lts;o.framesDecodeFreezeTime=a.framesDecodeFreezeTime,o.framesDecodeInterval=a.framesDecodeInterval,o.framesDecodeCount>a.framesDecodeCount&&this.isFirstVideoDecoded[o.ssrc]?(s.lts=Date.now(),o.framesDecodeInterval=c,o.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(n.ssrc,10))?o.framesDecodeFreezeTime+=o.framesDecodeInterval:this.setVideoIsReady2(parseInt(n.ssrc,10),!0))):o.framesDecodeCount<s.stats.framesDecodeCount&&(o.framesDecodeInterval=0);}this.lastDecodeVideoReceiverStats.set(o.ssrc,{stats:K3({},o),lts:Date.now()}),this._stats.videoRecv.push(o);break}case"audio_recv":{let o=Qi(jw);o.codec=n.googCodecName,o.outputLevel=Math.abs(Number(n.audioOutputLevel))/32767,o.decodingCNG=Number(n.googDecodingCNG),o.decodingCTN=Number(n.googDecodingCTN),o.decodingCTSG=Number(n.googDecodingCTSG),o.decodingNormal=Number(n.googDecodingNormal),o.decodingPLC=Number(n.googDecodingPLC),o.decodingPLCCNG=Number(n.googDecodingPLCCNG),o.expandRate=Number(n.googExpandRate),o.accelerateRate=Number(n.googAccelerateRate),o.preemptiveExpandRate=Number(n.googPreemptiveExpandRate),o.secondaryDecodedRate=Number(n.googSecondaryDecodedRate),o.speechExpandRate=Number(n.googSpeechExpandRate),o.preferredJitterBufferMs=Number(n.googPreferredJitterBufferMs),o.jitterBufferMs=Number(n.googJitterBufferMs),o.jitterMs=Number(n.googJitterReceived),o.bytes=Number(n.bytesReceived),o.packets=Number(n.packetsReceived),o.packetsLost=Number(n.packetsLost),o.ssrc=Number(n.ssrc),o.receivedFrames=Number(n.googDecodingCTN)||Number(n.packetsReceived),o.droppedFrames=Number(n.googDecodingPLC)+Number(n.googDecodingPLCCNG)||Number(n.packetsLost),o.receivedFrames>0&&!this.isFirstAudioReceived[o.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(o.ssrc),this.isFirstAudioReceived[o.ssrc]=!0),o.decodingNormal>0&&!this.isFirstAudioDecoded[o.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(o.ssrc),this.isFirstAudioDecoded[o.ssrc]=!0),this._stats.audioRecv.push(o);break}case"audio_send":{let o=Qi(Bw);o.codec=n.googCodecName,o.inputLevel=Math.abs(Number(n.audioInputLevel))/32767,o.aecReturnLoss=Number(n.googEchoCancellationReturnLoss||0),o.aecReturnLossEnhancement=Number(n.googEchoCancellationReturnLossEnhancement||0),o.residualEchoLikelihood=Number(n.googResidualEchoLikelihood||0),o.residualEchoLikelihoodRecentMax=Number(n.googResidualEchoLikelihoodRecentMax||0),o.bytes=Number(n.bytesSent),o.packets=Number(n.packetsSent),o.packetsLost=Number(n.packetsLost),o.ssrc=Number(n.ssrc),o.rttMs=Number(n.googRtt||0),this._stats.rtt=o.rttMs,this._stats.audioSend.push(o);break}}});}_getStats(){return new K((e,n)=>{this.pc.getStats(e,n);})}statsResponsesToObjects(e){let n=[];return e.result().forEach(i=>{let r={id:i.id,timestamp:i.timestamp.valueOf().toString(),type:i.type};i.names().forEach(o=>{r[o]=i.stat(o);}),n.push(r);}),n}}function Kw(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function Ps(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Kw(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Kw(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}class Yw extends qE{constructor(){super(...arguments),g(this,"_stats",Cd),g(this,"report",void 0),g(this,"lastDecodeVideoReceiverStats",new Map),g(this,"lastVideoFramesRecv",new Map),g(this,"lastVideoFramesSent",new Map),g(this,"lastVideoFramesDecode",new Map),g(this,"lastVideoFramesOutput",new Map),g(this,"lastVideoJBDelay",new Map),g(this,"lastAudioJBDelay",new Map),g(this,"mediaBytesSent",new Map),g(this,"mediaBytesRetransmit",new Map),g(this,"mediaBytesTargetEncode",new Map),g(this,"lastEncoderMs",new Map);}async updateStats(){this.report=await this.pc.getStats(),this._stats=Qi(Cd),this.report.forEach(e=>{switch(e.type){case si.OUTBOUND:case si.INBOUND:{let n=e.mediaType||e.kind,i=!n&&"frameWidth"in e,r=!n&&!("frameWidth"in e);e.type===si.OUTBOUND?n==="audio"||r?this.processAudioOutboundStats(e):(n==="video"||i)&&this.processVideoOutboundStats(e):e.type===si.INBOUND&&(n==="audio"||r?this.processAudioInboundStats(e):(n==="video"||i)&&this.processVideoInboundStats(e));break}case si.TRANSPORT:{let n=this.report.get(e.selectedCandidatePairId);n&&this.processCandidatePairStats(n);break}case si.CANDIDATE_PAIR:e.selected&&this.processCandidatePairStats(e);}}),this.updateSendBitrate(),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats;}async getSelectedCandidatePair(){let e=await this.pc.getStats(),n={local:Ps({},Br),remote:Ps({},Br)};return e.forEach(i=>{let r;if(i.type===si.TRANSPORT&&(r=e.get(i.selectedCandidatePairId)),i.type===si.CANDIDATE_PAIR&&i.selected&&(r=i),r){let o=(s,a)=>{s.type=a.type,s.id=a.id,a.address&&(s.address=a.address),a.candidateType&&(s.candidateType=a.candidateType),a.port&&(s.port=a.port),a.priority&&(s.priority=a.priority),a.protocol&&(s.protocol=a.protocol),a.relayProtocol&&(s.relayProtocol=a.relayProtocol);};if(r.localCandidateId){let s=e.get(r.localCandidateId);s&&o(n.local,s);}if(r.remoteCandidateId){let s=e.get(r.remoteCandidateId);s&&o(n.remote,s);}}}),n}processCandidatePairStats(e){if(this._stats.sendBandwidth=e.availableOutgoingBitrate||0,e.currentRoundTripTime&&(this._stats.rtt=1e3*e.currentRoundTripTime),this._stats.videoSend.forEach(n=>{e.currentRoundTripTime&&(n.rttMs=1e3*e.currentRoundTripTime);}),this._stats.audioSend.forEach(n=>{e.currentRoundTripTime&&(n.rttMs=1e3*e.currentRoundTripTime);}),this._stats.selectedCandidatePair.id=e.id,e.localCandidateId){let n=this.report.get(e.localCandidateId);n&&this.processCandidateStats(n);}if(e.remoteCandidateId){let n=this.report.get(e.remoteCandidateId);n&&this.processCandidateStats(n);}}processCandidateStats(e){let n;e.type===si.LOCAL_CANDIDATE&&(n=this._stats.selectedCandidatePair.localCandidate),e.type===si.REMOTE_CANDIDATE&&(n=this._stats.selectedCandidatePair.remoteCandidate),n&&(n.type=e.type,n.id=e.id,e.address&&(n.address=e.address),e.candidateType&&(n.candidateType=e.candidateType),e.port&&(n.port=e.port),e.priority&&(n.priority=e.priority),e.protocol&&(n.protocol=e.protocol),e.relayProtocol&&(n.relayProtocol=e.relayProtocol),e.type===si.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==n.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(Ps({},n),Ps({},this.stats.selectedCandidatePair.localCandidate)),e.type===si.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==n.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(Ps({},n),Ps({},this.stats.selectedCandidatePair.remoteCandidate)));}processAudioInboundStats(e){let n=this._stats.audioRecv.find(i=>i.ssrc===e.ssrc);n||(n=Qi(jw),this._stats.audioRecv.push(n)),n.ssrc=e.ssrc,n.packets=e.packetsReceived,n.packetsLost=e.packetsLost,n.bytes=e.bytesReceived,n.jitterMs=1e3*e.jitter,this.processAudioTrackReceiverStats(e,e.trackId,n),e.codecId&&(n.codec=this.getCodecFromCodecStats(e.codecId)),n.receivedFrames||(n.receivedFrames=e.packetsReceived),n.droppedFrames||(n.droppedFrames=e.packetsLost),n.receivedFrames>0&&!this.isFirstAudioReceived[n.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(n.ssrc),this.isFirstAudioReceived[n.ssrc]=!0),n.outputLevel&&n.outputLevel>0&&!this.isFirstAudioDecoded[n.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(n.ssrc),this.isFirstAudioDecoded[n.ssrc]=!0),typeof e.concealedSamples=="number"&&(n.concealedSamples=e.concealedSamples);}processVideoInboundStats(e){let n=this._stats.videoRecv.find(a=>a.ssrc===e.ssrc);n||(n=Qi(Vw),this._stats.videoRecv.push(n)),n.ssrc=e.ssrc,n.packets=e.packetsReceived,n.packetsLost=e.packetsLost,n.bytes=e.bytesReceived,n.firsCount=e.firCount,n.nacksCount=e.nackCount,n.plisCount=e.pliCount,n.framesDecodeCount=e.framesDecoded,n.framesDroppedCount=e.framesDropped,n.totalInterFrameDelay=e.totalInterFrameDelay,n.totalSquaredInterFrameDelay=e.totalSquaredInterFrameDelay,n.totalFreezesDuration=e.totalFreezesDuration;let i=this.lastDecodeVideoReceiverStats.get(n.ssrc),r=this.lastVideoFramesDecode.get(n.ssrc),o=this.lastVideoFramesOutput.get(n.ssrc),s=Date.now();if(n.framesDecodeCount>0&&!this.isFirstVideoDecoded[n.ssrc]){let a=n.decodedFrame?n.decodedFrame.width:0,c=n.decodedFrame?n.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(n.ssrc,a,c),this.isFirstVideoDecoded[n.ssrc]=!0;}if(i){let a=i.stats,c=s-i.lts;n.framesDecodeFreezeTime=a.framesDecodeFreezeTime,n.framesDecodeInterval=a.framesDecodeInterval,!this.isFirstVideoDecoded[n.ssrc]&&c>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[n.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(n.ssrc),this.isFirstVideoDecodedTimeout[n.ssrc]=!0),n.framesDecodeCount>a.framesDecodeCount&&this.isFirstVideoDecoded[n.ssrc]?(i.lts=Date.now(),n.framesDecodeInterval=c,n.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc))?n.framesDecodeFreezeTime+=n.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):n.framesDecodeCount<a.framesDecodeCount&&(n.framesDecodeInterval=0),e.framesDecoded&&e.qpSum&&(i.stats.framesDecodeCount>e.framesDecoded?n.qpSumPerFrame=e.qpSum/e.framesDecoded:n.qpSumPerFrame=(e.qpSum-i.qpSum)/(e.framesDecoded-i.stats.framesDecodeCount));}r&&s-r.lts>=800?(n.decodeFrameRate=Math.round((n.framesDecodeCount-r.count)/((s-r.lts)/1e3)),this.lastVideoFramesDecode.set(n.ssrc,{count:n.framesDecodeCount,lts:s,rate:n.decodeFrameRate})):r?n.decodeFrameRate=r.rate:this.lastVideoFramesDecode.set(n.ssrc,{count:n.framesDecodeCount,lts:s,rate:0}),n.framesDroppedCount&&e.framesReceived&&(o&&s-o.lts>=800?(n.outputFrameRate=Math.round((e.framesReceived-n.framesDroppedCount-o.count)/((s-o.lts)/1e3)),this.lastVideoFramesOutput.set(n.ssrc,{count:e.framesReceived-n.framesDroppedCount,lts:s,rate:Math.max(n.outputFrameRate,0)})):o?n.outputFrameRate=o.rate:this.lastVideoFramesOutput.set(n.ssrc,{count:e.framesReceived-n.framesDroppedCount,lts:s,rate:0})),e.totalDecodeTime&&(n.decodeMs=1e3*e.totalDecodeTime),this.processVideoTrackReceiverStats(e,e.trackId,n),e.codecId&&(n.codec=this.getCodecFromCodecStats(e.codecId)),e.framerateMean&&(n.framesRateFirefox=e.framerateMean),n.packets>0&&!this.isFirstVideoReceived[n.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(n.ssrc),this.isFirstVideoReceived[n.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(n.ssrc,{stats:Ps({},n),lts:i?i.lts:Date.now(),qpSum:e.qpSum});}processVideoOutboundStats(e){let n=this._stats.videoSend.find(r=>r.ssrc===e.ssrc);n||(n=Qi(Fw),this._stats.videoSend.push(n));let i=this.mediaBytesSent.get(e.ssrc);if(i)i.add(e.bytesSent);else {let r=new YE(10);r.add(e.bytesSent),this.mediaBytesSent.set(e.ssrc,r);}if(e.retransmittedBytesSent!==void 0){let r=this.mediaBytesRetransmit.get(e.ssrc);if(r)r.add(e.retransmittedBytesSent);else {let o=new YE(10);o.add(e.retransmittedBytesSent),this.mediaBytesRetransmit.set(e.ssrc,o);}}if(e.totalEncodedBytesTarget){let r=this.mediaBytesTargetEncode.get(e.ssrc);if(r)r.add(e.totalEncodedBytesTarget);else {let o=new YE(10);o.add(e.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(e.ssrc,o);}}if(n.ssrc=e.ssrc,n.bytes=e.bytesSent,n.packets=e.packetsSent,n.firsCount=e.firCount,n.nacksCount=e.nackCount,n.plisCount=e.pliCount,n.frameCount=e.framesEncoded,n.adaptionChangeReason=e.qualityLimitationReason,n.scalabilityMode=e.scalabilityMode,e.totalEncodeTime&&e.framesEncoded){let r=this.lastEncoderMs.get(e.ssrc);if(!r||r.lastFrameCount>e.framesEncoded)n.avgEncodeMs=1e3*e.totalEncodeTime/e.framesEncoded;else {let o=e.framesEncoded-r.lastFrameCount,s=e.totalEncodeTime-r.lastEncoderTime;n.avgEncodeMs=1e3*s/o;}}if(e.framesEncoded&&e.qpSum){let r=this.lastEncoderMs.get(e.ssrc);!r||r.lastFrameCount>e.framesEncoded?n.qpSumPerFrame=e.qpSum/e.framesEncoded:n.qpSumPerFrame=(e.qpSum-r.lastQpSum)/(e.framesEncoded-r.lastFrameCount);}if(this.lastEncoderMs.set(e.ssrc,{lastFrameCount:e.framesEncoded,lastEncoderTime:e.totalEncodeTime,lastQpSum:e.qpSum,lts:Date.now()}),e.codecId&&(n.codec=this.getCodecFromCodecStats(e.codecId)),e.mediaSourceId&&this.processVideoMediaSource(e.mediaSourceId,n),this.processVideoTrackSenderStats(e,e.trackId,n),e.remoteId)this.processRemoteInboundStats(e.remoteId,n);else {let r=this.findRemoteStatsId(e.ssrc,si.REMOTE_INBOUND);r&&this.processRemoteInboundStats(r,n);}}processAudioOutboundStats(e){let n=this._stats.audioSend.find(i=>i.ssrc===e.ssrc);if(n||(n=Qi(Bw),this._stats.audioSend.push(n)),n.ssrc=e.ssrc,n.packets=e.packetsSent,n.bytes=e.bytesSent,e.mediaSourceId&&this.processAudioMediaSource(e.mediaSourceId,n),e.codecId&&(n.codec=this.getCodecFromCodecStats(e.codecId)),this.processAudioTrackSenderStats(e,e.trackId,n),e.remoteId)this.processRemoteInboundStats(e.remoteId,n);else {let i=this.findRemoteStatsId(e.ssrc,si.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,n);}}findRemoteStatsId(e,n){var i;let r=Array.from(cr(i=this.report).call(i)).find(o=>o.type===n&&o.ssrc===e);return r?r.id:null}processVideoMediaSource(e,n){let i=this.report.get(e);i&&i.width&&i.height&&i.framesPerSecond&&(n.inputFrame={width:i.width,height:i.height,frameRate:i.framesPerSecond});}processAudioMediaSource(e,n){let i=this.report.get(e);i&&(n.inputLevel=i.audioLevel);}processVideoTrackSenderStats(e,n,i){var r,o,s,a;let c=n?this.report.get(n):void 0,d=(r=c?.framesSent)!==null&&r!==void 0?r:e.framesSent;if(typeof d!="number")return;let l=(o=c?.frameWidth)!==null&&o!==void 0?o:e.frameWidth,u=(s=c?.frameHeight)!==null&&s!==void 0?s:e.frameHeight,h=(a=c?.framesPerSecond)!==null&&a!==void 0?a:e.framesPerSecond;if(typeof l=="number"&&typeof u=="number"||(l=0,u=0),h==null){let p=Date.now(),T=this.lastVideoFramesSent.get(i.ssrc);T&&p-T.lts>=800?(h=Math.round((d-T.count)/((p-T.lts)/1e3)),this.lastVideoFramesSent.set(i.ssrc,{count:d,lts:p,rate:h})):T?h=T.rate:this.lastVideoFramesSent.set(i.ssrc,{count:d,lts:p,rate:0});}i.sentFrame={width:l,height:u,frameRate:Math.max(0,h)};}processVideoTrackReceiverStats(e,n,i){var r,o,s,a,c;let d=n?this.report.get(n):void 0,l=(r=d?.framesReceived)!==null&&r!==void 0?r:e.framesReceived,u=(o=d?.frameWidth)!==null&&o!==void 0?o:e.frameWidth,h=(s=d?.frameHeight)!==null&&s!==void 0?s:e.frameHeight,p=(a=d?.jitterBufferDelay)!==null&&a!==void 0?a:e.jitterBufferDelay,T=(c=d?.jitterBufferEmittedCount)!==null&&c!==void 0?c:e.jitterBufferEmittedCount;if(typeof l=="number"){let m=this.lastVideoFramesRecv.get(i.ssrc),E=Date.now();i.framesReceivedCount=l;let S=0;m&&E-m.lts>=800?(S=Math.round((l-m.count)/((E-m.lts)/1e3)),this.lastVideoFramesRecv.set(i.ssrc,{count:l,lts:E,rate:S})):m?S=m.rate:this.lastVideoFramesRecv.set(i.ssrc,{count:l,lts:E,rate:0}),i.receivedFrame={width:u||0,height:h||0,frameRate:S||0},i.decodedFrame={width:u||0,height:h||0,frameRate:i.decodeFrameRate||0},i.outputFrame={width:u||0,height:h||0,frameRate:i.outputFrameRate||i.decodeFrameRate||0};}if(p&&T){let m=this.lastVideoJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0},E=m.jitterBufferMs,S=T-m.jitterBufferEmittedCount;S>0&&(E=1e3*(p-m.jitterBufferDelay)/S),i.jitterBufferMs=E,i.currentDelayMs=Math.round(E),this.lastVideoJBDelay.set(i.ssrc,{jitterBufferDelay:p,jitterBufferEmittedCount:T,jitterBufferMs:i.currentDelayMs});}}processAudioTrackSenderStats(e,n,i){var r,o,s,a;let c=n?this.report.get(n):void 0,d=(r=(o=c?.echoReturnLoss)!==null&&o!==void 0?o:e.echoReturnLoss)!==null&&r!==void 0?r:0,l=(s=(a=c?.echoReturnLossEnhancement)!==null&&a!==void 0?a:e.echoReturnLossEnhancement)!==null&&s!==void 0?s:0;i.aecReturnLoss=d,i.aecReturnLossEnhancement=l;}processAudioTrackReceiverStats(e,n,i){var r,o,s,a,c,d,l;let u=n?this.report.get(n):void 0,h=(r=u?.removedSamplesForAcceleration)!==null&&r!==void 0?r:e.removedSamplesForAcceleration,p=(o=u?.totalSamplesReceived)!==null&&o!==void 0?o:e.totalSamplesReceived,T=(s=u?.jitterBufferDelay)!==null&&s!==void 0?s:e.jitterBufferDelay,m=(a=u?.jitterBufferEmittedCount)!==null&&a!==void 0?a:e.jitterBufferEmittedCount,E=(c=u?.audioLevel)!==null&&c!==void 0?c:e?.audioLevel,S=(d=u?.totalSamplesDuration)!==null&&d!==void 0?d:e?.totalSamplesDuration,C=(l=u?.concealedSamples)!==null&&l!==void 0?l:e.concealedSamples;if(h&&p&&(i.accelerateRate=h/p),T&&m){let b=this.lastAudioJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0},O=b.jitterBufferMs,N=m-b.jitterBufferEmittedCount;N>0&&(O=1e3*(T-b.jitterBufferDelay)/N),i.jitterBufferMs=Math.round(O),this.lastAudioJBDelay.set(i.ssrc,{jitterBufferDelay:T,jitterBufferEmittedCount:m,jitterBufferMs:i.jitterBufferMs});}i.outputLevel=E;let A=1920;S&&p&&(A=p/S/50,i.receivedFrames=Math.round(p/A)),C&&(i.droppedFrames=Math.round(C/A));}processRemoteInboundStats(e,n){let i=this.report.get(e);i&&(n.packetsLost=i.packetsLost,i.roundTripTime&&(n.rttMs=1e3*i.roundTripTime),i.jitter&&(n.jitterMs=1e3*i.jitter),i.timestamp&&(n.timestamp=i.timestamp));}getCodecFromCodecStats(e){let n=this.report.get(e);if(!n)return "";let i=n.mimeType.match(/\/(.*)$/);return i&&i[1]?i[1]:""}updateSendBitrate(){let e=0,n=null,i=null;this.mediaBytesSent.forEach(o=>{e+=o.diffMean();}),this.mediaBytesRetransmit.forEach(o=>{n=n===null?o.diffMean():n+o.diffMean();}),this.mediaBytesTargetEncode.forEach(o=>{i=i===null?o.diffMean():i+o.diffMean();});let r=n!==null?e-n:e;this._stats.bitrate={actualEncoded:8*r/(this.options.updateInterval/1e3),transmit:8*e/(this.options.updateInterval/1e3)},n!==null&&(this._stats.bitrate.retransmit=8*n/(this.options.updateInterval/1e3)),i!==null&&(this._stats.bitrate.targetEncoded=8*i/(this.options.updateInterval/1e3));}}class q3 extends qE{updateStats(){return K.resolve()}}function Wu(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:250,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:8,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1e4,o=function(){let s=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return s&&s[0]?Number(s[0].split("/")[1]):null}();return o?o<76?new Y3(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):new Yw(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):function(s){return !!window.RTCStatsReport&&s.getStats()instanceof K}(t)?new Yw(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):new q3(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r})}function qw(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function zw(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?qw(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):qw(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}function vd(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=arguments.length>3?arguments[3]:void 0,{filterRTX:r,filterVideoFec:o,filterAudioFec:s,filterAudioCodec:a,filterVideoCodec:c}=e,{useXR:d}=n,l=[],u=[],h=[],p=[],T=!1,m=!1;if(ue.parse(t).mediaDescriptions.forEach(S=>{i&&i!==S.attributes.direction||(S.media.mediaType!=="video"||T||(u=S.attributes.payloads,p=S.attributes.extmaps,T=!0),S.media.mediaType!=="audio"||m||(l=S.attributes.payloads,h=S.attributes.extmaps,m=!0));}),!p||u.length===0)throw new Error("Cannot get video capabilities from SDP.");if(!h||l.length===0)throw new Error("Cannot get audio capabilities from SDP.");if(u.forEach(S=>{var C;(C=S.rtpMap)!==null&&C!==void 0&&C.clockRate&&(S.rtpMap.clockRate=parseInt(S.rtpMap.clockRate)),d&&S.rtcpFeedbacks.push({type:"rrtr"});}),l.forEach(S=>{var C;(C=S.rtpMap)!==null&&C!==void 0&&C.clockRate&&(S.rtpMap.clockRate=parseInt(S.rtpMap.clockRate)),d&&S.rtcpFeedbacks.push({type:"rrtr"});}),r&&(l=l.filter(S=>{var C;return ((C=S.rtpMap)===null||C===void 0?void 0:C.encodingName.toLowerCase())!=="rtx"}),u=u.filter(S=>{var C;return ((C=S.rtpMap)===null||C===void 0?void 0:C.encodingName.toLowerCase())!=="rtx"})),o&&(u=u.filter(S=>{var C;return !/(red)|(ulpfec)|(flexfec)/i.test(((C=S.rtpMap)===null||C===void 0?void 0:C.encodingName)||"")})),s&&(l=l.filter(S=>{var C;return !/(red)|(ulpfec)|(flexfec)/i.test(((C=S.rtpMap)===null||C===void 0?void 0:C.encodingName)||"")})),a&&a?.length>0&&(l=l.filter(S=>{var C;return q(a).call(a,((C=S.rtpMap)===null||C===void 0?void 0:C.encodingName.toLowerCase())||"")})),c&&c?.length>0){let S=u.filter(C=>{var A;return q(c).call(c,((A=C.rtpMap)===null||A===void 0?void 0:A.encodingName.toLowerCase())||"")});u=S.concat(r?[]:ZE(S,u));}let E=v("UNSUPPORTED_VIDEO_CODEC");return E&&E.length>0&&(u=u.filter(S=>!(S.rtpMap&&q(E).call(E,S.rtpMap.encodingName.toLowerCase())))),{audioCodecs:l,videoCodecs:u,audioExtensions:h,videoExtensions:p}}function _r(t){let e=ue.parse(t),n,i;for(let r of e.mediaDescriptions){if(!n){let o=r.attributes.iceUfrag,s=r.attributes.icePwd;if(!o||!s)throw new Error("Cannot get iceUfrag or icePwd from SDP.");n={iceUfrag:o,icePwd:s};}if(!i){let o=r.attributes.fingerprints;o.length>0&&(i={fingerprints:o});}}if(!i&&e.attributes.fingerprints.length>0&&(i={fingerprints:e.attributes.fingerprints}),!i||!n)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return {iceParameters:n,dtlsParameters:i}}function zE(t,e){let n=[],i=t.attributes.ssrcGroups.filter(s=>s.semantic==="FID"),r=t.attributes.ssrcGroups.find(s=>s.semantic==="SIM"),o=t.attributes.ssrcs;if(r)r.ssrcIds.forEach(s=>{var a;let c=(a=i.find(d=>d.ssrcIds[0]===s))===null||a===void 0?void 0:a.ssrcIds[1];n.push({ssrcId:s,rtx:e?c:void 0});});else if(i.length>0){let s=i[0].ssrcIds[0],a=i[0].ssrcIds[1];n.push({ssrcId:s,rtx:e?a:void 0});}else {if(o.length===0)throw new Error("No ssrcs found on local media description.");n.push({ssrcId:o[0].ssrcId});}return n}function Jw(t,e){let{cname:n}=t,i;e&&e.ip&&typeof e.port=="number"?(i=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip,port:e.port.toString(),type:"host",extension:{}}],_.debug("Using remote candidate from AP ".concat(e.ip,":").concat(e.port)),e.ip6&&(i.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip6,port:e.port.toString(),type:"host",extension:{}}),_.debug("Using IPV6 remote candidate from AP ".concat(e.ip6,":").concat(e.port)))):i=t.iceParameters.candidates.map(a=>({foundation:a.foundation,componentId:"1",transport:a.protocol,priority:a.priority.toString(),connectionAddress:a.ip,port:a.port.toString(),type:a.type,extension:{}}));let r={fingerprints:t.dtlsParameters.fingerprints.map(a=>({hashFunction:a.algorithm,fingerprint:a.fingerprint}))},o={iceUfrag:t.iceParameters.iceUfrag,icePwd:t.iceParameters.icePwd},s;switch(t.dtlsParameters.role){case"server":s="passive";break;case"client":s="active";break;case"auto":s="actpass";}return {dtlsParameters:r,iceParameters:o,candidates:i,rtpCapabilities:za(t.rtpCapabilities),setup:s,cname:n}}function mi(t,e,n){let i=[],r=[];return t.forEach(o=>{let{ssrcId:s,rtx:a}=o,c=Zt(8,"track-"),d={ssrcId:s,attributes:zw({label:c,mslabel:n=n||Zt(10,""),msid:"".concat(n," ").concat(c)},e&&{cname:e})};if(i.push(d),a!==void 0){let l={ssrcId:a,attributes:zw({label:c,mslabel:n,msid:"".concat(n," ").concat(c)},e&&{cname:e})};i.push(l),r.push({semantic:"FID",ssrcIds:[s,a]});}}),t.length>1&&r.push({semantic:"SIM",ssrcIds:t.map(o=>{let{ssrcId:s}=o;return s})}),{ssrcs:i,ssrcGroups:r}}function Fo(t,e){e instanceof Re&&t.attributes.payloads.forEach(n=>{var i;let r=(i=n.rtpMap)===null||i===void 0?void 0:i.encodingName.toLowerCase();if(!r||["opus","pcmu","pcma","g722"].indexOf(r)===-1)return;n.fmtp||(n.fmtp={parameters:{}}),n.fmtp.parameters.minptime="10",n.fmtp.parameters.useinbandfec="1";let o=e._encoderConfig;o&&r!=="pcmu"&&r!=="pcma"&&r!=="g722"&&(o.bitrate&&!Xt()&&(n.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*o.bitrate))),o.sampleRate&&(n.fmtp.parameters.maxplaybackrate="".concat(o.sampleRate),n.fmtp.parameters["sprop-maxcapturerate"]="".concat(o.sampleRate)),o.stereo&&(n.fmtp.parameters.stereo="1",n.fmtp.parameters["sprop-stereo"]="1"));});}function Hu(t){let e=t.attributes.unrecognized.findIndex(n=>n.attField==="x-google-flag"&&n.attValue==="conference");e!==-1&&t.attributes.unrecognized.splice(e,1);}function Ku(t,e){var n;if(!(e instanceof $t&&e._encoderConfig&&e._hints.indexOf(ie.SCREEN_TRACK)===-1))return;let i=e._encoderConfig;Ot().supportMinBitrate&&i.bitrateMin&&t.attributes.payloads.forEach(r=>{var o,s;q(o=["h264","h265","vp8","vp9","av1"]).call(o,((s=r.rtpMap)===null||s===void 0?void 0:s.encodingName.toLowerCase())||"")&&(r.fmtp||(r.fmtp={parameters:{}}),r.fmtp.parameters["x-google-min-bitrate"]="".concat(i.bitrateMin));}),Ot().supportMinBitrate&&!q(n=e._hints).call(n,ie.LOW_STREAM)&&i.bitrateMax&&t.attributes.payloads.forEach(r=>{var o,s;q(o=["h264","h265","vp8","vp9","av1"]).call(o,((s=r.rtpMap)===null||s===void 0?void 0:s.encodingName.toLowerCase())||"")&&(r.fmtp||(r.fmtp={parameters:{}}),r.fmtp.parameters["x-google-start-bitrate"]="".concat(v("X_GOOGLE_START_BITRATE")||Math.floor(i.bitrateMax)));});}function JE(t){if(t.media.mediaType!=="video")return;let e=Pt();if(e.name!==Bt.SAFARI&&e.os!==He.IOS)return;let n=t.attributes.extmaps.findIndex(i=>/video-orientation/g.test(i.extensionName));n!==-1&&t.attributes.extmaps.splice(n,1);}function qa(t,e,n){if(!e)return;let i,r;if(t.media.mediaType==="video"?(i=n.videoExtensions,r=n.videoCodecs):(i=n.audioExtensions,r=n.audioCodecs),e.twcc===!0){let o=i.find(s=>s.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");o&&(t.attributes.extmaps.find(a=>a.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01")||t.attributes.extmaps.push({entry:o.entry,extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"}),function(a,c){return c.filter(d=>!!a.find(l=>l.payloadType===d.payloadType&&!!l.rtcpFeedbacks.find(u=>u.type==="transport-cc")))}(r,t.attributes.payloads).forEach(a=>{a.rtcpFeedbacks.find(c=>c.type==="transport-cc")||a.rtcpFeedbacks.push({type:"transport-cc"});}));}else if(e.twcc===!1){let o=t.attributes.extmaps.findIndex(s=>s.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");o!==-1&&t.attributes.extmaps.splice(o,1),t.attributes.payloads.forEach(s=>{let a=s.rtcpFeedbacks.findIndex(c=>c.type==="transport-cc");a!==-1&&s.rtcpFeedbacks.splice(a,1);});}if(e.remb===!0){let o=i.find(s=>s.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time");o&&(t.attributes.extmaps.find(a=>a.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time")||t.attributes.extmaps.push({entry:o.entry,extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}),function(a,c){return c.filter(d=>!!a.find(l=>l.payloadType===d.payloadType&&!!l.rtcpFeedbacks.find(u=>u.type==="goog-remb")))}(r,t.attributes.payloads).forEach(a=>{a.rtcpFeedbacks.find(c=>c.type==="goog-remb")||a.rtcpFeedbacks.push({type:"goog-remb"});}));}else if(e.remb===!1){let o=t.attributes.extmaps.findIndex(s=>s.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time");o!==-1&&t.attributes.extmaps.splice(o,1),t.attributes.payloads.forEach(s=>{let a=s.rtcpFeedbacks.findIndex(c=>c.type==="goog-remb");a!==-1&&s.rtcpFeedbacks.splice(a,1);});}}function XE(t,e,n){if(Xt()||t.media.mediaType!=="video"||!(e instanceof $t)||n!=="vp9"&&n!=="vp8"||n==="vp8"&&!v("SIMULCAST")||e._scalabilityMode===void 0||e._scalabilityMode.numSpatialLayers<=1)return;let i=n==="vp8"?2:e._scalabilityMode.numSpatialLayers,r=t.attributes.ssrcs[0],o=t.attributes.ssrcGroups.find(a=>a.semantic==="FID"&&a.ssrcIds[0]===r.ssrcId),s={semantic:"SIM",ssrcIds:[r.ssrcId]};for(let a=1;a<i;a++)t.attributes.ssrcs.push({ssrcId:r.ssrcId+a,attributes:ne(r.attributes)}),s.ssrcIds.push(r.ssrcId+a),o&&(t.attributes.ssrcs.push({ssrcId:o.ssrcIds[1]+a,attributes:ne(r.attributes)}),t.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[r.ssrcId+a,o.ssrcIds[1]+a]}));t.attributes.ssrcGroups.unshift(s);}async function QE(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=new RTCPeerConnection;n.addTransceiver("video",{direction:"sendonly"}),n.addTransceiver("audio",{direction:"sendonly"}),n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"});let i=(await n.createOffer()).sdp,{send:r,recv:o,sendrecv:s}=function(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},c=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},d=arguments.length>2?arguments[2]:void 0,l=vd(d,a,c,"sendonly"),u=vd(d,a,c,"recvonly"),h={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},T={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Zi(l,u,"videoExtensions",h,p,T),Zi(l,u,"videoCodecs",h,p,T),Zi(l,u,"audioExtensions",h,p,T),Zi(l,u,"audioCodecs",h,p,T),v("RAISE_H264_BASELINE_PRIORITY")){let m=T.videoCodecs.findIndex(E=>{var S,C;return ((S=E.rtpMap)===null||S===void 0?void 0:S.encodingName.toLocaleLowerCase())==="h264"&&((C=E.fmtp)===null||C===void 0?void 0:C.parameters["profile-level-id"])==="42001f"});if(m!==-1){let E=T.videoCodecs.findIndex(S=>{var C;return ((C=S.rtpMap)===null||C===void 0?void 0:C.encodingName.toLocaleLowerCase())==="h264"});if(E<m){_.debug("raising H264 baseline profile priority");let S=T.videoCodecs[m];T.videoCodecs.splice(m,1),T.videoCodecs.splice(E,0,S);}E!==-1&&(p.videoCodecs=p.videoCodecs.filter(S=>{var C,A;return !(((C=S.rtpMap)===null||C===void 0?void 0:C.encodingName.toLocaleLowerCase())==="h264"&&((A=S.fmtp)===null||A===void 0?void 0:A.parameters["profile-level-id"])!=="42001f")})),E!==-1&&v("FILTER_SEND_H264_BASELINE")&&(h.videoCodecs=h.videoCodecs.filter(S=>{var C,A;return !(((C=S.rtpMap)===null||C===void 0?void 0:C.encodingName.toLocaleLowerCase())==="h264"&&((A=S.fmtp)===null||A===void 0?void 0:A.parameters["profile-level-id"])!=="42001f")}));}}return {send:h,recv:p,sendrecv:T}}(t,e,i);try{n.close();}catch{}return {send:r,recv:o,sendrecv:s}}function Xw(){let t={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},e=vd(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"recvonly"),n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Zi(t,e,"videoExtensions",n,i,r),Zi(t,e,"videoCodecs",n,i,r),Zi(t,e,"audioExtensions",n,i,r),Zi(t,e,"audioCodecs",n,i,r),v("RAISE_H264_BASELINE_PRIORITY")){let o=r.videoCodecs.findIndex(s=>s.rtpMap&&s.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&s.fmtp&&s.fmtp.parameters["profile-level-id"]==="42001f");if(o!==-1){let s=r.videoCodecs.findIndex(a=>a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(s<o){_.debug("raising H264 baseline profile priority");let a=r.videoCodecs[o];r.videoCodecs.splice(o,1),r.videoCodecs.splice(s,0,a);}s!==-1&&(i.videoCodecs=i.videoCodecs.filter(a=>!(a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&a.fmtp&&a.fmtp.parameters["profile-level-id"]!=="42001f")));}}return {send:n,recv:i,sendrecv:r}}function Zi(t,e,n,i,r,o){if(n==="videoExtensions"||n==="audioExtensions"){let s=[];return t[n].forEach(a=>{e[n].some((c,d)=>{if(a.entry===c.entry&&a.extensionName===c.extensionName)return s.push(d),!0})?o[n].push(a):i[n].push(a);}),void e[n].forEach((a,c)=>{s.indexOf(c)===-1&&r[n].push(a);})}if(n==="videoCodecs"||n==="audioCodecs"){let s=[];return t[n].forEach(a=>{e[n].some((c,d)=>{if(a.payloadType===c.payloadType&&JSON.stringify(a)===JSON.stringify(c))return s.push(d),!0})?o[n].push(a):i[n].push(a);}),void e[n].forEach((a,c)=>{s.indexOf(c)===-1&&r[n].push(a);})}}function za(t){let{send:e,recv:n,sendrecv:i}=t;if(!i){if(!e||!n)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return {send:e,recv:n}}let r,o;return e?(r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r.audioCodecs=[...e.audioCodecs,...i.audioCodecs],r.videoCodecs=[...e.videoCodecs,...i.videoCodecs],r.audioExtensions=[...e.audioExtensions,...i.audioExtensions],r.videoExtensions=[...e.videoExtensions,...i.videoExtensions]):r=i,n?(o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o.audioCodecs=[...n.audioCodecs,...i.audioCodecs],o.videoCodecs=[...n.videoCodecs,...i.videoCodecs],o.audioExtensions=[...n.audioExtensions,...i.audioExtensions],o.videoExtensions=[...n.videoExtensions,...i.videoExtensions]):o=i,{send:r,recv:o}}function mr(t){t.media.mediaType==="audio"&&t.attributes.payloads.filter(e=>{var n;return ((n=e.rtpMap)===null||n===void 0?void 0:n.encodingName.toLowerCase())==="opus"}).forEach(e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1";});}function Yu(t){t.mediaDescriptions.forEach(e=>{e.media.mediaType!=="video"&&e.media.mediaType!=="audio"||e.attributes.payloads.forEach(n=>{n.rtcpFeedbacks.findIndex(i=>i.type==="rrtr")===-1&&n.rtcpFeedbacks.push({type:"rrtr"});});});}function Ls(t,e,n,i){let r=[];if(t===tt.VIDEO){if(v("H264_PROFILE_LEVEL_ID")&&i==="h264"&&(r=e.videoCodecs.filter(o=>{var s;return q(s=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(s,i)&&o&&o.fmtp&&o.fmtp.parameters["profile-level-id"]===v("H264_PROFILE_LEVEL_ID")})),!Array.isArray(r)||r.length===0){let o=[],s=[],a=[],c=[];if(n.videoCodecs.forEach(d=>{let l=d.rtpMap&&d.rtpMap.encodingName.toLowerCase()||"";q(l).call(l,i)?o.push(d):q(l).call(l,"vp9")?s.push(d):q(l).call(l,"vp8")?a.push(d):q(l).call(l,"h264")&&c.push(d);}),o.length===0){let d="";s.length!==0?(o=s,d="vp9"):a.length!==0?(o=a,d="vp8"):c.length!==0&&(o=c,d="h264"),_.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: ").concat(d));}o.length!==0&&(r=e.videoCodecs.filter(d=>o.some(l=>l.payloadType===d.payloadType)));}if(r.length===0&&(_.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: ").concat(e.videoCodecs[0].rtpMap&&e.videoCodecs[0].rtpMap.encodingName)),r=e.videoCodecs),v("USE_PUB_RTX")||v("USE_SUB_RTX")){let o=ZE(r,e.videoCodecs);r=[...r,...o];}}else r=e.audioCodecs.filter(o=>{var s;return q(s=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(s,i)}),r.length===0&&(_.warning("codec ".concat(i," not included in rtpCapabilities, fallback to opus")),r=e.audioCodecs.filter(o=>{var s;return q(s=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(s,"opus")}));return r}function ZE(t,e){let n=t.map(i=>i.payloadType.toString());return e.filter(i=>i.rtpMap&&i.rtpMap.encodingName==="rtx"&&i.fmtp&&i.fmtp.parameters.apt&&q(n).call(n,i.fmtp&&i.fmtp.parameters.apt))}let Qw=class{get localCapabilities(){return ne(this._localCapabilities)}get rtpCapabilities(){return ne(this._rtpCapabilities)}get candidates(){return ne(this._candidates)}get iceParameters(){return ne(this._iceParameters)}get dtlsParameters(){return ne(this._dtlsParameters)}constructor(t){g(this,"sessionDesc",void 0),g(this,"_localCapabilities",void 0),g(this,"_rtpCapabilities",void 0),g(this,"_candidates",void 0),g(this,"_iceParameters",void 0),g(this,"_dtlsParameters",void 0),g(this,"setup",void 0),g(this,"currentMidIndex",void 0),g(this,"cname","o/i14u9pJrxRKAsu"),g(this,"firefoxSsrcMidMap",new Map),t=ne(t);let{remoteIceParameters:e,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r,localCapabilities:o,direction:s,setup:a,videoCodec:c,audioCodec:d}=t,l;this.setup=a,l=s===Dn.RECEIVE_ONLY?ue.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`):ue.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`),this._rtpCapabilities=r,this._candidates=i,this._iceParameters=e,this._dtlsParameters=n,this._localCapabilities=o;let u=s===Dn.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,h=s===Dn.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,p=s===Dn.RECEIVE_ONLY?r.send.videoCodecs:Ls(tt.VIDEO,u,h,c),T=s===Dn.RECEIVE_ONLY?r.send.audioCodecs:Ls(tt.AUDIO,u,h,d);for(let m of l.mediaDescriptions)m.attributes.iceUfrag=e.iceUfrag,m.attributes.icePwd=e.icePwd,m.attributes.fingerprints=n.fingerprints,m.attributes.candidates=i,m.attributes.setup=this.setup,m.media.mediaType==="application"&&(m.attributes.sctpPort="5000"),m.media.mediaType==="video"&&(m.media.fmts=p.map(E=>E.payloadType.toString(10)),m.attributes.payloads=p,m.attributes.extmaps=u.videoExtensions),m.media.mediaType==="audio"&&(m.media.fmts=T.map(E=>E.payloadType.toString(10)),m.attributes.payloads=T,m.attributes.extmaps=u.audioExtensions,mr(m));this.sessionDesc=l,this.currentMidIndex=l.mediaDescriptions.length-1;}toString(){return ue.print(this.sessionDesc)}hasMid(t){return Array.isArray(t)?t.every(e=>this.hasMid(e)):this.sessionDesc.mediaDescriptions.some(e=>e.attributes.mid===t)}send(t,e,n,i,r){n=n.replace(/ /g,"-");let{ssrcs:o,ssrcGroups:s}=mi(e,this.cname,v("SYNC_GROUP")?n:void 0),a=this.findPreloadMediaDesc(o);if(a){if(Xt()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,a.attributes.mid),r&&(r.twcc||r.remb)){let c=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(a,r),{mid:a.attributes.mid,needExchangeSDP:!0}}return {mid:a.attributes.mid,needExchangeSDP:!1}}{let c=this.findAvailableMediaIndex(t,o,i),d;return c===-1?(d=this.createOrRecycleSendMedia(t,o,s,"sendonly",i,r),this.updateBundleMids()):(d=ne(this.sessionDesc.mediaDescriptions[c]),d.attributes.direction="sendonly",d.attributes.ssrcs=o,d.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(d,r)),Xt()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,d.attributes.mid),{needExchangeSDP:!0,mid:d.attributes.mid}}}stopSending(t){let e=this.sessionDesc.mediaDescriptions.filter(n=>n.attributes.mid&&t.indexOf(n.attributes.mid)!==-1);if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");e.forEach(n=>{n.attributes.ssrcs=[];}),this.updateBundleMids();}receive(t,e,n){let i=[];return t.forEach(r=>{let o=r._mediaStreamTrack.kind,s=this.findAvailableRecvMediaIndex(o),a,c=!1;s===-1?(c=!0,a=this.createOrRecycleRecvMedia(r,[],"recvonly",e,n),this.updateBundleMids()):(a=ne(this.sessionDesc.mediaDescriptions[s]),a.attributes.direction="recvonly"),i.push({mid:a.attributes.mid,needCreateTransceiver:c});}),i}stopReceiving(t){let e=this.sessionDesc.mediaDescriptions.filter(n=>t.indexOf(n.attributes.mid)!==-1);if(e.length!==t.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");e.forEach(n=>{n.media.port="0",n.attributes.direction="inactive";}),this.updateBundleMids();}addRemoteCandidate(t){let{foundation:e,protocol:n,address:i,port:r,type:o,relatedAddress:s,relatedPort:a,priority:c}=new RTCIceCandidate(t),d={foundation:e??"",componentId:"1",transport:n??"",priority:c?c+"":"",connectionAddress:i??"",port:r?r+"":"",type:o?o+"":"",relAddr:s??"",relPort:a?a+"":"",extension:{}};this.candidates.some(l=>l.priority===d.priority&&l.connectionAddress===d.connectionAddress&&l.port===d.port)||(this._candidates.push(d),this.sessionDesc.mediaDescriptions.forEach(l=>{l.attributes.candidates=this.candidates;}));}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates;}createOrRecycleRecvMedia(t,e,n,i,r){let o=t._mediaStreamTrack.kind,s=this.rtpCapabilities.recv,a=Ls(o,s,this.localCapabilities.send,o===tt.AUDIO?r:i),c=o===tt.VIDEO?s.videoExtensions:s.audioExtensions,d="".concat(++this.currentMidIndex),l={media:{mediaType:o,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(h=>h.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};l=this.mungRecvMediaDsec(l,t);let u=this.findFirstClosedMedia(o);if(u){let h=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[h]=l;}else this.sessionDesc.mediaDescriptions.push(l);return l}muteRemote(t){let e=this.sessionDesc.mediaDescriptions.filter(n=>q(t).call(t,n.attributes.mid||""));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(n=>{n.attributes.direction="inactive";});}unmuteRemote(t){let e=this.sessionDesc.mediaDescriptions.filter(n=>q(t).call(t,n.attributes.mid||""));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(n=>{n.attributes.direction="recvonly";});}findAvailableMediaIndex(t,e,n){return this.sessionDesc.mediaDescriptions.findIndex(i=>{let r=i.media.mediaType===t&&i.media.port!=="0"&&(i.attributes.direction==="sendonly"||i.attributes.direction==="sendrecv")&&i.attributes.ssrcs.length===0;if(Xt()){if(r){let o=this.firefoxSsrcMidMap.get(e[0].ssrcId);return !(o||i.attributes.mid!=="0"&&i.attributes.mid!=="1")||!(!o||o!==i.attributes.mid)}return !1}return r&&i.attributes.mid===n})}findAvailableRecvMediaIndex(t){return this.sessionDesc.mediaDescriptions.findIndex(e=>{let n=e.media.mediaType===t&&e.media.port!=="0"&&(e.attributes.direction==="recvonly"||e.attributes.direction==="sendrecv");return e.attributes.mid!=="0"&&e.attributes.mid!=="1"&&n})}predictReceivingMids(t){let e=[];for(let n=0;n<t;n++)e.push((this.currentMidIndex+n+1).toString(10));return e}restartICE(t){t=ne(t),this._iceParameters=t,this.sessionDesc.mediaDescriptions.forEach(e=>{e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd;});}createOrRecycleSendMedia(t,e,n,i,r,o){let s=this.rtpCapabilities.send,a=t===tt.VIDEO?s.videoCodecs:s.audioCodecs,c=t===tt.VIDEO?s.videoExtensions:s.audioExtensions;Xt()&&(r="".concat(++this.currentMidIndex));let d={media:{mediaType:t,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(u=>u.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:r}};d=this.mungSendMediaDesc(d,o);let l=this.findFirstClosedMedia(t);if(l){let u=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[u]=d;}else this.sessionDesc.mediaDescriptions.push(d);return d}mungRecvMediaDsec(t,e,n){let i=ne(t);return Hu(i),Fo(i,e),Ku(i,e),JE(i),qa(i,n,this.localCapabilities.send),i}mungSendMediaDesc(t,e){let n=ne(t);return qa(n,e,this.localCapabilities.recv),mr(n),n}updateRecvMedia(t,e){let n=this.sessionDesc.mediaDescriptions.findIndex(i=>i.attributes.mid===t);if(n!==-1){let i=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],e);this.sessionDesc.mediaDescriptions[n]=i;}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(t=>t.media.port!=="0").map(t=>t.attributes.mid);}findPreloadMediaDesc(t){return this.sessionDesc.mediaDescriptions.find(e=>{var n;return ((n=e.attributes)===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId)===t[0].ssrcId})}findFirstClosedMedia(t){return this.sessionDesc.mediaDescriptions.find(e=>Xt()?e.media.port==="0"&&e.media.mediaType===t:e.media.port==="0")}},z3=["sdp"];var oe;function Zw(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function Bo(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Zw(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Zw(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}let $w=(oe=class ic extends kI{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,n;return (e=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&e!==void 0?e:null}get localCodecs(){return []}set isInRestartIce(e){this._isInRestartIce=e;}get isInRestartIce(){return this._isInRestartIce}constructor(e,n,i){super(e,n),g(this,"direction",void 0),g(this,"name",void 0),g(this,"store",void 0),g(this,"spec",void 0),g(this,"peerConnection",void 0),g(this,"initialOffer",void 0),g(this,"transport",void 0),g(this,"statsFilter",void 0),g(this,"localCandidateCount",0),g(this,"_isInRestartIce",!1),g(this,"mutex",new Qe("P2PConnection-mutex")),g(this,"onLocalCandidate",void 0),g(this,"remoteSDP",void 0),g(this,"pendingCandidates",[]),g(this,"localCapabilities",void 0),g(this,"isReady",!1),g(this,"restartCnt",0),g(this,"curTurnServerIndex",0),this.store=n,this.spec=e,this.peerConnection=new RTCPeerConnection(ic.resolvePCConfiguration(e,n.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=i??Dn.SEND_ONLY,this.name=this.direction===Dn.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=Wu(this.peerConnection,v("STATS_UPDATE_INTERVAL"),void 0,Xt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1;}async establish(e){try{let n=await QE();if(this.localCapabilities=za(n),e){let{sdp:i}=e,r=H3(e,z3),o=function(){let l={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},u=vd(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"sendonly"),h={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},T={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Zi(u,l,"videoExtensions",h,p,T),Zi(u,l,"videoCodecs",h,p,T),Zi(u,l,"audioExtensions",h,p,T),Zi(u,l,"audioCodecs",h,p,T),v("RAISE_H264_BASELINE_PRIORITY")){let m=T.videoCodecs.findIndex(E=>E.rtpMap&&E.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&E.fmtp&&E.fmtp.parameters["profile-level-id"]==="42001f");if(m!==-1){let E=T.videoCodecs.findIndex(S=>S.rtpMap&&S.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(E<m){_.debug("raising H264 baseline profile priority");let S=T.videoCodecs[m];T.videoCodecs.splice(m,1),T.videoCodecs.splice(E,0,S);}E!==-1&&v("FILTER_SEND_H264_BASELINE")&&(h.videoCodecs=h.videoCodecs.filter(S=>!(S.rtpMap&&S.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&S.fmtp&&S.fmtp.parameters["profile-level-id"]!=="42001f")));}}return {send:h,recv:p,sendrecv:T}}({},{},i);this.remoteSDP=new Qw({remoteIceParameters:r.iceParameters,remoteDtlsParameters:r.dtlsParameters,candidates:[],remoteRTPCapabilities:o,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;let s=await this.peerConnection.createAnswer();if(!s.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");let a=_r(s.sdp);await this.peerConnection.setLocalDescription(s);let c=await Xw({},{},s.sdp);this.localCapabilities=za(c);let d=this.peerConnection.getTransceivers()[0];return d!=null&&d.receiver&&d.receiver.transport&&this.tryBindTransportEvents(d.receiver.transport),Bo(Bo({},a),{},{sdp:s.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});let i=await this.peerConnection.createOffer();if(!i.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let r=_r(i.sdp);return this.initialOffer=i,Bo(Bo({},r),{},{sdp:i.sdp})}}catch(n){throw new D(R.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);let{sdp:n,iceParameters:i,dtlsParameters:r}=e,o=await Xw({},{},n);this.remoteSDP=new Qw({remoteIceParameters:i,remoteDtlsParameters:r,candidates:[],remoteRTPCapabilities:o,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});let s=this.peerConnection.getTransceivers()[0];s!=null&&s.sender&&s.sender.transport&&this.tryBindTransportEvents(s.sender.transport);}catch(n){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(n.toString()))}}async addRemoteCandidate(e){try{e&&this.pendingCandidates.push(e),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach(n=>{this.peerConnection.addIceCandidate(n);}),this.pendingCandidates=[]);}catch(n){throw new D(R.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(n.toString()))}}send(e,n,i){var r=this;return $n(function*(){let o=yield gt(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");let s=[],a=r.remoteSDP.receive(e,n,i);e.forEach((E,S)=>{if(a[S].needCreateTransceiver){let C=r.peerConnection.addTransceiver(E._mediaStreamTrack,{direction:"sendonly"});s.push(C),E._updateRtpTransceiver(C);}else {let C=r.peerConnection.getTransceivers().find(A=>A.mid===a[S].mid);if(!C)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(a[S].mid));s.push(C),E._updateRtpTransceiver(C);}}),Xt()&&v("SIMULCAST")===!0&&(yield gt(r.applySimulcastForFirefox(s,e)));let c=a.map(E=>E.mid),d=yield gt(r.peerConnection.createOffer()),l=r.mungSendOfferSDP(d.sdp,e,c),u=ue.parse(l),h=c.map(E=>{let S=u.mediaDescriptions.find(C=>C.attributes.mid===E);if(!S)throw new Error("Cannot extract ssrc from mediaDescription.");return zE(S,v("USE_PUB_RTX"))}),p=s.map((E,S)=>{let C=c[S];return {localSSRC:h[S],id:C}});yield gt(r.peerConnection.setLocalDescription({type:"offer",sdp:l}));try{yield p;}catch(E){let S=r.remoteSDP.toString();throw yield gt(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield gt(r.peerConnection.setRemoteDescription({type:"answer",sdp:S})),yield gt(r.stopSending(c,!0)),E}yield gt(r.applySimulcastEncodings(s,e)),yield gt(r.applySendEncodings(s,e));let T=r.remoteSDP.toString(),m=r.logSDPExchange(l,"offer","local","send");return m?.(T),yield gt(r.setRemoteDescription({type:"answer",sdp:T})),s.map((E,S)=>{let C=c[S];return {localSSRC:h[S],id:C}})}catch(s){throw s instanceof D?s:new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(s.toString()))}finally{o();}})()}async stopSending(e,n){let i=n?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");let r=this.peerConnection.getTransceivers().filter(c=>e.indexOf(c.mid)!==-1);if(r.length!==e.length)throw new Error("Transceivers' length (".concat(r.length,") doesn't match mids' length (").concat(e.length,") when trying to call P2PConnection.stopSending."));r.map(c=>{var d;c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c);});let o=await this.peerConnection.createOffer(),s=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(e);let a=this.remoteSDP.toString();s?.(a),await this.setRemoteDescription({type:"answer",sdp:a});}catch(r){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{i&&i();}}async receive(e,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));let{mid:o,needExchangeSDP:s}=this.remoteSDP.send(e,n,i,r);if(s){let c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:c});let l=await this.peerConnection.createAnswer(),u=this.mungReceiveAnswerSDP(l.sdp,o,e);d?.(u||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:u}),_.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."));}else _.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));let a=this.peerConnection.getTransceivers().find(c=>c.mid===o);if(!a||a.mid===null)throw new Error("Cannot get transceiver after setLocalDescription.");return {track:a.receiver.track,mid:a.mid,transceiver:a}}catch(o){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async mockReceive(e,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));let{mid:o,needExchangeSDP:s}=this.remoteSDP.send(e,n,i,r);if(s){let a=this.remoteSDP.toString(),c=this.logSDPExchange(a,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:a});let d=await this.peerConnection.createAnswer(),l=this.mungReceiveAnswerSDP(d.sdp,o,e);c?.(l||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:l}),_.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."));}else _.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));}catch(o){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);let n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:n});let r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r);}catch(n){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async restartICE(e){try{if(this.store.p2pTransport===ms.Auto&&(this.store.p2pTransport=ms.SdRtn,Ot().supportPCSetConfiguration&&this.peerConnection.setConfiguration(ic.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,Ot().supportPCSetConfiguration&&this.peerConnection.setConfiguration(ic.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!e){this.restartCnt++,this.isReady=!1;let n=await this.peerConnection.createOffer({iceRestart:!0});if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let{iceParameters:i}=_r(n.sdp);return this.store.descriptionStart(),this.direction===Dn.SEND_ONLY&&await this.peerConnection.setLocalDescription(n),i}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(e),this.store.descriptionStart(),this.direction===Dn.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});let n=await this.peerConnection.createAnswer();if(!n.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");let{iceParameters:i}=_r(n.sdp);return await this.peerConnection.setLocalDescription(n),i}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0;}catch(n){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}close(){var e;this.peerConnection.close(),this.peerConnection.onicecandidate=null,(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy();}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");let i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n],[e]);this.remoteSDP.updateRecvMedia(e,n);let o=this.remoteSDP.toString(),s=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),s?.(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o});}catch(i){throw new D(R.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(e,n){let i=this.peerConnection.getTransceivers().filter(r=>r.mid===e);i.length===1&&(this.isVP8Simulcast(n)?Xt()||await this.applySimulcastEncodings(i,[n]):await this.applySendEncodings(i,[n]));}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n);}async replaceTrack(e,n){let i=this.peerConnection.getTransceivers().find(r=>r.mid===n);i&&await i.sender.replaceTrack(e._mediaStreamTrack);}async getSelectedCandidatePair(){let e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){let n=e[0].transport.iceTransport,{local:i,remote:r}=n.getSelectedCandidatePair();return {local:Bo(Bo({},Br),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:Bo(Bo({},Br),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e,n;q(e=["connected","completed"]).call(e,this.peerConnection.iceConnectionState)&&(this.isReady=!1),(n=this.onICEConnectionStateChange)===null||n===void 0||n.call(this,this.peerConnection.iceConnectionState);},this.peerConnection.onconnectionstatechange=()=>{var e;this.peerConnection.connectionState==="connected"&&(this.restartCnt=0),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState);},this.startICECandidate();}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=e=>{if(e.candidate){var n;e.candidate.candidate&&((n=this.onLocalCandidate)===null||n===void 0||n.call(this,e.candidate.toJSON())),this.localCandidateCount+=1;}else _.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount);});}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null;}static resolvePCConfiguration(e,n){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,r={iceServers:[]};var o;return e.iceServers?r.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(_a(e.turnServer.servers)?r.iceServers=e.turnServer.servers:(r.iceServers&&r.iceServers.push(...ic.turnServerConfigToIceServers(e.turnServer.servers,n,i)),v("USE_TURN_SERVER_OF_GATEWAY")&&r.iceServers&&e.turnServer.serversFromGateway&&r.iceServers.push(...ic.turnServerConfigToIceServers(e.turnServer.serversFromGateway,n,i)),q(o=[ms.Relay,ms.SdRtn]).call(o,n)&&(r.iceTransportPolicy="relay"),v("FORCE_TURN_TCP")?r.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(s=>{s.forceturn&&(r.iceTransportPolicy="relay");}))),v("ENABLE_ENCODED_TRANSFORM")&&Ot().supportWebRTCEncodedTransform&&(r.encodedInsertableStreams=!0),_.debug("P2PConnection p2pTransport is ".concat(n)),r}static turnServerConfigToIceServers(e,n){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,r=[],o=e.filter(a=>a.tcpport);_.debug("P2PConnection turnServers is ".concat(o,", current index is ").concat(i));let s=o.length>i?o[i]:o[0];switch(n){case ms.SdRtn:let a=e.filter(d=>{var l;return q(l=d.username).call(l,"glb:")&&d.turnServerURL==d.turnServerURL}),c=a.length>i?a[i]:a[0];c&&(r.push({username:c.username,credential:c.password,credentialType:"password",urls:"turn:".concat(Do(c.turnServerURL),":").concat(c.tcpport,"?transport=udp")}),r.push({username:c.username,credential:c.password,credentialType:"password",urls:"turns:".concat(Do(c.turnServerURL),":").concat(c.tcpport,"?transport=tcp")}));break;case ms.Relay:s&&(r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turn:".concat(s.turnServerURL,":").concat(s.tcpport,"?transport=udp")}),r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turns:".concat(Do(s.turnServerURL),":").concat(s.tcpport,"?transport=tcp")}));break;default:s&&(r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turn:".concat(s.turnServerURL,":").concat(s.tcpport,"?transport=udp")}),r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turns:".concat(Do(s.turnServerURL),":").concat(s.tcpport,"?transport=tcp")}),r.push({username:s.username,credential:s.password,credentialType:"password",urls:"stun:".concat(s.turnServerURL,":").concat(s.tcpport)}));}return r}tryBindTransportEvents(e){if(e){this.transport=e,e.onstatechange=()=>{var i;e!=null&&e.state&&((i=this.onDTLSTransportStateChange)===null||i===void 0||i.call(this,e.state));},e.onerror=i=>{var r;(r=this.onDTLSTransportError)===null||r===void 0||r.call(this,"error"in i?i.error:i);};let n=e.iceTransport;n&&(n.onstatechange=()=>{let i=e?.iceTransport.state;var r;i&&((r=this.onICETransportStateChange)===null||r===void 0||r.call(this,i));},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){let{local:i,remote:r}=n.getSelectedCandidatePair();_.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:i.type,protocol:i.protocol}),", remote ").concat(JSON.stringify({candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})," )"));}}));}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null));}async updateRtpSenderEncodings(e,n){var i;if(n||(n=this.peerConnection.getSenders().find(l=>l.track===e._mediaStreamTrack)),!n)return _.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return _.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Ot().supportSetRtpSenderParameters)return _.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");let r={},o={};switch(e._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced";}if(e._encoderConfig){var s;let{bitrateMax:l,frameRate:u,scaleResolutionDownBy:h}=e._encoderConfig;l&&(o.maxBitrate=1e3*l),q(s=e._hints).call(s,ie.LOW_STREAM)&&(u&&(o.maxFramerate=Wn(u)),h&&h>=1&&(o.scaleResolutionDownBy=h));}if(v("DSCP_TYPE")&&Io()){var a;let l=v("DSCP_TYPE");q(a=["very-low","low","medium","high"]).call(a,l)&&(o.networkPriority=l);}let c=n.getParameters(),d=(i=c.encodings)===null||i===void 0?void 0:i[0];Xt()&&!d&&(r.encodings=[o]),d&&Object.assign(d,o),Object.assign(c,r),_.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(c.encodings))),await n.setParameters(c);}async applySendEncodings(e,n){try{if(!Ot().supportSetRtpSenderParameters||e.length!==n.length)return;for(let i=0;i<e.length;i++){let r=e[i],o=n[i];o instanceof $t&&!this.isVP8Simulcast(o)&&await this.updateRtpSenderEncodings(o,r.sender);}}catch{_.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."));}}mungSendOfferSDP(e,n,i){let r=ue.parse(e);return n.forEach((o,s)=>{let a=i[s],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(Fo(c,o),XE(c,o,this.store.codec));}),ue.print(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,e);},this.statsFilter.onFirstVideoReceived=e=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,e);},this.statsFilter.onFirstAudioDecoded=e=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,e);},this.statsFilter.onFirstVideoDecoded=(e,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,n,i);},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,e,n);},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,e,n);},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,e);};}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0;}async applySimulcastForFirefox(e,n){if(e.length===n.length)for(let c=0;c<e.length;c++){var i,r,o,s,a;let d=e[c],l=n[c];if(l instanceof $t&&!q(i=l._hints).call(i,ie.LOW_STREAM)&&(r=l._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((o=l._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(s=l._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((a=l._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){let u={},h={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};u.encodings=[{rid:"m",active:!0,maxBitrate:h.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:h.high}];let p=d.sender.getParameters();await d.sender.setParameters(Object.assign(p,u));}}}async applySimulcastEncodings(e,n){if(!Xt()&&e.length===n.length)for(let i=0;i<e.length;i++){let r=n[i];if(r instanceof $t&&this.isVP8Simulcast(r)){let o=e[i],s={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];let c=o.sender.getParameters();await o.sender.setParameters(Object.assign(c,s));}}}isVP8Simulcast(e){var n,i,r,o,s;return !!(e instanceof $t&&v("SIMULCAST")&&this.store.codec==="vp8"&&!q(n=e._hints).call(n,ie.LOW_STREAM)&&(i=e._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=e._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(o=e._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((s=e._scalabilityMode)===null||s===void 0?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,n,i,r){if(v("SDP_LOGGING"))return _.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(n," SDP during P2PConnection.").concat(r,`
`),e),n==="offer"?o=>{this.logSDPExchange(o,"answer",i==="local"?"remote":"local",r);}:void 0}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");let n=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(s=>{s.direction="inactive";});let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);let o=this.remoteSDP.toString();r?.(o),await this.setRemoteDescription({type:"answer",sdp:o});}catch(n){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");let n=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(async s=>{s.direction="sendonly";});let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);let o=this.remoteSDP.toString();r?.(o),await this.setRemoteDescription({type:"answer",sdp:o});}catch(n){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}async getRemoteSSRC(e,n){var i,r;if(n=(i=n)!==null&&i!==void 0?i:(r=this.currentRemoteDescription)===null||r===void 0?void 0:r.sdp){var o;let s=(o=ue.parse(n).mediaDescriptions.find(a=>a.attributes.mid===e))===null||o===void 0?void 0:o.attributes.ssrcs;return s?.[0].ssrcId}}async setRemoteDescription(e){var n;await this.peerConnection.setRemoteDescription(e),q(n=["connected","completed"]).call(n,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate());}mungReceiveAnswerSDP(e,n,i){let r=ue.parse(e),o=r.mediaDescriptions.find(s=>s.attributes.mid===n);return o&&i===tt.AUDIO&&o.media.mediaType==="audio"&&mr(o),ue.print(r)}},W(oe.prototype,"establish",[$i],Object.getOwnPropertyDescriptor(oe.prototype,"establish"),oe.prototype),W(oe.prototype,"connect",[$i],Object.getOwnPropertyDescriptor(oe.prototype,"connect"),oe.prototype),W(oe.prototype,"receive",[$i],Object.getOwnPropertyDescriptor(oe.prototype,"receive"),oe.prototype),W(oe.prototype,"mockReceive",[$i],Object.getOwnPropertyDescriptor(oe.prototype,"mockReceive"),oe.prototype),W(oe.prototype,"stopReceiving",[$i],Object.getOwnPropertyDescriptor(oe.prototype,"stopReceiving"),oe.prototype),W(oe.prototype,"restartICE",[$i],Object.getOwnPropertyDescriptor(oe.prototype,"restartICE"),oe.prototype),W(oe.prototype,"close",[$i],Object.getOwnPropertyDescriptor(oe.prototype,"close"),oe.prototype),W(oe.prototype,"updateEncoderConfig",[$i],Object.getOwnPropertyDescriptor(oe.prototype,"updateEncoderConfig"),oe.prototype),W(oe.prototype,"updateSendParameters",[$i],Object.getOwnPropertyDescriptor(oe.prototype,"updateSendParameters"),oe.prototype),W(oe.prototype,"replaceTrack",[$i],Object.getOwnPropertyDescriptor(oe.prototype,"replaceTrack"),oe.prototype),W(oe.prototype,"muteLocal",[$i],Object.getOwnPropertyDescriptor(oe.prototype,"muteLocal"),oe.prototype),W(oe.prototype,"unmuteLocal",[$i],Object.getOwnPropertyDescriptor(oe.prototype,"unmuteLocal"),oe.prototype),oe);function $i(t,e,n){let i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){let r=this.mutex,o=await r.lock("From P2PConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o();}},n}function $E(t,e){let n=document.createElement("video"),i=document.createElement("canvas");n.setAttribute("style","display:none"),i.setAttribute("style","display:none"),n.setAttribute("muted",""),n.muted=!0,n.setAttribute("autoplay",""),n.autoplay=!0,n.setAttribute("playsinline",""),i.width=Wn(e.width),i.height=Wn(e.height);let r=Wn(e.framerate||15);document.body.append(n),document.body.append(i);let o=t._mediaStreamTrack;n.srcObject=new MediaStream([o]),n.play();let s=i.getContext("2d");if(!s)throw new w(R.UNEXPECTED_ERROR,"can not get canvas context");let a=Ot(),c=i.captureStream(a.supportRequestFrame?0:r).getVideoTracks()[0];c.canvas||(c.canvas=i),i.startCapture=()=>{if(!n)return i.stopCapture&&i.stopCapture();if(n.paused&&n.play(),n.videoHeight>2&&n.videoWidth>2){let l=n.videoWidth,u=n.videoHeight/l,h=i.width*u;Math.abs(h-i.height)>=2&&(_.debug("adjust low stream resolution","".concat(i.width,"x").concat(i.height," -> ").concat(i.width,"x").concat(h)),i.height=h);}s.drawImage(n,0,0,i.width,i.height),c.requestFrame&&c.requestFrame(),o!==t._mediaStreamTrack&&(o=t._mediaStreamTrack,n.srcObject=new MediaStream([o]));},i.stopCapture=kE(()=>i.startCapture&&i.startCapture(),r);let d=c.stop;return c.stop=()=>{d.call(c),n&&(n.remove(),n.srcObject=null,n=null),i&&(i.width=0,i.remove(),i.stopCapture&&i.stopCapture(),i.startCapture=void 0,i.stopCapture=void 0,i=null),_.debug("clean low stream renderer");},c}var qu=function(t){return t[t.HEIGHT=2033]="HEIGHT",t[t.FRAME_RATE=2034]="FRAME_RATE",t[t.WIDTH=2035]="WIDTH",t}(qu||{}),ze=function(t){return t[t.FRAME_RATE=2002]="FRAME_RATE",t[t.WIDTH=2003]="WIDTH",t[t.HEIGHT=2004]="HEIGHT",t[t.PACKAGE_LOST=2005]="PACKAGE_LOST",t[t.AVG_ENCODE=2007]="AVG_ENCODE",t[t.NACKS=2009]="NACKS",t[t.PLIS=2010]="PLIS",t[t.FIRS=2011]="FIRS",t[t.BITRATE=2012]="BITRATE",t[t.PACKAGE_RATE=2031]="PACKAGE_RATE",t[t.ADAPTATION=2032]="ADAPTATION",t[t.ACTUAL_ENCODED=2060]="ACTUAL_ENCODED",t[t.BANDWIDTH=2061]="BANDWIDTH",t[t.RETRANSMIT=2062]="RETRANSMIT",t[t.TARGET_ENCODED=2064]="TARGET_ENCODED",t[t.TRANSMIT=2066]="TRANSMIT",t[t.FREEZE=2082]="FREEZE",t[t.DISABLED=2095]="DISABLED",t[t.PLAYER_STATUS=2128]="PLAYER_STATUS",t[t.QP_SUM=2143]="QP_SUM",t}(ze||{}),ks=function(t){return t[t.BITRATE=2069]="BITRATE",t[t.PACKAGE_LOST=2070]="PACKAGE_LOST",t[t.PACKAGE_RATE=2071]="PACKAGE_RATE",t[t.HEIGHT=2073]="HEIGHT",t[t.FRAME_RATE=2075]="FRAME_RATE",t[t.WIDTH=2077]="WIDTH",t}(ks||{}),Rn=function(t){return t[t.JITTER=-1]="JITTER",t[t.PACKAGE_LOST=2014]="PACKAGE_LOST",t[t.WIDTH=2018]="WIDTH",t[t.HEIGHT=2019]="HEIGHT",t[t.FRAME_RATE=2020]="FRAME_RATE",t[t.JITTER_BUFFER=2023]="JITTER_BUFFER",t[t.CURRENT_DELAY=2024]="CURRENT_DELAY",t[t.NACKS=2026]="NACKS",t[t.PLIS=2027]="PLIS",t[t.FIRS=2028]="FIRS",t[t.BITRATE=2029]="BITRATE",t[t.PACKAGE_RATE=2078]="PACKAGE_RATE",t[t.FREEZE=2084]="FREEZE",t[t.DISABLED=2101]="DISABLED",t[t.PLAYER_STATUS=2129]="PLAYER_STATUS",t[t.QP_SUM=2144]="QP_SUM",t[t.I_FRAME_DELAY=2149]="I_FRAME_DELAY",t}(Rn||{}),Ms=function(t){return t[t.FRAME_RATE_DECODE=2021]="FRAME_RATE_DECODE",t[t.FRAME_RATE_RENDER=2022]="FRAME_RATE_RENDER",t[t.FRAME_RATE_OUTPUT=2155]="FRAME_RATE_OUTPUT",t[t.FREEZE_TIME=2109]="FREEZE_TIME",t[t.FREEZE_TIME_RENDER=2147]="FREEZE_TIME_RENDER",t[t.FREEZE_DURATION=2156]="FREEZE_DURATION",t}(Ms||{}),tO=function(t){return t[t.PCM_LEVEL=2104]="PCM_LEVEL",t}(tO||{}),jo=function(t){return t[t.PACKAGE_LOST=-1]="PACKAGE_LOST",t[t.LEVEL=2038]="LEVEL",t[t.BITRATE=2039]="BITRATE",t[t.PACKAGE_RATE=2040]="PACKAGE_RATE",t[t.AEC_RETURN_LOSS=2041]="AEC_RETURN_LOSS",t[t.AEC_RETURN_LOSS_ENH=2042]="AEC_RETURN_LOSS_ENH",t[t.FREEZE=2081]="FREEZE",t[t.DISABLED=2096]="DISABLED",t}(jo||{}),tr=function(t){return t[t.BITRATE=2044]="BITRATE",t[t.PACKAGE_LOST=2045]="PACKAGE_LOST",t[t.PACKAGE_RATE=2046]="PACKAGE_RATE",t[t.CURRENT_DELAY=2047]="CURRENT_DELAY",t[t.JITTER_BUFFER=2054]="JITTER_BUFFER",t[t.JITTER=2055]="JITTER",t[t.FREEZE=2083]="FREEZE",t[t.DISABLED=2102]="DISABLED",t[t.PCM_LEVEL=2105]="PCM_LEVEL",t[t.PLAYER_STATUS=2130]="PLAYER_STATUS",t[t.CONCEALED_SAMPLES=2148]="CONCEALED_SAMPLES",t}(tr||{}),eO=function(t){return t[t.FREEZE_TIME=-1]="FREEZE_TIME",t[t.LEVEL=2043]="LEVEL",t}(eO||{}),Oi=function(t){return t[t.RTT=2006]="RTT",t[t.CONN_TYPE=801]="CONN_TYPE",t}(Oi||{});let ao=1e3,Us=3;function St(t,e,n){n!=null&&Number.isFinite(n)&&(t[e]=Math.round(Math.max(0,n)));}function nO(t){let e={[Oi.CONN_TYPE]:0,[Oi.RTT]:t.rtt};switch(t.selectedCandidatePair.localCandidate.candidateType){case"relay":{let n=t.selectedCandidatePair.localCandidate.relayProtocol;n==="udp"&&(e[Oi.CONN_TYPE]=1),n==="tcp"&&(e[Oi.CONN_TYPE]=3),n==="tls"&&(e[Oi.CONN_TYPE]=4);break}case"srflx":e[Oi.CONN_TYPE]=2;}return e}function iO(t){let e=0;switch(t){case"none":e=0;break;case"cpu":e=1;break;case"bandwidth":e=2;break;case"other":e=3;}return e}class rO extends de{constructor(e){super(),g(this,"store",void 0),g(this,"uploadWRTCStatsTimer",void 0),g(this,"uploadOutboundDenoiserStatsTimer",void 0),g(this,"uploadExtStatsTimer",void 0),g(this,"uploadExtUsageStatsTimer",void 0),g(this,"uploadInboundExtStatsTimer",void 0),g(this,"requestStats",void 0),g(this,"requestTransportStats",void 0),g(this,"requestLocalMedia",void 0),g(this,"requestRemoteMedia",void 0),g(this,"requestAllTracks",void 0),g(this,"requestVideoIsReady",void 0),g(this,"requestUploadStats",void 0),g(this,"requestUpload",void 0),g(this,"uploadOutboundStarted",!1),g(this,"uploadInboundStarted",!1),g(this,"uploadTransportStarted",!1),g(this,"uploadExtensionUsageStarted",!1),g(this,"lastRecvStats",void 0),g(this,"lastSendStats",void 0),g(this,"lastFullRecvStats",void 0),g(this,"lastFullSendStats",void 0),g(this,"needUploadRenderFreezeTime",!0),this.store=e;}uploadWRTCStats(e){if(!this.requestStats||!this.requestUploadStats)return;let n,i;if(this.uploadTransportStarted&&(n=this.requestStats(),this.store.useP2P&&(i=this.requestStats(!0))),!n&&this.uploadOutboundStarted&&(n=this.requestStats()),!i&&this.uploadInboundStarted&&(i=this.requestStats(!0)),n||i){let r={};if(this.uploadTransportStarted&&n){let o=this.getTransportStats(n,i,e);o&&(r.misc=[o]);}if(this.uploadOutboundStarted&&n){let o=this.getOutboundStats(n,e?this.lastSendStats:this.lastFullSendStats,e);o&&(r.outbound=[o]);}if(this.uploadInboundStarted&&i){let o=this.getInboundStats(i,e?this.lastRecvStats:this.lastFullRecvStats,e);o&&(r.inbound=o);}this.requestUploadStats(r);}this.lastRecvStats=i,this.lastSendStats=n,e||(this.lastFullRecvStats=i,this.lastFullSendStats=n);}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;let e=1;this.uploadWRTCStatsTimer=window.setInterval(()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted)return this.stopUploadWRTCStats();this.uploadWRTCStats(e!==Us),++e===Us+1&&(e=1);},ao);}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0);}getTransportStats(e,n,i){if(!this.requestStats)return;if(i)return e.rtt==null?void 0:{addition:{[Oi.RTT]:e.rtt,[Oi.CONN_TYPE]:void 0}};let r=nO(e);if(this.store.useP2P){if(n){let o=nO(n);r[Oi.CONN_TYPE]+=o[Oi.CONN_TYPE]<<3;}r[Oi.CONN_TYPE]+=110;}else r[Oi.CONN_TYPE]+=100;return {addition:r}}getOutboundStats(e,n,i){if(!this.requestUploadStats||!this.requestLocalMedia)return;let r=this.requestLocalMedia();if(!r||r.length===0)return;let o,s,a;return r.forEach(c=>{let[d,{track:l,ssrcs:u}]=c;switch(d){case F.LocalVideoLowTrack:case F.LocalVideoTrack:if(d===F.LocalVideoTrack){let h=function(m,E,S,C,A){let b=E.videoSend.find(X=>X.ssrc===m);if(!b)return;let O={},{sentFrame:N,inputFrame:k}=b;if(k&&N){let X=k.frameRate,bt=N.frameRate;O[ze.FREEZE]=function(Ft,re){let Le=!0;return Le=!(Ft<=5)&&(Ft<=10?re<3:Ft<=20?re<4:re<5),Le}(X,bt)?1:0;}if(St(O,ze.QP_SUM,b.qpSumPerFrame),A)return O;switch(N&&(St(O,ze.HEIGHT,N.height),St(O,ze.WIDTH,N.width),St(O,ze.FRAME_RATE,N.frameRate)),O[ze.DISABLED]=C._originMediaStreamTrack&&!C._originMediaStreamTrack.enabled||C._mediaStreamTrack&&!C._mediaStreamTrack.enabled?1:0,b.adaptionChangeReason){case"none":O[ze.ADAPTATION]=0;break;case"cpu":O[ze.ADAPTATION]=1;break;case"bandwidth":O[ze.ADAPTATION]=2;break;case"other":O[ze.ADAPTATION]=3;}let M=0;b.adaptionChangeReason&&(M+=iO(b.adaptionChangeReason)),E.qualityLimitationReason&&(M+=iO(E.qualityLimitationReason)<<3),O[ze.ADAPTATION]=M,O[ze.PLAYER_STATUS]=PE[C._player?C._player.videoElementStatus:"uninit"],St(O,ze.NACKS,b.nacksCount),St(O,ze.PLIS,b.plisCount),St(O,ze.FIRS,b.firsCount),St(O,ze.AVG_ENCODE,b.avgEncodeMs);let x=S&&S.videoSend.find(X=>X.ssrc===m);if(x){let X=A?ao:ao*Us;x.timestamp&&b.timestamp&&(X=b.timestamp-x.timestamp),x.packets!=null&&b.packets!=null&&St(O,ze.PACKAGE_RATE,1e3*(b.packets-x.packets)/X),b.packetsLost!=null&&x.packetsLost!=null&&St(O,ze.PACKAGE_LOST,b.packetsLost-x.packetsLost),x.bytes!=null&&b.bytes!=null&&St(O,ze.BITRATE,8*(b.bytes-x.bytes)/X);}return O}(u[0].ssrcId,e,n,l,i),p=i?null:function(m,E,S){let C=E.videoSend.find(M=>M.ssrc===m);if(!C)return null;let A={},b=C.inputFrame,O=b&&b.height||S&&S.videoHeight||0,N=b&&b.width||S&&S.videoWidth||0,k=b&&b.frameRate||0;return St(A,qu.HEIGHT,O),St(A,qu.WIDTH,N),St(A,qu.FRAME_RATE,k),A}(u[0].ssrcId,e,l),T=i?null:function(m){let E={};return St(E,ze.RETRANSMIT,m.bitrate.retransmit),St(E,ze.TARGET_ENCODED,m.bitrate.targetEncoded),St(E,ze.ACTUAL_ENCODED,m.bitrate.actualEncoded),St(E,ze.TRANSMIT,m.bitrate.transmit),St(E,ze.BANDWIDTH,m.sendBandwidth),E}(e);s=Object.assign({},h,p,T);}else a=i?void 0:function(h,p,T){let m=p.videoSend.find(C=>C.ssrc===h);if(!m)return;let E={},S=m.sentFrame;if(S&&(St(E,ks.HEIGHT,S.height),St(E,ks.WIDTH,S.width),St(E,ks.FRAME_RATE,S.frameRate)),T){let C=T.videoSend.find(A=>A.ssrc===h);if(C){let A=ao*Us;C.timestamp&&m.timestamp&&(A=m.timestamp-C.timestamp),C.packets!=null&&m.packets!=null&&St(E,ks.PACKAGE_RATE,1e3*(m.packets-C.packets)/A),m.packetsLost!=null&&C.packetsLost!=null&&St(E,ks.PACKAGE_LOST,m.packetsLost-C.packetsLost),C.bytes!=null&&m.bytes!=null&&St(E,ks.BITRATE,8*(m.bytes-C.bytes)/A);}}return E}(u[0].ssrcId,e,n);break;case F.LocalAudioTrack:o=i?void 0:function(h,p,T,m){let E=p.audioSend.find(O=>O.ssrc===h);if(!E)return;let S={};S[jo.DISABLED]=m._originMediaStreamTrack&&!m._originMediaStreamTrack.enabled||m._mediaStreamTrack&&!m._mediaStreamTrack.enabled?1:0;let C=100*m._source.getAccurateVolumeLevel(),A=E.inputLevel;if(A!=null){let O=Math.ceil(50*Math.log10(100*A+1));St(S,jo.LEVEL,O);}St(S,tO.PCM_LEVEL,C),St(S,jo.AEC_RETURN_LOSS,E.aecReturnLoss),St(S,jo.AEC_RETURN_LOSS_ENH,E.aecReturnLossEnhancement),S[jo.FREEZE]=0;let b=T&&T.audioSend.find(O=>O.ssrc===h);if(b){let O=ao*Us;b.timestamp&&E.timestamp&&(O=E.timestamp-b.timestamp),b.bytes!=null&&E.bytes!=null&&St(S,jo.BITRATE,8*(E.bytes-b.bytes)/O),b.packets!=null&&E.packets!=null&&St(S,jo.PACKAGE_RATE,1e3*(E.packets-b.packets)/O);}return S}(u[0].ssrcId,e,n,l);}}),{high:s,low:a,audio:o}}getInboundStats(e,n,i){if(!this.requestRemoteMedia)return;let r=this.requestRemoteMedia()||[],o=[];return r.forEach(s=>{let[a,c]=s,d={peer:a.uid};if(c.has(tt.VIDEO)&&a.videoTrack){let l=a._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(a._videoSSRC)||!1,u=a.videoTrack?function(h,p,T,m,E,S,C){var A;let b=p.videoRecv.find(bt=>bt.ssrc===h);if(!b)return;let O={},{receivedFrame:N,outputFrame:k,decodeFrameRate:M}=b,x=T&&T.videoRecv.find(bt=>bt.ssrc===h);if(O[Rn.FREEZE]=E&&Id.isRemoteVideoFreeze(m,b,x)?1:0,St(O,Ms.FRAME_RATE_DECODE,M),St(O,Rn.QP_SUM,b.qpSumPerFrame),b.framesRateFirefox&&St(O,Rn.FRAME_RATE,b.framesRateFirefox),N&&St(O,Rn.FRAME_RATE,N.frameRate),x){let bt=p.timestamp-T.timestamp||(C?ao:Us*ao);b.packetsLost!=null&&x.packetsLost!=null&&St(O,Rn.PACKAGE_LOST,b.packetsLost-x.packetsLost),x.bytes!=null&&b.bytes!=null&&St(O,Rn.BITRATE,8*(b.bytes-x.bytes)/bt),x.packets!=null&&b.packets!=null&&St(O,Rn.PACKAGE_RATE,1e3*(b.packets-x.packets)/bt);}if(C)return O;N?(St(O,Rn.HEIGHT,N.height),St(O,Rn.WIDTH,N.width)):m&&(St(O,Rn.HEIGHT,m._videoHeight||0),St(O,Rn.WIDTH,m._videoWidth||0)),k&&St(O,Ms.FRAME_RATE_OUTPUT,k.frameRate);let X=(A=m._player)===null||A===void 0?void 0:A.rendFrameRate.toFixed(0);if(X&&St(O,Ms.FRAME_RATE_RENDER,+X),St(O,Rn.JITTER_BUFFER,b.jitterBufferMs),St(O,Rn.CURRENT_DELAY,b.currentDelayMs),St(O,Rn.FIRS,b.firsCount),St(O,Rn.NACKS,b.nacksCount),St(O,Rn.PLIS,b.plisCount),m){O[Rn.DISABLED]=m._originMediaStreamTrack.enabled&&m._mediaStreamTrack.enabled?0:1;let bt=m._player;if(bt){let{freezeTimeCounterList:Ft,renderFreezeAccTime:re,videoElementStatus:Le}=bt;if(Ft&&Ft.length>0&&St(O,Ms.FREEZE_TIME,Ft.splice(0,1)[0]),S&&so.visibility==="visible"&&Le===An.PLAYING&&Ot().supportRequestVideoFrameCallback){let Ee=Math.min(6e3,re);bt.renderFreezeAccTime=Math.max(0,re-Ee),St(O,Ms.FREEZE_TIME_RENDER,Ee);}if(typeof b.totalFreezesDuration=="number"){let Ee=x&&x.totalFreezesDuration?b.totalFreezesDuration-x.totalFreezesDuration:b.totalFreezesDuration;St(O,Ms.FREEZE_DURATION,1e3*Ee);}}}if(O[Rn.PLAYER_STATUS]=PE[m._player?m._player.videoElementStatus:"uninit"],x&&b.totalInterFrameDelay!==void 0&&b.totalSquaredInterFrameDelay!==void 0&&x.totalInterFrameDelay!==void 0&&x.totalSquaredInterFrameDelay!==void 0){let bt=b.totalInterFrameDelay-x.totalInterFrameDelay,Ft=b.totalSquaredInterFrameDelay-x.totalSquaredInterFrameDelay,re=b.framesDecodeCount-x.framesDecodeCount,Le=bt/re*1e3,Ee=Math.round(1e3*Math.sqrt((Ft-Math.pow(bt,2)/re)/re));!isNaN(Ee)&&Le+Ee>Math.max(3*Le,Le+150)&&(O[Rn.I_FRAME_DELAY]=Ee);}return O}(a._videoSSRC,e,n,a.videoTrack,l===!0,this.needUploadRenderFreezeTime,i):void 0;u&&(d.video=u);}if(c.has(tt.AUDIO)&&a.audioTrack){let l=a.audioTrack?function(u,h,p,T,m){let E=h.audioRecv.find(x=>x.ssrc===u);if(!E)return;let S={},C=p&&p.audioRecv.find(x=>x.ssrc===u),{receivedFrames:A,droppedFrames:b}=E;var O,N;if(St(S,tr.JITTER,E.jitterMs),A!=null&&b!=null&&(S[tr.FREEZE]=(N=b,(O=A)===0||100*N/O>20?1:0)),C){let x=h.timestamp-p.timestamp||(m?ao:ao*Us);E.packets!=null&&C.packets!=null&&St(S,tr.PACKAGE_RATE,1e3*(E.packets-C.packets)/x),C.bytes!=null&&E.bytes!=null&&St(S,tr.BITRATE,8*(E.bytes-C.bytes)/x),E.packetsLost!=null&&C.packetsLost!=null&&St(S,tr.PACKAGE_LOST,E.packetsLost-C.packetsLost);}if(m)return S;let k=100*T._source.getAccurateVolumeLevel(),M=E.outputLevel;if(M!=null){let x=Math.ceil(50*Math.log10(100*M+1));St(S,eO.LEVEL,x);}if(St(S,tr.PCM_LEVEL,k),T&&(S[tr.DISABLED]=T._originMediaStreamTrack.enabled&&T._mediaStreamTrack.enabled?0:1),St(S,tr.JITTER_BUFFER,E.jitterBufferMs),St(S,tr.CURRENT_DELAY,E.jitterBufferMs),S[tr.PLAYER_STATUS]=PE[xn.getPlayerState(T.getTrackId())],C){let x=E.concealedSamples-C.concealedSamples;x>0&&St(S,tr.CONCEALED_SAMPLES,x);}return S}(a._audioSSRC,e,n,a.audioTrack,i):void 0;l&&(d.audio=l);}(d.video||d.audio)&&o.push(d);}),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,o}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats();}stopUploadTransportStats(){this.uploadTransportStarted=!1;}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval(()=>{if(!this.requestAllTracks||!this.requestUpload)return;let e=(this.requestAllTracks()||[]).find(n=>n instanceof Vu);if(e&&e._external.getDenoiserStats){let n=e._external.getDenoiserStats();n&&this.requestUpload(fs.DENOISER_STATS,n);}},2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval(()=>{!this.requestAllTracks||!this.requestUpload||this.requestAllTracks().forEach(e=>{e.getProcessorStats().forEach(n=>{this.requestUpload&&this.requestUpload(n.type,n.stats);});});},2e3));}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0);}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval(()=>{!this.requestUpload||!this.requestRemoteMedia||(this.requestRemoteMedia()||[]).forEach(e=>{let[n,i]=e;i.has(tt.VIDEO)&&n.videoTrack&&n.videoTrack.getProcessorStats().forEach(r=>{this.requestUpload&&this.requestUpload(r.type,r.stats);}),i.has(tt.AUDIO)&&n.audioTrack&&n.audioTrack.getProcessorStats().forEach(r=>{this.requestUpload&&this.requestUpload(r.type,r.stats);});});},2e3));}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0));}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);let e=new Map;this.uploadExtUsageStatsTimer=window.setInterval(async()=>{let n=Date.now(),i={connectionInterval:v("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:n},r=[],o=this.requestAllTracks&&this.requestAllTracks()||[];for(let d of o)!d.muted&&d.enabled&&(r=r.concat(await d.getProcessorUsage()));let s=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(let[d,l]of s)l.has(tt.VIDEO)&&d.videoTrack&&(r=r.concat(await d.videoTrack.getProcessorUsage())),l.has(tt.AUDIO)&&d.audioTrack&&(r=r.concat(await d.audioTrack.getProcessorUsage()));if(r.length===0)return;i.details=function(d,l){let u={};for(let{id:m,value:E,level:S,direction:C}of d){var h;let A=(h=l.get(m))!==null&&h!==void 0?h:0,b=E===2?A+v("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:A;var p,T;l.set(m,b),u[m]?(E===2&&(u[m].value=E),S>u[m].level&&(u[m].level=S),C==="remote"&&(u[m].remoteUidCount+=1),u[m].totalTs=(p=l.get(m))!==null&&p!==void 0?p:0):u[m]={value:E,level:S,remoteUidCount:C==="local"?0:1,totalTs:(T=l.get(m))!==null&&T!==void 0?T:0};}return Object.keys(u).map(m=>{let{level:E,value:S,totalTs:C}=u[m];return {id:m,level:E,value:S,totalTs:C}})}(r,e);let a=Date.now(),c=a>n?a:n+1;this.requestUpload&&this.requestUpload(fs.EXTENSION_USAGE_STATS,{usageStats:i,sendTs:c});},v("EXTENSION_USAGE_UPLOAD_INTERVAL"));}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0);}}class Go{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(e,n){g(this,"uid",void 0),g(this,"_uintid",void 0),g(this,"_trust_in_room_",!0),g(this,"_trust_audio_enabled_state_",!0),g(this,"_trust_video_enabled_state_",!0),g(this,"_trust_audio_mute_state_",!0),g(this,"_trust_video_mute_state_",!0),g(this,"_audio_muted_",!1),g(this,"_video_muted_",!1),g(this,"_audio_enabled_",!0),g(this,"_video_enabled_",!0),g(this,"_audio_added_",!1),g(this,"_video_added_",!1),g(this,"_is_pre_created",!1),g(this,"_video_pre_subscribed",!1),g(this,"_audio_pre_subscribed",!1),g(this,"_trust_video_stream_added_state_",!0),g(this,"_trust_audio_stream_added_state_",!0),g(this,"_audioTrack",void 0),g(this,"_videoTrack",void 0),g(this,"_dataChannels",[]),g(this,"_audioSSRC",void 0),g(this,"_videoSSRC",void 0),g(this,"_audioOrtc",void 0),g(this,"_videoOrtc",void 0),g(this,"_cname",void 0),g(this,"_rtxSsrcId",void 0),g(this,"_videoMid",void 0),g(this,"_audioMid",void 0),this.uid=e,this._uintid=n;}}let Er=function(t){return t.SEND_ONLY="SEND_ONLY",t.RECEIVE_ONLY="RECEIVE_ONLY",t}({});function J3(t,e){var n;let i;switch(e){case F.LocalAudioTrack:i=jt.Audio;break;case F.LocalVideoTrack:i=q(n=t._hints).call(n,ie.SCREEN_TRACK)?jt.Screen:jt.High;break;case F.LocalVideoLowTrack:i=jt.Low;}return i}function tf(t){let e=Ot();if(t.some(n=>n._bypassWebAudio))throw new D(R.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!e.webAudioMediaStreamDest)throw new D(R.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function ef(t,e){tf(t);let n=new je;return t.forEach(i=>n.addAudioTrack(i)),n}var oO,sO,aO,cO,dO,lO,uO,hO,pO,_O,mO,he;function EO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function zu(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?EO(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):EO(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}let ti=(oO=fr(Er.SEND_ONLY),sO=fr(Er.SEND_ONLY),aO=fr(),cO=fr(Er.RECEIVE_ONLY),dO=fr(Er.RECEIVE_ONLY),lO=fr(Er.RECEIVE_ONLY),uO=fr(Er.RECEIVE_ONLY),hO=fr(Er.RECEIVE_ONLY),pO=fr(Er.RECEIVE_ONLY),_O=fr(),mO=fr(Er.RECEIVE_ONLY),he=class extends de{get state(){return this._state}set state(t){let e=this._state;this._state=t,this.emit(ct.StateChange,e,this._state);}constructor(t,e){super(),g(this,"store",void 0),g(this,"statsUploader",void 0),g(this,"sendConnection",void 0),g(this,"recvConnection",void 0),g(this,"localTrackMap",new Map),g(this,"remoteUserMap",new Map),g(this,"localDataChannels",[]),g(this,"pendingLocalTracks",[]),g(this,"pendingRemoteTracks",[]),g(this,"statsCollector",void 0),g(this,"dtlsFailedCount",0),g(this,"sendMutex",new Qe("P2PChannel2-send-mutex")),g(this,"recvMutex",new Qe("P2PChannel2-recv-mutex")),g(this,"_state",Gt.Disconnected),g(this,"_restartStates",["disconnected","failed"]),g(this,"reconnectInterval",void 0),g(this,"uploadUnplinkStarted",!1),g(this,"uploadDownlinkStarted",!1),g(this,"uplinkStateUploadInterval",void 0),g(this,"downlinkStatsUploadInterval",void 0),g(this,"handleMuteLocalTrack",async(n,i,r)=>{let o=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==Gt.Connected)return void r(new D(R.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));let c=this.filterTobeMutedTracks(n);if(c.length===0)return void i();let d=c.find(p=>p[0]==="videoLowTrack");d&&d[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(c.map(p=>{let[,{id:T}]=p;return T}));let l=!1;var s,a;n.trackMediaType==="video"?l=!((s=this.localTrackMap.get(F.LocalAudioTrack))===null||s===void 0||!s.track._muted):l=((a=this.localTrackMap.get(F.LocalVideoTrack))===null||a===void 0?void 0:a.id)===void 0;let u=this.createMuteMessage(c);await Qt(this,ct.RequestMuteLocal,u);let h=n.trackMediaType==="video"?No.MUTE_LOCAL_VIDEO:No.MUTE_LOCAL_AUDIO;await Qt(this,ct.RequestP2PMuteLocal,{action:h,message:u,isMuteAll:l}),i();}catch(c){r(c);}finally{o();}}),g(this,"handleUnmuteLocalTrack",async(n,i,r)=>{let o=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==Gt.Connected)return void r(new D(R.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));let s=this.filterTobeUnmutedTracks(n);if(s.length===0)return void i();await this.sendConnection.unmuteLocal(s.map(d=>{let[,{id:l}]=d;return l}));let a=this.createUnmuteMessage(s),c=n.trackMediaType==="video"?No.UNMUTE_LOCAL_VIDEO:No.UNMUTE_LOCAL_AUDIO;await Qt(this,ct.RequestP2PMuteLocal,{action:c,message:a}),i();}catch(s){r(s);}finally{o();}}),g(this,"handleUpdateVideoEncoder",async(n,i,r)=>{let o=await this.sendMutex.lock("Locking from P2PChannel2.handleSetVideoEncoder");try{let s=this.localTrackMap.get(F.LocalVideoTrack);if(!this.sendConnection||!s||s.track!==n||this.state!==Gt.Connected)return void i();let{id:a,track:c}=s;a&&(await this.sendConnection.updateSendParameters(a,c),await this.sendConnection.updateEncoderConfig(a,c),this.emit(ct.UpdateVideoEncoder,c)),i();}catch(s){r(s);}finally{o();}}),g(this,"handleUpdateVideoSendParameters",async(n,i,r)=>{let o=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoSendParameters");try{let s=this.localTrackMap.get(F.LocalVideoTrack);if(!this.sendConnection||!s||s.track!==n||this.state!==Gt.Connected)return void i();let{id:a,track:c}=s;a&&await this.sendConnection.updateSendParameters(a,c),i();}catch(s){r(s);}finally{o();}}),g(this,"handleReplaceTrack",async(n,i,r,o)=>{let s;_.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(n.getTrackId(),"]")),typeof o=="boolean"&&o||(s=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var a;let d=Array.from(this.localTrackMap.entries()).find(l=>{let[,{track:u}]=l;return n===u});if(!this.sendConnection||!d||d[1].id===void 0||this.state!==Gt.Connected)return void i();if(await((a=this.sendConnection)===null||a===void 0?void 0:a.replaceTrack(n,d[1].id)),d[0]===F.LocalVideoTrack&&Ot().supportDualStreamEncoding){let l=this.localTrackMap.get(F.LocalVideoLowTrack);if(l){let u=n._mediaStreamTrack.clone();l.track._originMediaStreamTrack.stop(),l.track._mediaStreamTrack=u,l.track._originMediaStreamTrack=u,await new K((h,p)=>{this.handleReplaceTrack(l.track,h,p,!0);});}}i();}catch(d){r(d);}finally{var c;(c=s)===null||c===void 0||c();}}),g(this,"handleGetLocalVideoStats",n=>{n(this.statsCollector.getLocalVideoTrackStats());}),g(this,"handleGetLocalAudioStats",n=>{n(this.statsCollector.getLocalAudioTrackStats());}),g(this,"handleGetRemoteVideoStats",n=>this.statsCollector.getRemoteVideoTrackStats(n.uid)[n.uid]),g(this,"handleGetRemoteAudioStats",n=>this.statsCollector.getRemoteAudioTrackStats(n.uid)[n.uid]),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new rO(t),this.bindStatsUploaderEvents(),this.reconnectInterval=window.setInterval(()=>{[this.sendConnection,this.recvConnection].forEach(n=>{n&&(n.iceConnectionState!=="disconnected"&&n.iceConnectionState!=="failed"||this.handleDisconnect(n.direction));});},v("ICE_RESTART_INTERVAL"));}async startP2PConnection(t,e){throw new D(R.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(t,e,n,i,r,o){throw new D(R.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(t,e){let n;try{if(e){this.recvConnection&&(_.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),n=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new $w(t,this.store,Dn.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);let i=await this.recvConnection.establish(e);return {iceParameters:i.iceParameters,dtlsParameters:i.dtlsParameters,sdp:i.sdp}}{this.state=Gt.New,this.sendConnection&&(_.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),n=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new $w(t,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);let i=await this.sendConnection.establish();return {iceParameters:i.iceParameters,dtlsParameters:i.dtlsParameters,sdp:i.sdp}}}finally{n&&n();}}async p2pConnect(t){if(!this.sendConnection)throw new D(R.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(t),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Gt.Connected;}async addRemoteCandidate(t,e){if(e===Dn.RECEIVE_ONLY){if(!this.sendConnection)throw new D(R.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(t);}else {if(!this.recvConnection)throw new D(R.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(t);}}publish(t,e,n){var i=this;return $n(function*(){let r=yield gt(i.sendMutex.lock("From P2PChannel.publish"));try{if(!i.sendConnection||i.state!==Gt.Connected){i.throwIfTrackTypeNotMatch(t);let d=t.filter(l=>i.pendingLocalTracks.indexOf(l)===-1);return void(i.pendingLocalTracks=i.pendingLocalTracks.concat(d))}i.store.pubId=i.store.pubId+1,fn.markPublishStart(i.store.clientId,i.store.pubId);let o=i.filterTobePublishedTracks(t,e,n);if(o.length===0)return void(yield gt(i.tryToUnmuteAudio(t)));o.forEach(d=>{let{track:l,type:u}=d,h=Date.now();i.store.publish(l.getTrackId(),u===F.LocalAudioTrack?"audio":"video",h);}),i.bindLocalTrackEvents(o);let s=yield gt(i.sendConnection.send(o.map(d=>{let{track:l}=d;return l}),i.store.codec,i.store.audioCodec)),a=(yield gt(s.next())).value,c=i.createGatewayPublishMessage(o,a);try{yield c;}catch(d){throw s.throw(d),d?.code===R.WS_ABORT&&o.forEach(l=>{let{track:u}=l;i.pendingLocalTracks.indexOf(u)===-1&&i.pendingLocalTracks.push(u);}),i.unbindLocalTrackEvents(o),d}yield gt(s.next()),o.forEach(d=>{let{type:l}=d;i.statsCollector.addLocalStats(l);}),i.statsUploader.startUploadOutboundStats(),i.assignLocalTracks(o,a),o.forEach(d=>{let{track:l,type:u}=d,h=Date.now();i.store.publish(l.getTrackId(),u===F.LocalAudioTrack?"audio":"video",void 0,h);}),i.startUploadUplinkState();}finally{r();}})()}async unpublish(t){if(!this.sendConnection||this.state!==Gt.Connected)return void(t.length===0?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter(r=>!q(t).call(t,r)));let e=this.filterTobeUnpublishedTracks(t);if(e.length===0)return;let n=e.find(r=>r[0]==="videoLowTrack");n&&n[1].track.close();let i=this.createGatewayUnpublishMessage(e);if(await this.sendConnection.stopSending(e.map(r=>{let[,{id:o}]=r;return o})),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map(r=>{let[o,{track:s}]=r;return {type:o,track:s}})),e.forEach(r=>{let[o]=r;this.statsCollector.removeLocalStats(o);}),this.localTrackMap.size===0&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===Gt.Connected)return n&&n[1].track.close(),i;t.forEach(r=>{let o=this.pendingLocalTracks.indexOf(r);o!==-1&&this.pendingLocalTracks.splice(o,1);});}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);let t=()=>{let e=[],n=[];Array.from(this.localTrackMap.entries()).forEach(i=>{let[r,{track:o,ssrcs:s}]=i,a={stream_type:J3(o,r),ssrcs:s};o._muted||!o._enabled?e.push(a):n.push(a);}),e.length>0&&e.forEach(i=>{Qt(this,ct.RequestMuteLocal,[i]);}),n.length>0&&n.forEach(i=>{Qt(this,ct.RequestUnmuteLocal,[i]);});};t(),this.uplinkStateUploadInterval=window.setInterval(()=>{t();},3e3);}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval));}publishLowStream(t){return $n(function*(){throw new D(R.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")})()}async republish(){this.pendingLocalTracks.length>0&&(_.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await Me(this,ct.RequestRePublish,this.pendingLocalTracks),this.emit(ct.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]);}async unpublishLowStream(){throw new D(R.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(t,e,n,i){var r;if(!this.recvConnection)throw new D(R.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if((r=this.remoteUserMap.get(t))!==null&&r!==void 0&&r.has(e))return;let{track:o,mid:s,transceiver:a}=await this.recvConnection.receive(e,[{ssrcId:n}],String(t.uid),i);e===tt.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(o):(t._audioTrack=new Ya(o,t.uid,t._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),a&&t._audioTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoSSRC=n,t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(o):(t._videoTrack=new Ka(o,t.uid,t._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),a&&t._videoTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(t,t._videoTrack));let c=this.remoteUserMap.get(t);c?c.set(e,s):this.remoteUserMap.set(t,new Map([[e,s]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();let d=this.pendingRemoteTracks.findIndex(l=>{let{user:u,kind:h}=l;return u.uid===t.uid&&e===h});d!==-1&&(this.pendingRemoteTracks.splice(d,1),this.emit(ct.MediaReconnectEnd,t.uid));}async mockSubscribe(t,e,n,i){if(!this.recvConnection)throw new D(R.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(e,[{ssrcId:n}],String(t.uid),i);}async unsubscribe(t,e,n){let i=this.pendingRemoteTracks.filter(o=>{let{user:s,kind:a}=o;return e!==void 0?s.uid===t.uid&&e===a:s.uid===t.uid});if(i.forEach(o=>{let s=this.pendingRemoteTracks.indexOf(o);this.pendingRemoteTracks.splice(s,1);}),this.recvConnection||n||i.forEach(o=>{let{kind:s}=o;var a;if(s===tt.AUDIO)(a=t._audioTrack)===null||a===void 0||a._destroy(),t._audioTrack=void 0;else if(s===tt.VIDEO){var c;(c=t._videoTrack)===null||c===void 0||c._destroy(),t._videoTrack=void 0;}}),!this.recvConnection)return;let r=this.filterTobeUnSubscribedTracks(t,e);r.length!==0&&(await this.recvConnection.stopReceiving(r.map(o=>{let[,{id:s}]=o;return s})),this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),r.forEach(o=>{let[s,{kind:a}]=o;var c,d;if(a===tt.VIDEO&&s._videoSSRC&&((c=this.recvConnection)===null||c===void 0||c.setStatsRemoteVideoIsReady(s._videoSSRC,!1)),a===tt.VIDEO)this.unbindRemoteTrackEvents(s._videoTrack),n||((d=s._videoTrack)===null||d===void 0||d._destroy(),s._videoTrack=void 0);else if(a===tt.AUDIO){var l;this.unbindRemoteTrackEvents(s._audioTrack),!n&&((l=s._audioTrack)===null||l===void 0||l._destroy(),s._audioTrack=void 0);}}),r.forEach(o=>{let[,{kind:s}]=o;Qt(this,ct.RequestP2PMuteRemote,s);}));}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);let t=()=>Array.from(this.remoteUserMap.entries()).forEach(e=>{let[,n]=e;[tt.VIDEO,tt.AUDIO].forEach(i=>{n.has(i)?Qt(this,ct.RequestP2PUnmuteRemote,i):Qt(this,ct.RequestP2PMuteRemote,i);});});t(),this.downlinkStatsUploadInterval=window.setInterval(()=>{t();},3e3);}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval));}getAllDataChannels(){return this.localDataChannels}async massSubscribe(t){throw new D(R.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(t){throw new D(R.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(t){throw new D(R.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(t){throw new D(R.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(t,e){if(!this.recvConnection)return;let n=this.remoteUserMap.get(t);if(!n)return void _.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid,"."));if(!n.get(e))return void _.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));let i=e===tt.VIDEO?t._videoSSRC:t._audioSSRC;i!==void 0&&this.recvConnection.setStatsRemoteVideoIsReady(i,!1);}async unmuteRemote(t,e){return this.unmuteRemoteNoLock(t,e)}async unmuteRemoteNoLock(t,e){if(!this.recvConnection)return;let n=this.remoteUserMap.get(t);if(!n)return void _.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid,"."));n.get(e)||_.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));}getAllTracks(t){let e=this.localTrackMap.get(F.LocalAudioTrack);if(e?.track instanceof je){let n=e.track;return Array.from(this.localTrackMap.entries()).filter(i=>{let[r]=i;return r!==F.LocalAudioTrack}).filter(i=>{let[r]=i;return !(t&&r===F.LocalVideoLowTrack)}).map(i=>{let[,{track:r}]=i;return r}).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter(n=>{let[i]=n;return !(t&&i===F.LocalVideoLowTrack)}).map(n=>{let[,{track:i}]=n;return i})}reportPublishEvent(t,e,n,i,r){if(t){let s=this.localTrackMap.get(F.LocalAudioTrack),a=i?this.localTrackMap.get(F.LocalVideoLowTrack):this.localTrackMap.get(F.LocalVideoTrack);et.publish(this.store.sessionId,{eventElapse:fn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:s?.track.getTrackLabel(),videoName:a?.track.getTrackLabel(),screenshare:a?.track._hints.indexOf(ie.SCREEN_TRACK)!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r});}else {var o;n||(n=[]);let s=n.find(c=>c instanceof Re),a=i?(o=this.localTrackMap.get(F.LocalVideoTrack))===null||o===void 0?void 0:o.track:n.find(c=>c instanceof $t);et.publish(this.store.sessionId,{eventElapse:fn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:s?.getTrackLabel(),videoName:a?.getTrackLabel(),screenshare:a?._hints.indexOf(ie.SCREEN_TRACK)!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r});}}reportSubscribeEvent(t,e,n,i){let r=i===tt.VIDEO?n._videoSSRC:n._audioSSRC;r&&et.subscribe(this.store.sessionId,{succ:t,ec:e,video:i===tt.VIDEO,audio:i===tt.AUDIO,peerid:n.uid,subscribeRequestid:i===tt.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:fn.measureFromSubscribeStart(this.store.clientId,r)});}reset(){_.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new Qe("P2PChannel2-send-mutex"),this.sendMutex=new Qe("P2PChannel2-recv-mutex"),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();let t=this.localTrackMap.get(F.LocalAudioTrack);if(t?.track instanceof je){if(t.track.trackList.length>0){let e=t.track;t.track.trackList.forEach(n=>{e.removeAudioTrack(n);});}t.track.close();}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=Gt.Disconnected;}getStats(t){var e,n;return t?(n=this.recvConnection)===null||n===void 0?void 0:n.getStats():(e=this.sendConnection)===null||e===void 0?void 0:e.getStats()}getRemoteVideoIsReady(t){var e;return ((e=this.recvConnection)===null||e===void 0?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){let t=this.localTrackMap.get(F.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){let t=this.localTrackMap.get(F.LocalVideoTrack);if(t)return {width:t.track.videoWidth||0,height:t.track.videoHeight||0}}getEncoderConfig(t){let e=this.localTrackMap.get(t);return e&&e.track instanceof $t||e&&e.track instanceof Re?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;let n=this.remoteUserMap.get(t);return !!n&&(!e||n.has(e))}async hasRemoteMediaWithLock(t,e){if(!t)return this.remoteUserMap.size>0;let n=this.remoteUserMap.get(t);return !!n&&(!e||n.has(e))}getRemoteMedia(t){var e;let n=Array.from(ri(e=this.remoteUserMap).call(e)).find(i=>i.uid===t);return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map(n=>{let[i]=n;return {uid:i.uid,level:i.audioTrack?100*i.audioTrack._source.getAccurateVolumeLevel():0}}),e=this.localTrackMap.get(F.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=vc(t).call(t,(n,i)=>n.level-i.level),t}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(_.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=Gt.Reconnecting,v("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e]=t;var n;e._videoTrack&&e._videoTrack._player&&((n=e._videoTrack._player.getVideoElement())===null||n===void 0||n.pause(),e._videoTrack._player.isKeepLastFrame=!0,e._videoTrack._originMediaStreamTrack.stop());}),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(t=>{var e;let[n,{track:i}]=t;switch(n){case F.LocalVideoTrack:q(e=i._hints).call(e,ie.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case F.LocalAudioTrack:i instanceof je?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case F.LocalVideoLowTrack:}}),this.emit(ct.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,n]=t;Array.from(ri(n).call(n)).forEach(i=>{this.setPendingRemoteMedia(e,i);}),this.emit(ct.MediaReconnectStart,e.uid);}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),_.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")));}hasPendingRemoteMedia(t,e){for(let n of this.pendingRemoteTracks){let{user:i,kind:r}=n;if((t instanceof Go?t.uid:t)===i.uid&&e===r)return !0}return !1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e});}async restartICE(t,e){let n,i;if(t===Dn.SEND_ONLY){if(!this.sendConnection)throw new D(R.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");n=await this.sendMutex.lock("From P2PChannel.restartICE"),i=this.sendConnection;}else {if(!this.recvConnection)throw new D(R.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");n=await this.recvMutex.lock("From P2PChannel.restartICE"),i=this.recvConnection;}try{if(e){let r=await i.restartICE(e);return i.isInRestartIce=!1,r}{let r=await i.restartICE();if(r){let o=await Me(this,ct.RequestP2PRestartICE,{direction:Dn.RECEIVE_ONLY,iceParameter:r});await i.restartICE(o),i.isInRestartIce=!1;}}}finally{n();}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;let t=this.sendConnection.getStats(),e=this.localTrackMap.get(F.LocalVideoTrack),n=this.localTrackMap.get(F.LocalAudioTrack),i=t.videoSend.find(p=>{var T;return p.ssrc===(e==null||(T=e.ssrcs)===null||T===void 0?void 0:T[0].ssrcId)}),r=t.audioSend.find(p=>{var T;return p.ssrc===(n==null||(T=n.ssrcs)===null||T===void 0?void 0:T[0].ssrcId)});if(!i||!r)return 1;let o=Qn(this,ct.NeedSignalRTT),s=i?i.rttMs:void 0,a=r?r.rttMs:void 0,c=s&&a?(s+a)/2:s||a,d=(c&&o?(c+o)/2:c||o)||0,l=100*t.sendPacketLossRate*.7/50+.3*d/1500,u=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,h=e?.track;if(h&&h._encoderConfig&&h._hints.indexOf(ie.SCREEN_TRACK)===-1){let p=h._encoderConfig.bitrateMax,T=t.bitrate.actualEncoded;if(p&&T){let m=(1e3*p-T)/(1e3*p);return vI[m<.15?0:m<.3?1:m<.45?2:m<.6?3:4][u]}}return u}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;let t=this.recvConnection.getStats(),e=0;return Array.from(this.remoteUserMap.entries()).forEach(n=>{let[i]=n,r=i._audioSSRC,o=i._videoSSRC,s=t.audioRecv.find(T=>T.ssrc===r),a=t.videoRecv.find(T=>T.ssrc===o);if(!s&&!a)return void(e+=1);let c=Qn(this,ct.NeedSignalRTT),d=t.rtt,l=(d&&c?(d+c)/2:d||c)||0,u=s?s.jitterMs:void 0,h=t.recvPacketLossRate,p=.7*h*100/50+.3*l/1500;u&&(p=.6*h*100/50+.2*l/1500+.2*u/400),e+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5;}),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}async muteLocalTrack(t){return new K((e,n)=>{this.handleMuteLocalTrack(t,e,n);})}filterTobePublishedTracks(t,e,n){let i=[],r=Ot(),o=this.getAllTracks();t=ma(t=t.filter(c=>o.indexOf(c)===-1));let s=!1,a=!1;for(let c of t){if(c instanceof $t&&(this.localTrackMap.has(F.LocalVideoTrack)||s?new D(R.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(i.push({track:c,type:F.LocalVideoTrack}),s=!0),e)){let d=this.getLowVideoTrack(c,n);i.push({track:d,type:F.LocalVideoLowTrack});}if(c instanceof Re){let d=this.localTrackMap.get(F.LocalAudioTrack);if(d){if(!(d.track instanceof je))throw new D(R.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new D(R.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");d.track.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0);}else if(a){let l=i.find(u=>{let{type:h}=u;return h===F.LocalAudioTrack});if(!(l.track instanceof je))throw new D(R.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new D(R.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");l.track.addAudioTrack(c);}else {if(!r.webAudioMediaStreamDest||c instanceof je||c._bypassWebAudio)i.push({track:c,type:F.LocalAudioTrack});else {let l=new je;l.addAudioTrack(c),i.push({track:l,type:F.LocalAudioTrack});}a=!0;}}}return i}filterTobeUnpublishedTracks(t){let e=[],n=this.getAllTracks();t=ma(t=t.filter(i=>n.indexOf(i)!==-1));for(let i of t){if(i instanceof Re){let r=this.localTrackMap.get(F.LocalAudioTrack);if(!r)continue;r.track instanceof je?(r.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),r.track.trackList.length===0&&(e.push([F.LocalAudioTrack,r]),r.track.close())):e.push([F.LocalAudioTrack,r]);}if(i instanceof $t){let r=this.localTrackMap.get(F.LocalVideoTrack);if(!r)continue;e.push([F.LocalVideoTrack,r]);let o=this.localTrackMap.get(F.LocalVideoLowTrack);o&&e.push([F.LocalVideoLowTrack,o]);}}return e}bindLocalTrackEvents(t){t.forEach(e=>{let{track:n,type:i}=e;switch(i){case F.LocalVideoTrack:n.addListener(J.GET_STATS,this.handleGetLocalVideoStats),n.addListener(J.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(J.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(J.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.addListener(J.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.addListener(J.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.addListener(J.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(J.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case F.LocalAudioTrack:this.bindLocalAudioTrackEvents(n);case F.LocalVideoLowTrack:}});}bindLocalAudioTrackEvents(t,e){t instanceof je?t.trackList.forEach(n=>{n.addListener(J.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(J.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(J.GET_STATS,this.handleGetLocalAudioStats),n.addListener(J.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(J.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);}):(t.addListener(J.GET_STATS,this.handleGetLocalAudioStats),t.addListener(J.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(J.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(J.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(J.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||t.addListener(J.NEED_REPLACE_TRACK,this.handleReplaceTrack));}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map(e=>{let[n,{track:i}]=e;return {track:i,type:n}})),t.forEach(e=>{let{track:n,type:i}=e;switch(i){case F.LocalVideoTrack:n.off(J.GET_STATS,this.handleGetLocalVideoStats),n.off(J.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(J.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(J.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.off(J.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.off(J.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(J.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(J.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case F.LocalAudioTrack:this.unbindLocalAudioTrackEvents(n);case F.LocalVideoLowTrack:}});}unbindLocalAudioTrackEvents(t){t instanceof je?t.trackList.forEach(e=>{e.off(J.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(J.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(J.GET_STATS,this.handleGetLocalAudioStats),e.off(J.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(J.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);}):(t.off(J.GET_STATS,this.handleGetLocalAudioStats),t.off(J.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(J.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(J.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(J.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(J.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack));}bindRemoteTrackEvents(t,e){e instanceof Ka&&e.addListener(J.GET_STATS,n=>{n(this.handleGetRemoteVideoStats(t));}),e instanceof Ya&&e.addListener(J.GET_STATS,n=>{n(this.handleGetRemoteAudioStats(t));});}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(J.GET_STATS);}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,n]=t;n.has(tt.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),n.has(tt.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack);});}createGatewayPublishMessage(t,e){return t.map((n,i)=>{var r;let o,{track:s,type:a}=n;switch(a){case F.LocalAudioTrack:o=jt.Audio;break;case F.LocalVideoTrack:o=q(r=s._hints).call(r,ie.SCREEN_TRACK)?jt.Screen:jt.High;break;case F.LocalVideoLowTrack:o=jt.Low;}return {kind:a===F.LocalAudioTrack?tt.AUDIO:tt.VIDEO,stream_type:o,mid:e[i].id,ssrcs:e[i].localSSRC,isMuted:s.muted||!s.enabled}})}createGatewayUnpublishMessage(t){return t.map(e=>{var n;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case F.LocalVideoTrack:i=q(n=o._hints).call(n,ie.SCREEN_TRACK)?jt.Screen:jt.High;break;case F.LocalAudioTrack:i=jt.Audio;break;case F.LocalVideoLowTrack:i=jt.Low;}return {stream_type:i,ssrcs:s,mid:a}})}assignLocalTracks(t,e){t.forEach((n,i)=>{let{track:r,type:o}=n;this.localTrackMap.set(o,{track:r,id:e[i].id,ssrcs:e[i].localSSRC});});}withdrawLocalTracks(t){t.forEach(e=>{let[n]=e;this.localTrackMap.delete(n);});}bindConnectionEvents(t){t.onConnectionStateChange=async e=>{var n;_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(t.name,".onConnectionStateChange(").concat(e,")")),this.emit(ct.PeerConnectionStateChange,e),e!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),e==="connected"&&(t.isInRestartIce=!1),q(n=this._restartStates).call(n,e)&&!t.isInRestartIce&&(e==="disconnected"&&await Ye(800),t.iceConnectionState!=="disconnected"&&t.iceConnectionState!=="failed"||this.handleDisconnect(t.direction));},t.onICEConnectionStateChange=e=>{e!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),et.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:ge.TRACER}).onSuccess(),this.emit(ct.IceConnectionStateChange,e);},t.onICETransportStateChange=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"));},t.onDTLSTransportStateChange=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"));},t.onDTLSTransportError=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"));},t.onFirstAudioDecoded=e=>{var n;let i=Array.from(ri(n=this.remoteUserMap).call(n)).find(o=>o._audioSSRC===e);var r;i&&(this.store.subscribe(i.uid,"audio",void 0,void 0,void 0,Date.now()),(r=i.audioTrack)===null||r===void 0||r.emit(ja.FIRST_FRAME_DECODED),et.firstRemoteFrame(this.store.sessionId,Ze.FIRST_AUDIO_DECODE,_e.FIRST_AUDIO_DECODE,{peer:i._uintid,subscribeElapse:fn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}));},t.onFirstAudioReceived=e=>{var n;let i=Array.from(ri(n=this.remoteUserMap).call(n)).find(r=>r._audioSSRC===e);i&&et.firstRemoteFrame(this.store.sessionId,Ze.FIRST_AUDIO_RECEIVED,_e.FIRST_AUDIO_RECEIVED,{peer:i._uintid,subscribeElapse:fn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId});},t.onFirstVideoDecoded=(e,n,i)=>{this.reportVideoFirstFrameDecoded(e,n,i);},t.onFirstVideoReceived=e=>{var n;let i=Array.from(ri(n=this.remoteUserMap).call(n)).find(r=>r._videoSSRC===e);i&&et.firstRemoteFrame(this.store.sessionId,Ze.FIRST_VIDEO_RECEIVED,_e.FIRST_VIDEO_RECEIVED,{peer:i._uintid,subscribeElapse:fn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId});},t.onSelectedLocalCandidateChanged=(e,n)=>{let i=e.candidateType==="relay",r=n.candidateType==="relay";n.candidateType!=="unknown"&&i===r||this.emit(ct.ConnectionTypeChange,i),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Po(n))," -> ").concat(JSON.stringify(Po(e)),")"));},t.onSelectedRemoteCandidateChanged=(e,n)=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Po(n))," -> ").concat(JSON.stringify(Po(e)),")"));},t.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0);},t.onLocalCandidate=e=>{this.emit(ct.LocalCandidate,{candidate:e,direction:t.direction});};}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0,t.onLocalCandidate=void 0;}async handleDisconnect(t){let e=t===Dn.SEND_ONLY?this.sendConnection:this.recvConnection;e&&!e.isInRestartIce&&(e.isInRestartIce=!0,_.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(e.name,"] start use restartICE")),t===Dn.SEND_ONLY?this.restartICE(t):Me(this,ct.RequestP2PRestartICE,{direction:Dn.SEND_ONLY}));}filterTobeMutedTracks(t){let e=[];if(this.getAllTracks().indexOf(t)===-1)return e;let n=this.localTrackMap.get(F.LocalAudioTrack);if(t instanceof Re&&n?.track instanceof je)return n.track.isActive||e.push([F.LocalAudioTrack,n]),e;let i=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return t===o});if(i&&(e.push(i),i[0]===F.LocalVideoTrack)){let r=this.localTrackMap.get(F.LocalVideoLowTrack);r&&e.push([F.LocalVideoLowTrack,r]);}return e}filterTobeUnmutedTracks(t){let e=[],n=this.localTrackMap.get(F.LocalAudioTrack);if(t instanceof Re&&n?.track instanceof je)return n.track.isActive&&e.push([F.LocalAudioTrack,n]),e;let i=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return t===o});if(i)if(i[0]===F.LocalVideoTrack){e.push(i);let r=this.localTrackMap.get(F.LocalVideoLowTrack);r&&e.push([F.LocalVideoLowTrack,r]);}else e.push(i);return e}createMuteMessage(t){return t.map(e=>{var n;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case F.LocalAudioTrack:i=jt.Audio;break;case F.LocalVideoTrack:i=q(n=o._hints).call(n,ie.SCREEN_TRACK)?jt.Screen:jt.High;break;case F.LocalVideoLowTrack:i=jt.Low;}return {stream_type:i,ssrcs:s,mid:a}})}createUnmuteMessage(t){return t.map(e=>{var n;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case F.LocalAudioTrack:i=jt.Audio;break;case F.LocalVideoTrack:i=q(n=o._hints).call(n,ie.SCREEN_TRACK)?jt.Screen:jt.High;break;case F.LocalVideoLowTrack:i=jt.Low;}return {stream_type:i,ssrcs:s,mid:a}})}filterTobeUnSubscribedTracks(t,e){let n=[],i=this.remoteUserMap.get(t);if(!i)return n;if(e){let r=i.get(e);if(!r)return n;n.push([t,{kind:e,id:r}]);}else Array.from(i.entries()).forEach(r=>{let[o,s]=r;n.push([t,{kind:o,id:s}]);});return n}createUnsubscribeMessage(t){let e=[];return t.forEach(n=>{let[i,{kind:r,id:o}]=n;switch(r){case tt.VIDEO:return void(i._videoSSRC&&e.push({stream_type:tt.VIDEO,ssrcId:i._videoSSRC}));case tt.AUDIO:return void(i._audioSSRC&&e.push({stream_type:tt.AUDIO,ssrcId:i._audioSSRC}))}}),e}withdrawRemoteTracks(t){t.forEach(e=>{let[n,{kind:i}]=e,r=this.remoteUserMap.get(n);r&&(r.delete(i),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(n));});}async updateBitrateLimit(t){let e=this.localTrackMap.get(F.LocalVideoTrack),n=this.localTrackMap.get(F.LocalVideoLowTrack);e&&await e.track.setBitrateLimit(t.uplink),n&&t.low_stream_uplink&&await n.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0});}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){let t=this.sendConnection.peerConnectionState,e=this.recvConnection.peerConnectionState;return t!=="connected"&&e!=="connected"}return !0}async tryToUnmuteAudio(t){for(let e=0;e<t.length;e++)if(t[e]instanceof Re){let n=this.filterTobeUnmutedTracks(t[e]);if(n.length===0)continue;let i=this.createUnmuteMessage(n);return void await Qt(this,ct.RequestUnmuteLocal,i)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=t=>this.getStats(t),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter(t=>{let[,{ssrcs:e}]=t;return !!e}),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return !((e=this.recvConnection)===null||e===void 0||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(ct.RequestUpload,t,e),this.statsUploader.requestUploadStats=t=>this.emit(ct.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks();}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0;}async requestReconnect(){this.dtlsFailedCount+=1,await Ye(Ql(this.dtlsFailedCount,Ne)),this.emit(ct.RequestReconnect);}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(F.LocalVideoTrack)||this.pendingLocalTracks.some(t=>t instanceof $t)}throwIfTrackTypeNotMatch(t){if(t.filter(e=>e instanceof $t).length>1)throw new D(R.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter(e=>e instanceof Re).length>1&&(t.some(e=>e instanceof Re&&e._bypassWebAudio)||!Ot().webAudioMediaStreamDest))throw new D(R.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(let e of t){if(e instanceof $t&&this.pendingLocalTracks.some(n=>n instanceof $t))throw new D(R.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof Re&&this.pendingLocalTracks.some(n=>n instanceof Re)&&(!Ot().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some(n=>n instanceof Re&&n._bypassWebAudio)))throw new D(R.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){let n=!v("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ot().supportDualStreamEncoding,i=zu(zu({},{width:160,height:120,framerate:15,bitrate:50}),e),r;r=n?t._mediaStreamTrack.clone():$E(t,i);let o=Zt(8,"track-low-"),s=new $t(r,zu(zu({},n&&{scaleResolutionDownBy:Om(i,t)}),{},{frameRate:i.framerate,bitrateMax:i.bitrate,bitrateMin:i.bitrate}),void 0,void 0,o);return s.on(Os.TRANSCEIVER_UPDATED,a=>{t._updateRtpTransceiver(a,Fa.LOW_STREAM);}),s._hints.push(ie.LOW_STREAM),t.addListener(J.NEED_CLOSE,()=>{s.close();}),s}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(t,e,n,i){var r;let o=Array.from(ri(r=this.remoteUserMap).call(r)).find(s=>s._videoSSRC===t);if(o){i||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());let s=this.store.keyMetrics,a=s.subscribe.find(c=>c.userId===o.uid&&c.type==="video");et.firstRemoteVideoDecode(this.store.sessionId,Ze.FIRST_VIDEO_DECODE,_e.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:e,videoheight:n,subscribeElapse:fn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:s.requestAPEnd||0,apStart:s.requestAPStart||0,joinGwEnd:s.joinGatewayEnd||0,joinGwStart:s.joinGatewayStart||0,pcEnd:s.peerConnectionEnd||0,pcStart:s.peerConnectionStart||0,subscriberEnd:a?.subscribeEnd||0,subscriberStart:a?.subscribeStart||0,videoAddNotify:a?.streamAdded||0,state:i?1:0});}}async remoteMediaSsrcChanged(t,e,n){if(!this.recvConnection)return !1;let i=this.remoteUserMap.get(t);if(!i)return !1;let r=i.get(e);if(!r)return !1;let o=await this.recvConnection.getRemoteSSRC(r);return o!==void 0&&o!==n}resetConnection(t){_.debug("[".concat(this.store.clientId,"] [P2PChannel2] reset connection to ").concat(t)),this.state===Gt.Connected?(_.debug("[".concat(this.store.clientId,"] [P2PChannel2] fallback to websocket but P2PChannel2 state still connected, disconnect first")),this.disconnectForReconnect()):(this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0));}async publishDataChannel(t){throw new D(R.NOT_SUPPORTED)}async unpublishDataChannel(t){throw new D(R.NOT_SUPPORTED)}async subscribeDataChannel(t,e){throw new D(R.NOT_SUPPORTED)}async unsubscribeDataChannel(t,e){throw new D(R.NOT_SUPPORTED)}hasPendingRemoteDataChannel(t,e){throw new D(R.NOT_SUPPORTED)}setPendingRemoteDataChannel(t,e){throw new D(R.NOT_SUPPORTED)}async preConnect(t,e,n,i,r,o){throw new D(R.NOT_SUPPORTED)}getEstablishParams(){throw new D(R.NOT_SUPPORTED)}async reSubscribe(t){throw new D(R.NOT_SUPPORTED)}async updateVideoStreamParameter(t,e){throw new D(R.NOT_SUPPORTED)}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(t=>{let[e,{track:n}]=t;e===F.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,Fa.LOW_STREAM):n._updateRtpTransceiver(void 0);});}},W(he.prototype,"p2pConnect",[oO],Object.getOwnPropertyDescriptor(he.prototype,"p2pConnect"),he.prototype),W(he.prototype,"unpublish",[sO],Object.getOwnPropertyDescriptor(he.prototype,"unpublish"),he.prototype),W(he.prototype,"unpublishLowStream",[aO],Object.getOwnPropertyDescriptor(he.prototype,"unpublishLowStream"),he.prototype),W(he.prototype,"subscribe",[cO],Object.getOwnPropertyDescriptor(he.prototype,"subscribe"),he.prototype),W(he.prototype,"mockSubscribe",[dO],Object.getOwnPropertyDescriptor(he.prototype,"mockSubscribe"),he.prototype),W(he.prototype,"unsubscribe",[lO],Object.getOwnPropertyDescriptor(he.prototype,"unsubscribe"),he.prototype),W(he.prototype,"muteRemote",[uO],Object.getOwnPropertyDescriptor(he.prototype,"muteRemote"),he.prototype),W(he.prototype,"unmuteRemote",[hO],Object.getOwnPropertyDescriptor(he.prototype,"unmuteRemote"),he.prototype),W(he.prototype,"hasRemoteMediaWithLock",[pO],Object.getOwnPropertyDescriptor(he.prototype,"hasRemoteMediaWithLock"),he.prototype),W(he.prototype,"disconnectForReconnect",[_O],Object.getOwnPropertyDescriptor(he.prototype,"disconnectForReconnect"),he.prototype),W(he.prototype,"remoteMediaSsrcChanged",[mO],Object.getOwnPropertyDescriptor(he.prototype,"remoteMediaSsrcChanged"),he.prototype),he);function fr(t){return function(e,n,i){let r=e[n];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){for(var o=arguments.length,s=new Array(o),a=0;a<o;a++)s[a]=arguments[a];switch(t){case Er.SEND_ONLY:{let c=await this.sendMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,s)}finally{c();}}case Er.RECEIVE_ONLY:{let c=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,s)}finally{c();}}default:{let c=await this.sendMutex.lock("From P2PChannel2.".concat(n)),d=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,s)}finally{c(),d();}}}},i}}function fO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function xs(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?fO(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):fO(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}class Id{constructor(e){g(this,"store",void 0),g(this,"onStatsException",void 0),g(this,"onUploadPublishDuration",void 0),g(this,"onStatsChanged",void 0),g(this,"localStats",new Map),g(this,"remoteStats",new Map),g(this,"updateStatsInterval",void 0),g(this,"trafficStats",void 0),g(this,"trafficStatsPeerList",[]),g(this,"uplinkStats",void 0),g(this,"exceptionMonitor",void 0),g(this,"p2pChannel",void 0),g(this,"scalabilityMode",Oj.L1T1),g(this,"updateStats",()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel));}),this.store=e,this.exceptionMonitor=new D3,this.exceptionMonitor.on("exception",(n,i,r)=>{this.onStatsException&&this.onStatsException(n,i,r);});}startUpdateStats(){this.updateStatsInterval||(this.updateStatsInterval=window.setInterval(this.updateStats,1e3));}stopUpdateStats(){this.updateStatsInterval&&(window.clearInterval(this.updateStatsInterval),this.updateStatsInterval=void 0);}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0;}getLocalAudioTrackStats(){return this.localStats.get(F.LocalAudioTrack)||xs({},NE)}getLocalVideoTrackStats(){return this.localStats.get(F.LocalVideoTrack)||xs({},DE)}getRemoteAudioTrackStats(e){let n=(o,s)=>{if(!this.trafficStats)return s;let a=this.trafficStats.peer_delay.find(c=>c.peer_uid===o);return a&&(s.publishDuration=a.B_ppad+(Date.now()-this.trafficStats.timestamp)),s},i={};if(e){var r;let o=(r=this.remoteStats.get(e))===null||r===void 0?void 0:r.audioStats;o&&(i[e]=n(e,o));}else Array.from(this.remoteStats.entries()).forEach(o=>{let[s,{audioStats:a}]=o;a&&(i[s]=n(s,a));});return i}getRemoteNetworkQualityStats(e){let n={};if(e){var i;let r=(i=this.remoteStats.get(e))===null||i===void 0?void 0:i.networkStats;r&&(n[e]=r);}else Array.from(this.remoteStats.entries()).forEach(r=>{let[o,{networkStats:s}]=r;s&&(n[o]=s);});return n}getRemoteVideoTrackStats(e){let n=(o,s)=>{if(!this.trafficStats)return s;let a=this.trafficStats.peer_delay.find(c=>c.peer_uid===o);return a&&(s.publishDuration=a.B_ppvd+(Date.now()-this.trafficStats.timestamp)),s},i={};if(e){var r;let o=(r=this.remoteStats.get(e))===null||r===void 0?void 0:r.videoStats;o&&(i[e]=n(e,o));}else Array.from(this.remoteStats.entries()).forEach(o=>{let[s,{videoStats:a}]=o;a&&(i[s]=n(s,a));});return i}getRTCStats(){let e=0,n=0,i=0,r=0,o=this.localStats.get(F.LocalAudioTrack);o&&(e+=o.sendBytes,n+=o.sendBitrate);let s=this.localStats.get(F.LocalVideoTrack);s&&(e+=s.sendBytes,n+=s.sendBitrate);let a=this.localStats.get(F.LocalVideoLowTrack);a&&(e+=a.sendBytes,n+=a.sendBitrate),this.remoteStats.forEach(d=>{let{audioStats:l,videoStats:u}=d;l&&(i+=l.receiveBytes,r+=l.receiveBitrate),u&&(i+=u.receiveBytes,r+=u.receiveBitrate);});let c=1;return this.trafficStats&&(c+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:c,SendBitrate:n,SendBytes:e,RecvBytes:i,RecvBitrate:r,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(e){this.localStats.set(e,void 0);}removeLocalStats(e){e?this.localStats.delete(e):this.localStats.clear();}addRemoteStats(e){this.remoteStats.set(e,{});}removeRemoteStats(e){e?this.remoteStats.delete(e):this.remoteStats.clear();}addP2PChannel(e){this.p2pChannel=e;}updateTrafficStats(e){e.peer_delay=e.peer_delay.filter(n=>n.B_ppad!==void 0||n.B_ppvd!==void 0),e.peer_delay.filter(n=>this.trafficStatsPeerList.indexOf(n.peer_uid)===-1).forEach(n=>{var i;let r=(i=this.p2pChannel)===null||i===void 0?void 0:i.getRemoteMedia(n.peer_uid),o=r!=null&&r.videoSSRC?fn.measureFromSubscribeStart(this.store.clientId,r.videoSSRC):0,s=r!=null&&r.audioSSRC?fn.measureFromSubscribeStart(this.store.clientId,r.audioSSRC):0;n.B_ppad!==void 0&&n.B_ppvd!==void 0&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(n.peer_uid,n.B_ppad,n.B_ppvd,o>s?o:s),this.trafficStatsPeerList.push(n.peer_uid));}),this.trafficStats=e;}updateUplinkStats(e){this.uplinkStats&&this.uplinkStats.B_fir!==e.B_fir&&_.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(e.B_fir)),this.uplinkStats=e;}static isRemoteVideoFreeze(e,n,i){if(!e)return !1;let r=!!i&&n.framesDecodeFreezeTime>i.framesDecodeFreezeTime,o=!i||n.framesDecodeCount>i.framesDecodeCount;return r||!o}static isRemoteAudioFreeze(e){return !!e&&e._isFreeze()}isLocalVideoFreeze(e){return !(!e.inputFrame||!e.sentFrame)&&e.inputFrame.frameRate>5&&e.sentFrame.frameRate<3}updateLocalStats(e){Array.from(this.localStats.entries()).forEach(n=>{let[i,r]=n;switch(i){case F.LocalVideoTrack:case F.LocalVideoLowTrack:{let s=r,a=xs({},DE),c=e.getStats(),d=e.getLocalMedia(i);if(c){let l=c.videoSend.find(u=>u.ssrc===d?.ssrcs[0].ssrcId);if(l){let u=e.getLocalVideoSize(),h=e.getEncoderConfig(F.LocalVideoTrack);l.codec!=="H264"&&l.codec!=="H265"&&l.codec!=="VP8"&&l.codec!=="VP9"&&l.codec!=="AV1X"&&l.codec!=="AV1"||(a.codecType=l.codec),a.sendBytes=l.bytes,a.sendBitrate=s?8*Math.max(0,a.sendBytes-s.sendBytes):0,l.inputFrame?(a.captureFrameRate=l.inputFrame.frameRate,a.captureResolutionHeight=l.inputFrame.height,a.captureResolutionWidth=l.inputFrame.width):u&&(a.captureResolutionWidth=u.width,a.captureResolutionHeight=u.height),l.sentFrame?(a.sendFrameRate=l.sentFrame.frameRate,a.sendResolutionHeight=l.sentFrame.height,a.sendResolutionWidth=l.sentFrame.width):u&&(a.sendResolutionWidth=u.width,a.sendResolutionHeight=u.height),l.avgEncodeMs&&(a.encodeDelay=l.avgEncodeMs),h&&h.bitrateMax&&(a.targetSendBitrate=1e3*h.bitrateMax),a.sendPackets=l.packets,a.sendPacketsLost=l.packetsLost,a.sendJitterMs=l.jitterMs,a.sendRttMs=l.rttMs,a.totalDuration=s?s.totalDuration+1:1,a.totalFreezeTime=s?s.totalFreezeTime:0,this.isLocalVideoFreeze(l)&&(a.totalFreezeTime+=1),l.scalabilityMode&&this.scalabilityMode!==l.scalabilityMode&&(_.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(l.scalabilityMode)),this.scalabilityMode=l.scalabilityMode);}this.trafficStats&&(a.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100);}var o;this.localStats.set(i,a),(s?.sendResolutionWidth!==a.sendResolutionWidth||s?.sendResolutionHeight!==a.sendResolutionHeight)&&((o=this.onStatsChanged)===null||o===void 0||o.call(this,"resolution",{width:a.sendResolutionWidth,height:a.sendResolutionHeight})),a&&d&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,d.track,a);break}case F.LocalAudioTrack:{let s=r,a=xs({},NE),c=e.getStats(),d=e.getLocalMedia(i);if(c){let l=c.audioSend.find(u=>u.ssrc===d?.ssrcs[0].ssrcId);if(l){if(l.codec!=="opus"&&l.codec!=="aac"&&l.codec!=="PCMU"&&l.codec!=="PCMA"&&l.codec!=="G722"||(a.codecType=l.codec),l.inputLevel)a.sendVolumeLevel=Math.round(32767*l.inputLevel);else {let u=e.getLocalAudioVolume();u&&(a.sendVolumeLevel=Math.round(32767*u));}a.sendBytes=l.bytes,a.sendPackets=l.packets,a.sendPacketsLost=l.packetsLost,a.sendJitterMs=l.jitterMs,a.sendRttMs=l.rttMs,a.sendBitrate=s?8*Math.max(0,a.sendBytes-s.sendBytes):0;}}this.trafficStats&&(a.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(F.LocalAudioTrack,a),a&&d&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,d.track,a);break}}});}updateRemoteStats(e){Array.from(this.remoteStats.entries()).forEach(n=>{var i,r;let[o,{videoStats:s,audioStats:a,videoPcStats:c}]=n,d=a,l=s,u=c,h=xs({},NA),p=xs({},DA),T=xs({},T3),{audioTrack:m,videoTrack:E,audioSSRC:S,videoSSRC:C}=e.getRemoteMedia(o),A;A=e instanceof ti?e.getStats(!0):e.getStats();let b=(i=A)===null||i===void 0?void 0:i.audioRecv.find(k=>k.ssrc===S),O=(r=A)===null||r===void 0?void 0:r.videoRecv.find(k=>k.ssrc===C),N=this.trafficStats&&this.trafficStats.peer_delay.find(k=>k.peer_uid===o);if(b&&(b.codec!=="opus"&&b.codec!=="aac"&&b.codec!=="PCMU"&&b.codec!=="PCMA"&&b.codec!=="G722"||(h.codecType=b.codec),b.outputLevel?h.receiveLevel=Math.round(32767*b.outputLevel):m&&(h.receiveLevel=Math.round(32767*m.getVolumeLevel())),h.receiveBytes=b.bytes,h.receivePackets=b.packets,h.receivePacketsLost=b.packetsLost,h.packetLossRate=h.receivePacketsLost/(h.receivePackets+h.receivePacketsLost),h.receiveBitrate=d?8*Math.max(0,h.receiveBytes-d.receiveBytes):0,h.totalDuration=d?d.totalDuration+1:1,h.totalFreezeTime=d?d.totalFreezeTime:0,h.freezeRate=h.totalFreezeTime/h.totalDuration,h.receiveDelay=b.jitterBufferMs,h.totalDuration>10&&Id.isRemoteAudioFreeze(m)&&(h.totalFreezeTime+=1)),O){O.codec!=="H264"&&O.codec!=="H265"&&O.codec!=="VP8"&&O.codec!=="VP9"&&O.codec!=="AV1X"&&O.codec!=="AV1"||(p.codecType=O.codec),p.receiveBytes=O.bytes,p.receiveBitrate=l?8*Math.max(0,p.receiveBytes-l.receiveBytes):0,p.decodeFrameRate=O.decodeFrameRate<0?0:O.decodeFrameRate,p.renderFrameRate=O.decodeFrameRate<0?0:O.decodeFrameRate,O.outputFrame&&(p.renderFrameRate=O.outputFrame.frameRate),O.receivedFrame?(p.receiveFrameRate=O.receivedFrame.frameRate,p.receiveResolutionHeight=O.receivedFrame.height,p.receiveResolutionWidth=O.receivedFrame.width):E&&(p.receiveResolutionHeight=E._videoHeight||0,p.receiveResolutionWidth=E._videoWidth||0),O.framesRateFirefox!==void 0&&(p.receiveFrameRate=Math.round(O.framesRateFirefox)),p.receivePackets=O.packets,p.receivePacketsLost=O.packetsLost,p.packetLossRate=p.receivePacketsLost/(p.receivePackets+p.receivePacketsLost),p.totalDuration=l?l.totalDuration+1:1,p.totalFreezeTime=l?l.totalFreezeTime:0,p.receiveDelay=O.jitterBufferMs||0;let k=!!C&&e.getRemoteVideoIsReady(C);E&&k&&Id.isRemoteVideoFreeze(E,O,u)&&(p.totalFreezeTime+=1),p.freezeRate=p.totalFreezeTime/p.totalDuration;}N&&(h.end2EndDelay=N.B_ad,p.end2EndDelay=N.B_vd,h.transportDelay=N.B_ed,p.transportDelay=N.B_ed,h.currentPacketLossRate=N.B_ealr4/100,p.currentPacketLossRate=N.B_evlr4/100,T.uplinkNetworkQuality=N.B_punq?N.B_punq:0,T.downlinkNetworkQuality=N.B_pdnq?N.B_pdnq:0),this.remoteStats.set(o,{audioStats:h,videoStats:p,videoPcStats:O,networkStats:T}),m&&this.exceptionMonitor.setRemoteAudioStats(m,h),E&&this.exceptionMonitor.setRemoteVideoStats(E,p);});}}function gO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function yd(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?gO(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):gO(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}class X3 extends de{constructor(e,n,i,r){super(),g(this,"spec",void 0),g(this,"token",void 0),g(this,"websocket",void 0),g(this,"pingpongTimer",void 0),g(this,"reconnectMode","retry"),g(this,"serviceMode",void 0),g(this,"reqId",0),g(this,"commandReqId",0),g(this,"handleWebSocketOpen",()=>{this.reconnectMode="retry",this.startPingPong();}),g(this,"handleWebSocketMessage",o=>{if(!o.data)return;let s=JSON.parse(o.data);s.requestId?this.emit("@".concat(s.requestId,"-").concat(s.sid),s):this.serviceMode===$e.INJECT?this.emit(Nr.INJECT_STREAM_STATUS,s):(et.workerEvent(this.spec.sid,{actionType:"status",serverCode:s.code,workerType:this.serviceMode===$e.TRANSCODE?1:2}),this.emit(Nr.PUBLISH_STREAM_STATUS,s));}),this.spec=n,this.token=e,this.serviceMode=r,this.websocket=new Yc("live-streaming",i),this.websocket.on(dt.CONNECTED,this.handleWebSocketOpen),this.websocket.on(dt.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(dt.REQUEST_NEW_URLS,(o,s)=>{Me(this,Nr.REQUEST_NEW_ADDRESS).then(o).catch(s);}),this.websocket.on(dt.RECONNECTING,()=>{this.websocket.reconnectMode=this.reconnectMode;});}init(e){return this.websocket.init(e)}async request(e,n,i,r){this.reqId+=1,e==="request"&&(this.commandReqId+=1);let o=this.commandReqId,s=this.reqId;if(!s||!this.websocket)throw new w(R.UNEXPECTED_ERROR);let a=yd({command:e,sdkVersion:vi==="4.21.0"?"0.0.1":vi,seq:s,requestId:s,allocate:i,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},n);if(this.websocket.state==="closed")throw new w(R.WS_DISCONNECT);let c=()=>new K((h,p)=>{this.websocket.once(dt.CLOSED,()=>p(new w(R.WS_ABORT))),this.websocket.once(dt.CONNECTED,h);});this.websocket.state!=="connected"&&await c(),a.clientRequest&&(a.clientRequest.workerToken=this.token);let d=new K((h,p)=>{let T=()=>{p(new w(R.WS_ABORT));};this.websocket.once(dt.RECONNECTING,T),this.websocket.once(dt.CLOSED,T),this.once("@".concat(s,"-").concat(this.spec.sid),m=>{h(m);});});r&&et.workerEvent(this.spec.sid,yd(yd({},r),{},{requestId:o,actionType:"request",payload:JSON.stringify(n.clientRequest),serverCode:0,code:0}));let l=Date.now();this.websocket.sendMessage(a);let u=null;try{u=await d;}catch(h){if(this.websocket.state==="closed")throw h;return await c(),await this.request(e,n,i)}return r&&et.workerEvent(this.spec.sid,yd(yd({},r),{},{requestId:o,actionType:"response",payload:JSON.stringify(u.serverResponse),serverCode:u.code,success:u.code===200,responseTime:Date.now()-l})),u.code!==200&&this.handleResponseError(u),u}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext");}close(){let e=vi==="4.21.0"?"0.0.1":vi;this.reqId+=1,this.websocket.state==="connected"?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:e,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0);}handleResponseError(e){switch(e.code){case Be.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void _.warning("live stream response already exists stream");case Be.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case Be.LIVE_STREAM_RESPONSE_BAD_STREAM:case Be.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new w(R.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:e.code}).throw();case Be.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if(e.serverResponse.command==="UnpublishStream"||e.serverResponse.command==="UninjectStream")return;throw new w(R.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Be.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new w(R.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:e.code}).throw();case Be.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{let n=new w(R.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(Nr.WARNING,n,e.serverResponse.url)}case Be.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{let n=new w(R.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(Nr.WARNING,n,e.serverResponse.url)}case Be.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new w(R.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Be.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new w(R.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:e.code}).throw();case Be.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{let n=new w(R.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(Nr.WARNING,n,e.serverResponse.url)}case Be.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new w(R.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code}).throw();case Be.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new w(R.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case Be.LIVE_STREAM_RESPONSE_WORKER_LOST:case Be.LIVE_STREAM_RESPONSE_WORKER_QUIT:if(e.serverResponse.command==="UnpublishStream"||e.serverResponse.command==="UninjectStream")return;throw new w(R.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Be.ERROR_FAIL_SEND_MESSAGE:if(e.serverResponse.command==="UnpublishStream"||e.serverResponse.command==="UninjectStream")return;if(e.serverResponse.command==="UpdateTranscoding"||e.serverResponse.command==="ControlStream")return new w(R.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:e.code}).throw();throw new w(R.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Be.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Be.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Be.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Be.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new w(R.LIVE_STREAMING_CDN_ERROR,"",{code:e.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(()=>{this.websocket.state==="connected"&&this.request("ping",{}).catch(Jl);},6e3);}}function TO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function Vn(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?TO(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):TO(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}class Q3 extends de{constructor(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ne,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Ne;super(),g(this,"onLiveStreamWarning",void 0),g(this,"onLiveStreamError",void 0),g(this,"onInjectStatusChange",void 0),g(this,"spec",void 0),g(this,"retryTimeout",1e4),g(this,"connection",void 0),g(this,"httpRetryConfig",void 0),g(this,"wsRetryConfig",void 0),g(this,"streamingTasks",new Map),g(this,"isStartingStreamingTask",!1),g(this,"taskMutex",new Qe("live-streaming")),g(this,"cancelToken",Mn.CancelToken.source()),g(this,"transcodingConfig",void 0),g(this,"injectConfig",Vn({},Pj)),g(this,"injectLoopTimes",0),g(this,"uapResponse",void 0),g(this,"lastTaskId",1),g(this,"statusError",new Map),this.spec=e,this.httpRetryConfig=i,this.wsRetryConfig=n;}async setTranscodingConfig(e){let n=Vn(Vn({},Dj),e);n.videoCodecProfile!==66&&n.videoCodecProfile!==77&&n.videoCodecProfile!==100&&(_.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(n.videoCodecProfile," -> 100")),n.videoCodecProfile=100),n.transcodingUsers||(n.transcodingUsers=n.userConfigs),n.transcodingUsers&&(n.transcodingUsers=n.transcodingUsers.map(s=>Vn(Vn(Vn({},Nj),s),{},{zOrder:s.zOrder?s.zOrder+1:1}))),function(s){fe(s.width)||zt(s.width,"config.width",0,1e4),fe(s.height)||zt(s.height,"config.height",0,1e4),fe(s.videoBitrate)||zt(s.videoBitrate,"config.videoBitrate",1,1e6),fe(s.videoFrameRate)||zt(s.videoFrameRate,"config.videoFrameRate"),fe(s.lowLatency)||Xr(s.lowLatency,"config.lowLatency"),fe(s.audioSampleRate)||Ge(s.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),fe(s.audioBitrate)||zt(s.audioBitrate,"config.audioBitrate",1,128),fe(s.audioChannels)||Ge(s.audioChannels,"config.audioChannels",[1,2,3,4,5]),fe(s.videoGop)||zt(s.videoGop,"config.videoGop"),fe(s.videoCodecProfile)||Ge(s.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),fe(s.userCount)||zt(s.userCount,"config.userCount",0,17),fe(s.backgroundColor)||zt(s.backgroundColor,"config.backgroundColor",0,16777215),fe(s.userConfigExtraInfo)||rn(s.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),s.transcodingUsers&&!fe(s.transcodingUsers)&&(Qr(s.transcodingUsers,"config.transcodingUsers"),s.transcodingUsers.forEach((a,c)=>{iu(a.uid),fe(a.x)||zt(a.x,"transcodingUser[".concat(c,"].x"),0,1e4),fe(a.y)||zt(a.y,"transcodingUser[".concat(c,"].y"),0,1e4),fe(a.width)||zt(a.width,"transcodingUser[".concat(c,"].width"),0,1e4),fe(a.height)||zt(a.height,"transcodingUser[".concat(c,"].height"),0,1e4),fe(a.zOrder)||zt(a.zOrder-1,"transcodingUser[".concat(c,"].zOrder"),0,100),fe(a.alpha)||zt(a.alpha,"transcodingUser[".concat(c,"].alpha"),0,1,!1);})),fe(s.watermark)||ym(s.watermark,"watermark"),fe(s.backgroundImage)||ym(s.backgroundImage,"backgroundImage"),s.images&&!fe(s.images)&&(Qr(s.images,"config.images"),s.images.forEach((a,c)=>{ym(a,"images[".concat(c,"]"));}));}(n);let i=[];n.images&&i.push(...n.images.map(s=>Vn(Vn(Vn({},Im),s),{},{zOrder:255}))),n.backgroundImage&&(i.push(Vn(Vn(Vn({},Im),n.backgroundImage),{},{zOrder:0})),delete n.backgroundImage),n.watermark&&(i.push(Vn(Vn(Vn({},Im),n.watermark),{},{zOrder:255})),delete n.watermark),n.images=i,n.transcodingUsers&&(n.userConfigs=n.transcodingUsers.map(s=>Vn({},s)),n.userCount=n.transcodingUsers.length,delete n.transcodingUsers);let r=(n.userConfigs||[]).map(s=>typeof s.uid=="number"?K.resolve(s.uid):iy(s.uid,this.spec,this.cancelToken.token,this.httpRetryConfig));if((await K.all(r)).forEach((s,a)=>{n.userConfigs&&n.userConfigs[a]&&(n.userConfigs[a].uid=s);}),this.transcodingConfig=n,this.connection)try{var o;let s=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(cr(o=this.streamingTasks).call(o)).map(a=>a.taskId).join("#")});_.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(s.code,", config:"),JSON.stringify(this.transcodingConfig));}catch(s){if(!s.data||!s.data.retry)throw s;s.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach(a=>{_.warning("[".concat(this.spec.clientId,"] live streaming receive error"),s.toString(),"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,s).then(()=>{_.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(a.url," success"));}).catch(c=>{_.error("[".concat(this.spec.clientId,"] live streaming republish failed"),a.url,c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c);});});}}setInjectStreamConfig(e,n){this.injectConfig=Object.assign({},this.injectConfig,e),this.injectLoopTimes=n;}async startLiveStreamingTask(e,n,i){var r;if(Array.from(cr(r=this.streamingTasks).call(r)).find(d=>d.mode===$e.INJECT)&&n===$e.INJECT)return new w(R.LIVE_STREAMING_TASK_CONFLICT,"inject stream over limit").throw();if(!this.transcodingConfig&&n===$e.TRANSCODE)throw new w(R.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let s={command:"PublishStream",ts:Date.now(),url:e,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};_.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(e,", mode: ").concat(n));let a=await this.taskMutex.lock();if(!this.connection&&i)return void a();if(this.streamingTasks.get(e)&&!i)return a(),new w(R.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(n));}catch(d){throw a(),d}switch(n){case $e.TRANSCODE:s.transcodingConfig=Vn({},this.transcodingConfig);break;case $e.RAW:break;case $e.INJECT:s={cname:this.spec.cname,command:"InjectStream",sid:this.spec.sid,transcodingConfig:this.injectConfig,ts:Date.now(),url:e,loopTimes:this.injectLoopTimes};}this.uapResponse&&this.uapResponse.vid&&(s.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;let c=this.lastTaskId++;try{let d=new K((u,h)=>{Ye(this.retryTimeout).then(()=>{if(i)return h(i);let p=this.statusError.get(e);return p?(this.statusError.delete(e),h(p)):void 0});}),l=await K.race([this.connection.request("request",{clientRequest:s},!0,{url:e,command:"PublishStream",workerType:n===$e.TRANSCODE?1:2,requestByUser:!i,tid:c.toString()}),d]);this.isStartingStreamingTask=!1,_.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(l.code)),this.streamingTasks.set(e,{clientRequest:s,mode:n,url:e,taskId:c}),a();}catch(d){if(a(),this.isStartingStreamingTask=!1,!d.data||!d.data.retry||i)throw d;return d.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(e,n,d)):await this.startLiveStreamingTask(e,n,d)}}stopLiveStreamingTask(e){return new K((n,i)=>{let r=this.streamingTasks.get(e);if(!r||!this.connection)return new w(R.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();let o=r.mode;r.abortTask=()=>{_.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(e),n();},this.connection.request("request",{clientRequest:{command:o===$e.INJECT?"UninjectStream":"UnpublishStream",url:r.url}},!1,{url:e,command:"UnPublishStream",workerType:o===$e.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then(s=>{_.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(s.code)),this.streamingTasks.delete(e),this.streamingTasks.size===0&&o!==$e.INJECT&&(this.connection&&this.connection.close(),this.connection=void 0),n(),o===$e.INJECT&&this.onInjectStatusChange&&this.onInjectStatusChange(Ta.INJECT_STREAM_STATUS_STOP_SUCCESS,this.spec.uid,e);}).catch(i);})}async controlInjectStream(e,n,i,r){let o=this.streamingTasks.get(e);if(!o||!this.connection||o.mode!==$e.INJECT)throw new w(R.INVALID_OPERATION,"can not find inject stream task to control");return (await this.connection.request("request",{clientRequest:{command:"ControlStream",url:e,control:n,audioVolume:i,position:r}})).serverResponse}resetAllTask(){var e;let n=Array.from(cr(e=this.streamingTasks).call(e));this.terminate();for(let i of n)this.startLiveStreamingTask(i.url,i.mode).catch(r=>{this.onLiveStreamError&&this.onLiveStreamError(i.url,r);});}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=Mn.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0;}async connect(e){if(this.connection)throw new w(R.UNEXPECTED_ERROR,"live streaming connection has already connected");let n=await Me(this,ru.REQUEST_WORKER_MANAGER_LIST,e);return this.uapResponse=n,this.connection=new X3(n.workerToken,this.spec,this.wsRetryConfig,e),this.connection.on(Nr.WARNING,(i,r)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(r,i)),this.connection.on(Nr.PUBLISH_STREAM_STATUS,i=>this.handlePublishStreamServer(i)),this.connection.on(Nr.INJECT_STREAM_STATUS,i=>this.handleInjectStreamServerStatus(i)),this.connection.on(Nr.REQUEST_NEW_ADDRESS,(i,r)=>{if(!this.connection)return r(new w(R.UNEXPECTED_ERROR,"can not get new live streaming address list"));Me(this,ru.REQUEST_WORKER_MANAGER_LIST,e).then(o=>{this.uapResponse=o,i(o.addressList);}).catch(r);}),await this.connection.init(n.addressList),this.connection}handlePublishStreamServer(e){let n=e.serverStatus&&e.serverStatus.url||"empty_url",i=this.streamingTasks.get(n),r=e.reason;switch(e.code){case Be.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Be.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Be.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Be.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{let s=new w(R.LIVE_STREAMING_CDN_ERROR,"",{code:e.code});if(i)return _.error(s.toString()),this.onLiveStreamError&&this.onLiveStreamError(n,s);if(!this.isStartingStreamingTask)return;this.statusError.set(n,s);}case Be.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{let s=new w(R.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,r);return this.onLiveStreamWarning&&this.onLiveStreamWarning(n,s)}case Be.LIVE_STREAM_RESPONSE_WORKER_LOST:case Be.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var o;if(!this.connection)return;this.connection.tryNextAddress();let s=Array.from(cr(o=this.streamingTasks).call(o));for(let a of s)a.abortTask?a.abortTask():(_.warning("[".concat(this.spec.clientId,"] publish stream status code"),e.code,"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,new w(R.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code})).then(()=>{_.debug("[".concat(this.spec.clientId,"] republish live stream success"),a.url);}).catch(c=>{_.error(c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c);}));return}}}handleInjectStreamServerStatus(e){let n=Number(e.uid),i=e.serverStatus&&e.serverStatus.url;switch(e.code){case 200:return void(this.onInjectStatusChange&&this.onInjectStatusChange(Ta.INJECT_STREAM_STATUS_START_SUCCESS,n,i));case 451:return this.onInjectStatusChange&&this.onInjectStatusChange(Ta.INJECT_STREAM_STATUS_START_ALREADY_EXISTS,n,i),void this.streamingTasks.delete(i);case 453:return this.onInjectStatusChange&&this.onInjectStatusChange(Ta.INJECT_STREAM_STATUS_START_UNAUTHORIZED,n,i),void this.streamingTasks.delete(i);case 470:return this.onInjectStatusChange&&this.onInjectStatusChange(Ta.INJECT_STREAM_STATUS_BROKEN,n,i),void this.streamingTasks.delete(i);case 499:return this.onInjectStatusChange&&this.onInjectStatusChange(Ta.INJECT_STREAM_STATUS_START_TIMEOUT,n,i),void this.streamingTasks.delete(i);default:return void _.debug("inject stream server status",e)}}hasUrl(e){return this.streamingTasks.has(e)}}class SO{constructor(){g(this,"destChannelMediaInfos",new Map),g(this,"srcChannelMediaInfo",void 0);}setSrcChannelInfo(e){DI(e),this.srcChannelMediaInfo=e;}addDestChannelInfo(e){DI(e),this.destChannelMediaInfos.set(e.channelName,e);}removeDestChannelInfo(e){nu(e),this.destChannelMediaInfos.delete(e);}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function RO(t){if(!(t instanceof SO))return new w(R.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();let e=t.getSrcChannelMediaInfo(),n=t.getDestChannelMediaInfo();if(!e)return new w(R.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw();if(n.size===0)return new w(R.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}class Z3 extends de{constructor(e,n,i){super(),g(this,"ws",void 0),g(this,"requestId",1),g(this,"heartBeatTimer",void 0),g(this,"joinInfo",void 0),g(this,"clientId",void 0),g(this,"onOpen",()=>{this.emit("open"),this.startHeartBeatCheck();}),g(this,"onClose",r=>{this.emit("close"),this.dispose();}),g(this,"onMessage",r=>{let o=JSON.parse(r.data);if(!o||o.command!=="serverResponse"||!o.requestId)return o&&o.command==="serverStatus"&&o.serverStatus&&o.serverStatus.command?(this.emit("status",o.serverStatus),void this.emit(o.serverStatus.command,o.serverStatus)):void 0;this.emit("req_".concat(o.requestId),o);}),this.joinInfo=e,this.clientId=n,this.ws=new Yc("cross-channel-".concat(this.clientId),i),this.ws.on(dt.RECONNECTING,()=>{this.ws.reconnectMode="retry",this.emit("reconnecting");}),this.ws.on(dt.CONNECTED,this.onOpen),this.ws.on(dt.ON_MESSAGE,this.onMessage),this.ws.on(dt.CLOSED,this.onClose);}isConnect(){return this.ws.state==="connected"}sendMessage(e){let n=this.requestId++;return e.requestId=n,e.seq=n,this.ws.sendMessage(e),n}waitStatus(e){return new K((n,i)=>{let r=window.setTimeout(()=>{i(new w(R.TIMEOUT,"wait status timeout, status: ".concat(e)));},5e3);this.once(e,o=>{window.clearTimeout(r),o.state&&o.state!==0?i(new w(R.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(e))):n(void 0);}),this.once("dispose",()=>{window.clearTimeout(r),i(new w(R.WS_ABORT));});})}async request(e){if(this.ws.state==="closed")throw new w(R.WS_DISCONNECT);let n=()=>new K((s,a)=>{this.ws.once(dt.CLOSED,()=>a(new w(R.WS_ABORT))),this.ws.once(dt.CONNECTED,s);});this.ws.state!=="connected"&&await n();let i=this.sendMessage(e),r=new K((s,a)=>{let c=()=>{a(new w(R.WS_ABORT));};this.ws.once(dt.RECONNECTING,c),this.ws.once(dt.CLOSED,c),this.once("req_".concat(i),s),Ye(3e3).then(()=>{this.removeAllListeners("req_".concat(i)),this.ws.off(dt.RECONNECTING,c),this.ws.off(dt.CLOSED,c),a(new w(R.TIMEOUT,"cross channel ws request timeout"));});}),o=await r;if(!o||o.code!==200)throw new w(R.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(o)));return o}async connect(e){this.ws.removeAllListeners(dt.REQUEST_NEW_URLS),this.ws.on(dt.REQUEST_NEW_URLS,n=>{n(e);}),await this.ws.init(e);}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close();}sendPing(e){let n=this.requestId++;return e.requestId=n,this.ws.sendMessage(e),n}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval(()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0});},3e3);}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0;}}class $3 extends de{set state(e){e!==this._state&&(e!==Gn.RELAY_STATE_FAILURE&&(this.errorCode=Sa.RELAY_OK),this.emit("state",e,this.errorCode),this._state=e);}get state(){return this._state}constructor(e,n,i,r,o){super(),g(this,"joinInfo",void 0),g(this,"sid",void 0),g(this,"clientId",void 0),g(this,"cancelToken",Mn.CancelToken.source()),g(this,"workerToken",void 0),g(this,"requestId",0),g(this,"signal",void 0),g(this,"prevChannelMediaConfig",void 0),g(this,"httpRetryConfig",void 0),g(this,"_resolution",void 0),g(this,"_state",Gn.RELAY_STATE_IDLE),g(this,"errorCode",Sa.RELAY_OK),g(this,"onStatus",s=>{_.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(s))),s&&s.command&&(s.command==="onAudioPacketReceived"&&this.emit("event",Zr.PACKET_RECEIVED_AUDIO_FROM_SRC),s.command==="onVideoPacketReceived"&&this.emit("event",Zr.PACKET_RECEIVED_VIDEO_FROM_SRC),s.command==="onSrcTokenPrivilegeDidExpire"&&(this.errorCode=Sa.SRC_TOKEN_EXPIRED,this.state=Gn.RELAY_STATE_FAILURE),s.command==="onDestTokenPrivilegeDidExpire"&&(this.errorCode=Sa.DEST_TOKEN_EXPIRED,this.state=Gn.RELAY_STATE_FAILURE));}),g(this,"onReconnect",async()=>{_.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",Zr.NETWORK_DISCONNECTED),this.state=Gn.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch(s=>{this.state!==Gn.RELAY_STATE_IDLE&&(_.error("auto restart channel media relay failed",s.toString()),this.errorCode=Sa.SERVER_CONNECTION_LOST,this.state=Gn.RELAY_STATE_FAILURE);});}),this.joinInfo=e,this.clientId=n,this.sid=jc(),this.signal=new Z3(this.joinInfo,this.clientId,i),this.httpRetryConfig=r,this._resolution=o;}async startChannelMediaRelay(e){if(this.state!==Gn.RELAY_STATE_IDLE)throw new w(R.INVALID_OPERATION);this.state=Gn.RELAY_STATE_CONNECTING,await this.connect(),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(e);}catch(n){throw n.data&&n.data.serverResponse&&n.data.serverResponse.command==="SetSourceChannel"?new w(R.CROSS_CHANNEL_FAILED_JOIN_SRC):n.data&&n.data.serverResponse&&n.serverResponse.command==="SetDestChannelStatus"?new w(R.CROSS_CHANNEL_FAILED_JOIN_DEST):n.data&&n.data.serverResponse&&n.serverResponse.command==="StartPacketTransfer"?new w(R.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):n}this.prevChannelMediaConfig=e;}async updateChannelMediaRelay(e){if(this.state!==Gn.RELAY_STATE_RUNNING)throw new w(R.INVALID_OPERATION);await this.sendUpdateMessage(e),this.prevChannelMediaConfig=e;}async setVideoProfile(e){if(this._resolution=e,this.state!==Gn.RELAY_STATE_RUNNING)throw new w(R.INVALID_OPERATION);let n=this.genMessage(Pn.SetVideoProfile);await this.signal.request(n),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"));}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),_.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=Gn.RELAY_STATE_IDLE,this.dispose();}dispose(){_.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=Mn.CancelToken.source(),this.state=Gn.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0;}async connect(){let e=await Zj(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=e.workerToken,await this.signal.connect(e.addressList),this.emit("event",Zr.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect);}async sendStartRelayMessage(e){let n=this.genMessage(Pn.StopPacketTransfer);await this.signal.request(n),await this.signal.waitStatus("Normal Quit"),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));let i=this.genMessage(Pn.SetSdkProfile,e);await this.signal.request(i),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));let r=this.genMessage(Pn.SetSourceChannel,e);await this.signal.request(r),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",Zr.PACKET_JOINED_SRC_CHANNEL),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));let o=this.genMessage(Pn.SetSourceUserId,e);await this.signal.request(o),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));let s=this.genMessage(Pn.SetDestChannel,e);await this.signal.request(s),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",Zr.PACKET_JOINED_DEST_CHANNEL),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));let a=this.genMessage(Pn.StartPacketTransfer,e);await this.signal.request(a),this.emit("event",Zr.PACKET_SENT_TO_DEST_CHANNEL),this.state=Gn.RELAY_STATE_RUNNING,_.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution);}async sendUpdateMessage(e){let n=this.genMessage(Pn.UpdateDestChannel,e);await this.signal.request(n),this.emit("event",Zr.PACKET_UPDATE_DEST_CHANNEL),_.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"));}async sendStopRelayMessage(){let e=this.genMessage(Pn.StopPacketTransfer);await this.signal.request(e),_.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"));}genMessage(e,n){let i=[],r=[],o=[];this.requestId+=1;let s={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:vi,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};s.sdkVersion==="4.21.0"&&(s.sdkVersion="0.0.1");let a=null,c=null;switch(e){case Pn.SetSdkProfile:return s.clientRequest={command:"SetSdkProfile",type:"multi_channel"},s;case Pn.SetSourceChannel:if(c=n&&n.getSrcChannelMediaInfo(),!c)throw new w(R.UNEXPECTED_ERROR,"can not find source config");return s.clientRequest={command:"SetSourceChannel",uid:"0",channelName:c.channelName,token:c.token||this.joinInfo.appId},s;case Pn.SetSourceUserId:if(c=n&&n.getSrcChannelMediaInfo(),!c)throw new w(R.UNEXPECTED_ERROR,"can not find source config");return s.clientRequest={command:"SetSourceUserId",uid:c.uid+""},s;case Pn.SetDestChannel:if(a=n&&n.getDestChannelMediaInfo(),!a)throw new w(R.UNEXPECTED_ERROR,"can not find dest config");return a.forEach(d=>{i.push(d.channelName),r.push(d.uid+""),o.push(d.token||this.joinInfo.appId);}),s.clientRequest={command:"SetDestChannel",channelName:i,uid:r,token:o},s;case Pn.StartPacketTransfer:return s.clientRequest={command:"StartPacketTransfer"},s;case Pn.Reconnect:return s.clientRequest={command:"Reconnect"},s;case Pn.StopPacketTransfer:return s.clientRequest={command:"StopPacketTransfer"},s;case Pn.UpdateDestChannel:if(a=n&&n.getDestChannelMediaInfo(),!a)throw new w(R.UNEXPECTED_ERROR,"can not find dest config");return a.forEach(d=>{i.push(d.channelName),r.push(d.uid+""),o.push(d.token||this.joinInfo.appId);}),s.clientRequest={command:"UpdateDestChannel",channelName:i,uid:r,token:o},s;case Pn.SetVideoProfile:s.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height};}return s}}function Ju(t){var e={},n=!1;function i(r,o){return n=!0,{done:!1,value:new GE(o=new WE(function(s){s(t[r](o));}),1)}}return e[aa!==void 0&&HC||"@@iterator"]=function(){return this},e.next=function(r){return n?(n=!1,r):i("next",r)},typeof t.throw=="function"&&(e.throw=function(r){if(n)throw n=!1,r;return i("throw",r)}),typeof t.return=="function"&&(e.return=function(r){return n?(n=!1,r):i("return",r)}),e}var CO=j(Pw);function vO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function IO(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?vO(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):vO(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}var te;function yO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function AO(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?yO(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):yO(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}let Ja=(te=class Od extends su{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return [...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var n;return q(n=Object.keys(fa)).call(n,e)}))]}constructor(e,n){super(e,n),g(this,"store",void 0),g(this,"peerConnection",void 0),g(this,"remoteSDP",void 0),g(this,"initialOffer",void 0),g(this,"statsFilter",void 0),g(this,"useRTX",!1),g(this,"localCapabilities",void 0),g(this,"localCandidateCount",0),g(this,"allCandidatesReceived",!1),g(this,"establishPromise",void 0),g(this,"mutex",new Qe("P2PConnection-mutex")),this.store=n,this.peerConnection=new RTCPeerConnection(Od.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=Wu(this.peerConnection,v("STATS_UPDATE_INTERVAL"),void 0,Xt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish();}async establish(){try{let e=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let n=_r(e.sdp),i=vd(e.sdp,{filterRTX:!this.useRTX,filterVideoFec:v("FILTER_VIDEO_FEC"),filterAudioFec:v("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=i,this.initialOffer=e,AO(AO({},n),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:i},offerSDP:e.sdp})}catch(e){throw new D(R.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,n,i,r,o,s){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{constructor(c){g(this,"sessionDesc",void 0),g(this,"localCapabilities",void 0),g(this,"rtpCapabilities",void 0),g(this,"candidates",void 0),g(this,"iceParameters",void 0),g(this,"dtlsParameters",void 0),g(this,"setup",void 0),g(this,"currentMidIndex",void 0),g(this,"cname",void 0),c=ne(c);let{remoteIceParameters:d,remoteDtlsParameters:l,candidates:u,remoteRTPCapabilities:h,remoteSetup:p,localCapabilities:T,sdkCodec:m,cname:E}=c,S=ue.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE audio video
a=msid-semantic: WMS
a=ice-lite
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:audio
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:video
`);this.rtpCapabilities=h,this.candidates=u,this.iceParameters=d,this.dtlsParameters=l,this.setup=p,this.localCapabilities=T,this.cname=E;for(let C=0;C<S.mediaDescriptions.length;C++){let A=S.mediaDescriptions[C];if(A.attributes.iceUfrag=d.iceUfrag,A.attributes.icePwd=d.icePwd,A.attributes.fingerprints=l.fingerprints,A.attributes.candidates=u,A.attributes.setup=p,A.media.mediaType==="video"){A.media.fmts=h.videoCodecs.map(O=>O.payloadType.toString(10));let b=h.videoCodecs.filter(O=>{var N,k;return (N=O.rtpMap)===null||N===void 0?void 0:q(k=N.encodingName.toLowerCase()).call(k,m)});b.length===0&&(b=h.videoCodecs),A.attributes.payloads=b,A.attributes.extmaps=h.videoExtensions;}A.media.mediaType==="audio"&&(A.media.fmts=h.audioCodecs.map(b=>b.payloadType.toString(10)),A.attributes.payloads=h.audioCodecs,A.attributes.extmaps=h.audioExtensions),S.mediaDescriptions[C]=this.mungMediaDesc(A);}this.sessionDesc=S,this.currentMidIndex=S.mediaDescriptions.length-1;}toString(){return ue.print(this.sessionDesc)}send(c,d,l){let{ssrcs:u,ssrcGroups:h}=mi(d,this.cname),p=this.sessionDesc.mediaDescriptions.find(E=>c===tt.VIDEO?E.media.mediaType==="video":E.media.mediaType==="audio"),T=u[0].attributes.label,m=u[0].attributes.mslabel;return p.attributes.ssrcs=p.attributes.ssrcs.concat(u),p.attributes.ssrcGroups=p.attributes.ssrcGroups.concat(h),{id:T,mslabel:m}}batchSend(c){return c.map(d=>{let{kind:l,ssrcMsg:u}=d;return this.send(l,u,void 0)})}stopSending(c){this.sessionDesc.mediaDescriptions.forEach(d=>{let l=[],u=[],h=[];d.attributes.ssrcs.forEach(p=>{q(c).call(c,p.attributes.label||"")?h.push(p):l.push(p);}),d.attributes.ssrcGroups.forEach(p=>{var T;q(T=h.map(m=>m.ssrcId)).call(T,p.ssrcIds[0])||u.push(p);}),d.attributes.ssrcs=l,d.attributes.ssrcGroups=u;});}mute(c){let d=this.sessionDesc.mediaDescriptions.find(l=>l.attributes.mid===c);if(!d)throw new Error("mediaDescription not found with ".concat(c," in remote SDP when calling RemoteSDP.mute."));d.attributes.direction="inactive";}unmute(c){let d=this.sessionDesc.mediaDescriptions.find(l=>l.attributes.mid===c);if(!d)throw new Error("mediaDescription not found with ".concat(c," in remote SDP when calling RemoteSDP.unmute."));d.attributes.direction="sendonly";}receive(c,d,l){c.forEach((u,h)=>{let p=u._mediaStreamTrack,T=this.sessionDesc.mediaDescriptions.findIndex(E=>E.attributes.mid===p.kind),m=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[T],u);this.sessionDesc.mediaDescriptions[T]=m;});}stopReceiving(c){}updateCandidates(c){c===In.TCP?this.candidates.forEach(d=>{this.candidates.findIndex(l=>l.transport==="tcp"&&l.connectionAddress===d.connectionAddress&&l.port===d.port)===-1&&this.candidates.push(IO(IO({},d),{},{foundation:"tcpcandidate",priority:Number(d.priority)-1+"",transport:"tcp",port:Number(d.port)+90+""}));}):this.candidates=this.candidates.filter(d=>d.transport!=="tcp");for(let d of this.sessionDesc.mediaDescriptions)d.attributes.candidates=this.candidates;}restartICE(c){c=ne(c),this.iceParameters=c,this.sessionDesc.mediaDescriptions.forEach(d=>{d.attributes.iceUfrag=c.iceUfrag,d.attributes.icePwd=c.icePwd;});}predictReceivingMids(c){let d=[];for(let l=0;l<c;l++)d.push((this.currentMidIndex+l+1).toString(10));return d}mungRecvMediaDsec(c,d){let l=ne(c);return Fo(l,d),Ku(l,d),l}updateRecvMedia(c,d){let l=this.sessionDesc.mediaDescriptions.findIndex(u=>u.attributes.mid===c);if(l!==-1){let u=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[l],d);this.sessionDesc.mediaDescriptions[l]=u;}}bumpMid(c){this.currentMidIndex+=c;}updateTrackLabel(c,d,l){let u=this.sessionDesc.mediaDescriptions.find(p=>c===tt.VIDEO?p.attributes.mid==="video":p.attributes.mid==="audio");if(u){let p=u.attributes.ssrcs.find(T=>T.attributes.label===d);var h;p&&(p.attributes.label=l,(h=p.attributes.msid)===null||h===void 0||h.replace(d,l));}}mungMediaDesc(c){let d=ne(c);return Hu(d),function(l){let u=l.attributes.extmaps.find(h=>h.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");u&&l.attributes.extmaps.splice(l.attributes.extmaps.indexOf(u),1),l.attributes.payloads.forEach(h=>{let p=h.rtcpFeedbacks.findIndex(T=>T.type==="transport-cc");p!==-1&&h.rtcpFeedbacks.splice(p,1);});}(d),d}getSSRC(c){for(let d of this.sessionDesc.mediaDescriptions)for(let l of d.attributes.ssrcs)if(l.attributes.label===c)return [l]}}({remoteIceParameters:e,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r.send,remoteSetup:o,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec,cname:s});let a=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a});}catch(a){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(a.toString()))}}async updateRemoteRTPCapabilities(e,n){throw new D(R.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}send(e,n){var i=this;return $n(function*(){let r=yield gt(i.mutex.lock());try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");let o=e.map(h=>i.peerConnection.addTrack(h._mediaStreamTrack)),s=yield gt(i.peerConnection.createOffer()),a=ue.parse(s.sdp),c=e.map(h=>{let p=h._mediaStreamTrack,T=a.mediaDescriptions.find(m=>m.attributes.mid===p.kind);if(!T)throw new Error("Cannot extract ssrc from mediaDescription.");return function(m,E,S){let C=m.attributes.ssrcs.filter(b=>b.attributes.label===E),A=m.attributes.ssrcGroups;if(C.length===0)throw new Error("Cannot extract ssrc from plan-b SDP.");if(A&&C.length>1){let b=A.find(O=>O.ssrcIds.indexOf(C[0].ssrcId)!==-1);return b?[{ssrcId:b.ssrcIds[0],rtx:S?b.ssrcIds[1]:void 0}]:[{ssrcId:C[0].ssrcId}]}return [{ssrcId:C[0].ssrcId}]}(T,p.id,i.useRTX)}),d;try{d=yield c;}catch(h){throw o.forEach(p=>{Ke()&&p.replaceTrack(null),i.peerConnection.removeTrack(p);}),h}let l=i.mungSendOfferSDP(s.sdp,e);i.remoteSDP.receive(e,n,d);let u=i.remoteSDP.toString();return yield gt(i.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield gt(i.applySendEncodings(o,e)),yield gt(i.peerConnection.setRemoteDescription({type:"answer",sdp:u})),e.map((h,p)=>{let T=h._mediaStreamTrack.id;return {localSSRC:c[p],id:T}})}catch(o){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{r();}})()}async stopSending(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");let n=this.peerConnection.getSenders().filter(o=>{var s;return e.indexOf(((s=o.track)===null||s===void 0?void 0:s.id)||"")!==-1});if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");n.map(o=>{Ke()&&o.replaceTrack(null),this.peerConnection.removeTrack(o);});let i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(e);let r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r});}catch(n){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(n.toString()))}}async receive(e,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));let{id:o,mslabel:s}=this.remoteSDP.send(e,n,r),a=new K((l,u)=>{let h=setTimeout(()=>{u(new Error("Cannot receive track, id: ".concat(o)));},1e4),p=T=>{let m=Pt();if((m.name==="Safari"&&Number(m.version)===11||mn())&&T.track.id!==o&&T.streams[0].id===s){var E;let S=T.streams[0].getTracks()[0];return (E=this.remoteSDP)===null||E===void 0||E.updateTrackLabel(e,o,T.track.id),this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l(S)}if(T.track.id===o)return this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l(T.track)};this.peerConnection.addEventListener("track",p);}),c=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});let d=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(d),{track:await a,id:o}}catch(o){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);let n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});let i=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(i);}catch(n){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(e){}async unmuteRemote(e){}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");let n=this.peerConnection.getSenders().filter(i=>{var r;return e.indexOf(((r=i.track)===null||r===void 0?void 0:r.id)||"")!==-1});if(n.length!==e.length)throw new Error("sender' length doesn't match mids' length.");n.map(i=>{if(Ke()&&i.track)i.track.enabled=!1;else {let r=i.getParameters();r.encodings.forEach(o=>o.active=!1),i.setParameters(r);}});}catch(n){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");let n=this.peerConnection.getSenders().filter(o=>{var s;return e.indexOf(((s=o.track)===null||s===void 0?void 0:s.id)||"")!==-1});if(n.length!==e.length)throw new Error("Senders' length doesn't match mids' length.");n.map(async o=>{if(Ke()&&o.track)o.track.enabled=!0;else {let s=o.getParameters();s.encodings.forEach(a=>a.active=!0),await o.setParameters(s);}});let i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i);let r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r});}catch(n){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(e){var n=this;return $n(function*(){let i=yield gt(n.mutex.lock("From P2PConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(Ot().supportPCSetConfiguration){let c=n.peerConnection.getConfiguration(),d=e===In.RELAY?"relay":"all";c.iceTransportPolicy!==d&&(_.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(c.iceTransportPolicy,"] to [").concat(d,"]")),c.iceTransportPolicy=d,n.peerConnection.setConfiguration(c));}else if(e===In.RELAY)return;e!==In.RELAY&&n.remoteSDP.updateCandidates(e);let r=yield gt(n.peerConnection.createOffer({iceRestart:!0}));if(!r.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let o=_r(r.sdp),{remoteIceParameters:s}=yield o.iceParameters;n.remoteSDP.restartICE(s);let a=n.remoteSDP.toString();yield gt(n.peerConnection.setLocalDescription(r)),yield gt(n.peerConnection.setRemoteDescription({type:"answer",sdp:a}));}catch(r){_.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),r);}finally{i();}})()}close(){var e;this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy();}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");let i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n]);this.remoteSDP.updateRecvMedia(n._mediaStreamTrack.kind,n);let o=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o});}catch(i){throw new D(R.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(e,n){let i=this.peerConnection.getSenders().filter(r=>{var o;return ((o=r.track)===null||o===void 0?void 0:o.id)===e});i.length===1&&await this.applySendEncodings(i,[n]);}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n);}async replaceTrack(e,n){let i=this.peerConnection.getSenders().find(r=>{var o;return ((o=r.track)===null||o===void 0?void 0:o.id)===n});i&&await i.replaceTrack(e._mediaStreamTrack);}createDataChannels(e,n){throw new D(R.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(e){throw new D(R.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState);},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState);},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount));},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount));},v("CANDIDATE_TIMEOUT"));}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null;}static resolvePCConfiguration(e){let n={iceServers:[],sdpSemantics:"plan-b"};return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(_a(e.turnServer.servers)?n.iceServers=e.turnServer.servers:(n.iceServers&&n.iceServers.push(...Od.turnServerConfigToIceServers(e.turnServer.servers)),v("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...Od.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(i=>{i.forceturn&&(n.iceTransportPolicy="relay");}))),n}static turnServerConfigToIceServers(e){let n=[];return e.forEach(i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}));}),n}async updateRtpSenderEncodings(e,n){var i;if(n||(n=this.peerConnection.getSenders().find(d=>{var l;return ((l=d.track)===null||l===void 0?void 0:l.id)===e._mediaStreamTrack.id})),!n)return _.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(!Ot().supportSetRtpSenderParameters)return _.warn("Browser not support set rtp-sender parameters");let r={},o={};if(e instanceof $t)switch(e._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced";}if(v("DSCP_TYPE")&&Io()){var s;let d=v("DSCP_TYPE");q(s=["very-low","low","medium","high"]).call(s,d)&&(o.networkPriority=d);}let a=n.getParameters(),c=(i=a.encodings)===null||i===void 0?void 0:i[0];c&&Object.assign(c,o),Object.assign(a,r),_.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a.encodings))),await n.setParameters(a);}async applySendEncodings(e,n){try{if(!Ot().supportSetRtpSenderParameters||e.length!==n.length)return;for(let i=0;i<e.length;i++){let r=e[i],o=n[i];r&&o&&await this.updateRtpSenderEncodings(o,r);}}catch{_.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."));}}mungSendOfferSDP(e,n){let i=ue.parse(e);return n.forEach((r,o)=>{let s=r._mediaStreamTrack,a=i.mediaDescriptions.find(c=>c.attributes.mid===s.kind);a&&Fo(a,r);}),ue.print(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,e);},this.statsFilter.onFirstVideoReceived=e=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,e);},this.statsFilter.onFirstAudioDecoded=e=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,e);},this.statsFilter.onFirstVideoDecoded=(e,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,n,i);},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,e,n);},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,e,n);};}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0;}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");let n=this.remoteSDP.batchSend(e).map((o,s)=>{let{id:a,mslabel:c}=o,{kind:d}=e[s];return new K((l,u)=>{let h=setTimeout(()=>{u(new Error("Cannot receive track, id: ".concat(a)));},1e4),p=T=>{let m=Pt();if(m.name==="Safari"&&Number(m.version)===11&&T.track.id!==a&&T.streams[0].id===c){var E;let S=T.streams[0].getTracks()[0];return (E=this.remoteSDP)===null||E===void 0||E.updateTrackLabel(d,a,T.track.id),this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l({track:S,id:a})}if(T.track.id===a)return this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l({track:T.track,id:a})};this.peerConnection.addEventListener("track",p);})}),i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});let r=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(r),await K.all(n)}catch(n){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(n.toString()))}}async getRemoteSSRC(e){if(!this.remoteSDP)return;let n=this.remoteSDP.getSSRC(e);return n?.[0].ssrcId}setConfiguration(e){if(Ot().supportPCSetConfiguration){let n=Od.resolvePCConfiguration(e);this.peerConnection.setConfiguration(n);}}},W(te.prototype,"connect",[Ni],Object.getOwnPropertyDescriptor(te.prototype,"connect"),te.prototype),W(te.prototype,"stopSending",[Ni],Object.getOwnPropertyDescriptor(te.prototype,"stopSending"),te.prototype),W(te.prototype,"receive",[Ni],Object.getOwnPropertyDescriptor(te.prototype,"receive"),te.prototype),W(te.prototype,"stopReceiving",[Ni],Object.getOwnPropertyDescriptor(te.prototype,"stopReceiving"),te.prototype),W(te.prototype,"muteRemote",[Ni],Object.getOwnPropertyDescriptor(te.prototype,"muteRemote"),te.prototype),W(te.prototype,"unmuteRemote",[Ni],Object.getOwnPropertyDescriptor(te.prototype,"unmuteRemote"),te.prototype),W(te.prototype,"muteLocal",[Ni],Object.getOwnPropertyDescriptor(te.prototype,"muteLocal"),te.prototype),W(te.prototype,"unmuteLocal",[Ni],Object.getOwnPropertyDescriptor(te.prototype,"unmuteLocal"),te.prototype),W(te.prototype,"close",[Ni],Object.getOwnPropertyDescriptor(te.prototype,"close"),te.prototype),W(te.prototype,"updateEncoderConfig",[Ni],Object.getOwnPropertyDescriptor(te.prototype,"updateEncoderConfig"),te.prototype),W(te.prototype,"updateSendParameters",[Ni],Object.getOwnPropertyDescriptor(te.prototype,"updateSendParameters"),te.prototype),W(te.prototype,"replaceTrack",[Ni],Object.getOwnPropertyDescriptor(te.prototype,"replaceTrack"),te.prototype),W(te.prototype,"getRemoteSSRC",[Ni],Object.getOwnPropertyDescriptor(te.prototype,"getRemoteSSRC"),te.prototype),te);function Ni(t,e,n){let i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){let r=this.mutex,o=await r.lock("Locking from P2PConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o();}},n}function bO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function Wo(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?bO(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):bO(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}let Ad="9",wO=4e4;function OO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function co(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?OO(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):OO(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}let Xu=function(t){return t.BANDWIDTH="bandwidth",t.CPU="cpu",t.NONE="none",t.OTHER="other",t}({});var Xa=function(t){return t[t.DOWN=0]="DOWN",t[t.UP=1]="UP",t}(Xa||{});let Qu=new Map;function NO(t,e,n,i){let{scale:r}=t;if(r===0&&i===Xa.UP||r>=e.length-1&&i===Xa.DOWN)return t;let o=co(co({},t),{},{scale:i===Xa.DOWN?++r:--r});switch(n){case"maintain-framerate":o=co(co({},o),e[r].motion);break;case"maintain-resolution":o=co(co({},o),e[r].detail);break;case"balanced":o=co(co({},o),e[r].balanced);}return o}function DO(t,e){if(e){let n={overUse:0,underUse:0,adaptationList:PO(e)};Qu.set(t,n);}else Qu.delete(t);}function PO(t){let e=co({},t),{bitrateMax:n,frameRate:i,scaleResolutionDownBy:r,bitrateMin:o}=e,{MIN_FRAME_RATE:s,MAX_THRESHOLD_FRAMERATE:a,MAX_SCALE:c,BITRATE_MIN_THRESHOLD:d,BITRATE_MAX_THRESHOLD:l,BWE_SCALE_UP_THRESHOLD:u,BWE_SCALE_DOWN_THRESHOLD:h,PERF_SCALE_DOWN_THRESHOLD:p,PERF_SCALE_UP_THRESHOLD:T,BALANCE_BITRATE_FACTOR:m,BALANCE_FRAMERATE_FACTOR:E,BALANCE_RESOLUTION_FACTOR:S,MOTION_RESOLUTION_FACTOR:C,MOTION_BITRATE_FACTOR:A,DETAIL_FRAMERATE_FACTOR:b,DETAIL_BITRATE_FACTOR:O}=mm,N=Math.min(e.frameRate,a),k=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(h,1)*n),bwe_up:n,fps_down:Math.round(Math.pow(p,1)*N),fps_up:i},balanced:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:o},motion:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:o},detail:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:o}}];for(let M=1;M<=c;M++){let x={bwe_up:Math.round(Math.pow(u,M)*n),bwe_down:Math.round(Math.pow(h,M+1)*n),fps_up:Math.round(Math.pow(T,M)*N),fps_down:Math.round(Math.pow(p,M+1)*N)},X={scaleResolutionDownBy:r/Math.pow(S,M),frameRate:Math.max(Math.round(Math.pow(E,M)*i),s),bitrateMax:Math.max(Math.round(Math.pow(m,M)*n),l),bitrateMin:Math.max(Math.round(Math.pow(m,M)*o),d)},bt={scaleResolutionDownBy:r/Math.pow(C,M),frameRate:i,bitrateMax:Math.max(Math.round(Math.pow(A,M)*n),l),bitrateMin:Math.max(Math.round(Math.pow(A,M)*o),d)},Ft={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(b,M)*i),s),bitrateMax:Math.max(Math.round(Math.pow(O,M)*n),l),bitrateMin:Math.max(Math.round(Math.pow(O,M)*o),d)};k.push({scale:M,threshold:x,balanced:X,motion:bt,detail:Ft});}return k}function tH(t,e,n,i,r,o){let s=Qu.get(t)||{overUse:0,underUse:0,adaptationList:PO(r)},{adaptationList:a}=s;Qu.set(t,s);let{OVERUSE_TIMES_THRESHOLD:c,UNDERUSE_TIMES_THRESHOLD:d}=mm,{scale:l}=i,u,h;return typeof e=="number"&&e>0&&function(p,T,m,E){if(T>=m.length)return !1;let{threshold:{fps_down:S}}=m[T];return v("FORCE_AG_HIGH_FRAMERATE")&&E==="maintain-framerate"&&(S=m[0].threshold.fps_down),p<S}(e,l,a,o)&&(s.overUse++,h=Xu.CPU,s.overUse>c)||typeof n=="number"&&n>0&&function(p,T,m){if(T>=m.length)return !1;let{threshold:{bwe_down:E}}=m[T];return p<E}(n,l,a)&&(s.overUse++,h=Xu.BANDWIDTH,s.overUse>c)?(s.overUse=0,s.underUse=0,u=NO(i,a,o,Xa.DOWN),[u,h]):(typeof e=="number"&&e>0&&typeof n=="number"&&n>0&&function(p,T,m,E){if(T===0)return;let{threshold:{fps_up:S}}=m[T];return v("FORCE_AG_HIGH_FRAMERATE")&&E==="maintain-framerate"&&(S=m[1].threshold.fps_up),p>S}(e,l,a,o)&&function(p,T,m){if(T===0)return;let{threshold:{bwe_up:E}}=m[T];return p>E}(n,l,a)&&(s.underUse++,s.underUse>d&&(s.overUse=0,s.underUse=0,u=NO(i,a,o,Xa.UP),u.scale===0&&(h=Xu.NONE))),[u,h])}function LO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function nf(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?LO(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):LO(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}function eH(t){var e;return !!v("ENABLE_AG_ADAPTATION")&&!!(t instanceof BE||q(e=t._hints).call(e,ie.CUSTOM_TRACK))&&(!!v("FORCE_SUPPORT_AG_ADAPTATION")||!!(function(n){let i=Pt();if(i.os!==He.IOS||!i.osVersion)return !1;let r=i.osVersion.split(".");return Number(r[0])>=n}(14)&&Wv(17,4)||Gv(14)&&Hv(17,4)))}let Zu=new Map;function $u(t){let e=Zu.get(t);if(e){let{timer:n,adaptationFunc:i,originConfig:r}=e;window.clearTimeout(n),i(r),Zu.delete(t);}DO(t);}var Lt;function kO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function Ho(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?kO(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):kO(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}let gr=(Lt=class Nd extends su{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,n;return (e=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&e!==void 0?e:null}get localCodecs(){return [...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var n;return q(n=Object.keys(fa)).call(n,e)}))]}constructor(e,n){super(e,n),g(this,"store",void 0),g(this,"peerConnection",void 0),g(this,"id",Zt(5,"connection-")),g(this,"remoteSDP",void 0),g(this,"initialOffer",void 0),g(this,"transportEventReceiver",void 0),g(this,"statsFilter",void 0),g(this,"useXR",v("USE_XR")),g(this,"localCapabilities",void 0),g(this,"remoteCodecs",void 0),g(this,"localCandidateCount",0),g(this,"allCandidatesReceived",!1),g(this,"dataStreamChannelMap",new Map),g(this,"establishPromise",void 0),g(this,"recoveredDataChannelIds",[]),g(this,"currentDataChannelId",1),g(this,"mutex",new Qe("P2PConnection-mutex")),g(this,"qualityLimitationReason",Xu.NONE),this.store=n,this.peerConnection=new RTCPeerConnection(Nd.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=Wu(this.peerConnection,v("STATS_UPDATE_INTERVAL"),void 0,Xt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish();}async updateRemoteRTPCapabilities(e,n){if(this.remoteCodecs=n,!this.remoteSDP)return void _.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(n));if(this.remoteSDP.updateRemoteCodec(e,n,this.store.codec)){let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i);let o=this.remoteSDP.toString();r?.(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o});}else _.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.");}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});let e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let n=_r(e.sdp),i=await QE({filterRTX:!v("USE_PUB_RTX")&&!v("USE_SUB_RTX"),filterVideoFec:v("FILTER_VIDEO_FEC"),filterAudioFec:v("FILTER_AUDIO_FEC"),filterVideoCodec:v("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=za(i),this.initialOffer=e,Ho(Ho({},n),{},{rtpCapabilities:i,offerSDP:e.sdp})}catch(e){throw new D(R.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,n,i,r,o,s){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{get localCapabilities(){return ne(this._localCapabilities)}get rtpCapabilities(){return ne(this._rtpCapabilities)}get candidates(){return ne(this._candidates)}get iceParameters(){return ne(this._iceParameters)}get dtlsParameters(){return ne(this._dtlsParameters)}constructor(p){g(this,"sessionDesc",void 0),g(this,"_localCapabilities",void 0),g(this,"_rtpCapabilities",void 0),g(this,"_candidates",void 0),g(this,"_iceParameters",void 0),g(this,"_dtlsParameters",void 0),g(this,"setup",void 0),g(this,"currentMidIndex",void 0),g(this,"cname",void 0),g(this,"firefoxSsrcMidMap",new Map),p=ne(p);let{remoteIceParameters:T,remoteDtlsParameters:m,candidates:E,remoteRTPCapabilities:S,remoteSetup:C,localCapabilities:A,cname:b}=p,O=ue.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=ice-lite
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`);this._rtpCapabilities=S,this._candidates=E,this._iceParameters=T,this._dtlsParameters=m,this._localCapabilities=A,this.setup=C,this.cname=b;let N=this.rtpCapabilities.send;for(let k of O.mediaDescriptions){if(k.attributes.iceUfrag=T.iceUfrag,k.attributes.icePwd=T.icePwd,k.attributes.fingerprints=m.fingerprints,k.attributes.candidates=E,k.attributes.setup=C,k.media.mediaType==="video"&&(k.media.fmts=N.videoCodecs.map(M=>M.payloadType.toString(10)),k.attributes.payloads=N.videoCodecs,k.attributes.extmaps=N.videoExtensions,v("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:M,ssrcGroups:x}=mi([{ssrcId:wO,rtx:v("USE_SUB_RTX")?40001:void 0}],this.cname);k.attributes.ssrcs=M,k.attributes.ssrcGroups=x;}if(k.media.mediaType==="audio"&&(k.media.fmts=N.audioCodecs.map(M=>M.payloadType.toString(10)),k.attributes.payloads=N.audioCodecs,k.attributes.extmaps=N.audioExtensions,mr(k),v("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:M,ssrcGroups:x}=mi([{ssrcId:2e4}],this.cname);k.attributes.ssrcs=M,k.attributes.ssrcGroups=x;}}this.sessionDesc=O,this.currentMidIndex=O.mediaDescriptions.length-1;}preloadRemoteMedia(){let p=v("PRELOAD_MEDIA_COUNT");this.rtpCapabilities;let T=this.candidates,m=this.dtlsParameters,E=this.iceParameters,S=this.rtpCapabilities.send;for(let C=1;C<p;C++){let A=2*C+2e4,b=2*C+wO,{ssrcs:O,ssrcGroups:N}=mi([{ssrcId:A}],this.cname),{ssrcs:k,ssrcGroups:M}=mi([{ssrcId:b,rtx:v("USE_SUB_RTX")?b+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:Ad,protos:["UDP","TLS","RTP","SAVPF"],fmts:S.videoCodecs.map(x=>x.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:E.iceUfrag,icePwd:E.icePwd,unrecognized:[],candidates:T,extmaps:S.videoExtensions,fingerprints:m.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:k,ssrcGroups:M,rtcpFeedbackWildcards:[],payloads:S.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*C)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:Ad,protos:["UDP","TLS","RTP","SAVPF"],fmts:S.audioCodecs.map(x=>x.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:E.iceUfrag,icePwd:E.icePwd,unrecognized:[],candidates:T,extmaps:S.audioExtensions,fingerprints:m.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:O,ssrcGroups:N,rtcpFeedbackWildcards:[],payloads:S.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*C+1)}}),this.currentMidIndex+=2;}this.updateBundleMids();}toString(){return ue.print(this.sessionDesc)}send(p,T,m,E){let{ssrcs:S,ssrcGroups:C}=mi(T,this.cname,v("SYNC_GROUP")?m:void 0),A=this.findPreloadMediaDesc(S);if(A){if(Xt()&&this.firefoxSsrcMidMap.set(S[0].ssrcId,A.attributes.mid),E&&(E.twcc||E.remb)){let b=this.sessionDesc.mediaDescriptions.indexOf(A);return this.sessionDesc.mediaDescriptions[b]=this.mungSendMediaDesc(A,E),{mid:A.attributes.mid,needExchangeSDP:!0}}return {mid:A.attributes.mid,needExchangeSDP:!1}}{let b=this.findAvailableMediaIndex(p,S),O;return b===-1||b===1&&(Ke()||Yv())||b===0&&v("USE_SUB_RTX")||qv()?(O=this.createOrRecycleSendMedia(p,S,C,"sendonly",E),this.updateBundleMids()):(O=ne(this.sessionDesc.mediaDescriptions[b]),O.attributes.direction="sendonly",O.attributes.ssrcs=S,O.attributes.ssrcGroups=C,this.sessionDesc.mediaDescriptions[b]=this.mungSendMediaDesc(O,E)),Xt()&&this.firefoxSsrcMidMap.set(S[0].ssrcId,O.attributes.mid),{mid:O.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){let{mediaDesc:p,needExchangeSDP:T}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:p.attributes.mid,needExchangeSDP:T}}batchSend(p){let T=p.map(S=>{let{kind:C,ssrcMsg:A,mslabel:b}=S;return this.send(C,A,b)}),m=[],E=!1;return T.forEach(S=>{let{mid:C,needExchangeSDP:A}=S;A&&(E=!0),m.push(C);}),{mids:m,needExchangeSDP:E}}stopSending(p){let T=this.sessionDesc.mediaDescriptions.filter(m=>m.attributes.mid&&p.indexOf(m.attributes.mid)!==-1);if(T.length!==p.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");T.forEach(m=>{m.attributes.mid==="0"||Xt()||qv()?m.attributes.ssrcs=[]:(m.attributes.ssrcs=[],m.attributes.direction="inactive",m.media.port="0");}),this.updateBundleMids();}mute(p){let T=this.sessionDesc.mediaDescriptions.find(m=>m.attributes.mid===p);if(!T)throw new Error("mediaDescription not found with ".concat(p," in remote SDP when calling RemoteSDP.mute."));T.attributes.direction="inactive";}unmute(p){let T=this.sessionDesc.mediaDescriptions.find(m=>m.attributes.mid===p);if(!T)throw new Error("mediaDescription not found with ".concat(p," in remote SDP when calling RemoteSDP.unmute."));T.attributes.direction="sendonly";}muteRemote(p){let T=this.sessionDesc.mediaDescriptions.filter(m=>q(p).call(p,m.attributes.mid||""));if(T.length!==p.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");T.forEach(m=>{m.attributes.direction="inactive";});}unmuteRemote(p){let T=this.sessionDesc.mediaDescriptions.filter(m=>q(p).call(p,m.attributes.mid||""));if(T.length!==p.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");T.forEach(m=>{m.attributes.direction="recvonly";});}receive(p,T,m,E){p.forEach((S,C)=>{this.createOrRecycleRecvMedia(S,[],"recvonly",T,m,E[C]);}),this.updateBundleMids();}stopReceiving(p){let T=this.sessionDesc.mediaDescriptions.filter(m=>p.indexOf(m.attributes.mid)!==-1);if(T.length!==p.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");T.forEach(m=>{m.media.port="0",m.attributes.direction="inactive";}),this.updateBundleMids();}updateCandidates(p){let T=this._candidates.filter(m=>m.transport==="udp");if(p===In.TCP){if(T.length===0)return;if(v("TCP_CANDIDATE_ONLY")){let m=this._candidates.filter(E=>E.transport==="tcp");T.forEach(E=>{m.findIndex(S=>S.connectionAddress===E.connectionAddress)===-1&&m.push(Wo(Wo({},E),{},{foundation:"tcpcandidate",priority:Number(E.priority)-1+"",transport:"tcp",port:Number(E.port)+90+""}));}),this._candidates=m;}else {let m=[];T.forEach(E=>{m.push(Wo(Wo({},E),{},{foundation:"tcpcandidate",priority:Number(E.priority)-1+"",transport:"tcp",port:Number(E.port)+90+""}));}),this._candidates=[...T,...m];}}else if(p===In.RELAY){if(T.length!==0)return;{let m=this._candidates.filter(E=>E.transport==="tcp");m.forEach(E=>{T.push(Wo(Wo({},E),{},{foundation:"udpcandidate",priority:Number(E.priority)+1+"",transport:"udp",port:Number(E.port)-90+""}));}),this._candidates=[...T,...m];}}else T.length===0?(this._candidates.filter(m=>m.transport==="tcp").forEach(m=>{T.push(Wo(Wo({},m),{},{foundation:"udpcandidate",priority:Number(m.priority)+1+"",transport:"udp",port:Number(m.port)-90+""}));}),this._candidates=T):this._candidates=this._candidates.filter(m=>m.transport!=="tcp");for(let m of this.sessionDesc.mediaDescriptions)m.attributes.candidates=this.candidates;}restartICE(p){p=ne(p),this._iceParameters=p,this.sessionDesc.mediaDescriptions.forEach(T=>{T.attributes.iceUfrag=p.iceUfrag,T.attributes.icePwd=p.icePwd;});}predictReceivingMids(p){let T=[];for(let m=0;m<p;m++)T.push((this.currentMidIndex+m+1).toString(10));return T}findAvailableMediaIndex(p,T){return this.sessionDesc.mediaDescriptions.findIndex(m=>{let E=m.media.mediaType===p&&m.media.port!=="0"&&(m.attributes.direction==="sendonly"||m.attributes.direction==="sendrecv")&&m.attributes.ssrcs.length===0;if(Xt()){if(E){let S=this.firefoxSsrcMidMap.get(T[0].ssrcId);return !(S||m.attributes.mid!=="0"&&m.attributes.mid!=="1")||!(!S||S!==m.attributes.mid)}return !1}return E})}createOrRecycleDataChannel(){for(let m of this.sessionDesc.mediaDescriptions)if(m.media.mediaType==="application")return {mediaDesc:m,needExchangeSDP:!1};this.currentMidIndex+=1;let p="".concat(this.currentMidIndex),T={media:{mediaType:"application",port:Ad,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(p),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(T),{mediaDesc:T,needExchangeSDP:!0}}createOrRecycleRecvMedia(p,T,m,E,S,C){let A=p._mediaStreamTrack.kind,b=this.rtpCapabilities.recv,O=Ls(A,b,this.localCapabilities.send,A===tt.VIDEO?E:S),N=A===tt.VIDEO?b.videoExtensions:b.audioExtensions;this.currentMidIndex+=1;let k="".concat(this.currentMidIndex),M={media:{mediaType:A,port:Ad,protos:["UDP","TLS","RTP","SAVPF"],fmts:O.map(X=>X.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:N,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:T,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:O,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:m,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(k)}};M=this.mungRecvMediaDsec(M,p,C);let x=this.findFirstClosedMedia(A);if(x){let X=this.sessionDesc.mediaDescriptions.indexOf(x);this.sessionDesc.mediaDescriptions[X]=M;}else this.sessionDesc.mediaDescriptions.push(M);return M}updateRemoteCodec(p,T,m){let E=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(M=>M.rtpMap&&M.rtpMap.encodingName.toLowerCase()||"").filter(M=>{var x;return q(x=Object.keys(fa)).call(x,M)}))],S=new Set(T);if(E.every(M=>S.has(M)))return _.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(T)),!1;let C=this._rtpCapabilities.recv.videoCodecs.filter(M=>T.some(x=>{var X;return q(X=M.rtpMap&&M.rtpMap.encodingName.toLowerCase()||"").call(X,x)}));if(C.length===0)return _.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(E," codecs: ").concat(T)),!1;let A=[...new Set(C.map(M=>M.rtpMap&&M.rtpMap.encodingName.toLowerCase()||""))],b;if(_.debug("updateRemoteCodec, from ".concat(E," to ").concat(A)),p.length===0)b=this.sessionDesc.mediaDescriptions.filter(M=>M.media.mediaType==="video"&&M.attributes.direction==="recvonly");else if(b=this.sessionDesc.mediaDescriptions.filter(M=>M.attributes.mid&&q(p).call(p,M.attributes.mid)&&M.attributes.direction==="recvonly"),b.length!==p.length)return _.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(p,", codecs: ").concat(T)),!1;if(v("USE_PUB_RTX")||v("USE_SUB_RTX")){let M=ZE(C,this.rtpCapabilities.recv.videoCodecs);C.push(...M);}this._rtpCapabilities.recv.videoCodecs=C;let O=this.localCapabilities.send,N=this.rtpCapabilities.recv,k=Ls(tt.VIDEO,N,O,m);return b.forEach(M=>{let x=k.map(X=>X.payloadType.toString(10));_.debug("updateRemoteCodec mid: ".concat(M.attributes.mid,", from ").concat(M.attributes.payloads," to ").concat(k)),M.attributes.payloads=k,M.media.fmts=x;}),!0}createOrRecycleSendMedia(p,T,m,E,S){let C=this.rtpCapabilities.send,A=p===tt.VIDEO?C.videoCodecs:C.audioCodecs,b=p===tt.VIDEO?C.videoExtensions:C.audioExtensions;this.currentMidIndex+=1;let O="".concat(this.currentMidIndex),N={media:{mediaType:p,port:Ad,protos:["UDP","TLS","RTP","SAVPF"],fmts:A.map(M=>M.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:b,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:T,ssrcGroups:m,rtcpFeedbackWildcards:[],payloads:A,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:E,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(O)}};N=this.mungSendMediaDesc(N,S);let k=this.findFirstClosedMedia(p);if(k){let M=this.sessionDesc.mediaDescriptions.indexOf(k);this.sessionDesc.mediaDescriptions[M]=N;}else this.sessionDesc.mediaDescriptions.push(N);return N}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(p=>p.media.port!=="0").map(p=>p.attributes.mid);}mungRecvMediaDsec(p,T,m){let E=ne(p);return Hu(E),Fo(E,T),Ku(E,T),JE(E),qa(E,m,this.localCapabilities.send),E}mungSendMediaDesc(p,T){let m=ne(p);return qa(m,T,this.localCapabilities.recv),mr(m),m}updateRecvMedia(p,T){let m=this.sessionDesc.mediaDescriptions.findIndex(E=>E.attributes.mid===p);if(m!==-1){let E=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[m],T);this.sessionDesc.mediaDescriptions[m]=E;}}bumpMid(p){this.currentMidIndex+=p;}findFirstClosedMedia(p){return this.sessionDesc.mediaDescriptions.find(T=>Xt()?T.media.port==="0"&&T.media.mediaType===p:T.media.port==="0")}findPreloadMediaDesc(p){return this.sessionDesc.mediaDescriptions.find(T=>{var m;return ((m=T.attributes)===null||m===void 0||(m=m.ssrcs[0])===null||m===void 0?void 0:m.ssrcId)===p[0].ssrcId})}getSSRC(p){var T;return (T=this.sessionDesc.mediaDescriptions.find(m=>m.attributes.mid===p))===null||T===void 0?void 0:T.attributes.ssrcs}}({remoteIceParameters:e,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r,remoteSetup:o,localCapabilities:this.localCapabilities,cname:s}),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);let a=this.remoteSDP.toString(),c=ue.parse(this.initialOffer.sdp),d=c.mediaDescriptions.find(p=>p.media.mediaType==="audio");d&&mr(d),this.useXR&&Yu(c);let l=ue.print(c),u=this.logSDPExchange(l||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:l}),u?.(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a});let h=this.peerConnection.getTransceivers()[0];if(h!=null&&h.receiver&&this.tryBindTransportEvents(h.receiver),v("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia();let p=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:p});let T=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(T);}}catch(a){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(a.toString()))}}send(e,n,i){var r=this;return $n(function*(){let o=yield gt(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");let s=[];e.forEach(m=>{let E=r.peerConnection.addTransceiver(m._mediaStreamTrack,{direction:"sendonly"});s.push(E),m._updateRtpTransceiver(E);}),Xt()&&v("SIMULCAST")===!0&&(yield gt(r.applySimulcastForFirefox(s,e)));let a=yield gt(r.peerConnection.createOffer()),c=r.remoteSDP.predictReceivingMids(e.length),d=r.mungSendOfferSDP(a.sdp,e,c),l=ue.parse(d),u=c.map(m=>{let E=l.mediaDescriptions.find(S=>S.attributes.mid===m);if(!E)throw new Error("Cannot extract ssrc from mediaDescription.");return zE(E,v("USE_PUB_RTX"))}),h;try{h=yield u;}catch(m){h=[],r.remoteSDP.receive(e,n,i,h);let E=r.remoteSDP.toString();throw yield gt(r.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield gt(r.peerConnection.setRemoteDescription({type:"answer",sdp:E})),yield gt(r.stopSending(c,!0)),m}r.remoteSDP.receive(e,n,i,h);let p=r.remoteSDP.toString(),T=r.logSDPExchange(d,"offer","local","send");return yield gt(r.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield gt(r.applySimulcastEncodings(s,e)),yield gt(r.applySendEncodings(s,e)),T?.(p),yield gt(r.peerConnection.setRemoteDescription({type:"answer",sdp:p})),s.map((m,E)=>{let S=c[E];return {localSSRC:u[E],id:S,transceiver:m}})}catch(s){throw s instanceof D?s:new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(s.toString()))}finally{o();}})()}async createDataChannels(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(e);if(i&&i.readyState==="open")_.debug("[P2PConnection] Channels are already available and can be reused directly.");else {let o=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof o!="number")throw new Error("create DataChannel error, because cannot get dc id");i=this.peerConnection.createDataChannel("datastream-channel",{id:o,negotiated:!0,ordered:!1,maxRetransmits:v("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,i);}n.forEach(o=>{o._updateOriginDataChannel(i);});let{needExchangeSDP:r}=this.remoteSDP.sendDataChannel();if(r){let o=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:o});let s=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(s),_.debug("[P2PConnection] createDataChannels by exchanging SDP.");}else _.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(i){throw i instanceof D?i:new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(i.toString()))}}async stopDataChannels(e){try{let n=this.dataStreamChannelMap.get(e);return n&&(n.id&&this.recoveredDataChannelIds.push(n.id),n.close()),void this.dataStreamChannelMap.delete(e)}catch(n){throw n instanceof D?n:new D(R.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(n.toString()))}}async stopSending(e,n){let i=n?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");let r=this.peerConnection.getTransceivers().filter(c=>e.indexOf(c.mid)!==-1);if(r.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");r.map(c=>{var d;$u(this.id+c.mid),c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c);});let o=await this.peerConnection.createOffer(),s=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(e);let a=this.remoteSDP.toString();s?.(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a});}catch(r){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{i&&i();}}async receive(e,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));let{mid:o,needExchangeSDP:s}=this.remoteSDP.send(e,n,i,r);if(s){let c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});let l=await this.peerConnection.createAnswer(),u=this.mungReceiveAnswerSDP(l.sdp,o,e);d?.(u||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:u}),_.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."));}else _.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));let a=this.peerConnection.getTransceivers().find(c=>c.mid===o);if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return {track:a.receiver.track,id:o,transceiver:a}}catch(o){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");let{mids:n,needExchangeSDP:i}=this.remoteSDP.batchSend(e);if(i){let r=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});let s=await this.peerConnection.createAnswer();o?.(s.sdp||""),await this.peerConnection.setLocalDescription(s),_.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."));}else _.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive no need to exchange SDP."));return n.map(r=>{let o=this.peerConnection.getTransceivers().find(s=>s.mid===r);if(!o)throw new Error("Cannot get transceiver after setLocalDescription.");return {track:o.receiver.track,id:r,transceiver:o}})}catch(n){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(n.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);let n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});let r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r);}catch(n){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);let n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});let r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r);}catch(n){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(n.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);let n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});let r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r);}catch(n){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(n.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");let n=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(s=>{s.direction="inactive";});let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);let o=this.remoteSDP.toString();r?.(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o});}catch(n){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");let n=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(async(s,a)=>{s.direction="sendonly";});let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);let o=this.remoteSDP.toString();r?.(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o});}catch(n){throw new D(R.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(e){var n=this;return $n(function*(){let i=yield gt(n.mutex.lock("From P2PConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(Ot().supportPCSetConfiguration){let d=n.peerConnection.getConfiguration(),l=e===In.RELAY?"relay":"all";d.iceTransportPolicy!==l&&(_.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(d.iceTransportPolicy,"] to [").concat(l,"]")),d.iceTransportPolicy=l,n.peerConnection.setConfiguration(d));}else if(e===In.RELAY)return;n.remoteSDP.updateCandidates(e);let r=yield gt(n.peerConnection.createOffer({iceRestart:!0}));if(!r.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let o=_r(r.sdp),{remoteIceParameters:s}=yield o.iceParameters;n.remoteSDP.restartICE(s);let a=n.remoteSDP.toString(),c=n.logSDPExchange(r.sdp||"","offer","local","restartICE");n.store.descriptionStart(),yield gt(n.peerConnection.setLocalDescription(r)),c?.(a),yield gt(n.peerConnection.setRemoteDescription({type:"answer",sdp:a}));}catch(r){_.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),r);}finally{i();}})()}close(){var e;this.peerConnection.getTransceivers().forEach(n=>{$u(this.id+n.mid);}),this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1;}getStats(){return Ho(Ho({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");let i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n],[e]);this.remoteSDP.updateRecvMedia(e,n);let o=this.remoteSDP.toString(),s=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),s?.(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o});}catch(i){throw new D(R.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(e,n){let i=this.peerConnection.getTransceivers().filter(r=>r.mid===e);i.length===1&&(this.isVP8Simulcast(n)?Xt()||await this.applySimulcastEncodings(i,[n]):await this.applySendEncodings(i,[n]));}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n);}async replaceTrack(e,n){let i=this.peerConnection.getTransceivers().find(r=>r.mid===n);i&&await i.sender.replaceTrack(e._mediaStreamTrack);}async getSelectedCandidatePair(){let e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){let n=e[0].transport.iceTransport,{local:i,remote:r}=n.getSelectedCandidatePair();return {local:Ho(Ho({},Br),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:Ho(Ho({},Br),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState);},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState);},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount));},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount));},v("CANDIDATE_TIMEOUT"));}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null;}static resolvePCConfiguration(e){let n={iceServers:[]};return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(_a(e.turnServer.servers)?n.iceServers=e.turnServer.servers:(n.iceServers&&n.iceServers.push(...Nd.turnServerConfigToIceServers(e.turnServer.servers)),v("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...Nd.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),v("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(i=>{i.forceturn&&(n.iceTransportPolicy="relay");}))),v("ENABLE_ENCODED_TRANSFORM")&&Ot().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),n}static turnServerConfigToIceServers(e){let n=[];return e.forEach(i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(Do(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!v("FORCE_TURN_TCP")&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}));}),n}tryBindTransportEvents(e){let n=e.transport;if(n){this.transportEventReceiver=e,n.onstatechange=()=>{var r;n!=null&&n.state&&((r=this.onDTLSTransportStateChange)===null||r===void 0||r.call(this,n.state));},n.onerror=r=>{var o;(o=this.onDTLSTransportError)===null||o===void 0||o.call(this,"error"in r?r.error:r);};let i=n.iceTransport;i&&(i.onstatechange=()=>{let r=n?.iceTransport.state;var o;r&&((o=this.onICETransportStateChange)===null||o===void 0||o.call(this,r));},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){let{local:r,remote:o}=i.getSelectedCandidatePair();_.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:r.type,protocol:r.protocol}),", remote ").concat(JSON.stringify({candidateType:o.type,protocol:o.protocol,address:o.address,port:o.port})," )"));}}));}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null));}async updateRtpSenderEncodings(e,n){var i,r;if(n||(n=this.peerConnection.getSenders().find(E=>E.track===e._mediaStreamTrack)),!n)return _.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return _.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Ot().supportSetRtpSenderParameters)return _.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");let o={},s={};switch(e._optimizationMode){case"motion":o.degradationPreference="maintain-framerate";break;case"detail":o.degradationPreference="maintain-resolution";break;case"balanced":o.degradationPreference="balanced";}let a=function(m,E){return m.getTransceivers().find(S=>S.sender.track===E||S.receiver.track===E)}(this.peerConnection,e._mediaStreamTrack),c=I3(e);if(eH(e)&&a&&n&&c&&this.getLocalVideoStats&&q(i=["vp8","vp9"]).call(i,this.store.codec)){var d;let m=o.degradationPreference||(q(d=e._hints).call(d,ie.CUSTOM_TRACK)?v("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");(function(E,S,C,A,b,O){if($u(E),A!=="balanced"&&A!=="maintain-framerate"&&A!=="maintain-resolution")return;let N=-1;DO(E,S);let k=window.setInterval(()=>{let x=Zu.get(E);if(!v("ENABLE_AG_ADAPTATION")||!x)return void $u(E);let X=O();if(X.sendPackets>0&&X.OutgoingAvailableBandwidth>0){if(N===-1)return void(N=Date.now());if(Date.now()-N<1e3)return;let bt=X.sendFrameRate,Ft=X.OutgoingAvailableBandwidth,[re,Le]=tH(E,bt,Ft,x.adaptationConfig,S,A);Le&&(C.qualityLimitationReason=Le),re&&x.adaptationConfig.scale!==re.scale&&(_.debug("[".concat(E,"] applyAdaptation: ").concat(C.qualityLimitationReason,`
           sendFps `).concat(bt,", bwe ").concat(Ft,", switch from ").concat(x.adaptationConfig.scale," to ").concat(re.scale," ")),x.adaptationConfig=nf(nf({},x.adaptationConfig),re),b(re));}},v("CHECK_LOCAL_STATS_INTERVAL")),M=nf({},S);Zu.set(E,{timer:k,adaptationConfig:M,originConfig:S,adaptationFunc:b}),_.debug("[".concat(E,"] start adaptation, originConfig: ").concat(JSON.stringify(S),", degradationPreference: ").concat(A));})(this.id+a.mid,c,this,m,E=>{n&&this.updateAdaptation(n,E);},this.getLocalVideoStats.bind(this));}if(e._encoderConfig){var l;let{bitrateMax:m,frameRate:E,scaleResolutionDownBy:S}=e._encoderConfig;m&&(s.maxBitrate=1e3*m),(q(l=e._hints).call(l,ie.LOW_STREAM)||e.isUseScaleResolutionDownBy)&&(E&&(s.maxFramerate=Wn(E)),S&&S>=1&&(s.scaleResolutionDownBy=S));}let{maxFramerate:u}=v("ENCODER_CONFIG_LIMIT");if(u&&typeof u=="number"&&(s.maxFramerate=s.maxFramerate?Math.min(s.maxFramerate,u):u),v("DSCP_TYPE")&&Io()){var h;let m=v("DSCP_TYPE");q(h=["very-low","low","medium","high"]).call(h,m)&&(s.networkPriority=m);}let p=n.getParameters(),T=(r=p.encodings)===null||r===void 0?void 0:r[0];Xt()&&!T&&(o.encodings=[s]),T&&Object.assign(T,s),Object.assign(p,o),_.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(p.encodings))),await n.setParameters(p);}async updateAdaptation(e,n){var i,r;if(!e)return _.debug("[updateAdaptation] no rtpSender found");if(!Ot().supportSetRtpSenderParameters)return _.debug("[updateAdaptation] Browser not support set rtp-sender parameters");let o={},{bitrateMax:s,frameRate:a,scaleResolutionDownBy:c}=n;s&&(o.maxBitrate=1e3*s),a&&(o.maxFramerate=Wn(a)),c&&c>=1&&q(i=["vp8","vp9"]).call(i,this.store.codec)&&(o.scaleResolutionDownBy=c);let d=e.getParameters(),l=(r=d.encodings)===null||r===void 0?void 0:r[0];l&&Object.assign(l,o),Object.assign(d,{});try{await e.setParameters(d),_.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(d.encodings)));}catch(u){!("transport"in e)||e.transport&&e.transport.state==="connected"?this.peerConnectionState!=="connected"?_.debug("[updateAdaptation] peerConnection not connected}"):_.debug("[updateAdaptation] updateRtpSenderEncodings failed",u):_.debug("[updateAdaptation] rtpSender transport not connected}");}}async applySendEncodings(e,n){try{if(!Ot().supportSetRtpSenderParameters||e.length!==n.length)return;for(let i=0;i<e.length;i++){let r=e[i],o=n[i];o instanceof $t&&!this.isVP8Simulcast(o)&&await this.updateRtpSenderEncodings(o,r.sender);}}catch{_.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."));}}mungSendOfferSDP(e,n,i){let r=ue.parse(e);return n.forEach((o,s)=>{let a=i[s],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(Fo(c,o),XE(c,o,this.store.codec));}),ue.print(r)}mungReceiveAnswerSDP(e,n,i){let r=ue.parse(e),o=r.mediaDescriptions.find(s=>s.attributes.mid===n);return o&&(i===tt.AUDIO&&o.media.mediaType==="audio"&&mr(o),this.useXR&&Yu(r)),ue.print(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,e);},this.statsFilter.onFirstVideoReceived=e=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,e);},this.statsFilter.onFirstAudioDecoded=e=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,e);},this.statsFilter.onFirstVideoDecoded=(e,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,n,i);},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,e,n);},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,e,n);},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,e);};}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0;}async applySimulcastForFirefox(e,n){if(e.length===n.length)for(let c=0;c<e.length;c++){var i,r,o,s,a;let d=e[c],l=n[c];if(l instanceof $t&&!q(i=l._hints).call(i,ie.LOW_STREAM)&&(r=l._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((o=l._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(s=l._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((a=l._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){let u={},h={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};u.encodings=[{rid:"m",active:!0,maxBitrate:h.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:h.high}];let p=d.sender.getParameters();await d.sender.setParameters(Object.assign(p,u));}}}async applySimulcastEncodings(e,n){if(!Xt()&&e.length===n.length)for(let i=0;i<e.length;i++){let r=n[i];if(r instanceof $t&&this.isVP8Simulcast(r)){let o=e[i],s={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];let c=o.sender.getParameters();await o.sender.setParameters(Object.assign(c,s));}}}isVP8Simulcast(e){var n,i,r,o,s;return !!(e instanceof $t&&v("SIMULCAST")&&this.store.codec==="vp8"&&!q(n=e._hints).call(n,ie.LOW_STREAM)&&(i=e._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=e._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(o=e._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((s=e._scalabilityMode)===null||s===void 0?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,n,i,r){if(v("SDP_LOGGING"))return _.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(n," SDP during P2PConnection.").concat(r,`
`),e),n==="offer"?o=>{this.logSDPExchange(o,"answer",i==="local"?"remote":"local",r);}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;let n=this.remoteSDP.getSSRC(e);return n?.[0].ssrcId}setConfiguration(e){if(Ot().supportPCSetConfiguration){let n=Nd.resolvePCConfiguration(e);this.peerConnection.setConfiguration(n);}}},W(Lt.prototype,"updateRemoteRTPCapabilities",[Hn],Object.getOwnPropertyDescriptor(Lt.prototype,"updateRemoteRTPCapabilities"),Lt.prototype),W(Lt.prototype,"connect",[Hn],Object.getOwnPropertyDescriptor(Lt.prototype,"connect"),Lt.prototype),W(Lt.prototype,"createDataChannels",[Hn],Object.getOwnPropertyDescriptor(Lt.prototype,"createDataChannels"),Lt.prototype),W(Lt.prototype,"receive",[Hn],Object.getOwnPropertyDescriptor(Lt.prototype,"receive"),Lt.prototype),W(Lt.prototype,"batchReceive",[Hn],Object.getOwnPropertyDescriptor(Lt.prototype,"batchReceive"),Lt.prototype),W(Lt.prototype,"stopReceiving",[Hn],Object.getOwnPropertyDescriptor(Lt.prototype,"stopReceiving"),Lt.prototype),W(Lt.prototype,"muteRemote",[Hn],Object.getOwnPropertyDescriptor(Lt.prototype,"muteRemote"),Lt.prototype),W(Lt.prototype,"unmuteRemote",[Hn],Object.getOwnPropertyDescriptor(Lt.prototype,"unmuteRemote"),Lt.prototype),W(Lt.prototype,"muteLocal",[Hn],Object.getOwnPropertyDescriptor(Lt.prototype,"muteLocal"),Lt.prototype),W(Lt.prototype,"unmuteLocal",[Hn],Object.getOwnPropertyDescriptor(Lt.prototype,"unmuteLocal"),Lt.prototype),W(Lt.prototype,"close",[Hn],Object.getOwnPropertyDescriptor(Lt.prototype,"close"),Lt.prototype),W(Lt.prototype,"updateEncoderConfig",[Hn],Object.getOwnPropertyDescriptor(Lt.prototype,"updateEncoderConfig"),Lt.prototype),W(Lt.prototype,"updateSendParameters",[Hn],Object.getOwnPropertyDescriptor(Lt.prototype,"updateSendParameters"),Lt.prototype),W(Lt.prototype,"replaceTrack",[Hn],Object.getOwnPropertyDescriptor(Lt.prototype,"replaceTrack"),Lt.prototype),W(Lt.prototype,"updateAdaptation",[Hn],Object.getOwnPropertyDescriptor(Lt.prototype,"updateAdaptation"),Lt.prototype),W(Lt.prototype,"getRemoteSSRC",[Hn],Object.getOwnPropertyDescriptor(Lt.prototype,"getRemoteSSRC"),Lt.prototype),Lt);function Hn(t,e,n){let i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){let r=this.mutex,o=await r.lock("From P2PConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o();}},n}function MO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function UO(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?MO(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):MO(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}let xO=`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0
a=msid-semantic: WMS
a=ice-lite
m=application 9 UDP/DTLS/SCTP webrtc-datachannel
c=IN IP4 127.0.0.1
a=mid:0
`,th="9",rf=2e4,of=4e4;class nH{get localCapabilities(){return ne(this._localCapabilities)}get rtpCapabilities(){return ne(this._rtpCapabilities)}get candidates(){return ne(this._candidates)}get iceParameters(){return ne(this._iceParameters)}get dtlsParameters(){return ne(this._dtlsParameters)}constructor(e){g(this,"sessionDesc",void 0),g(this,"_localCapabilities",void 0),g(this,"_rtpCapabilities",void 0),g(this,"_candidates",void 0),g(this,"_iceParameters",void 0),g(this,"_dtlsParameters",void 0),g(this,"setup",void 0),g(this,"currentMidIndex",void 0),g(this,"cname",void 0),g(this,"firefoxSsrcMidMap",new Map),e=ne(e);let{remoteIceParameters:n,remoteDtlsParameters:i,candidates:r,remoteRTPCapabilities:o,remoteSetup:s,localCapabilities:a,cname:c}=e,d=ue.parse(xO);this._rtpCapabilities=o,this._candidates=r,this._iceParameters=n,this._dtlsParameters=i,this._localCapabilities=a,this.setup=s,this.cname=c;let l=this.rtpCapabilities.send;for(let u of d.mediaDescriptions){if(u.attributes.iceUfrag=n.iceUfrag,u.attributes.icePwd=n.icePwd,u.attributes.fingerprints=i.fingerprints,u.attributes.candidates=r,u.attributes.setup=s,u.media.mediaType==="application"&&(u.attributes.sctpPort="5000"),u.media.mediaType==="video"&&(u.media.fmts=l.videoCodecs.map(h=>h.payloadType.toString(10)),u.attributes.payloads=l.videoCodecs,u.attributes.extmaps=l.videoExtensions,v("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:h,ssrcGroups:p}=mi([{ssrcId:of,rtx:v("USE_SUB_RTX")?40001:void 0}],this.cname);u.attributes.ssrcs=h,u.attributes.ssrcGroups=p;}if(u.media.mediaType==="audio"&&(u.media.fmts=l.audioCodecs.map(h=>h.payloadType.toString(10)),u.attributes.payloads=l.audioCodecs,u.attributes.extmaps=l.audioExtensions,mr(u),v("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:h,ssrcGroups:p}=mi([{ssrcId:rf}],this.cname);u.attributes.ssrcs=h,u.attributes.ssrcGroups=p;}}this.sessionDesc=d,this.currentMidIndex=d.mediaDescriptions.length-1;}updateRemoteRTPCapabilities(e){let n=ue.parse(xO);this._rtpCapabilities=e;let i=this.rtpCapabilities.send;for(let r of n.mediaDescriptions){if(r.attributes.iceUfrag=this._iceParameters.iceUfrag,r.attributes.icePwd=this._iceParameters.icePwd,r.attributes.fingerprints=this._dtlsParameters.fingerprints,r.attributes.candidates=this._candidates,r.attributes.setup=this.setup,r.media.mediaType==="application"&&(r.attributes.sctpPort="5000"),r.media.mediaType==="video"&&(r.media.fmts=i.videoCodecs.map(o=>o.payloadType.toString(10)),r.attributes.payloads=i.videoCodecs,r.attributes.extmaps=i.videoExtensions,v("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:o,ssrcGroups:s}=mi([{ssrcId:of,rtx:v("USE_SUB_RTX")?40001:void 0}],this.cname);r.attributes.ssrcs=o,r.attributes.ssrcGroups=s;}if(r.media.mediaType==="audio"&&(r.media.fmts=i.audioCodecs.map(o=>o.payloadType.toString(10)),r.attributes.payloads=i.audioCodecs,r.attributes.extmaps=i.audioExtensions,v("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:o,ssrcGroups:s}=mi([{ssrcId:rf}],this.cname);r.attributes.ssrcs=o,r.attributes.ssrcGroups=s;}}this.sessionDesc=n,this.currentMidIndex=n.mediaDescriptions.length-1;}preloadRemoteMedia(e){this.rtpCapabilities;let n=this.candidates,i=this.dtlsParameters,r=this.iceParameters,o=this.rtpCapabilities.send;for(let s=1;s<e;s++){let a=2*s+rf,c=2*s+of,{ssrcs:d,ssrcGroups:l}=mi([{ssrcId:a}],this.cname),{ssrcs:u,ssrcGroups:h}=mi([{ssrcId:c,rtx:v("USE_SUB_RTX")?c+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:th,protos:["UDP","TLS","RTP","SAVPF"],fmts:o.videoCodecs.map(p=>p.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:r.iceUfrag,icePwd:r.icePwd,unrecognized:[],candidates:n,extmaps:o.videoExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:u,ssrcGroups:h,rtcpFeedbackWildcards:[],payloads:o.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*s-1)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:th,protos:["UDP","TLS","RTP","SAVPF"],fmts:o.audioCodecs.map(p=>p.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:r.iceUfrag,icePwd:r.icePwd,unrecognized:[],candidates:n,extmaps:o.audioExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:l,rtcpFeedbackWildcards:[],payloads:o.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*s)}}),this.currentMidIndex+=2;}this.updateBundleMids();}toString(){return ue.print(this.sessionDesc)}send(e,n,i,r){let{ssrcs:o,ssrcGroups:s}=mi(n,this.cname,v("SYNC_GROUP")?i:void 0),a=this.findPreloadMediaDesc(o);if(a){if(Xt()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,a.attributes.mid),r&&(r.twcc||r.remb)){let c=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(a,r),{mid:a.attributes.mid,needExchangeSDP:!0}}return {mid:a.attributes.mid,needExchangeSDP:!1}}{let c=this.findAvailableMediaIndex(e,o),d;return c===-1||Ke()||mn()||Yv()||c===0&&v("USE_SUB_RTX")?(d=this.createOrRecycleSendMedia(e,o,s,"sendonly",r),this.updateBundleMids()):(d=ne(this.sessionDesc.mediaDescriptions[c]),d.attributes.direction="sendonly",d.attributes.ssrcs=o,d.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(d,r)),Xt()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,d.attributes.mid),{mid:d.attributes.mid,needExchangeSDP:!0}}}batchSend(e){let n=e.map(o=>{let{kind:s,ssrcMsg:a,mslabel:c}=o;return this.send(s,a,c)}),i=[],r=!1;return n.forEach(o=>{let{mid:s,needExchangeSDP:a}=o;a&&(r=!0),i.push(s);}),{mids:i,needExchangeSDP:r}}stopSending(e){let n=this.sessionDesc.mediaDescriptions.filter(i=>i.attributes.mid&&e.indexOf(i.attributes.mid)!==-1);if(n.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");n.forEach(i=>{i.attributes.mid==="0"||Xt()||Ke()||mn()?i.attributes.ssrcs=[]:(i.attributes.ssrcs=[],i.attributes.direction="inactive",i.media.port="0");}),this.updateBundleMids();}mute(e){let n=this.sessionDesc.mediaDescriptions.find(i=>i.attributes.mid===e);if(!n)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));n.attributes.direction="inactive";}unmute(e){let n=this.sessionDesc.mediaDescriptions.find(i=>i.attributes.mid===e);if(!n)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));n.attributes.direction="sendonly";}muteRemote(e){let n=this.sessionDesc.mediaDescriptions.filter(i=>q(e).call(e,i.attributes.mid||""));if(n.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");n.forEach(i=>{i.attributes.direction="inactive";});}unmuteRemote(e){let n=this.sessionDesc.mediaDescriptions.filter(i=>q(e).call(e,i.attributes.mid||""));if(n.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");n.forEach(i=>{i.attributes.direction="recvonly";});}receive(e,n,i,r){e.forEach((o,s)=>{this.createOrRecycleRecvMedia(o,[],"recvonly",n,i,r[s]);}),this.updateBundleMids();}stopReceiving(e){let n=this.sessionDesc.mediaDescriptions.filter(i=>e.indexOf(i.attributes.mid)!==-1);if(n.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");n.forEach(i=>{i.media.port="0",i.attributes.direction="inactive";}),this.updateBundleMids();}updateCandidates(e){e===In.TCP?this._candidates.forEach(n=>{this._candidates.findIndex(i=>i.transport==="tcp"&&i.connectionAddress===n.connectionAddress&&i.port===n.port)===-1&&this._candidates.push(UO(UO({},n),{},{foundation:"tcpcandidate",priority:Number(n.priority)-1+"",transport:"tcp",port:Number(n.port)+90+""}));}):this._candidates=this._candidates.filter(n=>n.transport!=="tcp");for(let n of this.sessionDesc.mediaDescriptions)n.attributes.candidates=this.candidates;}restartICE(e){e=ne(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach(n=>{n.attributes.iceUfrag=e.iceUfrag,n.attributes.icePwd=e.icePwd;});}predictReceivingMids(e){let n=[];for(let i=0;i<e;i++)n.push((this.currentMidIndex+i+1).toString(10));return n}findAvailableMediaIndex(e,n){return this.sessionDesc.mediaDescriptions.findIndex(i=>{let r=i.media.mediaType===e&&i.media.port!=="0"&&(i.attributes.direction==="sendonly"||i.attributes.direction==="sendrecv")&&i.attributes.ssrcs.length===0;if(Xt()){if(r){let o=this.firefoxSsrcMidMap.get(n[0].ssrcId);return !(o||i.attributes.mid!=="0"&&i.attributes.mid!=="1")||!(!o||o!==i.attributes.mid)}return !1}return r})}createOrRecycleRecvMedia(e,n,i,r,o,s){let a=e._mediaStreamTrack.kind,c=this.rtpCapabilities.recv,d=Ls(a,c,this.localCapabilities.send,a===tt.VIDEO?r:o),l=a===tt.VIDEO?c.videoExtensions:c.audioExtensions;this.currentMidIndex+=1;let u="".concat(this.currentMidIndex),h={media:{mediaType:a,port:th,protos:["UDP","TLS","RTP","SAVPF"],fmts:d.map(T=>T.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:l,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:n,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:d,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(u)}};h=this.mungRecvMediaDsec(h,e,s);let p=this.findFirstClosedMedia(a);if(p){let T=this.sessionDesc.mediaDescriptions.indexOf(p);this.sessionDesc.mediaDescriptions[T]=h;}else this.sessionDesc.mediaDescriptions.push(h);return h}updateRemoteCodec(e,n,i){let r=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(h=>h.rtpMap&&h.rtpMap.encodingName.toLowerCase()||"").filter(h=>{var p;return q(p=Object.keys(fa)).call(p,h)}))],o=new Set(n);if(r.every(h=>o.has(h)))return _.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(n)),!1;let s=this._rtpCapabilities.recv.videoCodecs.filter(h=>n.some(p=>{var T;return q(T=h.rtpMap&&h.rtpMap.encodingName.toLowerCase()||"").call(T,p)}));if(s.length===0)return _.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(r," codecs: ").concat(n)),!1;let a=[...new Set(s.map(h=>h.rtpMap&&h.rtpMap.encodingName.toLowerCase()||""))],c;if(_.debug("updateRemoteCodec, from ".concat(r," to ").concat(a)),e.length===0)c=this.sessionDesc.mediaDescriptions.filter(h=>h.media.mediaType==="video"&&h.attributes.direction==="recvonly");else if(c=this.sessionDesc.mediaDescriptions.filter(h=>h.attributes.mid&&q(e).call(e,h.attributes.mid)&&h.attributes.direction==="recvonly"),c.length!==e.length)return _.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(e,", codecs: ").concat(n)),!1;this._rtpCapabilities.recv.videoCodecs=s;let d=this.localCapabilities.send,l=this.rtpCapabilities.recv,u=Ls(tt.VIDEO,l,d,i);return c.forEach(h=>{let p=u.map(T=>T.payloadType.toString(10));_.debug("updateRemoteCodec mid: ".concat(h.attributes.mid,", from ").concat(h.attributes.payloads," to ").concat(u)),h.attributes.payloads=u,h.media.fmts=p;}),!0}createOrRecycleSendMedia(e,n,i,r,o){let s=this.rtpCapabilities.send,a=e===tt.VIDEO?s.videoCodecs:s.audioCodecs,c=e===tt.VIDEO?s.videoExtensions:s.audioExtensions;this.currentMidIndex+=1;let d="".concat(this.currentMidIndex),l={media:{mediaType:e,port:th,protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(h=>h.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:n,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:r,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};l=this.mungSendMediaDesc(l,o);let u=this.findFirstClosedMedia(e);if(u){let h=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[h]=l;}else this.sessionDesc.mediaDescriptions.push(l);return l}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(e=>e.media.port!=="0").map(e=>e.attributes.mid);}mungRecvMediaDsec(e,n,i){let r=ne(e);return Hu(r),Fo(r,n),Ku(r,n),JE(r),qa(r,i,this.localCapabilities.send),r}mungSendMediaDesc(e,n){let i=ne(e);return qa(i,n,this.localCapabilities.recv),mr(i),i}updateRecvMedia(e,n){let i=this.sessionDesc.mediaDescriptions.findIndex(r=>r.attributes.mid===e);if(i!==-1){let r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],n);this.sessionDesc.mediaDescriptions[i]=r;}}bumpMid(e){this.currentMidIndex+=e;}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find(n=>Xt()?n.media.port==="0"&&n.media.mediaType===e:n.media.port==="0")}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find(n=>{var i;return ((i=n.attributes)===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId)===e[0].ssrcId})}getSSRC(e){var n;return (n=this.sessionDesc.mediaDescriptions.find(i=>i.attributes.mid===e))===null||n===void 0?void 0:n.attributes.ssrcs}}var kt;function VO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function eh(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?VO(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):VO(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}let iH=(kt=class _h extends su{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){let e;return this.localCapabilities&&(e=za(this.localCapabilities)),[...new Set(e&&e.send.videoCodecs.map(n=>n.rtpMap&&n.rtpMap.encodingName.toLowerCase()||"").filter(n=>{var i;return q(i=Object.keys(fa)).call(i,n)}))]}constructor(e,n,i){super(e,n),g(this,"store",void 0),g(this,"peerConnection",void 0),g(this,"remoteSDP",void 0),g(this,"initialOffer",void 0),g(this,"transportEventReceiver",void 0),g(this,"statsFilter",void 0),g(this,"useXR",v("USE_XR")),g(this,"localCapabilities",void 0),g(this,"localCandidateCount",0),g(this,"allCandidatesReceived",!1),g(this,"remoteCodecs",void 0),g(this,"dataStreamChannelMap",new Map),g(this,"establishPromise",void 0),g(this,"mutex",new Qe("NVExtentionsConnection-mutex")),g(this,"rtcMedia",void 0),this.store=n,this.peerConnection=i,this.statsFilter=Wu(this.peerConnection,v("STATS_UPDATE_INTERVAL"),void 0,Xt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish();}async establish(e){try{let n=await this.peerConnection.createOffer();if(!n.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let i=_r(n.sdp),r=await QE({filterRTX:!v("USE_PUB_RTX")&&!v("USE_SUB_RTX"),filterVideoFec:v("FILTER_VIDEO_FEC"),filterAudioFec:v("FILTER_AUDIO_FEC"),filterVideoCodec:v("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=r,this.initialOffer=n,eh(eh({},i),{},{rtpCapabilities:r,offerSDP:n.sdp})}catch(n){throw new w(R.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(e,n,i,r,o,s){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnection without initial offer.");this.remoteSDP=new nH({remoteIceParameters:e,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r,remoteSetup:o,localCapabilities:za(this.localCapabilities),cname:s});let a=this.remoteSDP.toString(),c=ue.parse(this.initialOffer.sdp),d=c.mediaDescriptions.find(h=>h.media.mediaType==="audio");d&&mr(d),this.useXR&&Yu(c);let l=ue.print(c),u=this.logSDPExchange(l||"","offer","local","connect");await this.peerConnection.setLocalDescription({type:"offer",sdp:l}),u?.(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a});}catch(a){throw new w(R.EXCHANGE_SDP_FAILED,"NV.connect failed; ".concat(a.toString()))}}async updateRemoteRTPCapabilities(e,n){if(this.remoteCodecs=n,!this.remoteSDP)return void _.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(n));if(this.remoteSDP.updateRemoteCodec(e,n,this.store.codec)){let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i);let o=this.remoteSDP.toString();r?.(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o});}else _.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.");}async updateRemoteConnect(e){var n,i,r,o;(n=this.remoteSDP)===null||n===void 0||n.updateRemoteRTPCapabilities(e),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&((o=this.remoteSDP)===null||o===void 0||o.updateRemoteCodec([],this.remoteCodecs,this.store.codec)),(i=this.remoteSDP)===null||i===void 0||i.preloadRemoteMedia(2);let s=(r=this.remoteSDP)===null||r===void 0?void 0:r.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});let a=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(a),_.debug("[NVExtentionsConnection] updateRemoteRTPCapabilities by exchanging SDP.");}send(e,n,i){var r=this;return $n(function*(){let o=yield gt(r.mutex.lock("From NVExtentionsConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.send before remote SDP created");let s=[];e.forEach(m=>{let E=r.peerConnection.addTransceiver(m._mediaStreamTrack,{direction:"sendonly"});s.push(E);}),Xt()&&v("SIMULCAST")===!0&&(yield gt(r.applySimulcastForFirefox(s,e)));let a=yield gt(r.peerConnection.createOffer()),c=r.remoteSDP.predictReceivingMids(e.length),d=r.mungSendOfferSDP(a.sdp,e,c),l=ue.parse(d),u=c.map(m=>{let E=l.mediaDescriptions.find(S=>S.attributes.mid===m);if(!E)throw new Error("Cannot extract ssrc from mediaDescription.");return zE(E,v("USE_PUB_RTX"))}),h;try{h=yield u;}catch(m){h=[],r.remoteSDP.receive(e,n,i,h);let E=r.remoteSDP.toString();throw yield gt(r.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield gt(r.peerConnection.setRemoteDescription({type:"answer",sdp:E})),yield gt(r.stopSending(c,!0)),m}r.remoteSDP.receive(e,n,i,h);let p=r.remoteSDP.toString(),T=r.logSDPExchange(d,"offer","local","send");return yield gt(r.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield gt(r.applySimulcastEncodings(s,e)),yield gt(r.applySendEncodings(s,e)),T?.(p),yield gt(r.peerConnection.setRemoteDescription({type:"answer",sdp:p})),s.map((m,E)=>{let S=c[E];return {localSSRC:u[E],id:S,transceiver:m}})}catch(s){throw s instanceof w?s:new w(R.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.send failed; ".concat(s.toString()))}finally{o();}})()}async stopSending(e,n){let i=n?void 0:await this.mutex.lock("From NVExtentionsConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopSending before remote SDP created");let r=this.peerConnection.getTransceivers().filter(c=>e.indexOf(c.mid)!==-1);if(r.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVExtentionsConnection.stopSending.");r.map(c=>{var d;c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c);});let o=await this.peerConnection.createOffer(),s=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(e);let a=this.remoteSDP.toString();s?.(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a});}catch(r){throw new w(R.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.stopSending failed; ".concat(r.toString()))}finally{i&&i();}}async createDataChannels(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(e);return i&&i.readyState==="open"?_.debug("[P2PConnection] Channels are already available and can be reused directly."):(i=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:v("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,i)),void n.forEach(r=>{r._updateOriginDataChannel(i);})}catch(i){throw i instanceof w?i:new w(R.DATACHANNEL_FAILED,"NVExtentionsConnection.createDataChannels failed; ".concat(i.toString()))}}async stopDataChannels(e){try{let n=this.dataStreamChannelMap.get(e);return n?.close(),void this.dataStreamChannelMap.delete(e)}catch(n){throw n instanceof w?n:new w(R.DATACHANNEL_FAILED,"NVExtentionsConnection.stopDataChannels failed; ".concat(n.toString()))}}async receive(e,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.receive ".concat(e," before remoteSDP created."));let{mid:o,needExchangeSDP:s}=this.remoteSDP.send(e,n,i,r);if(s){let c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});let l=await this.peerConnection.createAnswer(),u=this.mungReceiveAnswerSDP(l.sdp,o,e);d?.(u||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:u}),_.debug("[NVExtentionsConnection] receive ".concat(e," by exchanging SDP."));}else _.debug("[NVExtentionsConnection] receive ".concat(e," no need to exchange SDP."));let a=this.peerConnection.getTransceivers().find(c=>c.mid===o);if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return {track:a.receiver.track,id:o}}catch(o){throw new w(R.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(o.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.batchReceive before remoteSDP created.");let{mids:n,needExchangeSDP:i}=this.remoteSDP.batchSend(e);if(i){let r=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});let s=await this.peerConnection.createAnswer();o?.(s.sdp||""),await this.peerConnection.setLocalDescription(s),_.debug("[NVExtentionsConnection] batchReceive by exchanging SDP.");}else _.debug("[NVExtentionsConnection] batchReceive no need to exchange SDP.");return n.map(r=>{let o=this.peerConnection.getTransceivers().find(s=>s.mid===r);if(!o)throw new Error("Cannot get transceiver after setLocalDescription.");return {track:o.receiver.track,id:r}})}catch(n){throw new w(R.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(n.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);let n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});let r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r);}catch(n){throw new w(R.EXCHANGE_SDP_FAILED,"NVExtentionsConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);let n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});let r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r);}catch(n){throw new w(R.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteRemote failed; ".concat(n.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);let n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});let r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r);}catch(n){throw new w(R.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteRemote failed; ".concat(n.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteLocal before remote SDP created.");let n=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(s=>{s.direction="inactive";});let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);let o=this.remoteSDP.toString();r?.(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o});}catch(n){throw new w(R.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteLocal before remote SDP created.");let n=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(async(s,a)=>{s.direction="sendonly";});let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);let o=this.remoteSDP.toString();r?.(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o});}catch(n){throw new w(R.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(e){var n=this;return $n(function*(){let i=yield gt(n.mutex.lock("From NVExtentionsConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(Ot().supportPCSetConfiguration){let d=n.peerConnection.getConfiguration(),l=e===In.RELAY?"relay":"all";d.iceTransportPolicy!==l&&(_.debug("restartICE change iceTransportPolicy from [".concat(d.iceTransportPolicy,"] to [").concat(l,"]")),d.iceTransportPolicy=l,n.peerConnection.setConfiguration(d));}else if(e===In.RELAY)return;e!==In.RELAY&&n.remoteSDP.updateCandidates(e);let r=yield gt(n.peerConnection.createOffer({iceRestart:!0}));if(!r.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let o=_r(r.sdp),{remoteIceParameters:s}=yield o.iceParameters;n.remoteSDP.restartICE(s);let a=n.remoteSDP.toString(),c=n.logSDPExchange(r.sdp||"","offer","local","restartICE");yield gt(n.peerConnection.setLocalDescription(r)),c?.(a),yield gt(n.peerConnection.setRemoteDescription({type:"answer",sdp:a}));}catch(r){_.warning("restart ICE failed, abort operation",r);}finally{i();}})()}close(){var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear();}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.updateEncoderConfig before remote SDP created.");let i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n],[e]);this.remoteSDP.updateRecvMedia(e,n);let o=this.remoteSDP.toString(),s=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),s?.(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o});}catch(i){throw new w(R.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(e,n){let i=this.peerConnection.getTransceivers().filter(r=>r.mid===e);i.length===1&&(this.isVP8Simulcast(n)?Xt()||await this.applySimulcastEncodings(i,[n]):await this.applySendEncodings(i,[n]));}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n);}async replaceTrack(e,n){let i=this.peerConnection.getTransceivers().find(r=>r.mid===n);i&&await i.sender.replaceTrack(e._mediaStreamTrack);}getP2PConnectionParams(){var e;if((e=this.peerConnection.currentLocalDescription)===null||e===void 0||!e.sdp||!this.localCapabilities)throw new Error;return eh(eh({},_r(this.peerConnection.currentLocalDescription.sdp)),{},{rtpCapabilities:this.localCapabilities})}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState);},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState);},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,_.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount));},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,_.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount));},v("CANDIDATE_TIMEOUT"));}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null;}static resolvePCConfiguration(e){let n={iceServers:[]};return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(_a(e.turnServer.servers)?n.iceServers=e.turnServer.servers:(n.iceServers&&n.iceServers.push(..._h.turnServerConfigToIceServers(e.turnServer.servers)),v("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(..._h.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),v("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(i=>{i.forceturn&&(n.iceTransportPolicy="relay");}))),n}static turnServerConfigToIceServers(e){let n=[];return e.forEach(i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(Do(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!v("FORCE_TURN_TCP")&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}));}),n}async applySendEncodings(e,n){try{if(!Ot().supportSetRtpSenderParameters||e.length!==n.length)return;for(let u=0;u<e.length;u++){let h=e[u],p=n[u];if(p&&p instanceof $t){var i,r,o;if(this.isVP8Simulcast(p))continue;let T={},m={};switch(p._optimizationMode){case"motion":T.degradationPreference="maintain-framerate";break;case"detail":T.degradationPreference="maintain-resolution";break;default:T.degradationPreference="balanced";}var s,a,c,d;if((i=p._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&(m.maxBitrate=1e3*((s=p._encoderConfig)===null||s===void 0?void 0:s.bitrateMax)),q(r=p._hints).call(r,ie.LOW_STREAM)&&((a=p._encoderConfig)!==null&&a!==void 0&&a.frameRate&&(m.maxFramerate=Wn(p._encoderConfig.frameRate)),(c=p._encoderConfig)!==null&&c!==void 0&&c.scaleResolutionDownBy&&((d=p._encoderConfig)===null||d===void 0?void 0:d.scaleResolutionDownBy)>1&&(m.scaleResolutionDownBy=p._encoderConfig.scaleResolutionDownBy)),v("DSCP_TYPE")&&Io()){var l;let C=v("DSCP_TYPE");q(l=["very-low","low","medium","high"]).call(l,C)&&(m.networkPriority=C);}let E=h.sender.getParameters(),S=(o=E.encodings)===null||o===void 0?void 0:o[0];Xt()&&!S&&(T.encodings=[m]),S&&Object.assign(S,m),Object.assign(E,T),await h.sender.setParameters(E);}}}catch{_.debug("Apply RTPSendEncodings failed.");}}mungSendOfferSDP(e,n,i){let r=ue.parse(e);return n.forEach((o,s)=>{let a=i[s],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(Fo(c,o),XE(c,o,this.store.codec));}),ue.print(r)}mungReceiveAnswerSDP(e,n,i){let r=ue.parse(e),o=r.mediaDescriptions.find(s=>s.attributes.mid===n);return o&&i===tt.AUDIO&&o.media.mediaType==="audio"&&mr(o),this.useXR&&Yu(r),ue.print(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,e);},this.statsFilter.onFirstVideoReceived=e=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,e);},this.statsFilter.onFirstAudioDecoded=e=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,e);},this.statsFilter.onFirstVideoDecoded=(e,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,n,i);},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,e,n);},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,e,n);},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,e);};}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0;}async applySimulcastForFirefox(e,n){if(e.length===n.length)for(let c=0;c<e.length;c++){var i,r,o,s,a;let d=e[c],l=n[c];if(l instanceof $t&&!q(i=l._hints).call(i,ie.LOW_STREAM)&&(r=l._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((o=l._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(s=l._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((a=l._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){let u={},h={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};u.encodings=[{rid:"m",active:!0,maxBitrate:h.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:h.high}];let p=d.sender.getParameters();await d.sender.setParameters(Object.assign(p,u));}}}async applySimulcastEncodings(e,n){if(!Xt()&&e.length===n.length)for(let i=0;i<e.length;i++){let r=n[i];if(r instanceof $t&&this.isVP8Simulcast(r)){let o=e[i],s={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];let c=o.sender.getParameters();await o.sender.setParameters(Object.assign(c,s));}}}isVP8Simulcast(e){var n,i,r,o,s;return !!(e instanceof $t&&v("SIMULCAST")&&this.store.codec==="vp8"&&!q(n=e._hints).call(n,ie.LOW_STREAM)&&(i=e._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=e._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(o=e._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((s=e._scalabilityMode)===null||s===void 0?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,n,i,r){if(v("SDP_LOGGING"))return _.upload("exchanging ".concat(i," ").concat(n," SDP during NVExtentionsConnection.").concat(r,`
`),e),n==="offer"?o=>{this.logSDPExchange(o,"answer",i==="local"?"remote":"local",r);}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;let n=this.remoteSDP.getSSRC(e);return n?.[0].ssrcId}setConfiguration(e){if(Ot().supportPCSetConfiguration){let n=_h.resolvePCConfiguration(e);this.peerConnection.setConfiguration(n);}}},W(kt.prototype,"connect",[Kn],Object.getOwnPropertyDescriptor(kt.prototype,"connect"),kt.prototype),W(kt.prototype,"updateRemoteRTPCapabilities",[Kn],Object.getOwnPropertyDescriptor(kt.prototype,"updateRemoteRTPCapabilities"),kt.prototype),W(kt.prototype,"updateRemoteConnect",[Kn],Object.getOwnPropertyDescriptor(kt.prototype,"updateRemoteConnect"),kt.prototype),W(kt.prototype,"createDataChannels",[Kn],Object.getOwnPropertyDescriptor(kt.prototype,"createDataChannels"),kt.prototype),W(kt.prototype,"receive",[Kn],Object.getOwnPropertyDescriptor(kt.prototype,"receive"),kt.prototype),W(kt.prototype,"batchReceive",[Kn],Object.getOwnPropertyDescriptor(kt.prototype,"batchReceive"),kt.prototype),W(kt.prototype,"stopReceiving",[Kn],Object.getOwnPropertyDescriptor(kt.prototype,"stopReceiving"),kt.prototype),W(kt.prototype,"muteRemote",[Kn],Object.getOwnPropertyDescriptor(kt.prototype,"muteRemote"),kt.prototype),W(kt.prototype,"unmuteRemote",[Kn],Object.getOwnPropertyDescriptor(kt.prototype,"unmuteRemote"),kt.prototype),W(kt.prototype,"muteLocal",[Kn],Object.getOwnPropertyDescriptor(kt.prototype,"muteLocal"),kt.prototype),W(kt.prototype,"unmuteLocal",[Kn],Object.getOwnPropertyDescriptor(kt.prototype,"unmuteLocal"),kt.prototype),W(kt.prototype,"close",[Kn],Object.getOwnPropertyDescriptor(kt.prototype,"close"),kt.prototype),W(kt.prototype,"updateEncoderConfig",[Kn],Object.getOwnPropertyDescriptor(kt.prototype,"updateEncoderConfig"),kt.prototype),W(kt.prototype,"updateSendParameters",[Kn],Object.getOwnPropertyDescriptor(kt.prototype,"updateSendParameters"),kt.prototype),W(kt.prototype,"replaceTrack",[Kn],Object.getOwnPropertyDescriptor(kt.prototype,"replaceTrack"),kt.prototype),W(kt.prototype,"getRemoteSSRC",[Kn],Object.getOwnPropertyDescriptor(kt.prototype,"getRemoteSSRC"),kt.prototype),kt);function Kn(t,e,n){let i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){let r=this.mutex,o=await r.lock("From NVExtentionsConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o();}},n}var Wt;function FO(t){var e,n,i,r=2;for(typeof Symbol<"u"&&(n=CO,i=Symbol.iterator);r--;){if(n&&(e=t[n])!=null)return e.call(t);if(i&&(e=t[i])!=null)return new nh(e.call(t));n="@@asyncIterator",i="@@iterator";}throw new TypeError("Object is not async iterable")}function nh(t){function e(n){if(Object(n)!==n)return K.reject(new TypeError(n+" is not an object."));var i=n.done;return K.resolve(n.value).then(function(r){return {value:r,done:i}})}return nh=function(n){this.s=n,this.n=n.next;},nh.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(n){var i=this.s.return;return i===void 0?K.resolve({value:n,done:!0}):e(i.apply(this.s,arguments))},throw:function(n){var i=this.s.return;return i===void 0?K.reject(n):e(i.apply(this.s,arguments))}},new nh(t)}let Ko=(Wt=class mh extends su{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){return this._p2pConnection.localCodecs}constructor(e,n){super(e,n),g(this,"store",void 0),g(this,"peerConnection",void 0),g(this,"cname",void 0),g(this,"mutex",new Qe("DataChannelConnection-mutex")),g(this,"dataChannel",void 0),g(this,"_p2pConnection",void 0),g(this,"establishPromise",void 0),g(this,"_nvMedia",void 0),this.store=n,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(mh.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new iH(e,n,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise;}async establish(){var e;let n=(e=this._nvMedia)===null||e===void 0?void 0:e.getLocalRtpCapabilities();return await this._p2pConnection.establish(n)}getP2PConnectionParams(){return this._p2pConnection.getP2PConnectionParams()}async connect(e,n,i,r,o,s){return this.cname=s,await this._p2pConnection.connect(e,n,i,r,o,s),await new K((a,c)=>{let d=setTimeout(()=>{this.closeSignal(),c(new w(R.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(i))));},2e3);this.dataChannel.onopen=()=>{if(this.dataChannel.readyState==="open")return clearTimeout(d),void a()},this.dataChannel.onerror=l=>{this.closeSignal(),c(l);};}),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(e,n){return this._p2pConnection.updateRemoteRTPCapabilities(e,n)}send(e,n,i){var r=this;return $n(function*(){let o=yield gt(r.mutex.lock("From DataChannelConnection.send"));try{return yield*Ju(FO(r._p2pConnection.send(e,n,i)))}finally{o();}})()}async stopSending(e,n){return this._p2pConnection.stopSending(e,n)}async createDataChannels(e,n){return this._p2pConnection.createDataChannels(e,n)}async stopDataChannels(e){return this._p2pConnection.stopDataChannels(e)}async receive(e,n,i,r){return this._nvMedia?(_.debug("[DataChannelConnection] receive ".concat(e," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(e,n,this.cname)):(_.debug("[DataChannelConnection] receive ".concat(e," by WebRTC.")),await this._p2pConnection.receive(e,n,i,r))}async batchReceive(e){return [...await this._p2pConnection.batchReceive(e)]}async stopReceiving(e){return await this._p2pConnection.stopReceiving(e)}async muteRemote(e){return await this._p2pConnection.muteRemote(e)}async unmuteRemote(e){return await this._p2pConnection.unmuteRemote(e)}async muteLocal(e){return await this._p2pConnection.muteLocal(e)}async unmuteLocal(e){return await this._p2pConnection.unmuteLocal(e)}restartICE(e){var n=this;return $n(function*(){return yield*Ju(FO(n._p2pConnection.restartICE(e)))})()}close(){var e;(e=this._nvMedia)===null||e===void 0||e.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection);}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(e){return this._p2pConnection.getRemoteVideoIsReady(e)}updateRemoteConnect(e){var n;(n=this._nvMedia)===null||n===void 0||n.setRemoteRtpCapabilities(e),this._p2pConnection.updateRemoteConnect(e);}async updateEncoderConfig(e,n){return await this._p2pConnection.updateEncoderConfig(e,n)}async updateSendParameters(e,n){return await this._p2pConnection.updateSendParameters(e,n)}setStatsRemoteVideoIsReady(e,n){this._p2pConnection.setStatsRemoteVideoIsReady(e,n);}async replaceTrack(e,n){return await this._p2pConnection.replaceTrack(e,n)}async getRemoteSSRC(e){return this._p2pConnection.getRemoteSSRC(e)}logSDPExchange(e,n,i,r){if(v("SDP_LOGGING"))return _.upload("exchanging ".concat(i," ").concat(n," SDP during DataChannelConnection.").concat(r,`
`),e),n==="offer"?o=>{this.logSDPExchange(o,"answer",i==="local"?"remote":"local",r);}:void 0}static resolvePCConfiguration(e){let n={iceServers:[]};return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(_a(e.turnServer.servers)?n.iceServers=e.turnServer.servers:(n.iceServers&&n.iceServers.push(...mh.turnServerConfigToIceServers(e.turnServer.servers)),v("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...mh.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),v("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(i=>{i.forceturn&&(n.iceTransportPolicy="relay");}))),n}static turnServerConfigToIceServers(e){let n=[];return e.forEach(i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(Do(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!v("FORCE_TURN_TCP")&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}));}),n}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=e=>{var n;return (n=this.onICEConnectionStateChange)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onConnectionStateChange=e=>{var n;return (n=this.onConnectionStateChange)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onDTLSTransportStateChange=e=>{var n;return (n=this.onDTLSTransportStateChange)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onDTLSTransportError=e=>{var n;return (n=this.onDTLSTransportError)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onICETransportStateChange=e=>{var n;return (n=this.onICETransportStateChange)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstAudioReceived=e=>{var n;return (n=this.onFirstAudioReceived)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstVideoReceived=e=>{var n;return (n=this.onFirstVideoReceived)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstAudioDecoded=e=>{var n;return (n=this.onFirstAudioDecoded)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstVideoDecoded=(e,n,i)=>{var r;return (r=this.onFirstVideoDecoded)===null||r===void 0?void 0:r.call(this,e,n,i)},this._p2pConnection.onFirstVideoDecodedTimeout=e=>{var n;return (n=this.onFirstVideoDecodedTimeout)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onSelectedLocalCandidateChanged=(e,n)=>{var i;return (i=this.onSelectedLocalCandidateChanged)===null||i===void 0?void 0:i.call(this,e,n)},this._p2pConnection.onSelectedRemoteCandidateChanged=(e,n)=>{var i;return (i=this.onSelectedRemoteCandidateChanged)===null||i===void 0?void 0:i.call(this,e,n)};}closeSignal(){this.dataChannel.close(),this.peerConnection.close();}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0;}setConfiguration(e){this._p2pConnection.setConfiguration(e);}},W(Wt.prototype,"connect",[Ei],Object.getOwnPropertyDescriptor(Wt.prototype,"connect"),Wt.prototype),W(Wt.prototype,"updateRemoteRTPCapabilities",[Ei],Object.getOwnPropertyDescriptor(Wt.prototype,"updateRemoteRTPCapabilities"),Wt.prototype),W(Wt.prototype,"createDataChannels",[Ei],Object.getOwnPropertyDescriptor(Wt.prototype,"createDataChannels"),Wt.prototype),W(Wt.prototype,"receive",[Ei],Object.getOwnPropertyDescriptor(Wt.prototype,"receive"),Wt.prototype),W(Wt.prototype,"stopReceiving",[Ei],Object.getOwnPropertyDescriptor(Wt.prototype,"stopReceiving"),Wt.prototype),W(Wt.prototype,"muteRemote",[Ei],Object.getOwnPropertyDescriptor(Wt.prototype,"muteRemote"),Wt.prototype),W(Wt.prototype,"unmuteRemote",[Ei],Object.getOwnPropertyDescriptor(Wt.prototype,"unmuteRemote"),Wt.prototype),W(Wt.prototype,"muteLocal",[Ei],Object.getOwnPropertyDescriptor(Wt.prototype,"muteLocal"),Wt.prototype),W(Wt.prototype,"unmuteLocal",[Ei],Object.getOwnPropertyDescriptor(Wt.prototype,"unmuteLocal"),Wt.prototype),W(Wt.prototype,"close",[Ei],Object.getOwnPropertyDescriptor(Wt.prototype,"close"),Wt.prototype),W(Wt.prototype,"updateEncoderConfig",[Ei],Object.getOwnPropertyDescriptor(Wt.prototype,"updateEncoderConfig"),Wt.prototype),W(Wt.prototype,"updateSendParameters",[Ei],Object.getOwnPropertyDescriptor(Wt.prototype,"updateSendParameters"),Wt.prototype),W(Wt.prototype,"replaceTrack",[Ei],Object.getOwnPropertyDescriptor(Wt.prototype,"replaceTrack"),Wt.prototype),W(Wt.prototype,"getRemoteSSRC",[Ei],Object.getOwnPropertyDescriptor(Wt.prototype,"getRemoteSSRC"),Wt.prototype),Wt);function Ei(t,e,n){let i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){let r=this.mutex,o=await r.lock("From DataChannelConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o();}},n}var Tt;function BO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function jr(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?BO(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):BO(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}function jO(t){var e,n,i,r=2;for(typeof Symbol<"u"&&(n=CO,i=Symbol.iterator);r--;){if(n&&(e=t[n])!=null)return e.call(t);if(i&&(e=t[i])!=null)return new ih(e.call(t));n="@@asyncIterator",i="@@iterator";}throw new TypeError("Object is not async iterable")}function ih(t){function e(n){if(Object(n)!==n)return K.reject(new TypeError(n+" is not an object."));var i=n.done;return K.resolve(n.value).then(function(r){return {value:r,done:i}})}return ih=function(n){this.s=n,this.n=n.next;},ih.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(n){var i=this.s.return;return i===void 0?K.resolve({value:n,done:!0}):e(i.apply(this.s,arguments))},throw:function(n){var i=this.s.return;return i===void 0?K.reject(n):e(i.apply(this.s,arguments))}},new ih(t)}let rh=(Tt=class extends de{get state(){return this._state}set state(t){let e=this._state;this._state=t,this.emit(ct.StateChange,e,this._state);}constructor(t,e){super(),g(this,"store",void 0),g(this,"statsUploader",void 0),g(this,"connection",void 0),g(this,"localTrackMap",new Map),g(this,"remoteUserMap",new Map),g(this,"localDataChannels",[]),g(this,"remoteDataChannelMap",new Map),g(this,"pendingLocalTracks",[]),g(this,"pendingRemoteTracks",[]),g(this,"pendingLocalDataChannels",[]),g(this,"pendingRemoteDataChannels",[]),g(this,"statsCollector",void 0),g(this,"isPlanB",!1),g(this,"shouldForwardP2PCreation",void 0),g(this,"iceFailedCount",0),g(this,"dtlsFailedCount",0),g(this,"mutex",new Qe("P2PChannel-mutex")),g(this,"_state",Gt.Disconnected),g(this,"_pcStatsUploadType",v("NEW_ICE_RESTART")?$r.FIRST_CONNECTION:$r.OLD_FIRST_CONNECTION),g(this,"_isInRestartIce",!1),g(this,"_isStartRestartIce",!1),g(this,"_restartStates",["disconnected","failed"]),g(this,"_restartTimer",void 0),g(this,"_isFirstConnected",!0),g(this,"handleMuteLocalTrack",async(n,i,r)=>{let o=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==Gt.Connected)return void r(new D(R.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));let s=this.filterTobeMutedTracks(n);if(s.length===0)return void i();let a=s.find(d=>d[0]==="videoLowTrack");a&&a[1].track._originMediaStreamTrack.stop(),await this.connection.muteLocal(s.map(d=>{let[,{id:l}]=d;return l}));let c=this.createMuteMessage(s);await Qt(this,ct.RequestMuteLocal,c),i();}catch(s){r(s);}finally{o();}}),g(this,"handleUnmuteLocalTrack",async(n,i,r)=>{let o=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==Gt.Connected)return void r(new D(R.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));let s=this.filterTobeUnmutedTracks(n);if(s.length===0)return void i();let a=s.find(d=>d[0]==="videoLowTrack");if(a){let d=a[1];if(d.track._originMediaStreamTrack.stop(),!v("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ot().supportDualStreamEncoding){let l=n._mediaStreamTrack.clone();d.track._mediaStreamTrack=l,d.track._originMediaStreamTrack=l;}else {let l=$E(n,hs(this,ct.RequestLowStreamParameter));d.track._mediaStreamTrack=l,d.track._originMediaStreamTrack=l;}await new K((l,u)=>{this.handleReplaceTrack(d.track,l,u,!0);});}await this.connection.unmuteLocal(s.map(d=>{let[,{id:l}]=d;return l}));let c=this.createUnmuteMessage(s);await Qt(this,ct.RequestUnmuteLocal,c),i();}catch(s){r(s);}finally{o();}}),g(this,"handleUpdateVideoEncoder",async(n,i,r)=>{let o=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{let s=this.localTrackMap.get(F.LocalVideoTrack);if(!this.connection||!s||s.track!==n||this.state!==Gt.Connected)return void i();let{id:a,track:c}=s;await this.connection.updateSendParameters(a,c),await this.connection.updateEncoderConfig(a,c),this.emit(ct.UpdateVideoEncoder,c),i();}catch(s){r(s);}finally{o();}}),g(this,"handleUpdateVideoSendParameters",async(n,i,r)=>{let o=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoSendParameters");try{let s=this.localTrackMap.get(F.LocalVideoTrack);if(!this.connection||!s||s.track!==n||this.state!==Gt.Connected)return void i();let{id:a,track:c}=s;await this.connection.updateSendParameters(a,c),i();}catch(s){r(s);}finally{o();}}),g(this,"handleReplaceMixingTrack",async(n,i,r,o)=>{if(!this.connection||this.state!==Gt.Connected)return void i();let s=ef([n]),a;_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(s.getTrackId(),"]")),typeof o=="boolean"&&o||(a=await this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{await this.replaceTrack(n,s),i();}catch(d){r(d);}finally{var c;(c=a)===null||c===void 0||c();}}),g(this,"handleReplaceTrack",async(n,i,r,o)=>{let s;_.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(n.getTrackId(),"]")),typeof o=="boolean"&&o||(s=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var a;let d=Array.from(this.localTrackMap.entries()).find(l=>{let[,{track:u}]=l;return n===u});if(!this.connection||!d||this.state!==Gt.Connected)return void i();if(await((a=this.connection)===null||a===void 0?void 0:a.replaceTrack(n,d[1].id)),this.isPlanB){let l=d[1];l.id=n._mediaStreamTrack.id,this.localTrackMap.set(d[0],l);}if(d[0]===F.LocalVideoTrack&&!v("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ot().supportDualStreamEncoding){let l=this.localTrackMap.get(F.LocalVideoLowTrack);if(l){let u=n._mediaStreamTrack.clone();l.track._originMediaStreamTrack.stop(),l.track._mediaStreamTrack=u,l.track._originMediaStreamTrack=u,await new K((h,p)=>{this.handleReplaceTrack(l.track,h,p,!0);});}}i();}catch(d){r(d);}finally{var c;(c=s)===null||c===void 0||c();}}),g(this,"handleGetRTCStats",n=>{n(this.statsCollector.getRTCStats());}),g(this,"handleGetLocalVideoStats",n=>{n(this.statsCollector.getLocalVideoTrackStats());}),g(this,"handleGetLocalAudioStats",n=>{n(this.statsCollector.getLocalAudioTrackStats());}),g(this,"handleGetRemoteVideoStats",n=>this.statsCollector.getRemoteVideoTrackStats(n.uid)[n.uid]),g(this,"handleGetRemoteAudioStats",n=>this.statsCollector.getRemoteAudioTrackStats(n.uid)[n.uid]),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new rO(this.store),this.bindStatsUploaderEvents(),this.isPlanB=!Ot().supportUnifiedPlan||v("CHROME_FORCE_PLAN_B")&&Io(),this.shouldForwardP2PCreation=v("FORWARD_P2P_CREATION")&&Ot().supportPCSetConfiguration&&rm(),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Ko({},this.store):this.isPlanB?new Ja({},this.store):new gr({},this.store),this.bindConnectionEvents(this.connection));}async startP2PConnection(t,e){var n;this.state=Gt.New;let i=this.shouldForwardP2PCreation&&((n=this.connection)===null||n===void 0?void 0:n.peerConnectionState)==="closed";if(this.shouldForwardP2PCreation&&!i||(i&&this.connection&&(_.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.connection.close(),this.unbindConnectionEvents(this.connection)),this.connection=this.store.useDataChannel?new Ko(t,this.store):this.isPlanB?new Ja(t,this.store):new gr(t,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new D(R.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=v("NEW_ICE_RESTART")?$r.FIRST_CONNECTION:$r.OLD_FIRST_CONNECTION,this._isFirstConnected=!0,this._isInRestartIce=!1,this._isStartRestartIce=!1,this.connection.setConfiguration(t),this.connection.establishPromise}async connect(t,e,n,i,r,o){if(!this.connection)throw new D(R.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.connection instanceof Ko?this.connection.updateRemoteConnect(i):(this.store.peerConnectionStart(),await this.connection.connect(t,e,n,i,r,o),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Gt.Connected);}updateRemoteRTPCapabilities(t){let e=Array.from(this.localTrackMap.entries()).filter(r=>{var o;let[s]=r;return q(o=[F.LocalVideoLowTrack,F.LocalVideoTrack]).call(o,s)}),n=e.map(r=>{let[,{id:o}]=r;return o}),i=e.map(r=>{let[o]=r;return o});if(this.connection instanceof gr){if(et.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(i),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(t)}),!q(t).call(t,this.store.codec)){let r=["vp9","vp8","h264"].find(o=>q(t).call(t,o));r&&(this.store.codec=r,_.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(r,".")));}this.connection.updateRemoteRTPCapabilities(n,t);}}async preConnect(t,e,n,i,r,o){if(!this.connection)throw new D(R.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.store.peerConnectionStart();let s=await this.connection.connect(t,e,n,i,r,o);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Gt.Connected,s}getEstablishParams(){if(this.connection instanceof Ko)return this.connection.getP2PConnectionParams();throw new Error("Only DataChannelConnection needs to obtain establishParams")}async publishDataChannel(t){if(!this.connection||this.state!==Gt.Connected){if(this.state===Gt.Disconnected)throw new D(R.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return void t.forEach(n=>{var i;q(i=this.pendingLocalDataChannels).call(i,n)||this.pendingLocalDataChannels.push(n);})}let e=this.filterTobePublishedDataChannels(t);e.length!==0&&(e.forEach(n=>{let i=Date.now();this.store.publish(n.id.toString(),"datachannel",i);}),await this.connection.createDataChannels(this.store.uid,e),e.forEach(n=>{this.localDataChannels.push(n);let i=Date.now();this.store.publish(n.id+"","datachannel",void 0,i);}));}publish(t,e,n){var i=this;return $n(function*(){let r=yield gt(i.mutex.lock("From P2PChannel.publish"));try{if(!i.connection||i.state!==Gt.Connected){if(i.state===Gt.Disconnected)throw new D(R.UNEXPECTED_ERROR,"PeerConnection already disconnected.");i.throwIfTrackTypeNotMatch(t);let s=t.filter(a=>i.pendingLocalTracks.indexOf(a)===-1);return void(i.pendingLocalTracks=i.pendingLocalTracks.concat(s))}i.store.pubId=i.store.pubId+1,fn.markPublishStart(i.store.clientId,i.store.pubId);let o=i.filterTobePublishedTracks(t,e,n);if(o.length===0)return void(yield gt(i.tryToUnmuteAudio(t)));yield*Ju(jO(i.doPublish(i.connection,o)));}finally{r();}})()}doPublish(t,e){var n=this;return $n(function*(){e.forEach(u=>{let{track:h,type:p}=u,T=Date.now();n.store.publish(h.getTrackId(),p===F.LocalAudioTrack?"audio":"video",T);}),n.bindLocalTrackEvents(e);let i=e.map(u=>{let{track:h}=u;return h}),r=yield gt(t.send(e.map(u=>{let{track:h}=u;return h}),n.store.codec,n.store.audioCodec)),o=(yield gt(r.next())).value,s=n.createGatewayPublishMessage(e,o),a;try{a=yield s;}catch(u){throw r.throw(u),u?.code===R.WS_ABORT&&e.forEach(h=>{let{track:p}=h;n.pendingLocalTracks.indexOf(p)===-1&&n.pendingLocalTracks.push(p);}),n.unbindLocalTrackEvents(e),u}let c=n.mapPubResToRemoteConfig(s,a),d=(yield gt(r.next(c))).value,l=v("ENABLE_VIDEO_SEI");i.forEach(async u=>{let h=u.getRTCRtpTransceiver();h&&l&&(u.trackMediaType===tt.VIDEO?await O3(h.sender,u):u.trackMediaType===tt.AUDIO&&await async function(p){if(!Ot().supportWebRTCEncodedTransform)return void _.warning("browser not support audio encoded transform");if(Bu.has(p)||!p.track)return;let T={track:p.track};if(vo()){if(!p.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");let E=null;try{E=p.createEncodedStreams();}catch(C){return void _.error("create audio-encoded-streams error",C&&C.message)}let S=new TransformStream({transform(C,A){T.controller||(T.controller=A),p.track&&p.track.id!==T.track.id&&(_.debug("audio track changed: ".concat(T.track.id," => ").concat(p.track.id)),T.track.removeEventListener("ended",m),T.track=p.track,T.track.addEventListener("ended",m)),A.enqueue(C);}});E.readable.pipeThrough(S).pipeTo(E.writable);}else if(Ke()){if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");let E=Fu(),S=new MessageChannel;await new K(A=>E.onmessage=b=>{b.data==="registered"&&A(void 0);});let C=new RTCRtpScriptTransform(E,{name:"tx",port:S.port2},[S.port2]);p.transform=C,await new K(A=>E.onmessage=b=>{b.data==="started"&&A(void 0);}),S.port1.onmessage=A=>{var b;A.data.transformed&&p.track&&((b=p.track)===null||b===void 0?void 0:b.id)!==T.track.id&&(_.debug("audio track changed: ".concat(T.track.id," => ").concat(p.track.id)),T.track.removeEventListener("ended",m),T.track=p.track,T.track.addEventListener("ended",m));},T.worker=E;}function m(){if(p.track){if(this.id!==p.track.id)return;p.track.removeEventListener("ended",m);}let E=Bu.get(p);if(E){Bu.delete(p);try{var S,C;(S=E.controller)===null||S===void 0||S.terminate(),(C=E.worker)===null||C===void 0||C.terminate();}catch(A){_.warning(A&&A.message);}}}Bu.set(p,T),p.track.addEventListener("ended",m);}(h.sender));}),e.forEach(u=>{let{type:h}=u;n.statsCollector.addLocalStats(h);}),n.assignLocalTracks(e,d),n.statsUploader.startUploadOutboundStats(),e.forEach(u=>{let{track:h,type:p}=u,T=Date.now();n.store.publish(h.getTrackId(),p===F.LocalAudioTrack?"audio":"video",void 0,T);});})()}async updateVideoStreamParameter(t,e){let n=this.localTrackMap.get(e);if(!n)return;if(!(n.track instanceof $t))return _.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");if(!(this.connection instanceof gr||this.connection instanceof Ja))return _.warn("[updateVideoStreamParameter]: connection is not P2PConnection or P2PConnectionPlanB");let{track:i}=n,r=function(o,s){let a={};return o.height&&o.width&&(a.scaleResolutionDownBy=Om(o,s)),a.maxFramerate=o.framerate?Wn(o.framerate):void 0,a.maxBitrate=o.bitrate?1e3*o.bitrate:void 0,a}(t,i);if(i._encoderConfig||(i._encoderConfig={}),e!==F.LocalVideoLowTrack||!v("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ot().supportDualStreamEncoding)r.scaleResolutionDownBy!=null&&(i._encoderConfig.scaleResolutionDownBy=r.scaleResolutionDownBy);else {let o=i._originMediaStreamTrack;if(!o.canvas)return _.warn("[".concat(i.getTrackId(),"] no canvas on track"));(function(s,a){let c=s.canvas;a.width&&(c.width=Wn(a.width)),a.height&&(c.height=Wn(a.height)),a.framerate&&(c.stopCapture&&c.stopCapture(),c.stopCapture=kE(()=>{!c.startCapture&&c.stopCapture&&c.stopCapture(),c.startCapture&&c.startCapture();},Wn(a.framerate)));})(o,t);}r.maxBitrate!=null&&(i._encoderConfig.bitrateMax=r.maxBitrate/1e3),r.maxFramerate!=null&&(i._encoderConfig.frameRate&&typeof i._encoderConfig.frameRate=="object"?i._encoderConfig.frameRate.max=r.maxFramerate:i._encoderConfig.frameRate={max:r.maxFramerate}),_.debug("[".concat(i.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(i._encoderConfig))),await this.connection.updateRtpSenderEncodings(i);}publishLowStream(t){var e=this;return $n(function*(){if(!e.connection||e.state!==Gt.Connected)return;let n=yield gt(e.mutex.lock("Locking from P2PChannel.publishLowStream"));try{let r=e.localTrackMap.get(F.LocalVideoTrack);if(!r)throw new D(R.UNEXPECTED_ERROR,"Could not find high stream");if(e.localTrackMap.has(F.LocalVideoLowTrack))throw new D(R.UNEXPECTED_ERROR,"[".concat(e.store.clientId,"] Can't publish low stream when stream already publish"));let o=[{track:e.getLowVideoTrack(r.track,t),type:F.LocalVideoLowTrack}];if(yield*Ju(jO(e.doPublish(e.connection,o))),r.track.muted||!r.track.enabled){var i;let s=(i=e.localTrackMap.get(F.LocalVideoLowTrack))===null||i===void 0?void 0:i.id;s!==void 0&&(yield gt(e.connection.muteLocal([s])));}}finally{n();}})()}async republish(){this.pendingLocalTracks.length>0&&(_.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await Me(this,ct.RequestRePublish,this.pendingLocalTracks),this.emit(ct.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(_.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await Me(this,ct.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[]);}async reSubscribe(t){for(let e=this.pendingRemoteTracks.length-1;e>=0;e--){let{user:n,kind:i}=this.pendingRemoteTracks[e];(i!==tt.AUDIO||n._audio_added_&&n._audioSSRC)&&(i!==tt.VIDEO||n._video_added_&&n._videoSSRC)||this.pendingRemoteTracks.splice(e,1);}if(t)await Me(this,ct.RequestReSubscribe,this.pendingRemoteTracks);else for(let{user:e,kind:n}of this.pendingRemoteTracks)await this.subscribe(e,n,n===tt.VIDEO?e._videoSSRC:e._audioSSRC);this.pendingRemoteTracks.forEach(e=>{let{user:n}=e;this.emit(ct.MediaReconnectEnd,n.uid);}),this.pendingRemoteTracks=[];}async unpublish(t){if(!this.connection||this.state!==Gt.Connected)return void t.forEach(i=>{let r=this.pendingLocalTracks.indexOf(i);r!==-1&&this.pendingLocalTracks.splice(r,1);});let e=this.filterTobeUnpublishedTracks(t);if(e.length===0)return;let n=e.find(i=>i[0]==="videoLowTrack");return n&&n[1].track.close(),this.doUnpublish(this.connection,e)}async unpublishDataChannel(t){if(!this.connection||this.state!==Gt.Connected)return void t.forEach(n=>{let i=this.pendingLocalDataChannels.indexOf(n);i!==-1&&this.pendingLocalDataChannels.splice(i,1);});let e=this.filterTobeUnpublishedDataChannels(t);return e.length!==0?(e.forEach(n=>{let i=this.localDataChannels.indexOf(n);i!==-1&&this.localDataChannels.splice(i,1);}),this.localDataChannels.length===0&&await this.connection.stopDataChannels(this.store.uid),e.map(n=>n.id)):void 0}async unpublishLowStream(){if(!this.connection||this.state!==Gt.Connected)return;let t=this.localTrackMap.get(F.LocalVideoLowTrack);if(!t)return;t.track.close();let e=[[F.LocalVideoLowTrack,t]];return this.doUnpublish(this.connection,e)}async doUnpublish(t,e){let n=this.createGatewayUnpublishMessage(e);return await t.stopSending(e.map(i=>{let[,{id:r}]=i;return r})),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map(i=>{let[r,{track:o}]=i;return {type:r,track:o}})),e.forEach(i=>{let[r]=i;this.statsCollector.removeLocalStats(r);}),this.localTrackMap.size===0&&this.statsUploader.stopUploadOutboundStats(),n}async subscribeDataChannel(t,e){if(!this.connection||this.state!==Gt.Connected)throw new D(R.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");let n=e.filter(i=>{var r;return !((r=this.remoteDataChannelMap.get(t))!==null&&r!==void 0&&r.get(i.id))});if(n.length!==0)return await this.connection.createDataChannels(t.uid,n),n.forEach(i=>{var r;this.remoteDataChannelMap.has(t)?(r=this.remoteDataChannelMap.get(t))===null||r===void 0||r.set(i.id,i):this.remoteDataChannelMap.set(t,new Map([[i.id,i]]));let o=this.pendingRemoteDataChannels.findIndex(s=>{let{user:a,id:c}=s;return a.uid===t.uid&&c===i.id});o!==-1&&this.pendingRemoteDataChannels.splice(o,1);}),n.map(i=>i.id)}async subscribe(t,e,n,i,r){var o;if(!this.connection||this.state!==Gt.Connected)throw new D(R.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if((o=this.remoteUserMap.get(t))!==null&&o!==void 0&&o.has(e))return;let s,a,c;if(r){let u=r.find(p=>{let{stream_type:T}=p;return T===e});if(!u)throw new D(R.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(e," for user: ").concat(t.uid," because subscribe answer from gateway does not contain stream_type: ").concat(e,"."));let h=await this.connection.receive(e,u.ssrcs,String(t._uintid),u.attributes);this.connection instanceof gr&&(c=h.transceiver),s=h.track,a=h.id;}else {let u=await this.connection.receive(e,[{ssrcId:n,rtx:i}],String(t._uintid),void 0);this.connection instanceof gr&&(c=u.transceiver),s=u.track,a=u.id;}e===tt.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(s):(t._audioTrack=new Ya(s,t.uid,t._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),c&&t._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(s):(t._videoTrack=new Ka(s,t.uid,t._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),c&&t._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(t,t._videoTrack)),v("ENABLE_VIDEO_SEI")&&c&&(e==tt.VIDEO?await N3(c.receiver,{onSei:u=>{var h;(h=t._videoTrack)===null||h===void 0||h._onSei(u);}}):e==tt.AUDIO&&await async function(u){if(!Ot().supportWebRTCEncodedTransform)return void _.warning("browser not support audio encoded transform");if(ju.has(u))return;let h={track:u.track};if(vo()){if(!u.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");let T=null;try{T=u.createEncodedStreams();}catch(E){return void _.error("create audio-encoded-streams error",E&&E.message)}let m=new TransformStream({transform(E,S){h.controller||(h.controller=S),u.track&&u.track.id!==h.track.id&&(_.debug("audio track changed: ".concat(h.track.id," => ").concat(u.track.id)),h.track.removeEventListener("ended",p),h.track=u.track,h.track.addEventListener("ended",p)),S.enqueue(E);}});T.readable.pipeThrough(m).pipeTo(T.writable);}else if(Ke()){if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");let T=Fu(),m=new MessageChannel;await new K(S=>T.onmessage=C=>{C.data==="registered"&&S(void 0);});let E=new RTCRtpScriptTransform(T,{name:"rx",port:m.port2},[m.port2]);u.transform=E,await new K(S=>T.onmessage=C=>{C.data==="started"&&S(void 0);}),m.port1.onmessage=S=>{var C;S.data.transformed&&u.track&&((C=u.track)===null||C===void 0?void 0:C.id)!==h.track.id&&(_.debug("audio track changed: ".concat(h.track.id," => ").concat(u.track.id)),h.track.removeEventListener("ended",p),h.track=u.track,h.track.addEventListener("ended",p));},h.worker=T;}function p(){u.track.removeEventListener("ended",p),function(T){let m=ju.get(T);if(m){ju.delete(T);try{var E,S;(E=m.controller)===null||E===void 0||E.terminate(),(S=m.worker)===null||S===void 0||S.terminate();}catch(C){_.warning(C&&C.message);}}}(u);}ju.set(u,h),u.track.addEventListener("ended",p);}(c.receiver));let d=this.remoteUserMap.get(t);d?d.set(e,a):this.remoteUserMap.set(t,new Map([[e,a]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadInboundStats();let l=this.pendingRemoteTracks.findIndex(u=>{let{user:h,kind:p}=u;return h.uid===t.uid&&e===p});l!==-1&&(this.pendingRemoteTracks.splice(l,1),this.emit(ct.MediaReconnectEnd,t.uid));}async massSubscribe(t){return this.massSubscribeNoLock(t)}async massSubscribeNoLock(t){if(!this.connection||this.state!==Gt.Connected)throw new D(R.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");t=t.filter(n=>{var i;let{user:r,mediaType:o}=n;return !((i=this.remoteUserMap.get(r))!==null&&i!==void 0&&i.has(o))});let e=await this.connection.batchReceive(t.map(n=>{let{user:i,mediaType:r,ssrcId:o,rtxSsrcId:s}=n;return {kind:r,ssrcMsg:[{ssrcId:o,rtx:s}],mslabel:String(i._uintid)}}));t.forEach((n,i)=>{let{user:r,mediaType:o}=n,{track:s,id:a,transceiver:c}=e[i];o===tt.AUDIO?(r._audioTrack?r._audioTrack._updateOriginMediaStreamTrack(s):(r._audioTrack=new Ya(s,r.uid,r._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(r._audioTrack.getTrackId()))),c&&r._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(r,r._audioTrack)):(r._videoTrack?r._videoTrack._updateOriginMediaStreamTrack(s):(r._videoTrack=new Ka(s,r.uid,r._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(r._videoTrack.getTrackId()))),c&&r._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(r,r._videoTrack));let d=this.remoteUserMap.get(r);d?d.set(o,a):this.remoteUserMap.set(r,new Map([[o,a]])),this.statsCollector.addRemoteStats(r.uid),this.statsUploader.startUploadInboundStats();let l=this.pendingRemoteTracks.findIndex(u=>{let{user:h,kind:p}=u;return h.uid===r.uid&&o===p});l!==-1&&(this.pendingRemoteTracks.splice(l,1),this.emit(ct.MediaReconnectEnd,r.uid));});}async unsubscribe(t,e,n){let i=this.pendingRemoteTracks.filter(s=>{let{user:a,kind:c}=s;return e!==void 0?a.uid===t.uid&&e===c:a.uid===t.uid});if(i.forEach(s=>{let a=this.pendingRemoteTracks.indexOf(s);this.pendingRemoteTracks.splice(a,1);}),this.connection&&this.state===Gt.Connected||n||i.forEach(s=>{let{kind:a}=s;var c;if(a===tt.AUDIO)(c=t._audioTrack)===null||c===void 0||c._destroy(),t._audioTrack=void 0;else if(a===tt.VIDEO){var d;(d=t._videoTrack)===null||d===void 0||d._destroy(),t._videoTrack=void 0;}}),!this.connection||this.state!==Gt.Connected)return;let r=this.filterTobeUnSubscribedTracks(t,e);if(r.length===0)return;await this.connection.stopReceiving(r.map(s=>{let[,{id:a}]=s;return a}));let o=this.createUnsubscribeMessage(r);return this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),r.forEach(s=>{let[a,{kind:c}]=s;var d,l;if(c===tt.VIDEO&&a._videoSSRC&&((d=this.connection)===null||d===void 0||d.setStatsRemoteVideoIsReady(a._videoSSRC,!1)),c===tt.VIDEO)this.unbindRemoteTrackEvents(a._videoTrack),n||((l=a._videoTrack)===null||l===void 0||l._destroy(),a._videoTrack=void 0);else if(c===tt.AUDIO){var u;this.unbindRemoteTrackEvents(a._audioTrack),!n&&((u=a._audioTrack)===null||u===void 0||u._destroy(),a._audioTrack=void 0);}}),o}async unsubscribeDataChannel(t,e){if(e.forEach(r=>{let o=this.pendingRemoteDataChannels.findIndex(s=>s.id===r.id);o!==-1&&this.pendingRemoteDataChannels.splice(o,1);}),!this.connection)return;let n=this.filterTobeUnSubscribedDataChannels(t,e);if(n.length===0)return;e.forEach(r=>{r._close();});let i=this.remoteDataChannelMap.get(t);return n.forEach(r=>{i&&i.delete(r.id);}),i&&i.size===0&&(this.remoteDataChannelMap.delete(t),await this.connection.stopDataChannels(t.uid)),n.map(r=>r.id)}async massUnsubscribe(t){return this.massUnsubscribeNoLock(t)}async massUnsubscribeNoLock(t){let e=[];for(let{user:r,mediaType:o}of t){let s=this.pendingRemoteTracks.filter(a=>{let{user:c,kind:d}=a;return o!==void 0?c.uid===r.uid&&o===d:c.uid===r.uid});s.forEach(a=>{let c=this.pendingRemoteTracks.indexOf(a);this.pendingRemoteTracks.splice(c,1);}),e=e.concat(s);}if(!this.connection||this.state!==Gt.Connected)return void e.forEach(r=>{let{user:o,kind:s}=r;var a;if(s===tt.AUDIO)(a=o._audioTrack)===null||a===void 0||a._destroy(),o._audioTrack=void 0;else if(s===tt.VIDEO){var c;(c=o._videoTrack)===null||c===void 0||c._destroy(),o._videoTrack=void 0;}});let n=rr(t).call(t,(r,o)=>{let{user:s,mediaType:a}=o,c=this.filterTobeUnSubscribedTracks(s,a);return r.concat(c)},[]);if(n.length===0)return;await this.connection.stopReceiving(n.map(r=>{let[,{id:o}]=r;return o}));let i=this.createUnsubscribeAllMessage(n);return this.withdrawRemoteTracks(n),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),n.forEach(r=>{let[o,{kind:s}]=r;var a,c;if(s===tt.VIDEO&&o._videoSSRC&&((a=this.connection)===null||a===void 0||a.setStatsRemoteVideoIsReady(o._videoSSRC,!1)),s===tt.VIDEO)this.unbindRemoteTrackEvents(o._videoTrack),(c=o._videoTrack)===null||c===void 0||c._destroy(),o._videoTrack=void 0;else if(s===tt.AUDIO){var d;this.unbindRemoteTrackEvents(o._audioTrack),(d=o._audioTrack)===null||d===void 0||d._destroy(),o._audioTrack=void 0;}}),i}async muteRemote(t,e){if(!this.connection)return;let n=this.remoteUserMap.get(t);if(!n)return void _.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid,"."));if(!n.get(e))return void _.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));let i=e===tt.VIDEO?t._videoSSRC:t._audioSSRC;i!==void 0&&this.connection.setStatsRemoteVideoIsReady(i,!1);}async unmuteRemote(t,e){return this.unmuteRemoteNoLock(t,e)}async unmuteRemoteNoLock(t,e){if(!this.connection)return;let n=this.remoteUserMap.get(t);if(!n)return void _.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid,"."));n.get(e)||_.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));}getAllTracks(t){let e=this.localTrackMap.get(F.LocalAudioTrack);if(e?.track instanceof je){let n=e.track;return Array.from(this.localTrackMap.entries()).filter(i=>{let[r]=i;return r!==F.LocalAudioTrack}).filter(i=>{let[r]=i;return !(t&&r===F.LocalVideoLowTrack)}).map(i=>{let[,{track:r}]=i;return r}).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter(n=>{let[i]=n;return !(t&&i===F.LocalVideoLowTrack)}).map(n=>{let[,{track:i}]=n;return i})}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(t,e,n,i,r){if(t){let s=this.localTrackMap.get(F.LocalAudioTrack),a=i?this.localTrackMap.get(F.LocalVideoLowTrack):this.localTrackMap.get(F.LocalVideoTrack);et.publish(this.store.sessionId,{eventElapse:fn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:s?.track.getTrackLabel(),videoName:a?.track.getTrackLabel(),screenshare:a?.track._hints.indexOf(ie.SCREEN_TRACK)!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r});}else {var o;n||(n=[]);let s=n.find(c=>c instanceof Re),a=i?(o=this.localTrackMap.get(F.LocalVideoTrack))===null||o===void 0?void 0:o.track:n.find(c=>c instanceof $t);et.publish(this.store.sessionId,{eventElapse:fn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:s?.getTrackLabel(),videoName:a?.getTrackLabel(),screenshare:a?._hints.indexOf(ie.SCREEN_TRACK)!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r});}}reportSubscribeEvent(t,e,n,i){let r=i===tt.VIDEO?n._videoSSRC:n._audioSSRC;r&&et.subscribe(this.store.sessionId,{succ:t,ec:e,video:i===tt.VIDEO,audio:i===tt.AUDIO,peerid:n.uid,subscribeRequestid:i===tt.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:fn.measureFromSubscribeStart(this.store.clientId,r)});}reset(){_.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new Qe("P2PChannel-mutex"),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Ko({},this.store):this.isPlanB?new Ja({},this.store):new gr({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();let t=this.localTrackMap.get(F.LocalAudioTrack);if(t?.track instanceof je){if(t.track.trackList.length>0){let e=t.track;t.track.trackList.forEach(n=>{e.removeAudioTrack(n);});}t.track.close();}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=Gt.Disconnected;}getStats(){var t;return (t=this.connection)===null||t===void 0?void 0:t.getStats()}getRemoteVideoIsReady(t){var e;return ((e=this.connection)===null||e===void 0?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){let t=this.localTrackMap.get(F.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){let t=this.localTrackMap.get(F.LocalVideoTrack);if(t)return {width:t.track.videoWidth||0,height:t.track.videoHeight||0}}getEncoderConfig(t){let e=this.localTrackMap.get(t);return e&&e.track instanceof $t||e&&e.track instanceof Re?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;let n=this.remoteUserMap.get(t);return !!n&&(!e||n.has(e))}async hasRemoteMediaWithLock(t,e){if(!t)return this.remoteUserMap.size>0;let n=this.remoteUserMap.get(t);return !!n&&(!e||n.has(e))}getRemoteMedia(t){var e;let n=Array.from(ri(e=this.remoteUserMap).call(e)).find(i=>i.uid===t);return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map(n=>{let[i]=n;return {uid:i.uid,level:i.audioTrack?100*i.audioTrack._source.getAccurateVolumeLevel():0}}),e=this.localTrackMap.get(F.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=vc(t).call(t,(n,i)=>n.level-i.level),t}async disconnectForReconnect(){this.connection&&(_.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=Gt.Reconnecting,v("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e]=t;var n;e._videoTrack&&e._videoTrack._player&&((n=e._videoTrack._player.getVideoElement())===null||n===void 0||n.pause(),e._videoTrack._player.isKeepLastFrame=!0,e._videoTrack._originMediaStreamTrack.stop());}),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Ko({},this.store):this.isPlanB?new Ja({},this.store):new gr({},this.store),this.bindConnectionEvents(this.connection)),this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(t=>{var e;let[n,{track:i}]=t;switch(n){case F.LocalVideoTrack:q(e=i._hints).call(e,ie.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case F.LocalAudioTrack:i instanceof je?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case F.LocalVideoLowTrack:}}),this.emit(ct.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,n]=t;Array.from(ri(n).call(n)).forEach(i=>{this.setPendingRemoteMedia(e,i);}),this.emit(ct.MediaReconnectStart,e.uid);}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.localDataChannels.length!==0&&(this.localDataChannels.forEach(t=>{this.pendingLocalDataChannels.push(t);}),this.localDataChannels.length=0),this.remoteDataChannelMap.size!==0&&(Array.from(this.remoteDataChannelMap.entries()).forEach(t=>{let[e,n]=t;Array.from(ri(n).call(n)).forEach(i=>{this.setPendingRemoteDataChannel(e,i);});}),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),_.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")));}hasPendingRemoteDataChannel(t,e){for(let n of this.pendingRemoteDataChannels){let{user:i,id:r}=n;if((t instanceof Go?t.uid:t)===i.uid&&r===e)return !0}return !1}setPendingRemoteDataChannel(t,e){this.hasPendingRemoteDataChannel(t,e)||this.pendingRemoteDataChannels.push({user:t,id:e});}hasPendingRemoteMedia(t,e){for(let n of this.pendingRemoteTracks){let{user:i,kind:r}=n;if((t instanceof Go?t.uid:t)===i.uid&&e===r)return !0}return !1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e});}restartICE(t){var e=this;return $n(function*(){if(!e.connection||e.state!==Gt.Connected||e.connection instanceof Ko)return;let n=yield gt(e.mutex.lock("From P2PChannel.restartICE")),i;try{i=yield gt(e.connection.restartICE(t));let o=yield gt(i.next());if(o.done)return;let s=o.value,a=yield s;switch(e.reportPCDisconnectedOrFailed(t),t){case In.TCP:e._pcStatsUploadType=$r.TCP_RESTART;break;case In.RELAY:e._pcStatsUploadType=$r.RELAY_RESTART;break;default:e._pcStatsUploadType=$r.OLD_RESTART;}e._isInRestartIce=!0,i.next(a);}catch(o){var r;(r=i)===null||r===void 0||r.throw(o);}finally{n();}})()}getUplinkNetworkQuality(){if(!this.connection)return 0;let t=this.connection.getStats(),e=this.localTrackMap.get(F.LocalVideoTrack),n=this.localTrackMap.get(F.LocalAudioTrack),i=t.videoSend.find(p=>p.ssrc===e?.ssrcs[0].ssrcId),r=t.audioSend.find(p=>p.ssrc===n?.ssrcs[0].ssrcId);if(!i||!r)return 1;let o=Qn(this,ct.NeedSignalRTT),s=i?i.rttMs:void 0,a=r?r.rttMs:void 0,c=s&&a?(s+a)/2:s||a,d=(c&&o?(c+o)/2:c||o)||0,l=100*t.sendPacketLossRate*.7/50+.3*d/1500,u=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,h=e?.track;if(h&&h._encoderConfig&&h._hints.indexOf(ie.SCREEN_TRACK)===-1){let p=h._encoderConfig.bitrateMax,T=t.bitrate.actualEncoded;if(p&&T){let m=(1e3*p-T)/(1e3*p);return vI[m<.15?0:m<.3?1:m<.45?2:m<.6?3:4][u]}}return u}getDownlinkNetworkQuality(){if(!this.connection)return 0;let t=this.connection.getStats(),e=0;return Array.from(this.remoteUserMap.entries()).forEach(n=>{let[i]=n,r=i._audioSSRC,o=i._videoSSRC,s=t.audioRecv.find(T=>T.ssrc===r),a=t.videoRecv.find(T=>T.ssrc===o);if(!s&&!a)return void(e+=1);let c=Qn(this,ct.NeedSignalRTT),d=t.rtt,l=(d&&c?(d+c)/2:d||c)||0,u=s?s.jitterMs:void 0,h=t.recvPacketLossRate,p=.7*h*100/50+.3*l/1500;u&&(p=.6*h*100/50+.2*l/1500+.2*u/400),e+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5;}),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}async muteLocalTrack(t){return new K((e,n)=>{this.handleMuteLocalTrack(t,e,n);})}async replaceTrack(t,e){var n;if(_.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(t.getTrackId(),"] to [").concat(e.getTrackId(),"]")),!this.connection||this.state!==Gt.Connected)return;let i=Array.from(this.localTrackMap.entries()).find(o=>{let[,{track:s}]=o;return t===s});if(!i)return;let r=i[0];if(t!==e&&(this.unbindLocalTrackEvents([{track:t,type:r}]),this.bindLocalTrackEvents([{track:e,type:r}]),i[1].track=e),await((n=this.connection)===null||n===void 0?void 0:n.replaceTrack(e,i[1].id)),this.isPlanB){let o=i[1];o.id=e._mediaStreamTrack.id,this.localTrackMap.set(r,o);}if(r===F.LocalVideoTrack&&!v("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ot().supportDualStreamEncoding){let o=this.localTrackMap.get(F.LocalVideoLowTrack);if(o){let s=t._mediaStreamTrack.clone();o.track._originMediaStreamTrack.stop(),o.track._mediaStreamTrack=s,o.track._originMediaStreamTrack=s,await new K((a,c)=>{this.handleReplaceTrack(o.track,a,c,!0);});}}}filterTobePublishedTracks(t,e,n){let i=[],r=this.getAllTracks();t=ma(t=t.filter(c=>r.indexOf(c)===-1));let o,s=!1,a=this.localTrackMap.get(F.LocalAudioTrack);for(let c of t){if(c instanceof $t&&(this.localTrackMap.has(F.LocalVideoTrack)||s?new D(R.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(i.push({track:c,type:F.LocalVideoTrack}),s=!0),e)){let d=this.getLowVideoTrack(c,n);i.push({track:d,type:F.LocalVideoLowTrack});}if(c instanceof Re)if(a){let d=a.track;if(d instanceof je)tf([c]),d.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0);else {let l=ef([d,c]);_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(l.getTrackId(),"]")),this.replaceTrack(d,l);}}else o instanceof je?(tf([c]),o.addAudioTrack(c)):o||!c._useAudioElement&&Ot().webAudioMediaStreamDest&&!c._bypassWebAudio?o=ef(o?[c,o]:[c]):o=c;}return o&&(_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(o.getTrackId(),"]")),i.push({track:o,type:F.LocalAudioTrack})),i}filterTobeUnpublishedTracks(t){let e=[],n=this.getAllTracks();t=ma(t=t.filter(i=>n.indexOf(i)!==-1));for(let i of t){if(i instanceof Re){let r=this.localTrackMap.get(F.LocalAudioTrack);if(!r)continue;r.track instanceof je?(r.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),r.track.trackList.length===0&&(e.push([F.LocalAudioTrack,r]),r.track.close())):e.push([F.LocalAudioTrack,r]);}if(i instanceof $t){let r=this.localTrackMap.get(F.LocalVideoTrack);if(!r)continue;e.push([F.LocalVideoTrack,r]);let o=this.localTrackMap.get(F.LocalVideoLowTrack);o&&e.push([F.LocalVideoLowTrack,o]);}}return e}filterTobePublishedDataChannels(t){return t=(t=ma(t)).filter(e=>this.localDataChannels.findIndex(n=>n.id===e.id)===-1)}filterTobeUnpublishedDataChannels(t){return t=(t=(t=ma(t)).filter(e=>this.localDataChannels.indexOf(e)!==-1)).filter(e=>e._originDataChannel)}bindLocalTrackEvents(t){t.forEach(e=>{let{track:n,type:i}=e;switch(i){case F.LocalVideoTrack:n.addListener(J.GET_STATS,this.handleGetLocalVideoStats),n.addListener(J.GET_RTC_STATS,this.handleGetRTCStats),n.addListener(J.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(J.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(J.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.addListener(J.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.addListener(J.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.addListener(J.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(J.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case F.LocalAudioTrack:this.bindLocalAudioTrackEvents(n);case F.LocalVideoLowTrack:}});}bindLocalAudioTrackEvents(t,e){t instanceof je?t.trackList.forEach(n=>{n.addListener(J.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(J.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(J.GET_STATS,this.handleGetLocalAudioStats),n.addListener(J.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(J.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);}):(t.addListener(J.GET_STATS,this.handleGetLocalAudioStats),t.addListener(J.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(J.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(J.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(J.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||(t.addListener(J.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(J.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)));}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map(e=>{let[n,{track:i}]=e;return {track:i,type:n}})),t.forEach(e=>{let{track:n,type:i}=e;switch(i){case F.LocalVideoTrack:n.off(J.GET_STATS,this.handleGetLocalVideoStats),n.off(J.GET_RTC_STATS,this.handleGetRTCStats),n.off(J.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(J.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(J.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.off(J.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.off(J.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(J.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(J.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case F.LocalAudioTrack:this.unbindLocalAudioTrackEvents(n);case F.LocalVideoLowTrack:}});}unbindLocalAudioTrackEvents(t){t instanceof je?t.trackList.forEach(e=>{e.off(J.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(J.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(J.GET_STATS,this.handleGetLocalAudioStats),e.off(J.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(J.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);}):(t.off(J.GET_STATS,this.handleGetLocalAudioStats),t.off(J.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(J.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(J.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(J.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),t.off(J.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(J.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack));}bindRemoteTrackEvents(t,e){e instanceof Ka&&e.addListener(J.GET_STATS,n=>{n(this.handleGetRemoteVideoStats(t));}),e instanceof Ya&&e.addListener(J.GET_STATS,n=>{n(this.handleGetRemoteAudioStats(t));});}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(J.GET_STATS);}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,n]=t;n.has(tt.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),n.has(tt.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack);});}createGatewayPublishMessage(t,e){return t.map((n,i)=>{var r;let o,s,{track:a,type:c}=n;switch(c){case F.LocalAudioTrack:o=jt.Audio,s={dtx:a instanceof Vu&&a._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case F.LocalVideoTrack:o=q(r=a._hints).call(r,ie.SCREEN_TRACK)?jt.Screen:jt.High,s=jr(jr({},GI(a)),{},{codec:this.store.codec});break;case F.LocalVideoLowTrack:o=jt.Low,s=jr(jr({},GI(a)),{},{codec:this.store.codec});}return {stream_type:o,attributes:s,ssrcs:e[i]}})}createGatewayUnpublishMessage(t){return t.map(e=>{var n;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case F.LocalVideoTrack:i=q(n=o._hints).call(n,ie.SCREEN_TRACK)?jt.Screen:jt.High;break;case F.LocalAudioTrack:i=jt.Audio;break;case F.LocalVideoLowTrack:i=jt.Low;}return {stream_type:i,ssrcs:s,mid:a}})}assignLocalTracks(t,e){t.forEach((n,i)=>{let{track:r,type:o}=n;this.localTrackMap.set(o,{track:r,id:e[i].id,ssrcs:e[i].localSSRC});});}withdrawLocalTracks(t){t.forEach(e=>{let[n]=e;this.localTrackMap.delete(n);});}bindConnectionEvents(t){t.onConnectionStateChange=async e=>{if(_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(e,")")),this.emit(ct.PeerConnectionStateChange,e),e!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),e==="connected"&&(this._restartTimer&&(clearTimeout(this._restartTimer),this._restartTimer=void 0),(this._isFirstConnected||this._isInRestartIce)&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isInRestartIce=!1,this._isFirstConnected=!1,this._isStartRestartIce=!1),v("NEW_ICE_RESTART")){var n;if(q(n=this._restartStates).call(n,e)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;let i=s=>{(t.iceConnectionState==="disconnected"||t.iceConnectionState==="checking"||t.iceConnectionState==="failed")&&(_.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE, type is ").concat(s)),Qn(this,ct.QueryClientConnectionState)==="CONNECTED"&&this.emit(ct.RequestRestartICE,s));},r=()=>{t.iceConnectionState!=="disconnected"&&t.iceConnectionState!=="checking"&&t.iceConnectionState!=="failed"||(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),_.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout(()=>this.emit(ct.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect());},o=v("ICE_RESTART_INTERVAL");return void(this._restartTimer=window.setTimeout(()=>{if(v("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&Ot().supportPCSetConfiguration)i(In.RELAY),this._restartTimer=window.setTimeout(r,o);else if(Xt())i(In.UDP),this._restartTimer=window.setTimeout(r,4e3);else {if(i(In.TCP),Ot().supportPCSetConfiguration)return void(this._restartTimer=window.setTimeout(()=>{i(In.RELAY),this._restartTimer=window.setTimeout(r,o);},o));this._restartTimer=window.setTimeout(r,o);}},800))}}else {if(e==="disconnected"&&t.iceConnectionState==="disconnected")return setTimeout(()=>{t.iceConnectionState==="disconnected"&&v("ICE_RESTART")&&Qn(this,ct.QueryClientConnectionState)==="CONNECTED"&&this.emit(ct.RequestRestartICE);},800),void setTimeout(()=>{t.peerConnectionState==="disconnected"&&(_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isInRestartIce=!1,setTimeout(()=>this.emit(ct.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect());},4e3);e==="failed"&&(_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCDisconnectedOrFailed(),setTimeout(()=>this.emit(ct.P2PLost),0),this.iceFailedCount+=1,await this.requestReconnect());}},t.onICEConnectionStateChange=e=>{e!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),et.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:ge.TRACER}).onSuccess(),this.emit(ct.IceConnectionStateChange,e);},t.onICETransportStateChange=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"));},t.onDTLSTransportStateChange=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"));},t.onDTLSTransportError=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"));},t.onFirstAudioDecoded=e=>{var n;let i=Array.from(ri(n=this.remoteUserMap).call(n)).find(o=>o._audioSSRC===e);var r;i&&(this.store.subscribe(i.uid,"audio",void 0,void 0,void 0,Date.now()),(r=i.audioTrack)===null||r===void 0||r.emit(ja.FIRST_FRAME_DECODED),et.firstRemoteFrame(this.store.sessionId,Ze.FIRST_AUDIO_DECODE,_e.FIRST_AUDIO_DECODE,{peer:i._uintid,subscribeElapse:fn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}));},t.onFirstAudioReceived=e=>{var n;let i=Array.from(ri(n=this.remoteUserMap).call(n)).find(r=>r._audioSSRC===e);i&&et.firstRemoteFrame(this.store.sessionId,Ze.FIRST_AUDIO_RECEIVED,_e.FIRST_AUDIO_RECEIVED,{peer:i._uintid,subscribeElapse:fn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId});},t.onFirstVideoDecoded=(e,n,i)=>{this.reportVideoFirstFrameDecoded(e,n,i);},t.onFirstVideoReceived=e=>{var n;let i=Array.from(ri(n=this.remoteUserMap).call(n)).find(r=>r._videoSSRC===e);i&&et.firstRemoteFrame(this.store.sessionId,Ze.FIRST_VIDEO_RECEIVED,_e.FIRST_VIDEO_RECEIVED,{peer:i._uintid,subscribeElapse:fn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId});},t.onSelectedLocalCandidateChanged=(e,n)=>{let i=e.candidateType==="relay",r=n.candidateType==="relay";n.candidateType!=="unknown"&&i===r||this.emit(ct.ConnectionTypeChange,i),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Po(n))," -> ").concat(JSON.stringify(Po(e)),")"));},t.onSelectedRemoteCandidateChanged=(e,n)=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Po(n))," -> ").concat(JSON.stringify(Po(e)),")"));},t.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0);},t.getLocalVideoStats=()=>{let e=this.statsCollector.getLocalVideoTrackStats(),n=this.statsCollector.getRTCStats();return jr(jr({},e),n)};}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0,t.getLocalVideoStats=void 0;}filterTobeMutedTracks(t){let e=[];if(this.getAllTracks().indexOf(t)===-1)return e;let n=this.localTrackMap.get(F.LocalAudioTrack);if(t instanceof Re&&n?.track instanceof je)return n.track.isActive||e.push([F.LocalAudioTrack,n]),e;let i=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return t===o});if(i&&(e.push(i),i[0]===F.LocalVideoTrack)){let r=this.localTrackMap.get(F.LocalVideoLowTrack);r&&e.push([F.LocalVideoLowTrack,r]);}return e}filterTobeUnmutedTracks(t){let e=[],n=this.localTrackMap.get(F.LocalAudioTrack);if(t instanceof Re&&n?.track instanceof je)return n.track.isActive&&e.push([F.LocalAudioTrack,n]),e;let i=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return t===o});if(i)if(i[0]===F.LocalVideoTrack){e.push(i);let r=this.localTrackMap.get(F.LocalVideoLowTrack);r&&e.push([F.LocalVideoLowTrack,r]);}else e.push(i);return e}createMuteMessage(t){return t.map(e=>{var n;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case F.LocalAudioTrack:i=jt.Audio;break;case F.LocalVideoTrack:i=q(n=o._hints).call(n,ie.SCREEN_TRACK)?jt.Screen:jt.High;break;case F.LocalVideoLowTrack:i=jt.Low;}return {stream_type:i,ssrcs:s,mid:a}})}createUnmuteMessage(t){return t.map(e=>{var n;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case F.LocalAudioTrack:i=jt.Audio;break;case F.LocalVideoTrack:i=q(n=o._hints).call(n,ie.SCREEN_TRACK)?jt.Screen:jt.High;break;case F.LocalVideoLowTrack:i=jt.Low;}return {stream_type:i,ssrcs:s,mid:a}})}filterTobeUnSubscribedTracks(t,e){let n=[],i=this.remoteUserMap.get(t);if(!i)return n;if(e){let r=i.get(e);if(!r)return n;n.push([t,{kind:e,id:r}]);}else Array.from(i.entries()).forEach(r=>{let[o,s]=r;n.push([t,{kind:o,id:s}]);});return n}filterTobeUnSubscribedDataChannels(t,e){let n=[];return e.forEach(i=>{var r;(r=this.remoteDataChannelMap.get(t))!==null&&r!==void 0&&r.has(i.id)&&n.push(i);}),n}createUnsubscribeMessage(t){let e=[];return t.forEach(n=>{let[i,{kind:r,id:o}]=n;switch(r){case tt.VIDEO:return void(i._videoSSRC&&e.push({stream_type:tt.VIDEO,ssrcId:i._videoSSRC}));case tt.AUDIO:return void(i._audioSSRC&&e.push({stream_type:tt.AUDIO,ssrcId:i._audioSSRC}))}}),e}createUnsubscribeAllMessage(t){let e=new Map;return t.forEach(n=>{let[i,{kind:r}]=n;if(e.has(i)){let o=e.get(i);r===tt.VIDEO?o|=qe.Video:o|=qe.Audio,e.set(i,o);}else r===tt.VIDEO?e.set(i,qe.Video):e.set(i,qe.Audio);}),{users:Array.from(e.entries()).map(n=>{let[i,r]=n;return {stream_id:i.uid,stream_type:r}})}}withdrawRemoteTracks(t){t.forEach(e=>{let[n,{kind:i}]=e,r=this.remoteUserMap.get(n);r&&(r.delete(i),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(n));});}async updateBitrateLimit(t){let e=this.localTrackMap.get(F.LocalVideoTrack),n=this.localTrackMap.get(F.LocalVideoLowTrack);e&&await e.track.setBitrateLimit(t.uplink),n&&t.low_stream_uplink&&await n.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0});}isP2PDisconnected(){return this.connection?this.connection.peerConnectionState!=="connected":!0}mapPubResToRemoteConfig(t,e){return t.map((n,i)=>{var r;let{stream_type:o}=n;return (r=e.find(s=>{let{stream_type:a}=s;return o===a}))===null||r===void 0?void 0:r.attributes})}async tryToUnmuteAudio(t){for(let n=0;n<t.length;n++)if(t[n]instanceof Re){var e;let i=this.filterTobeUnmutedTracks(t[n]);if(i.length===0)continue;await((e=this.connection)===null||e===void 0?void 0:e.unmuteLocal(i.map(o=>{let[,{id:s}]=o;return s})));let r=this.createUnmuteMessage(i);return void await Qt(this,ct.RequestUnmuteLocal,r)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return !((e=this.connection)===null||e===void 0||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(ct.RequestUpload,t,e),this.statsUploader.requestUploadStats=t=>this.emit(ct.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks();}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0;}async requestReconnect(){this.dtlsFailedCount+=1,await Ye(Ql(this.dtlsFailedCount,Ne)),this.emit(ct.RequestReconnect);}async reconnectP2P(){let t=Array.from(this.localTrackMap.entries()),e=this.createGatewayUnpublishMessage(t);Array.from(this.remoteUserMap.entries()),e.length>0&&await Me(this,ct.RequestUnpublishForReconnectPC,e),this.disconnectForReconnect(),this.emit(ct.RequestReconnectPC);}canPublishLowStream(){return this.localTrackMap.has(F.LocalVideoTrack)||this.pendingLocalTracks.some(t=>t instanceof $t)}throwIfTrackTypeNotMatch(t){if(t.filter(e=>e instanceof $t).length>1)throw new D(R.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter(e=>e instanceof Re).length>1&&(t.some(e=>e instanceof Re&&e._bypassWebAudio)||!Ot().webAudioMediaStreamDest))throw new D(R.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(let e of t){if(e instanceof $t&&this.pendingLocalTracks.some(n=>n instanceof $t))throw new D(R.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof Re&&this.pendingLocalTracks.some(n=>n instanceof Re)&&(!Ot().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some(n=>n instanceof Re&&n._bypassWebAudio)))throw new D(R.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){let n=!v("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ot().supportDualStreamEncoding,i=jr(jr({},{width:160,height:120,framerate:15,bitrate:50}),e),r;r=n?t._mediaStreamTrack.clone():$E(t,i);let o=Zt(8,"track-low-"),s=new $t(r,jr(jr({},n&&{scaleResolutionDownBy:Om(i,t)}),{},{frameRate:i.framerate,bitrateMax:i.bitrate,bitrateMin:i.bitrate}),void 0,void 0,o);return s.on(Os.TRANSCEIVER_UPDATED,a=>{t._updateRtpTransceiver(a,Fa.LOW_STREAM);}),s._hints.push(ie.LOW_STREAM),t.on("sei-to-send",a=>{s.emit("sei-to-send",a);}),t.addListener(J.NEED_CLOSE,()=>{s.close();}),s}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(t,e,n){let i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null;if(this.connection&&this.connection instanceof gr){var r,o,s,a;let c=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:d,dtlsTransportState:l,peerConnectionState:u}=this.connection,{local:h,remote:p}=await this.connection.getSelectedCandidatePair();et.pcStats(this.store.sessionId,{startTime:c,eventElapse:t-c||0,iceconnectionsate:d,dtlsstate:l,connectionstate:u,intSucc:e?1:2,error:i,selectedLocalCandidateProtocol:(r=h?.protocol)!==null&&r!==void 0?r:"",selectedLocalCandidateType:(o=h.candidateType)!==null&&o!==void 0?o:"",selectedLocalCandidateAddress:"".concat(h.address,":").concat(h.port),selectedRemoteCandidateProtocol:(s=p.protocol)!==null&&s!==void 0?s:"",selectedRemoteCandidateType:(a=p.candidateType)!==null&&a!==void 0?a:"",selectedRemoteCandidateAddress:"".concat(p.address,":").concat(p.port),restartCnt:n});}}reportVideoFirstFrameDecoded(t,e,n,i){var r;let o=Array.from(ri(r=this.remoteUserMap).call(r)).find(s=>s._videoSSRC===t);if(o){i||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());let s=this.store.keyMetrics,a=s.subscribe.find(c=>c.userId===o.uid&&c.type==="video");et.firstRemoteVideoDecode(this.store.sessionId,Ze.FIRST_VIDEO_DECODE,_e.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:e,videoheight:n,subscribeElapse:fn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:s.requestAPEnd||0,apStart:s.requestAPStart||0,joinGwEnd:s.joinGatewayEnd||0,joinGwStart:s.joinGatewayStart||0,pcEnd:s.peerConnectionEnd||0,pcStart:s.peerConnectionStart||0,subscriberEnd:a?.subscribeEnd||0,subscriberStart:a?.subscribeStart||0,videoAddNotify:a?.streamAdded||0,state:i?1:0});}}async remoteMediaSsrcChanged(t,e,n){if(!this.connection)return !1;let i=this.remoteUserMap.get(t);if(!i)return !1;let r=i.get(e);if(!r)return !1;let o=await this.connection.getRemoteSSRC(r);return o!==void 0&&o!==n}resetConnection(t){_.debug("[".concat(this.store.clientId,"] [P2PChannel] reset connection to ").concat(t)),this.state===Gt.Connected?(_.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=t===PI.datachannel?new Ko({},this.store):this.isPlanB?new Ja({},this.store):new gr({},this.store),this.bindConnectionEvents(this.connection)));}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(t=>{let[e,{track:n}]=t;e===F.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,Fa.LOW_STREAM):n._updateRtpTransceiver(void 0);});}reportPCDisconnectedOrFailed(t){this.connection&&this.connection instanceof gr&&(this.connection.iceConnectionState!=="disconnected"&&this.connection.iceConnectionState!=="checking"&&this.connection.iceConnectionState!=="failed"||(this._isFirstConnected?(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isFirstConnected=!1):this._pcStatsUploadType===$r.TCP_RESTART&&t===In.RELAY?this.reportPCStats(Date.now(),!1,this._pcStatsUploadType):this.reportPCStats(Date.now(),!1,$r.DISCONNECTED_OR_FAILED)));}},W(Tt.prototype,"startP2PConnection",[Cn],Object.getOwnPropertyDescriptor(Tt.prototype,"startP2PConnection"),Tt.prototype),W(Tt.prototype,"connect",[Cn],Object.getOwnPropertyDescriptor(Tt.prototype,"connect"),Tt.prototype),W(Tt.prototype,"updateRemoteRTPCapabilities",[Cn],Object.getOwnPropertyDescriptor(Tt.prototype,"updateRemoteRTPCapabilities"),Tt.prototype),W(Tt.prototype,"preConnect",[Cn],Object.getOwnPropertyDescriptor(Tt.prototype,"preConnect"),Tt.prototype),W(Tt.prototype,"publishDataChannel",[Cn],Object.getOwnPropertyDescriptor(Tt.prototype,"publishDataChannel"),Tt.prototype),W(Tt.prototype,"unpublish",[Cn],Object.getOwnPropertyDescriptor(Tt.prototype,"unpublish"),Tt.prototype),W(Tt.prototype,"unpublishDataChannel",[Cn],Object.getOwnPropertyDescriptor(Tt.prototype,"unpublishDataChannel"),Tt.prototype),W(Tt.prototype,"unpublishLowStream",[Cn],Object.getOwnPropertyDescriptor(Tt.prototype,"unpublishLowStream"),Tt.prototype),W(Tt.prototype,"subscribeDataChannel",[Cn],Object.getOwnPropertyDescriptor(Tt.prototype,"subscribeDataChannel"),Tt.prototype),W(Tt.prototype,"subscribe",[Cn],Object.getOwnPropertyDescriptor(Tt.prototype,"subscribe"),Tt.prototype),W(Tt.prototype,"massSubscribe",[Cn],Object.getOwnPropertyDescriptor(Tt.prototype,"massSubscribe"),Tt.prototype),W(Tt.prototype,"unsubscribe",[Cn],Object.getOwnPropertyDescriptor(Tt.prototype,"unsubscribe"),Tt.prototype),W(Tt.prototype,"unsubscribeDataChannel",[Cn],Object.getOwnPropertyDescriptor(Tt.prototype,"unsubscribeDataChannel"),Tt.prototype),W(Tt.prototype,"massUnsubscribe",[Cn],Object.getOwnPropertyDescriptor(Tt.prototype,"massUnsubscribe"),Tt.prototype),W(Tt.prototype,"muteRemote",[Cn],Object.getOwnPropertyDescriptor(Tt.prototype,"muteRemote"),Tt.prototype),W(Tt.prototype,"unmuteRemote",[Cn],Object.getOwnPropertyDescriptor(Tt.prototype,"unmuteRemote"),Tt.prototype),W(Tt.prototype,"hasRemoteMediaWithLock",[Cn],Object.getOwnPropertyDescriptor(Tt.prototype,"hasRemoteMediaWithLock"),Tt.prototype),W(Tt.prototype,"disconnectForReconnect",[Cn],Object.getOwnPropertyDescriptor(Tt.prototype,"disconnectForReconnect"),Tt.prototype),W(Tt.prototype,"updateBitrateLimit",[Cn],Object.getOwnPropertyDescriptor(Tt.prototype,"updateBitrateLimit"),Tt.prototype),W(Tt.prototype,"remoteMediaSsrcChanged",[Cn],Object.getOwnPropertyDescriptor(Tt.prototype,"remoteMediaSsrcChanged"),Tt.prototype),Tt);function Cn(t,e,n){let i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){let r=this.mutex,o=await r.lock("From P2PChannel.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o();}},n}function rH(t){let e=HO();return function(n,i){let r=n.appId;r!==void 0&&(Ht(i,10),Gr(i,r));let o=n.cid;o!==void 0&&(Ht(i,16),Ht(i,o));let s=n.cname;s!==void 0&&(Ht(i,26),Gr(i,s));let a=n.deviceId;a!==void 0&&(Ht(i,34),Gr(i,a));let c=n.elapse;c!==void 0&&(Ht(i,40),Yo(i,c));let d=n.fileSize;d!==void 0&&(Ht(i,48),Yo(i,Qa(d)));let l=n.height;l!==void 0&&(Ht(i,56),Yo(i,Qa(l)));let u=n.jpg;u!==void 0&&(Ht(i,66),Ht(i,u.length),function(nr,U){let G=Za(nr,U.length);nr.bytes.set(U,G);}(i,u));let h=n.networkType;h!==void 0&&(Ht(i,72),Yo(i,Qa(h)));let p=n.osType;p!==void 0&&(Ht(i,80),Yo(i,Qa(p)));let T=n.requestId;T!==void 0&&(Ht(i,90),Gr(i,T));let m=n.sdkVersion;m!==void 0&&(Ht(i,98),Gr(i,m));let E=n.sequence;E!==void 0&&(Ht(i,104),Yo(i,Qa(E)));let S=n.sid;S!==void 0&&(Ht(i,114),Gr(i,S));let C=n.timestamp;C!==void 0&&(Ht(i,120),Yo(i,C));let A=n.uid;A!==void 0&&(Ht(i,128),Ht(i,A));let b=n.vid;b!==void 0&&(Ht(i,136),Ht(i,b));let O=n.width;O!==void 0&&(Ht(i,144),Yo(i,Qa(O)));let N=n.service;N!==void 0&&(Ht(i,152),Ht(i,N));let k=n.callbackData;k!==void 0&&(Ht(i,162),Gr(i,k));let M=n.jpgEncryption;M!==void 0&&(Ht(i,168),Ht(i,M));let x=n.requestType;x!==void 0&&(Ht(i,176),Ht(i,x));let X=n.scorePorn;X!==void 0&&(Ht(i,185),lf(i,X));let bt=n.scoreSexy;bt!==void 0&&(Ht(i,193),lf(i,bt));let Ft=n.scoreNeutral;Ft!==void 0&&(Ht(i,201),lf(i,Ft));let re=n.scene;re!==void 0&&(Ht(i,208),Ht(i,re));let Le=n.ossFilePrefix;Le!==void 0&&(Ht(i,218),Gr(i,Le));let Ee=n.serviceVendor;if(Ee!==void 0)for(let nr of Ee){Ht(i,226);let U=HO();aH(nr,U),Ht(i,U.limit),uH(i,U),lH(U);}}(t,e),function(n){let i=n.bytes,r=n.limit;return i.length===r?i:i.subarray(0,r)}(e)}function oH(t){return function(n){let i={};t:for(;!KO(n);){let r=Wr(n);switch(r>>>3){case 0:break t;case 1:i.code=Wr(n);break;case 2:i.msg=YO(n,Wr(n));break;case 3:{let o=cH(n);i.data=sH(n),n.limit=o;break}default:GO(n,7&r);}}return i}({bytes:e=t,offset:0,limit:e.length});var e;}function sH(t){let e={};t:for(;!KO(t);){let n=Wr(t);switch(n>>>3){case 0:break t;case 1:e.requestId=YO(t,Wr(t));break;case 2:e.requestType=Wr(t)>>>0;break;case 3:e.scorePorn=df(t);break;case 4:e.scoreSexy=df(t);break;case 5:e.scoreNeutral=df(t);break;case 6:e.requestScene=Wr(t)>>>0;break;case 7:e.scene=Wr(t)>>>0;break;default:GO(t,7&n);}}return e}function aH(t,e){let n=t.service;n!==void 0&&(Ht(e,8),Ht(e,n));let i=t.vendor;i!==void 0&&(Ht(e,16),Ht(e,i));let r=t.token;r!==void 0&&(Ht(e,26),Gr(e,r));let o=t.callbackUrl;o!==void 0&&(Ht(e,34),Gr(e,o));}function cH(t){let e=Wr(t),n=t.limit;return t.limit=t.offset+e,n}function GO(t,e){switch(e){case 0:for(;128&qO(t););break;case 2:af(t,Wr(t));break;case 5:af(t,4);break;case 1:af(t,8);break;default:throw new Error("Unimplemented type: "+e)}}let dH=new Float32Array(1);new Uint8Array(dH.buffer);let sf=new Float64Array(1),Yn=new Uint8Array(sf.buffer);function Qa(t){return {low:t|=0,high:t>>31,unsigned:t>=0}}let WO=[];function HO(){let t=WO.pop();return t?(t.offset=t.limit=0,t):{bytes:new Uint8Array(64),offset:0,limit:0}}function lH(t){WO.push(t);}function af(t,e){if(t.offset+e>t.limit)throw new Error("Skip past limit");t.offset+=e;}function KO(t){return t.offset>=t.limit}function Za(t,e){let n=t.bytes,i=t.offset,r=t.limit,o=i+e;if(o>n.length){let s=new Uint8Array(2*o);s.set(n),t.bytes=s;}return t.offset=o,o>r&&(t.limit=o),i}function cf(t,e){let n=t.offset;if(n+e>t.limit)throw new Error("Read past limit");return t.offset+=e,n}function YO(t,e){let n=cf(t,e),i=String.fromCharCode,r=t.bytes,o="\uFFFD",s="";for(let a=0;a<e;a++){let c,d,l,u,h=r[a+n];128&h?(224&h)==192?a+1>=e?s+=o:(c=r[a+n+1],(192&c)!=128?s+=o:(u=(31&h)<<6|63&c,u<128?s+=o:(s+=i(u),a++))):(240&h)==224?a+2>=e?s+=o:(c=r[a+n+1],d=r[a+n+2],(49344&(c|d<<8))!=32896?s+=o:(u=(15&h)<<12|(63&c)<<6|63&d,u<2048||u>=55296&&u<=57343?s+=o:(s+=i(u),a+=2))):(248&h)==240?a+3>=e?s+=o:(c=r[a+n+1],d=r[a+n+2],l=r[a+n+3],(12632256&(c|d<<8|l<<16))!=8421504?s+=o:(u=(7&h)<<18|(63&c)<<12|(63&d)<<6|63&l,u<65536||u>1114111?s+=o:(u-=65536,s+=i(55296+(u>>10),56320+(1023&u)),a+=3))):s+=o:s+=i(h);}return s}function Gr(t,e){let n=e.length,i=0;for(let s=0;s<n;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<n&&(a=(a<<10)+e.charCodeAt(++s)-56613888),i+=a<128?1:a<2048?2:a<65536?3:4;}Ht(t,i);let r=Za(t,i),o=t.bytes;for(let s=0;s<n;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<n&&(a=(a<<10)+e.charCodeAt(++s)-56613888),a<128?o[r++]=a:(a<2048?o[r++]=a>>6&31|192:(a<65536?o[r++]=a>>12&15|224:(o[r++]=a>>18&7|240,o[r++]=a>>12&63|128),o[r++]=a>>6&63|128),o[r++]=63&a|128);}}function uH(t,e){let n=Za(t,e.limit),i=t.bytes,r=e.bytes;for(let o=0,s=e.limit;o<s;o++)i[o+n]=r[o];}function qO(t){return t.bytes[cf(t,1)]}function zO(t,e){let n=Za(t,1);t.bytes[n]=e;}function df(t){let e=cf(t,8),n=t.bytes;return Yn[0]=n[e++],Yn[1]=n[e++],Yn[2]=n[e++],Yn[3]=n[e++],Yn[4]=n[e++],Yn[5]=n[e++],Yn[6]=n[e++],Yn[7]=n[e++],sf[0]}function lf(t,e){let n=Za(t,8),i=t.bytes;sf[0]=e,i[n++]=Yn[0],i[n++]=Yn[1],i[n++]=Yn[2],i[n++]=Yn[3],i[n++]=Yn[4],i[n++]=Yn[5],i[n++]=Yn[6],i[n++]=Yn[7];}function Wr(t){let e,n=0,i=0;do e=qO(t),n<32&&(i|=(127&e)<<n),n+=7;while(128&e);return i}function Ht(t,e){for(e>>>=0;e>=128;)zO(t,127&e|128),e>>>=7;zO(t,e);}function Yo(t,e){let n=e.low>>>0,i=(e.low>>>28|e.high<<4)>>>0,r=e.high>>>24,o=r===0?i===0?n<16384?n<128?1:2:n<1<<21?3:4:i<16384?i<128?5:6:i<1<<21?7:8:r<128?9:10,s=Za(t,o),a=t.bytes;switch(o){case 10:a[s+9]=r>>>7&1;case 9:a[s+8]=o!==9?128|r:127&r;case 8:a[s+7]=o!==8?i>>>21|128:i>>>21&127;case 7:a[s+6]=o!==7?i>>>14|128:i>>>14&127;case 6:a[s+5]=o!==6?i>>>7|128:i>>>7&127;case 5:a[s+4]=o!==5?128|i:127&i;case 4:a[s+3]=o!==4?n>>>21|128:n>>>21&127;case 3:a[s+2]=o!==3?n>>>14|128:n>>>14&127;case 2:a[s+1]=o!==2?n>>>7|128:n>>>7&127;case 1:a[s]=o!==1?128|n:127&n;}}function JO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}let hH=new Map([["moderation",1],["supervise",2]]);class oh extends de{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;let n=this._connectionState;this._connectionState=e,this.emit(tn.CONNECTION_STATE_CHANGE,n,e);}get inspectType(){return this._inspectType}set inspectType(e){var n;this._inspectMode=rr(n=e.map(i=>hH.get(i)||0)).call(n,(i,r)=>i+r),this._inspectType=e;}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this.qualityRatio;},6e4));}constructor(e){super(),g(this,"name","AgoraRTCVideoContentInspect"),g(this,"_connectionState",Bi.CONNECTING),g(this,"_innerConnectionState",void 0),g(this,"sequence",0),g(this,"inspectStartTime",void 0),g(this,"workerManagerConnection",void 0),g(this,"workerConnection",void 0),g(this,"workerMessageLengthLimit",void 0),g(this,"inspectIntervalMinimum",void 0),g(this,"qualityRatio",void 0),g(this,"_connectInfo",void 0),g(this,"_cancelTokenSource",Mn.CancelToken.source()),g(this,"_retryConfig",void 0),g(this,"wmSequence",0),g(this,"inspectInterval",void 0),g(this,"inspectTimer",null),g(this,"ossFilePrefix",void 0),g(this,"extraInfo",void 0),g(this,"_inspectType",void 0),g(this,"_inspectMode",void 0),g(this,"_quality",1),g(this,"qualityTimer",null),g(this,"_inspectId",void 0),g(this,"_needWorkUrlOnly",!1),g(this,"inspectImage",()=>{if(this.connectionState!==Bi.CONNECTED)throw new w(R.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval(()=>{this.connectionState===Bi.CONNECTED?this.requestToInspectImage():_.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState);},this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage();}),this._inspectId=Zt(5,"inspect-"),this.workerMessageLengthLimit=v("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=v("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=v("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=e.interval,this.ossFilePrefix=e.ossFilePrefix,this.extraInfo=e.extraInfo,this.inspectType=e.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new Yc("worker-manager-"+this._inspectId,Ne),this.on(tn.STATE_CHANGE,(n,i)=>{this._innerConnectionState=n,_.debug("[".concat(this._inspectId,"] Inspect operation :").concat(ji[n]," ").concat(i||""));}),this.handleWorkerManagerEvents(),this.workerConnection=new Yc("worker-"+this._inspectId,Ne),this.handleWorkerEvents();}async init(e,n){this.emit(tn.STATE_CHANGE,ji.CONNECT_AP),this._connectInfo=e;let i=this._cancelTokenSource.token;return this._retryConfig=n,new K((r,o)=>{this.on(tn.CONNECTION_STATE_CHANGE,(s,a)=>{a===Bi.CONNECTED&&r();}),this.requestAP(e,i,n).then(s=>{this.connectWorkerManager(s);}).catch(s=>{o(s);});})}async requestAP(e,n,i){let r=v("WEBCS_DOMAIN").map(a=>"https://".concat(a,"/api/v1")),o=await function(a,c,d,l){let{appId:u,areaCode:h,cname:p,sid:T,token:m,uid:E}=c;Ia++;let S="image_moderation_api",C={service_name:S,json_body:JSON.stringify({appId:u,areaCode:h,cname:p,command:"allocateEdge",requestId:Ia,seq:Ia,sid:T,token:m,ts:Date.now(),uid:E+""})},A,b,O=a[0];return ar(async()=>{A=Date.now();let N=await ur(O,{data:C,cancelToken:d,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(b=Date.now()-A,N.code!==0){let X=new w(R.UNEXPECTED_RESPONSE,"image inspect ap error, code"+N.code,{retry:!0,responseTime:b});throw _.error(X.toString()),X}let k=JSON.parse(N.json_body);if(k.code!==200){let X=new w(R.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(k.code,", reason: ").concat(k.reason),{code:k.code,responseTime:b});throw _.error(X.toString()),X}if(!k.servers||!Array.isArray(k.servers)||k.servers.length===0){let X=new w(R.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:k.code,responseTime:b});throw _.error(X.toString()),X}let M=v("VIDEO_INSPECT_WORKER_MANAGER_HOST"),x=v("VIDEO_INSPECT_WORKER_MANAGER_PORT");return {addressList:k.servers.map(X=>{let{address:bt,wss:Ft}=X;if(bt&&Ft)return "wss://".concat(bt.replace(/\./g,"-"),".").concat(M,":").concat(x||Ft)}).filter(X=>!!X),workerToken:k.workerToken,vid:k.vid,responseTime:b}},(N,k)=>(et.apworkerEvent(T,{success:!0,sc:200,serviceName:S,responseDetail:JSON.stringify(N.addressList),firstSuccess:k===0,responseTime:b,serverIp:a[k%a.length]}),!1),(N,k)=>(et.apworkerEvent(T,{success:!1,sc:N.data&&N.data.code||200,serviceName:S,responseTime:b,serverIp:a[k%a.length]}),!!(N.code!==R.OPERATION_ABORTED&&N.code!==R.UNEXPECTED_RESPONSE||N.data&&N.data.retry)&&(O=a[(k+1)%a.length],!0)),l)}(r,e,n,i);this.emit(tn.STATE_CHANGE,ji.AP_CONNECTED);let{addressList:s}=o;return this.wmSequence++,s}async connectWorkerManager(e){let n=arguments.length>1&&arguments[1]!==void 0&&arguments[1];this._needWorkUrlOnly=n,this.emit(tn.STATE_CHANGE,ji.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(e,1e4);}async connectWorker(e){await this.workerConnection.init([e]);}handleWorkerManagerEvents(){this.workerManagerConnection.on(dt.CONNECTED,async()=>{this.emit(tn.STATE_CHANGE,ji.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.21.0",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0);}),this.workerManagerConnection.on(dt.CLOSED,()=>{this._innerConnectionState<ji.GET_WORKER_MANAGER_RESPONSE&&_.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"));}),this.workerManagerConnection.on(dt.FAILED,()=>{this._innerConnectionState<ji.GET_WORKER_MANAGER_RESPONSE&&_.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"));}),this.workerManagerConnection.on(dt.RECONNECTING,()=>{this._innerConnectionState<ji.GET_WORKER_MANAGER_RESPONSE&&_.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"));}),this.workerManagerConnection.on(dt.ON_MESSAGE,async e=>{this.emit(tn.STATE_CHANGE,ji.GET_WORKER_MANAGER_RESPONSE);let n=this.workerManagerConnection.url;this.workerManagerConnection.close();let i=JSON.parse(e.data);if(i.code!==200)throw _.error("[".concat(this._inspectId,"] Unexpected code ").concat(i.code," from worker manager")),new w(R.UNEXPECTED_RESPONSE,"response code of worker is unexpected",i);if(!(i.serverResponse&&i.serverResponse.portWss&&n))throw _.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(i))),new w(R.UNEXPECTED_RESPONSE,"response content of worker is unexpected",i);{let r=v("VIDEO_INSPECT_WORKER_PORT")||i.serverResponse.portWss,o=n.replace(/:\d+\/?$/,":".concat(r));this.emit(tn.STATE_CHANGE,ji.CONNECT_WORKER,o),this._needWorkUrlOnly?this.emit(tn.REQUEST_NEW_WORKER_URL,o):await this.connectWorker(o);}}),this.workerManagerConnection.on(dt.WILL_RECONNECT,(e,n,i)=>{i(e);}),this.workerManagerConnection.on(dt.REQUEST_NEW_URLS,(e,n)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(n);});}handleWorkerEvents(){this.workerConnection.on(dt.CONNECTED,async()=>{this.emit(tn.STATE_CHANGE,ji.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=Bi.CONNECTED;}),this.workerConnection.on(dt.ON_MESSAGE,async e=>{if(e.data instanceof ArrayBuffer){let i=oH(new Uint8Array(e.data));if(v("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&_.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(i)),i.code===200){if(Array.isArray(this.inspectType)&&this.inspectType.length===1&&this.inspectType[0]==="supervise")return void this.emit(tn.INSPECT_RESULT,void 0,void 0);if(i.data&&i.data.scorePorn&&i.data.scoreSexy&&i.data.scoreNeutral){var n;let r={porn:i.data.scorePorn,sexy:i.data.scoreSexy,neutral:i.data.scoreNeutral},o=rr(n=Object.keys(r)).call(n,(a,c)=>r[a]>r[c]?a:c,"porn"),s=Object.keys(r).find(a=>a===o);this.emit(tn.INSPECT_RESULT,s);}else this.emit(tn.INSPECT_RESULT,void 0,new w(R.UNEXPECTED_RESPONSE,i.code+"","There is an unexpected data on message"));}else this.emit(tn.INSPECT_RESULT,void 0,new w(R.UNEXPECTED_RESPONSE,i.code+"",i.msg));}else _.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(tn.INSPECT_RESULT,void 0,new w(R.UNEXPECTED_RESPONSE,"invalid worker message type"));}),this.workerConnection.on(dt.CLOSED,()=>{this.connectionState=Bi.CLOSED;}),this.workerConnection.on(dt.FAILED,()=>{this.connectionState=Bi.CLOSED;}),this.workerConnection.on(dt.RECONNECTING,()=>{this.connectionState=this.connectionState===Bi.CONNECTED?Bi.RECONNECTING:Bi.CONNECTING;}),this.workerConnection.on(dt.WILL_RECONNECT,(e,n,i)=>{e==="recover"&&i(e),i("tryNext");}),this.workerConnection.on(dt.REQUEST_NEW_URLS,(e,n)=>{this.workerManagerConnection.close(),this.once(tn.REQUEST_NEW_WORKER_URL,i=>{e([i]);}),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(i=>{this.connectWorkerManager(i,!0);}).catch(i=>{n(i);});});}static intToLong(e){return {low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){this.sequence++;let e=Qn(this,tn.CLIENT_LOCAL_VIDEO_TRACK),n={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void this.emit(tn.INSPECT_RESULT,void 0,new w(R.INVALID_OPERATION,"Only the track being played can be inspected"));let i=await this.generateRequestData(e,n);this.workerConnection.sendMessage(i,!0,!0);}else this.emit(tn.INSPECT_RESULT,void 0,new w(R.INVALID_OPERATION,"Only the track being published can be inspected"));}async generateRequestData(e,n){let{appId:i,cname:r,cid:o,vid:s,sid:a,uid:c}=n,d=Date.now(),l=await e.getCurrentFrameImage("image/jpeg",this.quality),u=await XA(l,i,r),h=this.sequence+"-"+o+"-"+c+"-"+d+"-"+Zt(12,""),p={appId:i,cid:o,cname:r,deviceId:"",elapse:oh.intToLong(Number(d-this.inspectStartTime)),fileSize:u.byteLength,jpgEncryption:2,height:l.height,width:l.width,jpg:u,networkType:6,osType:7,requestId:h,sdkVersion:"4.21.0",sequence:this.sequence,sid:a,timestamp:oh.intToLong(d),uid:c,vid:s,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};this.extraInfo===void 0&&delete p.callbackData,this.ossFilePrefix===void 0&&delete p.ossFilePrefix;let T=rH(p);if(T.byteLength<this.workerMessageLengthLimit){if(v("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){let m=function(E){for(var S=1;S<arguments.length;S++){var C=arguments[S]!=null?arguments[S]:{};S%2?JO(Object(C),!0).forEach(function(A){g(E,A,C[A]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(E,Object.getOwnPropertyDescriptors(C)):JO(Object(C)).forEach(function(A){Object.defineProperty(E,A,Object.getOwnPropertyDescriptor(C,A));});}return E}({},p);delete m.jpg,_.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(m));}return T}{let m=this.quality*this.qualityRatio;return this.quality=m,await this.generateRequestData(e,{appId:i,cname:r,cid:o,vid:s,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=Mn.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=Bi.CLOSED,this.emit(tn.STATE_CHANGE,ji.CLOSED);}}function pH(t){let e=function(){let n=EH.pop();return n?(n.offset=n.limit=0,n):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(n,i){let r=n.appId;r!==void 0&&(Pe(i,10),qo(i,r));let o=n.cid;o!==void 0&&(Pe(i,16),Pe(i,o));let s=n.cname;s!==void 0&&(Pe(i,26),qo(i,s));let a=n.deviceId;a!==void 0&&(Pe(i,34),qo(i,a));let c=n.elapse;c!==void 0&&(Pe(i,40),zo(i,c));let d=n.fileSize;d!==void 0&&(Pe(i,48),zo(i,$a(d)));let l=n.height;l!==void 0&&(Pe(i,56),zo(i,$a(l)));let u=n.jpg;u!==void 0&&(Pe(i,66),Pe(i,u.length),QO(i,u));let h=n.networkType;h!==void 0&&(Pe(i,72),zo(i,$a(h)));let p=n.osType;p!==void 0&&(Pe(i,80),zo(i,$a(p)));let T=n.requestId;T!==void 0&&(Pe(i,90),qo(i,T));let m=n.sdkVersion;m!==void 0&&(Pe(i,98),qo(i,m));let E=n.sequence;E!==void 0&&(Pe(i,104),zo(i,$a(E)));let S=n.sid;S!==void 0&&(Pe(i,114),qo(i,S));let C=n.timestamp;C!==void 0&&(Pe(i,120),zo(i,C));let A=n.uid;A!==void 0&&(Pe(i,128),Pe(i,A));let b=n.vid;b!==void 0&&(Pe(i,136),Pe(i,b));let O=n.width;O!==void 0&&(Pe(i,144),zo(i,$a(O)));let N=n.service;N!==void 0&&(Pe(i,152),Pe(i,N));let k=n.callbackData;k!==void 0&&(Pe(i,162),Pe(i,k.length),QO(i,k));let M=n.ticket;M!==void 0&&(Pe(i,170),qo(i,M));let x=n.vendorConfigs;x!==void 0&&(Pe(i,178),qo(i,x));}(t,e),function(n){let i=n.bytes,r=n.limit;return i.length===r?i:i.subarray(0,r)}(e)}function _H(t){return function(n){let i={};t:for(;!fH(n);){let r=bd(n);switch(r>>>3){case 0:break t;case 1:i.code=bd(n);break;case 2:i.msg=ZO(n,bd(n));break;case 3:i.requestId=ZO(n,bd(n));break;case 4:i.timestamp=gH(n,!1);break;default:mH(n,7&r);}}return i}({bytes:e=t,offset:0,limit:e.length});var e;}function mH(t,e){switch(e){case 0:for(;128&er(t););break;case 2:uf(t,bd(t));break;case 5:uf(t,4);break;case 1:uf(t,8);break;default:throw new Error("Unimplemented type: "+e)}}function $a(t){return {low:t|=0,high:t>>31,unsigned:t>=0}}let EH=[];function uf(t,e){if(t.offset+e>t.limit)throw new Error("Skip past limit");t.offset+=e;}function fH(t){return t.offset>=t.limit}function sh(t,e){let n=t.bytes,i=t.offset,r=t.limit,o=i+e;if(o>n.length){let s=new Uint8Array(2*o);s.set(n),t.bytes=s;}return t.offset=o,o>r&&(t.limit=o),i}function XO(t,e){let n=t.offset;if(n+e>t.limit)throw new Error("Read past limit");return t.offset+=e,n}function QO(t,e){let n=sh(t,e.length);t.bytes.set(e,n);}function ZO(t,e){let n=XO(t,e),i=String.fromCharCode,r=t.bytes,o="\uFFFD",s="";for(let a=0;a<e;a++){let c,d,l,u,h=r[a+n];128&h?(224&h)==192?a+1>=e?s+=o:(c=r[a+n+1],(192&c)!=128?s+=o:(u=(31&h)<<6|63&c,u<128?s+=o:(s+=i(u),a++))):(240&h)==224?a+2>=e?s+=o:(c=r[a+n+1],d=r[a+n+2],(49344&(c|d<<8))!=32896?s+=o:(u=(15&h)<<12|(63&c)<<6|63&d,u<2048||u>=55296&&u<=57343?s+=o:(s+=i(u),a+=2))):(248&h)==240?a+3>=e?s+=o:(c=r[a+n+1],d=r[a+n+2],l=r[a+n+3],(12632256&(c|d<<8|l<<16))!=8421504?s+=o:(u=(7&h)<<18|(63&c)<<12|(63&d)<<6|63&l,u<65536||u>1114111?s+=o:(u-=65536,s+=i(55296+(u>>10),56320+(1023&u)),a+=3))):s+=o:s+=i(h);}return s}function qo(t,e){let n=e.length,i=0;for(let s=0;s<n;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<n&&(a=(a<<10)+e.charCodeAt(++s)-56613888),i+=a<128?1:a<2048?2:a<65536?3:4;}Pe(t,i);let r=sh(t,i),o=t.bytes;for(let s=0;s<n;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<n&&(a=(a<<10)+e.charCodeAt(++s)-56613888),a<128?o[r++]=a:(a<2048?o[r++]=a>>6&31|192:(a<65536?o[r++]=a>>12&15|224:(o[r++]=a>>18&7|240,o[r++]=a>>12&63|128),o[r++]=a>>6&63|128),o[r++]=63&a|128);}}function er(t){return t.bytes[XO(t,1)]}function $O(t,e){let n=sh(t,1);t.bytes[n]=e;}function bd(t){let e,n=0,i=0;do e=er(t),n<32&&(i|=(127&e)<<n),n+=7;while(128&e);return i}function Pe(t,e){for(e>>>=0;e>=128;)$O(t,127&e|128),e>>>=7;$O(t,e);}function gH(t,e){let n,i=0,r=0,o=0;return n=er(t),i=127&n,128&n&&(n=er(t),i|=(127&n)<<7,128&n&&(n=er(t),i|=(127&n)<<14,128&n&&(n=er(t),i|=(127&n)<<21,128&n&&(n=er(t),r=127&n,128&n&&(n=er(t),r|=(127&n)<<7,128&n&&(n=er(t),r|=(127&n)<<14,128&n&&(n=er(t),r|=(127&n)<<21,128&n&&(n=er(t),o=127&n,128&n&&(n=er(t),o|=(127&n)<<7))))))))),{low:i|r<<28,high:r>>>4|o<<24,unsigned:e}}function zo(t,e){let n=e.low>>>0,i=(e.low>>>28|e.high<<4)>>>0,r=e.high>>>24,o=r===0?i===0?n<16384?n<128?1:2:n<1<<21?3:4:i<16384?i<128?5:6:i<1<<21?7:8:r<128?9:10,s=sh(t,o),a=t.bytes;switch(o){case 10:a[s+9]=r>>>7&1;case 9:a[s+8]=o!==9?128|r:127&r;case 8:a[s+7]=o!==8?i>>>21|128:i>>>21&127;case 7:a[s+6]=o!==7?i>>>14|128:i>>>14&127;case 6:a[s+5]=o!==6?i>>>7|128:i>>>7&127;case 5:a[s+4]=o!==5?128|i:127&i;case 4:a[s+3]=o!==4?n>>>21|128:n>>>21&127;case 3:a[s+2]=o!==3?n>>>14|128:n>>>14&127;case 2:a[s+1]=o!==2?n>>>7|128:n>>>7&127;case 1:a[s]=o!==1?128|n:127&n;}}let t0={},e0={},ah=4294967296,n0=ah*ah,i0=n0/2;o0(0,!0);let r0=o0(0),TH=tc(0,-2147483648,!1),SH=tc(-1,2147483647,!1);function o0(t,e){let n,i,r;return e?(r=0<=(t>>>=0)&&t<256)&&(i=e0[t],i)?i:(n=tc(t,0,!0),r&&(e0[t]=n),n):(r=-128<=(t|=0)&&t<128)&&(i=t0[t],i)?i:(n=tc(t,t<0?-1:0,!1),r&&(t0[t]=n),n)}function tc(t,e,n){return {low:0|t,high:0|e,unsigned:!!n}}function CH(t,e){if(isNaN(t))return r0;{if(t<=-i0)return TH;if(t+1>=i0)return SH}return t<0?r0:tc(t%ah|0,t/ah|0,e)}function s0(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}class pf extends de{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;let n=this._connectionState;this._connectionState=e,this.emit(dr.CONNECTION_STATE_CHANGE,e,n);}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this._qualityRatio;},6e4));}constructor(e){var n;super(),g(this,"name","AgoraRTCImageModeration"),g(this,"_connectionState",yi.CONNECTING),g(this,"_sequence",0),g(this,"_moderationStartTime",void 0),g(this,"_workerConnection",void 0),g(this,"_workerMessageLengthLimit",void 0),g(this,"_qualityRatio",void 0),g(this,"_connectInfo",void 0),g(this,"_cancelTokenSource",Mn.CancelToken.source()),g(this,"_retryConfig",void 0),g(this,"_moderationInterval",void 0),g(this,"_moderationTimer",null),g(this,"_moderationMode",1),g(this,"_quality",1),g(this,"_qualityTimer",null),g(this,"_ticket",void 0),g(this,"_moderationIntervalMinimum",void 0),g(this,"_uploadFailedNum",0),g(this,"_uploadNum",0),g(this,"_uploadTimer",null),g(this,"_extraInfo",void 0),g(this,"_vendor",""),g(this,"_encoder",new TextEncoder),g(this,"_moderationId",void 0),g(this,"inspectImage",()=>{if(this.connectionState!==yi.CONNECTED)throw new w(R.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval(()=>{this.connectionState===yi.CONNECTED?this.requestToInspectImage():_.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState);},this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage();}),this._moderationId=Zt(5,"image-moderation-"),this._workerMessageLengthLimit=v("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=v("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=(n=e.interval)!==null&&n!==void 0?n:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),this._qualityRatio=v("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new Yc("worker-"+this._moderationId,Ne),this.on(dr.STATE_CHANGE,(i,r)=>{_.debug("[".concat(this._moderationId,"] Moderation operation :").concat(Ra[i]," ").concat(r||""));}),this.handleWorkerEvents();}async init(e,n){this.emit(dr.STATE_CHANGE,Ra.CONNECT_AP),this._connectInfo=e;let i=this._cancelTokenSource.token;return this._retryConfig=n,new K((r,o)=>{this.on(dr.CONNECTION_STATE_CHANGE,(s,a)=>{s===yi.CONNECTED&&r();}),this.requestAP(e,i,n).then(s=>{this.connectWorker(s);}).catch(s=>{o(s);});})}updateConfig(e){var n;this._moderationInterval=(n=e.interval)!==null&&n!==void 0?n:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),_.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(e))),this.connectionState===yi.CONNECTED&&this.inspectImage();}async requestAP(e,n,i){let r=v("WEBCS_DOMAIN").map(c=>"https://".concat(c,"/api/v1")),o=await function(c,d,l,u){let{appId:h,areaCode:p,cname:T,sid:m,token:E,uid:S}=d;Ia++;let C="moderation_plugin",A={service_name:C,json_body:JSON.stringify({appId:h,areaCode:p,cname:T,command:"allocateEdge",requestId:Ia,seq:Ia,sid:m,appToken:E,ts:Date.now(),uid:S+""})},b,O,N=c[0];return ar(async()=>{b=Date.now();let k=await ur(N,{data:A,cancelToken:l,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(O=Date.now()-b,k.code!==0){let X=new w(R.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+k.code,{retry:!0,responseTime:O});throw _.error(X.toString()),X}let M=JSON.parse(k.json_body);if(M.code!==200){let X=new w(R.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(M.code,", reason: ").concat(M.reason),{code:M.code,responseTime:O});throw _.error(X.toString()),X}if(!M.servers||!Array.isArray(M.servers)||M.servers.length===0){let X=new w(R.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:M.code,responseTime:O});throw _.error(X.toString()),X}if(!M.servers.some(X=>!!X.wss)){let X=new w(R.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:M.code,responseTime:O});throw _.error(X.toString()),X}let x=v("IMAGE_MODERATION_WORKER_HOST");return {addressList:M.servers.map(X=>{let{address:bt,wss:Ft}=X;if(bt&&Ft)return "wss://".concat(bt.replace(/\./g,"-"),".").concat(x,":").concat(Ft,"/moderation")}).filter(X=>!!X),workerToken:M.workerToken,vid:M.vid,ticket:M.appTicket,responseTime:O}},(k,M)=>(et.apworkerEvent(m,{success:!0,sc:200,serviceName:C,responseDetail:JSON.stringify(k.addressList),firstSuccess:M===0,responseTime:O,serverIp:c[M%c.length]}),!1),(k,M)=>(et.apworkerEvent(m,{success:!1,sc:k.data&&k.data.code||200,serviceName:C,responseTime:O,serverIp:c[M%c.length]}),!!(k.code!==R.OPERATION_ABORTED&&k.code!==R.UNEXPECTED_RESPONSE||k.data&&k.data.retry)&&(N=c[(M+1)%c.length],!0)),u)}(r,e,n,i);this.emit(dr.STATE_CHANGE,Ra.AP_CONNECTED);let{addressList:s,ticket:a}=o;return this._ticket=a,s}async connectWorker(e){this.emit(dr.STATE_CHANGE,Ra.CONNECT_WORKER),await this._workerConnection.init(e,1e4);}handleWorkerEvents(){this._workerConnection.on(dt.CONNECTED,async()=>{this.emit(dr.STATE_CHANGE,Ra.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=yi.CONNECTED;}),this._workerConnection.on(dt.CLOSED,()=>{this.connectionState=yi.CLOSED;}),this._workerConnection.on(dt.FAILED,()=>{this.connectionState=yi.CLOSED;}),this._workerConnection.on(dt.RECONNECTING,()=>{this.connectionState=this.connectionState===yi.CONNECTED?yi.RECONNECTING:yi.CONNECTING;}),this._workerConnection.on(dt.ON_MESSAGE,async e=>{if(e.data instanceof ArrayBuffer){let n=_H(new Uint8Array(e.data));v("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&_.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(n)),this._uploadNum++,n.code===void 0||n.code===0||(this._uploadFailedNum++,_.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(n.code,", msg is ").concat(n.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout(()=>{et.reportApiInvoke(this._connectInfo.sid||null,{name:ke.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,n.code],tag:ge.TRACER}).onError(new w(R.IMAGE_MODERATION_UPLOAD_FAILED,n.msg)),this._uploadTimer=null;},v("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))));}else _.error("[".concat(this._moderationId,"] Unexpected message type from worker"));}),this._workerConnection.on(dt.WILL_RECONNECT,(e,n,i)=>{e==="recover"&&i(e),i("tryNext");}),this._workerConnection.on(dt.REQUEST_NEW_URLS,(e,n)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(n);});}static intToLong(e){return {low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){let e=Qn(this,dr.CLIENT_LOCAL_VIDEO_TRACK),n={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void(v("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&_.debug("Only the track being played can be inspected"));this._sequence++;let i=await this.generateRequestData(e,n);this._workerConnection.sendMessage(i,!0,!0);}else v("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&_.debug("Only the track being published can be inspected");}async generateRequestData(e,n){let{appId:i,cname:r,cid:o,vid:s,sid:a,uid:c}=n,d=Date.now(),l=await e.getCurrentFrameImage("image/jpeg",this.quality),u=await XA(l,i,r),h=this._sequence+"-"+o+"-"+c+"-"+d+"-"+Zt(12,""),p={appId:i,cid:o,cname:r,deviceId:"",elapse:pf.intToLong(Number(d-this._moderationStartTime)),fileSize:l.buffer.byteLength,height:l.height,width:l.width,jpg:u,networkType:6,osType:7,requestId:h,sdkVersion:"4.21.0",sequence:this._sequence,sid:a,timestamp:CH(d),uid:c,vid:s,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};this._extraInfo===void 0&&delete p.callbackData;let T=pH(p);if(T.byteLength<this._workerMessageLengthLimit){if(v("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){let m=function(E){for(var S=1;S<arguments.length;S++){var C=arguments[S]!=null?arguments[S]:{};S%2?s0(Object(C),!0).forEach(function(A){g(E,A,C[A]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(E,Object.getOwnPropertyDescriptors(C)):s0(Object(C)).forEach(function(A){Object.defineProperty(E,A,Object.getOwnPropertyDescriptor(C,A));});}return E}({},p);delete m.jpg,_.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(m));}return T}{let m=this.quality*this._qualityRatio;return this.quality=m,await this.generateRequestData(e,{appId:i,cname:r,cid:o,vid:s,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=Mn.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=yi.CLOSED,this.emit(dr.STATE_CHANGE,Ra.CLOSED);}}function a0(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function c0(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?a0(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):a0(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}let vH=Date.now(),IH=20,_f=new Map,ch=new Map;async function d0(t){let e=_f.get(t),n=Array.isArray(e)&&e[e.length-1],i=ch.get(t);if(!n)return void(i.isSyncing=!1);let r={uid:n.uid,payload:n.payload};i.firstRecvTs===0&&(i.firstRecvTs=n.recvTs,i.firstSendTs=n.sendTs);let o=n.sendTs-i.firstSendTs,s=o-(Date.now()-i.firstRecvTs);s>0&&(i.firstRecvTs=Date.now()-o);let a=n.mediaDelay+s;a<=0?(e.pop(),l0(n.context,r),a=0):a=Math.min(a,IH),setTimeout(()=>e.length&&d0(t),a);}function l0(t,e){t.safeEmit(yt.STREAM_MESSAGE,e.uid,e.payload),t.onStreamMessage&&t.onStreamMessage(e);}function yH(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0;if(!t.syncWithAudio)return l0(n,{uid:t.uid,payload:t.payload});let i="".concat(n.id,"-").concat(t.uid),r=_f.get(i)||[],o=r.findIndex(d=>t.sendTs>=d.sendTs),s=c0(c0({},t),{},{context:n,mediaDelay:e,recvTs:Date.now()});o===-1?r.push(s):r.splice(o,0,s),_f.set(i,r);let a=!1;var c;ch.has(i)?a=!((c=ch.get(i))===null||c===void 0||!c.isSyncing):ch.set(i,{isSyncing:a,firstRecvTs:0,firstSendTs:0}),a||d0(i);}let AH=Pt().name;function u0(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function h0(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?u0(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):u0(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}let ec="websdk_ng_cache_parameter",bH=v("MAX_PRELOAD_ASYNC_LENGTH"),wH=1e4,Vs=new Map,Fs=[],mf=null,Ef=0,ff=0,dh=new Map,OH=function(t,e){let n=[],i=0,r=async()=>{let o=n.shift();o&&await o(),n.length>0&&i<e?r():i--;};return async function(){for(var o=arguments.length,s=new Array(o),a=0;a<o;a++)s[a]=arguments[a];return new K(async(c,d)=>{n.push(async()=>{try{let l=await t(...s);c(l);}catch(l){d(l);}}),i<e&&(i++,r());})}}(p0,bH),gf=Mn.CancelToken.source();async function p0(t,e,n,i,r){try{if(!v("ENABLE_PRELOAD"))return;if(!Ot().supportWebCrypto)return void yo(()=>{_.warn("Your browser does not support preloading, this feature  be run in a secure environment");},"preload_webcrypto_not_supported");if(!n&&n!==null)throw new D(R.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));n&&rn(n,"token",1,2047),rn(t,"appid",1,2047),nu(e),i&&iu(i);let o=jc();_.debug("preload channel ".concat(e,", uid is ").concat(i));let s={appId:t,cname:e,token:n||t,uid:typeof i!="string"?i:null,sid:o,proxyServer:r},a,c;typeof i=="string"?(s.stringUid=i,[c,a]=await K.all([Xj(i,{sid:o,appId:t},gf.token),ry(h0(h0({},s),{},{token:n||t,uid:0}),gf.token)]),s.uid=c.uid,a.gatewayInfo.uid=s.uid,a.gatewayInfo.res.uid=s.uid):a=await ry(s,gf.token);let d={sid:o,appId:t,cname:e,token:n||t,uid:s.stringUid||i,intUid:s.uid||a.gatewayInfo.uid,stringUid:s.stringUid,ts:Date.now(),sua:c,ap:a};await async function(l){let u;try{l.uid&&m0({appId:l.appId,cname:l.cname,token:l.token,uid:l.uid,stringUid:l.stringUid});let h=T0(l),p=await async function(m,E){try{let S=await window.crypto.subtle.importKey("raw",cI(E),"AES-GCM",!1,["encrypt"]),C=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:new Uint8Array(1)},S,_s(window.btoa(JSON.stringify(m))));return Ao(new Uint8Array(C))}catch{return}}(l,l.token||l.appId);if(!p)return;u=g0(ec);let T=u?JSON.parse(u):[];T.push({[h]:p}),T.length>v("AP_CACHE_NUM")&&T.shift(),lh(ec,JSON.stringify(T));}catch(h){_.warn("Error caching server parameters:",h.message),lh(ec,"");}}(d),Ef++;}catch(o){throw ff++,function(s){mf||(mf=window.setTimeout(()=>{let c="";dh.forEach((d,l)=>{c+="".concat(l,": ").concat(d," ;");}),et.reportApiInvoke(null,{name:ke.PRELOAD,options:{success:Ef,failed:ff,err:c}}).onError(s),Ef=0,ff=0,dh.clear(),mf=null;},wH));let a=dh.get(s.code)||0;dh.set(s.code,a+1);}(o),o}}async function _0(t){try{let e=m0(t);if(!e||t.cloudProxyServer!=="disabled")return;let n=await async function(i,r){try{let o=await window.crypto.subtle.importKey("raw",cI(r),"AES-GCM",!1,["decrypt"]),s=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(1)},o,_s(i));return JSON.parse(window.atob(Ao(new Uint8Array(s))))}catch{return}}(e,t.token||t.appId);if(!n||!function(i,r){return i.cname===r.cname&&i.appId===r.appId&&i.token===r.token?r.stringUid?i.stringUid===r.stringUid:typeof r.uid=="number"?i.uid===r.uid:i.uid==r.uid:!1}(n,t))return;if(n&&Date.now()-n.ts<v("AP_CACHE_LIFETIME"))return n}catch(e){_.warn("Error get preloadInfo",e.message);}}function m0(t){let e;try{if(e=g0(ec),!e)return;let n=JSON.parse(e),i=T0(t),r=function(s,a){for(let c=s.length-1;c>=0;c--)if(a(s[c]))return c;return -1}(n,s=>i in s);if(r===-1)return;let o=n.splice(r,1)[0];return lh(ec,JSON.stringify(n)),o[i]}catch(n){_.warn("Error delete preload info: ".concat(e),n.message),lh(ec,"");}}function Tf(t){if(t){let e=Vs.get(t);e&&(window.clearTimeout(e),e=null,Vs.delete(t)),q(Fs).call(Fs,t)||t.cloudProxyServer!=="disabled"||Fs.push(t);}if(Vs.size<v("AP_CACHE_NUM")&&Fs.length>0){let e=Fs.shift();Vs.set(e,window.setTimeout(async()=>{let{appId:n,cname:i,token:r,uid:o,proxyServer:s}=e;try{await OH(n,i,r,o,s),Vs.has(e)&&Tf(e);}catch(a){_.warn("update preload failed",a.message),E0(e);}},v("AP_UPDATE_INTERVAL")));}}function E0(t){let e=Fs.indexOf(t);e!==-1&&Fs.splice(e,1);let n=Vs.get(t);n&&(window.clearTimeout(n),n=null,Vs.delete(t),Tf());}function f0(t,e){let n=t.sua,i=t.ap;e&&n&&et.reqUserAccount(t.sid,{lts:n.requestTime,elapse:n.elapse,success:!0,serverAddr:n.url,stringUid:e,uid:t.intUid,errorCode:null,extend:n.req}),et.reportResourceTiming(t.ap.url,t.sid),et.joinWebProxyAP(t.sid,{lts:i.requestTime,elapse:i.elapse,sucess:1,apServerAddr:i.url,turnServerAddrList:i.proxyInfo.addresses.map(r=>r.ip).join(","),eventType:"disabled",unilbsServerIds:[De.CHOOSE_SERVER,De.CLOUD_PROXY_FALLBACK].toString()}),et.joinChooseServer(t.sid,{lts:i.requestTime,elapse:i.elapse,succ:!0,csAddr:i.url,opid:i.opid,serverList:i.gatewayInfo.gatewayAddrs.map(r=>r.address),ec:null,cid:i.gatewayInfo.cid.toString(),uid:i.gatewayInfo.uid.toString(),csIp:i.gatewayInfo.csIp,unilbsServerIds:[De.CHOOSE_SERVER].toString(),isHttp3:i.isHttp3});}function g0(t){return window.atob(window.localStorage.getItem(t)||"")}function lh(t,e){window.localStorage.setItem(t,window.btoa(e));}function T0(t){let e="".concat(t.appId,"_").concat(t.cname);return typeof t.uid=="string"&&(e+="_s_".concat(t.uid)),typeof t.uid=="number"&&(e+="_".concat(t.uid)),t.token&&(e+="_".concat(t.token)),mI(e)}var S0,R0,C0,v0,I0,y0,A0,b0,w0,O0,N0,D0,P0,L0,k0,M0,U0,x0,V0,F0,B0,j0,G0,W0,H0,K0,Y0,q0,z0,J0,X0,Q0,Z0,$0,tN,eN,nN,iN,rN,oN,sN,aN,z;function cN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function Di(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?cN(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):cN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}Qe.setLogger(_);let NH=(S0=st(),R0=st({argsMap:(t,e)=>{if(!Array.isArray(e)){if(!(e instanceof Ga))return [e];e=[e];}return e.map(n=>n?Object(n).toString():"null")}}),C0=st({argsMap:(t,e)=>(e||(e=[]),e instanceof Nw?[e.getChannelId()]:(Array.isArray(e)||(e=[e]),e.map(n=>n.getTrackId())))}),v0=st({argsMap:(t,e,n,i)=>[typeof e=="object"?e.uid:e,n,i]}),I0=st({argsMap:(t,e,n)=>[e,n]}),y0=st({argsMap:(t,e)=>e.map(n=>{let{user:i,mediaType:r}=n;return [i?.uid,r]})}),A0=st({argsMap:(t,e,n,i)=>[typeof e=="object"?e.uid:e,n,i]}),b0=st({argsMap:(t,e)=>e.map(n=>{let{user:i,mediaType:r}=n;return {uid:i?.uid,mediaType:r}})}),w0=st(),O0=st(),N0=st(),D0=st(),P0=st(),L0=st(),k0=st(),M0=st(),U0=st(),x0=st(),V0=st(),F0=st(),B0=st(),j0=st(),G0=st({argsMap:(t,e)=>[e]}),W0=st(),H0=st(),K0=st(),Y0=st(),q0=st(),z0=st(),J0=st(),X0=st(),Q0=st(),Z0=st(),$0=st({argsMap:(t,e)=>(Array.isArray(e)||(e=[e]),[JSON.stringify(e)])}),tN=st(),eN=st(),nN=st(),iN=st(),rN=st(),oN=st(),sN=st({reportResult:!0}),aN=st(),z=class extends de{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var t;return ((t=this._config)===null||t===void 0?void 0:t.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return !!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return "Client"}constructor(t){let e;if(super(),g(this,"store",void 0),g(this,"_uid",void 0),g(this,"_channelName",void 0),g(this,"_uintUid",void 0),g(this,"_users",[]),g(this,"_config",void 0),g(this,"_clientId",void 0),g(this,"_appId",void 0),g(this,"_sessionId",null),g(this,"_key",void 0),g(this,"_rtmConfig",{}),g(this,"_joinInfo",void 0),g(this,"_gateway",void 0),g(this,"_statsCollector",void 0),g(this,"_configDistribute",void 0),g(this,"_leaveMutex",new Qe("client-leave")),g(this,"_publishMutex",new Qe("client-publish")),g(this,"_renewTokenMutex",new Qe("client-renewtoken")),g(this,"_subscribeMutex",new Qe("client-subscribe")),g(this,"_encryptionMode","none"),g(this,"_encryptionSecret",null),g(this,"_encryptionSalt",null),g(this,"_encryptDataStream",!1),g(this,"_encryptDataStreamKey",null),g(this,"_encryptDataStreamIv",null),g(this,"_proxyServer",void 0),g(this,"_turnServer",{servers:[],mode:"auto"}),g(this,"_cloudProxyServerMode","disabled"),g(this,"_isDualStreamEnabled",!1),g(this,"_defaultStreamFallbackType",void 0),g(this,"_lowStreamParameter",void 0),g(this,"_streamFallbackTypeCacheMap",new Map),g(this,"_remoteStreamTypeCacheMap",new Map),g(this,"_axiosCancelSource",Mn.CancelToken.source()),g(this,"_audioVolumeIndicationInterval",void 0),g(this,"_networkQualityInterval",void 0),g(this,"_userOfflineTimeout",void 0),g(this,"_streamRemovedTimeout",void 0),g(this,"_injectStreamingClient",void 0),g(this,"_liveTranscodeStreamingClient",void 0),g(this,"_liveRawStreamingClient",void 0),g(this,"_channelMediaRelayClient",void 0),g(this,"_networkQualitySensitivity","normal"),g(this,"_p2pChannel",void 0),g(this,"_useLocalAccessPoint",!1),g(this,"_setLocalAPVersion",void 0),g(this,"_joinAndNotLeaveYet",!1),g(this,"_numberOfJoinCount",0),g(this,"_remoteDefaultVideoStreamType",void 0),g(this,"_inspect",void 0),g(this,"_moderation",void 0),g(this,"_license",void 0),g(this,"_pendingPublishedUsers",[]),g(this,"ntpAlignErrorCount",0),g(this,"remoteInboundOffset",0),g(this,"_handleLocalTrackEnable",(n,i,r)=>{this.publish(n,!1).then(i).catch(r);}),g(this,"_handleLocalTrackDisable",(n,i,r)=>{this.unpublish(n).then(i).catch(r);}),g(this,"_handleUserOnline",n=>{if(v("BLOCK_LOCAL_CLIENT")&&Es(n.uid,this.channelName))return void _.debug("[".concat(n.uid,"] will be ignored in local"));this.isStringUID&&typeof n.uid!="string"&&_.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));let i=this._users.find(r=>r.uid===n.uid);if(i)i._trust_in_room_=!0,i._is_pre_created&&(i._is_pre_created=!1,this.safeEmit(yt.USER_JOINED,i));else {let r=new Go(n.uid,n.uint_id||n.uid);this._users.push(r),_.debug("[".concat(this._clientId,"] user online"),n.uid),this.safeEmit(yt.USER_JOINED,r);}}),g(this,"_handleUserOffline",n=>{if(v("BLOCK_LOCAL_CLIENT")&&Es(n.uid,this.channelName))return;let i=this._users.find(r=>r.uid===n.uid);i&&(this._handleRemoveStream(n),this._handleRemoveDataChannels(n),i._audio_pre_subscribed||i._video_pre_subscribed?i._is_pre_created=!0:ql(this._users,i),this._remoteStreamTypeCacheMap.delete(i.uid),this._streamFallbackTypeCacheMap.delete(i.uid),_.debug("[".concat(this._clientId,"] user offline"),n.uid,"reason:",n.reason),this.safeEmit(yt.USER_LEAVED,i,n.reason));}),g(this,"_handleAddAudioOrVideoStream",(n,i,r,o,s,a,c)=>{if(v("BLOCK_LOCAL_CLIENT")&&Es(i,this.channelName))return;let d=this._users.find(u=>u.uid===i);if(!d)return void _.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));_.debug("[".concat(this._clientId,"] stream added with uid ").concat(i,", type ").concat(n)),this.store.subscribe(d.uid,n,void 0,void 0,void 0,Date.now());let l=n==="audio"?d.hasAudio:d.hasVideo;d._uintid||(d._uintid=s||i),n==="audio"?d._trust_audio_stream_added_state_=!0:d._trust_video_stream_added_state_=!0,n==="audio"?(d._audio_added_=!0,r!==void 0&&(d._audioSSRC=r),o!==void 0&&(d._cname=o),a&&(d._audioOrtc=a)):(d._video_added_=!0,r!==void 0&&(d._videoSSRC=r),o!==void 0&&(d._cname=o),c!==void 0&&(d._rtxSsrcId=c),a&&(d._videoOrtc=a)),(n==="audio"?d.hasAudio:d.hasVideo)&&!l&&(_.info("[".concat(this._clientId,"] remote user ").concat(d.uid," published ").concat(n)),this.safeEmit(yt.USER_PUBLISHED,d,n)),n==="video"?et.onGatewayStream(this._sessionId,Ze.ON_ADD_VIDEO_STREAM,_e.ON_ADD_VIDEO_STREAM,{peer:s||i,ssrc:d._videoSSRC}):et.onGatewayStream(this._sessionId,Ze.ON_ADD_AUDIO_STREAM,_e.ON_ADD_AUDIO_STREAM,{peer:s||i,ssrc:d._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(d,n,r).then(u=>{if(u&&(_.debug("[".concat(this._clientId,"] resubscribe ").concat(n," for user ").concat(d.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof rh))return this._p2pChannel.unsubscribe(d,n,!0).then(()=>this._subscribe(d,n,!0).catch(h=>{_.error("[".concat(this._clientId,"] resubscribe error"),h.toString());}))}),this._p2pChannel.hasPendingRemoteMedia(d,n)&&(_.debug("[".concat(this._clientId,"] resubscribe ").concat(n," for user ").concat(d.uid," after reconnect.")),this._subscribe(d,n,!0).catch(u=>{_.error("[".concat(this._clientId,"] resubscribe error"),u.toString());}));}),g(this,"_handleRemoveStream",n=>{if(v("BLOCK_LOCAL_CLIENT")&&Es(n.uid,this.channelName))return;let i=this._users.find(o=>o.uid===n.uid);if(!i)return void _.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));_.debug("[".concat(this._clientId,"] stream removed with uid ").concat(n.uid));let r=()=>{};i.hasAudio&&i.hasVideo?r=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished audio track")),this.safeEmit(yt.USER_UNPUBLISHED,i,"audio"),_.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished video track")),this.safeEmit(yt.USER_UNPUBLISHED,i,"video");}:i.hasVideo?r=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished video track")),this.safeEmit(yt.USER_UNPUBLISHED,i,"video");}:i.hasAudio&&(r=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished audio track")),this.safeEmit(yt.USER_UNPUBLISHED,i,"audio");}),i._video_pre_subscribed||i._audio_pre_subscribed||(i._trust_audio_stream_added_state_=!0,i._trust_video_stream_added_state_=!0,i._audio_added_=!1,i._video_added_=!1,this._p2pChannel instanceof rh&&this._p2pChannel.unsubscribe(i).then(o=>{if(o)return this._gateway.unsubscribe(o,i.uid)}),i._audioSSRC=void 0,i._videoSSRC=void 0,i._audioOrtc=void 0,i._videoOrtc=void 0,i._rtxSsrcId=void 0),et.onGatewayStream(this._sessionId,Ze.ON_REMOVE_STREAM,_e.ON_REMOVE_STREAM,{peer:n.uint_id||n.uid}),r();}),g(this,"_handleSetStreamLocalEnable",(n,i,r)=>{if(v("BLOCK_LOCAL_CLIENT")&&Es(i,this.channelName))return;let o=this._users.find(c=>c.uid===i);if(!o)return void _.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));_.debug("[".concat(this._clientId,"] local ").concat(n," ").concat(r?"enabled":"disabled"," with uid ").concat(i));let s=n==="audio"?o.hasAudio:o.hasVideo;if(n==="audio"){o._trust_audio_enabled_state_=!0;let c=o._audio_enabled_;if(o._audio_enabled_=r,o._audio_enabled_===c)return;{let d=o._audio_enabled_?"enable-local-audio":"disable-local-audio";_.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(i,", msg: ").concat(d)),this.safeEmit(yt.USER_INFO_UPDATED,i,d);}}else {o._trust_video_enabled_state_=!0;let c=o._video_enabled_;if(o._video_enabled_=r,o._video_enabled_===c)return;{let d=o._video_enabled_?"enable-local-video":"disable-local-video";_.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(i,", msg: ").concat(d)),this.safeEmit(yt.USER_INFO_UPDATED,i,d);}}let a=n==="audio"?o.hasAudio:o.hasVideo;return s!==a?!s&&a?(_.info("[".concat(this._clientId,"] remote user ").concat(i," published ").concat(n)),void this.safeEmit(yt.USER_PUBLISHED,o,n)):(n==="video"&&o._videoTrack&&o._videoTrack._destroy(),n==="audio"&&o._audioTrack,this._p2pChannel.muteRemote(o,n),_.info("[".concat(this._clientId,"] remote user ").concat(i," unpublished ").concat(n)),void this.safeEmit(yt.USER_UNPUBLISHED,o,n)):void 0}),g(this,"_handleMuteStream",(n,i,r)=>{if(v("BLOCK_LOCAL_CLIENT")&&Es(n,this.channelName))return;_.debug("[".concat(this._clientId,"] receive mute message"),n,i,r);let o=this._users.find(c=>c.uid===n);if(!o)return void _.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(n));let s=i==="audio"?o.hasAudio:o.hasVideo;if(i==="audio"){o._trust_audio_mute_state_=!0;let c=o._audio_muted_;if(o._audio_muted_=r,o._audio_muted_===c)return;{let d=o._audio_muted_?"mute-audio":"unmute-audio";_.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(n,", msg: ").concat(d)),this.safeEmit(yt.USER_INFO_UPDATED,n,d);}}else {o._trust_video_mute_state_=!0;let c=o._video_muted_;if(o._video_muted_=r,o._video_muted_===c)return;{let d=o._video_muted_?"mute-video":"unmute-video";_.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(n,", msg: ").concat(d)),this.safeEmit(yt.USER_INFO_UPDATED,n,d);}}let a=i==="audio"?o.hasAudio:o.hasVideo;if(s!==a){if(!s&&a)return (i==="audio"?o._audioSSRC:o._videoSSRC)?(_.info("[".concat(this._clientId,"] remote user ").concat(n," published ").concat(i)),void this.safeEmit(yt.USER_PUBLISHED,o,i)):void _.warning("[".concat(this._clientId,"] remote user ").concat(n," receive ").concat(i," unmute message  before add stream message, ").concat(i," SSRC doesn't exist yet."));i==="video"&&o._videoTrack&&!o._video_pre_subscribed&&o._videoTrack._destroy(),i==="audio"&&o._audioTrack,this._p2pChannel.muteRemote(o,i),_.info("[".concat(this._clientId,"] remote user ").concat(n," unpublished ").concat(i)),this.safeEmit(yt.USER_UNPUBLISHED,o,i);}}),g(this,"_handleP2PLost",async n=>{_.debug("[".concat(this._clientId,"] receive p2p lost"),n),parseInt(n.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():_.warning("[".concat(this._clientId,"] P2PLost stream not found"),n);}),g(this,"_handleTokenWillExpire",()=>{_.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(yt.ON_TOKEN_PRIVILEGE_WILL_EXPIRE);}),g(this,"_handleBeforeUnload",n=>{n.type==="beforeunload"&&n.returnValue!==void 0&&n.returnValue!==""||(this.leave(),_.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")));}),g(this,"_handleUpdateNetworkQuality",()=>{if(this._networkQualitySensitivity==="normal")return;if(navigator&&navigator.onLine!==void 0&&!navigator.onLine)return void this.safeEmit(yt.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});let n={downlinkNetworkQuality:0,uplinkNetworkQuality:0};n.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),n.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(yt.NETWORK_QUALITY,n);}),g(this,"_handleP2PAddAudioOrVideoStream",(n,i,r,o)=>{let s=this._users.find(c=>c.uid===i);if(!s)return void _.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));_.debug("[".concat(this._clientId,"] stream added with uid ").concat(i,", type ").concat(n)),this.store.subscribe(s.uid,n,void 0,void 0,void 0,Date.now());let a=n==="audio"?s.hasAudio:s.hasVideo;n==="audio"?s._trust_audio_stream_added_state_=!0:s._trust_video_stream_added_state_=!0,n==="audio"?(s._audio_added_=!0,r!==void 0&&(s._audioSSRC=r),o!==void 0&&(s._audioMid=o)):(s._video_added_=!0,r!==void 0&&(s._videoSSRC=r),o!==void 0&&(s._videoMid=o)),(n==="audio"?s.hasAudio:s.hasVideo)&&!a&&(_.info("[".concat(this._clientId,"] remote user ").concat(s.uid," published ").concat(n)),this.safeEmit(yt.USER_PUBLISHED,s,n)),this._p2pChannel.hasPendingRemoteMedia(s,n)&&(_.debug("[".concat(this._clientId,"] resubscribe ").concat(n," for user ").concat(s.uid," after reconnect.")),this._subscribe(s,n,!0).catch(c=>{_.error("[".concat(this._clientId,"] resubscribe error"),c.toString());}));}),this._config=t,this._clientId=Zt(5,"client-"),this.store=new kB(t.codec,t.audioCodec,t.mode,this._clientId),this.store.clientCreated(),t.proxyServer&&this.setProxyServer(t.proxyServer,!0),t.turnServer&&this.setTurnServer(t.turnServer,!0),_.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(vi," build: ").concat(Em,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),t.clientRoleOptions)try{sI(t.clientRoleOptions),e=Object.assign({},t.clientRoleOptions);}catch(n){_.warning("[".concat(this._clientId,"] ").concat(n.toString()));}this._statsCollector=new Id(this.store),this._statsCollector.onStatsException=(n,i,r)=>{_.debug("[".concat(this._clientId,"] receive exception msg, code: ").concat(n,", msg: ").concat(i,", uid: ").concat(r)),this.safeEmit(yt.EXCEPTION,{code:n,msg:i,uid:r});},this._statsCollector.onUploadPublishDuration=(n,i,r,o)=>{let s=this._users.find(a=>a.uid===n);s&&et.peerPublishStatus(this._sessionId,{subscribeElapse:o,audioPublishDuration:i,videoPublishDuration:r,peer:s._uintid});},this.store.useDataChannel=Ot().supportDataChannel&&v("SIGNAL_CHANNEL"),this.store.useP2P=t.mode==="p2p",this._gateway=new Hj(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:t.websocketRetryConfig||Ne,httpRetryConfig:t.httpRetryConfig||Ne,forceWaitGatewayResponse:t.forceWaitGatewayResponse===void 0||t.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:t.role,clientRoleOptions:e}),this._configDistribute=new tG,this.store.useP2P?(this._p2pChannel=new ti(this.store,this._statsCollector),this._handleP2PEvents()):this._p2pChannel=new rh(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents();}async joinMeta(t,e,n,i,r){let o=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5],s=arguments.length>6&&arguments[6]!==void 0&&arguments[6];Jt("JOIN_GATEWAY_USE_443PORT_ONLY",o),Jt("JOIN_GATEWAY_USE_DUAL_DOMAIN",s);let a=this._gateway.signal.websocket;return a instanceof Kc&&(a.use443PortOnly=o,a.tryDoubleDomain=s),async function(c,d,l){Gl.get(c)||Gl.set(c,[]),Wl.get(c)||Wl.set(c,d),wr.get(c)||wr.set(c,0);let u=Gl.get(c),h=Wl.get(c);if(!u||!h)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(wr.get(c)===h){let S=xc();u.push(S),await S.promise;}wr.set(c,wr.get(c)+1);for(var p=arguments.length,T=new Array(p>3?p-3:0),m=3;m<p;m++)T[m-3]=arguments[m];let E=await l(...T);return wr.set(c,wr.get(c)-1),wr.get(c)===h-1&&u.length>0&&(u[0].resolve(),u.shift()),wr.get(c)===0&&(Gl.set(c,[]),Wl.set(c,0),wr.set(c,0)),E}("client.join",v("JOIN_MAX_CONCURRENCY"),this.join.bind(this),t,e,n,i,r)}async join(t,e,n,i,r){let o=++this._numberOfJoinCount;this.store.joinStart(),i&&(this.store.uid=i);let s=(Zl||Zl||(Zl=(window.location.protocol.split(":")[0]||"").toUpperCase(),Zl))==="HTTPS",a=EI()?window.isSecureContext:"Browser Not Support";(!EI()&&!s||!window.isSecureContext)&&_.warning("The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser"),this.connectionState==="DISCONNECTED"&&(this.store.avoidJoinStart=Math.round(Date.now()),_.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart))),et.setAppId(t);try{if(!n&&n!==null)throw new w(R.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));n&&rn(n,"token",1,2047),rn(t,"appid",1,2047),nu(e),i&&iu(i),r&&rn(r,"optionalInfo",1,2047);}catch(m){throw et.reportApiInvoke(jc(),{name:ke.JOIN,options:[t,e,n,i],states:{isHttps:s,isSecureContext:a},tag:ge.TRACER}).onError(m),m}let c=await _0({appId:t,cname:e,uid:i,stringUid:typeof i=="string"?i:void 0,token:n||t,cloudProxyServer:this._cloudProxyServerMode}),d=c?.sid||jc(),l=et.reportApiInvoke(d,{name:ke.JOIN,options:[t,e,n,i],states:{isHttps:s,isSecureContext:a},tag:ge.TRACER});if(_.info("[".concat(this._clientId,"] start join channel ").concat(e,", join number: ").concat(o)),this._leaveMutex.isLocked&&(_.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),_.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,this.connectionState!=="DISCONNECTED"){let m=new w(R.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw l.onError(m),m}this._sessionId||(this._sessionId=d,this.store.sessionId=this._sessionId),this._gateway.state="CONNECTING";let u=Di(Di({},this._rtmConfig),{},{clientId:this._clientId,appId:t,sid:this._sessionId,cname:e,uid:typeof i!="string"?i:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:n||t,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:r,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint,preload:!!c},this._remoteDefaultVideoStreamType!==void 0&&{defaultVideoStream:this._remoteDefaultVideoStreamType});if(this._useLocalAccessPoint&&(u.setLocalAPVersion=this._setLocalAPVersion),typeof i=="string"&&(u.stringUid=i,this._uintUid?(u.uid=this._uintUid,this._uintUid=void 0):u.uid=0),this._encryptionMode!=="none"&&this._encryptionSecret){if(u.aesmode=this._encryptionMode,u.aespassword=await(async m=>{let E=function(b){let O=window.atob(`MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu
STM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+
HvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy
xQiYDz3vqa6bP29adwIDAQAB`),N=new Uint8Array(new ArrayBuffer(O.length));for(let k=0;k<O.length;k+=1)N[k]=O.charCodeAt(k);return N}(),S=await window.crypto.subtle.importKey("spki",E,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),C=am(m),A=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},S,C);return function(b){let O="";for(let N=0;N<b.length;N+=1)O+=String.fromCharCode(b[N]);return window.btoa(O)}(new Uint8Array(A))})(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new w(R.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(u.aessalt=this._encryptionSalt);}if(this._encryptDataStream&&(this._encryptionMode==="aes-128-gcm2"||this._encryptionMode==="aes-256-gcm2"))if(this._encryptionSalt&&this._encryptionSecret)if(window.crypto.subtle){let m=new TextEncoder,E=v("USE_PURE_ENCRYPTION_MASTER_KEY")?m.encode(u.appId+this._encryptionSecret+this._encryptionSecret):m.encode(u.appId+u.cname+this._encryptionSecret);this._encryptDataStreamIv=await async function(S,C,A){let b=await window.crypto.subtle.importKey("raw",C,"PBKDF2",!1,["deriveBits","deriveKey"]),O=S==="aes-128-gcm2"?128:256,N=await window.crypto.subtle.deriveBits({name:"PBKDF2",iterations:gI,hash:"SHA-256",salt:A},b,O+MB);return new Uint8Array(N).subarray(O/8)}(this._encryptionMode,E,_s(this._encryptionSalt)),this._encryptDataStreamKey=await async function(S,C,A){let b=await window.crypto.subtle.importKey("raw",C,"PBKDF2",!1,["deriveBits","deriveKey"]),O=S==="aes-128-gcm2"?128:256;return await window.crypto.subtle.deriveKey({name:"PBKDF2",iterations:gI,hash:"SHA-256",salt:A},b,{name:"AES-GCM",length:O},!0,["encrypt","decrypt"])}(this._encryptionMode,E,_s(this._encryptionSalt));}else a?_.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):_.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1;else this._encryptDataStream=!1,_.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));this._startSession(this._sessionId,{channel:e,appId:t,stringUid:u.stringUid,preload:u.preload});let h=this._sessionId;setTimeout(()=>{this.connectionState==="CONNECTING"&&h===this._sessionId&&et.joinChannelTimeout(this._sessionId,5);},5e3);try{var p;let m,E=u.cloudProxyServer;if(q(p=["proxy3","proxy4","proxy5"]).call(p,E)){let O=v("PROXY_SERVER_TYPE3");Array.isArray(O)?u.proxyServer=O[0]:u.proxyServer=O;}if(et.setProxyServer(u.proxyServer),_.setProxyServer(u.proxyServer),this.store.requestAPStart(),c){if(_.debug("[".concat(this._clientId,"] get serverInfo Success from Preload Cache ").concat(u.stringUid?", ".concat(u.stringUid," => ").concat(c.intUid):""," ")),u.stringUid&&!u.uid&&(u.uid=c.intUid),m={gatewayInfo:c.ap.gatewayInfo},v("JOIN_WITH_FALLBACK_MEDIA_PROXY")&&u.turnServer.mode==="auto")if(c.ap.proxyInfo.addresses.length===0)_.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers");else {let O=(await HI(c.ap.proxyInfo,c.ap.gatewayInfo.uid)).map(N=>({turnServerURL:N.address,tcpport:N.tcpport||ln.tcpport,udpport:N.udpport||ln.udpport,username:N.username||ln.username,password:N.password||ln.password,forceturn:!1,security:!0}));u.turnServer={mode:"manual",servers:O};}f0(c,u.stringUid);}else {if(u.stringUid&&!u.uid){let O;[O,m]=await K.all([iy(u.stringUid,u,this._axiosCancelSource.token,this._config.httpRetryConfig||Ne,this.store),ny(u,this._axiosCancelSource.token,this._config.httpRetryConfig||Ne,!0,this.store)]),_.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(u.stringUid," => ").concat(O)),u.uid=O,m.gatewayInfo.uid=O,m.gatewayInfo.res.uid=O;}else m=await ny(u,this._axiosCancelSource.token,this._config.httpRetryConfig||Ne,!0,this.store);if(!this._joinAndNotLeaveYet)throw new w(R.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"))}this.store.requestAPEnd(),setTimeout(()=>{this._configDistribute.startGetConfigDistribute(u,this._axiosCancelSource.token),this._configDistribute.on(Am.UPDATE_BITRATE_LIMIT,O=>{this._p2pChannel.updateBitrateLimit(O);});},0),this._key=n||t;let S=m.gatewayInfo,C=u.uid?u.uid:S.uid;this._joinInfo=Di(Di({},u),{},{cid:S.cid,uid:C,vid:S.vid,apResponse:S.res,uni_lbs_ip:S.uni_lbs_ip,gatewayAddrs:S.gatewayAddrs}),this.store.intUid=C;let A=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new w(R.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));l.onSuccess(A),this._appId=t,this._channelName=u.cname,this._uid=A,this.store.uid=A,setTimeout(()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(Ke()?"beforeunload":"pagehide",this._handleBeforeUnload),this._statsCollector.startUpdateStats();},0);let b=u.stringUid?"string uid: ".concat(u.stringUid,",uid: ").concat(u.uid):"uid: ".concat(this._uid);return _.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(e,",").concat(b)),setTimeout(()=>{_.startUpload();},5e3),this.store.joinEnd(),T=this,q(wo).call(wo,T)||wo.push(T),this._cloudProxyServerMode==="disabled"&&Ot().supportWebCrypto&&v("ENABLE_PRELOAD")&&Tf(this._joinInfo),A}catch(m){let E=Array.isArray(m)?m[0]:m;throw E&&E.code===R.OPERATION_ABORTED?_.warning("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),E):_.error("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),E),E.code!==R.OPERATION_ABORTED&&this._numberOfJoinCount===o&&(this._gateway.state="DISCONNECTED",this._reset()),l.onError(E),E}var T;}_joinGateway(){if(!this._joinInfo||!this._key)throw new w(R.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!(this._joinInfo.cloudProxyServer!=="disabled"||this._joinInfo.proxyServer||!v("JOIN_WITH_FALLBACK_SIGNAL_PROXY"))).then(t=>t).catch(t=>{if(t.code===R.INIT_WEBSOCKET_TIMEOUT)return this._gateway.leave(!0,It.FALLBACK),t;if(t.code===R.INIT_DATACHANNEL_TIMEOUT)return this._gateway.leave(!0,It.FALLBACK),t;throw t}).then(t=>{if(t instanceof w){if(t.code===R.INIT_WEBSOCKET_TIMEOUT){if(_.info("[".concat(this._clientId,"] join timeout, fallback to proxy")),!this._joinInfo||!this._key)throw new w(R.INVALID_OPERATION);this._joinInfo.cloudProxyServer="fallback",this._cloudProxyServerMode="fallback",this.store.cloudProxyServerMode="fallback";let e=v("PROXY_SERVER_TYPE3");if(Array.isArray(e))if(this._joinInfo.apUrl){let i=/^https?:\/\/(.+?)(\/.*)?$/.exec(this._joinInfo.apUrl)[1].split("."),r=i.slice(i.length-2).join(".");e.forEach(o=>{this._joinInfo&&q(o).call(o,r)&&(this._joinInfo.proxyServer=o);}),this._joinInfo.proxyServer||(this._joinInfo.proxyServer=e[0]);}else this._joinInfo.proxyServer=e[0];else this._joinInfo.proxyServer=e;let n=v("LOG_UPLOAD_SERVER").match(/.+:(\d{1,5})$/);return n&&n[1]&&n[1]!=="443"&&_.setProxyServer(this._joinInfo.proxyServer),v("STATS_COLLECTOR_PORT").toString()!=="443"&&et.setProxyServer(this._joinInfo.proxyServer),et.reportApiInvoke(this._sessionId,{name:ke.JOIN_FALLBACK_TO_PROXY,options:[this._joinInfo.proxyServer],tag:ge.TRACER}).onSuccess(),this.safeEmit(yt.JOIN_FALLBACK_TO_PROXY,this._joinInfo.proxyServer),v("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&this._joinInfo.turnServer.servers.forEach(i=>{"forceturn"in i&&(i.forceturn=!0);}),this._gateway.join(this._joinInfo,this._key)}if(_.info("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new w(R.INVALID_OPERATION);return et.reportApiInvoke(this._sessionId,{name:ke.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:ge.TRACER}).onSuccess(),this._joinGateway()}return t}).then(t=>t)}async leave(){_.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(Ke()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(e){let n=wo.indexOf(e);n!==-1&&wo.splice(n,1);}(this),this._statsCollector.stopUpdateStats();let t=await this._leaveMutex.lock();if(this.connectionState==="DISCONNECTED")return _.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void t();await this._gateway.leave(this.connectionState!=="CONNECTED"),_.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),t();}async publish(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!Array.isArray(t)){if(!(t instanceof Ga))return this._publishDataChannel(t);t=[t];}if(t.length===0)throw new w(R.INVALID_PARAMS,"param list is empty");let n=t;if(this._gateway.role==="audience")throw new w(R.INVALID_OPERATION,"audience can not publish stream");for(let r of n){if(!(r instanceof Ga))throw new w(R.INVALID_PARAMS,"parameter is not local track");if(!r._enabled&&e)throw new w(R.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(r.getTrackId()))}_.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(n.map(r=>"".concat(r.getTrackId()," "))));let i=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),e&&n.forEach(r=>{let o=this._configDistribute.getBitrateLimit();r instanceof $t&&o&&r.setBitrateLimit(o.uplink);});try{await this._publishHighStream(n),_.info("[".concat(this._clientId,"] Publish success, id ").concat(n.map(r=>"".concat(r.getTrackId()," "))));}catch(r){throw _.error("[".concat(this._clientId,"] publish error"),r.toString()),r}finally{i();}}async _publishDataChannel(t){zt(t.id,"id",0,65535,!0),Xr(t.ordered,"ordered"),rn(t.metadata,"metadata",0,512),_.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(t.id));let e=await this._publishMutex.lock();try{if(this._p2pChannel.getAllDataChannels().findIndex(i=>i.id===t.id)!==-1)throw new w(R.INVALID_PARAMS,"Invalid id: ".concat(t.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||this._uid===void 0)throw new w(R.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&v("FORCE_TURN")&&!v("TURN_ENABLE_TCP")&&!v("TURN_ENABLE_UDP"))throw new w(R.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");let n=new Nw(t);if(await this._p2pChannel.publishDataChannel([n]),!this._p2pChannel.isP2PDisconnected()){if(typeof n._originDataChannelId!="number")throw _.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new w(R.CREATE_DATACHANNEL_ERROR);try{let i={streamId:t.id,ordered:t.ordered,maxRetransmits:v("DATASTREAM_MAX_RETRANSMITS"),metadata:t.metadata,channelId:n._originDataChannelId};await this._gateway.publishDataChannel(this._uid,i,!0),await n._waitTillOpen();}catch(i){if(i.code!==R.DISCONNECT_P2P)throw i}}return _.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(n.id)),n}catch(n){throw _.error("[".concat(this._clientId,"] publish datachannels error"),n.toString()),n}finally{e();}}async unpublish(t){if(!this._joinInfo||this._uid===void 0)throw new w(R.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let e=[];if(t)if(Array.isArray(t))e=t;else {if(!(t instanceof Ga))return this._unpublishDataChannel([t]);e=[t];}else this.store.useP2P||await this._unpublishDataChannel(),e=this._p2pChannel.getAllTracks(!0);_.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(e.map(i=>"".concat(i.getTrackId()," "))," "));let n=await this._publishMutex.lock();try{if(this._p2pChannel instanceof ti){let i=await this._p2pChannel.unpublish(e);i&&await this._gateway.sendExtensionMessage(ye.UNPUBLISH,{unpubMsg:i},!0);}else {let i=await this._p2pChannel.unpublish(e);i&&await this._gateway.unpublish(i,this._uid),_.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(e.map(r=>"".concat(r.getTrackId()))));}}catch(i){throw _.error("[".concat(this._clientId,"] unpublish error"),i.toString()),i}finally{n&&n();}}async _unpublishDataChannel(t){t!==void 0&&t.length!==0||(t=this._p2pChannel.getAllDataChannels()),_.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(t.map(n=>"".concat(n.id," "))," "));let e=await this._publishMutex.lock();try{let n=await this._p2pChannel.unpublishDataChannel(t);n&&await this._gateway.unpublishDataChannel(n),_.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(t.map(i=>"".concat(i.id))));}catch(n){throw _.error("[".concat(this._clientId,"] unpublish dataChannel error"),n.toString()),n}finally{e&&e();}}async subscribe(t,e,n){if(!(t instanceof Go)){let i=this.remoteUsers.find(r=>r.uid===t);if(!i)throw new w(R.INVALID_REMOTE_USER,"user is not in the channel");t=i;}return e==="datachannel"?this._subscribeDataChannel(t,n):this._subscribe(t,e)}async presubscribe(t,e){if(Ge(e,"mediaType",["audio","video"]),this._p2pChannel instanceof ti)throw new w(R.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new w(R.INVALID_OPERATION,"can't presub when not join");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));let n=e===tt.AUDIO,i=e===tt.VIDEO,r=await this._subscribeMutex.lock();try{let{ssrcId:o,ortc:s,rtxSsrcId:a,cname:c,uint_id:d}=await this._gateway.presubscribe(t,e,!0);if(o==null)throw new w(R.UNEXPECTED_RESPONSE,"no ssrc id");let l=this._users.find(h=>h.uid===t);l||(l=new Go(t,d||t),l._is_pre_created=!0,this._users.push(l)),c&&(l._cname=c),l._uintid||(l._uintid=d||t),n&&(l._audioSSRC=o,l._audio_pre_subscribed=!0,s&&(l._audioOrtc=s)),i&&(l._videoSSRC=o,l._video_pre_subscribed=!0,s&&(l._videoOrtc=s),a!=null&&(l._rtxSsrcId=a)),_.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(o)),await this._p2pChannel.subscribe(l,e,o,a,s);let u=n?l._audioTrack:l._videoTrack;if(!u)throw new w(R.UNEXPECTED_ERROR,"can not find remote track in user");return n&&(l._trust_audio_stream_added_state_=!0,l._audio_added_=!0),i&&(l._trust_video_stream_added_state_=!0,l._video_added_=!0),u}catch(o){throw _.error("[".concat(this._clientId,"] presub user ").concat(t," error"),o),o}finally{r();}}async _subscribeDataChannel(t,e){var n;if(zt(e,"channelId",0,65535,!0),!this._joinInfo)throw new w(R.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find(a=>a===t))throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),new w(R.INVALID_REMOTE_USER,"user is not in the channel");if(!t.hasAudio&&!t.hasVideo&&t._dataChannels.length===0)throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),new w(R.INVALID_REMOTE_USER,"user is not published");let r=(n=t._dataChannels)===null||n===void 0?void 0:n.find(a=>a.id===e);if(!r)throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, remote datachannel is not published")),new w(R.REMOTE_USER_IS_NOT_PUBLISHED);let o=await this._subscribeMutex.lock();_.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: datachannel"));try{let a=await this._p2pChannel.subscribeDataChannel(t,[r]);if(a&&q(a).call(a,r.id))try{var s;if(typeof r._originDataChannelId!="number")throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, cannot get RTCDatachannel")),new w(R.CREATE_DATACHANNEL_ERROR);let c={id:r.id,datachannelId:r._originDataChannelId,ordered:r.ordered,maxRetransmits:r.maxRetransmits,metadata:(s=r.metadata)!==null&&s!==void 0?s:""};await this._gateway.subscribeDataChannel(t.uid,c,!0),await r._waitTillOpen();}catch(c){if(c?.code!==R.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(t,[r]),c;await this._p2pChannel.unsubscribeDataChannel(t,[r]),this._p2pChannel.setPendingRemoteDataChannel(t,r.id);}return _.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: datachannel")),r}finally{o();}}async _p2pSubscribe(t,e,n){if(Ge(e,"mediaType",["audio","video"]),!this._joinInfo)throw new w(R.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(o=>o===t)){let o=new w(R.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),o}if(!t.hasAudio&&!t.hasVideo){let o=new w(R.INVALID_REMOTE_USER,"user is not published");throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),o}if(!n&&(e==="audio"&&!t.hasAudio||e==="video"&&!t.hasVideo)){let o=new w(R.REMOTE_USER_IS_NOT_PUBLISHED);throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),o}let r=await this._subscribeMutex.lock();_.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,e))await this._p2pChannel.unmuteRemote(t,e);else try{let s=e==="audio"?t._audioSSRC:t._videoSSRC,a=e==="audio"?t._audioMid:t._videoMid;this.store.subscribe(t.uid,e,Date.now()),this._p2pChannel instanceof ti&&await this._p2pChannel.subscribe(t,e,s,a);}catch(s){throw s}_.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch(s=>{_.warning("[".concat(this._clientId,"] auto set fallback failed"),s);});let o=e==="audio"?t._audioTrack:t._videoTrack;if(!o)throw new w(R.UNEXPECTED_ERROR,"can not find remote track in user object");return o}catch(o){throw _.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),o),o}finally{r();}}async _subscribe(t,e,n){if(this._p2pChannel instanceof ti)return this._p2pSubscribe(t,e);if(Ge(e,"mediaType",["audio","video"]),!this._joinInfo)throw new w(R.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(d=>d===t)){let d=new w(R.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),d}if(!t.hasAudio&&!t.hasVideo){let d=new w(R.INVALID_REMOTE_USER,"user is not published");throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),d}if(!(n||(e!=="audio"||t.hasAudio&&t._audioSSRC!==void 0)&&(e!=="video"||t.hasVideo&&t._videoSSRC!==void 0))){let d=new w(R.REMOTE_USER_IS_NOT_PUBLISHED);throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),d}let r=e==="audio"?t._audioSSRC:t._videoSSRC,o=e==="audio"?t._audioOrtc:t._videoOrtc,s=e==="video"?t._rtxSsrcId:void 0,a={stream_type:e==="audio"?tt.AUDIO:tt.VIDEO,ssrcId:r},c=await this._subscribeMutex.lock();_.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,e))await this._p2pChannel.unmuteRemote(t,e);else try{let l=e==="audio"?t._audioSSRC:t._videoSSRC;l!==void 0&&l!==r&&(r=l,o=e==="audio"?t._audioOrtc:t._videoOrtc,s=e==="video"?t._rtxSsrcId:void 0,a={stream_type:e==="audio"?tt.AUDIO:tt.VIDEO,ssrcId:r}),fn.markSubscribeStart(this.store.clientId,r),this.store.subscribe(t.uid,e,Date.now()),await this._p2pChannel.subscribe(t,e,r,s,o);try{await this._gateway.subscribe(t.uid,a,!0);}catch(u){if(u?.code!==R.WS_ABORT)throw await this._p2pChannel.unsubscribe(t,e),u;await this._p2pChannel.unsubscribe(t,e,!0),this._p2pChannel.setPendingRemoteMedia(t,e);}this.store.subscribe(t.uid,e,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,t,e);}catch(l){throw this._p2pChannel.reportSubscribeEvent(!1,l?.code,t,e),l}_.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch(l=>{_.warning("[".concat(this._clientId,"] auto set fallback failed"),l);});let d=e==="audio"?t._audioTrack:t._videoTrack;if(!d)throw new w(R.UNEXPECTED_ERROR,"can not find remote track in user object");return d}catch(d){throw _.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),d),d}finally{c();}}async massSubscribe(t){if(Qr(t,"subscribeList"),!this._joinInfo)throw new w(R.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));let e=Date.now(),n=new Map,i=await this._subscribeMutex.lock();_.info("[".concat(this._clientId,"]start massSubscribe user ").concat(t.map(a=>{let{user:c,mediaType:d}=a;return "user: ".concat(c?.uid,", mediaType: ").concat(d)}).join("; ")));let r=(t=[...t]).map(a=>{let{user:c,mediaType:d}=a;return {user:c,mediaType:d}}),o=await this._p2pChannel.globalLock();try{var s;for(let c=t.length-1;c>=0;c--){let d=t[c],{user:l,mediaType:u}=d;if(Ge(u,"mediaType",["audio","video"]),!l){let m=new w(R.INVALID_PARAMS,"user property does not exist in subscribeList item");throw _.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),m}if(!this._users.find(m=>m===l)){let m=new w(R.INVALID_REMOTE_USER,"user is not in the channel");_.error("[".concat(this._clientId,"] can not massSubscribe ").concat(l.uid,", this user is not in the channel")),r[c].error=m,t.splice(c,1);continue}if(u==="audio"&&(!l.hasAudio||l._audioSSRC===void 0)||u==="video"&&(!l.hasVideo||l._videoSSRC===void 0)){let m=new w(R.REMOTE_USER_IS_NOT_PUBLISHED);_.error("[".concat(this._clientId,"] can not subscribe ").concat(l.uid," with mediaType ").concat(u,", remote user is not published")),r[c].error=m,t.splice(c,1);continue}let p=qe.Video|qe.LwoVideo,T=n.get(l);if(T){if(u==="video"?T&p:T&qe.Audio){t.splice(c,1),_.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(l.uid,", mediaType:").concat(u," twice"));continue}n.set(l,T|(u==="video"?p:qe.Audio));}else n.set(l,u==="video"?p:qe.Audio);}for(let c=t.length-1;c>=0;c--){let d=t[c],{user:l,mediaType:u}=d,h=qe.Video|qe.LwoVideo;if(this._p2pChannel.hasRemoteMedia(l,u)){await this._p2pChannel.unmuteRemoteNoLock(l,u);let p=n.get(l);n.set(l,u==="video"?p^h:p^qe.Audio),t.splice(c,1);}}this.store.massSubscribe(t.map(c=>({userId:c.user.uid,type:c.mediaType})),e);let a=rr(s=Array.from(n.entries())).call(s,(c,d)=>{let[l,u]=d;if(u===0)return c;let h={stream_id:l.uid,stream_type:u};return u&qe.Audio&&(h.audio_ssrc=l._audioSSRC),u&qe.Video&&(h.video_ssrc=l._videoSSRC),c.push(h),c},[]);try{t.length>0&&await this._p2pChannel.massSubscribeNoLock(t.map(d=>{let{user:l,mediaType:u}=d;return {user:l,mediaType:u,ssrcId:u===tt.VIDEO?l._videoSSRC:l._audioSSRC,rtxSsrcId:u===tt.VIDEO?l._rtxSsrcId:void 0}}));let c=new Map;if(a.length>0){let d=await this._gateway.subscribeAll(a,!0);(d?.users||[]).forEach(l=>{let{stream_id:u,video_error_code:h,audio_error_code:p,error_code:T}=l;(h||p||T)&&c.set(u,{video_error_code:h,audio_error_code:p,error_code:T});});}if(Array.from(c.entries()).length>0){let d=[];Array.from(c.entries()).forEach(l=>{let[u,h]=l,p=this.remoteUsers.find(T=>T.uid===u);if(p){let T;h.error_code||h.video_error_code&&h.audio_error_code?T=void 0:h.video_error_code?T=tt.VIDEO:h.audio_error_code&&(T=tt.AUDIO),d.push({user:p,mediaType:T});}}),d.length>0&&await this._p2pChannel.massUnsubscribeNoLock(d);}for(let d of r){let l=c.get(d.user.uid);if(l){let u=l.error_code||d.mediaType==="audio"&&l.audio_error_code||d.mediaType==="video"&&l.video_error_code;if(u){let h=gs(u);_.error("user:".concat(d.user.uid," mediaType:").concat(d.mediaType," has massSubscribe error ").concat(h.desc)),d.error=new w(R.SUBSCRIBE_FAILED,"code ".concat(u,": ").concat(h.desc));}}d.error||(d.mediaType==="video"?d.track=d.user.videoTrack:d.track=d.user.audioTrack);}return this.store.massSubscribe(r.filter(d=>!d.error).map(d=>({userId:d.user.uid,type:d.mediaType})),void 0,Date.now()),r.forEach(d=>{var l;et.subscribe(this.store.sessionId,{succ:!!d.error,ec:((l=d.error)===null||l===void 0?void 0:l.code)||null,video:d.mediaType===tt.VIDEO,audio:d.mediaType===tt.AUDIO,peerid:d.user.uid,subscribeRequestid:d.mediaType===tt.VIDEO?d.user._videoSSRC:d.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-e)},!0);}),_.info("[".concat(this._clientId,"] massSubscribe success ").concat(t.map(d=>{let{user:l,mediaType:u}=d;return "user: ".concat(l?.uid,", mediaType: ").concat(u)}).join("; "))),r}catch(c){throw await this._p2pChannel.massUnsubscribeNoLock(t),c}}finally{o(),i();}}async unsubscribe(t,e,n){if(!(t instanceof Go)){let o=this.remoteUsers.find(s=>s.uid===t);if(!o)throw new w(R.INVALID_REMOTE_USER,"user is not in the channel");t=o;}if(e||this.store.useP2P){if(e==="datachannel")return this._unsubscribeDataChannel(t,n)}else await this._unsubscribeDataChannel(t,n);if(e&&Ge(e,"mediaType",["audio","video"]),!this._joinInfo)throw new w(R.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find(o=>o===t)){let o=new w(R.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),o}_.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: ").concat(e));let r=await this._subscribeMutex.lock();try{if(this._p2pChannel instanceof ti)await this._p2pChannel.unsubscribe(t,e);else {let o=await this._p2pChannel.unsubscribe(t,e);o&&await this._gateway.unsubscribe(o,t.uid),e&&e!=="audio"||(t._audio_pre_subscribed=!1),e&&e!=="video"||(t._video_pre_subscribed=!1),t._is_pre_created&&ql(this._users,t),_.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(t.uid,", mediaType: ").concat(e));}}catch(o){if(o.code===R.DISCONNECT_P2P)return void _.warning("disconnecting p2p, abort unsubscribe request.");throw _.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),o.toString()),o}finally{r();}}async _unsubscribeDataChannel(t,e){if(e&&zt(e,"id",0,65535,!0),!this._joinInfo)throw new w(R.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find(r=>r===t)){let r=new w(R.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),r}let i;if(typeof e=="number"){let r=t._dataChannels.find(o=>o.id===e);r&&(i=[r]);}else i=t._dataChannels;if(i===void 0){let r=new w(R.REMOTE_USER_IS_NOT_PUBLISHED);throw _.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid," with channelId ").concat(e,", remote datachannel is not published")),r}_.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(i.map(r=>r.id)));try{let r=await this._p2pChannel.unsubscribeDataChannel(t,i);r&&await this._gateway.unsubscribeDataChannel(r,t.uid),_.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(r));}catch(r){if(r.code===R.DISCONNECT_P2P)return void _.warning("disconnecting p2p, abort unsubscribe request.");throw _.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),r.toString()),r}}async massUnsubscribe(t){if(Qr(t,"unsubscribeList"),!this._joinInfo)throw new w(R.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");_.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(t.map(n=>{let{user:i,mediaType:r}=n;return "user: ".concat(i?.uid,", mediaType: ").concat(r,";")}).join())),t=[...t];let e=new Map;for(let n=t.length-1;n>=0;n--){let{user:i,mediaType:r}=t[n];if(!i){let a=new w(R.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw _.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),a}if(Ge(r,"mediaType",["video","audio",void 0]),!this._users.find(a=>a===i)){_.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(i.uid,", user is not in the channel")),t.splice(n,1);continue}let s=qe.Video|qe.LwoVideo;if(e.has(i)){let a=e.get(i),c;switch(r){case"video":c=a&s;break;case"audio":c=a&qe.Audio;break;default:c=a&(qe.Audio|s);}if(c){_.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(i.uid,",mediaType:").concat(r," twice.")),t.splice(n,1);continue}r?r==="audio"?e.set(i,a|qe.Audio):r==="video"&&e.set(i,a|s):e.set(i,a|qe.Audio|s);}else r?r==="audio"?e.set(i,qe.Audio):r==="video"&&e.set(i,s):e.set(i,qe.Audio|s);}try{let n=await this._p2pChannel.massUnsubscribe(t);n&&await this._gateway.massUnsubscribe(n),_.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(t.map(i=>{let{user:r,mediaType:o}=i;return "user: ".concat(r?.uid,", mediaType: ").concat(o,";")}).join()));}catch(n){if(n.code===R.DISCONNECT_P2P)return void _.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw _.error("[".concat(this._clientId,"] massUnsubscribe error"),n.toString()),n}}async setLowStreamParameter(t){((function(n){if(!n)throw new D(R.INVALID_PARAMS);fe(n.width)||om(n.width,"streamParameter.width"),fe(n.height)||om(n.height,"streamParameter.height"),fe(n.framerate)||om(n.framerate,"streamParameter.framerate"),fe(n.bitrate)||zt(n.bitrate,"streamParameter.bitrate");}))(t),(!t.width&&t.height||t.width&&!t.height)&&_.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),_.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(t));let e=this._configDistribute.getLowStreamConfigDistribute();if(e&&e.bitrate&&t.bitrate&&e.bitrate<t.bitrate&&(t.bitrate=e.bitrate),this._lowStreamParameter=t,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(t,F.LocalVideoLowTrack)}async enableDualStream(){if(!Ot().supportDualStream)throw et.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new w(R.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new w(R.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream();}catch(t){throw et.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),t}this._isDualStreamEnabled=!0,et.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),_.info("[".concat(this._clientId,"] enable dual stream"));}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new w(R.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(F.LocalVideoLowTrack))try{let t=await this._p2pChannel.unpublishLowStream();t&&await this._gateway.unpublish(t,this._joinInfo.stringUid||this._joinInfo.uid);}catch(t){throw et.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),t}this._isDualStreamEnabled=!1,et.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),_.info("[".concat(this._clientId,"] disable dual stream"));}}async setClientRole(t,e){if(function(n){Ge(n,"role",["audience","host"]);}(t),e&&sI(e),this.mode==="rtc"||this.mode==="p2p")throw _.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new w(R.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(e&&e.level&&t==="host")throw new w(R.INVALID_OPERATION,"host mode can not set audience latency level");if(t==="audience"&&this._p2pChannel.hasLocalMedia())throw new w(R.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(t,e),this._config.role=t,_.info("[".concat(this._clientId,"] set client role to ").concat(t,", level: ").concat(e&&e.level));}getRemoteInboundOffset(){var t;let e=(t=this._p2pChannel.getStats())===null||t===void 0?void 0:t.audioSend[0];if(!e||!e.timestamp)return 0;let n=e.timestamp-Date.now();return Math.abs(n)>1e3+e.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?n:0}getNtpWallTimeInMs(){return document.visibilityState==="visible"&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(t,e){if(rn(t,"proxyServer"),!e){if(this.connectionState!=="DISCONNECTED")throw new w(R.INVALID_OPERATION,"Set proxy server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new w(R.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=t,et.setProxyServer(this._proxyServer),_.setProxyServer(this._proxyServer),_.info("[".concat(this._clientId,"] Set proxy server ").concat(e?"by initialize call":""," success."));}setTurnServer(t,e){if(Array.isArray(t)||(t=[t]),!e){if(this.connectionState!=="DISCONNECTED")throw new w(R.INVALID_OPERATION,"Set turn server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new w(R.INVALID_OPERATION,"You have already set the proxy")}if(_a(t))return this._turnServer={servers:t,mode:"original-manual"},void _.info("[".concat(this._clientId,"] Set original turnserver ").concat(e?"by initialize call":""," success: ").concat(t.map(n=>n.urls).join(","),"."));t.forEach(n=>oI(n)),this._turnServer={servers:t,mode:"manual"},_.info("[".concat(this._clientId,"] Set turnserver ").concat(e?"by initialize call":""," success."));}setLicense(t){if(this.connectionState!=="DISCONNECTED")throw new w(R.INVALID_OPERATION,"you should set license before join channel");if(rn(t,"license",32,32),!/^[A-Za-z\d]+$/.test(t))throw new w(R.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=t,_.info("[".concat(this._clientId,"] set license success"),t);}startProxyServer(t){if(this.connectionState!=="DISCONNECTED")throw new w(R.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||this._turnServer.mode==="manual"||this._useLocalAccessPoint)throw new w(R.INVALID_OPERATION,"You have already set the proxy");let e=[3,4,5],n;switch(t===void 0&&(t=3),t){case 1:case 2:throw new w(R.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:n="proxy3";break;case 4:n="proxy4";break;case 5:n="proxy5";break;default:throw new w(R.INVALID_PARAMS,"proxy server mode must be ".concat(e.join("|")))}this._cloudProxyServerMode=n,this.store.cloudProxyServerMode=n,_.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode);}stopProxyServer(){if(this.connectionState!=="DISCONNECTED")throw new w(R.INVALID_OPERATION,"Stop proxy server after leave channel");et.setProxyServer(),_.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",_.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]};}setLocalAccessPointsV2(t){if(!t.accessPoints)throw new w(R.INVALID_PARAMS,"accessPoints is required.");Qr(t.accessPoints.serverList,"accessPoints.serverList"),rn(t.accessPoints.domain,"accessPoints.domain");let e=(h,p)=>{zt(h,p,0,65535,!0);},n=443;if(t.accessPoints.port&&(e(t.accessPoints.port,"accessPoints.port"),n=t.accessPoints.port),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new w(R.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");v("CLOSE_AFB_FOR_LOCAL_AP")&&(Jt("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),Jt("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));let i=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,r=t.accessPoints.domain,o=t.accessPoints.serverList.map(h=>i.test(h)?"".concat(h.replace(/\./g,"-"),".").concat(r):h),s=o.map(h=>"".concat(h,":").concat(n));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,Jt("WEBCS_DOMAIN",s),Jt("WEBCS_DOMAIN_BACKUP_LIST",s),Jt("GATEWAY_DOMAINS",[r]),t.report&&t.report.hostname&&Array.isArray(t.report.hostname)&&t.report.hostname.length?(Qr(t.report.hostname,"report.hostname"),Jt("EVENT_REPORT_DOMAIN",t.report.hostname[0]),Jt("EVENT_REPORT_BACKUP_DOMAIN",t.report.hostname[1]||t.report.hostname[0])):(Jt("EVENT_REPORT_DOMAIN",o[0]),Jt("EVENT_REPORT_BACKUP_DOMAIN",o[1]||o[0]));let a=6443;t.report&&t.report.port&&(e(t.report.port,"report.port"),a=t.report.port),Jt("STATS_COLLECTOR_PORT",a),t.report?Jt("ENABLE_EVENT_REPORT",!0):Jt("ENABLE_EVENT_REPORT",!1);let c="";t.log&&t.log.hostname&&Array.isArray(t.log.hostname)&&t.log.hostname.length?(Qr(t.log.hostname,"log.hostname"),c=t.log.hostname[0]):c=o[0];let d=6444;t.log&&t.log.port&&(e(t.log.port,"log.port"),d=t.log.port),Jt("LOG_UPLOAD_SERVER","".concat(c,":").concat(d));let l=[];t.cds&&t.cds.hostname&&Array.isArray(t.cds.hostname)&&t.cds.hostname.length?(Qr(t.cds.hostname,"cds.hostname"),l=t.cds.hostname):l=o;let u=443;t.cds&&t.cds.port&&(e(t.cds.port,"cds.port"),u=t.cds.port),Jt("CDS_AP",l.map(h=>"".concat(h,":").concat(u))),t.cds?Jt("ENABLE_CONFIG_DISTRIBUTE",!0):Jt("ENABLE_CONFIG_DISTRIBUTE",!1),_.info("set local access point v2 success");}setLocalAccessPoints(t,e){if(Qr(t,"serverList"),rn(e,"domain"),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new w(R.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");let n=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;t=t.map(i=>n.test(i)?"".concat(i.replace(/\./g,"-"),".").concat(e):i),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,Jt("WEBCS_DOMAIN",t),Jt("WEBCS_DOMAIN_BACKUP_LIST",t),Jt("GATEWAY_DOMAINS",[e]),Jt("EVENT_REPORT_DOMAIN",t[0]),Jt("EVENT_REPORT_BACKUP_DOMAIN",t[1]||t[0]),Jt("LOG_UPLOAD_SERVER","".concat(t[0],":6444")),_.info("[".concat(this._clientId,"] set local access point success"));}async setRemoteDefaultVideoStreamType(t){if(Ge(t,"streamType",[0,1]),this._remoteDefaultVideoStreamType=t,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(t),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType;}catch(e){throw _.error("[".concat(this._clientId,"] set default remote video stream type error"),e.toString()),e}else _.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(t));}async setRemoteVideoStreamType(t,e){Ge(e,"streamType",[0,1]);try{await this._gateway.setRemoteVideoStreamType(t,e),setTimeout(()=>{let n=this._users.find(i=>i.uid===t);n&&n.videoTrack&&n.videoTrack.updateMediaStreamTrackResolution();},2e3);}catch(n){throw _.error("[".concat(this._clientId,"] set remote video stream type error"),n.toString()),n}_.info("[".concat(this._clientId,"] set remote ").concat(t," video stream type to ").concat(e)),this._remoteStreamTypeCacheMap.set(t,e);}async setStreamFallbackOption(t,e){Ge(e,"fallbackType",[0,1,2]);try{await this._gateway.setStreamFallbackOption(t,e);}catch(n){throw _.error("[".concat(this._clientId,"] set stream fallback option"),n.toString()),n}_.info("[".concat(this._clientId,"] set remote ").concat(t," stream fallback type to ").concat(e)),this._streamFallbackTypeCacheMap.set(t,e);}setEncryptionConfig(t,e,n,i){((function(o){Ge(o,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"]);}))(t),rn(e,"secret");let r=["aes-128-gcm2","aes-256-gcm2"];if(q(r).call(r,t)){if(!n||!(n instanceof Uint8Array&&n.length===32))throw new w(R.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(n)throw new w(R.INVALID_PARAMS,"current encrypt mode does not need salt");if(i){if(Xr(i,"encryptDataStream"),!q(r).call(r,t))throw new w(R.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0;}new RegExp(`^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'"|{}\\[\\]])(?=.{8,})`).test(e)||_.warning(`The secret is not strong:
      The secret must contain at least 1 lowercase alphabetical character,
      The secret must contain at least 1 uppercase alphabetical character,
      The secret must contain at least 1 numeric character,
      The secret must contain at least one special character,
      The secret must be eight characters or longer.
      `),this._encryptionMode=t,this._encryptionSecret=e,n&&(this._encryptionSalt=Ao(n));}async renewToken(t){if(rn(t,"token",1,2047),!this._key||!this._joinInfo)throw new w(R.INVALID_OPERATION,"renewToken should not be called before user join");let e=this._key;this._key=t,this._joinInfo&&(this._joinInfo.token=t);let n=await this._renewTokenMutex.lock();try{if(v("USE_NEW_TOKEN")){_.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));let i=await $j(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Ne);_.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:t,ticket:i});}else _.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:t});_.debug("[".concat(this._clientId,"] renewToken success"));}catch(i){throw this._key=e,this._joinInfo.token=e,_.error("[".concat(this._clientId,"] renewToken failed"),i.toString()),i}finally{n();}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?_.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval(()=>{let t=this._p2pChannel.getAudioLevels();this.safeEmit(yt.VOLUME_INDICATOR,t);},v("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3);}getRTCStats(){let t=this._statsCollector.getRTCStats(),e=this._gateway.getInChannelInfo();return t.Duration=Math.round(e.duration/1e3),t}async startLiveStreaming(t,e){if(!e){if(this.codec!=="h264")throw new w(R.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new w(R.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(t)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(t))throw new w(R.LIVE_STREAMING_TASK_CONFLICT);let n=e?$e.TRANSCODE:$e.RAW;return this._createLiveStreamingClient(n).startLiveStreamingTask(t,n)}setLiveTranscoding(t){return this._createLiveStreamingClient($e.TRANSCODE).setTranscodingConfig(t)}async stopLiveStreaming(t){let e=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter(n=>n&&n.hasUrl(t));if(!e.length)throw new w(R.INVALID_PARAMS,"can not find live streaming url to stop");await K.all(e.map(n=>n&&n.stopLiveStreamingTask(t)));}async addInjectStreamUrl(t,e){if(!this._joinInfo)throw new w(R.INVALID_OPERATION,"can not addInjectStreamUrl, no joininfo");let n=this._createLiveStreamingClient($e.INJECT);n.setInjectStreamConfig(e,0),await n.startLiveStreamingTask(t,$e.INJECT);}async removeInjectStreamUrl(){var t;let e=this._createLiveStreamingClient($e.INJECT),n=Array.from(cr(t=e.streamingTasks).call(t)).find(i=>i.mode===$e.INJECT);if(!this._joinInfo||!n)throw new w(R.INVALID_OPERATION,"can remove addInjectStreamUrl, no joininfo or inject task");await e.stopLiveStreamingTask(n.url);}async startChannelMediaRelay(t){RO(t),await this._createChannelMediaRelayClient().startChannelMediaRelay(t);}async updateChannelMediaRelay(t){RO(t),await this._createChannelMediaRelayClient().updateChannelMediaRelay(t);}async stopChannelMediaRelay(){await this._createChannelMediaRelayClient().stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0);}async sendStreamMessage(t){var e;let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!this._joinInfo)throw new w(R.INVALID_OPERATION,"can not send data stream, not joined");if((typeof t=="string"||t instanceof Uint8Array)&&(t={payload:t}),typeof t.payload=="string"){let r=new TextEncoder;t.payload=r.encode(t.payload);}let i=!1;if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&q(e=["aes-128-gcm2","aes-256-gcm2"]).call(e,this._encryptionMode)&&(i=!0,t.payload=await async function(r,o,s){var a;let c=rr(a=Array.from(s)).call(a,(m,E)=>m+E,0),d={serverTs:0,seq:UB++,length:s.length,checkSum:c},l=new Uint8Array(_I(c,2)),u=new ArrayBuffer(ga),h=new DataView(u);h.setUint32(0,d.serverTs),h.setUint16(4,d.seq),h.setUint16(6,d.length),h.setUint16(8,d.checkSum);let p=16-s.length%16;s=dI(s,new Uint8Array(p));let T=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:r,tagLength:fI,additionalData:l},o,s);return dI(new Uint8Array(u),new Uint8Array(T))}(this._encryptDataStreamIv,this._encryptDataStreamKey,t.payload)),new Blob([t.payload]).size>1024)throw new w(R.INVALID_PARAMS,i?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request(it.DATA_STREAM,{payload:Ao(t.payload),syncWithAudio:t.syncWithAudio,sendTs:Date.now()-vH},!n)}sendMetadata(t){if(!this._joinInfo)throw new w(R.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([t]).size>1024)throw new w(R.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(it.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:Ao(t)})}async sendCustomReportMessage(t){if(Array.isArray(t)||(t=[t]),t.forEach(VB),!this._joinInfo)throw new w(R.INVALID_OPERATION,"can not send custom report, not joined");await et.sendCustomReportMessage(this._joinInfo.sid,t);}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(t,e){Ge(e.spatialLayer,"spatialLayer",[0,1,2,3]),Ge(e.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(t,e);}catch(n){throw _.error("[".concat(this._clientId,"] pick SVC layer failed"),n.toString()),n}}async setRTMConfig(t){let{apRTM:e=!1,rtmFlag:n}=t;if(Xr(e,"apRTM"),zt(n,"rtmFlag",0),this._rtmConfig.apRTM=e,this._rtmConfig.rtmFlag=n,_.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(t)," in ").concat(this.connectionState," state")),(this.connectionState==="CONNECTED"||this.connectionState==="RECONNECTING")&&this._joinInfo)return this._joinInfo.apRTM=e,this._joinInfo.rtmFlag=n,this._gateway.setRTM2Flag(n)}_reset(){if(_.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=Mn.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo&&E0(this._joinInfo),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach(t=>{t._audioTrack&&t._audioTrack._destroy(),t._videoTrack&&t._videoTrack._destroy(),t._dataChannels&&(t._dataChannels.forEach(e=>e._close()),t._dataChannels.length=0);}),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),this._cloudProxyServerMode==="fallback"&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new Qe("client-publish"),this._subscribeMutex=new Qe("client-subscribe"),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._injectStreamingClient&&(this._injectStreamingClient.terminate(),this._injectStreamingClient.removeAllListeners(),this._injectStreamingClient=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0;}catch{}if(this._moderation)try{this.setImageModeration(!1);}catch{}}_startSession(t,e){var n;let i=t||jc();t?_.debug("[".concat(this._clientId,"] new Session ").concat(i)):_.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(i));let r=t?"":this._sessionId||"";this._sessionId=i,this.store.sessionId=i;let o={lts:new Date().getTime(),mode:this.mode,buildFormat:1,stringUid:e?.stringUid||((n=this._joinInfo)===null||n===void 0?void 0:n.stringUid),channelProfile:this.mode==="live"?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:r,clientRole:this.role==="audience"?2:1};e?et.sessionInit(this._sessionId,Di({cname:e.channel,appid:e.appId,preload:e.preload},o)):this._joinInfo?et.sessionInit(this._sessionId,Di({cname:this._joinInfo.cname,appid:this._joinInfo.appId,preload:!!this._joinInfo.recoverPreloadCache},o)):this._gateway.joinInfo&&et.sessionInit(this._sessionId,Di({cname:this._gateway.joinInfo.cname,appid:this._gateway.joinInfo.appId},o)),this._joinInfo&&(this._joinInfo.sid=i),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=i);}async _publishHighStream(t){if(!this._joinInfo||this._uid===void 0)throw new w(R.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&v("FORCE_TURN")&&!v("TURN_ENABLE_TCP")&&!v("TURN_ENABLE_UDP"))throw new w(R.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");_.debug("[".concat(this._clientId,"] publish high stream"));try{let n=await this._p2pChannel.publish(t,this._isDualStreamEnabled,this._lowStreamParameter);if(this._p2pChannel instanceof ti){let i=(await n.next()).value;if(i){try{await this._gateway.sendExtensionMessage(ye.PUBLISH,i,!0);}catch(r){throw n.throw(r),r}await n.next();}this._p2pChannel.reportPublishEvent(!0,null);}else {let i=(await n.next()).value;if(i){var e;let r;try{r=await this._gateway.publish(this._uid,i,!0);}catch(o){if(o.code!==R.DISCONNECT_P2P)throw n.throw(o),o}await n.next(((e=r)===null||e===void 0?void 0:e.ortc)||[]);}this._p2pChannel.reportPublishEvent(!0,null);for(let r of t)r instanceof $t&&r._encoderConfig&&this._gateway.setVideoProfile(r._encoderConfig),!r.muted&&r.enabled||await this._p2pChannel.muteLocalTrack(r);}}catch(n){if(this._p2pChannel.reportPublishEvent(!1,n?.code,t),n?.code===R.WS_ABORT)return;throw n}}async _publishLowStream(){if(!this._joinInfo||this._uid===void 0)throw new w(R.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));_.debug("[".concat(this._clientId,"] publish low stream"));let t=this._configDistribute.getLowStreamConfigDistribute();t&&t.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&t.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=t.bitrate));try{let n=await this._p2pChannel.publishLowStream(this._lowStreamParameter),i=(await n.next()).value;if(i){var e;let r;try{r=await this._gateway.publish(this._uid,i,!0);}catch(o){if(o.code!==R.DISCONNECT_P2P)throw n.throw(o),o}n.next(((e=r)===null||e===void 0?void 0:e.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0);}}catch(n){if(this._p2pChannel.reportPublishEvent(!1,n?.code,void 0,!0),n?.code===R.WS_ABORT)return;throw n}}_createLiveStreamingClient(t){if(!this._joinInfo||!this._appId)return new w(R.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();let e=()=>new Q3(this._joinInfo,this._config.websocketRetryConfig||Ne,this._config.httpRetryConfig||Ne),n=i=>{i.onLiveStreamError=(r,o)=>{et.reportApiInvoke(this._sessionId,{name:ke.ON_LIVE_STREAM_ERROR,options:[r,o],tag:ge.TRACER}).onSuccess(),this.safeEmit(yt.LIVE_STREAMING_ERROR,r,o);},i.onLiveStreamWarning=(r,o)=>{et.reportApiInvoke(this._sessionId,{name:ke.ON_LIVE_STREAM_WARNING,options:[r,o],tag:ge.TRACER}).onSuccess(),this.safeEmit(yt.LIVE_STREAMING_WARNING,r,o);},i.on(ru.REQUEST_WORKER_MANAGER_LIST,(r,o,s)=>{if(!this._joinInfo)return s(new w(R.INVALID_OPERATION,"can not find join info to get worker manager"));sy(r,this._joinInfo,this._axiosCancelSource.token,Ne).then(o).catch(s);});};switch(t){case $e.RAW:return this._liveRawStreamingClient||(this._liveRawStreamingClient=e(),n(this._liveRawStreamingClient)),this._liveRawStreamingClient;case $e.TRANSCODE:return this._liveTranscodeStreamingClient||(this._liveTranscodeStreamingClient=e(),n(this._liveTranscodeStreamingClient)),this._liveTranscodeStreamingClient;case $e.INJECT:return this._injectStreamingClient||(this._injectStreamingClient=e(),this._injectStreamingClient.on(ru.REQUEST_WORKER_MANAGER_LIST,(i,r,o)=>{if(!this._joinInfo)return o(new w(R.INVALID_OPERATION,"can not find join info to get worker manager"));sy(i,this._joinInfo,this._axiosCancelSource.token,Ne).then(r).catch(o);}),this._injectStreamingClient.onInjectStatusChange=(i,r,o)=>{this.safeEmit(yt.INJECT_STREAM_STATUS,i,r,o);}),this._injectStreamingClient}}_createChannelMediaRelayClient(){if(!this._joinInfo)return new w(R.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){let{sendResolutionWidth:t,sendResolutionHeight:e}=this.getLocalVideoStats(),n={width:t,height:e};this._channelMediaRelayClient=new $3(this._joinInfo,this._clientId,this._config.websocketRetryConfig||Ne,this._config.httpRetryConfig||Ne,n),this._channelMediaRelayClient.on("state",i=>{i===Gn.RELAY_STATE_FAILURE&&this._channelMediaRelayClient&&this._channelMediaRelayClient.dispose(),this.safeEmit(yt.CHANNEL_MEDIA_RELAY_STATE,i);}),this._channelMediaRelayClient.on("event",i=>{this.safeEmit(yt.CHANNEL_MEDIA_RELAY_EVENT,i);}),this._statsCollector.onStatsChanged=(i,r)=>{var o;i==="resolution"&&((o=this._channelMediaRelayClient)===null||o===void 0||o.setVideoProfile(r));};}return this._channelMediaRelayClient}_handleUpdateDataChannel(t,e){let{added:n,deleted:i}=t,r=[];Array.isArray(n)&&n.length>0&&n.forEach(o=>{let{uid:s,stream_id:a,ordered:c,max_retrans_times:d,metadata:l}=o,u=this._users.find(h=>h._uintid===s);if(!u)return void _.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));if(_.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(s)),q(r).call(r,u)||r.push(u),u._uintid||(u._uintid=s),u._dataChannels.findIndex(h=>h.id===o.stream_id)===-1){let h={id:a,ordered:!!c,maxRetransmits:d,metadata:l},p=new w3(h);u._dataChannels.push(p),_.info("[".concat(this._clientId,"] remote user ").concat(u.uid," published datachannel")),e||this.safeEmit(yt.USER_PUBLISHED,u,"datachannel",h);}this._p2pChannel.hasPendingRemoteDataChannel(u,o.stream_id)&&(_.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(u.uid," after reconnect.")),this._subscribeDataChannel(u,o.stream_id).catch(h=>{_.error("[".concat(this._clientId,"] resubscribe datachannel error"),h.toString());}));}),e&&(this.safeEmit(yt.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(i)&&i.length>0&&i.forEach(o=>{let{uid:s,stream_id:a}=o,c=this._users.find(l=>l._uintid===s);if(!c)return void _.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));let d=c._dataChannels.find(l=>l.id===o.stream_id);d&&(_.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(s)),this._p2pChannel.unsubscribeDataChannel(c,[d]).then(l=>{if(c._dataChannels=c._dataChannels.filter(u=>u!==d),l)return this._gateway.unsubscribeDataChannel(l,c.uid)}),_.info("[".concat(this._clientId,"] remote user ").concat(s," unpublished datachannel ,id:").concat(d.id)),this.safeEmit(yt.USER_UNPUBLISHED,c,"datachannel",d._config));});}_handleRemoveDataChannels(t){let e=this._users.find(n=>n.uid===t.uid);if(e){if(e._dataChannels!==void 0&&e._dataChannels.length>0){_.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(t.uid));let n=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(e.uid," unpublished datachannel")),e._dataChannels.forEach(i=>{this.safeEmit(yt.USER_UNPUBLISHED,e,"datachannel",i._config);});};this._p2pChannel.unsubscribeDataChannel(e,e._dataChannels).then(i=>{if(i)return this._gateway.unsubscribeDataChannel(i,e.uid)}),n();}}else _.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"));}_handleGatewayEvents(){this._gateway.on(Ie.DISCONNECT_P2P,async()=>{await this._p2pChannel.disconnectForReconnect();}),this._gateway.on(Ie.CONNECTION_STATE_CHANGE,(t,e,n)=>{var i;if(n===It.FALLBACK)return;let r=()=>{this.safeEmit(yt.CONNECTION_STATE_CHANGE,t,e,n);};if(et.reportApiInvoke(this._sessionId||((i=this._gateway.joinInfo)===null||i===void 0?void 0:i.sid)||null,{name:ke.CONNECTION_STATE_CHANGE,options:[t,e,n],tag:ge.TRACER}).onSuccess(JSON.stringify({cur:t,prev:e,reason:n})),_.info("[".concat(this._clientId,"] connection state change: ").concat(e," -> ").concat(t)),t==="DISCONNECTED")return this._reset(),void r();if(t==="RECONNECTING")this._users.forEach(s=>{s._trust_in_room_=!1,s._trust_audio_enabled_state_=!1,s._trust_video_enabled_state_=!1,s._trust_audio_mute_state_=!1,s._trust_video_mute_state_=!1,s._trust_audio_stream_added_state_=!1,s._trust_video_stream_added_state_=!1,s._is_pre_created||(s._audio_pre_subscribed||(s._audioSSRC=void 0,s._audioOrtc=void 0),s._video_pre_subscribed||(s._videoSSRC=void 0,s._videoOrtc=void 0,s._rtxSsrcId=void 0),s._cname=void 0);}),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if(t==="CONNECTED"){var o;this._streamFallbackTypeCacheMap.forEach((s,a)=>{this._gateway.setStreamFallbackOption(a,s).catch(c=>{_.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),c);});}),this._remoteStreamTypeCacheMap.forEach((s,a)=>{this._gateway.setRemoteVideoStreamType(a,s).catch(c=>{_.warning("[".concat(this._clientId,"] auto set remote stream type failed"),c);});}),this._remoteDefaultVideoStreamType!==void 0&&((o=this._joinInfo)===null||o===void 0?void 0:o.defaultVideoStream)===void 0&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then(()=>{_.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"));}).catch(s=>{_.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(s));}),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._userOfflineTimeout=void 0,this._users.filter(s=>!s._trust_in_room_).forEach(s=>{_.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(s.uid)),this._handleUserOffline({uid:s.uid});}));},3e3),this._streamRemovedTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._streamRemovedTimeout=void 0,this._users.forEach(s=>{s._trust_audio_mute_state_||(_.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(s.uid)),this._handleMuteStream(s.uid,tt.AUDIO,!1)),s._trust_video_mute_state_||(_.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(s.uid)),this._handleMuteStream(s.uid,tt.VIDEO,!1)),s._trust_audio_enabled_state_||(_.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(s.uid)),this._handleSetStreamLocalEnable("audio",s.uid,!0)),s._trust_video_enabled_state_||(_.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(s.uid)),this._handleSetStreamLocalEnable("video",s.uid,!0)),s._trust_video_stream_added_state_||(_.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(s.uid)),this._handleResetAddStream(s,"video")),s._trust_audio_stream_added_state_||(_.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(s.uid)),this._handleResetAddStream(s,"audio")),s._video_added_||s._audio_added_||(_.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(s.uid)),this._handleRemoveStream({uid:s.uid,uint_id:s._uintid}));}));},1e3));}r();}),this._gateway.on(Ie.REQUEST_NEW_GATEWAY_LIST,async(t,e)=>{if(!this._joinInfo)return e(new w(R.UNEXPECTED_ERROR,"can not recover, no join info"));try{let n;this._joinInfo.recoverPreloadCache?(n=this._joinInfo.recoverPreloadCache.ap,f0(this._joinInfo.recoverPreloadCache),this._joinInfo.recoverPreloadCache=void 0):n=await Fm(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Ne,this.store),this._joinInfo&&(this._joinInfo.apResponse=n.gatewayInfo.res,this._joinInfo.gatewayAddrs=n.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=n.gatewayInfo.uni_lbs_ip);let i=[];n.gatewayInfo.gatewayAddrs.forEach(r=>{let{address:o}=r,[s,a]=o.split(":");this._joinInfo&&this._joinInfo.proxyServer?i.push({proxy:this._joinInfo.proxyServer,host:s,port:a}):i.push({host:s,port:a});}),t(i);}catch(n){e(n);}}),this._gateway.on(Ie.NETWORK_QUALITY,t=>{this._networkQualitySensitivity==="normal"&&this.safeEmit(yt.NETWORK_QUALITY,t);}),this._gateway.on(Ie.STREAM_TYPE_CHANGE,(t,e)=>{this.safeEmit(yt.STREAM_TYPE_CHANGED,t,e),et.reportApiInvoke(this._sessionId,{name:ke.STREAM_TYPE_CHANGE,options:[t,e],tag:ge.TRACER}).onSuccess(JSON.stringify({uid:t,streamType:e}));}),this._gateway.on(Ie.IS_P2P_DISCONNECTED,t=>{this._p2pChannel.isP2PDisconnected()?t(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?t(!1):t(!0);}),this._gateway.on(Ie.NEED_RENEW_SESSION,async t=>{if(t==="recover"&&this._joinInfo){let e=await _0(Di(Di({},this._joinInfo),{},{uid:this._joinInfo.uid,stringUid:void 0}));this._joinInfo.recoverPreloadCache=e,this._startSession(e?.sid);}else this._startSession();}),this._gateway.on(Ie.REQUEST_P2P_CONNECTION_PARAMS,async(t,e,n)=>{try{e(await this._p2pChannel.startP2PConnection(t));}catch(i){n(i);}}),this._gateway.on(Ie.JOIN_RESPONSE,(t,e)=>{if(this.store.useP2P)return;let{dtlsParameters:n,iceParameters:i,candidates:r,rtpCapabilities:o,setup:s,cname:a}=Jw(t.ortc,e);this._p2pChannel.connect(i,n,r,o,s,a);}),this._gateway.on(Ie.REQUEST_DC_CONNECTION_PARAMS,t=>{t(this._p2pChannel.getEstablishParams());}),this._gateway.on(Ie.RESET_SIGNAL,t=>{this._p2pChannel.resetConnection(t),this._handleGatewaySignalEvents();}),this._gateway.on(Ie.DATACHANNEL_FAILBACK,()=>{this._joinGateway();}),this._gateway.on(Ie.DATACHANNEL_PRECONNECT,async(t,e,n,i)=>{var r,o,s,a,c,d;await this._p2pChannel.startP2PConnection({turnServer:(r=this._joinInfo)===null||r===void 0?void 0:r.turnServer},!0);let l=function(u,h){let p;return h&&h.ip&&typeof h.port=="number"?(p=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:h.ip,port:h.port.toString(),type:"host",extension:{}}],_.debug("Using remote candidate from AP ".concat(h.ip,":").concat(h.port)),h.ip6&&(p.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:h.ip6,port:h.port.toString(),type:"host",extension:{}}),_.debug("Using IPV6 remote candidate from AP ".concat(h.ip6,":").concat(h.port)))):p=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:u.ip,port:u.port.toString(),type:"host",extension:{}}],p}(t,e);return this._p2pChannel.preConnect({iceUfrag:"".concat((o=this._joinInfo)===null||o===void 0?void 0:o.apResponse.cid,"_").concat((s=this._joinInfo)===null||s===void 0?void 0:s.apResponse.cert),icePwd:"".concat((a=this._joinInfo)===null||a===void 0?void 0:a.apResponse.cid,"_").concat((c=this._joinInfo)===null||c===void 0?void 0:c.apResponse.cert)},{fingerprints:[{hashFunction:"sha-256",fingerprint:(d=v("FINGERPRINT"))!==null&&d!==void 0?d:t.fingerprint}]},l,{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},"active","o/i14u9pJrxRKAsu").then(n).catch(i)});}_handleGatewaySignalEvents(){this._gateway.signal.on(_t.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(_t.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(_t.ON_ADD_AUDIO_STREAM,t=>this._handleAddAudioOrVideoStream("audio",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc)),this._gateway.signal.on(_t.ON_ADD_VIDEO_STREAM,t=>this._handleAddAudioOrVideoStream("video",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc,t.rtxSsrcId)),this._gateway.signal.on(_t.ON_REMOTE_DATASTREAM_UPDATE,t=>{this._handleUpdateDataChannel(t);}),this._gateway.signal.on(_t.ON_REMOTE_FULL_DATASTREAM_INFO,t=>{this._handleUpdateDataChannel({added:t.datastreams,deleted:[]},!0);}),this._gateway.signal.on(_t.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(_t.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(_t.MUTE_AUDIO,t=>this._handleMuteStream(t.uid,tt.AUDIO,!0)),this._gateway.signal.on(_t.UNMUTE_AUDIO,t=>this._handleMuteStream(t.uid,tt.AUDIO,!1)),this._gateway.signal.on(_t.MUTE_VIDEO,t=>this._handleMuteStream(t.uid,tt.VIDEO,!0)),this._gateway.signal.on(_t.UNMUTE_VIDEO,t=>this._handleMuteStream(t.uid,tt.VIDEO,!1)),this._gateway.signal.on(_t.RECEIVE_METADATA,t=>{let e=_s(t.metadata);this.safeEmit(yt.RECEIVE_METADATA,t.uid,e);}),this._gateway.signal.on(_t.ON_DATA_STREAM,async t=>{var e;if(!t)return;let n=_s(t.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&q(e=["aes-128-gcm2","aes-256-gcm2"]).call(e,this._encryptionMode)){if(t.payload.length<ga)throw new w(R.UNEXPECTED_RESPONSE,"payload length ".concat(t.payload.length," is less than header length ").concat(ga));n=await async function(o,s,a){let c=a.subarray(0,ga),d=c.slice(8,ga),l=(d[0]<<8)+d[1],u=(c[6]<<8)+c[7],h=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:o,tagLength:fI,additionalData:new Uint8Array(_I(l,2))},s,a.subarray(ga));return new Uint8Array(h).subarray(0,u)}(this._encryptDataStreamIv,this._encryptDataStreamKey,n);}let i=0;if(t.ordered||t.syncWithAudio){let r=this._p2pChannel.getStats(),o=this.remoteUsers.find(a=>a.uid===t.uid),s=r?.audioRecv.find(a=>a.ssrc===o?._audioSSRC);i=s?.jitterBufferMs;}i==null&&(i=0),yH(Di(Di({},t),{},{payload:n}),i,{id:this._clientId,onStreamMessage:typeof this.onStreamMessage=="function"?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)});}),this._gateway.signal.on(_t.ON_CRYPT_ERROR,()=>{yo(()=>{_.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(yt.CRYPT_ERROR);},this._sessionId);}),this._gateway.signal.on(_t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(_t.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{_.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,It.TOKEN_EXPIRE),this.safeEmit(yt.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset();}),this._gateway.signal.on(_t.ON_STREAM_FALLBACK_UPDATE,t=>{_.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(t.stream_id,", attr: ").concat(t.stream_type)),this.safeEmit(yt.STREAM_FALLBACK,t.stream_id,t.stream_type===1?"fallback":"recover");}),this._gateway.signal.on(_t.ON_PUBLISH_STREAM,t=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:t.proxy})),_.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(t))));}),this._gateway.signal.on(_t.ENABLE_LOCAL_VIDEO,t=>{this._handleSetStreamLocalEnable("video",t.uid,!0);}),this._gateway.signal.on(_t.DISABLE_LOCAL_VIDEO,t=>{this._handleSetStreamLocalEnable("video",t.uid,!1);}),this._gateway.signal.on(Q.REQUEST_TIMEOUT,(t,e)=>{if(this._joinInfo)switch(t){case it.PUBLISH:{if(!e)return;let r=e.ortc;if(r){var n,i;let o=r.some(c=>{let{stream_type:d}=c;return d===jt.Audio}),s=r.some(c=>{let{stream_type:d}=c;return d!==jt.Audio}),a=r.some(c=>{let{stream_type:d}=c;return d===jt.Screen||d===jt.ScreenLow});e.state==="offer"&&et.publish(this._joinInfo.sid,{eventElapse:fn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:R.TIMEOUT,audio:o,video:s,p2pid:e.p2p_id,publishRequestid:this.store.pubId,screenshare:a,audioName:o?(n=r.find(c=>{let{stream_type:d}=c;return d===jt.Audio}))===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId.toString():void 0,videoName:s?(i=r.find(c=>{let{stream_type:d}=c;return d!==jt.Audio}))===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId.toString():void 0});}break}case it.SUBSCRIBE:e&&et.subscribe(this._joinInfo.sid,{succ:!1,ec:R.TIMEOUT,audio:e.stream_type===tt.AUDIO,video:e.stream_type===tt.VIDEO,peerid:e.stream_id,subscribeRequestid:e.ssrcId,p2pid:this.store.p2pId,eventElapse:fn.measureFromSubscribeStart(this.store.clientId,e.ssrcId)});}}),this._gateway.signal.on(_t.ON_P2P_OK,t=>{this.uid,this._uid;}),this._gateway.signal.on(_t.ON_PUBLISHED_USER_LIST,t=>{if(t==null||!t.users)return;v("BLOCK_LOCAL_CLIENT")&&(t.users=t.users.filter(i=>!Es(i.string_id||i.stream_id,this.channelName)));let e=[],n=[];for(let i of t.users){let r=this._users.find(l=>l._uintid===i.stream_id);r?r._trust_in_room_=!0:(r=new Go(i.string_id||i.stream_id,i.stream_id),this._users.push(r),this.getListeners(yt.PUBLISHED_USER_LIST).length===0&&(_.debug("[".concat(this._clientId,"] user online"),i.stream_id),this.safeEmit(yt.USER_JOINED,r)));let o=qe.Audio&i.stream_type,s=(qe.Video|qe.LwoVideo)&i.stream_type,a=(65280&i.stream_type)!=0,c=o&&r.hasAudio,d=s&&r.hasVideo;s&&(r._trust_video_stream_added_state_=!0,r._video_added_=!0,r._videoSSRC=i.video_ssrc,r._rtxSsrcId=i.video_rtx),o&&(r._trust_audio_stream_added_state_=!0,r._audio_added_=!0,r._audioSSRC=i.audio_ssrc),o&&!c&&this.getListeners(yt.PUBLISHED_USER_LIST).length===0&&(_.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published audio")),this.safeEmit(yt.USER_PUBLISHED,r,"audio")),s&&!d&&this.getListeners(yt.PUBLISHED_USER_LIST).length===0&&(_.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published video")),this.safeEmit(yt.USER_PUBLISHED,r,"video")),(o&&!c||s&&!d||a)&&e.push(r),s&&this._p2pChannel.hasPendingRemoteMedia(r,"video")&&n.push({user:r,mediaType:"video"}),o&&this._p2pChannel.hasPendingRemoteMedia(r,"audio")&&n.push({user:r,mediaType:"audio"});}n.length>0&&(_.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(n.map(i=>"user: ".concat(i.user.uid,", mediaType: ").concat(i.mediaType)).join("; ")," ")),this.massSubscribe(n).catch(i=>{_.error("[".concat(this._clientId,"] mass resubscribe error"),i.toString());})),this.getListeners(yt.PUBLISHED_USER_LIST).length>0?v("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=e:(_.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(e.map(i=>i.uid).join(", "))),this.safeEmit(yt.PUBLISHED_USER_LIST,e)):_.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(e.map(i=>i.uid).join(", ")));}),this._gateway.signal.on(_t.ON_RTP_CAPABILITY_CHANGE,t=>{let{video_codec:e}=t;this._p2pChannel instanceof rh&&this._p2pChannel.updateRemoteRTPCapabilities(e.map(n=>n.toLowerCase()).filter(n=>{var i;return q(i=Object.keys(fa)).call(i,n)}));});}_handleP2PEvents(){this._gateway.signal.on(_t.ON_USER_OFFLINE,()=>{this._p2pChannel.disconnectForReconnect();}),this._gateway.signal.on(ye.PUBLISH,(t,e,n)=>{let{uid:i}=t;t.forEach(r=>{let{kind:o,ssrcs:s,mid:a,isMuted:c}=r;this._handleP2PAddAudioOrVideoStream(o,i,s[0].ssrcId,a);let d=this._users.find(l=>l.uid===i);return d&&this._p2pChannel instanceof ti?this._p2pChannel.mockSubscribe(d,o,s[0].ssrcId,a).then(()=>{e();}).catch(n):e(),this._handleMuteStream(i,o,!!c)});}),this._gateway.signal.on(ye.CALL,async(t,e,n)=>{if(this._p2pChannel instanceof ti)try{var i;e(await this._p2pChannel.startP2P({turnServer:(i=this._joinInfo)===null||i===void 0?void 0:i.turnServer},t));}catch(r){n(r);}}),this._gateway.signal.on(Q.P2P_CONNECTION,async t=>{this._p2pChannel instanceof ti&&await this._p2pChannel.p2pConnect(t);}),this._gateway.signal.on(ye.UNPUBLISH,async(t,e,n)=>{if(this._p2pChannel instanceof ti){let{unpubMsg:i,uid:r}=t,o=this._users.find(s=>s.uid===r);if(!o)return _.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(r)),void e();try{i.forEach(async s=>{let{stream_type:a}=s,c=a===jt.Audio?tt.AUDIO:tt.VIDEO;await this._p2pChannel.unsubscribe(o,c),this._handleMuteStream(r,c,!0);}),e();}catch(s){n(s);}}}),this._gateway.signal.on(ye.CONTROL,async(t,e)=>{let{action:n}=t;switch(n){case No.MUTE_LOCAL_VIDEO:this._handleMuteStream(e,tt.VIDEO,!0);break;case No.MUTE_LOCAL_AUDIO:this._handleMuteStream(e,tt.AUDIO,!0);break;case No.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",e),this._handleMuteStream(e,tt.VIDEO,!1);break;case No.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",e),this._handleMuteStream(e,tt.AUDIO,!1);}}),this._gateway.signal.on(ye.RESTART_ICE,async(t,e,n)=>{if(this._p2pChannel instanceof ti)try{let{direction:i,iceParameter:r}=t;i!==Dn.SEND_ONLY||r?e(await this._p2pChannel.restartICE(i,r)):(this._p2pChannel.handleDisconnect(i),e());}catch(i){n(i);}}),this._gateway.signal.on(ye.CANDIDATE,t=>{if(this._p2pChannel instanceof ti){let{candidate:e,direction:n}=t;this._p2pChannel.addRemoteCandidate(e,n);}}),this._p2pChannel.on(ct.RequestP2PRestartICE,async(t,e,n)=>{try{let{direction:i}=t;e(await this._gateway.sendExtensionMessage(ye.RESTART_ICE,t,i===Dn.SEND_ONLY));}catch(i){n(i);}}),this._p2pChannel.on(ct.LocalCandidate,t=>{this._gateway.sendExtensionMessage(ye.CANDIDATE,JSON.stringify(t),!0);}),this._p2pChannel.on(ct.RequestP2PMuteLocal,async(t,e,n)=>{try{await this._gateway.sendExtensionMessage(ye.CONTROL,t,!0),e();}catch(i){n(i);}}),this._p2pChannel.on(ct.RequestP2PUnmuteRemote,async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),e();}catch(i){i.code===R.DISCONNECT_P2P?e():n(i);}else e();}),this._p2pChannel.on(ct.RequestP2PMuteRemote,async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.muteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),e();}catch(i){i.code===R.DISCONNECT_P2P?e():n(i);}else e();}),this._p2pChannel.on(ct.StateChange,(t,e)=>{e===Gt.Connected&&this._p2pChannel.republish();});}_handleP2PChannelEvents(){this._p2pChannel.on(ct.RequestMuteLocal,async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.muteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e();}catch(i){i.code===R.DISCONNECT_P2P?e():n(i);}else e();}),this._p2pChannel.on(ct.RequestUnmuteLocal,async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e();}catch(i){i.code===R.DISCONNECT_P2P?e():n(i);}else e();}),this._p2pChannel.on(ct.RequestRePublish,(t,e,n)=>{this.publish(t,!1).then(e).catch(n);}),this._p2pChannel.on(ct.RequestRePublishDataChannel,(t,e,n)=>{K.all(t.map(async i=>{await this._p2pChannel.publishDataChannel([i]);let r={streamId:i.id,ordered:i.ordered,maxRetransmits:i.maxRetransmits,metadata:i.metadata,channelId:i._originDataChannelId};try{await this._gateway.publishDataChannel(this._uid,r,!0);}catch(o){if(o.code!==R.DISCONNECT_P2P)throw o}})).then(e).catch(n);}),this._p2pChannel.on(ct.RequestReSubscribe,async(t,e,n)=>{try{for(let{user:i,kind:r}of t)r===tt.VIDEO?await this.subscribe(i,"video"):await this.subscribe(i,"audio");e();}catch(i){n(i);}}),this._p2pChannel.on(ct.RequestUpload,(t,e)=>{this._gateway.upload(t,e);}),this._p2pChannel.on(ct.RequestUploadStats,t=>{this._gateway.uploadWRTCStats(t);}),this._p2pChannel.on(ct.MediaReconnectStart,t=>{this.safeEmit(yt.MEDIA_RECONNECT_START,t);}),this._p2pChannel.on(ct.MediaReconnectEnd,t=>{this.safeEmit(yt.MEDIA_RECONNECT_END,t);}),this._p2pChannel.on(ct.NeedSignalRTT,t=>{t(this._gateway.getSignalRTT());}),this._p2pChannel.on(ct.RequestRestartICE,async t=>{if(this._p2pChannel instanceof ti)return;let e=await this._p2pChannel.restartICE(t),n=await e.next();if(n.done)return;let i=n.value,r;try{r=await this._gateway.restartICE({iceParameters:i});}catch(s){return void e.throw(s)}let{iceParameters:o}=function(s){let a=s.iceParameters;return {iceParameters:{iceUfrag:a.iceUfrag,icePwd:a.icePwd}}}(r);await e.next({remoteIceParameters:o});}),this._p2pChannel.on(ct.RequestReconnect,async()=>{this._gateway.reconnect();}),this._p2pChannel.on(ct.RequestReconnectPC,async()=>{var t;let{iceParameters:e,dtlsParameters:n,rtpCapabilities:i}=await this._p2pChannel.startP2PConnection({turnServer:(t=this._joinInfo)===null||t===void 0?void 0:t.turnServer}),{gatewayEstablishParams:r,gatewayAddress:o}=await this._gateway.reconnectPC({iceParameters:e,dtlsParameters:n,rtpCapabilities:i}),{dtlsParameters:s,iceParameters:a,candidates:c,rtpCapabilities:d,setup:l,cname:u}=Jw(r,o);await this._p2pChannel.connect(a,s,c,d,l,u),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe();}),this._p2pChannel.on(ct.RequestUnpublishForReconnectPC,async(t,e,n)=>{this._joinInfo&&this._uid!==void 0?(await this._gateway.unpublish(t,this._uid),e()):n();}),this._p2pChannel.on(ct.P2PLost,()=>{this.safeEmit(yt.P2P_LOST,this.store.uid);}),this._p2pChannel.on(ct.UpdateVideoEncoder,t=>{t._encoderConfig&&this._gateway.setVideoProfile(t._encoderConfig);}),this._p2pChannel.on(ct.ConnectionTypeChange,t=>{this.safeEmit(yt.IS_USING_CLOUD_PROXY,t);}),this._p2pChannel.on(ct.RequestLowStreamParameter,t=>{t(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50});}),this._p2pChannel.on(ct.QueryClientConnectionState,t=>{t(this.connectionState);});}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(t){if(this.connectionState!=="CONNECTED"||!this._joinInfo)throw new w(R.INVALID_OPERATION,"[".concat(this._clientId,"] Client did not join channel"));if(this._inspect)throw new w(R.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));if(!t)throw new w(R.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig is necessary"));if(!t.inspectType||!Array.isArray(t.inspectType))throw new w(R.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.inspectType is necessary and is an instance of Array."));{let e=[...new Set(t.inspectType)];e.forEach(n=>{var i;if(!q(i=["supervise","moderation"]).call(i,n))throw new w(R.INVALID_PARAMS,"[".concat(this._clientId,"] ").concat(n," is not a valid inspect type."))}),t.inspectType=e;}if(t&&t.extraInfo&&t.extraInfo.length>1024)throw new w(R.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.extraInfo length cannot exceed 1024 bytes"));try{let e=new oh(t);this._inspect=e,this.handleVideoInspectEvents(this._inspect),await e.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},Ne);}catch(e){throw Array.isArray(e)?e[0]:e}}async disableContentInspect(){if(!this._inspect)throw new w(R.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0;}catch(t){throw Array.isArray(t)?t[0]:t}}async setImageModeration(t,e){if(Xr(t,"enabled"),t){if(!e)throw new w(R.INVALID_PARAMS,"[".concat(this._clientId,"] config is necessary"));if(zt(e.interval,"interval",1e3,1/0),e&&e.extraInfo&&e.extraInfo.length>1024)throw new w(R.INVALID_PARAMS,"[".concat(this._clientId,"] config.extraInfo length cannot exceed 1024 bytes"));if(e&&e.vendor&&e.vendor.length>1024)throw new w(R.INVALID_PARAMS,"[".concat(this._clientId,"] config.vendor length cannot exceed 1024 bytes"));if(this.connectionState!=="CONNECTED"||!this._joinInfo)throw new w(R.INVALID_OPERATION,"[".concat(this._clientId,'] can not enable image moderation, not joined"'));try{if(this._moderation)return void this._moderation.updateConfig(e);let n=new pf(e);this._moderation=n,this.handleImageModerationEvents(this._moderation),await n.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},Ne);}catch(n){throw Array.isArray(n)?n[0]:n}}else {if(!this._moderation)throw new w(R.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0;}catch(n){throw Array.isArray(n)?n[0]:n}}}setP2PTransport(t){if(function(e){Ge(e,"transport",["default","auto","relay","sd-rtn"]);}(t),this.mode!=="p2p")throw new w(R.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=t,_.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(t));}handleImageModerationEvents(t){t.on(dr.CONNECTION_STATE_CHANGE,(e,n)=>{if(this.safeEmit(yt.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,e,n),e===yi.CONNECTED){if(this.connectionState!=="CONNECTED")throw this.setImageModeration(!1),new w(R.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");t.inspectImage();}}),t.on(dr.CLIENT_LOCAL_VIDEO_TRACK,e=>{e(this.localTracks.filter(n=>n.trackMediaType==="video")[0]);});}handleVideoInspectEvents(t){t.on(tn.CONNECTION_STATE_CHANGE,(e,n)=>{if(this.safeEmit(yt.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,e,n),n===Bi.CONNECTED){if(this.connectionState!=="CONNECTED")return void this.safeEmit(yt.CONTENT_INSPECT_ERROR,new w(R.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));t.inspectImage();}}),t.on(tn.INSPECT_RESULT,(e,n)=>{var i;if(n?.code===R.INVALID_OPERATION&&this.connectionState==="DISCONNECTED")return _.debug("Stop inspect content because that has left channel"),this==null||(i=this._inspect)===null||i===void 0||i.close(),void(this._inspect=void 0);this.safeEmit(yt.CONTENT_INSPECT_RESULT,e,n);}),t.on(tn.CLIENT_LOCAL_VIDEO_TRACK,e=>{e(this.localTracks.filter(n=>n.trackMediaType==="video")[0]);});}getJoinChannelServiceRecords(){return _.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(t){Xr(t,"enabled"),Jt("ENABLE_PUBLISH_AUDIO_FILTER",t),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(t);}_handleResetAddStream(t,e){switch(e){case"audio":t._audio_added_=!1,t._trust_audio_stream_added_state_=!0;break;case"video":t._video_added_=!1,t._trust_video_stream_added_state_=!0;}}},W(z.prototype,"leave",[S0],Object.getOwnPropertyDescriptor(z.prototype,"leave"),z.prototype),W(z.prototype,"publish",[R0],Object.getOwnPropertyDescriptor(z.prototype,"publish"),z.prototype),W(z.prototype,"unpublish",[C0],Object.getOwnPropertyDescriptor(z.prototype,"unpublish"),z.prototype),W(z.prototype,"subscribe",[v0],Object.getOwnPropertyDescriptor(z.prototype,"subscribe"),z.prototype),W(z.prototype,"presubscribe",[I0],Object.getOwnPropertyDescriptor(z.prototype,"presubscribe"),z.prototype),W(z.prototype,"massSubscribe",[y0],Object.getOwnPropertyDescriptor(z.prototype,"massSubscribe"),z.prototype),W(z.prototype,"unsubscribe",[A0],Object.getOwnPropertyDescriptor(z.prototype,"unsubscribe"),z.prototype),W(z.prototype,"massUnsubscribe",[b0],Object.getOwnPropertyDescriptor(z.prototype,"massUnsubscribe"),z.prototype),W(z.prototype,"setLowStreamParameter",[w0],Object.getOwnPropertyDescriptor(z.prototype,"setLowStreamParameter"),z.prototype),W(z.prototype,"enableDualStream",[O0],Object.getOwnPropertyDescriptor(z.prototype,"enableDualStream"),z.prototype),W(z.prototype,"disableDualStream",[N0],Object.getOwnPropertyDescriptor(z.prototype,"disableDualStream"),z.prototype),W(z.prototype,"setClientRole",[D0],Object.getOwnPropertyDescriptor(z.prototype,"setClientRole"),z.prototype),W(z.prototype,"setProxyServer",[P0],Object.getOwnPropertyDescriptor(z.prototype,"setProxyServer"),z.prototype),W(z.prototype,"setTurnServer",[L0],Object.getOwnPropertyDescriptor(z.prototype,"setTurnServer"),z.prototype),W(z.prototype,"setLicense",[k0],Object.getOwnPropertyDescriptor(z.prototype,"setLicense"),z.prototype),W(z.prototype,"startProxyServer",[M0],Object.getOwnPropertyDescriptor(z.prototype,"startProxyServer"),z.prototype),W(z.prototype,"stopProxyServer",[U0],Object.getOwnPropertyDescriptor(z.prototype,"stopProxyServer"),z.prototype),W(z.prototype,"setLocalAccessPointsV2",[x0],Object.getOwnPropertyDescriptor(z.prototype,"setLocalAccessPointsV2"),z.prototype),W(z.prototype,"setLocalAccessPoints",[V0],Object.getOwnPropertyDescriptor(z.prototype,"setLocalAccessPoints"),z.prototype),W(z.prototype,"setRemoteDefaultVideoStreamType",[F0],Object.getOwnPropertyDescriptor(z.prototype,"setRemoteDefaultVideoStreamType"),z.prototype),W(z.prototype,"setRemoteVideoStreamType",[B0],Object.getOwnPropertyDescriptor(z.prototype,"setRemoteVideoStreamType"),z.prototype),W(z.prototype,"setStreamFallbackOption",[j0],Object.getOwnPropertyDescriptor(z.prototype,"setStreamFallbackOption"),z.prototype),W(z.prototype,"setEncryptionConfig",[G0],Object.getOwnPropertyDescriptor(z.prototype,"setEncryptionConfig"),z.prototype),W(z.prototype,"renewToken",[W0],Object.getOwnPropertyDescriptor(z.prototype,"renewToken"),z.prototype),W(z.prototype,"enableAudioVolumeIndicator",[H0],Object.getOwnPropertyDescriptor(z.prototype,"enableAudioVolumeIndicator"),z.prototype),W(z.prototype,"startLiveStreaming",[K0],Object.getOwnPropertyDescriptor(z.prototype,"startLiveStreaming"),z.prototype),W(z.prototype,"setLiveTranscoding",[Y0],Object.getOwnPropertyDescriptor(z.prototype,"setLiveTranscoding"),z.prototype),W(z.prototype,"stopLiveStreaming",[q0],Object.getOwnPropertyDescriptor(z.prototype,"stopLiveStreaming"),z.prototype),W(z.prototype,"addInjectStreamUrl",[z0],Object.getOwnPropertyDescriptor(z.prototype,"addInjectStreamUrl"),z.prototype),W(z.prototype,"removeInjectStreamUrl",[J0],Object.getOwnPropertyDescriptor(z.prototype,"removeInjectStreamUrl"),z.prototype),W(z.prototype,"startChannelMediaRelay",[X0],Object.getOwnPropertyDescriptor(z.prototype,"startChannelMediaRelay"),z.prototype),W(z.prototype,"updateChannelMediaRelay",[Q0],Object.getOwnPropertyDescriptor(z.prototype,"updateChannelMediaRelay"),z.prototype),W(z.prototype,"stopChannelMediaRelay",[Z0],Object.getOwnPropertyDescriptor(z.prototype,"stopChannelMediaRelay"),z.prototype),W(z.prototype,"sendCustomReportMessage",[$0],Object.getOwnPropertyDescriptor(z.prototype,"sendCustomReportMessage"),z.prototype),W(z.prototype,"pickSVCLayer",[tN],Object.getOwnPropertyDescriptor(z.prototype,"pickSVCLayer"),z.prototype),W(z.prototype,"setRTMConfig",[eN],Object.getOwnPropertyDescriptor(z.prototype,"setRTMConfig"),z.prototype),W(z.prototype,"enableContentInspect",[nN],Object.getOwnPropertyDescriptor(z.prototype,"enableContentInspect"),z.prototype),W(z.prototype,"disableContentInspect",[iN],Object.getOwnPropertyDescriptor(z.prototype,"disableContentInspect"),z.prototype),W(z.prototype,"setImageModeration",[rN],Object.getOwnPropertyDescriptor(z.prototype,"setImageModeration"),z.prototype),W(z.prototype,"setP2PTransport",[oN],Object.getOwnPropertyDescriptor(z.prototype,"setP2PTransport"),z.prototype),W(z.prototype,"getJoinChannelServiceRecords",[sN],Object.getOwnPropertyDescriptor(z.prototype,"getJoinChannelServiceRecords"),z.prototype),W(z.prototype,"setPublishAudioFilterEnabled",[aN],Object.getOwnPropertyDescriptor(z.prototype,"setPublishAudioFilterEnabled"),z.prototype),z);class wd{constructor(e,n){g(this,"id",0),g(this,"element",void 0),g(this,"peerPair",void 0),g(this,"context",void 0),g(this,"audioPlayerElement",void 0),g(this,"audioTrack",void 0),wd.count+=1,this.id=wd.count,this.element=e,this.context=n;}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=e=>{let n=document.createElement("audio");n.srcObject=new MediaStream([e.track]),n.play(),this.audioPlayerElement=n;};}async switchSdp(){if(!this.peerPair)return;let e=async(i,r)=>{let o=r==="offer"?await i.createOffer():await i.createAnswer();return await i.setLocalDescription(o),i.iceGatheringState==="complete"?i.localDescription:new K(s=>{i.onicegatheringstatechange=()=>{i.iceGatheringState==="complete"&&s(i.localDescription);};})},n=async(i,r)=>await i.setRemoteDescription(r);try{let i=await e(this.peerPair[0],"offer");await n(this.peerPair[1],i);let r=await e(this.peerPair[1],"answer");await n(this.peerPair[0],r);}catch(i){throw new w(R.LOCAL_AEC_ERROR,i.toString()).print()}}async getTracksFromMediaElement(e){if(this.audioTrack)return this.audioTrack;let n;try{e instanceof HTMLVideoElement&&(e.captureStream?e.captureStream():e.mozCaptureStream()),n=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(e).connect(n);}catch(r){throw new w(R.LOCAL_AEC_ERROR,r.toString()).print()}if(!n)throw new w(R.LOCAL_AEC_ERROR,"no dest node when local aec").print();let i=n.stream.getAudioTracks()[0];return this.audioTrack=i,i}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();let e=this.element,n=await this.getTracksFromMediaElement(e);this.peerPair&&this.peerPair[0].addTrack(n),await this.switchSdp();}close(){_.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach(e=>{e.close();}),this.peerPair=void 0,this.audioPlayerElement=void 0;}}var dN,uh;g(wd,"count",0);let DH=window.AudioContext||window.webkitAudioContext,PH=new(dN=st({report:et}),W((uh=class{constructor(){g(this,"units",[]),g(this,"context",void 0);}processExternalMediaAEC(t){if(!this._doesEnvironmentNeedAEC())return _.debug("the system does not need to process local aec"),-1;this.context||(this.context=new DH);let e=this.units.find(n=>n&&n.getElement()===t);return e||(e=new wd(t,this.context),this.units.push(e)),e.startEchoCancellation(),_.debug("start processing local audio echo cancellation, id is",e.id),e.id}_doesEnvironmentNeedAEC(){return Pt().name!==Bt.SAFARI}}).prototype,"processExternalMediaAEC",[dN],Object.getOwnPropertyDescriptor(uh.prototype,"processExternalMediaAEC"),uh.prototype),uh);function lN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i);}return n}function uN(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?lN(Object(n),!0).forEach(function(i){g(t,i,n[i]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):lN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i));});}return t}let Sf=window||document;function hN(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!Sf)return;let n=xe._cspEventHandlerPointer;if(n&&e)return void console.error(n,e);let i=r=>{if(!(r&&r.blockedURI&&(xe.onSecurityPolicyViolation||xe.getListeners(Dr.SECURITY_POLICY_VIOLATION).length>0)))return;let o=r.blockedURI;v("CSP_DETECTED_HOSTNAME_LIST").some(s=>q(o).call(o,s))&&(xe.onSecurityPolicyViolation&&typeof xe.onSecurityPolicyViolation=="function"&&xe.onSecurityPolicyViolation(r),xe.getListeners(Dr.SECURITY_POLICY_VIOLATION).length>0&&xe.safeEmit(Dr.SECURITY_POLICY_VIOLATION,r));};n&&Sf.removeEventListener("securitypolicyviolation",n),(e||t&&typeof t=="function"||xe.getListeners(Dr.SECURITY_POLICY_VIOLATION).length>0)&&Sf.addEventListener("securitypolicyviolation",i),xe._cspEventHandlerPointer=i;}Jt("PROCESS_ID","process-".concat(Zt(8,""),"-").concat(Zt(4,""),"-").concat(Zt(4,""),"-").concat(Zt(4,""),"-").concat(Zt(12,""))),function(){let t;try{t=window.localStorage.getItem("websdk_ng_global_parameter");}catch(e){return void _.error("Error loading sdk config",e.message)}if(t)try{let e=JSON.parse(window.atob(t)),n=Date.now();_.debug("Loading global parameters from cache",e),Object.keys(e).forEach(i=>{if(Object.prototype.hasOwnProperty.call(Fe,i)){let{value:r,expires:o}=e[i];if(o&&o<=n)return;bo[i]=r,Fe[i]=r;}});}catch(e){_.error("Error loading mutableParamsCache: ".concat(t),e.message);}}(),Array.isArray(bo.AREAS)&&bo.AREAS.length>0&&Lm(bo.AREAS,!0);let pN=(t,e,n)=>{_.debug("setParameter key:".concat(t,", value:").concat(JSON.stringify(e))),Jt(t,e,n);},xe=function(t){let e=new de,n=t,i={getListeners:e.getListeners.bind(e),on:(r,o)=>(function(s,a){s===Dr.SECURITY_POLICY_VIOLATION&&hN(a,!0);}(r,o),e.on.bind(e)(r,o)),addListener:e.addListener.bind(e),once:e.once.bind(e),off:e.off.bind(e),removeAllListeners:e.removeAllListeners.bind(e),emit:e.emit.bind(e),safeEmit:e.safeEmit.bind(e)};return uN(uN({},n),i)}({__TRACK_LIST__:Va,VERSION:vi,BUILD:Em,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:pN,getParameter:v,getSupportedCodec:async function(){let t={audio:[],video:[]};try{let e=new RTCPeerConnection,n=await async function(i){let r;return Ot().supportUnifiedPlan?(i.addTransceiver("video",{direction:"recvonly"}),i.addTransceiver("audio",{direction:"recvonly"}),r=(await i.createOffer()).sdp):r=(await i.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})).sdp,r}(e);if(!n)return t;e.close(),e=null,t=function(i){let r={video:[],audio:[]};return i.match(/ VP8/i)&&r.video.push("VP8"),i.match(/ VP9/i)&&r.video.push("VP9"),i.match(/ AV1/i)&&r.video.push("AV1"),i.match(/ H264/i)&&r.video.push("H264"),i.match(/ H265/i)&&r.video.push("H265"),i.match(/ opus/i)&&r.audio.push("OPUS"),i.match(/ PCMU/i)&&r.audio.push("PCMU"),i.match(/ PCMA/i)&&r.audio.push("PCMA"),i.match(/ G722/i)&&r.audio.push("G722"),r}(n);}catch(e){throw new w(R.CREATE_OFFER_FAILED,e.toString&&e.toString()).print()}return t},checkSystemRequirements:function(){let t=et.reportApiInvoke(null,{name:ke.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:ge.TRACER}),e=!1;try{let o=window.RTCPeerConnection,s=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,a=window.WebSocket;e=!!(o&&s&&a),e&&rm()&&function(c){let d=Pt();return !(d.name!==Bt.CHROME||!d.osVersion)&&Number(d.version)<c}(75)&&new o().close();}catch(o){return _.error("check system requirement failed: ",o),!1}let n=!1,i=Pt();i.name===Bt.CHROME&&Number(i.version)>=58&&(sr.engine.name!=="WebKit"||function(){let o=Pt();if(Kl()){if(o.os===He.MAC_OS)return !0;if(o.os===He.IOS){let s=sr.os.version&&sr.os.version.split(".");if(s&&Number(s[0])===14&&s[1]&&Number(s[1])>=3||s&&Number(s[0])>14)return !0}}return !1}())&&(n=!0),(i.name===Bt.FIREFOX&&Number(i.version)>=56||i.name===Bt.OPERA&&Number(i.version)>=45||i.name===Bt.SAFARI&&Number(i.version)>=11||i.name==="WebKit"&&(mn()||Vi())&&i.osVersion&&Number(i.osVersion.split(".")[0])>=11||Jv()||Pt().name===Bt.QQ)&&(n=!0),_.debug("checkSystemRequirements, api:",e,"browser",n);let r=e&&n;return t.onSuccess(r),r},getDevices:function(t){return hi.enumerateDevices(!0,!0,t)},getMicrophones:function(t){return hi.getRecordingDevices(t)},getCameras:function(t){return hi.getCamerasDevices(t)},getElectronScreenSources:FA,getPlaybackDevices:function(t){return hi.getSpeakers(t)},createClient:function(){var t;let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"},n=et.reportApiInvoke(null,{name:ke.CREATE_CLIENT,options:[e],tag:ge.TRACER});try{(function(i){Ge(i.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),Ge(i.mode,"config.mode",["rtc","live","p2p"]),i.audioCodec!==void 0&&Ge(i.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),i.proxyServer!==void 0&&rn(i.proxyServer,"config.proxyServer",1,1e4),i.turnServer!==void 0&&oI(i.turnServer),i.httpRetryConfig!==void 0&&rI(i.httpRetryConfig),i.websocketRetryConfig!==void 0&&rI(i.websocketRetryConfig);})(e);}catch(i){throw n.onError(i),i}return (Wv(16,0)||Hv(16,0))&&(e.codec==="vp9"&&(e.codec="vp8",_.debug("browser not support vp9, force use vp8")),Jt("UNSUPPORTED_VIDEO_CODEC",["vp9"])),e.audioCodec===void 0&&(e.audioCodec="opus"),n.onSuccess(),new NH(Di(Di({forceWaitGatewayResponse:!0},e),{},{role:q(t=["rtc","p2p"]).call(t,e.mode)?"host":e.role||"audience"}))},createCameraVideoTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=v("CAMERA_CAPTURE_CONFIG"),n=et.reportApiInvoke(null,{tag:ge.TRACER,name:ke.CREATE_CAM_VIDEO_TRACK,options:[le({},t),e]});e&&(t.encoderConfig=e);let i=xu(t),r=Zt(8,"track-cam-"),o=null,s=t.encoderConfig==="720p_auto";_.info("start create camera video track with config",JSON.stringify(t),"trackId",r);try{o=(await ui({video:i},r)).getVideoTracks()[0]||null;}catch(c){throw n.onError(c),c}if(!o){let c=new D(R.UNEXPECTED_ERROR,"can not find track in media stream");return n.onError(c),c.throw(_)}t.optimizationMode&&jE(r,o,t,xr(t.encoderConfig));let a=new BE(o,t,i,t.scalabiltyMode?Lu(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,r);return s&&a.startMonitorStats(),n.onSuccess(a.getTrackId()),_.info("create camera video success, trackId:",r),a},createCustomVideoTrack:function(t){let e=et.reportApiInvoke(null,{tag:ge.TRACER,name:ke.CREATE_CUSTOM_VIDEO_TRACK,options:[t]}),n=new $t(t.mediaStreamTrack,{width:t.width,height:t.height,frameRate:t.frameRate,bitrateMax:t.bitrateMax,bitrateMin:t.bitrateMin},t.scalabiltyMode?Lu(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,Zt(8,"track-cus-"),[ie.CUSTOM_TRACK]);return e.onSuccess(n.getTrackId()),_.info("create custom video track success with config",t,"trackId",n.getTrackId()),n},createScreenVideoTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"disable",n=et.reportApiInvoke(null,{tag:ge.TRACER,name:ke.CREATE_SCREEN_VIDEO_TRACK,options:[le({},t),e]}),i=t.encoderConfig==="720p_auto";t.encoderConfig?typeof t.encoderConfig=="string"||t.encoderConfig.width&&t.encoderConfig.height||(t.encoderConfig.width={max:1920},t.encoderConfig.height={max:1080}):t.encoderConfig="1080p_2";let r=function(u){let h={};u.screenSourceType&&(h.mediaSource=u.screenSourceType),u.extensionId&&vo()&&(h.extensionId=u.extensionId);let{displaySurface:p,selfBrowserSurface:T,surfaceSwitching:m,systemAudio:E}=u;(nm(107)||jv(107)||Kv(93))&&(p&&(Ge(p,"displaySurface",["browser","window","monitor"]),h.displaySurface=p),T?(Ge(T,"selfBrowserSurface",["exclude","include"]),h.selfBrowserSurface=T):h.selfBrowserSurface="include",m&&(Ge(m,"surfaceSwitching",["exclude","include"]),h.surfaceSwitching=m)),(nm(105)||jv(105)||Kv(91))&&E&&(Ge(E,"systemAudio",["exclude","include"]),h.systemAudio=E),u.electronScreenSourceId&&(h.sourceId=u.electronScreenSourceId);let S=u.encoderConfig?OE(u.encoderConfig):null;return h.mandatory={chromeMediaSource:"desktop",maxWidth:S?S.width:void 0,maxHeight:S?S.height:void 0},S&&(S.frameRate&&(typeof S.frameRate=="number"?(h.mandatory.maxFrameRate=S.frameRate,h.mandatory.minFrameRate=S.frameRate):(h.mandatory.maxFrameRate=S.frameRate.max||S.frameRate.ideal||S.frameRate.exact||void 0,h.mandatory.minFrameRate=S.frameRate.min||S.frameRate.ideal||S.frameRate.exact||void 0),h.frameRate=S.frameRate),S.width&&(h.width=S.width),S.height&&(h.height=S.height)),h}(t),o=Zt(8,"track-scr-v-"),s=null,a=null,c=Ot();if(!c.supportShareAudio&&e==="enable"){let u=new D(R.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return n.onError(u),u.throw(_)}_.info("start create screen video track with config",t,"withAudio",e,"trackId",o);try{let u=await ui({screen:r,screenAudio:e==="auto"?c.supportShareAudio:e==="enable"},o);s=u.getVideoTracks()[0]||null,a=u.getAudioTracks()[0]||null;}catch(u){throw n.onError(u),u}if(!s){let u=new D(R.UNEXPECTED_ERROR,"can not find track in media stream");return n.onError(u),u.throw(_)}if(!a&&e==="enable"){s&&s.stop();let u=new D(R.SHARE_AUDIO_NOT_ALLOWED);return n.onError(u),u.throw(_)}t.optimizationMode||(t.optimizationMode="detail"),t.optimizationMode&&(jE(o,s,t,t.encoderConfig&&OE(t.encoderConfig)||void 0),t.encoderConfig&&typeof t.encoderConfig!="string"&&(t.encoderConfig.bitrateMin=t.encoderConfig.bitrateMax));let d=new $t(s,t.encoderConfig?OE(t.encoderConfig):{},t.scalabiltyMode?Lu(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,o,[ie.SCREEN_TRACK]);if(i&&d.startMonitorStats(),!a)return n.onSuccess(d.getTrackId()),_.info("create screen video track success","video:",d.getTrackId()),d;let l=new Re(a,void 0,Zt(8,"track-scr-a-"),!1);return n.onSuccess([d.getTrackId(),l.getTrackId()]),_.info("create screen video track success","video:",d.getTrackId(),"audio:",l.getTrackId()),[d,l]},createMicrophoneAndCameraTracks:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=v("CAMERA_CAPTURE_CONFIG"),i=et.reportApiInvoke(null,{tag:ge.TRACER,name:ke.CREATE_MIC_AND_CAM_TRACKS,options:[t,e,n]});n&&(e.encoderConfig=n);let r=e.encoderConfig==="720p_auto",o=xu(e),s=JA(t),a=Zt(8,"track-mic-"),c=Zt(8,"track-cam-"),d=null,l=null;_.info("start create camera video track(".concat(c,") and microphone audio track(").concat(a,") with config, audio: ").concat(JSON.stringify(t),", video: ").concat(JSON.stringify(e)));try{let p=await ui({audio:s,video:o},"".concat(a,"-").concat(c));d=p.getAudioTracks()[0],l=p.getVideoTracks()[0];}catch(p){throw i.onError(p),p}if(!d||!l){let p=new D(R.UNEXPECTED_ERROR,"can not find tracks in media stream");return i.onError(p),p.throw(_)}e.optimizationMode&&jE(c,l,e,xr(e.encoderConfig));let u=new Vu(d,t,s,a),h=new BE(l,e,o,e.scalabiltyMode?Lu(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,c);return r&&h.startMonitorStats(),i.onSuccess([u.getTrackId(),h.getTrackId()]),_.info("create camera video track(".concat(c,") and microphone audio track(").concat(a,") success")),[u,h]},createMicrophoneAudioTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=et.reportApiInvoke(null,{tag:ge.TRACER,name:ke.CREATE_MIC_AUDIO_TRACK,options:[t]}),n=JA(t),i=Zt(8,"track-mic-"),r=null;_.info("start create microphone audio track with config",JSON.stringify(t),"trackId",i);try{r=(await ui({audio:n},i)).getAudioTracks()[0]||null;}catch(s){throw e.onError(s),s}if(!r){let s=new D(R.UNEXPECTED_ERROR,"can not find track in media stream");return e.onError(s),s.throw(_)}let o=new Vu(r,t,n,i);return e.onSuccess(o.getTrackId()),_.info("create microphone audio track success, trackId:",i),o},createCustomAudioTrack:function(t){let e=et.reportApiInvoke(null,{tag:ge.TRACER,name:ke.CREATE_CUSTOM_AUDIO_TRACK,options:[t]}),n=new Re(t.mediaStreamTrack,t.encoderConfig?ku(t.encoderConfig):{},Zt(8,"track-cus-"),!1);return _.info("create custom audio track success with config",t,"trackId",n.getTrackId()),e.onSuccess(n.getTrackId()),n},createBufferSourceAudioTrack:async function(t){var e;let{cacheOnlineFile:n,encoderConfig:i}=t,{source:r}=t,o={source:r instanceof AudioBuffer?"AudioBuffer":r instanceof File?(e=File.name)!==null&&e!==void 0?e:"File":r,cacheOnlineFile:n,encoderConfig:i},s=et.reportApiInvoke(null,{tag:ge.TRACER,name:ke.CREATE_BUFFER_AUDIO_TRACK,options:[o]});if(v("DISABLE_WEBAUDIO"))throw new D(R.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");let a=Zt(8,"track-buf-");_.info("start create buffer source audio track with config",JSON.stringify(o),"trackId",a);let c=r;if(!(r instanceof AudioBuffer))try{r=await async function(u,h){let p=null;if(typeof u=="string"){let m=Mb.get(u);if(m)return _.debug("use cached audio resource: ",u),m;try{p=(await ar(()=>Mn.get(u,{responseType:"arraybuffer"}),void 0,void 0,{maxRetryCount:3})).data;}catch(E){throw new D(R.FETCH_AUDIO_FILE_FAILED,E.toString())}}else p=await new K((E,S)=>{let C=new FileReader;C.onload=A=>{A.target?E(A.target.result):S(new D(R.READ_LOCAL_AUDIO_FILE_ERROR));},C.onerror=()=>{S(new D(R.READ_LOCAL_AUDIO_FILE_ERROR));},C.readAsArrayBuffer(u);});let T=await function(m){let E=Wa();return new K((S,C)=>{E.decodeAudioData(m,A=>{S(A);},A=>{C(new D(R.DECODE_AUDIO_FILE_FAILED,A.toString()));});})}(p);return typeof u=="string"&&h&&Mb.set(u,T),T}(r,n);}catch(u){return s.onError(u),u.throw(_)}let d=new A3(r),l=new y3(c,d,i?ku(i):{},a);return _.info("create buffer source audio track success, trackId:",a),s.onSuccess(l.getTrackId()),l},setAppType:function(t){if(_.debug("setAppType: ".concat(t)),!(Number.isInteger(t)&&t>=0))throw _.debug("Invalid appType"),new w(R.INVALID_PARAMS,"invalid app type",t);Jt("APP_TYPE",Math.floor(t));},setLogLevel:function(t){_.setLogLevel(t);},enableLogUpload:function(){v("USE_NEW_LOG")?Jt("UPLOAD_LOG",!0):_.enableLogUpload();},disableLogUpload:function(){v("USE_NEW_LOG")?Jt("UPLOAD_LOG",!1):_.disableLogUpload();},createChannelMediaRelayConfiguration:function(){return new SO},checkAudioTrackIsActive:async function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3,n=et.reportApiInvoke(null,{tag:ge.TRACER,name:ke.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[e]});if(!(t instanceof Re||t instanceof Ya)){let c=new w(R.INVALID_TRACK,"the parameter is not a audio track");return n.onError(c),c.throw()}e&&e<1e3&&(e=1e3);let i=t instanceof Re?t.getTrackLabel():"remote_track",r=t.getVolumeLevel(),o=r,s=r,a=Date.now();return new K(c=>{let d=setInterval(()=>{let l=t.getVolumeLevel();o=l>o?l:o,s=l<s?l:s;let u=o-s>1e-4,h=Date.now()-a;if(u||h>e){clearInterval(d);let p=u,T={duration:h,deviceLabel:i,maxVolumeLevel:o,result:p};_.info("[track-".concat(t.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(T))),n.onSuccess(T),c(p);}},200);})},checkVideoTrackIsActive:async function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3,n=et.reportApiInvoke(null,{tag:ge.TRACER,name:ke.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[e]});if(!(t instanceof $t||t instanceof Ka)){let u=new w(R.INVALID_TRACK,"the parameter is not a video track");return n.onError(u),u.throw()}e&&e<1e3&&(e=1e3);let i=t instanceof $t?t.getTrackLabel():"remote_track",r=t.getMediaStreamTrack(!0),o=document.createElement("video");o.style.width="1px",o.style.height="1px",o.setAttribute("muted",""),o.muted=!0,o.setAttribute("playsinline",""),o.controls=!1,(Ke()||Kl())&&(o.style.opacity="0.01",o.style.position="fixed",o.style.left="0",o.style.top="0",document.body.appendChild(o)),o.srcObject=new MediaStream([r]),o.play();let s=document.createElement("canvas");s.width=160,s.height=120;let a=0,c=0;try{let u=Date.now();a=await function(h,p,T,m){let E,S=0,C=null;return new K((A,b)=>{function O(){S>m&&E&&(E(),A(S));let N=T.getContext("2d");if(!N){let x=new w(R.UNEXPECTED_ERROR,"can not get canvas 2d context.");return _.error(x.toString()),void b(x)}N.drawImage(h,0,0,160,120);let k=N.getImageData(0,0,T.width,T.height),M=Math.floor(k.data.length/3);if(C){for(let x=0;x<M;x+=3)if(k.data[x]!==C[x])return S+=1,void(C=k.data);C=k.data;}else C=k.data;}setTimeout(()=>{E&&(E(),A(S));},p),E=kE(()=>{O();},30);})}(o,e,s,4),c=Date.now()-u;}catch(u){throw n.onError(u),u}AH===Bt.SAFARI&&(o.pause(),o.remove()),o.srcObject=null;let d=a>4,l={duration:c,changedPicNum:a,deviceLabel:i,result:d};return _.info("[track-".concat(t.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(l))),n.onSuccess(l),d},setArea:Lm,audioElementPlayCenter:xn,resumeAudioContext:function(){xn.autoResumeAfterInterruption(!0);},processExternalMediaAEC:function(t){PH.processExternalMediaAEC(t);},registerExtensions:function(t){let e=v("PLUGIN_INFO")||[];t.forEach(n=>{"name"in n&&!q(e).call(e,n.name)&&e.push(n.name);let i=n;i.__registered__=!0,i.logger.hookLog=_.extLog,i.reporter.hookApiInvoke=et.extApiInvoke,i.parameters&&Object.keys(i.parameters).forEach(r=>{i.parameters[r]=v(r);});}),pN("PLUGIN_INFO",e);},ChannelMediaRelayError:Sa,ChannelMediaRelayEvent:Zr,ChannelMediaRelayState:Gn,RemoteStreamFallbackType:g3,RemoteStreamType:f3,ConnectionDisconnectedReason:It,AudienceLatencyLevelType:NB,AREAS:Mt,preload:async function(t,e,n,i){return p0(t,e,n,i)}});return Object.defineProperties(xe,{onAudioAutoplayFailed:{get:()=>pi.onAudioAutoplayFailed,set:t=>{pi.onAudioAutoplayFailed=t;}},onAutoplayFailed:{get:()=>pi.onAutoplayFailed,set:t=>{pi.onAutoplayFailed=t;}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>xe._onSecurityPolicyViolation,set(t){xe._onSecurityPolicyViolation=t,hN(t);}},__CLIENT_LIST__:{get:()=>v("SHOW_GLOBAL_CLIENT_LIST")?wo:[]}}),hi.on(Ns.CAMERA_DEVICE_CHANGED,t=>{_.info("camera device changed",JSON.stringify(t)),xe.onCameraChanged&&xe.onCameraChanged(t),xe.safeEmit(Dr.CAMERA_CHANGED,t);}),hi.on(Ns.RECORDING_DEVICE_CHANGED,t=>{_.info("microphone device changed",JSON.stringify(t)),xe.onMicrophoneChanged&&xe.onMicrophoneChanged(t),xe.safeEmit(Dr.MICROPHONE_CHANGED,t);}),hi.on(Ns.PLAYOUT_DEVICE_CHANGED,t=>{_.debug("playout device changed",JSON.stringify(t)),xe.onPlaybackDeviceChanged&&xe.onPlaybackDeviceChanged(t),xe.safeEmit(Dr.PLAYBACK_DEVICE_CHANGED,t);}),xn.onAutoplayFailed=()=>{_.info("detect audio element autoplay failed"),pi.onAudioAutoplayFailed&&pi.onAudioAutoplayFailed();},Kt.on("autoplay-failed",()=>{_.info("detect webaudio autoplay failed"),pi.onAudioAutoplayFailed&&pi.onAudioAutoplayFailed(),xe.safeEmit(Dr.AUTOPLAY_FAILED);}),Kt.on(on.STATE_CHANGE,(t,e)=>{_.info("audio context state changed: ".concat(e," => ").concat(t)),xe.onAudioContextStateChanged&&xe.onAudioContextStateChanged(t,e),xe.safeEmit(Dr.AUDIO_CONTEXT_STATE_CHANGED,t,e);}),Te.on(us.NETWORK_STATE_CHANGE,(t,e)=>{_.info("[network-indicator] network state changed, ".concat(e," => ").concat(t));}),window&&(window.__ARTC__=xe),xe});});var Sr={};FH(Sr,{AgoraRTCProvider:()=>XH,AgoraRTCReactError:()=>Xe,AgoraRTCScreenShareProvider:()=>e5,LocalAudioTrack:()=>Mf,LocalUser:()=>z5,LocalVideoTrack:()=>Uf,RemoteAudioTrack:()=>Vf,RemoteUser:()=>t4,RemoteVideoTrack:()=>Ff,TrackBoundary:()=>x5,VERSION:()=>n4,default:()=>i4,useAutoPlayAudioTrack:()=>Pd,useAutoPlayVideoTrack:()=>Dd,useClientEvent:()=>YH,useConnectionState:()=>s5,useCurrentUID:()=>u5,useIsConnected:()=>Fn,useJoin:()=>p5,useLocalCameraTrack:()=>v5,useLocalMicrophoneTrack:()=>C5,useLocalScreenTrack:()=>L5,useNetworkQuality:()=>E5,usePublish:()=>g5,useRTCClient:()=>gn,useRTCScreenShareClient:()=>n5,useRemoteAudioTracks:()=>y5,useRemoteUserTrack:()=>fh,useRemoteUsers:()=>P5,useRemoteVideoTracks:()=>b5,useTrackEvent:()=>qH,useVolumeLevel:()=>R5});var MN=Bs(Qo());function Je(L,V,j){return L.on(V,j),()=>L.off(V,j)}function BH(L){try{return L()}catch(V){console.error(V);}}function fi(L){return ()=>L.forEach(BH)}function fN(L,V){let j=setInterval(L,V);return ()=>clearInterval(j)}function Zo(L,V){let j=setTimeout(L,V);return ()=>clearTimeout(j)}function rc(){let L,V,j;function H(){if(V){let Et=V;V=void 0,Et();}}async function rt(){if(j){let Et=j;j=void 0;try{await Et();}catch(ut){console.error(ut);}}}async function wt(Et){L=!0,await rt();try{j=await Et();}catch(ut){console.error(ut);}L=!1,H();}async function lt(){L=!0,await rt(),L=!1,H();}function qt(Et){L?V=()=>wt(Et):wt(Et);}function se(){L?V=lt:lt();}return {run:qt,dispose:se}}var oc=typeof document<"u"?react.useLayoutEffect:react.useEffect;function HH(L){return L!=null&&typeof L.then=="function"}function ni(){let L=react.useRef(!1);return react.useEffect(()=>(L.current=!1,()=>{L.current=!0;}),[]),L}function KH(){let L=ni();function V(j,H){return new Promise(async(rt,wt)=>{try{let lt=await j;L.current||rt(lt);}catch(lt){L.current?H?H(lt):process.env.NODE_ENV==="development"&&console.error("An error occurs from a promise after a component is unmounted",lt):wt(lt);}})}return react.useCallback(V,[L])}function Eh(L){let V=KH(),[j,H]=react.useState();return oc(()=>{HH(L)?V(L).then(H):H(L);},[L,V]),j}function gi(L,V){let j=react.useRef();react.useEffect(()=>{let{run:H,dispose:rt}=j.current||=rc();return H(L),rt},V);}function TN(L,V){let j=L.split("."),H=V.split("."),rt=Math.max(j.length,H.length);for(let wt=0;wt<rt;wt++){let lt=parseInt(j[wt]||"0"),qt=parseInt(H[wt]||"0");if(lt>qt)return 1;if(lt<qt)return -1}return 0}function YH(L,V,j){let H=react.useRef(j);oc(()=>{H.current=j;},[j]),react.useEffect(()=>{if(L)return Je(L,V,(...rt)=>{H.current&&H.current(...rt);})},[V,L]);}function qH(L,V,j){let H=react.useRef(j);oc(()=>{H.current=j;},[j]),react.useEffect(()=>{if(L)return Je(L,V,(...rt)=>{H.current&&H.current(...rt);})},[V,L]);}var CN=react.createContext(null);function XH({client:L,children:V}){return jsxRuntime.jsx(CN.Provider,{value:L,children:V})}function QH(L){let V=react.useContext(CN);return L||V}function gn(L){let V=QH(L);if(!V)throw new Error("Agora RTC client not found. Should be wrapped in <AgoraRTCProvider value={client} />");return V}var vN=react.createContext(null);function e5({client:L,children:V}){return jsxRuntime.jsx(vN.Provider,{value:L,children:V})}function n5(L){let V=react.useContext(vN);return L||V}function s5(L){let V=gn(L),[j,H]=react.useState(V?V.connectionState:"DISCONNECTED");return react.useEffect(()=>{if(V){H(V.connectionState);let rt;return fi([Je(V,"connection-state-change",wt=>{rt?.(),wt==="CONNECTED"?rt=Zo(()=>H(wt),0):H(wt);}),()=>rt?.()])}else H("DISCONNECTED");},[V]),j}function Fn(L){let V=gn(L),[j,H]=react.useState(V?V.connectionState==="CONNECTED":!1);return react.useEffect(()=>{if(V){H(V.connectionState==="CONNECTED");let rt;return fi([Je(V,"connection-state-change",wt=>{rt?.(),rt=Zo(()=>H(wt==="CONNECTED"),0);}),()=>rt?.()])}else H(!1);},[V]),j}function u5(L){let V=gn(L),[j,H]=react.useState(V?.uid);return react.useEffect(()=>{if(V)return Je(V,"connection-state-change",rt=>{if(rt==="CONNECTED")return Zo(()=>H(V.uid),0);rt==="DISCONNECTED"&&H(void 0);})},[V]),j}var Xe=class extends Error{rtcMethod;rtcError;name="AgoraRTCReactException";constructor(V,j){typeof j=="string"?super(j):super(j.message),this.rtcMethod=V,this.rtcError=j;}log(V){console[V](this);}};function p5(L,V=!0,j){let H=gn(j),rt=Fn(j),wt=react.useRef(),[lt,qt]=react.useState(!1),[se,Et]=react.useState(0),[ut,Rt]=react.useState(null),Vt=ni();return gi(async()=>{if(Vt.current||(Rt(null),Et(0),qt(!1)),V&&H){try{Vt.current||qt(!0);let{appid:nn,channel:at,token:mt,uid:Se}=typeof L=="function"?await L():L,Ti=await H.join(nn,at,mt,Se);Vt.current||Et(Ti);}catch(nn){console.error(nn),Vt.current||Rt(new Xe("IAgoraRTCClient.join",nn));}Vt.current||qt(!1);let pn=wt.current||=rc();return fi([()=>{pn.dispose();},()=>{pn.run(()=>H.unpublish(H.localTracks));},()=>{for(let nn of H.localTracks)nn.isPlaying&&nn.stop(),nn.close();pn.run(()=>H.leave());}])}},[V,j]),{data:se,isLoading:lt,isConnected:rt,error:ut}}var IN=()=>({uplinkNetworkQuality:0,downlinkNetworkQuality:0,delay:0});function E5(L){let V=gn(L),[j,H]=react.useState(IN);return react.useEffect(()=>{if(V)return Je(V,"network-quality",rt=>H({uplinkNetworkQuality:rt.uplinkNetworkQuality,downlinkNetworkQuality:rt.downlinkNetworkQuality,delay:V.getRTCStats().RTT??0}));H(IN());},[V]),j}var AN=Bs(Qo());function g5(L,V=!0,j){let H=gn(j),rt=Fn(j),wt=react.useRef([]),[lt,qt]=react.useState(!1),[se,Et]=react.useState(null),ut=ni();return gi(async()=>{if(ut.current||(qt(!1),Et(null)),!H||!rt||!V)return;let Rt=L.filter(Boolean),Vt=at=>{let mt=TN(AN.default.VERSION,"4.18.2")>=0;return mt||new Xe("usePublish","please check your agora-rtc-sdk-ng version in package.json, it's recommend upgrade to >= 4.18.2").log("warn"),mt?H.mode!=="live"||H.role!=="audience":!0},pn=at=>wt.current.some(mt=>mt&&mt.getTrackId()===at.getTrackId()),nn=at=>Vt()&&at.enabled&&V&&!pn(at);for(let at=0;at<Rt.length;at++){let mt=Rt[at];if(mt&&nn(mt)){await H.unpublish(wt.current.filter(Se=>Se?.trackMediaType===mt.trackMediaType));try{ut.current||qt(!0),await H.publish(mt);}catch(Se){console.error(Se),ut.current||Et(new Xe("IAgoraRTCClient.publish",Se));}ut.current||qt(!1);}}wt.current=Rt;},[rt,V,H,L]),{isLoading:lt,error:se}}function R5(L){let[V,j]=react.useState(0);return react.useEffect(()=>{if(L)return fN(()=>{j(L.getVolumeLevel());},1e3)},[L]),V}var bN=Bs(Qo());function C5(L=!0,V={ANS:!0,AEC:!0},j){let H=Fn(j),[rt,wt]=react.useState(null),[lt,qt]=react.useState(!1),[se,Et]=react.useState(null),ut=ni();return gi(async()=>{if(ut.current||(qt(!1),Et(null)),H&&L&&!rt){try{ut.current||qt(!0);let Rt=await bN.default.createMicrophoneAudioTrack(V);ut.current||wt(Rt);}catch(Rt){console.error(Rt),ut.current||Et(new Xe("IAgoraRTC.createMicrophoneAudioTrack",Rt));}ut.current||qt(!1);}!H&&!ut.current&&wt(null);},[H,L]),{localMicrophoneTrack:rt,isLoading:lt,error:se}}var wN=Bs(Qo());function v5(L=!0,V,j){let H=Fn(j),[rt,wt]=react.useState(null),[lt,qt]=react.useState(!1),[se,Et]=react.useState(null),ut=ni();return gi(async()=>{if(ut.current||(qt(!1),Et(null)),H&&L&&!rt){try{ut.current||qt(!0);let Rt=await wN.default.createCameraVideoTrack(V);ut.current||wt(Rt);}catch(Rt){console.error(Rt),ut.current||Et(new Xe("IAgoraRTC.createCameraVideoTrack",Rt));}ut.current||qt(!1);}!H&&!ut.current&&wt(null);},[H,L]),{localCameraTrack:rt,isLoading:lt,error:se}}function y5(L,V){let j=gn(V),[H,rt]=react.useState([]),wt=Fn(),lt=react.useRef([]),[qt,se]=react.useState(!1),[Et,ut]=react.useState(null),Rt=ni();return gi(async()=>{if(Rt.current||ut(null),!Array.isArray(L)||!wt)return;let Vt=async at=>{if(!at.audioTrack&&L.some(({uid:mt})=>at.uid===mt)){try{Rt.current||se(!0),await j.subscribe(at,"audio");}catch(mt){console.error(mt),Rt.current||ut(new Xe("IAgoraRTCClient.subscribe",mt));}at.audioTrack&&!lt.current.some(mt=>mt.getUserId()===at.uid)&&lt.current.push(at.audioTrack),lt.current=lt.current.map(mt=>at.audioTrack&&mt.getUserId()===at.uid&&mt.getTrackId()!==at.audioTrack.getTrackId()?at.audioTrack:mt),Rt.current||(rt([...lt.current]),se(!1));}},pn=async at=>{if(L.some(({uid:mt})=>at.uid===mt)){Rt.current||(lt.current=lt.current.filter(mt=>mt.getUserId()!==at.uid),rt([...lt.current]));try{Rt.current||se(!0),await j.unsubscribe(at,"audio");}catch(mt){console.error(mt),Rt.current||ut(new Xe("IAgoraRTCClient.unsubscribe",mt));}Rt.current||se(!1);}};L.map(at=>{!at.audioTrack&&at.hasAudio&&Vt(at);});let nn=[];for(let at=0;at<lt.current.length;at++){let mt=lt.current[at];if(!L.some(Se=>Se.uid===mt.getUserId())){let Se=j.remoteUsers.find(Ti=>Ti.uid===mt.getUserId());Se&&nn.push({user:Se,mediaType:"audio"}),lt.current.splice(at,1),at--;}}if(nn.length>0){try{Rt.current||se(!0),await j.massUnsubscribe(nn);}catch(at){console.error(at),Rt.current||ut(new Xe("IAgoraRTCClient.massUnsubscribe",at));}Rt.current||(rt(lt.current.slice()),se(!1));}return fi([Je(j,"user-published",(at,mt)=>{L.find(Se=>Se.uid===at.uid)&&mt==="audio"&&Vt(at);}),Je(j,"user-unpublished",(at,mt)=>{L.find(Se=>Se.uid===at.uid)&&mt==="audio"&&pn(at);})])},[wt,j,L]),{audioTracks:H,isLoading:qt,error:Et}}function b5(L,V){let j=gn(V),[H,rt]=react.useState([]),wt=Fn(),lt=react.useRef([]),[qt,se]=react.useState(!1),[Et,ut]=react.useState(null),Rt=ni();return gi(async()=>{if(Rt.current||ut(null),!Array.isArray(L)||!wt)return;let Vt=async at=>{if(!at.videoTrack&&L.some(({uid:mt})=>at.uid===mt)){try{Rt.current||se(!0),await j.subscribe(at,"video");}catch(mt){console.error(mt),Rt.current||ut(new Xe("IAgoraRTCClient.subscribe",mt));}at.videoTrack&&!lt.current.some(mt=>mt.getUserId()===at.uid)&&lt.current.push(at.videoTrack),lt.current=lt.current.map(mt=>at.videoTrack&&mt.getUserId()===at.uid&&mt.getTrackId()!==at.videoTrack.getTrackId()?at.videoTrack:mt),Rt.current||(rt([...lt.current]),se(!1));}},pn=async at=>{if(L.some(({uid:mt})=>at.uid===mt)){Rt.current||(lt.current=lt.current.filter(mt=>mt.getUserId()!==at.uid),rt([...lt.current]));try{Rt.current||se(!0),await j.unsubscribe(at,"video");}catch(mt){console.error(mt),Rt.current||ut(new Xe("IAgoraRTCClient.unsubscribe",mt));}Rt.current||se(!1);}};L.map(at=>{!at.videoTrack&&at.hasVideo&&Vt(at);});let nn=[];for(let at=0;at<lt.current.length;at++){let mt=lt.current[at];if(!L.some(Se=>Se.uid===mt.getUserId())){let Se=j.remoteUsers.find(Ti=>Ti.uid===mt.getUserId());Se&&nn.push({user:Se,mediaType:"video"}),lt.current.splice(at,1),at--;}}if(nn.length>0){try{Rt.current||se(!0),await j.massUnsubscribe(nn);}catch(at){console.error(at),Rt.current||ut(new Xe("IAgoraRTCClient.massUnsubscribe",at));}Rt.current||(rt(lt.current.slice()),se(!1));}return fi([Je(j,"user-published",(at,mt)=>{L.find(Se=>Se.uid===at.uid)&&mt==="video"&&Vt(at);}),Je(j,"user-unpublished",(at,mt)=>{L.find(Se=>Se.uid===at.uid)&&mt==="video"&&pn(at);})])},[wt,j,L]),{videoTracks:H,isLoading:qt,error:Et}}function fh(L,V,j){let H=gn(j),rt=V==="audio"?"audioTrack":"videoTrack",[wt,lt]=react.useState(L&&L[rt]),qt=Fn(),se=react.useRef(),[Et,ut]=react.useState(!1),[Rt,Vt]=react.useState(null);return react.useEffect(()=>{if(!L||!qt)return;let pn=!1;pn||Vt(null);let nn=V==="audio"?"hasAudio":"hasVideo",at=L.uid,mt=async(Bn,Yr)=>{if(Bn[rt]&&H.remoteUsers.some(({uid:Tn})=>Bn.uid===Tn))try{pn||ut(!0),await H.unsubscribe(Bn,Yr);}catch(Tn){pn||Vt(new Xe("IAgoraRTCClient.unsubscribe",Tn)),console.error(Tn);}pn||(lt(void 0),ut(!1));},Se=async(Bn,Yr)=>{try{!Bn[rt]&&H.remoteUsers.some(({uid:Tn})=>Bn.uid===Tn)&&(pn||ut(!0),await H.subscribe(Bn,Yr)),pn||lt(Bn[rt]);}catch(Tn){pn||Vt(new Xe("IAgoraRTCClient.subscribe",Tn)),console.error(Tn);}pn||ut(!1);},Ti=se.current||=rc();return !L[rt]&&L[nn]?Ti.run(()=>Se(L,V)):lt(L[rt]),fi([()=>{pn=!0,Ti.dispose();},Je(H,"user-published",(Bn,Yr)=>{Bn.uid===at&&Yr===V&&Ti.run(()=>Se(Bn,V));}),Je(H,"user-unpublished",(Bn,Yr)=>{Bn.uid===at&&Yr===V&&Ti.run(()=>mt(Bn,V));})])},[qt,H,L,V,rt]),{track:wt,isLoading:Et,error:Rt}}function P5(L){let V=gn(L),[j,H]=react.useState(V?V.remoteUsers:[]);return react.useEffect(()=>{if(V){let rt=()=>H(V.remoteUsers.slice());return fi([Je(V,"user-joined",rt),Je(V,"user-left",rt),Je(V,"user-published",rt),Je(V,"user-unpublished",rt)])}},[V]),j}var ON=Bs(Qo());function L5(L=!0,V,j,H){let rt=Fn(H),[wt,lt]=react.useState(null),[qt,se]=react.useState(!1),[Et,ut]=react.useState(null),Rt=ni();return gi(async()=>{if(Rt.current||(se(!1),ut(null)),rt&&L&&!wt){try{Rt.current||se(!0);let Vt=await ON.default.createScreenVideoTrack(V,j);Rt.current||lt(Vt);}catch(Vt){console.error(Vt),Rt.current||ut(new Xe("IAgoraRTC.createScreenVideoTrack",Vt));}Rt.current||se(!1);}(!rt||!L)&&!Rt.current&&lt(null);},[rt,L]),{screenTrack:wt,isLoading:qt,error:Et}}function U5(){let L=new Map,V=1500;return {onMount:j=>{let H=L.get(j);H&&(H(),L.delete(j));},onUnmount:j=>{let H=L.get(j);H&&H(),L.set(j,Zo(()=>{j.isPlaying&&j.stop(),L.delete(j);},V));},dispose:()=>{for(let[j,H]of L)j.isPlaying&&j.stop(),H&&H();L.clear();}}}var Lf=react.createContext(void 0);function x5({children:L}){let[V]=react.useState(U5);return react.useEffect(()=>V.dispose,[V]),jsxRuntime.jsx(Lf.Provider,{value:V,children:L})}function Dd(L,V,j,H){let rt=react.useContext(Lf);react.useEffect(()=>{if(L)return H&&V?L.play(H,j||void 0):L.stop(),rt?(rt.onMount(L),()=>rt.onUnmount(L)):()=>{L.isPlaying&&L.stop();}},[L,H,V,rt,j]);}function Pd(L,V){let j=react.useContext(Lf);oc(()=>{if(L)return V?L.play():L.stop(),j?(j.onMount(L),()=>j.onUnmount(L)):()=>{L.isPlaying&&L.stop();}},[L,V,j]);}function Mf({track:L,play:V=!1,volume:j,disabled:H,muted:rt,children:wt}){let lt=Eh(L);return Pd(lt,V),react.useEffect(()=>{lt&&j!=null&&lt.setVolume(j);},[lt,j]),react.useEffect(()=>{lt&&H!=null&&lt.setEnabled(!H).catch(console.warn);},[H,lt]),react.useEffect(()=>{lt&&rt!=null&&lt.setMuted(rt).catch(console.warn);},[rt,lt]),wt?jsxRuntime.jsx(jsxRuntime.Fragment,{children:wt}):null}var gh={position:"relative",width:"100%",height:"100%",overflow:"hidden",background:"#000"},Th={width:"100%",height:"100%"},sc={position:"absolute",top:0,left:0,width:"100%",height:"100%",overflow:"hidden",zIndex:2},$o=(L,V)=>react.useMemo(()=>({...L,...V}),[L,V]);function Uf({track:L,play:V,disabled:j,muted:H,style:rt,videoPlayerConfig:wt,...lt}){let qt=$o(Th,rt),[se,Et]=react.useState(null),ut=Eh(L);return Dd(ut,V,wt,se),react.useEffect(()=>{ut&&j!=null&&ut.setEnabled(!j).catch(console.warn);},[j,ut]),react.useEffect(()=>{ut&&H!=null&&ut.setMuted(H).catch(console.warn);},[H,ut]),jsxRuntime.jsx("div",{...lt,ref:Et,style:qt})}var H5={width:"100%",height:"100%",background:"#1a1e21 center/cover no-repeat",filter:"blur(16px) brightness(0.4)"},K5={position:"absolute",top:"50%",left:"50%",maxWidth:"50%",maxHeight:"50%",aspectRatio:"1",transform:"translate(-50%, -50%)",borderRadius:"50%",overflow:"hidden",objectFit:"cover"};function Sh({cover:L}){return jsxRuntime.jsx("div",{style:sc,children:typeof L=="string"?jsxRuntime.jsxs(jsxRuntime.Fragment,{children:[jsxRuntime.jsx("div",{style:{...H5,backgroundImage:`url(${L})`}}),jsxRuntime.jsx("img",{src:L,style:K5})]}):L()})}function z5({micOn:L,cameraOn:V,audioTrack:j,videoTrack:H,playAudio:rt,playVideo:wt,volume:lt,cover:qt,children:se,style:Et,...ut}){let Rt=$o(gh,Et);return wt=wt??!!V,rt=rt??!!L,jsxRuntime.jsxs("div",{...ut,style:Rt,children:[jsxRuntime.jsx(Uf,{disabled:!V,play:wt,track:H}),jsxRuntime.jsx(Mf,{disabled:!L,play:rt,track:j,volume:lt}),qt&&!V&&jsxRuntime.jsx(Sh,{cover:qt}),jsxRuntime.jsx("div",{style:sc,children:se})]})}function Vf({track:L,play:V=!1,playbackDeviceId:j,volume:H,children:rt}){return Pd(L,V),react.useEffect(()=>{L&&j!=null&&L.setPlaybackDevice(j).catch(console.warn);},[L,j]),react.useEffect(()=>{L&&H!=null&&L.setVolume(H);},[L,H]),rt?jsxRuntime.jsx(jsxRuntime.Fragment,{children:rt}):null}function Ff({track:L,play:V,style:j,videoPlayerConfig:H,...rt}){let wt=$o(Th,j),[lt,qt]=react.useState(null);return Dd(L,V,H,lt),jsxRuntime.jsx("div",{...rt,ref:qt,style:wt})}function t4({user:L,playVideo:V,playAudio:j,playbackDeviceId:H,volume:rt,cover:wt,style:lt,children:qt,videoPlayerConfig:se,...Et}){let ut=$o(gh,lt),{track:Rt}=fh(L,"video"),{track:Vt}=fh(L,"audio");return V=V??L?.hasVideo,j=j??L?.hasAudio,jsxRuntime.jsxs("div",{...Et,style:ut,children:[jsxRuntime.jsx(Ff,{play:V,track:Rt,videoPlayerConfig:se}),jsxRuntime.jsx(Vf,{play:j,playbackDeviceId:H,track:Vt,volume:rt}),wt&&!V&&jsxRuntime.jsx(Sh,{cover:wt}),jsxRuntime.jsx("div",{style:sc,children:qt})]})}var kN=Bs(Qo()),Bf=class{appType=1001;constructor(){kN.default.setAppType(this.appType);}};new Bf;var n4="2.2.0";Kr(Sr,Bs(Qo()));var i4=MN.default;/*! Bundled license information:

agora-rtc-sdk-ng/AgoraRTC_N-production.js:
  (*! formdata-polyfill. MIT License. Jimmy W?rting <https://jimmy.warting.se/opensource> *)
*/

exports.AgoraRTCProvider = XH;
exports.AgoraRTCReactError = Xe;
exports.AgoraRTCScreenShareProvider = e5;
exports.LocalAudioTrack = Mf;
exports.LocalUser = z5;
exports.LocalVideoTrack = Uf;
exports.RemoteAudioTrack = Vf;
exports.RemoteUser = t4;
exports.RemoteVideoTrack = Ff;
exports.TrackBoundary = x5;
exports.VERSION = n4;
exports.default = i4;
exports.useAutoPlayAudioTrack = Pd;
exports.useAutoPlayVideoTrack = Dd;
exports.useClientEvent = YH;
exports.useConnectionState = s5;
exports.useCurrentUID = u5;
exports.useIsConnected = Fn;
exports.useJoin = p5;
exports.useLocalCameraTrack = v5;
exports.useLocalMicrophoneTrack = C5;
exports.useLocalScreenTrack = L5;
exports.useNetworkQuality = E5;
exports.usePublish = g5;
exports.useRTCClient = gn;
exports.useRTCScreenShareClient = n5;
exports.useRemoteAudioTracks = y5;
exports.useRemoteUserTrack = fh;
exports.useRemoteUsers = P5;
exports.useRemoteVideoTracks = b5;
exports.useTrackEvent = qH;
exports.useVolumeLevel = R5;
